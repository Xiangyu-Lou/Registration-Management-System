(function(){"use strict";var e={4420:function(e,t,o){var a=o(5130),l=o(6768);const r={id:"app"};function n(e,t,o,a,n,s){const i=(0,l.g2)("app-header"),u=(0,l.g2)("router-view");return(0,l.uX)(),(0,l.CE)("div",r,[a.showHeader?((0,l.uX)(),(0,l.Wv)(i,{key:0})):(0,l.Q3)("",!0),(0,l.bF)(u)])}var s=o(1387),i=o(4232);const u={class:"app-header"},d={key:0,class:"user-info"},c={class:"welcome-text"},p={key:0,class:"unit-tag"};function m(e,t,o,a,r,n){const s=(0,l.g2)("el-button");return(0,l.uX)(),(0,l.CE)("div",u,[t[2]||(t[2]=(0,l.Lk)("div",{class:"header-title"},[(0,l.Lk)("h1",null,"危险废物管理系统")],-1)),a.auth.state.isLoggedIn?((0,l.uX)(),(0,l.CE)("div",d,[(0,l.Lk)("span",c,[t[0]||(t[0]=(0,l.eW)(" 欢迎, ")),(0,l.Lk)("strong",null,(0,i.v_)(a.userName),1),a.auth.state.user.unit_name?((0,l.uX)(),(0,l.CE)("span",p,(0,i.v_)(a.auth.state.user.unit_name),1)):(0,l.Q3)("",!0)]),(0,l.bF)(s,{type:"text",class:"logout-button",onClick:a.handleLogout},{default:(0,l.k6)((()=>t[1]||(t[1]=[(0,l.eW)(" 退出登录 ")]))),_:1},8,["onClick"])])):(0,l.Q3)("",!0)])}var g=o(1219),f=o(144),h=o(4373);const v="";var w={baseURL:v,endpoints:{login:"/api/login",users:"/api/users",units:"/api/units",wasteTypes:"/api/waste-types",wasteRecords:"/api/waste-records",wasteRecordsByUnit:"/api/waste-records",wasteRecordDetail:"/api/waste-records/detail",wasteRecordsByUser:"/api/waste-records/user",exportWasteRecords:"/api/waste-records/export/user"},getUrl(e){return`${this.baseURL}${e}`}};const k={class:"unit-selection-container"},b={class:"content"},y={class:"units-grid"},_={class:"unit-name"};function F(e,t,o,a,r,n){const s=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",k,[t[1]||(t[1]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"危险废物管理系统")],-1)),(0,l.Lk)("div",b,[t[0]||(t[0]=(0,l.Lk)("h2",null,"请选择您的单位",-1)),(0,l.Lk)("div",y,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(s,{key:e.id,class:"unit-card",shadow:"hover",onClick:t=>n.selectUnit(e)},{default:(0,l.k6)((()=>[(0,l.Lk)("div",_,(0,i.v_)(e.name),1)])),_:2},1032,["onClick"])))),128))])]),t[2]||(t[2]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var I={name:"UnitSelection",data(){return{units:[],loading:!1}},created(){this.fetchUnits()},methods:{async fetchUnits(){this.loading=!0;try{console.log("正在获取单位列表...");const e=await h.A.get(w.getUrl(w.endpoints.units));console.log("获取单位列表成功:",e.data),this.units=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}finally{this.loading=!1}},selectUnit(e){this.$router.push({name:"WasteForm",params:{id:e.id}})}}},x=o(1241);const L=(0,x.A)(I,[["render",F],["__scopeId","data-v-a706bc72"]]);var R=L;const C={class:"waste-form-container"},T={class:"header"},W={key:1},U={class:"content"},V={class:"unit-info"},E={class:"form-row"},$={key:0,class:"upload-warning"},P={class:"form-actions"},A={class:"upload-progress"},K={class:"upload-status"};function S(e,t,o,a,r,n){const s=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),d=(0,l.g2)("document"),c=(0,l.g2)("el-option"),p=(0,l.g2)("el-select"),m=(0,l.g2)("el-form-item"),g=(0,l.g2)("el-input"),f=(0,l.g2)("el-date-picker"),h=(0,l.g2)("clock"),v=(0,l.g2)("el-time-picker"),w=(0,l.g2)("el-input-number"),k=(0,l.g2)("el-alert"),b=(0,l.g2)("plus"),y=(0,l.g2)("el-upload"),_=(0,l.g2)("el-button"),F=(0,l.g2)("el-form"),I=(0,l.g2)("el-progress"),x=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",C,[(0,l.Lk)("div",T,[a.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>a.goBack&&a.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[9]||(t[9]=(0,l.eW)(" 返回 "))])):((0,l.uX)(),(0,l.CE)("div",W)),t[11]||(t[11]=(0,l.Lk)("h1",null,"危险废物填报",-1)),(0,l.Lk)("div",{class:"view-records",onClick:t[1]||(t[1]=(...e)=>a.viewRecords&&a.viewRecords(...e))},[t[10]||(t[10]=(0,l.eW)(" 查看记录 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1})])]),(0,l.Lk)("div",U,[(0,l.Lk)("div",V,[(0,l.Lk)("h2",null,(0,i.v_)(a.unitName),1)]),(0,l.bF)(F,{ref:"wasteForm",model:a.form,rules:a.rules,"label-position":"top",class:"waste-form"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:a.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>a.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"产生地点",prop:"location"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.location,"onUpdate:modelValue":t[3]||(t[3]=e=>a.form.location=e),placeholder:"请输入废物产生地点"},null,8,["modelValue"])])),_:1}),(0,l.Lk)("div",E,[(0,l.bF)(m,{label:"收集日期",class:"date-item"},{default:(0,l.k6)((()=>[(0,l.bF)(f,{modelValue:a.form.collectionDate,"onUpdate:modelValue":t[4]||(t[4]=e=>a.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,"popper-class":"date-picker-popup",teleported:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"收集时间",class:"time-item"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:a.form.collectionTime,"onUpdate:modelValue":t[5]||(t[5]=e=>a.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"},editable:!1,"popper-class":"time-picker-popup",teleported:!1},{prefix:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1})])),_:1},8,["modelValue"])])),_:1})]),(0,l.bF)(m,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:a.form.quantity,"onUpdate:modelValue":t[6]||(t[6]=e=>a.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"},onFocus:t[7]||(t[7]=e=>a.selectAllText(e)),"input-props":{inputmode:"decimal",pattern:"[0-9]*[.,]?[0-9]*"},controls:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集前）",prop:"photo_before"},{default:(0,l.k6)((()=>[t[12]||(t[12]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),a.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",$,[(0,l.bF)(k,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":a.handlePhotoBeforeChange,"on-remove":a.handlePhotoBeforeRemove,"file-list":a.fileListBefore,limit:5,multiple:"","list-type":"picture-card","before-upload":a.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(b)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集后）",prop:"photo_after"},{default:(0,l.k6)((()=>[t[13]||(t[13]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":a.handlePhotoAfterChange,"on-remove":a.handlePhotoAfterRemove,"file-list":a.fileListAfter,limit:5,multiple:"","list-type":"picture-card","before-upload":a.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(b)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.Lk)("div",P,[(0,l.bF)(_,{type:"primary",class:"submit-btn",onClick:a.submitForm,loading:a.loading},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("提交")]))),_:1},8,["onClick","loading"]),(0,l.bF)(_,{class:"reset-btn",onClick:a.resetForm},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model","rules"])]),(0,l.bF)(x,{modelValue:a.showUploadProgress,"onUpdate:modelValue":t[8]||(t[8]=e=>a.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",A,[t[16]||(t[16]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(I,{percentage:a.uploadPercentage,format:a.percentageFormat,status:100===a.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",K,(0,i.v_)(a.uploadStatus),1)])])),_:1},8,["modelValue"]),t[17]||(t[17]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var X=o(7477),D=o(9372),B=o.n(D),Q={name:"WasteForm",components:{ArrowLeft:X.nkM,Document:X.yoT,Plus:X.FWt,Clock:X.zD7},props:{id:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),o=(0,f.KR)(null),a=(0,f.KR)(!1),r=(0,f.KR)(""),n=(0,f.KR)([]),i=(0,f.KR)([]),u=(0,f.KR)([]),d=(0,f.KR)([]),c=(0,f.KR)([]),p=(0,f.KR)(!1),m=(0,f.KR)(0),h=(0,f.KR)("准备上传..."),v=(0,f.KR)(!1),k=(0,l.EW)((()=>Nt.state.isLoggedIn&&3===Nt.state.user.role_id)),b=(0,f.Kh)({wasteTypeId:"",location:"",collectionDate:(new Date).toISOString().slice(0,10),collectionTime:"08:00",quantity:void 0,photo_before:[],photo_after:[]}),y={wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],location:[{required:!0,message:"请输入废物产生地点",trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{const e=document.createElement("meta");e.setAttribute("name","viewport"),e.setAttribute("content","width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1"),document.head.appendChild(e);const t=document.querySelector('meta[name="viewport"]');t&&t!==e&&t.remove(),await _(),await F()})),(0,l.xo)((()=>{const e=document.querySelector('meta[name="viewport"]');e&&e.remove();const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width,initial-scale=1.0"),document.head.appendChild(t)}));const _=async()=>{try{const t=await St.get(w.endpoints.units),o=t.data.find((t=>t.id===parseInt(e.id)));o&&(r.value=o.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},F=async()=>{try{const e=await St.get(w.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型失败")}},I=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],o=t.includes(e.type);if(!o)return g.nk.error("只能上传图片文件!"),!1;const a=52428800;return e.size>a?(g.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{p.value=!0,h.value="正在处理图片...",m.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(B())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,h.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,h.value="正在压缩图片...",console.log("图片绘制完成")},success(o){const a=e.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([o],a,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),h.value="图片处理完成",m.value=100,setTimeout((()=>{p.value=!1}),500),t(l)},error(o){console.error("图片压缩失败:",o),h.value="处理失败，使用原始图片",m.value=100,setTimeout((()=>{p.value=!1}),500),t(e)}})}))},x=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),d.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){p.value=!0,h.value="正在处理图片...",m.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(B())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,h.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,h.value="正在压缩图片...",console.log("图片绘制完成")},success(o){const a=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([o],a,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),h.value="图片处理完成",m.value=100,t(l)},error(o){console.error("图片压缩失败:",o),h.value="处理失败，使用原始图片",m.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const o=i.value.findIndex((t=>t.uid===e.uid||t.name===e.name));o>=0?i.value[o]=t:i.value.push(t);const a=d.value.findIndex((t=>t.uid===e.uid));a>=0&&(d.value[a].processed=!0),setTimeout((()=>{p.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),g.nk.warning("图片处理失败，将使用原始图片");const t=i.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?i.value[t]=e.raw:i.value.push(e.raw),p.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const o=[...i.value,...u.value];v.value=T(o),console.log("更新后的photoFilesBefore:",i.value),console.log("更新后的fileListBefore:",d.value)},L=(e,t)=>{console.log("收集前照片移除:",e),d.value=t,e.raw?i.value=i.value.filter((t=>t.name!==e.raw.name)):i.value=i.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),T([...i.value,...u.value])||(v.value=!1),console.log("更新后的photoFilesBefore:",i.value)},R=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){p.value=!0,h.value="正在处理图片...",m.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(B())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,h.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,h.value="正在压缩图片...",console.log("图片绘制完成")},success(o){const a=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([o],a,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),h.value="图片处理完成",m.value=100,t(l)},error(o){console.error("图片压缩失败:",o),h.value="处理失败，使用原始图片",m.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const o=u.value.findIndex((t=>t.uid===e.uid||t.name===e.name));o>=0?u.value[o]=t:u.value.push(t);const a=c.value.findIndex((t=>t.uid===e.uid));a>=0&&(c.value[a].processed=!0),setTimeout((()=>{p.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),g.nk.warning("图片处理失败，将使用原始图片");const t=u.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?u.value[t]=e.raw:u.value.push(e.raw),p.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const o=[...i.value,...u.value];v.value=T(o),console.log("更新后的photoFilesAfter:",u.value),console.log("更新后的fileListAfter:",c.value)},C=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,e.raw?u.value=u.value.filter((t=>t.name!==e.raw.name)):u.value=u.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),T([...i.value,...u.value])||(v.value=!1),console.log("更新后的photoFilesAfter:",u.value)},T=e=>{const t=5242880;return e.some((e=>e.size>t))},W=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);m.value=t,h.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},U=e=>100===e?"完成":`${e}%`,V=()=>{o.value.validate((async t=>{if(t){a.value=!0;try{const t=new FormData;if(t.append("unitId",e.id),t.append("wasteTypeId",b.wasteTypeId),t.append("location",b.location),b.collectionDate&&b.collectionTime&&(t.append("collectionDate",b.collectionDate),t.append("collectionTime",b.collectionTime)),t.append("quantity",b.quantity),Nt.state.isLoggedIn&&Nt.state.user){t.append("creator_id",Nt.state.user.id);const e=Nt.state.user.username||Nt.state.user.phone||"未知";t.append("creator_name",e),console.log("添加用户信息:",{creator_id:Nt.state.user.id,creator_name:e,user:Nt.state.user})}else console.log("用户未登录或用户信息不完整");console.log("提交表单数据:",{unitId:e.id,wasteTypeId:b.wasteTypeId,location:b.location,quantity:b.quantity,photo_before:i.value?i.value.length:0,photo_after:u.value?u.value.length:0}),i.value&&i.value.length>0&&(console.log("添加收集前照片数量:",i.value.length),i.value.forEach(((e,o)=>{e&&(console.log(`收集前照片 ${o+1}:`,e.name),t.append("photo_before",e))}))),u.value&&u.value.length>0&&(console.log("添加收集后照片数量:",u.value.length),u.value.forEach(((e,o)=>{e&&(console.log(`收集后照片 ${o+1}:`,e.name),t.append("photo_after",e))})));const o=[...i.value||[],...u.value||[]];v.value=T(o),o.length>0&&(p.value=!0,m.value=0,h.value="准备上传...");const a=await St.postForm(w.endpoints.wasteRecords,t,W);console.log("提交响应:",a.data),g.nk.success("废物记录提交成功"),E()}catch(o){console.error("Error submitting form:",o),o.response&&(console.error("错误响应数据:",o.response.data),console.error("错误状态码:",o.response.status)),g.nk.error("提交失败，请稍后再试")}finally{a.value=!1,p.value=!1}}else g.nk.warning("请完成必填项")}))},E=()=>{o.value&&o.value.resetFields(),i.value=[],u.value=[],d.value=[],c.value=[],b.quantity=void 0,b.collectionDate=(new Date).toISOString().slice(0,10),b.collectionTime="08:00"},$=()=>{k.value&&t.push("/")},P=()=>{t.push({name:"RecordsList",params:{unitId:e.id}})},A=e=>{setTimeout((()=>{if(e&&e.target){const t=e.target.querySelector("input");t&&t.select()}}),10)};return{form:b,rules:y,wasteForm:o,loading:a,unitName:r,wasteTypes:n,isAdmin:k,fileListBefore:d,fileListAfter:c,handlePhotoBeforeChange:x,handlePhotoBeforeRemove:L,handlePhotoAfterChange:R,handlePhotoAfterRemove:C,handleBeforeUpload:I,submitForm:V,resetForm:E,goBack:$,viewRecords:P,selectAllText:A,showUploadProgress:p,uploadPercentage:m,uploadStatus:h,percentageFormat:U,showLargeFileWarning:v}}};const q=(0,x.A)(Q,[["render",S],["__scopeId","data-v-5c62ef94"]]);var j=q;const M={class:"records-container"},z={class:"header"},O={key:1},N={class:"content"},Y={class:"unit-info"},H={class:"actions"},J={class:"filter-header"},G={class:"filter-form-container"},Z={class:"quantity-range"},ee={class:"filter-actions"},te={class:"records-wrapper"},oe={class:"card-header"},ae={class:"card-actions"},le={key:0,class:"photo-preview"},re=["onClick"],ne={key:0,class:"photo-count"},se={key:1},ie={key:0,class:"photo-preview"},ue=["onClick"],de={key:0,class:"photo-count"},ce={key:1},pe={class:"operation-buttons"},me={key:0,class:"loading-more"},ge={key:1,class:"empty-block"};function fe(e,t,o,r,n,s){const u=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),c=(0,l.g2)("home"),p=(0,l.g2)("plus"),m=(0,l.g2)("el-button"),g=(0,l.g2)("user"),f=(0,l.g2)("refresh"),h=(0,l.g2)("download"),v=(0,l.g2)("arrow-down"),w=(0,l.g2)("arrow-up"),k=(0,l.g2)("el-date-picker"),b=(0,l.g2)("el-form-item"),y=(0,l.g2)("el-col"),_=(0,l.g2)("el-option"),F=(0,l.g2)("el-select"),I=(0,l.g2)("el-row"),x=(0,l.g2)("el-input-number"),L=(0,l.g2)("el-input"),R=(0,l.g2)("el-form"),C=(0,l.g2)("el-card"),T=(0,l.g2)("el-table-column"),W=(0,l.g2)("el-image"),U=(0,l.g2)("el-table"),V=(0,l.g2)("loading"),E=(0,l.g2)("el-empty"),$=(0,l.g2)("el-image-viewer"),P=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",M,[(0,l.Lk)("div",z,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 返回填报 "))]),t[10]||(t[10]=(0,l.Lk)("h1",null,"废物记录查看",-1)),r.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"home-link",onClick:t[1]||(t[1]=(...e)=>r.goHome&&r.goHome(...e))},[t[9]||(t[9]=(0,l.eW)(" 首页 ")),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(c)])),_:1})])):((0,l.uX)(),(0,l.CE)("div",O))]),(0,l.Lk)("div",N,[(0,l.Lk)("div",Y,[(0,l.Lk)("h2",null,(0,i.v_)(r.unitName)+" - 危险废物记录",1)]),(0,l.Lk)("div",H,[(0,l.bF)(m,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isAdmin||r.isUnitAdmin?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}),t[12]||(t[12]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(m,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"]),(0,l.bF)(m,{type:"primary",onClick:r.exportRecords,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick","loading"])]),(0,l.bF)(C,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",J,[t[15]||(t[15]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(m,{type:"primary",link:"",onClick:t[2]||(t[2]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(d,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(w)])),_:1})):((0,l.uX)(),(0,l.Wv)(d,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(v)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",G,[(0,l.bF)(R,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(I,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(I,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Z,[(0,l.bF)(x,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"48%"}},null,8,["modelValue"]),t[16]||(t[16]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.bF)(x,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"48%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(L,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.Lk)("div",ee,[(0,l.bF)(m,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("筛选")]))),_:1},8,["onClick"]),(0,l.bF)(m,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[a.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",te,[(0,l.bF)(C,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",oe,[t[20]||(t[20]=(0,l.Lk)("h3",null,"废物记录列表",-1)),(0,l.Lk)("div",ae,[(0,l.bF)(m,{type:"warning",onClick:r.exportRecords},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1}),t[19]||(t[19]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(U,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:"500",onScroll:r.handleScroll},{default:(0,l.k6)((()=>[(0,l.bF)(T,{prop:"waste_type_name",label:"废物类型","min-width":"110"}),(0,l.bF)(T,{prop:"location",label:"产生地点","min-width":"120"}),(0,l.bF)(T,{label:"收集开始时间","min-width":"160"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.collection_start_time)),1)])),_:1}),(0,l.bF)(T,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(parseFloat(e.row.quantity).toFixed(3)),1)])),_:1}),(0,l.bF)(T,{label:"记录时间","min-width":"160",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.created_at)),1)])),_:1}),(0,l.bF)(T,{label:"汇报人","min-width":"100",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.creator_name||"未知"),1)])),_:1}),(0,l.bF)(T,{label:"现场照片（清理前）",width:"120",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",le,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,o)=>((0,l.uX)(),(0,l.CE)("div",{key:o,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),o)},[(0,l.bF)(W,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,re)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",ne,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",se,"无"))])),_:1}),(0,l.bF)(T,{label:"现场照片（清理后）",width:"120",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",ie,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,o)=>((0,l.uX)(),(0,l.CE)("div",{key:o,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),o)},[(0,l.bF)(W,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,ue)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",de,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",ce,"无"))])),_:1}),(0,l.bF)(T,{label:"操作","min-width":"70",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",pe,[r.canEdit(e.row)?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[21]||(t[21]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0),r.canEdit(e.row)?((0,l.uX)(),(0,l.Wv)(m,{key:1,type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[22]||(t[22]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0)])])),_:1})])),_:1},8,["data","onScroll"])),[[P,r.loading]]),r.loadingMore?((0,l.uX)(),(0,l.CE)("div",me,[(0,l.bF)(d,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(V)])),_:1}),t[23]||(t[23]=(0,l.eW)(" 加载更多... "))])):(0,l.Q3)("",!0),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",ge,[(0,l.bF)(E,{description:"暂无废物记录"})]))])),_:1})])]),t[24]||(t[24]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,l.uX)(),(0,l.Wv)($,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}var he=o(8828),ve=o(2933),we=o(5320),ke=o(3230),be=o(7093),ye=o.n(be);console.log("XLSX库版本:",ke.version),console.log("XLSX库可用方法:",Object.keys(ke).join(", "));const _e=async(e,t=window.location.origin)=>{if(console.log("获取图片:",e),!e)return console.error("图片URL为空"),null;const o=e.startsWith("/")?`${t}${e}`:e;try{console.log("获取图片:",o);const e=await fetch(o,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!e.ok)throw new Error(`获取图片失败: ${e.status} ${e.statusText}`);const t=await e.arrayBuffer();return console.log("图片获取成功，大小:",t.byteLength,"字节"),t}catch(a){return console.error("获取图片失败:",a),null}},Fe=async(e,t,o,a=window.location.origin,l=null)=>{if(console.log("=== exportToExcelWithImages 函数被调用 ==="),console.log("数据条数:",e.length),!e||0===e.length)return console.error("导出失败：没有数据"),!1;try{t=t.replace(/[\\/:*?"<>|]/g,"_");const n=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),s=`${t}_${n}.xlsx`,i=new(ye().Workbook);i.creator="危险废物管理系统",i.lastModifiedBy="危险废物管理系统",i.created=new Date,i.modified=new Date;const u=i.addWorksheet("危险废物记录"),d=o.map((e=>({header:e.text,key:e.field,width:e.isImage?20:15})));u.columns=d,u.getRow(1).font={bold:!0},u.getRow(1).alignment={vertical:"middle",horizontal:"center"},console.log("开始处理数据行...");const c=e.length*(1+o.filter((e=>e.isImage)).length);let p=0;for(let t=0;t<e.length;t++){const n=e[t];console.log(`处理第 ${t+1}/${e.length} 条记录...`);const s={};o.forEach((e=>{e.isImage||(s[e.field]=n[e.field]||"")}));const d=u.addRow(s);d.height=80,p++,l&&"function"===typeof l&&l(p,c);for(const e of o)if(e.isImage){const s=e.field,d=n[s];if(d){console.log(`记录 ${t+1} 的 ${s} 字段有图片路径: ${d}`);try{const e=await _e(d,a);if(e){const a=o.findIndex((e=>e.field===s))+1,l=u.getCell(t+2,a).address,r=i.addImage({buffer:e,extension:d.split(".").pop().toLowerCase()});u.addImage(r,{tl:{col:a-1,row:t+1},br:{col:a,row:t+1.9},editAs:"oneCell"}),console.log(`已添加图片到单元格 ${l}`)}else console.error(`获取图片失败: ${d}`)}catch(r){console.error("处理图片时出错:",r)}}else console.log(`记录 ${t+1} 的 ${s} 没有照片路径`);p++,l&&"function"===typeof l&&l(p,c)}}console.log("数据行处理完成，准备生成Excel文件...");const m=await i.xlsx.writeBuffer(),g=new Blob([m],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=window.URL.createObjectURL(g),h=document.createElement("a");return h.href=f,h.download=s,h.click(),window.URL.revokeObjectURL(f),console.log("Excel文件生成并下载成功"),!0}catch(n){return console.error("导出Excel文件失败:",n),!1}},Ie=async(e,t,o)=>{if(!e||0===e.length)return console.error("导出失败：没有数据"),!1;t=t.replace(/[\\/:*?"<>|]/g,"_");const a=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),l=`${t}_${a}.xlsx`;console.log("导出函数被调用，数据条数:",e.length);try{console.log("使用ExcelJS导出Excel...");const t=new(ye().Workbook);t.creator="危险废物管理系统",t.lastModifiedBy="危险废物管理系统",t.created=new Date,t.modified=new Date;const a=t.addWorksheet("危险废物记录"),r=o.map((e=>({header:e.text,key:e.field,width:15})));a.columns=r,a.getRow(1).font={bold:!0},a.getRow(1).alignment={vertical:"middle",horizontal:"center"},e.forEach((e=>{const t={};o.forEach((o=>{t[o.field]=e[o.field]||""})),a.addRow(t)})),console.log("生成Excel数据...");const n=await t.xlsx.writeBuffer(),s=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(s),u=document.createElement("a");return u.href=i,u.download=l,console.log("下载链接创建成功，准备触发点击"),document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(i),console.log("Excel导出成功"),!0}catch(r){return console.error("导出Excel失败，错误详情:",r),console.log("回退到CSV导出"),xe(e,t,o),!1}},xe=(e,t,o)=>{const a=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),l=`${t}_${a}.csv`;let r="\ufeff";const n=o.map((e=>`"${e.title}"`)).join(",");r+=n+"\r\n",e.forEach((e=>{const t=o.map((t=>{const o=e[t.field];if(null===o||void 0===o)return"";if("number"===t.type||"number"===typeof o)return o;let a=String(o);return(a.includes(",")||a.includes('"')||a.includes("\n"))&&(a=a.replace(/"/g,'""'),a=`"${a}"`),a})).join(",");r+=t+"\r\n"}));const s=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),u=document.createElement("a");u.setAttribute("href",i),u.setAttribute("download",l),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(i),console.log("CSV导出成功")};var Le={name:"RecordsList",components:{ArrowLeft:X.nkM,Home:X.Home,Refresh:X.C42,Plus:X.FWt,User:X.KJW,ArrowDown:X.yd$,ArrowUp:X.DoI,Download:X.f5X,ElImageViewer:he.Tg,Loading:X.Rhj},props:{unitId:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),o=(0,f.KR)([]),a=(0,f.KR)(!1),r=(0,f.KR)(""),n=(0,f.KR)([]),i=(0,f.KR)(!0),u=w.baseURL,d=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},c=(0,f.KR)(1),p=(0,f.KR)(20),m=(0,f.KR)(!0),v=(0,f.KR)(!1),k=(0,f.Kh)({dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:""}),b=(0,l.EW)((()=>o.value&&Array.isArray(o.value)?o.value.filter((e=>{if(k.wasteTypeId&&e.waste_type_id!==k.wasteTypeId)return!1;if(null!==k.minQuantity&&parseFloat(e.quantity)<k.minQuantity)return!1;if(null!==k.maxQuantity&&parseFloat(e.quantity)>k.maxQuantity)return!1;if(k.location&&!e.location.toLowerCase().includes(k.location.toLowerCase()))return!1;if(k.dateRange&&2===k.dateRange.length){const t=new Date(k.dateRange[0]),o=new Date(k.dateRange[1]);o.setHours(23,59,59);const a=new Date(e.collection_start_time);if(a<t||a>o)return!1}return!0})):[])),y=(0,l.EW)((()=>Nt.isAdmin())),_=(0,l.EW)((()=>Nt.isUnitAdmin())),F=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},I=async()=>{await j(),g.nk.success("记录已刷新")},x=()=>{const e=Nt.getUnitId();e?t.push(`/unit/${e}`):t.push("/")},L=()=>{t.push("/")},R=()=>{t.push("/user-management")},C=()=>{t.push(`/unit/${e.unitId}`)},T=e=>{t.push(`/record/${e}`)},W=e=>{if(!e)return!1;if(y.value)return!0;const t=Nt.getUnitId();if(_.value&&t&&e.unit_id===parseInt(t))return!0;const o=Nt.getUserId();return o&&e.creator_id===parseInt(o)},U=e=>{ve.s.confirm("确定要删除这条废物记录吗？此操作不可逆。","删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await St.delete(`${w.endpoints.wasteRecords}/${e.id}`),g.nk.success("记录已成功删除"),await j()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败，请重试")}})).catch((()=>{g.nk.info("已取消删除")}))},V=async()=>{try{c.value=1,await j(),g.nk.success("筛选条件已应用")}catch(e){console.error("应用筛选失败:",e),g.nk.error("应用筛选失败")}},E=async()=>{k.dateRange=null,k.wasteTypeId=null,k.minQuantity=null,k.maxQuantity=null,k.location="",c.value=1,await j(),g.nk.success("筛选条件已重置")},$=async()=>{try{await ve.s.confirm("请选择导出格式","导出选项",{confirmButtonText:"带图片导出",cancelButtonText:"不带图片导出",distinguishCancelAndClose:!0,type:"info"}).then((async()=>{await P()})).catch((e=>{"cancel"===e&&A()}))}catch(e){console.error("导出过程发生错误:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}},P=async()=>{try{(0,g.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const t=we.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const o={wasteTypeId:k.wasteTypeId?k.wasteTypeId:void 0,minQuantity:k.minQuantity?k.minQuantity:void 0,maxQuantity:k.maxQuantity?k.maxQuantity:void 0,location:k.location||void 0,dateRange:k.dateRange?JSON.stringify(k.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0};console.log("导出记录的筛选条件:",o);const{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${Nt.state.user.id}`,{params:o});if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return t.close(),g.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);t.setText(`准备导出 ${l.length} 条记录...`);const n=l.map((e=>{const t=d(e.photo_path_before),o=d(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"数量(kg)":e.quantity,"收集开始时间":F(e.collection_start_time),"填报人":e.creator_name||"系统","清理前照片":t.length>0?t[0]:"","清理后照片":o.length>0?o[0]:""}})),s=`危险废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"数量(kg)",field:"数量(kg)"},{text:"收集开始时间",field:"收集开始时间"},{text:"填报人",field:"填报人"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],u=window.location.origin,c=(e,o)=>{const a=Math.round(e/o*100);t.setText(`正在导出：${a}% (${e}/${o})`)},p=await Fe(n,s,i,u,c);t.close(),p?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),g.nk.error("导出失败: "+(t.message||"未知错误"))}finally{a.value=!1,we.Ks.service().close()}},A=async()=>{try{const t=we.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const o={wasteTypeId:k.wasteTypeId?k.wasteTypeId:void 0,minQuantity:k.minQuantity?k.minQuantity:void 0,maxQuantity:k.maxQuantity?k.maxQuantity:void 0,location:k.location||void 0,dateRange:k.dateRange?JSON.stringify(k.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0},{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${Nt.state.user.id}`,{params:o});if(0===l.length)return t.close(),g.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);t.setText(`准备导出 ${l.length} 条记录...`);const n=l.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"数量(kg)":e.quantity,"收集开始时间":F(e.collection_start_time),"填报人":e.creator_name||"系统","清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),s=`危险废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"数量(kg)",field:"数量(kg)"},{text:"收集开始时间",field:"收集开始时间"},{text:"填报人",field:"填报人"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],u=await Ie(n,s,i);t.close(),u?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),g.nk.error("导出失败: "+(t.message||"未知错误"))}finally{a.value=!1,we.Ks.service().close()}},K=(0,f.KR)(!1),S=(0,f.KR)([]),X=(0,f.KR)(0),D=(e,t)=>{const o=Array.isArray(e)?e:[e];S.value=o.map((e=>`${u}${e}`)),X.value=t||0,K.value=!0},B=()=>{K.value=!1};(0,l.sV)((async()=>{await q(),await Q(),await j()}));const Q=async()=>{try{const e=await St.get(w.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型列表失败")}},q=async()=>{try{const t=await St.get(w.endpoints.units),o=t.data.find((t=>t.id===parseInt(e.unitId)));o&&(r.value=o.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},j=async(e=!1)=>{e?v.value=!0:(a.value=!0,c.value=1,o.value=[]);try{const t={page:c.value,pageSize:p.value};k.wasteTypeId&&(t.wasteTypeId=k.wasteTypeId),null!==k.minQuantity&&(t.minQuantity=k.minQuantity),null!==k.maxQuantity&&(t.maxQuantity=k.maxQuantity),k.location&&(t.location=k.location),k.dateRange&&2===k.dateRange.length&&(t.dateRange=JSON.stringify(k.dateRange));const a=Nt.getUserId();if(!a)throw new Error("用户未登录");const l=await St.get(`${w.endpoints.wasteRecordsByUser}/${a}`,{params:t});l.data&&Array.isArray(l.data.records)?(o.value=e?[...o.value,...l.data.records]:l.data.records,m.value=!!l.data.hasMore):(console.error("Invalid response format:",l.data),o.value=[],m.value=!1,g.nk.error("获取废物记录失败：数据格式错误"))}catch(t){console.error("Error fetching records:",t),o.value=[],m.value=!1,g.nk.error("获取废物记录失败")}finally{a.value=!1,v.value=!1}},M=async e=>{if(!e||!e.target)return;const t=e.target.scrollHeight||0,o=e.target.scrollTop||0,a=e.target.clientHeight||0;t-o-a<50&&m.value&&!v.value&&(c.value++,await j(!0))};return{records:o,filteredRecords:b,loading:a,unitName:r,wasteTypes:n,isAdmin:y,isUnitAdmin:_,parseFormattedDateTime:F,refreshRecords:I,goBack:x,goHome:L,goToUserManagement:R,addNewRecord:C,editRecord:T,canEdit:W,confirmDelete:U,apiConfig:w,showFilterPanel:i,filterForm:k,applyFilter:V,resetFilter:E,exportRecords:$,showViewer:K,previewImages:S,previewIndex:X,previewPhoto:D,closeViewer:B,handleScroll:M,parsePhotoPath:d,baseUrl:u,page:c,pageSize:p,hasMore:m,loadingMore:v}}};const Re=(0,x.A)(Le,[["render",fe],["__scopeId","data-v-615e5dad"]]);var Ce=Re;const Te={class:"login-container"},We={class:"login-card"},Ue={key:0,class:"login-error"};function Ve(e,t,o,r,n,s){const u=(0,l.g2)("el-input"),d=(0,l.g2)("el-form-item"),c=(0,l.g2)("el-radio"),p=(0,l.g2)("el-radio-group"),m=(0,l.g2)("el-checkbox"),g=(0,l.g2)("el-button"),f=(0,l.g2)("el-form");return(0,l.uX)(),(0,l.CE)("div",Te,[(0,l.Lk)("div",We,[t[9]||(t[9]=(0,l.Lk)("div",{class:"login-header"},[(0,l.Lk)("h1",null,"危险废物管理系统"),(0,l.Lk)("h2",null,"用户登录")],-1)),(0,l.bF)(f,{ref:"loginForm",model:r.form,rules:r.rules,"label-width":"80px",class:"login-form",onSubmit:(0,a.D$)(r.submitForm,["prevent"])},{default:(0,l.k6)((()=>[(0,l.bF)(d,{label:"手机号",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(u,{modelValue:r.form.phone,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,l.bF)(d,{label:"密码",prop:"password"},{default:(0,l.k6)((()=>[(0,l.bF)(u,{modelValue:r.form.password,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:r.form.userType,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.userType=e),onChange:r.handleUserTypeChange},{default:(0,l.k6)((()=>[(0,l.bF)(c,{label:1},{default:(0,l.k6)((()=>t[4]||(t[4]=[(0,l.eW)("员工")]))),_:1}),(0,l.bF)(c,{label:2},{default:(0,l.k6)((()=>t[5]||(t[5]=[(0,l.eW)("单位管理员")]))),_:1}),(0,l.bF)(c,{label:3},{default:(0,l.k6)((()=>t[6]||(t[6]=[(0,l.eW)("超级管理员")]))),_:1})])),_:1},8,["modelValue","onChange"])])),_:1}),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:r.form.rememberMe,"onUpdate:modelValue":t[3]||(t[3]=e=>r.form.rememberMe=e)},{default:(0,l.k6)((()=>t[7]||(t[7]=[(0,l.eW)("记住登录")]))),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(g,{type:"primary","native-type":"submit",onClick:r.submitForm,loading:r.auth.state.loading,style:{width:"100%"}},{default:(0,l.k6)((()=>t[8]||(t[8]=[(0,l.eW)(" 登录 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules","onSubmit"]),r.auth.state.error?((0,l.uX)(),(0,l.CE)("div",Ue,(0,i.v_)(r.auth.state.error),1)):(0,l.Q3)("",!0)])])}var Ee={name:"LoginView",setup(){const e=(0,s.rd)(),t=(0,f.KR)(null),o=(0,f.Kh)({phone:"",password:"",userType:1,rememberMe:!1}),a=(0,l.EW)((()=>!0)),r=(0,l.EW)((()=>{const e=[{required:!0,message:"请输入手机号",trigger:"submit"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"submit"}],t=[{required:!0,message:"请输入密码",trigger:"submit"}];return{phone:e,password:t}})),n=()=>{t.value&&t.value.clearValidate()},i=async()=>{console.log("提交表单被触发"),t.value?Nt.state.loading?console.log("登录正在进行中，跳过"):(console.log("登录模式"),t.value.validate((async e=>{e?(console.log("表单验证通过"),await u()):console.log("表单验证失败")}))):console.log("表单引用不存在")},u=async()=>{console.log("开始登录，账号:",o.phone,"用户类型:",o.userType);try{console.log("开始处理登录操作...");const t=await Nt.login(o.phone,o.password,o.rememberMe,o.userType);if(console.log("登录响应:",t),t.success){const o=t.user;g.nk.success(`欢迎，${o.username||o.phone}`),3===o.role_id?e.push("/admin-records"):2===o.role_id?e.push(`/records/${o.unit_id}`):e.push(`/unit/${o.unit_id}`)}else g.nk.error(t.error||"登录失败")}catch(t){g.nk.error(t.response?.data?.error||"登录失败，请检查网络连接")}};return(0,l.sV)((()=>{if(Nt.state.isLoggedIn){const t=Nt.state.user;3===t.role_id?e.push("/admin-records"):2===t.role_id?e.push(`/records/${t.unit_id}`):e.push(`/unit/${t.unit_id}`)}})),{form:o,rules:r,loginForm:t,showPassword:a,handleUserTypeChange:n,submitForm:i,auth:Nt}}};const $e=(0,x.A)(Ee,[["render",Ve],["__scopeId","data-v-735f8166"]]);var Pe=$e;const Ae={class:"edit-record-container"},Ke={class:"header"},Se={class:"content"},Xe={class:"form-header"},De={key:0,class:"upload-warning"},Be=["src"],Qe=["src"],qe={class:"upload-progress"},je={class:"upload-status"};function Me(e,t,o,a,r,n){const s=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),d=(0,l.g2)("el-option"),c=(0,l.g2)("el-select"),p=(0,l.g2)("el-form-item"),m=(0,l.g2)("el-input"),g=(0,l.g2)("el-date-picker"),f=(0,l.g2)("clock"),h=(0,l.g2)("el-time-picker"),v=(0,l.g2)("el-input-number"),w=(0,l.g2)("el-alert"),k=(0,l.g2)("plus"),b=(0,l.g2)("el-upload"),y=(0,l.g2)("el-image-viewer"),_=(0,l.g2)("el-button"),F=(0,l.g2)("el-collapse-item"),I=(0,l.g2)("el-collapse"),x=(0,l.g2)("el-form"),L=(0,l.g2)("el-progress"),R=(0,l.g2)("el-dialog"),C=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Ae,[(0,l.Lk)("div",Ke,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>a.goBack&&a.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 返回 "))]),(0,l.Lk)("h1",null,(0,i.v_)(a.isNew?"新增废物记录":"编辑废物记录"),1),t[9]||(t[9]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Se,[(0,l.Lk)("div",Xe,[(0,l.Lk)("h2",null,(0,i.v_)(a.unitName),1)]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(x,{ref:"recordForm",model:a.form,rules:a.rules,"label-width":"120px",class:"record-form"},{default:(0,l.k6)((()=>[a.isSuperAdmin&&a.isNew?((0,l.uX)(),(0,l.Wv)(p,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:a.form.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>a.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.units,(e=>((0,l.uX)(),(0,l.Wv)(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(p,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:a.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>a.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"产生地点",prop:"location"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:a.form.location,"onUpdate:modelValue":t[3]||(t[3]=e=>a.form.location=e),placeholder:"请输入废物产生地点"},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集日期"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.collectionDate,"onUpdate:modelValue":t[4]||(t[4]=e=>a.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:a.form.collectionTime,"onUpdate:modelValue":t[5]||(t[5]=e=>a.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:a.form.quantity,"onUpdate:modelValue":t[6]||(t[6]=e=>a.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集前）",prop:"photo_path_before"},{default:(0,l.k6)((()=>[t[10]||(t[10]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),a.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",De,[(0,l.bF)(w,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(b,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":a.handlePhotoBeforeChange,"on-remove":a.handlePhotoBeforeRemove,"file-list":a.fileListBefore,limit:5,multiple:"","list-type":"picture-card","on-preview":a.handlePictureCardPreview,"before-upload":a.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集后）",prop:"photo_path_after"},{default:(0,l.k6)((()=>[t[11]||(t[11]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(b,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":a.handlePhotoAfterChange,"on-remove":a.handlePhotoAfterRemove,"file-list":a.fileListAfter,limit:5,multiple:"","list-type":"picture-card","on-preview":a.handlePictureCardPreview,"before-upload":a.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),a.showViewer?((0,l.uX)(),(0,l.Wv)(y,{key:0,"url-list":a.previewImages,"initial-index":a.previewIndex,onClose:a.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,null,{default:(0,l.k6)((()=>[(0,l.bF)(_,{type:"primary",onClick:a.submitForm,loading:a.loading},{default:(0,l.k6)((()=>t[12]||(t[12]=[(0,l.eW)("保存")]))),_:1},8,["onClick","loading"]),(0,l.bF)(_,{onClick:a.goBack},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("取消")]))),_:1},8,["onClick"])])),_:1}),a.isNew?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.Wv)(I,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(F,{title:"调试信息"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",null,[t[16]||(t[16]=(0,l.Lk)("h4",null,"收集前照片路径:",-1)),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.fileListBefore,((e,o)=>((0,l.uX)(),(0,l.CE)("div",{key:"before-"+o},[(0,l.Lk)("div",null,"名称: "+(0,i.v_)(e.name),1),(0,l.Lk)("div",null,"URL: "+(0,i.v_)(e.url),1),(0,l.Lk)("div",null,[(0,l.Lk)("img",{src:e.url,style:{"max-width":"200px","max-height":"200px"}},null,8,Be)]),t[14]||(t[14]=(0,l.Lk)("hr",null,null,-1))])))),128)),t[17]||(t[17]=(0,l.Lk)("h4",null,"收集后照片路径:",-1)),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.fileListAfter,((e,o)=>((0,l.uX)(),(0,l.CE)("div",{key:"after-"+o},[(0,l.Lk)("div",null,"名称: "+(0,i.v_)(e.name),1),(0,l.Lk)("div",null,"URL: "+(0,i.v_)(e.url),1),(0,l.Lk)("div",null,[(0,l.Lk)("img",{src:e.url,style:{"max-width":"200px","max-height":"200px"}},null,8,Qe)]),t[15]||(t[15]=(0,l.Lk)("hr",null,null,-1))])))),128))])])),_:1})])),_:1}))])),_:1},8,["model","rules"])),[[C,a.loading]])]),(0,l.bF)(R,{modelValue:a.showUploadProgress,"onUpdate:modelValue":t[7]||(t[7]=e=>a.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",qe,[t[18]||(t[18]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(L,{percentage:a.uploadPercentage,format:a.percentageFormat,status:100===a.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",je,(0,i.v_)(a.uploadStatus),1)])])),_:1},8,["modelValue"]),t[19]||(t[19]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var ze={name:"EditRecordView",components:{ArrowLeft:X.nkM,Plus:X.FWt,Clock:X.zD7,ElImageViewer:he.Tg},setup(){const e=(0,s.rd)(),t=(0,s.lq)(),o=(0,f.KR)(null),a=(0,f.KR)(!1),r=(0,f.KR)(!1),n=(0,f.KR)(""),i=(0,f.KR)([]),u=(0,f.KR)([]),d=(0,f.KR)([]),c=(0,f.KR)([]),p=(0,f.KR)([]),m=(0,f.KR)([]),h=(0,f.KR)([]),v=(0,f.KR)(!1),k=(0,f.KR)(0),b=(0,f.KR)(""),y=(0,f.KR)(!1),_=(0,f.KR)(0),F=(0,f.KR)("准备上传..."),I=(0,f.KR)(!1),x=e=>{if(!e)return[];console.log("解析照片路径，原始值:",e,"类型:",typeof e);try{if(Array.isArray(e))return console.log("照片路径已经是数组:",e),e;if("string"===typeof e){if(e.startsWith("[")&&e.endsWith("]")){const t=JSON.parse(e);return console.log("照片路径解析为JSON数组:",t),t}if(e.includes(",")){const t=e.split(",").map((e=>e.trim())).filter((e=>e));return console.log("照片路径解析为逗号分隔字符串:",t),t}return console.log("照片路径解析为单个字符串:",[e]),[e]}return console.log("照片路径类型未知，尝试转换为字符串:",String(e)),[String(e)]}catch(t){return console.error("解析照片路径失败:",t),"string"===typeof e?[e]:[]}},L=(0,l.EW)((()=>!t.params.id||"new"===t.params.id)),R=(0,l.EW)((()=>Nt.state.isLoggedIn&&3===Nt.state.user.role_id)),C=(0,f.Kh)({unitId:"",wasteTypeId:"",location:"",collectionDate:"",collectionTime:"",quantity:0,recordId:null,creatorId:Nt.state.user?.id||null,photo_path_before:"",photo_path_after:"",remarks:""}),T={unitId:[{required:!0,message:"请选择单位",trigger:"change"}],wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],location:[{required:!0,message:"请输入废物产生地点",trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{a.value=!0;try{await V(),R.value&&await W(),L.value?!R.value&&Nt.state.user&&(C.unitId=Nt.state.user.unit_id,await U(C.unitId)):await E()}catch(e){console.error("初始化数据失败:",e),g.nk.error("加载数据失败，请刷新重试")}finally{a.value=!1}}));const W=async()=>{try{const e=await St.get(w.endpoints.units);u.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},U=async e=>{try{const t=await St.get(w.endpoints.units),o=t.data.find((t=>t.id===parseInt(e)));o&&(n.value=o.name)}catch(t){console.error("获取单位信息失败:",t)}},V=async()=>{try{const e=await St.get(w.endpoints.wasteTypes);i.value=e.data}catch(e){console.error("获取废物类型失败:",e),g.nk.error("获取废物类型失败")}},E=async()=>{try{a.value=!0;const e=await St.get(`${w.endpoints.wasteRecords}/detail/${t.params.id}`),o=e.data;if(console.log("获取到的记录详情:",o),C.unitId=o.unit_id,C.wasteTypeId=o.waste_type_id,C.location=o.location,C.recordId=o.id,o.collection_start_time){const e=new Date(o.collection_start_time);C.collectionDate=e.toISOString().slice(0,10),C.collectionTime=e.toTimeString().slice(0,5)}if(C.quantity=o.quantity,o.photo_path_before){console.log("收集前照片路径:",o.photo_path_before);const e=x(o.photo_path_before);console.log("解析后的收集前照片路径:",e),d.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const o=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${o}`}return console.log("收集前照片完整URL:",t),{name:e.split("/").pop(),url:t}}))}if(o.photo_path_after){console.log("收集后照片路径:",o.photo_path_after);const e=x(o.photo_path_after);console.log("解析后的收集后照片路径:",e),c.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const o=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${o}`}return console.log("收集后照片完整URL:",t),{name:e.split("/").pop(),url:t}}))}n.value=o.unit_name,b.value=o.created_at,X([...d.value,...c.value])}catch(e){console.error("获取记录详情失败:",e),g.nk.error("获取记录详情失败")}finally{a.value=!1}},$=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],o=t.includes(e.type);if(!o)return g.nk.error("只能上传图片文件!"),!1;const a=52428800;return e.size>a?(g.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{y.value=!0,F.value="正在处理图片...",_.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(B())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){_.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){_.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(o){const a=e.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([o],a,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),F.value="图片处理完成",_.value=100,setTimeout((()=>{y.value=!1}),500),t(l)},error(o){console.error("图片压缩失败:",o),F.value="处理失败，使用原始图片",_.value=100,setTimeout((()=>{y.value=!1}),500),t(e)}})}))},P=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),d.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){y.value=!0,F.value="正在处理图片...",_.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(B())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){_.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){_.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(o){const a=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([o],a,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),F.value="图片处理完成",_.value=100,t(l)},error(o){console.error("图片压缩失败:",o),F.value="处理失败，使用原始图片",_.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const o=p.value.findIndex((t=>t.uid===e.uid||t.name===e.name));o>=0?p.value[o]=t:p.value.push(t);const a=d.value.findIndex((t=>t.uid===e.uid));a>=0&&(d.value[a].processed=!0),setTimeout((()=>{y.value=!1}),500)}catch(o){console.error("处理图片时出错:",o),g.nk.warning("图片处理失败，将使用原始图片");const t=p.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?p.value[t]=e.raw:p.value.push(e.raw),y.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return q(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集前照片添加raw属性:",e.raw)),X([...d.value,...c.value]),console.log("更新后的fileListBefore:",d.value),console.log("更新后的photoFilesBefore:",p.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},A=(e,t)=>{console.log("收集前照片移除:",e),d.value=t,q([...d.value,...c.value])||(I.value=!1),X([...d.value,...c.value])},K=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){y.value=!0,F.value="正在处理图片...",_.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(B())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){_.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){_.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(o){const a=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([o],a,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),F.value="图片处理完成",_.value=100,t(l)},error(o){console.error("图片压缩失败:",o),F.value="处理失败，使用原始图片",_.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const o=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));o>=0?m.value[o]=t:m.value.push(t);const a=c.value.findIndex((t=>t.uid===e.uid));a>=0&&(c.value[a].processed=!0),setTimeout((()=>{y.value=!1}),500)}catch(o){console.error("处理图片时出错:",o),g.nk.warning("图片处理失败，将使用原始图片");const t=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?m.value[t]=e.raw:m.value.push(e.raw),y.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return q(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集后照片添加raw属性:",e.raw)),X([...d.value,...c.value]),console.log("更新后的fileListAfter:",c.value),console.log("更新后的photoFilesAfter:",m.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},S=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,q([...d.value,...c.value])||(I.value=!1),X([...d.value,...c.value])},X=e=>{h.value=e.map((e=>e.url?(console.log("预览图片URL:",e.url),e.url):e.raw?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e.raw)),console.log("预览图片从raw创建:",e._blobUrl),e._blobUrl):e instanceof File?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e)),console.log("预览图片从File创建:",e._blobUrl),e._blobUrl):"")).filter((e=>e)),console.log("预览图片列表:",h.value)},D=e=>{console.log("预览图片:",e),X([...d.value,...c.value]);const t=h.value.findIndex((t=>{if(e.url)return t===e.url;if(e.raw){const o=URL.createObjectURL(e.raw),a=t===o;return URL.revokeObjectURL(o),a}return!1}));k.value=-1!==t?t:0,v.value=!0},Q=()=>{v.value=!1},q=e=>{const t=2097152;return e.some((e=>e.size>t))},j=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);_.value=t,F.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},M=e=>100===e?"完成":`${e}%`,z=async()=>{o.value&&await o.value.validate((async e=>{if(!e)return console.log("表单验证失败"),g.nk.error("请填写所有必填字段"),!1;_.value=0,F.value="正在上传文件...",y.value=!0;try{const e=new FormData;if(e.append("unitId",C.unitId),e.append("wasteTypeId",C.wasteTypeId),e.append("location",C.location),e.append("collectionDate",C.collectionDate),e.append("collectionTime",C.collectionTime),e.append("quantity",C.quantity),e.append("remarks",C.remarks||""),d.value.length>0){const t=d.value.filter((e=>e.raw)),o=d.value.filter((e=>!e.raw));if(t.length>0){if(console.log("有新上传的收集前照片，需要合并现有照片"),t.forEach((t=>{t.raw&&(console.log("添加新的收集前照片:",t.raw.name),e.append("photo_before",t.raw))})),o.length>0){const t=o.map((e=>{let t=e.url;const o=window.location.origin;return t.startsWith(o)&&(t=t.substring(o.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集前照片路径:",t),e.append("photo_path_before",JSON.stringify(t))}}else if(o.length>0){const t=o.map((e=>{let t=e.url;const o=window.location.origin;return t.startsWith(o)&&(t=t.substring(o.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集前照片路径(无新照片):",t),e.append("photo_path_before",JSON.stringify(t))}}else e.append("photo_path_before",JSON.stringify([]));if(c.value.length>0){const t=c.value.filter((e=>e.raw)),o=c.value.filter((e=>!e.raw));if(t.length>0){if(console.log("有新上传的收集后照片，需要合并现有照片"),t.forEach((t=>{t.raw&&(console.log("添加新的收集后照片:",t.raw.name),e.append("photo_after",t.raw))})),o.length>0){const t=o.map((e=>{let t=e.url;const o=window.location.origin;return t.startsWith(o)&&(t=t.substring(o.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集后照片路径:",t),e.append("photo_path_after",JSON.stringify(t))}}else if(o.length>0){const t=o.map((e=>{let t=e.url;const o=window.location.origin;return t.startsWith(o)&&(t=t.substring(o.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集后照片路径(无新照片):",t),e.append("photo_path_after",JSON.stringify(t))}}else e.append("photo_path_after",JSON.stringify([]));console.log("FormData内容:");for(let[t,o]of e.entries())o instanceof File?console.log(`${t}: File - ${o.name} (${o.type}, ${o.size} bytes)`):console.log(`${t}: ${o}`);C.recordId?(await St.putForm(`${w.endpoints.wasteRecords}/${C.recordId}`,e,j),g.nk.success("废物记录更新成功")):(await St.postForm(w.endpoints.wasteRecords,e,j),g.nk.success("废物记录添加成功")),y.value=!1,O()}catch(t){console.error("提交表单失败:",t),t.response&&t.response.data?(console.error("服务器返回错误:",t.response.data),g.nk.error(`提交表单失败: ${t.response.data.error||"未知错误"}`)):g.nk.error("提交表单失败，请检查网络连接"),y.value=!1}}))},O=()=>{R.value?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:Nt.state.user.unit_id}})};return{form:C,rules:T,recordForm:o,loading:a,submitting:r,unitName:n,wasteTypes:i,units:u,fileListBefore:d,fileListAfter:c,photoFilesBefore:p,photoFilesAfter:m,previewImages:h,showViewer:v,previewIndex:k,isNew:L,isSuperAdmin:R,parsePhotoPath:x,handlePhotoBeforeChange:P,handlePhotoBeforeRemove:A,handlePhotoAfterChange:K,handlePhotoAfterRemove:S,handlePictureCardPreview:D,handleBeforeUpload:$,closeViewer:Q,submitForm:z,goBack:O,showUploadProgress:y,uploadPercentage:_,uploadStatus:F,percentageFormat:M,showLargeFileWarning:I}}};const Oe=(0,x.A)(ze,[["render",Me],["__scopeId","data-v-eced3ebe"]]);var Ne=Oe;const Ye={class:"user-management-container"},He={class:"header"},Je={class:"content"},Ge={class:"toolbar"},Ze={key:0,class:"password-hint"},et={key:1,class:"password-hint"},tt={class:"dialog-footer"};function ot(e,t,o,a,r,n){const s=(0,l.g2)("arrow-left"),i=(0,l.g2)("el-icon"),u=(0,l.g2)("plus"),d=(0,l.g2)("el-button"),c=(0,l.g2)("el-table-column"),p=(0,l.g2)("el-popconfirm"),m=(0,l.g2)("el-table"),g=(0,l.g2)("el-input"),f=(0,l.g2)("el-form-item"),h=(0,l.g2)("el-option"),v=(0,l.g2)("el-select"),w=(0,l.g2)("el-form"),k=(0,l.g2)("el-dialog"),b=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Ye,[(0,l.Lk)("div",He,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>a.goBack&&a.goBack(...e))},[(0,l.bF)(i,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 返回 "))]),t[9]||(t[9]=(0,l.Lk)("h1",null,"人员管理",-1)),t[10]||(t[10]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Je,[(0,l.Lk)("div",Ge,[(0,l.bF)(d,{type:"primary",onClick:a.openAddDialog},{default:(0,l.k6)((()=>[(0,l.bF)(i,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 添加用户 "))])),_:1},8,["onClick"])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(m,{data:a.users,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,l.k6)((()=>[(0,l.bF)(c,{prop:"id",label:"ID",width:"60"}),(0,l.bF)(c,{prop:"username",label:"姓名",width:"120"}),(0,l.bF)(c,{prop:"phone",label:"手机号",width:"140"}),(0,l.bF)(c,{prop:"role_name",label:"角色",width:"120"}),(0,l.bF)(c,{prop:"unit_name",label:"单位","min-width":"120"}),(0,l.bF)(c,{label:"操作",width:"180",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.bF)(d,{size:"small",onClick:t=>a.handleEdit(e.row)},{default:(0,l.k6)((()=>t[12]||(t[12]=[(0,l.eW)("编辑")]))),_:2},1032,["onClick"]),(0,l.bF)(p,{title:"确定要删除此用户吗？",onConfirm:t=>a.handleDelete(e.row)},{reference:(0,l.k6)((()=>[(0,l.bF)(d,{size:"small",type:"danger"},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"])),[[b,a.loading]])]),(0,l.bF)(k,{modelValue:a.dialogVisible,"onUpdate:modelValue":t[7]||(t[7]=e=>a.dialogVisible=e),title:a.isEdit?"编辑用户":"添加用户",width:"500px"},{footer:(0,l.k6)((()=>[(0,l.Lk)("span",tt,[(0,l.bF)(d,{onClick:t[6]||(t[6]=e=>a.dialogVisible=!1)},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(d,{type:"primary",onClick:a.submitForm,loading:a.formLoading},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(w,{ref:"userForm",model:a.form,rules:a.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"姓名",prop:"username"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.username,"onUpdate:modelValue":t[1]||(t[1]=e=>a.form.username=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),(0,l.bF)(f,{label:"手机号",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.phone,"onUpdate:modelValue":t[2]||(t[2]=e=>a.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,l.bF)(f,{label:"角色",prop:"roleId"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:a.form.roleId,"onUpdate:modelValue":t[3]||(t[3]=e=>a.form.roleId=e),placeholder:"请选择角色",style:{width:"100%"}},{default:(0,l.k6)((()=>[a.isSuperAdmin?((0,l.uX)(),(0,l.Wv)(h,{key:0,value:3,label:"超级管理员"})):(0,l.Q3)("",!0),(0,l.bF)(h,{value:2,label:"单位管理员"}),(0,l.bF)(h,{value:1,label:"基层员工"})])),_:1},8,["modelValue"])])),_:1}),3!==a.form.roleId?((0,l.uX)(),(0,l.Wv)(f,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:a.form.unitId,"onUpdate:modelValue":t[4]||(t[4]=e=>a.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"},disabled:!a.isSuperAdmin&&a.isEdit},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.units,(e=>((0,l.uX)(),(0,l.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(f,{label:"密码",prop:"password"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.password,"onUpdate:modelValue":t[5]||(t[5]=e=>a.form.password=e),placeholder:"请输入密码",type:"password","show-password":""},null,8,["modelValue"]),a.isEdit?((0,l.uX)(),(0,l.CE)("div",et,"不修改密码请留空")):((0,l.uX)(),(0,l.CE)("div",Ze,"所有账号必须设置密码"))])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),t[16]||(t[16]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var at={name:"UserManagement",components:{ArrowLeft:X.nkM,Plus:X.FWt},setup(){const e=(0,s.rd)(),t=(0,f.KR)(!1),o=(0,f.KR)(!1),a=(0,f.KR)(!1),r=(0,f.KR)(!1),n=(0,f.KR)(null),i=(0,f.KR)([]),u=(0,f.KR)([]),d=(0,l.EW)((()=>Nt.state.isLoggedIn&&3===Nt.state.user.role_id)),c=(0,l.EW)((()=>Nt.state.isLoggedIn?Nt.state.user.unit_id:null)),p=(0,f.Kh)({id:null,username:"",phone:"",roleId:1,unitId:null,password:""}),m={username:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],unitId:[{required:!0,message:"请选择单位",trigger:"change"}],password:[{required:function(){return!r.value},message:"请输入密码",trigger:"blur"},{min:1,max:20,message:"长度在 1 到 20 个字符",trigger:"blur"}]},h=async()=>{t.value=!0;try{let e;e=d.value?await St.get(w.endpoints.users):await St.get(`${w.endpoints.units}/${c.value}/users`),i.value=e.data}catch(e){console.error("Error fetching users:",e),g.nk.error("获取用户列表失败")}finally{t.value=!1}},v=async()=>{try{const e=await St.get(w.endpoints.units);u.value=e.data}catch(e){console.error("Error fetching units:",e),g.nk.error("获取单位列表失败")}},k=()=>{r.value=!1,_(),a.value=!0,d.value||(p.unitId=c.value)},b=e=>{r.value=!0,p.id=e.id,p.username=e.username,p.phone=e.phone,p.roleId=e.role_id,p.unitId=e.unit_id,p.password="",a.value=!0},y=async e=>{try{await St.delete(`${w.endpoints.users}/${e.id}`),g.nk.success("用户删除成功"),h()}catch(t){console.error("Error deleting user:",t);let e="删除用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}},_=()=>{n.value&&n.value.resetFields(),p.id=null,p.username="",p.phone="",p.roleId=1,p.unitId=null,p.password=""},F=()=>{n.value.validate((async e=>{if(e){o.value=!0;try{const e={username:p.username,phone:p.phone,roleId:p.roleId,unitId:3!==p.roleId?p.unitId:null};p.password&&(e.password=p.password),r.value?(await St.put(`${w.endpoints.users}/${p.id}`,e),g.nk.success("用户更新成功")):(await St.post(w.endpoints.users,e),g.nk.success("用户添加成功")),a.value=!1,h()}catch(t){console.error("Error submitting user form:",t);let e=r.value?"更新用户失败":"添加用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}finally{o.value=!1}}else g.nk.warning("请完成必填项")}))},I=()=>{e.back()};return(0,l.sV)((()=>{h(),v()})),{loading:t,formLoading:o,dialogVisible:a,isEdit:r,userForm:n,users:i,units:u,form:p,rules:m,isSuperAdmin:d,currentUnitId:c,openAddDialog:k,handleEdit:b,handleDelete:y,submitForm:F,goBack:I}}};const lt=(0,x.A)(at,[["render",ot],["__scopeId","data-v-53211ca3"]]);var rt=lt;const nt={class:"admin-records-container"},st={class:"content"},it={class:"actions"},ut={class:"filter-header"},dt={class:"filter-form-container"},ct={class:"quantity-range"},pt={class:"filter-actions"},mt={class:"records-wrapper"},gt={class:"card-header"},ft={class:"card-actions"},ht={key:0,class:"photo-preview"},vt=["onClick"],wt={key:0,class:"photo-count"},kt={key:1},bt={key:0,class:"photo-preview"},yt=["onClick"],_t={key:0,class:"photo-count"},Ft={key:1},It={class:"operation-buttons"},xt={key:0,class:"loading-more"},Lt={key:1,class:"empty-block"};function Rt(e,t,o,r,n,s){const u=(0,l.g2)("plus"),d=(0,l.g2)("el-icon"),c=(0,l.g2)("el-button"),p=(0,l.g2)("user"),m=(0,l.g2)("refresh"),g=(0,l.g2)("arrow-down"),f=(0,l.g2)("arrow-up"),h=(0,l.g2)("el-option"),v=(0,l.g2)("el-select"),w=(0,l.g2)("el-form-item"),k=(0,l.g2)("el-col"),b=(0,l.g2)("el-date-picker"),y=(0,l.g2)("el-row"),_=(0,l.g2)("el-input-number"),F=(0,l.g2)("el-input"),I=(0,l.g2)("el-form"),x=(0,l.g2)("el-card"),L=(0,l.g2)("download"),R=(0,l.g2)("el-table-column"),C=(0,l.g2)("el-image"),T=(0,l.g2)("el-table"),W=(0,l.g2)("loading"),U=(0,l.g2)("el-empty"),V=(0,l.g2)("el-image-viewer"),E=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",nt,[t[19]||(t[19]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"危险废物管理系统 - 全部记录")],-1)),(0,l.Lk)("div",st,[(0,l.Lk)("div",it,[(0,l.bF)(c,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[7]||(t[7]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),(0,l.bF)(c,{type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"]),(0,l.bF)(c,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(m)])),_:1}),t[9]||(t[9]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,l.bF)(x,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ut,[t[10]||(t[10]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(c,{type:"primary",link:"",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(d,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})):((0,l.uX)(),(0,l.Wv)(d,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",dt,[(0,l.bF)(I,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(k,{span:12},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"所属单位"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.unitId=e),placeholder:"选择单位",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(k,{span:12},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(y,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(k,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(k,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ct,[(0,l.bF)(_,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"47%"}},null,8,["modelValue"]),t[11]||(t[11]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.bF)(_,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"47%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,l.bF)(k,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.Lk)("div",pt,[(0,l.bF)(c,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[12]||(t[12]=[(0,l.eW)("筛选")]))),_:1},8,["onClick"]),(0,l.bF)(c,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[a.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",mt,[(0,l.bF)(x,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",gt,[t[15]||(t[15]=(0,l.Lk)("h3",null,"所有废物记录",-1)),(0,l.Lk)("div",ft,[(0,l.bF)(c,{type:"warning",onClick:r.exportRecords},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(L)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(T,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:"500",onScroll:r.handleScroll},{default:(0,l.k6)((()=>[(0,l.bF)(R,{prop:"unit_name",label:"单位",width:"100"}),(0,l.bF)(R,{prop:"waste_type_name",label:"废物类型",width:"100"}),(0,l.bF)(R,{prop:"location",label:"产生地点"}),(0,l.bF)(R,{prop:"collection_start_time",label:"收集开始时间",width:"160"}),(0,l.bF)(R,{label:"数量(吨)",width:"80"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(parseFloat(e.row.quantity).toFixed(3)),1)])),_:1}),(0,l.bF)(R,{prop:"creator_name",label:"汇报人",width:"100"}),(0,l.bF)(R,{prop:"created_at",label:"记录时间",width:"160"}),(0,l.bF)(R,{label:"现场照片（清理前）",width:"120",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",ht,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,o)=>((0,l.uX)(),(0,l.CE)("div",{key:o,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),o)},[(0,l.bF)(C,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,vt)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",wt,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",kt,"无"))])),_:1}),(0,l.bF)(R,{label:"现场照片（清理后）",width:"120",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",bt,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,o)=>((0,l.uX)(),(0,l.CE)("div",{key:o,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),o)},[(0,l.bF)(C,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,yt)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",_t,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",Ft,"无"))])),_:1}),(0,l.bF)(R,{label:"操作",width:"70",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",It,[(0,l.bF)(c,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,l.bF)(c,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","onScroll"])),[[E,r.loading]]),r.loadingMore?((0,l.uX)(),(0,l.CE)("div",xt,[(0,l.bF)(d,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(W)])),_:1}),t[18]||(t[18]=(0,l.eW)(" 加载更多... "))])):(0,l.Q3)("",!0),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",Lt,[(0,l.bF)(U,{description:"暂无废物记录"})]))])),_:1})])]),t[20]||(t[20]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,l.uX)(),(0,l.Wv)(V,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}const Ct=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},Tt=(e,t)=>{if(!e.photos)return[];try{const o=JSON.parse(e.photos);return Array.isArray(o)?o.filter((e=>e.type===t)):[]}catch(o){return console.error("解析照片JSON失败:",o),[]}};var Wt={name:"AdminRecordsView",components:{Plus:X.FWt,Refresh:X.C42,User:X.KJW,ArrowDown:X.yd$,ArrowUp:X.DoI,Download:X.f5X,ElImageViewer:he.Tg,Loading:X.Rhj},setup(){const e=(0,s.rd)(),t=(0,f.KR)([]),o=(0,f.KR)(!1),a=(0,f.KR)([]),r=(0,f.KR)([]),n=(0,f.KR)(!0),i=w.baseURL,u=(0,f.KR)(!1),d=(0,f.KR)([]),c=(0,f.KR)(0),p=(0,f.KR)(1),m=(0,f.KR)(20),v=(0,f.KR)(!0),k=(0,f.KR)(!1),b=(0,f.Kh)({unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:""}),y=(0,l.EW)((()=>t.value.filter((e=>{if(b.unitId&&e.unit_id!==b.unitId)return!1;if(b.wasteTypeId&&e.waste_type_id!==b.wasteTypeId)return!1;if(null!==b.minQuantity&&parseFloat(e.quantity)<b.minQuantity)return!1;if(null!==b.maxQuantity&&parseFloat(e.quantity)>b.maxQuantity)return!1;if(b.location&&!e.location.toLowerCase().includes(b.location.toLowerCase()))return!1;if(b.dateRange&&2===b.dateRange.length){const t=new Date(b.dateRange[0]),o=new Date(b.dateRange[1]);if(o.setHours(23,59,59,999),!e.collection_start_time)return!1;{const a=_(e.collection_start_time);if(a<t||a>o)return!1}}return!0})))),_=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)};(0,l.sV)((async()=>{if(!Nt.state.isLoggedIn||3!==Nt.state.user.role_id)return g.nk.error("权限不足"),void e.push("/login");await Promise.all([F(),I(),x()])}));const F=async()=>{try{const e=await h.A.get(w.getUrl(w.endpoints.units));a.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},I=async()=>{try{const e=await h.A.get(w.getUrl(w.endpoints.wasteTypes));r.value=e.data}catch(e){console.error("获取废物类型列表失败:",e),g.nk.error("获取废物类型列表失败")}},x=async(e=!1)=>{e?k.value=!0:(o.value=!0,p.value=1,t.value=[]);try{const o={page:p.value,pageSize:m.value,wasteTypeId:b.wasteTypeId,minQuantity:b.minQuantity,maxQuantity:b.maxQuantity,location:b.location};b.dateRange&&2===b.dateRange.length&&(o.dateRange=JSON.stringify(b.dateRange));const a=await h.A.get(`${w.getUrl(w.endpoints.wasteRecords)}/user/${Nt.state.user.id}`,{params:o}),l=a.data.records.map((e=>({...e,created_at:L(e.created_at),collection_start_time:L(e.collection_start_time)})));t.value=e?[...t.value,...l]:l,v.value=a.data.hasMore,v.value&&p.value++}catch(a){console.error("获取废物记录失败:",a),g.nk.error("获取废物记录失败")}finally{o.value=!1,k.value=!1}},L=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})},R=()=>{x()},C=()=>{3===Nt.state.user.role_id?e.push("/record/new"):e.push(`/unit/${Nt.state.user.unit_id}`)},T=()=>{e.push("/user-management")},W=t=>{e.push(`/record/${t}`)},U=async()=>{await x(),g.nk.success("筛选已应用")},V=async()=>{b.unitId=null,b.dateRange=null,b.wasteTypeId=null,b.minQuantity=null,b.maxQuantity=null,b.location="",await x(),g.nk.info("筛选条件已重置")},E=async()=>{try{await ve.s.confirm("请选择导出格式","导出选项",{confirmButtonText:"带图片导出",cancelButtonText:"不带图片导出",distinguishCancelAndClose:!0,type:"info"}).then((async()=>{await $()})).catch((e=>{"cancel"===e&&P()}))}catch(e){console.error("导出过程发生错误:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}},$=async()=>{try{(0,g.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=we.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const t={wasteTypeId:b.wasteTypeId?b.wasteTypeId:void 0,minQuantity:b.minQuantity?b.minQuantity:void 0,maxQuantity:b.maxQuantity?b.maxQuantity:void 0,location:b.location||void 0,dateRange:b.dateRange?JSON.stringify(b.dateRange):void 0,unitId:b.unitId?b.unitId:void 0};console.log("导出记录的筛选条件:",t);const{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${Nt.state.user.id}`,{params:t});if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return e.close(),g.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);e.setText(`准备导出 ${l.length} 条记录...`);const r=l.map((e=>{const t=Ct(e.photo_path_before),o=Ct(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"数量(kg)":e.quantity,"收集开始时间":L(e.collection_start_time),"填报人":e.creator_name||"系统","清理前照片":t.length>0?t[0]:"","清理后照片":o.length>0?o[0]:""}})),n=b.unitId?a.value.find((e=>e.id===b.unitId))?.name||"未知单位":"全部单位",s=`危险废物记录_${n}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"数量(kg)",field:"数量(kg)"},{text:"收集开始时间",field:"收集开始时间"},{text:"填报人",field:"填报人"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],u=window.location.origin,d=(t,o)=>{const a=Math.round(t/o*100);e.setText(`正在导出：${a}% (${t}/${o})`)},c=await Fe(r,s,i,u,d);e.close(),c?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}finally{o.value=!1,we.Ks.service().close()}},P=async()=>{try{const e=we.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const t={wasteTypeId:b.wasteTypeId?b.wasteTypeId:void 0,minQuantity:b.minQuantity?b.minQuantity:void 0,maxQuantity:b.maxQuantity?b.maxQuantity:void 0,location:b.location||void 0,dateRange:b.dateRange?JSON.stringify(b.dateRange):void 0,unitId:b.unitId?b.unitId:void 0},{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${Nt.state.user.id}`,{params:t});if(0===l.length)return e.close(),g.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);e.setText(`准备导出 ${l.length} 条记录...`);const r=l.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"数量(kg)":e.quantity,"收集开始时间":L(e.collection_start_time),"填报人":e.creator_name||"系统","清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),n=b.unitId?a.value.find((e=>e.id===b.unitId))?.name||"未知单位":"全部单位",s=`危险废物记录_${n}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"数量(kg)",field:"数量(kg)"},{text:"收集开始时间",field:"收集开始时间"},{text:"填报人",field:"填报人"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],u=await Ie(r,s,i);e.close(),u?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}finally{o.value=!1,we.Ks.service().close()}},A=e=>{ve.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await h.A.delete(`${w.getUrl(w.endpoints.wasteRecords)}/${e.id}`),g.nk.success("删除成功"),await x()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败")}})).catch((()=>{g.nk.info("已取消删除")}))},K=(e,t)=>{const o=Array.isArray(e)?e:[e];d.value=o.map((e=>`${i}${e}`)),c.value=t||0,u.value=!0},S=()=>{u.value=!1},X=async e=>{const t=e.target;t&&t.scrollHeight&&!k.value&&v.value&&t.scrollHeight-t.scrollTop-t.clientHeight<100&&await x(!0)};return{records:t,filteredRecords:y,loading:o,units:a,wasteTypes:r,showFilterPanel:n,filterForm:b,applyFilter:U,resetFilter:V,exportRecords:E,parsePhotoPath:Ct,getPhotosByType:Tt,refreshRecords:R,addNewRecord:C,goToUserManagement:T,editRecord:W,confirmDelete:A,showViewer:u,previewImages:d,previewIndex:c,previewPhoto:K,closeViewer:S,baseUrl:i,page:p,pageSize:m,hasMore:v,loadingMore:k,handleScroll:X}}};const Ut=(0,x.A)(Wt,[["render",Rt],["__scopeId","data-v-027944f7"]]);var Vt=Ut;const Et=[{path:"/login",name:"Login",component:Pe,meta:{requiresAuth:!1}},{path:"/user-management",name:"UserManagement",component:rt,meta:{requiresAuth:!0,requiresManager:!0}},{path:"/",name:"UnitSelection",component:R,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/admin-records",name:"AdminRecords",component:Vt,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/record/new",name:"EditRecord",component:Ne,props:{id:null},meta:{requiresAuth:!0}},{path:"/record/:id",name:"EditRecord",component:Ne,props:!0,meta:{requiresAuth:!0}},{path:"/unit/:id",name:"WasteForm",component:j,props:!0,meta:{requiresAuth:!0}},{path:"/records/:unitId",name:"RecordsList",component:Ce,props:!0,meta:{requiresAuth:!0}}],$t=(0,s.aE)({history:(0,s.LA)("/"),routes:Et});$t.beforeEach(((e,t,o)=>{const a=e.matched.some((e=>e.meta.requiresAuth)),l=e.matched.some((e=>e.meta.requiresSuperAdmin)),r=e.matched.some((e=>e.meta.requiresManager));if(!a||Nt.state.isLoggedIn)if(l&&Nt.state.isLoggedIn&&3!==Nt.state.user.role_id)o({name:"WasteForm",params:{id:Nt.state.user.unit_id}});else if(r&&Nt.state.isLoggedIn&&1===Nt.state.user.role_id)o({name:"WasteForm",params:{id:Nt.state.user.unit_id}});else{if("Login"!==e.name||!Nt.state.isLoggedIn)return"/"===e.path&&Nt.state.isLoggedIn?3===Nt.state.user.role_id?void o({name:"AdminRecords"}):2===Nt.state.user.role_id?void o({name:"RecordsList",params:{unitId:Nt.state.user.unit_id}}):void o({name:"WasteForm",params:{id:Nt.state.user.unit_id}}):void("WasteForm"===e.name&&Nt.state.isLoggedIn&&3!==Nt.state.user.role_id&&Nt.state.user.unit_id!==parseInt(e.params.id)?o({name:"WasteForm",params:{id:Nt.state.user.unit_id}}):o());3===Nt.state.user.role_id?o({name:"AdminRecords"}):2===Nt.state.user.role_id?o({name:"RecordsList",params:{unitId:Nt.state.user.unit_id}}):o({name:"WasteForm",params:{id:Nt.state.user.unit_id}})}else o({name:"Login"})}));var Pt=$t;const At=h.A.create({baseURL:w.baseURL,timeout:3e5,headers:{"Content-Type":"application/json"},maxContentLength:52428800,maxBodyLength:52428800});At.interceptors.request.use((e=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return t&&(e.headers.Authorization=`Bearer ${t}`),e}),(e=>(console.error("Request error:",e),Promise.reject(e)))),At.interceptors.response.use((e=>e),(e=>{if(e.response)switch(e.response.status){case 401:if(e.config.url.includes("/api/login"))return Promise.reject(e);Nt.logout(),g.nk.error("登录已过期，请重新登录"),Pt.push("/login");break;case 403:g.nk.error("没有权限访问该资源");break;case 404:g.nk.error("请求的资源不存在");break;case 500:g.nk.error("服务器错误，请稍后重试");break;default:g.nk.error(e.response.data?.error||"请求失败")}else e.request?g.nk.error("网络错误，请检查网络连接"):g.nk.error("请求配置错误");return Promise.reject(e)}));const Kt={get(e,t={}){return At.get(e,{params:t})},post(e,t={}){return At.post(e,t)},postForm(e,t,o){const a={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};return"function"===typeof o&&(a.onUploadProgress=o),At.post(e,t,a)},put(e,t={}){return At.put(e,t)},putForm(e,t,o){const a={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};return"function"===typeof o&&(a.onUploadProgress=o),At.put(e,t,a)},delete(e){return At.delete(e)},defaults:At.defaults};var St=Kt;const Xt={user:null,token:null,isLoggedIn:!1,loading:!1,error:null},Dt=(0,f.Kh)({...Xt}),Bt=()=>{const e=localStorage.getItem("user"),t=localStorage.getItem("token");if(e&&t)try{const o=JSON.parse(e);Dt.user=o,Dt.token=t,Dt.isLoggedIn=!0,St.defaults&&St.defaults.headers&&(St.defaults.headers.common["Authorization"]=`Bearer ${t}`)}catch(o){console.error("Error parsing saved user data:",o),localStorage.removeItem("user"),localStorage.removeItem("token")}},Qt=async(e,t,o=!1,a=1)=>{Dt.loading=!0,Dt.error=null,console.log("auth.login 开始执行，手机号:",e,"用户类型:",a);try{const l={phone:e,rememberMe:o,userType:a};null!==t&&void 0!==t&&""!==t?(l.password=t,console.log("auth.login 发送密码参数")):console.log("auth.login 不发送密码参数"),console.log("发送登录请求，数据:",l);const r=await St.post(w.endpoints.login,l);console.log("登录请求成功响应:",r.data);const{token:n,...s}=r.data;return Dt.user=s,Dt.token=n,Dt.isLoggedIn=!0,St.defaults&&St.defaults.headers&&(St.defaults.headers.common["Authorization"]=`Bearer ${n}`),o?(localStorage.setItem("user",JSON.stringify(s)),localStorage.setItem("token",n)):(sessionStorage.setItem("user",JSON.stringify(s)),sessionStorage.setItem("token",n)),{success:!0,user:s}}catch(l){return Dt.error=l.response?.data?.error||"登录失败，请检查网络连接",console.error("Login error:",l),{success:!1,error:Dt.error}}finally{Dt.loading=!1}},qt=()=>{Dt.user=null,Dt.token=null,Dt.isLoggedIn=!1,St.defaults&&St.defaults.headers&&delete St.defaults.headers.common["Authorization"],localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")},jt=()=>Dt.isLoggedIn&&Dt.user&&3===Dt.user.role_id,Mt=()=>Dt.isLoggedIn&&Dt.user&&2===Dt.user.role_id,zt=()=>Dt.user?Dt.user.id:null,Ot=()=>Dt.user?Dt.user.unit_id:null;Bt();var Nt={state:Dt,login:Qt,logout:qt,isAdmin:jt,isUnitAdmin:Mt,getUserId:zt,getUnitId:Ot},Yt={name:"AppHeader",setup(){const e=(0,s.rd)(),t=(0,l.EW)((()=>Nt.state.isLoggedIn?Nt.state.user.username||Nt.state.user.phone:"")),o=()=>{Nt.logout(),g.nk.success("已退出登录"),e.push("/login")};return{auth:Nt,userName:t,handleLogout:o}}};const Ht=(0,x.A)(Yt,[["render",m],["__scopeId","data-v-47e31eb0"]]);var Jt=Ht,Gt={components:{AppHeader:Jt},setup(){const e=(0,s.lq)(),t=(0,l.EW)((()=>"/login"!==e.path));return{showHeader:t}}};const Zt=(0,x.A)(Gt,[["render",n]]);var eo=Zt,to=o(6070),oo=(o(4188),o(5186));const ao=(0,a.Ef)(eo);ao.use(Pt),ao.use(to.A,{locale:oo.A}),ao.mount("#app")}},t={};function o(a){var l=t[a];if(void 0!==l)return l.exports;var r=t[a]={exports:{}};return e[a].call(r.exports,r,r.exports,o),r.exports}o.m=e,function(){var e=[];o.O=function(t,a,l,r){if(!a){var n=1/0;for(d=0;d<e.length;d++){a=e[d][0],l=e[d][1],r=e[d][2];for(var s=!0,i=0;i<a.length;i++)(!1&r||n>=r)&&Object.keys(o.O).every((function(e){return o.O[e](a[i])}))?a.splice(i--,1):(s=!1,r<n&&(n=r));if(s){e.splice(d--,1);var u=l();void 0!==u&&(t=u)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[a,l,r]}}(),function(){o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,{a:t}),t}}(),function(){o.d=function(e,t){for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){o.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};o.O.j=function(t){return 0===e[t]};var t=function(t,a){var l,r,n=a[0],s=a[1],i=a[2],u=0;if(n.some((function(t){return 0!==e[t]}))){for(l in s)o.o(s,l)&&(o.m[l]=s[l]);if(i)var d=i(o)}for(t&&t(a);u<n.length;u++)r=n[u],o.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return o.O(d)},a=self["webpackChunkhazardous_waste_management_frontend"]=self["webpackChunkhazardous_waste_management_frontend"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=o.O(void 0,[504],(function(){return o(4420)}));a=o.O(a)})();
//# sourceMappingURL=app.c9c81929.js.map