(function(){"use strict";var e={6638:function(e,t,a){var l=a(5130),o=a(6768);const r={id:"app"};function n(e,t,a,l,n,s){const i=(0,o.g2)("app-header"),d=(0,o.g2)("router-view");return(0,o.uX)(),(0,o.CE)("div",r,[l.showHeader?((0,o.uX)(),(0,o.Wv)(i,{key:0})):(0,o.Q3)("",!0),(0,o.bF)(d)])}var s=a(1387),i=a(4232);const d={class:"app-header"},u={key:0,class:"user-info"},c={class:"welcome-text"},p={key:0,class:"company-tag"},m={key:1,class:"unit-tag"},g={class:"dialog-footer"};function f(e,t,a,r,n,s){const f=(0,o.g2)("chat-line-round"),k=(0,o.g2)("el-icon"),h=(0,o.g2)("el-button"),b=(0,o.g2)("user"),v=(0,o.g2)("el-option"),y=(0,o.g2)("el-select"),w=(0,o.g2)("el-form-item"),_=(0,o.g2)("el-input"),F=(0,o.g2)("el-form"),x=(0,o.g2)("el-dialog");return(0,o.uX)(),(0,o.CE)("div",d,[t[12]||(t[12]=(0,o.Lk)("div",{class:"logo"},[(0,o.Lk)("h1",null,"固体废物管理系统")],-1)),r.auth.state.isLoggedIn?((0,o.uX)(),(0,o.CE)("div",u,[(0,o.Lk)("span",c,[t[5]||(t[5]=(0,o.eW)(" 欢迎, ")),(0,o.Lk)("strong",null,(0,i.v_)(r.userName),1),r.auth.state.user.company_name?((0,o.uX)(),(0,o.CE)("span",p,(0,i.v_)(r.auth.state.user.company_name),1)):(0,o.Q3)("",!0),r.auth.state.user.unit_name?((0,o.uX)(),(0,o.CE)("span",m,(0,i.v_)(r.auth.state.user.unit_name),1)):(0,o.Q3)("",!0)]),(0,o.bF)(h,{type:"text",class:"feedback-button",onClick:r.showFeedbackDialog},{default:(0,o.k6)((()=>[(0,o.bF)(k,null,{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1}),t[6]||(t[6]=(0,o.eW)(" 问题反馈 "))])),_:1},8,["onClick"]),(0,o.bF)(h,{type:"text",class:"profile-button",onClick:r.goToProfile},{default:(0,o.k6)((()=>[(0,o.bF)(k,null,{default:(0,o.k6)((()=>[(0,o.bF)(b)])),_:1}),t[7]||(t[7]=(0,o.eW)(" 账号设置 "))])),_:1},8,["onClick"]),(0,o.bF)(h,{type:"text",class:"logout-button",onClick:r.handleLogout},{default:(0,o.k6)((()=>t[8]||(t[8]=[(0,o.eW)(" 退出登录 ")]))),_:1},8,["onClick"])])):(0,o.Q3)("",!0),(0,o.bF)(x,{modelValue:r.feedbackVisible,"onUpdate:modelValue":t[4]||(t[4]=e=>r.feedbackVisible=e),title:"问题反馈",width:"600px","close-on-click-modal":!1,onClose:r.closeFeedbackDialog},{footer:(0,o.k6)((()=>[(0,o.Lk)("div",g,[(0,o.bF)(h,{onClick:r.resetForm},{default:(0,o.k6)((()=>t[9]||(t[9]=[(0,o.eW)("重置")]))),_:1},8,["onClick"]),(0,o.bF)(h,{onClick:r.closeFeedbackDialog},{default:(0,o.k6)((()=>t[10]||(t[10]=[(0,o.eW)("取消")]))),_:1},8,["onClick"]),(0,o.bF)(h,{type:"primary",onClick:r.submitForm,loading:r.loading},{default:(0,o.k6)((()=>t[11]||(t[11]=[(0,o.eW)(" 提交反馈 ")]))),_:1},8,["onClick","loading"])])])),default:(0,o.k6)((()=>[(0,o.bF)(F,{ref:"formRef",model:r.form,rules:r.rules,"label-width":"100px",onSubmit:(0,l.D$)(r.submitForm,["prevent"])},{default:(0,o.k6)((()=>[(0,o.bF)(w,{label:"问题类型",prop:"type"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{modelValue:r.form.type,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.type=e),placeholder:"请选择问题类型",style:{width:"100%"}},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"系统漏洞",value:"bug"}),(0,o.bF)(v,{label:"功能建议",value:"feature"}),(0,o.bF)(v,{label:"体验改进",value:"improvement"}),(0,o.bF)(v,{label:"其他问题",value:"other"})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(w,{label:"优先级",prop:"priority"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{modelValue:r.form.priority,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.priority=e),placeholder:"请选择优先级",style:{width:"100%"}},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"低",value:"low"}),(0,o.bF)(v,{label:"中",value:"medium"}),(0,o.bF)(v,{label:"高",value:"high"}),(0,o.bF)(v,{label:"紧急",value:"urgent"})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(w,{label:"问题标题",prop:"title"},{default:(0,o.k6)((()=>[(0,o.bF)(_,{modelValue:r.form.title,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.title=e),placeholder:"请简要描述问题"},null,8,["modelValue"])])),_:1}),(0,o.bF)(w,{label:"问题描述",prop:"description"},{default:(0,o.k6)((()=>[(0,o.bF)(_,{modelValue:r.form.description,"onUpdate:modelValue":t[3]||(t[3]=e=>r.form.description=e),type:"textarea",rows:6,placeholder:"请详细描述遇到的问题，包括出现的情况、预期的结果等"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules","onSubmit"])])),_:1},8,["modelValue","onClose"])])}var k=a(144),h=a(1219),b=a(2933),v=a(7477),y=a(4373);const w="";var _={baseURL:w,endpoints:{login:"/api/login",users:"/api/users",usersByUnit:"/api/users/unit",userStatus:"/api/users/:id/status",userProfile:"/api/users/:id/profile",units:"/api/units",wasteTypes:"/api/waste-types",wasteRecords:"/api/waste-records",wasteRecordsByUnit:"/api/waste-records",wasteRecordDetail:"/api/waste-records/detail",wasteRecordsByUser:"/api/waste-records/user",exportWasteRecords:"/api/waste-records/export/user",operationLogs:"/api/operation-logs",operationLogStats:"/api/operation-logs/stats",operationLogUserStats:"/api/operation-logs/user-stats",exportOperationLogs:"/api/operation-logs/export",userLogPermission:"/api/users/:id/log-permission",companies:"/api/companies",companyById:"/api/companies/:id",companyStats:"/api/companies/:id/stats",feedback:"/api/feedback",userFeedbacks:"/api/feedback/user",adminFeedbacks:"/api/feedback/admin",feedbackStats:"/api/feedback/stats",feedbackById:"/api/feedback/:id",feedbackStatus:"/api/feedback/:id/status"},getUrl(e){return`${this.baseURL}${e}`}};const F={class:"unit-selection-container"},x={class:"content"},L={class:"units-grid"},C={class:"unit-name"};function I(e,t,a,l,r,n){const s=(0,o.g2)("el-card");return(0,o.uX)(),(0,o.CE)("div",F,[t[1]||(t[1]=(0,o.Lk)("div",{class:"header"},[(0,o.Lk)("h1",null,"固体废物管理系统")],-1)),(0,o.Lk)("div",x,[t[0]||(t[0]=(0,o.Lk)("h2",null,"请选择您的单位",-1)),(0,o.Lk)("div",L,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.units,(e=>((0,o.uX)(),(0,o.Wv)(s,{key:e.id,class:"unit-card",shadow:"hover",onClick:t=>n.selectUnit(e)},{default:(0,o.k6)((()=>[(0,o.Lk)("div",C,(0,i.v_)(e.name),1)])),_:2},1032,["onClick"])))),128))])]),t[2]||(t[2]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var R={name:"UnitSelection",data(){return{units:[],loading:!1}},created(){this.fetchUnits()},methods:{async fetchUnits(){this.loading=!0;try{console.log("正在获取单位列表...");const e=await Po.get(_.endpoints.units);console.log("获取单位列表成功:",e.data),this.units=e.data}catch(e){console.error("获取单位列表失败:",e),h.nk.error("获取单位列表失败")}finally{this.loading=!1}},selectUnit(e){this.$router.push({name:"WasteForm",params:{id:e.id}})}}},W=a(1241);const V=(0,W.A)(R,[["render",I],["__scopeId","data-v-608acce8"]]);var $=V;const T={class:"waste-form-container"},S={class:"header"},P={key:1},K={class:"content"},E={class:"unit-info"},U={class:"form-row"},A={key:0,class:"upload-warning"},D={class:"form-actions"},X={class:"upload-progress"},Q={class:"upload-status"};function M(e,t,a,l,r,n){const s=(0,o.g2)("arrow-left"),d=(0,o.g2)("el-icon"),u=(0,o.g2)("document"),c=(0,o.g2)("el-option"),p=(0,o.g2)("el-select"),m=(0,o.g2)("el-form-item"),g=(0,o.g2)("el-input"),f=(0,o.g2)("el-date-picker"),k=(0,o.g2)("clock"),h=(0,o.g2)("el-time-picker"),b=(0,o.g2)("el-input-number"),v=(0,o.g2)("el-alert"),y=(0,o.g2)("plus"),w=(0,o.g2)("el-upload"),_=(0,o.g2)("el-button"),F=(0,o.g2)("el-form"),x=(0,o.g2)("el-progress"),L=(0,o.g2)("el-dialog");return(0,o.uX)(),(0,o.CE)("div",T,[(0,o.Lk)("div",S,[l.isAdmin?((0,o.uX)(),(0,o.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(s)])),_:1}),t[13]||(t[13]=(0,o.eW)(" 返回 "))])):((0,o.uX)(),(0,o.CE)("div",P)),t[15]||(t[15]=(0,o.Lk)("h1",null,"固体废物填报",-1)),(0,o.Lk)("div",{class:"view-records",onClick:t[1]||(t[1]=(...e)=>l.viewRecords&&l.viewRecords(...e))},[t[14]||(t[14]=(0,o.eW)(" 查看记录 ")),(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1})])]),(0,o.Lk)("div",K,[(0,o.Lk)("div",E,[(0,o.Lk)("h2",null,(0,i.v_)(l.unitName),1)]),(0,o.bF)(F,{ref:"wasteForm",model:l.form,rules:l.rules,"label-position":"top",class:"waste-form"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{label:"废物类型",prop:"wasteTypeId"},{default:(0,o.k6)((()=>[(0,o.bF)(p,{modelValue:l.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"产生工序",prop:"process"},{default:(0,o.k6)((()=>[(0,o.bF)(p,{modelValue:l.form.process,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.process=e),placeholder:"请选择产生工序",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.processOptions,(e=>((0,o.uX)(),(0,o.Wv)(c,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===l.form.process?((0,o.uX)(),(0,o.Wv)(g,{key:0,modelValue:l.customProcess,"onUpdate:modelValue":t[4]||(t[4]=e=>l.customProcess=e),placeholder:"请输入具体产生工序",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,o.Q3)("",!0)])),_:1}),(0,o.bF)(m,{label:"产生地点",prop:"location"},{default:(0,o.k6)((()=>[(0,o.bF)(p,{modelValue:l.form.location,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.location=e),placeholder:"请选择废物产生地点",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.locationOptions,(e=>((0,o.uX)(),(0,o.Wv)(c,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===l.form.location?((0,o.uX)(),(0,o.Wv)(g,{key:0,modelValue:l.customLocation,"onUpdate:modelValue":t[6]||(t[6]=e=>l.customLocation=e),placeholder:"请输入具体产生地点",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,o.Q3)("",!0)])),_:1}),(0,o.bF)(m,{label:"备注",prop:"remarks"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:l.form.remarks,"onUpdate:modelValue":t[7]||(t[7]=e=>l.form.remarks=e),type:"textarea",rows:1,placeholder:"请输入备注信息（选填）"},null,8,["modelValue"])])),_:1}),(0,o.Lk)("div",U,[(0,o.bF)(m,{label:"收集日期",class:"date-item"},{default:(0,o.k6)((()=>[(0,o.bF)(f,{modelValue:l.form.collectionDate,"onUpdate:modelValue":t[8]||(t[8]=e=>l.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,"popper-class":"date-picker-popup",teleported:!1},null,8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"收集时间",class:"time-item"},{default:(0,o.k6)((()=>[(0,o.bF)(h,{modelValue:l.form.collectionTime,"onUpdate:modelValue":t[9]||(t[9]=e=>l.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"},editable:!1,"popper-class":"time-picker-popup",teleported:!1},{prefix:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(k)])),_:1})])),_:1},8,["modelValue"])])),_:1})]),(0,o.bF)(m,{label:"收集数量(吨)",prop:"quantity"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{modelValue:l.form.quantity,"onUpdate:modelValue":t[10]||(t[10]=e=>l.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"},onFocus:t[11]||(t[11]=e=>l.selectAllText(e)),"input-props":{inputmode:"decimal",pattern:"[0-9]*[.,]?[0-9]*"},controls:!1},null,8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"现场照片（收集前）",prop:"photo_before"},{default:(0,o.k6)((()=>[t[16]||(t[16]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),l.showLargeFileWarning?((0,o.uX)(),(0,o.CE)("div",A,[(0,o.bF)(v,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,o.Q3)("",!0),(0,o.bF)(w,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoBeforeChange,"on-remove":l.handlePhotoBeforeRemove,"file-list":l.fileListBefore,limit:5,multiple:"","list-type":"picture-card","before-upload":l.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(y)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,o.bF)(m,{label:"现场照片（收集后）",prop:"photo_after"},{default:(0,o.k6)((()=>[t[17]||(t[17]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,o.bF)(w,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoAfterChange,"on-remove":l.handlePhotoAfterRemove,"file-list":l.fileListAfter,limit:5,multiple:"","list-type":"picture-card","before-upload":l.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(y)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,o.Lk)("div",D,[(0,o.bF)(_,{type:"primary",class:"submit-btn",onClick:l.submitForm,loading:l.loading},{default:(0,o.k6)((()=>t[18]||(t[18]=[(0,o.eW)("提交")]))),_:1},8,["onClick","loading"]),(0,o.bF)(_,{class:"reset-btn",onClick:l.resetForm},{default:(0,o.k6)((()=>t[19]||(t[19]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model","rules"])]),(0,o.bF)(L,{modelValue:l.showUploadProgress,"onUpdate:modelValue":t[12]||(t[12]=e=>l.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,o.k6)((()=>[(0,o.Lk)("div",X,[t[20]||(t[20]=(0,o.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,o.bF)(x,{percentage:l.uploadPercentage,format:l.percentageFormat,status:100===l.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,o.Lk)("p",Q,(0,i.v_)(l.uploadStatus),1)])])),_:1},8,["modelValue"]),t[21]||(t[21]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var B=a(9372),q=a.n(B),z={name:"WasteForm",components:{ArrowLeft:v.nkM,Document:v.yoT,Plus:v.FWt,Clock:v.zD7},props:{id:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),a=(0,k.KR)(null),l=(0,k.KR)(!1),r=(0,k.KR)(""),n=(0,k.KR)([]),i=(0,k.KR)([]),d=(0,k.KR)([]),u=(0,k.KR)([]),c=(0,k.KR)([]),p=(0,k.KR)(!1),m=(0,k.KR)(0),g=(0,k.KR)("准备上传..."),f=(0,k.KR)(!1),b=(0,k.KR)([]),v=(0,k.KR)(""),y=(0,k.KR)(""),w=["作业现场","清罐清理","报废清理","管线刺漏","历史遗留","日常维护","封井退出","其他"],F={"桓台":["金家接转站","金17-1注采站","金17-2注采站","金6金9项目组","金8注采站","其他"],"潍北":["潍北联合站","昌79注采站","昌3注采站","疃3注采站","昌15注采站","其他"],"高青":["高青联合站","樊107注采站","樊14注采站","高21注采站","高54注采站","其他"],"牛庄":["牛25集输站","牛25注采站","营13注采站","史112注采站","其他"],"金角":["长堤注采站","桩23注采站","其他"],"信远":["河125注采站","河122注采站","永551注采站","其他"],"滨博":["樊142注采站","樊142-2-12注采站","樊162注采站","樊页1井组","滨博接转站","其他"],"无棣":["车41注采站","车142注采站","车40注采站","车408注采站","车274注采站","车1接转站","东风港联合站","其他"],"河口":["沾14东注采站","沾14西注采站","渤南注采站","大北注采站","沾5注采站","太平接转站","沾5接转站","其他"],"胜兴":["博兴注采站","其他"],"胜科":["采油一站","其他"],"其他":["其他"]},x=(0,o.EW)((()=>Ho.state.isLoggedIn&&(3===Ho.state.user.role_id||4===Ho.state.user.role_id))),L=(0,k.Kh)({wasteTypeId:"",location:"",collectionDate:(new Date).toISOString().slice(0,10),collectionTime:(new Date).toTimeString().slice(0,5),quantity:void 0,photo_before:[],photo_after:[],remarks:"",process:""}),C={wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],process:[{required:!0,message:"请选择产生工序",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||y.value.trim()?a():a(new Error("请输入具体产生工序"))},trigger:"blur"}],location:[{required:!0,message:"请选择废物产生地点",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||v.value.trim()?a():a(new Error("请输入具体产生地点"))},trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!1,message:"请输入收集数量",trigger:"change"}]};(0,o.sV)((async()=>{const e=document.createElement("meta");e.setAttribute("name","viewport"),e.setAttribute("content","width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1"),document.head.appendChild(e);const t=document.querySelector('meta[name="viewport"]');t&&t!==e&&t.remove(),await I(),await R()})),(0,o.xo)((()=>{const e=document.querySelector('meta[name="viewport"]');e&&e.remove();const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width,initial-scale=1.0"),document.head.appendChild(t)}));const I=async()=>{try{const t=await Po.get(_.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.id)));a&&(r.value=a.name,F[r.value]?b.value=F[r.value]:(b.value=[],console.warn(`未找到管理区 "${r.value}" 的地点选项`)))}catch(t){console.error("Error fetching unit name:",t),h.nk.error("获取单位信息失败")}},R=async()=>{try{const e=await Po.get(_.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),h.nk.error("获取废物类型失败")}},W=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return h.nk.error("只能上传图片文件!"),!1;const l=52428800;return e.size>l?(h.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{p.value=!0,g.value="正在处理图片...",m.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(q())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,g.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,g.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const l=e.name.replace(/\.[^/.]+$/,"")+".jpg",o=new File([a],l,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(o.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-o.size/e.size)),"%"),console.log("- 处理后文件类型:",o.type),console.log("- 处理后文件名:",o.name),g.value="图片处理完成",m.value=100,setTimeout((()=>{p.value=!1}),500),t(o)},error(a){console.error("图片压缩失败:",a),g.value="处理失败，使用原始图片",m.value=100,setTimeout((()=>{p.value=!1}),500),t(e)}})}))},V=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),u.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){p.value=!0,g.value="正在处理图片...",m.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(q())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,g.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,g.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const l=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",o=new File([a],l,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(o.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-o.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",o.type),console.log("- 处理后文件名:",o.name),g.value="图片处理完成",m.value=100,t(o)},error(a){console.error("图片压缩失败:",a),g.value="处理失败，使用原始图片",m.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=i.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?i.value[a]=t:i.value.push(t);const l=u.value.findIndex((t=>t.uid===e.uid));l>=0&&(u.value[l].processed=!0),setTimeout((()=>{p.value=!1}),500)}catch(l){console.error("处理图片时出错:",l),h.nk.warning("图片处理失败，将使用原始图片");const t=i.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?i.value[t]=e.raw:i.value.push(e.raw),p.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const a=[...i.value,...d.value];f.value=P(a),console.log("更新后的photoFilesBefore:",i.value),console.log("更新后的fileListBefore:",u.value)},$=(e,t)=>{console.log("收集前照片移除:",e),u.value=t,e.raw?i.value=i.value.filter((t=>t.name!==e.raw.name)):i.value=i.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),P([...i.value,...d.value])||(f.value=!1),console.log("更新后的photoFilesBefore:",i.value)},T=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){p.value=!0,g.value="正在处理图片...",m.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(q())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,g.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,g.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const l=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",o=new File([a],l,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(o.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-o.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",o.type),console.log("- 处理后文件名:",o.name),g.value="图片处理完成",m.value=100,t(o)},error(a){console.error("图片压缩失败:",a),g.value="处理失败，使用原始图片",m.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=d.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?d.value[a]=t:d.value.push(t);const l=c.value.findIndex((t=>t.uid===e.uid));l>=0&&(c.value[l].processed=!0),setTimeout((()=>{p.value=!1}),500)}catch(l){console.error("处理图片时出错:",l),h.nk.warning("图片处理失败，将使用原始图片");const t=d.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?d.value[t]=e.raw:d.value.push(e.raw),p.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const a=[...i.value,...d.value];f.value=P(a),console.log("更新后的photoFilesAfter:",d.value),console.log("更新后的fileListAfter:",c.value)},S=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,e.raw?d.value=d.value.filter((t=>t.name!==e.raw.name)):d.value=d.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),P([...i.value,...d.value])||(f.value=!1),console.log("更新后的photoFilesAfter:",d.value)},P=e=>{const t=5242880;return e.some((e=>e.size>t))},K=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);m.value=t,g.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},E=e=>100===e?"完成":`${e}%`,U=()=>{a.value.validate((async a=>{if(a){l.value=!0;try{const a=new FormData;a.append("unitId",e.id),a.append("wasteTypeId",L.wasteTypeId),"其他"===L.process&&y.value.trim()?a.append("process",y.value.trim()):a.append("process",L.process),"其他"===L.location&&v.value.trim()?a.append("location",v.value.trim()):a.append("location",L.location),L.collectionDate&&L.collectionTime&&(a.append("collectionDate",L.collectionDate),a.append("collectionTime",L.collectionTime)),void 0!==L.quantity&&null!==L.quantity&&""!==L.quantity&&a.append("quantity",L.quantity),a.append("remarks",L.remarks||""),Ho.state.isLoggedIn&&Ho.state.user?(a.append("creator_id",Ho.state.user.id),console.log("添加用户信息:",{creator_id:Ho.state.user.id,user:Ho.state.user})):console.log("用户未登录或用户信息不完整"),console.log("提交表单数据:",{unitId:e.id,wasteTypeId:L.wasteTypeId,process:"其他"===L.process?y.value:L.process,location:"其他"===L.location?v.value:L.location,quantity:L.quantity,remarks:L.remarks||"",photo_before:i.value?i.value.length:0,photo_after:d.value?d.value.length:0}),i.value&&i.value.length>0&&(console.log("添加收集前照片数量:",i.value.length),i.value.forEach(((e,t)=>{e&&(console.log(`收集前照片 ${t+1}:`,e.name),a.append("photo_before",e))}))),d.value&&d.value.length>0&&(console.log("添加收集后照片数量:",d.value.length),d.value.forEach(((e,t)=>{e&&(console.log(`收集后照片 ${t+1}:`,e.name),a.append("photo_after",e))})));const l=[...i.value||[],...d.value||[]];f.value=P(l),l.length>0&&(p.value=!0,m.value=0,g.value="准备上传...");const o=await Po.postForm(_.endpoints.wasteRecords,a,K);console.log("提交响应:",o.data),h.nk.success("废物记录提交成功！正在跳转到记录列表..."),A(),setTimeout((()=>{if(Ho.state.isLoggedIn&&Ho.state.user){const a=Ho.state.user.role_id;3===a||4===a?t.push("/admin-records"):t.push({name:"RecordsList",params:{unitId:e.id}})}else t.push({name:"RecordsList",params:{unitId:e.id}})}),1500)}catch(o){console.error("Error submitting form:",o),o.response&&(console.error("错误响应数据:",o.response.data),console.error("错误状态码:",o.response.status)),h.nk.error("提交失败，请稍后再试")}finally{l.value=!1,p.value=!1}}else h.nk.warning("请完成必填项")}))},A=()=>{a.value&&a.value.resetFields(),L.wasteTypeId="",L.location="",L.process="",L.remarks="",L.quantity=void 0,L.collectionDate=(new Date).toISOString().slice(0,10),L.collectionTime=(new Date).toTimeString().slice(0,5),v.value="",y.value="",i.value=[],d.value=[],u.value=[],c.value=[],f.value=!1},D=()=>{x.value&&t.push("/")},X=()=>{t.push({name:"RecordsList",params:{unitId:e.id}})},Q=e=>{setTimeout((()=>{if(e&&e.target){const t=e.target.querySelector("input");t&&t.select()}}),10)};return{form:L,rules:C,wasteForm:a,loading:l,unitName:r,wasteTypes:n,isAdmin:x,fileListBefore:u,fileListAfter:c,handlePhotoBeforeChange:V,handlePhotoBeforeRemove:$,handlePhotoAfterChange:T,handlePhotoAfterRemove:S,handleBeforeUpload:W,submitForm:U,resetForm:A,goBack:D,viewRecords:X,selectAllText:Q,showUploadProgress:p,uploadPercentage:m,uploadStatus:g,percentageFormat:E,showLargeFileWarning:f,locationOptions:b,customLocation:v,customProcess:y,processOptions:w}}};const O=(0,W.A)(z,[["render",M],["__scopeId","data-v-5a1688a2"]]);var N=O;const j={class:"records-container"},Y={class:"header"},H={key:1},J={class:"content"},G={class:"unit-info"},Z={class:"actions"},ee={class:"filter-header"},te={class:"filter-form-container"},ae={class:"quantity-range"},le={class:"input-with-clear"},oe={class:"input-with-clear"},re={class:"filter-actions"},ne={class:"records-wrapper"},se={class:"card-header"},ie={class:"card-actions"},de={key:0,class:"photo-preview"},ue=["onClick"],ce={key:0,class:"photo-count"},pe={key:1},me={key:0,class:"photo-preview"},ge=["onClick"],fe={key:0,class:"photo-count"},ke={key:1},he={class:"operation-buttons"},be={key:0,class:"loading-row"},ve={key:1,class:"load-more-row"},ye={key:2,class:"no-more-row"},we={key:0,class:"record-limit-tip"};function _e(e,t,a,r,n,s){const d=(0,o.g2)("arrow-left"),u=(0,o.g2)("el-icon"),c=(0,o.g2)("home"),p=(0,o.g2)("plus"),m=(0,o.g2)("el-button"),g=(0,o.g2)("user"),f=(0,o.g2)("refresh"),k=(0,o.g2)("arrow-down"),h=(0,o.g2)("arrow-up"),b=(0,o.g2)("el-option"),v=(0,o.g2)("el-select"),y=(0,o.g2)("el-form-item"),w=(0,o.g2)("el-col"),_=(0,o.g2)("el-input"),F=(0,o.g2)("el-date-picker"),x=(0,o.g2)("el-row"),L=(0,o.g2)("el-input-number"),C=(0,o.g2)("CircleClose"),I=(0,o.g2)("el-form"),R=(0,o.g2)("el-card"),W=(0,o.g2)("download"),V=(0,o.g2)("el-table-column"),$=(0,o.g2)("el-image"),T=(0,o.g2)("loading"),S=(0,o.g2)("el-table"),P=(0,o.g2)("el-alert"),K=(0,o.g2)("el-image-viewer"),E=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",j,[(0,o.Lk)("div",Y,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(d)])),_:1}),t[11]||(t[11]=(0,o.eW)(" 返回填报 "))]),t[13]||(t[13]=(0,o.Lk)("h1",null,"废物记录查看",-1)),r.isAdmin?((0,o.uX)(),(0,o.CE)("div",{key:0,class:"home-link",onClick:t[1]||(t[1]=(...e)=>r.goHome&&r.goHome(...e))},[t[12]||(t[12]=(0,o.eW)(" 首页 ")),(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(c)])),_:1})])):((0,o.uX)(),(0,o.CE)("div",H))]),(0,o.Lk)("div",J,[(0,o.Lk)("div",G,[(0,o.Lk)("h2",null,(0,i.v_)(r.unitName)+" 固体废物记录",1)]),(0,o.Lk)("div",Z,[(0,o.bF)(m,{type:"primary",onClick:r.addNewRecord},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1}),t[14]||(t[14]=(0,o.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isAdmin&&!r.isSupervisor||r.isUnitAdmin?((0,o.uX)(),(0,o.Wv)(m,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(g)])),_:1}),t[15]||(t[15]=(0,o.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,o.Q3)("",!0),(0,o.bF)(m,{onClick:r.refreshRecords},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1}),t[16]||(t[16]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,o.bF)(R,{class:"filter-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",ee,[t[17]||(t[17]=(0,o.Lk)("h3",null,"筛选条件",-1)),(0,o.bF)(m,{type:"primary",link:"",onClick:t[2]||(t[2]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,o.uX)(),(0,o.Wv)(u,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(h)])),_:1})):((0,o.uX)(),(0,o.Wv)(u,{key:0},{default:(0,o.k6)((()=>[(0,o.bF)(k)])),_:1}))])),_:1})]),(0,o.bo)((0,o.Lk)("div",te,[(0,o.bF)(I,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,o.k6)((()=>[(0,o.bF)(x,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(w,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,o.k6)((()=>[(0,o.bF)(y,{label:"废物类型"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(b,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(w,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,o.k6)((()=>[(0,o.bF)(y,{label:"产生地点"},{default:(0,o.k6)((()=>[(0,o.bF)(_,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(w,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,o.k6)((()=>[(0,o.bF)(y,{label:"产生工序"},{default:(0,o.k6)((()=>[(0,o.bF)(_,{modelValue:r.filterForm.process,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.process=e),placeholder:"输入工序关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(w,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,o.k6)((()=>[(0,o.bF)(y,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(F,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":r.disabledDate},null,8,["modelValue","disabled-date"])])),_:1})])),_:1})])),_:1}),(0,o.bF)(x,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(w,{xs:24,sm:12,md:16,lg:12,xl:12},{default:(0,o.k6)((()=>[(0,o.bF)(y,{label:"数量范围(吨)"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",ae,[(0,o.Lk)("div",le,[(0,o.bF)(L,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"100%"}},null,8,["modelValue"]),null!==r.filterForm.minQuantity?((0,o.uX)(),(0,o.Wv)(u,{key:0,class:"clear-icon",onClick:t[8]||(t[8]=e=>r.filterForm.minQuantity=null)},{default:(0,o.k6)((()=>[(0,o.bF)(C)])),_:1})):(0,o.Q3)("",!0)]),t[18]||(t[18]=(0,o.Lk)("span",{class:"range-separator"},"至",-1)),(0,o.Lk)("div",oe,[(0,o.bF)(L,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[9]||(t[9]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"100%"}},null,8,["modelValue","min"]),null!==r.filterForm.maxQuantity?((0,o.uX)(),(0,o.Wv)(u,{key:0,class:"clear-icon",onClick:t[10]||(t[10]=e=>r.filterForm.maxQuantity=null)},{default:(0,o.k6)((()=>[(0,o.bF)(C)])),_:1})):(0,o.Q3)("",!0)])])])),_:1})])),_:1}),(0,o.bF)(w,{xs:24,sm:12,md:8,lg:12,xl:12,class:"filter-buttons-col"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",re,[(0,o.bF)(m,{type:"primary",onClick:r.applyFilter},{default:(0,o.k6)((()=>t[19]||(t[19]=[(0,o.eW)("刷新筛选")]))),_:1},8,["onClick"]),(0,o.bF)(m,{onClick:r.resetFilter},{default:(0,o.k6)((()=>t[20]||(t[20]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])],512),[[l.aG,r.showFilterPanel]])])),_:1}),(0,o.Lk)("div",ne,[(0,o.bF)(R,{class:"records-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",se,[t[24]||(t[24]=(0,o.Lk)("h3",{class:"table-title"},"废物记录列表",-1)),(0,o.Lk)("div",ie,[(0,o.bF)(m,{type:"warning",onClick:r.exportWithoutImages,loading:r.loading},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(W)])),_:1}),t[21]||(t[21]=(0,o.eW)(" 无照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,o.bF)(m,{type:"warning",onClick:r.exportWithImages,loading:r.loading},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(W)])),_:1}),t[22]||(t[22]=(0,o.eW)(" 包含首张照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,o.bF)(m,{type:"warning",onClick:r.exportWithAllImages,loading:r.loading},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(W)])),_:1}),t[23]||(t[23]=(0,o.eW)(" 包含全部照片(不推荐) "))])),_:1},8,["onClick","loading"])])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(S,{data:r.records,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:r.tableHeight},{append:(0,o.k6)((()=>[r.loadingMore?((0,o.uX)(),(0,o.CE)("div",be,[(0,o.bF)(u,{class:"loading"},{default:(0,o.k6)((()=>[(0,o.bF)(T)])),_:1}),t[27]||(t[27]=(0,o.eW)(" 正在加载... "))])):r.hasMore&&r.records.length>0?((0,o.uX)(),(0,o.CE)("div",ve,[(0,o.bF)(m,{type:"primary",onClick:r.loadMore,disabled:r.loadingMore,size:"small"},{default:(0,o.k6)((()=>[t[28]||(t[28]=(0,o.eW)(" 点击加载更多 ")),(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(k)])),_:1})])),_:1},8,["onClick","disabled"])])):r.records.length>0?((0,o.uX)(),(0,o.CE)("div",ye," 已全部加载 ")):(0,o.Q3)("",!0)])),default:(0,o.k6)((()=>[(0,o.bF)(V,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,o.bF)(V,{prop:"waste_type_name",label:"废物类型","min-width":"120"}),(0,o.bF)(V,{prop:"location",label:"产生地点","min-width":"120"}),(0,o.bF)(V,{prop:"process",label:"产生工序","min-width":"120"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(e.row.process||"无"),1)])),_:1}),(0,o.bF)(V,{prop:"remarks",label:"备注","min-width":"150"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,o.bF)(V,{label:"收集开始时间","min-width":"160"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.collection_start_time)),1)])),_:1}),(0,o.bF)(V,{label:"数量(吨)","min-width":"100"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(null!==e.row.quantity&&void 0!==e.row.quantity?parseFloat(e.row.quantity).toFixed(3):""),1)])),_:1}),(0,o.bF)(V,{label:"汇报人","min-width":"100",class:"mobile-hidden"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(e.row.creator_name||"未知"),1)])),_:1}),(0,o.bF)(V,{label:"记录时间","min-width":"160",class:"mobile-hidden"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.created_at)),1)])),_:1}),(0,o.bF)(V,{label:"清理前照片","min-width":"150",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_before?((0,o.uX)(),(0,o.CE)("div",de,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,o.bF)($,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,ue)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,o.uX)(),(0,o.CE)("div",ce,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",pe,"无"))])),_:1}),(0,o.bF)(V,{label:"清理后照片","min-width":"150",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_after?((0,o.uX)(),(0,o.CE)("div",me,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,o.bF)($,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,ge)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,o.uX)(),(0,o.CE)("div",fe,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",ke,"无"))])),_:1}),(0,o.bF)(V,{label:"操作","min-width":"120"},{default:(0,o.k6)((e=>[(0,o.Lk)("div",he,[r.canEdit(e.row)?((0,o.uX)(),(0,o.Wv)(m,{key:0,type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,o.k6)((()=>t[25]||(t[25]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0),r.canEdit(e.row)&&(r.isAdmin||r.isUnitAdmin)?((0,o.uX)(),(0,o.Wv)(m,{key:1,type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,o.k6)((()=>t[26]||(t[26]=[(0,o.eW)(" 删除 ")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0)])])),_:1})])),_:1},8,["data","height"])),[[E,r.loading]]),r.isAdmin||r.isUnitAdmin?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("div",we,[(0,o.bF)(P,{title:"提示：只能查看过去48小时内的废物记录",type:"info",closable:!1,"show-icon":""})]))])),_:1})])]),r.showViewer?((0,o.uX)(),(0,o.Wv)(K,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])}var Fe=a(8828),xe=a(5320),Le=a(3230),Ce=a(7093),Ie=a.n(Ce);const Re=(e,t="")=>{const a=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),l=t?`.${t}`:"";return`${e}_${a}${l}`},We=e=>e?e.replace(/[\\/:*?"<>|]/g,"_"):"";console.log("XLSX库版本:",Le.version),console.log("XLSX库可用方法:",Object.keys(Le).join(", "));const Ve=async(e,t=window.location.origin)=>{if(console.log("获取图片:",e),!e)return console.error("图片URL为空"),null;const a=e.startsWith("/")?`${t}${e}`:e;try{console.log("获取图片:",a);const e=await fetch(a,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!e.ok)throw new Error(`获取图片失败: ${e.status} ${e.statusText}`);const t=await e.arrayBuffer();return console.log("图片获取成功，大小:",t.byteLength,"字节"),t}catch(l){return console.error("获取图片失败:",l),null}},$e=async(e,t,a,l=window.location.origin,o=null)=>{if(console.log("=== exportToExcelWithImages 函数被调用 ==="),console.log("数据条数:",e.length),!e||0===e.length)return console.error("导出失败：没有数据"),!1;try{const n=We(t),s=Re(n,"xlsx"),i=new(Ie().Workbook);i.creator="固体废物管理系统",i.lastModifiedBy="固体废物管理系统",i.created=new Date,i.modified=new Date;const d=i.addWorksheet("固体废物记录"),u=a.map((e=>({header:e.text,key:e.field,width:e.isImage?20:15})));d.columns=u,d.getRow(1).font={bold:!0},d.getRow(1).alignment={vertical:"middle",horizontal:"center"},console.log("开始处理数据行...");const c=e.length*(1+a.filter((e=>e.isImage)).length);let p=0;for(let t=0;t<e.length;t++){const n=e[t];console.log(`处理第 ${t+1}/${e.length} 条记录...`);const s={};a.forEach((e=>{e.isImage||(s[e.field]=n[e.field]||"")}));const u=d.addRow(s);u.height=80,p++,o&&"function"===typeof o&&o(p,c);for(const e of a)if(e.isImage){const s=e.field,u=n[s];if(u){console.log(`记录 ${t+1} 的 ${s} 字段有图片路径: ${u}`);try{const e=await Ve(u,l);if(e){const l=a.findIndex((e=>e.field===s))+1,o=d.getCell(t+2,l).address,r=i.addImage({buffer:e,extension:u.split(".").pop().toLowerCase()});d.addImage(r,{tl:{col:l-1,row:t+1},br:{col:l,row:t+1.9},editAs:"oneCell"}),console.log(`已添加图片到单元格 ${o}`)}else console.error(`获取图片失败: ${u}`)}catch(r){console.error("处理图片时出错:",r)}}else console.log(`记录 ${t+1} 的 ${s} 没有照片路径`);p++,o&&"function"===typeof o&&o(p,c)}}console.log("数据行处理完成，准备生成Excel文件...");const m=await i.xlsx.writeBuffer(),g=new Blob([m],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=window.URL.createObjectURL(g),k=document.createElement("a");return k.href=f,k.download=s,k.click(),window.URL.revokeObjectURL(f),console.log("Excel文件生成并下载成功"),!0}catch(n){return console.error("导出Excel文件失败:",n),!1}},Te=async(e,t,a)=>{if(!e||0===e.length)return console.error("导出失败：没有数据"),!1;const l=We(t),o=Re(l,"xlsx");console.log("导出函数被调用，数据条数:",e.length);try{console.log("使用ExcelJS导出Excel...");const t=new(Ie().Workbook);t.creator="固体废物管理系统",t.lastModifiedBy="固体废物管理系统",t.created=new Date,t.modified=new Date;const l=t.addWorksheet("固体废物记录"),r=a.map((e=>({header:e.text,key:e.field,width:15})));l.columns=r,l.getRow(1).font={bold:!0},l.getRow(1).alignment={vertical:"middle",horizontal:"center"},e.forEach((e=>{const t={};a.forEach((a=>{t[a.field]=e[a.field]||""})),l.addRow(t)})),console.log("生成Excel数据...");const n=await t.xlsx.writeBuffer(),s=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(s),d=document.createElement("a");return d.href=i,d.download=o,console.log("下载链接创建成功，准备触发点击"),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),console.log("Excel导出成功"),!0}catch(r){return console.error("导出Excel失败，错误详情:",r),console.log("回退到CSV导出"),Se(e,t,a),!1}},Se=(e,t,a)=>{const l=We(t),o=Re(l,"csv");let r="\ufeff";const n=a.map((e=>`"${e.title}"`)).join(",");r+=n+"\r\n",e.forEach((e=>{const t=a.map((t=>{const a=e[t.field];if(null===a||void 0===a)return"";if("number"===t.type||"number"===typeof a)return a;let l=String(a);return(l.includes(",")||l.includes('"')||l.includes("\n"))&&(l=l.replace(/"/g,'""'),l=`"${l}"`),l})).join(",");r+=t+"\r\n"}));const s=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),d=document.createElement("a");d.setAttribute("href",i),d.setAttribute("download",o),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),console.log("CSV导出成功")};var Pe={name:"RecordsList",components:{ArrowLeft:v.nkM,Home:v.Home,Refresh:v.C42,Plus:v.FWt,User:v.KJW,ArrowDown:v.yd$,ArrowUp:v.DoI,Download:v.f5X,ElImageViewer:Fe.Tg,Loading:v.Rhj,CircleClose:v.R$5},props:{unitId:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),a=(0,k.KR)([]),l=(0,k.KR)(!1),r=(0,k.KR)(""),n=(0,k.KR)([]),i=(0,k.KR)(!0),d=_.baseURL,u=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},c=(0,k.KR)(1),p=(0,k.KR)(20),m=(0,k.KR)(!0),g=(0,k.KR)(!1),f=(0,k.Kh)({dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:"",process:""}),v=(0,k.KR)(null);(0,o.wB)([()=>f.wasteTypeId,()=>f.location,()=>f.process,()=>f.minQuantity,()=>f.maxQuantity,()=>f.dateRange],(()=>{v.value&&clearTimeout(v.value),v.value=setTimeout((()=>{c.value=1,N()}),300)}));const w=(0,o.EW)((()=>Ho.isAdmin())),F=(0,o.EW)((()=>Ho.isUnitAdmin())),x=(0,o.EW)((()=>Ho.isSupervisor())),L=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},C=async()=>{await N(),h.nk.success("记录已刷新")},I=()=>{const e=Ho.getUnitId();e?t.push(`/unit/${e}`):t.push("/")},R=()=>{t.push("/")},W=()=>{t.push("/user-management")},V=()=>{t.push(`/unit/${e.unitId}`)},$=e=>{t.push(`/record/${e}`)},T=e=>{if(!e)return!1;if(w.value)return!0;const t=Ho.getUnitId();if(F.value&&t&&e.unit_id===parseInt(t))return!0;const a=Ho.getUserId();return a&&e.creator_id===parseInt(a)},S=e=>e+1,P=e=>{w.value||F.value?b.s.confirm("确定要删除这条废物记录吗？此操作不可逆。","删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await Po.delete(`${_.endpoints.wasteRecords}/${e.id}`),h.nk.success("记录已成功删除"),await N()}catch(t){console.error("删除记录失败:",t),h.nk.error("删除记录失败，请重试")}})).catch((()=>{h.nk.info("已取消删除")})):h.nk.error("您没有删除记录的权限")},K=async()=>{try{c.value=1,await N(),h.nk.success("筛选条件已应用")}catch(e){console.error("应用筛选失败:",e),h.nk.error("应用筛选失败")}},E=async()=>{f.dateRange=null,f.wasteTypeId=null,f.minQuantity=null,f.maxQuantity=null,f.location="",f.process="",c.value=1,await N(),h.nk.success("筛选条件已重置")},U=(0,k.KR)(!1),A=(0,k.KR)([]),D=(0,k.KR)(0),X=(e,t)=>{const a=Array.isArray(e)?e:[e];A.value=a.map((e=>`${d}${e}`)),D.value=t||0,U.value=!0},Q=()=>{U.value=!1},M=(0,k.KR)(750),B=()=>{const e=window.innerHeight,t=Math.max(.85*e,700);M.value=t},q=()=>{B()};(0,o.sV)((async()=>{B(),window.addEventListener("resize",q),await O(),await z(),await N()})),(0,o.hi)((()=>{window.removeEventListener("resize",q)}));const z=async()=>{try{const e=await Po.get(_.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),h.nk.error("获取废物类型列表失败")}},O=async()=>{try{const t=await Po.get(_.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.unitId)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),h.nk.error("获取单位信息失败")}},N=async(t=!1)=>{t?g.value=!0:(l.value=!0,c.value=1,a.value=[]);try{if(!Ho.state.isLoggedIn||!Ho.state.user)throw new Error("用户未登录");const l={page:c.value,pageSize:p.value,wasteTypeId:f.wasteTypeId||void 0,minQuantity:f.minQuantity||void 0,maxQuantity:f.maxQuantity||void 0,location:f.location||void 0,process:f.process||void 0,unitId:e.unitId?parseInt(e.unitId):void 0};f.dateRange&&2===f.dateRange.length&&(l.dateRange=JSON.stringify(f.dateRange)),console.log("【筛选】请求废物记录，参数:",JSON.stringify(l,null,2));const o=_.getUrl(`${_.endpoints.wasteRecords}/user/${Ho.state.user.id}`);console.log("【筛选】请求URL:",o);const r=await y.A.get(o,{params:l});if(console.log("【筛选】获取到废物记录响应:",r.data),!r.data||!r.data.records)throw console.error("【筛选】响应数据格式错误:",r.data),new Error("响应数据格式错误");const n=r.data.records.map((e=>({...e,created_at:L(e.created_at),collection_start_time:L(e.collection_start_time)})));console.log(`【筛选】获取到${n.length}条记录`),a.value=t?[...a.value,...n]:n,m.value=r.data.hasMore,m.value&&c.value++}catch(o){console.error("【筛选】获取废物记录失败:",o),h.nk.error("获取废物记录失败: "+(o.message||"未知错误"))}finally{l.value=!1,g.value=!1}},j=()=>{console.log("手动触发加载更多");const e=document.querySelector(".el-table__body-wrapper"),t=e?e.scrollTop:0;return N(!0).then((()=>{console.log("加载完成，当前记录数:",a.value.length),setTimeout((()=>{e&&(e.scrollTop=t)}),10)})).catch((e=>{console.error("加载失败:",e),h.nk.error("加载更多数据失败")}))},Y=(0,o.EW)((()=>!w.value&&!F.value)),H=async()=>{try{(0,h.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const t=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});l.value=!0;const a={wasteTypeId:f.wasteTypeId?f.wasteTypeId:void 0,minQuantity:f.minQuantity?f.minQuantity:void 0,maxQuantity:f.maxQuantity?f.maxQuantity:void 0,location:f.location||void 0,process:f.process||void 0,dateRange:f.dateRange?JSON.stringify(f.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0,exportType:"first_image"};console.log("导出记录的筛选条件:",a);const{data:o}=await y.A.get(`${_.getUrl(_.endpoints.exportWasteRecords)}/${Ho.state.user.id}`,{params:a});if(console.log(`从后端获取到 ${o.length} 条记录用于导出`),0===o.length)return t.close(),h.nk.warning("没有符合条件的记录可导出"),void(l.value=!1);t.setText(`准备导出 ${o.length} 条记录...`);const n=o.map((e=>{const t=u(e.photo_path_before),a=u(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"产生工序":e.process||"无","备注":e.remarks||"无","收集开始时间":L(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":L(e.created_at),"清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),s=`固体废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],d=window.location.origin,c=(e,a)=>{const l=Math.round(e/a*100);t.setText(`正在导出：${l}% (${e}/${a})`)},p=await $e(n,s,i,d,c);t.close(),p?h.nk.success("导出成功"):h.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),h.nk.error("导出失败: "+(t.message||"未知错误"))}finally{l.value=!1,xe.Ks.service().close()}},J=async()=>{try{(0,h.nk)({message:"导出大量包含全部图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const t=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});l.value=!0;const a={wasteTypeId:f.wasteTypeId?f.wasteTypeId:void 0,minQuantity:f.minQuantity?f.minQuantity:void 0,maxQuantity:f.maxQuantity?f.maxQuantity:void 0,location:f.location||void 0,process:f.process||void 0,dateRange:f.dateRange?JSON.stringify(f.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0,exportType:"all_images"};console.log("导出记录的筛选条件:",a);const{data:o}=await y.A.get(`${_.getUrl(_.endpoints.exportWasteRecords)}/${Ho.state.user.id}`,{params:a});if(console.log(`从后端获取到 ${o.length} 条记录用于导出`),0===o.length)return t.close(),h.nk.warning("没有符合条件的记录可导出"),void(l.value=!1);t.setText(`准备导出 ${o.length} 条记录的全部照片...`);const n=o.map((e=>{const t=u(e.photo_path_before),a=u(e.photo_path_after),l={"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":L(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":L(e.created_at)};for(let o=0;o<5;o++)l[`清理前照片${o+1}`]=o<t.length?t[o]:"";for(let o=0;o<5;o++)l[`清理后照片${o+1}`]=o<a.length?a[o]:"";return l})),s=`固体废物记录_全部照片_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"}];for(let e=0;e<5;e++)i.push({text:`清理前照片${e+1}`,field:`清理前照片${e+1}`,isImage:!0});for(let e=0;e<5;e++)i.push({text:`清理后照片${e+1}`,field:`清理后照片${e+1}`,isImage:!0});const d=window.location.origin,c=(e,a)=>{const l=Math.round(e/a*100);t.setText(`正在导出全部照片：${l}% (${e}/${a})`)},p=await $e(n,s,i,d,c);t.close(),p?h.nk.success("导出成功"):h.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),h.nk.error("导出失败: "+(t.message||"未知错误"))}finally{l.value=!1,xe.Ks.service().close()}},G=async()=>{try{const t=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});l.value=!0;const a={wasteTypeId:f.wasteTypeId?f.wasteTypeId:void 0,minQuantity:f.minQuantity?f.minQuantity:void 0,maxQuantity:f.maxQuantity?f.maxQuantity:void 0,location:f.location||void 0,process:f.process||void 0,dateRange:f.dateRange?JSON.stringify(f.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0,exportType:"no_images"},{data:o}=await y.A.get(`${_.getUrl(_.endpoints.exportWasteRecords)}/${Ho.state.user.id}`,{params:a});if(0===o.length)return t.close(),h.nk.warning("没有符合条件的记录可导出"),void(l.value=!1);t.setText(`准备导出 ${o.length} 条记录...`);const n=o.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":L(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":L(e.created_at),"清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),s=`固体废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],d=await Te(n,s,i);t.close(),d?h.nk.success("导出成功"):h.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),h.nk.error("导出失败: "+(t.message||"未知错误"))}finally{l.value=!1,xe.Ks.service().close()}},Z=e=>{if(!w.value&&!F.value){const t=new Date,a=new Date(t);return a.setHours(t.getHours()-48),e<a||e>t}return!1};return{records:a,loading:l,unitName:r,wasteTypes:n,isAdmin:w,isUnitAdmin:F,isSupervisor:x,parseFormattedDateTime:L,refreshRecords:C,goBack:I,goHome:R,goToUserManagement:W,addNewRecord:V,editRecord:$,canEdit:T,confirmDelete:P,apiConfig:_,showFilterPanel:i,filterForm:f,applyFilter:K,resetFilter:E,debounceTimer:v,exportWithImages:H,exportWithAllImages:J,exportWithoutImages:G,showViewer:U,previewImages:A,previewIndex:D,previewPhoto:X,closeViewer:Q,handleResize:q,parsePhotoPath:u,baseUrl:d,page:c,pageSize:p,hasMore:m,loadingMore:g,indexMethod:S,disabledDate:Z,tableHeight:M,isBasicEmployee:Y,loadMore:j}}};const Ke=(0,W.A)(Pe,[["render",_e],["__scopeId","data-v-e701a0ac"]]);var Ee=Ke;const Ue={class:"login-container"},Ae={class:"login-card"},De={key:0,class:"login-error"};function Xe(e,t,a,r,n,s){const d=(0,o.g2)("el-input"),u=(0,o.g2)("el-form-item"),c=(0,o.g2)("el-checkbox"),p=(0,o.g2)("el-button"),m=(0,o.g2)("el-form");return(0,o.uX)(),(0,o.CE)("div",Ue,[(0,o.Lk)("div",Ae,[t[5]||(t[5]=(0,o.Lk)("div",{class:"login-header"},[(0,o.Lk)("h1",null,"固体废物管理系统"),(0,o.Lk)("h2",null,"用户登录")],-1)),(0,o.bF)(m,{ref:"loginForm",model:r.form,rules:r.rules,"label-width":"80px",class:"login-form",onSubmit:(0,l.D$)(r.submitForm,["prevent"])},{default:(0,o.k6)((()=>[(0,o.bF)(u,{label:"用户",prop:"phone"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{modelValue:r.form.phone,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.phone=e),placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),(0,o.bF)(u,{label:"密码",prop:"password"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{modelValue:r.form.password,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1}),(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:r.form.rememberMe,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.rememberMe=e)},{default:(0,o.k6)((()=>t[3]||(t[3]=[(0,o.eW)("记住登录")]))),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(p,{type:"primary","native-type":"submit",onClick:r.submitForm,loading:r.auth.state.loading,style:{width:"100%"}},{default:(0,o.k6)((()=>t[4]||(t[4]=[(0,o.eW)(" 登录 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules","onSubmit"]),r.auth.state.error?((0,o.uX)(),(0,o.CE)("div",De,(0,i.v_)(r.auth.state.error),1)):(0,o.Q3)("",!0)])])}var Qe={name:"LoginView",setup(){const e=(0,s.rd)(),t=(0,k.KR)(null),a=(0,k.Kh)({phone:"",password:"",rememberMe:!1}),l=(0,o.EW)((()=>{const e=[{required:!0,message:"请输入用户名",trigger:"submit"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的格式",trigger:"submit"}],t=[{required:!0,message:"请输入密码",trigger:"submit"}];return{phone:e,password:t}})),r=async()=>{console.log("提交表单被触发"),t.value?Ho.state.loading?console.log("登录正在进行中，跳过"):t.value.validate((async e=>{e?(console.log("表单验证通过"),await n()):console.log("表单验证失败")})):console.log("表单引用不存在")},n=async()=>{console.log("开始登录，账号:",a.phone);try{console.log("开始处理登录操作...");const t=await Ho.login(a.phone,a.password,a.rememberMe);if(console.log("登录响应:",t),t.success){const a=t.user;h.nk.success(`欢迎，${a.username||a.phone}`),3===a.role_id?e.push("/admin-records"):4===a.role_id?e.push("/record/new"):(a.role_id,e.push(`/unit/${a.unit_id}`))}else h.nk.error(t.error||"登录失败")}catch(t){h.nk.error(t.response?.data?.error||"登录失败，请检查网络连接")}};return(0,o.sV)((()=>{if(Ho.state.isLoggedIn){const t=Ho.state.user;3===t.role_id?e.push("/admin-records"):4===t.role_id?e.push("/record/new"):(t.role_id,e.push(`/unit/${t.unit_id}`))}})),{form:a,rules:l,loginForm:t,submitForm:r,auth:Ho}}};const Me=(0,W.A)(Qe,[["render",Xe],["__scopeId","data-v-25ea481a"]]);var Be=Me;const qe={class:"edit-record-container"},ze={class:"header"},Oe={key:1},Ne={key:3},je={class:"content"},Ye={class:"form-header"},He={key:0,class:"form-tip"},Je={key:0,class:"upload-warning"},Ge={class:"upload-progress"},Ze={class:"upload-status"};function et(e,t,a,l,r,n){const s=(0,o.g2)("arrow-left"),d=(0,o.g2)("el-icon"),u=(0,o.g2)("el-option"),c=(0,o.g2)("el-select"),p=(0,o.g2)("el-form-item"),m=(0,o.g2)("el-input"),g=(0,o.g2)("el-date-picker"),f=(0,o.g2)("clock"),k=(0,o.g2)("el-time-picker"),h=(0,o.g2)("el-input-number"),b=(0,o.g2)("el-alert"),v=(0,o.g2)("plus"),y=(0,o.g2)("el-upload"),w=(0,o.g2)("el-image-viewer"),_=(0,o.g2)("el-button"),F=(0,o.g2)("el-form"),x=(0,o.g2)("el-progress"),L=(0,o.g2)("el-dialog"),C=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",qe,[(0,o.Lk)("div",ze,[l.isSupervisor?((0,o.uX)(),(0,o.CE)("div",Oe)):((0,o.uX)(),(0,o.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(s)])),_:1}),t[13]||(t[13]=(0,o.eW)(" 查看记录 "))])),(0,o.Lk)("h1",null,(0,i.v_)(l.isNew?"新增废物记录":"编辑废物记录"),1),l.isSupervisor?((0,o.uX)(),(0,o.CE)("div",{key:2,class:"back-button supervisor-back-button",onClick:t[1]||(t[1]=(...e)=>l.goBack&&l.goBack(...e))}," 查看记录 ")):((0,o.uX)(),(0,o.CE)("div",Ne))]),(0,o.Lk)("div",je,[(0,o.Lk)("div",Ye,[(0,o.Lk)("h2",null,(0,i.v_)(l.unitName),1)]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(F,{ref:"recordForm",model:l.form,rules:l.rules,"label-width":"120px",class:"record-form"},{default:(0,o.k6)((()=>[l.isAdmin?((0,o.uX)(),(0,o.Wv)(p,{key:0,label:"单位",prop:"unitId"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.unitId,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.units,(e=>((0,o.uX)(),(0,o.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),l.isNew?((0,o.uX)(),(0,o.CE)("div",He,"请先选择单位，才能选择产生地点")):(0,o.Q3)("",!0)])),_:1})):(0,o.Q3)("",!0),(0,o.bF)(p,{label:"废物类型",prop:"wasteTypeId"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"产生工序",prop:"process"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.process,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.process=e),placeholder:"请选择产生工序",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.processOptions,(e=>((0,o.uX)(),(0,o.Wv)(u,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===l.form.process?((0,o.uX)(),(0,o.Wv)(m,{key:0,modelValue:l.customProcess,"onUpdate:modelValue":t[5]||(t[5]=e=>l.customProcess=e),placeholder:"请输入具体产生工序",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,o.Q3)("",!0)])),_:1}),(0,o.bF)(p,{label:"产生地点",prop:"location"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.location,"onUpdate:modelValue":t[6]||(t[6]=e=>l.form.location=e),placeholder:l.isAdmin&&!l.unitName?"请先选择单位":"请选择废物产生地点",style:{width:"100%"},disabled:l.isAdmin&&!l.unitName},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.locationOptions,(e=>((0,o.uX)(),(0,o.Wv)(u,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","placeholder","disabled"]),"其他"===l.form.location?((0,o.uX)(),(0,o.Wv)(m,{key:0,modelValue:l.customLocation,"onUpdate:modelValue":t[7]||(t[7]=e=>l.customLocation=e),placeholder:"请输入具体产生地点",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,o.Q3)("",!0)])),_:1}),(0,o.bF)(p,{label:"备注",prop:"remarks"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{modelValue:l.form.remarks,"onUpdate:modelValue":t[8]||(t[8]=e=>l.form.remarks=e),type:"textarea",rows:1,placeholder:"请输入备注信息（选填）"},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集日期"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:l.form.collectionDate,"onUpdate:modelValue":t[9]||(t[9]=e=>l.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{modelValue:l.form.collectionTime,"onUpdate:modelValue":t[10]||(t[10]=e=>l.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集数量(吨)",prop:"quantity"},{default:(0,o.k6)((()=>[(0,o.bF)(h,{modelValue:l.form.quantity,"onUpdate:modelValue":t[11]||(t[11]=e=>l.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"现场照片（收集前）",prop:"photo_path_before"},{default:(0,o.k6)((()=>[t[14]||(t[14]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),l.showLargeFileWarning?((0,o.uX)(),(0,o.CE)("div",Je,[(0,o.bF)(b,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,o.Q3)("",!0),(0,o.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoBeforeChange,"on-remove":l.handlePhotoBeforeRemove,"file-list":l.fileListBefore,limit:5,multiple:"","list-type":"picture-card","on-preview":l.handlePictureCardPreview,"before-upload":l.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(v)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"])])),_:1}),(0,o.bF)(p,{label:"现场照片（收集后）",prop:"photo_path_after"},{default:(0,o.k6)((()=>[t[15]||(t[15]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,o.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoAfterChange,"on-remove":l.handlePhotoAfterRemove,"file-list":l.fileListAfter,limit:5,multiple:"","list-type":"picture-card","on-preview":l.handlePictureCardPreview,"before-upload":l.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(v)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),l.showViewer?((0,o.uX)(),(0,o.Wv)(w,{key:0,"url-list":l.previewImages,"initial-index":l.previewIndex,onClose:l.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])),_:1}),(0,o.bF)(p,null,{default:(0,o.k6)((()=>[(0,o.bF)(_,{type:"primary",onClick:l.submitForm,loading:l.loading},{default:(0,o.k6)((()=>t[16]||(t[16]=[(0,o.eW)("保存")]))),_:1},8,["onClick","loading"]),(0,o.bF)(_,{onClick:l.goBack},{default:(0,o.k6)((()=>t[17]||(t[17]=[(0,o.eW)("取消")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"])),[[C,l.loading]])]),(0,o.bF)(L,{modelValue:l.showUploadProgress,"onUpdate:modelValue":t[12]||(t[12]=e=>l.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,o.k6)((()=>[(0,o.Lk)("div",Ge,[t[18]||(t[18]=(0,o.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,o.bF)(x,{percentage:l.uploadPercentage,format:l.percentageFormat,status:100===l.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,o.Lk)("p",Ze,(0,i.v_)(l.uploadStatus),1)])])),_:1},8,["modelValue"]),t[19]||(t[19]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var tt={name:"EditRecordView",components:{ArrowLeft:v.nkM,Plus:v.FWt,Clock:v.zD7,ElImageViewer:Fe.Tg},setup(){const e=(0,s.rd)(),t=(0,s.lq)(),a=(0,k.KR)(null),l=(0,k.KR)(!1),r=(0,k.KR)(!1),n=(0,k.KR)(""),i=(0,k.KR)([]),d=(0,k.KR)([]),u=(0,k.KR)([]),c=(0,k.KR)([]),p=(0,k.KR)([]),m=(0,k.KR)([]),g=(0,k.KR)([]),f=(0,k.KR)(!1),b=(0,k.KR)(0),v=(0,k.KR)(""),y=(0,k.KR)(!1),w=(0,k.KR)(0),F=(0,k.KR)("准备上传..."),x=(0,k.KR)(!1),L=(0,k.KR)(null),C=(0,k.KR)([]),I=(0,k.KR)(""),R=(0,k.KR)(""),W=["作业现场","清罐清理","报废清理","管线刺漏","历史遗留","日常维护","封井退出","其他"],V=(0,k.KR)([]),$=(0,k.KR)([]),T=(0,k.KR)([]),S=(0,k.KR)([]),P={"桓台":["金家接转站","金17-1注采站","金17-2注采站","金6金9项目组","金8注采站","其他"],"潍北":["潍北联合站","昌79注采站","昌3注采站","疃3注采站","昌15注采站","其他"],"高青":["高青联合站","樊107注采站","樊14注采站","高21注采站","高54注采站","其他"],"牛庄":["牛25集输站","牛25注采站","营13注采站","史112注采站","其他"],"金角":["长堤注采站","桩23注采站","其他"],"信远":["河125注采站","河122注采站","永551注采站","其他"],"滨博":["樊142注采站","樊142-2-12注采站","樊162注采站","樊页1井组","滨博接转站","其他"],"无棣":["车41注采站","车142注采站","车40注采站","车408注采站","车274注采站","车1接转站","东风港联合站","其他"],"河口":["沾14东注采站","沾14西注采站","渤南注采站","大北注采站","沾5注采站","太平接转站","沾5接转站","其他"],"胜兴":["博兴注采站","其他"],"胜科":["采油一站","其他"],"其他":["其他"]},K=e=>{if(!e)return[];console.log("解析照片路径，原始值:",e,"类型:",typeof e);try{if(Array.isArray(e))return console.log("照片路径已经是数组:",e),e;if("string"===typeof e){if(e.startsWith("[")&&e.endsWith("]")){const t=JSON.parse(e);return console.log("照片路径解析为JSON数组:",t),t}if(e.includes(",")){const t=e.split(",").map((e=>e.trim())).filter((e=>e));return console.log("照片路径解析为逗号分隔字符串:",t),t}return console.log("照片路径解析为单个字符串:",[e]),[e]}return console.log("照片路径类型未知，尝试转换为字符串:",String(e)),[String(e)]}catch(t){return console.error("解析照片路径失败:",t),"string"===typeof e?[e]:[]}},E=(0,o.EW)((()=>!t.params.id||"new"===t.params.id)),U=(0,o.EW)((()=>Ho.state.isLoggedIn&&(3===Ho.state.user.role_id||4===Ho.state.user.role_id||5===Ho.state.user.role_id))),A=(0,o.EW)((()=>Ho.state.isLoggedIn&&4===Ho.state.user.role_id)),D=(0,k.Kh)({unitId:"",wasteTypeId:"",location:"",collectionDate:"",collectionTime:"",quantity:void 0,recordId:null,creatorId:Ho.state.user?.id||null,photo_path_before:"",photo_path_after:"",remarks:"",process:""}),X={unitId:[{required:!0,message:"请选择单位",trigger:"change",validator:(e,t,a)=>{U.value?t?a():a(new Error("请选择单位")):a()}}],wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],process:[{required:!0,message:"请选择产生工序",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||R.value.trim()?a():a(new Error("请输入具体产生工序"))},trigger:"blur"}],location:[{required:!0,message:"请选择废物产生地点",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||I.value.trim()?a():a(new Error("请输入具体产生地点"))},trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!1,message:"请输入收集数量",trigger:"change"}]};(0,o.sV)((async()=>{l.value=!0;try{await B(),U.value&&await Q(),E.value?(!U.value&&Ho.state.user&&(D.unitId=Ho.state.user.unit_id,await M(D.unitId)),D.collectionDate=(new Date).toISOString().slice(0,10),D.collectionTime=(new Date).toTimeString().slice(0,5)):await z()}catch(e){console.error("初始化数据失败:",e),h.nk.error("加载数据失败，请刷新重试")}finally{l.value=!1}}));const Q=async()=>{try{const e=await Po.get(_.endpoints.units);d.value=e.data}catch(e){console.error("获取单位列表失败:",e),h.nk.error("获取单位列表失败")}},M=async e=>{try{const t=await Po.get(_.endpoints.units),a=t.data.find((t=>t.id===parseInt(e)));a&&(n.value=a.name,P[n.value]?C.value=P[n.value]:(C.value=[],console.warn(`未找到管理区 "${n.value}" 的地点选项`)))}catch(t){console.error("获取单位信息失败:",t)}},B=async()=>{try{const e=await Po.get(_.endpoints.wasteTypes);i.value=e.data}catch(e){console.error("获取废物类型失败:",e),h.nk.error("获取废物类型失败")}},z=async()=>{try{l.value=!0;const e=await Po.get(`${_.endpoints.wasteRecords}/detail/${t.params.id}`);L.value=e.data;const a=e.data;if(console.log("获取到的记录详情:",a),D.unitId=a.unit_id,D.wasteTypeId=a.waste_type_id,await M(D.unitId),a.process&&(W.includes(a.process)?D.process=a.process:(D.process="其他",R.value=a.process)),C.value.includes(a.location)?D.location=a.location:(D.location="其他",I.value=a.location),D.recordId=a.id,a.collection_start_time){const e=a.collection_start_time;if(console.log("原始时间字符串:",e),e.includes(" ")){const[t,a]=e.split(" ");D.collectionDate=t,D.collectionTime=a.substring(0,5),console.log("解析后日期:",t,"时间:",a.substring(0,5))}else{const t=new Date(e+(e.includes("T")?"":"T00:00:00")),a=t.getFullYear(),l=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0");D.collectionDate=`${a}-${l}-${o}`,D.collectionTime=`${r}:${n}`,console.log("解析后日期:",D.collectionDate,"时间:",D.collectionTime)}}if(D.quantity=a.quantity,D.remarks=a.remarks||"",console.log("设置备注字段:",a.remarks),a.photo_path_before){console.log("收集前照片路径:",a.photo_path_before);const e=K(a.photo_path_before);console.log("解析后的收集前照片路径:",e),T.value=[...e],u.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集前照片完整URL:",t),{name:e.split("/").pop(),url:t,originalPath:e}}))}if(a.photo_path_after){console.log("收集后照片路径:",a.photo_path_after);const e=K(a.photo_path_after);console.log("解析后的收集后照片路径:",e),S.value=[...e],c.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集后照片完整URL:",t),{name:e.split("/").pop(),url:t,originalPath:e}}))}n.value=a.unit_name,v.value=a.created_at,J([...u.value,...c.value])}catch(e){console.error("获取记录详情失败:",e),h.nk.error("获取记录详情失败")}finally{l.value=!1}},O=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return h.nk.error("只能上传图片文件!"),!1;const l=52428800;return e.size>l?(h.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{y.value=!0,F.value="正在处理图片...",w.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(q())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){w.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){w.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const l=e.name.replace(/\.[^/.]+$/,"")+".jpg",o=new File([a],l,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(o.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-o.size/e.size)),"%"),console.log("- 处理后文件类型:",o.type),console.log("- 处理后文件名:",o.name),F.value="图片处理完成",w.value=100,setTimeout((()=>{y.value=!1}),500),t(o)},error(a){console.error("图片压缩失败:",a),F.value="处理失败，使用原始图片",w.value=100,setTimeout((()=>{y.value=!1}),500),t(e)}})}))},N=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),u.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){y.value=!0,F.value="正在处理图片...",w.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(q())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){w.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){w.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const l=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",o=new File([a],l,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(o.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-o.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",o.type),console.log("- 处理后文件名:",o.name),F.value="图片处理完成",w.value=100,t(o)},error(a){console.error("图片压缩失败:",a),F.value="处理失败，使用原始图片",w.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=p.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?p.value[a]=t:p.value.push(t);const l=u.value.findIndex((t=>t.uid===e.uid));l>=0&&(u.value[l].processed=!0),setTimeout((()=>{y.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),h.nk.warning("图片处理失败，将使用原始图片");const t=p.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?p.value[t]=e.raw:p.value.push(e.raw),y.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return ee(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集前照片添加raw属性:",e.raw)),J([...u.value,...c.value]),console.log("更新后的fileListBefore:",u.value),console.log("更新后的photoFilesBefore:",p.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},j=(e,t)=>{console.log("收集前照片移除:",e),e.originalPath&&(console.log("记录要删除的收集前照片:",e.originalPath),V.value.push(e.originalPath)),u.value=t,ee([...u.value,...c.value])||(x.value=!1),J([...u.value,...c.value])},Y=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){y.value=!0,F.value="正在处理图片...",w.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(q())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){w.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){w.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const l=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",o=new File([a],l,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(o.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-o.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",o.type),console.log("- 处理后文件名:",o.name),F.value="图片处理完成",w.value=100,t(o)},error(a){console.error("图片压缩失败:",a),F.value="处理失败，使用原始图片",w.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?m.value[a]=t:m.value.push(t);const l=c.value.findIndex((t=>t.uid===e.uid));l>=0&&(c.value[l].processed=!0),setTimeout((()=>{y.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),h.nk.warning("图片处理失败，将使用原始图片");const t=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?m.value[t]=e.raw:m.value.push(e.raw),y.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return ee(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集后照片添加raw属性:",e.raw)),J([...u.value,...c.value]),console.log("更新后的fileListAfter:",c.value),console.log("更新后的photoFilesAfter:",m.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},H=(e,t)=>{console.log("收集后照片移除:",e),e.originalPath&&(console.log("记录要删除的收集后照片:",e.originalPath),$.value.push(e.originalPath)),c.value=t,ee([...u.value,...c.value])||(x.value=!1),J([...u.value,...c.value])},J=e=>{g.value=e.map((e=>e.url?(console.log("预览图片URL:",e.url),e.url):e.raw?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e.raw)),console.log("预览图片从raw创建:",e._blobUrl),e._blobUrl):e instanceof File?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e)),console.log("预览图片从File创建:",e._blobUrl),e._blobUrl):"")).filter((e=>e)),console.log("预览图片列表:",g.value)},G=e=>{console.log("预览图片:",e),J([...u.value,...c.value]);const t=g.value.findIndex((t=>{if(e.url)return t===e.url;if(e.raw){const a=URL.createObjectURL(e.raw),l=t===a;return URL.revokeObjectURL(a),l}return!1}));b.value=-1!==t?t:0,f.value=!0},Z=()=>{f.value=!1},ee=e=>{const t=2097152;return e.some((e=>e.size>t))},te=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);w.value=t,F.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},ae=e=>100===e?"完成":`${e}%`,le=async()=>{a.value&&await a.value.validate((async t=>{if(!t)return console.log("表单验证失败"),h.nk.error("请填写所有必填字段"),!1;w.value=0,F.value="正在上传文件...",y.value=!0;try{const t=new FormData;if(t.append("unitId",D.unitId),t.append("wasteTypeId",D.wasteTypeId),"其他"===D.process&&R.value.trim()?t.append("process",R.value.trim()):t.append("process",D.process),"其他"===D.location&&I.value.trim()?t.append("location",I.value.trim()):t.append("location",D.location),t.append("collectionDate",D.collectionDate),t.append("collectionTime",D.collectionTime),void 0!==D.quantity&&null!==D.quantity&&""!==D.quantity&&t.append("quantity",D.quantity),t.append("remarks",D.remarks||""),E.value||(V.value.length>0&&(console.log("发送要删除的收集前照片列表:",V.value),t.append("photos_to_remove_before",JSON.stringify(V.value))),$.value.length>0&&(console.log("发送要删除的收集后照片列表:",$.value),t.append("photos_to_remove_after",JSON.stringify($.value)))),u.value.length>0){const e=u.value.filter((e=>e.raw)),a=u.value.filter((e=>!e.raw&&e.originalPath));if(e.forEach((e=>{e.raw&&(console.log("添加新的收集前照片:",e.raw.name),t.append("photo_before",e.raw))})),a.length>0){const e=a.map((e=>e.originalPath));console.log("保留的收集前照片路径:",e),t.append("photo_path_before",JSON.stringify(e))}}else!E.value&&T.value.length>0&&(console.log("用户删除了所有收集前照片，发送NULL标记"),t.append("photo_path_before","NULL"));if(c.value.length>0){const e=c.value.filter((e=>e.raw)),a=c.value.filter((e=>!e.raw&&e.originalPath));if(e.forEach((e=>{e.raw&&(console.log("添加新的收集后照片:",e.raw.name),t.append("photo_after",e.raw))})),a.length>0){const e=a.map((e=>e.originalPath));console.log("保留的收集后照片路径:",e),t.append("photo_path_after",JSON.stringify(e))}}else!E.value&&S.value.length>0&&(console.log("用户删除了所有收集后照片，发送NULL标记"),t.append("photo_path_after","NULL"));console.log("FormData内容:");for(let[e,a]of t.entries())a instanceof File?console.log(`${e}: File - ${a.name} (${a.type}, ${a.size} bytes)`):console.log(`${e}: ${a}`);D.recordId?(await Po.putForm(`${_.endpoints.wasteRecords}/${D.recordId}`,t,te),h.nk.success("废物记录更新成功！正在跳转到记录列表...")):(await Po.postForm(_.endpoints.wasteRecords,t,te),h.nk.success("废物记录添加成功！正在跳转到记录列表...")),y.value=!1,setTimeout((()=>{if(Ho.state.isLoggedIn&&Ho.state.user){const t=Ho.state.user.role_id;3===t||4===t?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:Ho.state.user.unit_id}})}else oe()}),1500)}catch(a){console.error("提交表单失败:",a),a.response&&a.response.data?(console.error("服务器返回错误:",a.response.data),h.nk.error(`提交表单失败: ${a.response.data.error||"未知错误"}`)):h.nk.error("提交表单失败，请检查网络连接"),y.value=!1}}))},oe=()=>{5===Ho.state.user.role_id?e.push({name:"SuperAdminRecords"}):3===Ho.state.user.role_id||4===Ho.state.user.role_id?e.push({name:"AdminRecords"}):Ho.state.user.unit_id?e.push({name:"RecordsList",params:{unitId:Ho.state.user.unit_id}}):e.push({name:"UnitSelection"})};return(0,o.wB)((()=>D.unitId),(async e=>{e?await M(e):(C.value=[],n.value="")})),{form:D,rules:X,recordForm:a,loading:l,submitting:r,unitName:n,wasteTypes:i,units:d,fileListBefore:u,fileListAfter:c,photoFilesBefore:p,photoFilesAfter:m,previewImages:g,showViewer:f,previewIndex:b,isNew:E,isAdmin:U,isSupervisor:A,parsePhotoPath:K,handlePhotoBeforeChange:N,handlePhotoBeforeRemove:j,handlePhotoAfterChange:Y,handlePhotoAfterRemove:H,handlePictureCardPreview:G,handleBeforeUpload:O,closeViewer:Z,submitForm:le,goBack:oe,showUploadProgress:y,uploadPercentage:w,uploadStatus:F,percentageFormat:ae,showLargeFileWarning:x,record:L,locationOptions:C,locationMap:P,customLocation:I,customProcess:R,processOptions:W,deletedPhotosBefore:V,deletedPhotosAfter:$,originalPhotosBefore:T,originalPhotosAfter:S}}};const at=(0,W.A)(tt,[["render",et],["__scopeId","data-v-5d7631d6"]]);var lt=at;const ot={class:"user-management-container"},rt={class:"header"},nt={class:"content"},st={class:"toolbar"},it={class:"search-container"},dt={key:0,class:"password-hint"},ut={key:1,class:"password-hint"},ct={class:"dialog-footer"};function pt(e,t,a,l,r,n){const s=(0,o.g2)("arrow-left"),d=(0,o.g2)("el-icon"),u=(0,o.g2)("search"),c=(0,o.g2)("el-input"),p=(0,o.g2)("plus"),m=(0,o.g2)("el-button"),g=(0,o.g2)("el-table-column"),f=(0,o.g2)("el-tag"),k=(0,o.g2)("el-popconfirm"),h=(0,o.g2)("el-table"),b=(0,o.g2)("el-form-item"),v=(0,o.g2)("el-option"),y=(0,o.g2)("el-select"),w=(0,o.g2)("el-form"),_=(0,o.g2)("el-dialog"),F=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",ot,[(0,o.Lk)("div",rt,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(s)])),_:1}),t[10]||(t[10]=(0,o.eW)(" 返回 "))]),t[11]||(t[11]=(0,o.Lk)("h1",null,"人员管理",-1)),t[12]||(t[12]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",nt,[(0,o.Lk)("div",st,[(0,o.Lk)("div",it,[(0,o.bF)(c,{modelValue:l.searchKeyword,"onUpdate:modelValue":t[1]||(t[1]=e=>l.searchKeyword=e),placeholder:"请输入姓名关键字搜索",clearable:"",onClear:l.clearSearch,class:"search-input"},{prefix:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1})])),_:1},8,["modelValue","onClear"])]),(0,o.bF)(m,{type:"primary",onClick:l.openAddDialog},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1}),t[13]||(t[13]=(0,o.eW)(" 添加用户 "))])),_:1},8,["onClick"])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(h,{data:l.users,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,o.k6)((()=>[(0,o.bF)(g,{type:"index",label:"序号",width:"70",align:"center"}),(0,o.bF)(g,{prop:"username",label:"姓名",width:"120"}),(0,o.bF)(g,{prop:"phone",label:"手机号",width:"140"}),(0,o.bF)(g,{prop:"role_name",label:"角色",width:"120"}),(0,o.bF)(g,{prop:"unit_name",label:"单位","min-width":"120"}),l.isSystemAdmin?((0,o.uX)(),(0,o.Wv)(g,{key:0,prop:"company_name",label:"公司",width:"120"})):(0,o.Q3)("",!0),(0,o.bF)(g,{label:"状态",width:"100",align:"center"},{default:(0,o.k6)((e=>[(0,o.bF)(f,{type:1===e.row.status?"success":"danger"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(1===e.row.status?"正常":"已停用"),1)])),_:2},1032,["type"])])),_:1}),(0,o.bF)(g,{label:"日志权限",width:"100",align:"center"},{default:(0,o.k6)((e=>[(0,o.bF)(f,{type:1===e.row.can_view_logs?"success":"info"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(1===e.row.can_view_logs?"允许":"禁止"),1)])),_:2},1032,["type"])])),_:1}),(0,o.bF)(g,{label:"操作",width:"300",fixed:"right"},{default:(0,o.k6)((e=>[l.isSuperAdmin||2!==e.row.role_id?((0,o.uX)(),(0,o.Wv)(m,{key:0,size:"small",onClick:t=>l.handleEdit(e.row)},{default:(0,o.k6)((()=>t[14]||(t[14]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0),l.isSuperAdmin||2!==e.row.role_id?((0,o.uX)(),(0,o.Wv)(m,{key:1,size:"small",type:1===e.row.status?"warning":"success",onClick:t=>l.handleStatusChange(e.row)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(1===e.row.status?"停用":"恢复"),1)])),_:2},1032,["type","onClick"])):(0,o.Q3)("",!0),l.canManageLogPermissions?((0,o.uX)(),(0,o.Wv)(m,{key:2,size:"small",type:1===e.row.can_view_logs?"warning":"primary",onClick:t=>l.handleLogPermissionChange(e.row)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(1===e.row.can_view_logs?"禁止日志":"允许日志"),1)])),_:2},1032,["type","onClick"])):(0,o.Q3)("",!0),l.isSuperAdmin||2!==e.row.role_id?((0,o.uX)(),(0,o.Wv)(k,{key:3,title:"确定要删除此用户吗？",onConfirm:t=>l.handleDelete(e.row)},{reference:(0,o.k6)((()=>[(0,o.bF)(m,{size:"small",type:"danger"},{default:(0,o.k6)((()=>t[15]||(t[15]=[(0,o.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])):(0,o.Q3)("",!0)])),_:1})])),_:1},8,["data"])),[[F,l.loading]])]),(0,o.bF)(_,{modelValue:l.dialogVisible,"onUpdate:modelValue":t[9]||(t[9]=e=>l.dialogVisible=e),title:l.isEdit?"编辑用户":"添加用户",width:"500px"},{footer:(0,o.k6)((()=>[(0,o.Lk)("span",ct,[(0,o.bF)(m,{onClick:t[8]||(t[8]=e=>l.dialogVisible=!1)},{default:(0,o.k6)((()=>t[16]||(t[16]=[(0,o.eW)("取消")]))),_:1}),(0,o.bF)(m,{type:"primary",onClick:l.submitForm,loading:l.formLoading},{default:(0,o.k6)((()=>t[17]||(t[17]=[(0,o.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,o.k6)((()=>[(0,o.bF)(w,{ref:"userForm",model:l.form,rules:l.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,o.k6)((()=>[(0,o.bF)(b,{label:"姓名",prop:"username"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.username,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.username=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),(0,o.bF)(b,{label:"手机号",prop:"phone"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.phone,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,o.bF)(b,{label:"角色",prop:"roleId"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{modelValue:l.form.roleId,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.roleId=e),placeholder:"请选择角色",style:{width:"100%"}},{default:(0,o.k6)((()=>[l.isSystemAdmin?((0,o.uX)(),(0,o.Wv)(v,{key:0,value:5,label:"系统超级管理员"})):(0,o.Q3)("",!0),l.isSystemAdmin||l.isCompanyAdmin?((0,o.uX)(),(0,o.Wv)(v,{key:1,value:3,label:"公司管理员"})):(0,o.Q3)("",!0),l.isSystemAdmin||l.isCompanyAdmin?((0,o.uX)(),(0,o.Wv)(v,{key:2,value:4,label:"监督人员"})):(0,o.Q3)("",!0),(0,o.bF)(v,{value:2,label:"单位管理员"}),(0,o.bF)(v,{value:1,label:"基层员工"})])),_:1},8,["modelValue"])])),_:1}),3!==l.form.roleId&&4!==l.form.roleId&&5!==l.form.roleId?((0,o.uX)(),(0,o.Wv)(b,{key:0,label:"单位",prop:"unitId"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{modelValue:l.form.unitId,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"},disabled:!e.isAdmin&&l.isEdit},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.units,(e=>((0,o.uX)(),(0,o.Wv)(v,{key:e.id,label:l.isSystemAdmin?`${e.name} (${e.company_name})`:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})):(0,o.Q3)("",!0),l.isSystemAdmin?((0,o.uX)(),(0,o.Wv)(b,{key:1,label:"公司",prop:"companyId"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{modelValue:l.form.companyId,"onUpdate:modelValue":t[6]||(t[6]=e=>l.form.companyId=e),placeholder:"请选择公司",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.companies,(e=>((0,o.uX)(),(0,o.Wv)(v,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(0,o.Q3)("",!0),(0,o.bF)(b,{label:"密码",prop:l.isEdit?"":"password"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.password,"onUpdate:modelValue":t[7]||(t[7]=e=>l.form.password=e),placeholder:"请输入密码",type:"password","show-password":""},null,8,["modelValue"]),l.isEdit?((0,o.uX)(),(0,o.CE)("div",ut,"不修改密码请留空")):((0,o.uX)(),(0,o.CE)("div",dt,"所有账号必须设置密码"))])),_:1},8,["prop"])])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),t[18]||(t[18]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var mt={name:"UserManagement",components:{ArrowLeft:v.nkM,Plus:v.FWt,Search:v.vji},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)(!1),l=(0,k.KR)(!1),r=(0,k.KR)(!1),n=(0,k.KR)(null),i=(0,k.KR)([]),d=(0,k.KR)([]),u=(0,k.KR)([]),c=(0,k.KR)(""),p=(0,k.KR)([]),m=(0,o.EW)((()=>Ho.isSystemAdmin())),g=(0,o.EW)((()=>Ho.isCompanyAdmin())),f=(0,o.EW)((()=>Ho.isAdmin())),b=(0,o.EW)((()=>Ho.state.isLoggedIn&&Ho.state.user&&1===Ho.state.user.can_view_logs)),v=(0,o.EW)((()=>Ho.state.isLoggedIn?Ho.state.user.unit_id:null)),y=(0,k.Kh)({id:null,username:"",phone:"",roleId:1,unitId:null,companyId:null,password:""}),w={username:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],unitId:[{required:function(){return 3!==y.roleId&&4!==y.roleId&&5!==y.roleId},message:"请选择单位",trigger:"change"}],companyId:[{required:function(){return m.value&&!r.value},message:"请选择公司",trigger:"change"}],password:[{required:function(){return!r.value},message:"请输入密码",trigger:"blur"},{validator:(e,t,a)=>{t&&t.length>0?t.length<1||t.length>20?a(new Error("长度在 1 到 20 个字符")):a():r.value?a():a(new Error("请输入密码"))},trigger:"blur"}]},F=async()=>{t.value=!0;try{let e;e=f.value?await Po.get(_.endpoints.users):await Po.get(`${_.endpoints.usersByUnit}/${v.value}`),i.value=e.data,p.value=e.data}catch(e){console.error("Error fetching users:",e),h.nk.error("获取用户列表失败")}finally{t.value=!1}},x=async()=>{try{const e=await Po.get(_.endpoints.units);d.value=e.data}catch(e){console.error("Error fetching units:",e),h.nk.error("获取单位列表失败")}},L=async()=>{if(m.value)try{const e=await Po.get(_.endpoints.companies);u.value=e.data}catch(e){console.error("Error fetching companies:",e),h.nk.error("获取公司列表失败")}},C=()=>{r.value=!1,$(),l.value=!0,f.value||(y.unitId=v.value),m.value||(y.companyId=Ho.getCompanyId())},I=e=>{r.value=!0,y.id=e.id,y.username=e.username,y.phone=e.phone,y.roleId=e.role_id,y.unitId=e.unit_id,y.companyId=e.company_id,y.password="",l.value=!0},R=async e=>{try{await Po.delete(`${_.endpoints.users}/${e.id}`),h.nk.success("用户删除成功"),F()}catch(t){console.error("Error deleting user:",t);let e="删除用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),h.nk.error(e)}},W=async e=>{const t=1===e.status?0:1,a=1===t?"恢复":"停用";try{await Po.put(`${_.endpoints.users}/${e.id}/status`,{status:t}),h.nk.success(`用户${a}成功`),F()}catch(l){console.error("状态变更失败:",l);let e=`${a}用户失败`;l.response&&l.response.data&&l.response.data.error&&(e=l.response.data.error),h.nk.error(e)}},V=async e=>{const t=1===e.can_view_logs?null:1,a=1===t?"允许查看日志":"禁止查看日志";try{const l=_.endpoints.userLogPermission.replace(":id",e.id);await Po.put(l,{can_view_logs:t}),h.nk.success(`用户日志权限设置成功：${a}`),Ho.state.user&&Ho.state.user.id===e.id&&Ho.updateUserInfo({can_view_logs:t}),F()}catch(l){console.error("日志权限变更失败:",l);let e="设置日志权限失败";l.response&&l.response.data&&l.response.data.error&&(e=l.response.data.error),h.nk.error(e)}},$=()=>{n.value&&n.value.resetFields(),y.id=null,y.username="",y.phone="",y.roleId=1,y.unitId=null,y.companyId=null,y.password=""},T=()=>{n.value.validate((async e=>{if(e){a.value=!0;try{const e={username:y.username,phone:y.phone,roleId:y.roleId,unitId:3!==y.roleId&&4!==y.roleId&&5!==y.roleId?y.unitId:null};m.value&&y.companyId&&(e.companyId=y.companyId),y.password&&(e.password=y.password),r.value?(await Po.put(`${_.endpoints.users}/${y.id}`,e),h.nk.success("用户更新成功")):(await Po.post(_.endpoints.users,e),h.nk.success("用户添加成功")),l.value=!1,F()}catch(t){console.error("Error submitting user form:",t);let e=r.value?"更新用户失败":"添加用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),h.nk.error(e)}finally{a.value=!1}}else h.nk.warning("请完成必填项")}))},S=()=>{e.back()},P=()=>{if(c.value.trim()){const e=c.value.toLowerCase();i.value=p.value.filter((t=>t.username.toLowerCase().includes(e)))}else i.value=p.value},K=()=>{c.value="",P()};return(0,o.sV)((()=>{F(),x(),L()})),(0,o.wB)(c,(()=>{P()})),{loading:t,formLoading:a,dialogVisible:l,isEdit:r,userForm:n,users:i,units:d,companies:u,form:y,rules:w,isSystemAdmin:m,isCompanyAdmin:g,isSuperAdmin:f,currentUnitId:v,canManageLogPermissions:b,openAddDialog:C,handleEdit:I,handleDelete:R,handleStatusChange:W,handleLogPermissionChange:V,submitForm:T,goBack:S,searchKeyword:c,filterUsers:P,clearSearch:K}}};const gt=(0,W.A)(mt,[["render",pt],["__scopeId","data-v-454f6f64"]]);var ft=gt;const kt={class:"admin-records-container"},ht={class:"content"},bt={class:"actions"},vt={class:"filter-header"},yt={class:"filter-form-container"},wt={class:"quantity-range"},_t={class:"input-with-clear"},Ft={class:"input-with-clear"},xt={class:"filter-actions"},Lt={class:"records-wrapper"},Ct={class:"card-header"},It={class:"card-actions"},Rt={class:"table-wrapper",ref:"tableContainer"},Wt={key:0,class:"photo-preview"},Vt=["onClick"],$t={key:0,class:"photo-count"},Tt={key:1},St={key:0,class:"photo-preview"},Pt=["onClick"],Kt={key:0,class:"photo-count"},Et={key:1},Ut={class:"operation-buttons"},At={key:0,class:"loading-row"},Dt={key:1,class:"load-more-row"},Xt={key:2,class:"no-more-row"},Qt={key:0,class:"empty-block"};function Mt(e,t,a,r,n,s){const d=(0,o.g2)("plus"),u=(0,o.g2)("el-icon"),c=(0,o.g2)("el-button"),p=(0,o.g2)("user"),m=(0,o.g2)("document"),g=(0,o.g2)("refresh"),f=(0,o.g2)("arrow-down"),k=(0,o.g2)("arrow-up"),h=(0,o.g2)("el-option"),b=(0,o.g2)("el-select"),v=(0,o.g2)("el-form-item"),y=(0,o.g2)("el-col"),w=(0,o.g2)("el-input"),_=(0,o.g2)("el-switch"),F=(0,o.g2)("el-row"),x=(0,o.g2)("el-date-picker"),L=(0,o.g2)("el-input-number"),C=(0,o.g2)("CircleClose"),I=(0,o.g2)("el-form"),R=(0,o.g2)("el-card"),W=(0,o.g2)("download"),V=(0,o.g2)("el-table-column"),$=(0,o.g2)("el-image"),T=(0,o.g2)("loading"),S=(0,o.g2)("el-table"),P=(0,o.g2)("el-empty"),K=(0,o.g2)("el-image-viewer"),E=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",kt,[t[27]||(t[27]=(0,o.Lk)("div",{class:"header"},[(0,o.Lk)("h1",null,"固体废物记录")],-1)),(0,o.Lk)("div",ht,[(0,o.Lk)("div",bt,[(0,o.bF)(c,{type:"primary",onClick:r.addNewRecord},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(d)])),_:1}),t[11]||(t[11]=(0,o.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isSuperAdmin&&!r.isSupervisor?((0,o.uX)(),(0,o.Wv)(c,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1}),t[12]||(t[12]=(0,o.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,o.Q3)("",!0),r.isSuperAdmin&&r.canViewLogs?((0,o.uX)(),(0,o.Wv)(c,{key:1,type:"warning",onClick:r.goToOperationLogs},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(m)])),_:1}),t[13]||(t[13]=(0,o.eW)(" 操作日志 "))])),_:1},8,["onClick"])):(0,o.Q3)("",!0),(0,o.bF)(c,{onClick:r.refreshRecords},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(g)])),_:1}),t[14]||(t[14]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,o.bF)(R,{class:"filter-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",vt,[t[15]||(t[15]=(0,o.Lk)("h3",null,"筛选条件",-1)),(0,o.bF)(c,{type:"primary",link:"",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,o.uX)(),(0,o.Wv)(u,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(k)])),_:1})):((0,o.uX)(),(0,o.Wv)(u,{key:0},{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1}))])),_:1})]),(0,o.bo)((0,o.Lk)("div",yt,[(0,o.bF)(I,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,o.k6)((()=>[(0,o.bF)(F,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(y,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"所属单位"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.unitId=e),placeholder:"选择单位",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.units,(e=>((0,o.uX)(),(0,o.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(y,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"废物类型"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(y,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"产生地点"},{default:(0,o.k6)((()=>[(0,o.bF)(w,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(y,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"产生工序"},{default:(0,o.k6)((()=>[(0,o.bF)(w,{modelValue:r.filterForm.process,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.process=e),placeholder:"输入工序关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),r.isSuperAdmin?((0,o.uX)(),(0,o.Wv)(y,{key:0,xs:24,sm:12,md:4,lg:4,xl:4},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"监督数据"},{default:(0,o.k6)((()=>[(0,o.bF)(_,{modelValue:r.filterForm.showSupervised,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.showSupervised=e),"active-text":"显示","inactive-text":"隐藏","active-color":"#13ce66","inactive-color":"#ff4949","active-value":!0,"inactive-value":!1,style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})):(0,o.Q3)("",!0)])),_:1}),(0,o.bF)(F,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(y,{xs:24,sm:24,md:10,lg:10,xl:10},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(x,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(y,{xs:24,sm:24,md:8,lg:8,xl:8},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"数量范围(吨)"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",wt,[(0,o.Lk)("div",_t,[(0,o.bF)(L,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"100%"}},null,8,["modelValue"]),null!==r.filterForm.minQuantity?((0,o.uX)(),(0,o.Wv)(u,{key:0,class:"clear-icon",onClick:t[8]||(t[8]=e=>r.filterForm.minQuantity=null)},{default:(0,o.k6)((()=>[(0,o.bF)(C)])),_:1})):(0,o.Q3)("",!0)]),t[16]||(t[16]=(0,o.Lk)("span",{class:"range-separator"},"至",-1)),(0,o.Lk)("div",Ft,[(0,o.bF)(L,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[9]||(t[9]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"100%"}},null,8,["modelValue","min"]),null!==r.filterForm.maxQuantity?((0,o.uX)(),(0,o.Wv)(u,{key:0,class:"clear-icon",onClick:t[10]||(t[10]=e=>r.filterForm.maxQuantity=null)},{default:(0,o.k6)((()=>[(0,o.bF)(C)])),_:1})):(0,o.Q3)("",!0)])])])),_:1})])),_:1}),(0,o.bF)(y,{xs:24,sm:24,md:6,lg:6,xl:6,class:"filter-buttons-col"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",xt,[(0,o.bF)(c,{type:"primary",onClick:r.applyFilter},{default:(0,o.k6)((()=>t[17]||(t[17]=[(0,o.eW)("刷新筛选")]))),_:1},8,["onClick"]),(0,o.bF)(c,{onClick:r.resetFilter},{default:(0,o.k6)((()=>t[18]||(t[18]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])],512),[[l.aG,r.showFilterPanel]])])),_:1}),(0,o.Lk)("div",Lt,[(0,o.bF)(R,{class:"records-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",Ct,[t[22]||(t[22]=(0,o.Lk)("h3",{class:"table-title"},"所有废物记录",-1)),(0,o.Lk)("div",It,[(0,o.bF)(c,{type:"warning",onClick:r.exportWithoutImages,loading:r.loading},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(W)])),_:1}),t[19]||(t[19]=(0,o.eW)(" 无照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,o.bF)(c,{type:"warning",onClick:r.exportWithImages,loading:r.loading},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(W)])),_:1}),t[20]||(t[20]=(0,o.eW)(" 包含首张照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,o.bF)(c,{type:"warning",onClick:r.exportWithAllImages,loading:r.loading},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(W)])),_:1}),t[21]||(t[21]=(0,o.eW)(" 包含全部照片(不推荐) "))])),_:1},8,["onClick","loading"])])]),(0,o.Lk)("div",Rt,[(0,o.bo)(((0,o.uX)(),(0,o.Wv)(S,{ref:"tableRef",data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:r.tableHeight},{append:(0,o.k6)((()=>[r.loadingMore?((0,o.uX)(),(0,o.CE)("div",At,[(0,o.bF)(u,{class:"loading"},{default:(0,o.k6)((()=>[(0,o.bF)(T)])),_:1}),t[25]||(t[25]=(0,o.eW)(" 正在加载... "))])):r.hasMore&&r.records.length>0?((0,o.uX)(),(0,o.CE)("div",Dt,[(0,o.bF)(c,{type:"primary",onClick:r.loadMore,disabled:r.loadingMore,size:"small"},{default:(0,o.k6)((()=>[t[26]||(t[26]=(0,o.eW)(" 点击加载更多 ")),(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1})])),_:1},8,["onClick","disabled"])])):r.records.length>0?((0,o.uX)(),(0,o.CE)("div",Xt," 已全部加载 ")):(0,o.Q3)("",!0)])),default:(0,o.k6)((()=>[(0,o.bF)(V,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,o.bF)(V,{prop:"unit_name",label:"单位","min-width":"100"}),(0,o.bF)(V,{prop:"waste_type_name",label:"废物类型","min-width":"100"}),(0,o.bF)(V,{prop:"location",label:"产生地点","min-width":"100"}),(0,o.bF)(V,{prop:"process",label:"产生工序","min-width":"100"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(e.row.process||"无"),1)])),_:1}),(0,o.bF)(V,{prop:"remarks",label:"备注","min-width":"120"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,o.bF)(V,{prop:"collection_start_time",label:"收集开始时间","min-width":"160"}),(0,o.bF)(V,{label:"数量(吨)","min-width":"100"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(null!==e.row.quantity&&void 0!==e.row.quantity?parseFloat(e.row.quantity).toFixed(3):""),1)])),_:1}),(0,o.bF)(V,{prop:"creator_name",label:"填报人","min-width":"100"}),(0,o.bF)(V,{prop:"created_at",label:"记录时间","min-width":"160"}),(0,o.bF)(V,{label:"清理前照片","min-width":"140",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_before?((0,o.uX)(),(0,o.CE)("div",Wt,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,o.bF)($,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,Vt)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,o.uX)(),(0,o.CE)("div",$t,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",Tt,"无"))])),_:1}),(0,o.bF)(V,{label:"清理后照片","min-width":"140",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_after?((0,o.uX)(),(0,o.CE)("div",St,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,o.bF)($,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,Pt)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,o.uX)(),(0,o.CE)("div",Kt,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",Et,"无"))])),_:1}),(0,o.bF)(V,{label:"操作","min-width":"130"},{default:(0,o.k6)((e=>[(0,o.Lk)("div",Ut,[(0,o.bF)(c,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,o.k6)((()=>t[23]||(t[23]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,o.bF)(c,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,o.k6)((()=>t[24]||(t[24]=[(0,o.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","height"])),[[E,r.loading]])],512),0!==r.records.length||r.loading?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("div",Qt,[(0,o.bF)(P,{description:"暂无废物记录"})]))])),_:1})])]),r.showViewer?((0,o.uX)(),(0,o.Wv)(K,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])}const Bt=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},qt=(e,t)=>{if(!e.photos)return[];try{const a=JSON.parse(e.photos);return Array.isArray(a)?a.filter((e=>e.type===t)):[]}catch(a){return console.error("解析照片JSON失败:",a),[]}};var zt={name:"AdminRecordsView",components:{Plus:v.FWt,Refresh:v.C42,User:v.KJW,ArrowDown:v.yd$,ArrowUp:v.DoI,Download:v.f5X,ElImageViewer:Fe.Tg,Loading:v.Rhj,CircleClose:v.R$5,Document:v.yoT},setup(){const e=(0,s.rd)(),t=(0,k.KR)([]),a=(0,k.KR)(!1),l=(0,k.KR)([]),r=(0,k.KR)([]),n=(0,k.KR)(!0),i=_.baseURL,d=(0,k.KR)(750),u=(0,k.KR)(null),c=()=>{const e=window.innerHeight,t=Math.min(Math.max(.85*e,650),900);d.value=t,console.log("设置表格高度:",t)},p=()=>{c()},m=(0,k.KR)(!1),g=(0,k.KR)([]),f=(0,k.KR)(0),v=(0,k.KR)(1),w=(0,k.KR)(1),F=(0,k.KR)(20),x=(0,k.KR)(!0),L=(0,k.KR)(!1),C=(0,k.KR)(null),I=(0,k.Kh)({unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:"",process:"",showSupervised:!0}),R=(0,k.KR)(null);(0,o.wB)([()=>I.unitId,()=>I.dateRange,()=>I.wasteTypeId,()=>I.minQuantity,()=>I.maxQuantity,()=>I.location,()=>I.process,()=>I.showSupervised],(()=>{R.value&&clearTimeout(R.value),R.value=setTimeout((()=>{v.value=1,S()}),300)}));const W=(0,o.EW)((()=>t.value.filter((e=>{if(I.unitId&&e.unit_id!==I.unitId)return!1;if(I.wasteTypeId&&e.waste_type_id!==I.wasteTypeId)return!1;if(null!==I.minQuantity&&""!==I.minQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)<I.minQuantity)return!1;if(null!==I.maxQuantity&&""!==I.maxQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)>I.maxQuantity)return!1;if(I.location&&!e.location.toLowerCase().includes(I.location.toLowerCase()))return!1;if(I.process&&!e.process?.toLowerCase().includes(I.process.toLowerCase()))return!1;if(I.dateRange&&2===I.dateRange.length){const t=new Date(I.dateRange[0]),a=new Date(I.dateRange[1]);if(a.setHours(23,59,59,999),!e.collection_start_time)return!1;{const l=V(e.collection_start_time);if(l<t||l>a)return!1}}return!0})))),V=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)};(0,o.sV)((async()=>{if(3!==Ho.state.user.role_id&&4!==Ho.state.user.role_id)return h.nk.error("权限不足"),void e.push("/login");await $(),await T(),S(),c(),window.addEventListener("resize",p)})),(0,o.hi)((()=>{window.removeEventListener("resize",p)}));const $=async()=>{try{const e=await Po.get(_.endpoints.units);l.value=e.data}catch(e){console.error("获取单位列表失败:",e),h.nk.error("获取单位列表失败")}},T=async()=>{try{const e=await y.A.get(_.getUrl(_.endpoints.wasteTypes));r.value=e.data}catch(e){console.error("获取废物类型列表失败:",e),h.nk.error("获取废物类型列表失败")}},S=async(e=!1)=>{console.log(`开始加载数据，是否加载更多: ${e}`),e?(L.value=!0,console.log(`加载更多: 当前page=${v.value}, currentPage=${w.value}`)):(a.value=!0,v.value=1,w.value=1,t.value=[],console.log("初始化加载: 重置页码和记录"));try{const a={page:v.value,pageSize:F.value,wasteTypeId:I.wasteTypeId,minQuantity:I.minQuantity,maxQuantity:I.maxQuantity,location:I.location,process:I.process,showSupervised:I.showSupervised?"true":"false",unitId:I.unitId?I.unitId:void 0};console.log("发送请求参数:",a),I.dateRange&&2===I.dateRange.length&&(a.dateRange=JSON.stringify(I.dateRange));const l=await Po.get(`${_.endpoints.wasteRecords}/user/${Ho.state.user.id}`,a);console.log("服务器返回数据:",{recordsCount:l.data.records.length,hasMore:l.data.hasMore});const o=l.data.records.map((e=>({...e,created_at:P(e.created_at),collection_start_time:P(e.collection_start_time)})));e?(t.value=[...t.value,...o],console.log(`追加${o.length}条记录，现在总共有${t.value.length}条记录`)):(t.value=o,console.log(`加载了${o.length}条新记录`)),x.value=l.data.hasMore,console.log(`服务器是否有更多数据: ${x.value}`),x.value?(v.value++,console.log(`有更多数据，下一页将是: page=${v.value}`)):console.log("没有更多数据了")}catch(l){console.error("获取废物记录失败:",l),h.nk.error("获取废物记录失败")}finally{a.value=!1,L.value=!1,console.log(`加载完成，状态: loading=${a.value}, loadingMore=${L.value}`)}},P=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})},K=()=>{S()},E=()=>{3===Ho.state.user.role_id||4===Ho.state.user.role_id?e.push("/record/new"):e.push(`/unit/${Ho.state.user.unit_id}`)},U=()=>{e.push("/user-management")},A=()=>{e.push("/operation-logs")},D=t=>{e.push(`/record/${t}`)},X=async()=>{await S(),h.nk.success("筛选已应用")},Q=async()=>{I.unitId=null,I.dateRange=null,I.wasteTypeId=null,I.minQuantity=null,I.maxQuantity=null,I.location="",I.process="",I.showSupervised=!0,await S(),h.nk.info("筛选条件已重置")},M=async()=>{try{(0,h.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:I.wasteTypeId?I.wasteTypeId:void 0,minQuantity:I.minQuantity?I.minQuantity:void 0,maxQuantity:I.maxQuantity?I.maxQuantity:void 0,location:I.location||void 0,process:I.process||void 0,dateRange:I.dateRange?JSON.stringify(I.dateRange):void 0,unitId:I.unitId?I.unitId:void 0,showSupervised:I.showSupervised?"true":"false",exportType:"first_image"};console.log("导出记录的筛选条件:",t);const{data:o}=await Po.get(`${_.endpoints.exportWasteRecords}/${Ho.state.user.id}`,t);if(console.log(`从后端获取到 ${o.length} 条记录用于导出`),0===o.length)return e.close(),h.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=I.unitId?l.value.find((e=>e.id===I.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_${r}`,s=200,i=o.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),h.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录...`);let u=0;for(let a=0;a<d;a++){const t=a*s,l=Math.min((a+1)*s,i),r=o.slice(t,l),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${l}条记录...`);const p=r.map((e=>{const t=Bt(e.photo_path_before),a=Bt(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"产生工序":e.process||"无","备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at),"清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],g=window.location.origin,f=(t,l)=>{const o=Math.round(t/l*100);e.setText(`正在导出第${a+1}/${d}部分：${o}% (${t}/${l})`)},k=await $e(p,c,m,g,f);k&&u++}e.close(),u===d?d>1?h.nk.success(`成功导出${d}个文件`):h.nk.success("导出成功"):u>0?h.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):h.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),h.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,xe.Ks.service().close()}},B=async()=>{try{(0,h.nk)({message:"导出大量包含全部图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:I.wasteTypeId?I.wasteTypeId:void 0,minQuantity:I.minQuantity?I.minQuantity:void 0,maxQuantity:I.maxQuantity?I.maxQuantity:void 0,location:I.location||void 0,process:I.process||void 0,dateRange:I.dateRange?JSON.stringify(I.dateRange):void 0,unitId:I.unitId?I.unitId:void 0,showSupervised:I.showSupervised?"true":"false",exportType:"all_images"};console.log("导出记录的筛选条件:",t);const{data:o}=await Po.get(`${_.endpoints.exportWasteRecords}/${Ho.state.user.id}`,t);if(console.log(`从后端获取到 ${o.length} 条记录用于导出`),0===o.length)return e.close(),h.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=I.unitId?l.value.find((e=>e.id===I.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_全部照片_${r}`,s=50,i=o.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),h.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录的全部照片...`);let u=0;for(let a=0;a<d;a++){const t=a*s,l=Math.min((a+1)*s,i),r=o.slice(t,l),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${l}条记录...`);const p=r.map((e=>{const t=Bt(e.photo_path_before),a=Bt(e.photo_path_after),l={"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at)};for(let o=0;o<5;o++)l[`清理前照片${o+1}`]=o<t.length?t[o]:"";for(let o=0;o<5;o++)l[`清理后照片${o+1}`]=o<a.length?a[o]:"";return l})),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"}];for(let e=0;e<5;e++)m.push({text:`清理前照片${e+1}`,field:`清理前照片${e+1}`,isImage:!0});for(let e=0;e<5;e++)m.push({text:`清理后照片${e+1}`,field:`清理后照片${e+1}`,isImage:!0});const g=window.location.origin,f=(t,l)=>{const o=Math.round(t/l*100);e.setText(`正在导出第${a+1}/${d}部分：${o}% (${t}/${l})`)},k=await $e(p,c,m,g,f);k&&u++}e.close(),u===d?d>1?h.nk.success(`成功导出${d}个文件`):h.nk.success("导出成功"):u>0?h.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):h.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),h.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,xe.Ks.service().close()}},q=async()=>{try{const e=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:I.wasteTypeId?I.wasteTypeId:void 0,minQuantity:I.minQuantity?I.minQuantity:void 0,maxQuantity:I.maxQuantity?I.maxQuantity:void 0,location:I.location||void 0,process:I.process||void 0,dateRange:I.dateRange?JSON.stringify(I.dateRange):void 0,unitId:I.unitId?I.unitId:void 0,showSupervised:I.showSupervised?"true":"false",exportType:"no_images"},{data:o}=await Po.get(`${_.endpoints.exportWasteRecords}/${Ho.state.user.id}`,t);if(0===o.length)return e.close(),h.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=I.unitId?l.value.find((e=>e.id===I.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_${r}`,s=1e3,i=o.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),h.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录...`);let u=0;for(let a=0;a<d;a++){const t=a*s,l=Math.min((a+1)*s,i),r=o.slice(t,l),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${l}条记录...`);const p=r.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at),"清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],g=await Te(p,c,m);g&&u++}e.close(),u===d?d>1?h.nk.success(`成功导出${d}个文件`):h.nk.success("导出成功"):u>0?h.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):h.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),h.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,xe.Ks.service().close()}},z=e=>{b.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await Po.delete(`${_.getUrl(_.endpoints.wasteRecords)}/${e.id}`),h.nk.success("删除成功"),await S()}catch(t){console.error("删除记录失败:",t),h.nk.error("删除记录失败")}})).catch((()=>{h.nk.info("已取消删除")}))},O=(e,t)=>{const a=Array.isArray(e)?e:[e];g.value=a.map((e=>`${i}${e}`)),f.value=t||0,m.value=!0},N=()=>{m.value=!1},j=()=>{console.log("手动触发加载更多");const e=document.querySelector(".el-table__body-wrapper"),a=e?e.scrollTop:0;return S(!0).then((()=>{console.log("加载完成，当前记录数:",t.value.length),setTimeout((()=>{e&&(e.scrollTop=a)}),10)})).catch((e=>{console.error("加载失败:",e),h.nk.error("加载更多数据失败")}))},Y=e=>e+1,H=(0,o.EW)((()=>Ho.state.isLoggedIn&&Ho.state.user&&(3===Ho.state.user.role_id||4===Ho.state.user.role_id))),J=(0,o.EW)((()=>Ho.state.isLoggedIn&&Ho.state.user&&1===Ho.state.user.can_view_logs)),G=(0,o.EW)((()=>Ho.state.isLoggedIn&&Ho.state.user&&4===Ho.state.user.role_id));return{records:t,filteredRecords:W,loading:a,units:l,wasteTypes:r,showFilterPanel:n,filterForm:I,applyFilter:X,resetFilter:Q,exportWithImages:M,exportWithAllImages:B,exportWithoutImages:q,parsePhotoPath:Bt,getPhotosByType:qt,refreshRecords:K,addNewRecord:E,goToUserManagement:U,goToOperationLogs:A,editRecord:D,confirmDelete:z,showViewer:m,previewImages:g,previewIndex:f,previewPhoto:O,closeViewer:N,baseUrl:i,page:v,currentPage:w,pageSize:F,hasMore:x,loadingMore:L,indexMethod:Y,tableHeight:d,debounceTimer:R,tableRef:C,loadMore:j,tableContainer:u,isSuperAdmin:H,canViewLogs:J,isSupervisor:G,auth:Ho}}};const Ot=(0,W.A)(zt,[["render",Mt],["__scopeId","data-v-6fda4594"]]);var Nt=Ot;const jt={class:"user-profile-container"},Yt={class:"header"},Ht={class:"content"};function Jt(e,t,a,l,r,n){const s=(0,o.g2)("arrow-left"),i=(0,o.g2)("el-icon"),d=(0,o.g2)("el-input"),u=(0,o.g2)("el-form-item"),c=(0,o.g2)("el-divider"),p=(0,o.g2)("el-button"),m=(0,o.g2)("el-form"),g=(0,o.g2)("el-card");return(0,o.uX)(),(0,o.CE)("div",jt,[(0,o.Lk)("div",Yt,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(i,null,{default:(0,o.k6)((()=>[(0,o.bF)(s)])),_:1}),t[6]||(t[6]=(0,o.eW)(" 返回 "))]),t[7]||(t[7]=(0,o.Lk)("h1",null,"个人账户设置",-1)),t[8]||(t[8]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",Ht,[(0,o.bF)(g,{class:"profile-card"},{header:(0,o.k6)((()=>t[9]||(t[9]=[(0,o.Lk)("div",{class:"card-header"},[(0,o.Lk)("h3",null,"账户信息")],-1)]))),default:(0,o.k6)((()=>[(0,o.bF)(m,{ref:"profileForm",model:l.form,rules:l.rules,"label-position":"top",class:"profile-form"},{default:(0,o.k6)((()=>[(0,o.bF)(u,{label:"手机号码"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{modelValue:l.form.phone,"onUpdate:modelValue":t[1]||(t[1]=e=>l.form.phone=e),disabled:"",placeholder:"手机号码"},null,8,["modelValue"]),t[10]||(t[10]=(0,o.Lk)("div",{class:"field-hint"},"手机号码不可修改",-1))])),_:1}),(0,o.bF)(u,{label:"用户名",prop:"username"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{modelValue:l.form.username,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.username=e),placeholder:"请输入您的名字"},null,8,["modelValue"])])),_:1}),(0,o.bF)(c,null,{default:(0,o.k6)((()=>t[11]||(t[11]=[(0,o.eW)("修改密码（可选）")]))),_:1}),(0,o.bF)(u,{label:"原密码",prop:"oldPassword"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{modelValue:l.form.oldPassword,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.oldPassword=e),placeholder:"请输入原密码",type:"password","show-password":""},null,8,["modelValue"])])),_:1}),(0,o.bF)(u,{label:"新密码",prop:"newPassword"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{modelValue:l.form.newPassword,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.newPassword=e),placeholder:"请输入新密码",type:"password","show-password":""},null,8,["modelValue"]),t[12]||(t[12]=(0,o.Lk)("div",{class:"field-hint"},"如不修改密码，请留空",-1))])),_:1}),(0,o.bF)(u,{label:"确认新密码",prop:"confirmPassword"},{default:(0,o.k6)((()=>[(0,o.bF)(d,{modelValue:l.form.confirmPassword,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.confirmPassword=e),placeholder:"请再次输入新密码",type:"password","show-password":""},null,8,["modelValue"])])),_:1}),(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(p,{type:"primary",onClick:l.saveProfile,loading:l.loading},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)(" 保存修改 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules"])])),_:1})])])}var Gt={name:"UserProfile",components:{ArrowLeft:v.nkM},setup(){const e=(0,s.rd)(),t=(0,k.KR)(null),a=(0,k.KR)(!1),l=(0,k.Kh)({username:"",phone:"",oldPassword:"",newPassword:"",confirmPassword:""}),r=(0,k.Kh)({username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度应为2-20个字符",trigger:"blur"}],oldPassword:[{validator:(e,t,a)=>{l.newPassword&&!t?a(new Error("修改密码时需要输入原密码")):a()},trigger:"blur"}],newPassword:[{min:1,max:20,message:"密码长度应为1-20个字符",trigger:"blur"}],confirmPassword:[{validator:(e,t,a)=>{l.newPassword?t?t!==l.newPassword?a(new Error("两次输入的密码不一致")):a():a(new Error("请再次输入新密码")):a()},trigger:"blur"}]});(0,o.sV)((()=>{if(!Ho.state.isLoggedIn)return h.nk.error("请先登录"),void e.push("/login");l.username=Ho.state.user.username||"",l.phone=Ho.state.user.phone||""}));const n=()=>{e.go(-1)},i=async()=>{if(Ho.state.isLoggedIn)try{await t.value.validate(),await b.s.confirm("确定要保存这些修改吗？","确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),a.value=!0;const e={username:l.username};l.newPassword&&(e.oldPassword=l.oldPassword,e.newPassword=l.newPassword),await Po.put(_.getUrl(`/api/users/${Ho.state.user.id}/profile`),e),Ho.updateUserInfo({...Ho.state.user,username:l.username}),h.nk.success("个人资料已更新"),l.oldPassword="",l.newPassword="",l.confirmPassword="",setTimeout((()=>{n()}),1500)}catch(e){if("cancel"===e)return;e.response&&e.response.data&&e.response.data.error?h.nk.error(e.response.data.error):e.message?h.nk.error(e.message):h.nk.error("保存失败，请重试")}finally{a.value=!1}else h.nk.error("请先登录")};return{profileForm:t,form:l,rules:r,loading:a,goBack:n,saveProfile:i}}};const Zt=(0,W.A)(Gt,[["render",Jt],["__scopeId","data-v-6ab973ca"]]);var ea=Zt;const ta={class:"operation-logs-container"},aa={class:"header"},la={class:"content"},oa={class:"filter-section"},ra={class:"filter-header"},na={class:"stats-section"},sa={class:"stat-content"},ia={class:"stat-number"},da={class:"stat-content"},ua={class:"stat-number"},ca={class:"stat-content"},pa={class:"stat-number"},ma={class:"stat-content"},ga={class:"stat-number"},fa={class:"table-section"},ka={class:"table-header"},ha={class:"total-count"},ba={class:"phone-text"},va={class:"description-text"},ya={class:"pagination-section"},wa={key:0,class:"detail-content"},_a={class:"user-agent-text"},Fa={class:"description-detail"},xa={key:0,class:"additional-data"};function La(e,t,a,l,r,n){const s=(0,o.g2)("arrow-left"),d=(0,o.g2)("el-icon"),u=(0,o.g2)("refresh"),c=(0,o.g2)("el-button"),p=(0,o.g2)("el-option"),m=(0,o.g2)("el-select"),g=(0,o.g2)("el-form-item"),f=(0,o.g2)("search"),k=(0,o.g2)("el-input"),h=(0,o.g2)("el-date-picker"),b=(0,o.g2)("el-form"),v=(0,o.g2)("el-card"),y=(0,o.g2)("el-col"),w=(0,o.g2)("el-row"),_=(0,o.g2)("el-table-column"),F=(0,o.g2)("el-tag"),x=(0,o.g2)("el-tooltip"),L=(0,o.g2)("el-table"),C=(0,o.g2)("el-pagination"),I=(0,o.g2)("el-descriptions-item"),R=(0,o.g2)("el-descriptions"),W=(0,o.g2)("el-dialog"),V=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",ta,[(0,o.Lk)("div",aa,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(s)])),_:1}),t[9]||(t[9]=(0,o.eW)(" 返回 "))]),t[10]||(t[10]=(0,o.Lk)("h1",null,"操作日志管理",-1)),t[11]||(t[11]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",la,[(0,o.Lk)("div",oa,[(0,o.bF)(v,null,{header:(0,o.k6)((()=>[(0,o.Lk)("div",ra,[t[13]||(t[13]=(0,o.Lk)("span",null,[(0,o.eW)("筛选条件 "),(0,o.Lk)("small",{style:{color:"#909399"}})],-1)),(0,o.bF)(c,{type:"primary",link:"",onClick:l.resetFilters},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1}),t[12]||(t[12]=(0,o.eW)(" 重置筛选 "))])),_:1},8,["onClick"])])])),default:(0,o.k6)((()=>[(0,o.bF)(b,{model:l.filters,inline:""},{default:(0,o.k6)((()=>[(0,o.bF)(g,{label:"操作类型"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{modelValue:l.filters.operationType,"onUpdate:modelValue":t[1]||(t[1]=e=>l.filters.operationType=e),placeholder:"选择操作类型",clearable:"",style:{width:"140px"}},{default:(0,o.k6)((()=>[(0,o.bF)(p,{label:"登录",value:"login"}),(0,o.bF)(p,{label:"创建",value:"create"}),(0,o.bF)(p,{label:"更新",value:"update"}),(0,o.bF)(p,{label:"删除",value:"delete"})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(g,{label:"操作人员"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{modelValue:l.filters.userKeyword,"onUpdate:modelValue":t[2]||(t[2]=e=>l.filters.userKeyword=e),placeholder:"输入用户名或手机号搜索",clearable:"",style:{width:"200px"}},{prefix:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(g,{label:"时间范围"},{default:(0,o.k6)((()=>[(0,o.bF)(h,{modelValue:l.dateRange,"onUpdate:modelValue":t[3]||(t[3]=e=>l.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:l.handleDateChange,style:{width:"280px"}},null,8,["modelValue","onChange"])])),_:1}),(0,o.bF)(g,{label:"描述关键词"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{modelValue:l.filters.description,"onUpdate:modelValue":t[4]||(t[4]=e=>l.filters.description=e),placeholder:"输入关键词搜索",style:{width:"200px"},clearable:""},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1})]),(0,o.Lk)("div",na,[(0,o.bF)(w,{gutter:16},{default:(0,o.k6)((()=>[(0,o.bF)(y,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(v,{class:"stat-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",sa,[(0,o.Lk)("div",ia,(0,i.v_)(l.totalStats.login||0),1),t[14]||(t[14]=(0,o.Lk)("div",{class:"stat-label"},"登录操作",-1))])])),_:1})])),_:1}),(0,o.bF)(y,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(v,{class:"stat-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",da,[(0,o.Lk)("div",ua,(0,i.v_)(l.totalStats.create||0),1),t[15]||(t[15]=(0,o.Lk)("div",{class:"stat-label"},"创建操作",-1))])])),_:1})])),_:1}),(0,o.bF)(y,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(v,{class:"stat-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",ca,[(0,o.Lk)("div",pa,(0,i.v_)(l.totalStats.update||0),1),t[16]||(t[16]=(0,o.Lk)("div",{class:"stat-label"},"更新操作",-1))])])),_:1})])),_:1}),(0,o.bF)(y,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(v,{class:"stat-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",ma,[(0,o.Lk)("div",ga,(0,i.v_)(l.totalStats.delete||0),1),t[17]||(t[17]=(0,o.Lk)("div",{class:"stat-label"},"删除操作",-1))])])),_:1})])),_:1})])),_:1})]),(0,o.Lk)("div",fa,[(0,o.bF)(v,null,{header:(0,o.k6)((()=>[(0,o.Lk)("div",ka,[t[18]||(t[18]=(0,o.Lk)("span",null,"操作日志列表",-1)),(0,o.Lk)("span",ha,"共 "+(0,i.v_)(l.pagination.total)+" 条记录",1)])])),default:(0,o.k6)((()=>[(0,o.bo)(((0,o.uX)(),(0,o.Wv)(L,{data:l.logs,style:{width:"100%"},size:"small"},{default:(0,o.k6)((()=>[(0,o.bF)(_,{prop:"id",label:"ID",width:"60"}),(0,o.bF)(_,{prop:"created_at",label:"操作时间",width:"160"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(l.formatDateTime(e.row.created_at)),1)])),_:1}),(0,o.bF)(_,{prop:"operation_type",label:"操作类型",width:"80"},{default:(0,o.k6)((e=>[(0,o.bF)(F,{type:l.getOperationTypeColor(e.row.operation_type),size:"small"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.getOperationTypeName(e.row.operation_type)),1)])),_:2},1032,["type"])])),_:1}),(0,o.bF)(_,{prop:"target_type",label:"目标类型",width:"100"},{default:(0,o.k6)((e=>[(0,o.bF)(F,{type:"info",size:"small"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.getTargetTypeName(e.row.target_type)),1)])),_:2},1024)])),_:1}),(0,o.bF)(_,{label:"操作人员",width:"120"},{default:(0,o.k6)((e=>[(0,o.Lk)("div",null,[(0,o.Lk)("div",null,(0,i.v_)(e.row.username||"未知"),1),(0,o.Lk)("div",ba,(0,i.v_)(e.row.phone||"-"),1)])])),_:1}),(0,o.bF)(_,{prop:"role_name",label:"角色",width:"80"}),(0,o.bF)(_,{prop:"description",label:"操作描述","min-width":"300"},{default:(0,o.k6)((e=>[(0,o.bF)(x,{content:e.row.description,placement:"top"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",va,(0,i.v_)(e.row.description),1)])),_:2},1032,["content"])])),_:1}),(0,o.bF)(_,{prop:"ip_address",label:"IP地址",width:"120"}),(0,o.bF)(_,{label:"操作",width:"80"},{default:(0,o.k6)((e=>[(0,o.bF)(c,{type:"primary",link:"",size:"small",onClick:t=>l.showDetail(e.row)},{default:(0,o.k6)((()=>t[19]||(t[19]=[(0,o.eW)(" 详情 ")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[V,l.loading]]),(0,o.Lk)("div",ya,[(0,o.bF)(C,{"current-page":l.pagination.page,"onUpdate:currentPage":t[5]||(t[5]=e=>l.pagination.page=e),"page-size":l.pagination.pageSize,"onUpdate:pageSize":t[6]||(t[6]=e=>l.pagination.pageSize=e),"page-sizes":[10,20,50,100],total:l.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:l.handleSizeChange,onCurrentChange:l.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])])),_:1})])]),(0,o.bF)(W,{modelValue:l.detailVisible,"onUpdate:modelValue":t[8]||(t[8]=e=>l.detailVisible=e),title:"操作日志详情",width:"60%","close-on-click-modal":!1},{footer:(0,o.k6)((()=>[(0,o.bF)(c,{onClick:t[7]||(t[7]=e=>l.detailVisible=!1)},{default:(0,o.k6)((()=>t[21]||(t[21]=[(0,o.eW)("关闭")]))),_:1})])),default:(0,o.k6)((()=>[l.selectedLog?((0,o.uX)(),(0,o.CE)("div",wa,[(0,o.bF)(R,{column:2,border:""},{default:(0,o.k6)((()=>[(0,o.bF)(I,{label:"日志ID"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.selectedLog.id),1)])),_:1}),(0,o.bF)(I,{label:"操作时间"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.formatDateTime(l.selectedLog.created_at)),1)])),_:1}),(0,o.bF)(I,{label:"操作类型"},{default:(0,o.k6)((()=>[(0,o.bF)(F,{type:l.getOperationTypeColor(l.selectedLog.operation_type)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.getOperationTypeName(l.selectedLog.operation_type)),1)])),_:1},8,["type"])])),_:1}),(0,o.bF)(I,{label:"目标类型"},{default:(0,o.k6)((()=>[(0,o.bF)(F,{type:"info"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.getTargetTypeName(l.selectedLog.target_type)),1)])),_:1})])),_:1}),(0,o.bF)(I,{label:"目标ID"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.selectedLog.target_id||"-"),1)])),_:1}),(0,o.bF)(I,{label:"操作人员"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.selectedLog.username||"未知"),1)])),_:1}),(0,o.bF)(I,{label:"手机号"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.selectedLog.phone||"-"),1)])),_:1}),(0,o.bF)(I,{label:"角色"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.selectedLog.role_name||"-"),1)])),_:1}),(0,o.bF)(I,{label:"IP地址"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(l.selectedLog.ip_address||"-"),1)])),_:1}),(0,o.bF)(I,{label:"用户代理",span:"2"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",_a,(0,i.v_)(l.selectedLog.user_agent||"-"),1)])),_:1}),(0,o.bF)(I,{label:"操作描述",span:"2"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",Fa,(0,i.v_)(l.selectedLog.description),1)])),_:1})])),_:1}),l.selectedLog.additional_data?((0,o.uX)(),(0,o.CE)("div",xa,[t[20]||(t[20]=(0,o.Lk)("h4",null,"附加数据",-1)),(0,o.bF)(k,{type:"textarea",rows:10,value:l.formatAdditionalData(l.selectedLog.additional_data),readonly:""},null,8,["value"])])):(0,o.Q3)("",!0)])):(0,o.Q3)("",!0)])),_:1},8,["modelValue"]),t[22]||(t[22]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var Ca={name:"OperationLogsView",components:{ArrowLeft:v.nkM,Search:v.vji,Refresh:v.C42},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)([]),l=(0,k.KR)({}),r=(0,k.KR)(!1),n=(0,k.KR)(null),i=(0,k.KR)([]),d=(0,k.Kh)({operationType:"",userKeyword:"",startDate:"",endDate:"",description:""}),u=(0,k.Kh)({page:1,pageSize:20,total:0}),c=(0,o.EW)((()=>Ho.state.isLoggedIn&&Ho.state.user&&1===Ho.state.user.can_view_logs));let p=null;(0,o.wB)([()=>d.operationType,()=>d.userKeyword,()=>d.startDate,()=>d.endDate,()=>d.description],(()=>{p&&clearTimeout(p),p=setTimeout((()=>{u.page=1,m(),g()}),500)})),(0,o.sV)((async()=>{if(!c.value)return h.nk.error("您没有权限查看操作日志"),void e.push("/");await Promise.all([m(),g()])})),(0,o.hi)((()=>{p&&(clearTimeout(p),p=null)}));const m=async()=>{try{t.value=!0;const e={page:u.page,pageSize:u.pageSize};d.operationType&&""!==d.operationType.trim()&&(e.operationType=d.operationType),d.userKeyword&&""!==d.userKeyword.trim()&&(e.userKeyword=d.userKeyword),d.startDate&&""!==d.startDate.trim()&&(e.startDate=d.startDate),d.endDate&&""!==d.endDate.trim()&&(e.endDate=d.endDate),d.description&&""!==d.description.trim()&&(e.description=d.description);const l=await Po.get(_.endpoints.operationLogs,e);a.value=l.data.logs||[],u.total=l.data.pagination.total||0}catch(e){console.error("获取操作日志失败:",e),h.nk.error("获取操作日志失败")}finally{t.value=!1}},g=async()=>{try{const e={};d.startDate&&""!==d.startDate.trim()&&(e.startDate=d.startDate),d.endDate&&""!==d.endDate.trim()&&(e.endDate=d.endDate);const t=await Po.get(`${_.endpoints.operationLogs}/stats`,e),a=t.data.totalStats||[],o={};a.forEach((e=>{o[e.operation_type]=e.total_count})),l.value=o}catch(e){console.error("获取统计信息失败:",e),l.value={login:0,create:0,update:0,delete:0}}},f=()=>{Object.keys(d).forEach((e=>{d[e]=""})),i.value=[],u.page=1},b=e=>{e&&2===e.length?(d.startDate=e[0],d.endDate=e[1]):(d.startDate="",d.endDate="")},v=e=>{u.pageSize=e,u.page=1,m()},y=e=>{u.page=e,m()},w=e=>{n.value=e,r.value=!0},F=e=>e?new Date(e).toLocaleString("zh-CN"):"-",x=e=>{const t={login:"登录",create:"创建",update:"更新",delete:"删除"};return t[e]||e},L=e=>{const t={login:"",create:"success",update:"warning",delete:"danger"};return t[e]||""},C=e=>{const t={waste_record:"废物记录",user:"用户管理",unit:"单位管理",waste_type:"废物类型"};return t[e]||e||"-"},I=e=>{if(!e)return"";try{const t="string"===typeof e?JSON.parse(e):e;return JSON.stringify(t,null,2)}catch(t){return e.toString()}},R=()=>{e.go(-1)};return{loading:t,logs:a,totalStats:l,filters:d,pagination:u,dateRange:i,detailVisible:r,selectedLog:n,hasPermission:c,fetchLogs:m,resetFilters:f,handleDateChange:b,handleSizeChange:v,handleCurrentChange:y,showDetail:w,formatDateTime:F,getOperationTypeName:x,getOperationTypeColor:L,getTargetTypeName:C,formatAdditionalData:I,goBack:R}}};const Ia=(0,W.A)(Ca,[["render",La],["__scopeId","data-v-9351c582"]]);var Ra=Ia;const Wa={class:"company-management-container"},Va={class:"header"},$a={class:"content"},Ta={class:"toolbar"},Sa={class:"search-container"},Pa={class:"stats-info"},Ka={class:"dialog-footer"},Ea={key:0,class:"stats-detail"},Ua={class:"stats-grid"},Aa={class:"stat-item"},Da={class:"stat-value"},Xa={class:"stat-item"},Qa={class:"stat-value"},Ma={class:"stat-item"},Ba={class:"stat-value"};function qa(e,t,a,l,r,n){const s=(0,o.g2)("arrow-left"),d=(0,o.g2)("el-icon"),u=(0,o.g2)("search"),c=(0,o.g2)("el-input"),p=(0,o.g2)("plus"),m=(0,o.g2)("el-button"),g=(0,o.g2)("el-table-column"),f=(0,o.g2)("el-tag"),k=(0,o.g2)("el-popconfirm"),h=(0,o.g2)("el-tooltip"),b=(0,o.g2)("el-table"),v=(0,o.g2)("el-form-item"),y=(0,o.g2)("el-option"),w=(0,o.g2)("el-select"),_=(0,o.g2)("el-form"),F=(0,o.g2)("el-dialog"),x=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",Wa,[(0,o.Lk)("div",Va,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(s)])),_:1}),t[8]||(t[8]=(0,o.eW)(" 返回 "))]),t[9]||(t[9]=(0,o.Lk)("h1",null,"公司管理",-1)),t[10]||(t[10]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",$a,[(0,o.Lk)("div",Ta,[(0,o.Lk)("div",Sa,[(0,o.bF)(c,{modelValue:l.searchKeyword,"onUpdate:modelValue":t[1]||(t[1]=e=>l.searchKeyword=e),placeholder:"请输入公司名称搜索",clearable:"",onClear:l.clearSearch,class:"search-input"},{prefix:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1})])),_:1},8,["modelValue","onClear"])]),(0,o.bF)(m,{type:"primary",onClick:l.openAddDialog},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1}),t[11]||(t[11]=(0,o.eW)(" 添加公司 "))])),_:1},8,["onClick"])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(b,{data:l.companies,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,o.k6)((()=>[(0,o.bF)(g,{type:"index",label:"序号",width:"70",align:"center"}),(0,o.bF)(g,{prop:"name",label:"公司名称","min-width":"200"}),(0,o.bF)(g,{prop:"code",label:"公司代码",width:"150"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(e.row.code||"未设置"),1)])),_:1}),(0,o.bF)(g,{label:"状态",width:"100",align:"center"},{default:(0,o.k6)((e=>[(0,o.bF)(f,{type:1===e.row.status?"success":"danger"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(1===e.row.status?"正常":"已停用"),1)])),_:2},1032,["type"])])),_:1}),(0,o.bF)(g,{label:"统计信息",width:"200",align:"center"},{default:(0,o.k6)((e=>[(0,o.Lk)("div",Pa,[(0,o.Lk)("div",null,"单位: "+(0,i.v_)(e.row.stats?.units||0),1),(0,o.Lk)("div",null,"用户: "+(0,i.v_)(e.row.stats?.users||0),1),(0,o.Lk)("div",null,"记录: "+(0,i.v_)(e.row.stats?.records||0),1)])])),_:1}),(0,o.bF)(g,{label:"操作",width:"300",fixed:"right"},{default:(0,o.k6)((e=>[(0,o.bF)(m,{size:"small",onClick:t=>l.handleEdit(e.row)},{default:(0,o.k6)((()=>t[12]||(t[12]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,o.bF)(m,{size:"small",type:1===e.row.status?"warning":"success",onClick:t=>l.handleStatusChange(e.row)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(1===e.row.status?"停用":"恢复"),1)])),_:2},1032,["type","onClick"]),(0,o.bF)(m,{size:"small",type:"info",onClick:t=>l.viewStats(e.row)},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)(" 查看统计 ")]))),_:2},1032,["onClick"]),!e.row.stats||0===e.row.stats.units&&0===e.row.stats.users&&0===e.row.stats.records?((0,o.uX)(),(0,o.Wv)(k,{key:0,title:"确定要删除此公司吗？",onConfirm:t=>l.handleDelete(e.row)},{reference:(0,o.k6)((()=>[(0,o.bF)(m,{size:"small",type:"danger"},{default:(0,o.k6)((()=>t[14]||(t[14]=[(0,o.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])):((0,o.uX)(),(0,o.Wv)(h,{key:1,content:"该公司下还有用户、单位或记录，无法删除",placement:"top"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{size:"small",type:"danger",disabled:""},{default:(0,o.k6)((()=>t[15]||(t[15]=[(0,o.eW)("删除")]))),_:1})])),_:1}))])),_:1})])),_:1},8,["data"])),[[x,l.loading]])]),(0,o.bF)(F,{modelValue:l.dialogVisible,"onUpdate:modelValue":t[6]||(t[6]=e=>l.dialogVisible=e),title:l.isEdit?"编辑公司":"添加公司",width:"500px"},{footer:(0,o.k6)((()=>[(0,o.Lk)("span",Ka,[(0,o.bF)(m,{onClick:t[5]||(t[5]=e=>l.dialogVisible=!1)},{default:(0,o.k6)((()=>t[16]||(t[16]=[(0,o.eW)("取消")]))),_:1}),(0,o.bF)(m,{type:"primary",onClick:l.submitForm,loading:l.formLoading},{default:(0,o.k6)((()=>t[17]||(t[17]=[(0,o.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,o.k6)((()=>[(0,o.bF)(_,{ref:"companyForm",model:l.form,rules:l.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,o.k6)((()=>[(0,o.bF)(v,{label:"公司名称",prop:"name"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.name,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.name=e),placeholder:"请输入公司名称"},null,8,["modelValue"])])),_:1}),(0,o.bF)(v,{label:"公司代码",prop:"code"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.code,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.code=e),placeholder:"请输入公司代码（可选）"},null,8,["modelValue"])])),_:1}),l.isEdit?((0,o.uX)(),(0,o.Wv)(v,{key:0,label:"状态",prop:"status"},{default:(0,o.k6)((()=>[(0,o.bF)(w,{modelValue:l.form.status,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.status=e),placeholder:"请选择状态",style:{width:"100%"}},{default:(0,o.k6)((()=>[(0,o.bF)(y,{value:1,label:"正常"}),(0,o.bF)(y,{value:0,label:"停用"})])),_:1},8,["modelValue"])])),_:1})):(0,o.Q3)("",!0)])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),(0,o.bF)(F,{modelValue:l.statsDialogVisible,"onUpdate:modelValue":t[7]||(t[7]=e=>l.statsDialogVisible=e),title:"公司统计信息",width:"600px"},{default:(0,o.k6)((()=>[l.currentCompanyStats?((0,o.uX)(),(0,o.CE)("div",Ea,[(0,o.Lk)("h3",null,(0,i.v_)(l.currentCompanyStats.company.name),1),(0,o.Lk)("div",Ua,[(0,o.Lk)("div",Aa,[t[18]||(t[18]=(0,o.Lk)("div",{class:"stat-label"},"单位数量",-1)),(0,o.Lk)("div",Da,(0,i.v_)(l.currentCompanyStats.stats.units),1)]),(0,o.Lk)("div",Xa,[t[19]||(t[19]=(0,o.Lk)("div",{class:"stat-label"},"用户数量",-1)),(0,o.Lk)("div",Qa,(0,i.v_)(l.currentCompanyStats.stats.users),1)]),(0,o.Lk)("div",Ma,[t[20]||(t[20]=(0,o.Lk)("div",{class:"stat-label"},"废物记录",-1)),(0,o.Lk)("div",Ba,(0,i.v_)(l.currentCompanyStats.stats.records),1)])])])):(0,o.Q3)("",!0)])),_:1},8,["modelValue"]),t[21]||(t[21]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var za={name:"CompanyManagement",components:{ArrowLeft:v.nkM,Plus:v.FWt,Search:v.vji},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)(!1),l=(0,k.KR)(!1),r=(0,k.KR)(!1),n=(0,k.KR)(!1),i=(0,k.KR)(null),d=(0,k.KR)([]),u=(0,k.KR)(""),c=(0,k.KR)([]),p=(0,k.KR)(null);if(!Ho.isSystemAdmin())return h.nk.error("权限不足，只有系统超级管理员可以访问此页面"),e.push("/"),{};const m=(0,k.Kh)({id:null,name:"",code:"",status:1}),g={name:[{required:!0,message:"请输入公司名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],code:[{max:20,message:"长度不能超过 20 个字符",trigger:"blur"}]},f=(0,o.EW)((()=>{if(!u.value.trim())return c.value;const e=u.value.toLowerCase();return c.value.filter((t=>t.name.toLowerCase().includes(e)||t.code&&t.code.toLowerCase().includes(e)))})),b=async()=>{t.value=!0;try{const e=await Po.get(_.endpoints.companies),t=await Promise.all(e.data.map((async e=>{try{const t=await Po.get(_.endpoints.companyStats.replace(":id",e.id));return{...e,stats:t.data.stats}}catch(t){return console.error(`获取公司 ${e.name} 统计信息失败:`,t),{...e,stats:{units:0,users:0,records:0}}}})));c.value=t}catch(e){console.error("Error fetching companies:",e),h.nk.error("获取公司列表失败")}finally{t.value=!1}};(0,o.wB)(f,(e=>{d.value=e}),{immediate:!0});const v=()=>{n.value=!1,L(),l.value=!0},y=e=>{n.value=!0,m.id=e.id,m.name=e.name,m.code=e.code||"",m.status=e.status,l.value=!0},w=async e=>{try{await Po.delete(`${_.endpoints.companies}/${e.id}`),h.nk.success("公司删除成功"),b()}catch(t){console.error("Error deleting company:",t);let e="删除公司失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),h.nk.error(e)}},F=async e=>{const t=1===e.status?0:1,a=1===t?"恢复":"停用";try{await Po.put(`${_.endpoints.companies}/${e.id}`,{name:e.name,code:e.code,status:t}),h.nk.success(`公司${a}成功`),b()}catch(l){console.error("状态变更失败:",l);let e=`${a}公司失败`;l.response&&l.response.data&&l.response.data.error&&(e=l.response.data.error),h.nk.error(e)}},x=async e=>{try{const t=await Po.get(_.endpoints.companyStats.replace(":id",e.id));p.value=t.data,r.value=!0}catch(t){console.error("获取公司统计失败:",t),h.nk.error("获取公司统计信息失败")}},L=()=>{i.value&&i.value.resetFields(),m.id=null,m.name="",m.code="",m.status=1},C=()=>{i.value.validate((async e=>{if(e){a.value=!0;try{const e={name:m.name,code:m.code||null,status:m.status};n.value?(await Po.put(`${_.endpoints.companies}/${m.id}`,e),h.nk.success("公司更新成功")):(await Po.post(_.endpoints.companies,e),h.nk.success("公司添加成功")),l.value=!1,b()}catch(t){console.error("Error submitting company form:",t);let e=n.value?"更新公司失败":"添加公司失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),h.nk.error(e)}finally{a.value=!1}}else h.nk.warning("请完成必填项")}))},I=()=>{e.back()},R=()=>{u.value=""};return(0,o.sV)((()=>{b()})),{loading:t,formLoading:a,dialogVisible:l,statsDialogVisible:r,isEdit:n,companyForm:i,companies:d,form:m,rules:g,currentCompanyStats:p,openAddDialog:v,handleEdit:y,handleDelete:w,handleStatusChange:F,viewStats:x,submitForm:C,goBack:I,searchKeyword:u,clearSearch:R}}};const Oa=(0,W.A)(za,[["render",qa],["__scopeId","data-v-27e228e0"]]);var Na=Oa;const ja={class:"super-admin-records-container"},Ya={class:"header"},Ha={class:"header-actions"},Ja={class:"content"},Ga={class:"card-header"},Za={class:"filter-form-container"},el={class:"filter-actions"},tl={class:"card-header"},al={class:"card-actions"},ll={class:"responsive-table"},ol={key:0,class:"photo-preview"},rl=["onClick"],nl={key:0,class:"photo-count"},sl={key:1},il={key:0,class:"photo-preview"},dl=["onClick"],ul={key:0,class:"photo-count"},cl={key:1},pl={class:"operation-buttons"},ml={key:0,class:"loading-row"},gl={key:1,class:"load-more-row"},fl={key:2,class:"no-more-row"},kl={key:0,class:"empty-state"};function hl(e,t,a,r,n,s){const d=(0,o.g2)("el-button"),u=(0,o.g2)("arrow-up"),c=(0,o.g2)("el-icon"),p=(0,o.g2)("arrow-down"),m=(0,o.g2)("el-option"),g=(0,o.g2)("el-select"),f=(0,o.g2)("el-form-item"),k=(0,o.g2)("el-col"),h=(0,o.g2)("el-date-picker"),b=(0,o.g2)("el-row"),v=(0,o.g2)("el-input-number"),y=(0,o.g2)("el-input"),w=(0,o.g2)("el-form"),_=(0,o.g2)("el-collapse-transition"),F=(0,o.g2)("el-card"),x=(0,o.g2)("refresh"),L=(0,o.g2)("download"),C=(0,o.g2)("el-dropdown-item"),I=(0,o.g2)("el-dropdown-menu"),R=(0,o.g2)("el-dropdown"),W=(0,o.g2)("user"),V=(0,o.g2)("document"),$=(0,o.g2)("chat-line-round"),T=(0,o.g2)("el-table-column"),S=(0,o.g2)("el-image"),P=(0,o.g2)("loading"),K=(0,o.g2)("el-table"),E=(0,o.g2)("el-empty"),U=(0,o.g2)("el-image-viewer"),A=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",ja,[(0,o.Lk)("div",Ya,[t[10]||(t[10]=(0,o.Lk)("div",null,null,-1)),t[11]||(t[11]=(0,o.Lk)("h1",null,"系统管理 - 固体废物记录",-1)),(0,o.Lk)("div",Ha,[(0,o.bF)(d,{type:"success",onClick:r.goToCompanyManagement},{default:(0,o.k6)((()=>t[9]||(t[9]=[(0,o.eW)(" 公司管理 ")]))),_:1},8,["onClick"])])]),(0,o.Lk)("div",Ja,[(0,o.bF)(F,{class:"filter-card",shadow:"hover"},{header:(0,o.k6)((()=>[(0,o.Lk)("div",Ga,[t[12]||(t[12]=(0,o.Lk)("span",null,"筛选条件",-1)),(0,o.bF)(d,{link:"",type:"primary",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,o.k6)((()=>[r.showFilterPanel?((0,o.uX)(),(0,o.Wv)(c,{key:0},{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1})):((0,o.uX)(),(0,o.Wv)(c,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1})),(0,o.eW)(" "+(0,i.v_)(r.showFilterPanel?"收起":"展开"),1)])),_:1})])])),default:(0,o.k6)((()=>[(0,o.bF)(_,null,{default:(0,o.k6)((()=>[(0,o.bo)((0,o.Lk)("div",Za,[(0,o.bF)(w,{model:r.filterForm,class:"filter-form","label-width":"80px"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(k,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"公司"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:r.filterForm.companyId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.companyId=e),placeholder:"请选择公司",clearable:""},{default:(0,o.k6)((()=>[(0,o.bF)(m,{label:"全部公司",value:null}),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.companies,(e=>((0,o.uX)(),(0,o.Wv)(m,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(k,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"单位"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.unitId=e),placeholder:"请选择单位",clearable:""},{default:(0,o.k6)((()=>[(0,o.bF)(m,{label:"全部单位",value:null}),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.filteredUnits,(e=>((0,o.uX)(),(0,o.Wv)(m,{key:e.id,label:`${e.name} (${e.company_name})`,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(k,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"废物类型"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"请选择废物类型",clearable:""},{default:(0,o.k6)((()=>[(0,o.bF)(m,{label:"全部类型",value:null}),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(m,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(k,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"时间范围"},{default:(0,o.k6)((()=>[(0,o.bF)(h,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.bF)(b,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(k,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"最小数量"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.minQuantity=e),min:0,precision:3,placeholder:"最小数量",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(k,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"最大数量"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.maxQuantity=e),min:0,precision:3,placeholder:"最大数量",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(k,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"产生地点"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.location=e),placeholder:"请输入产生地点",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(k,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"产生工序"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{modelValue:r.filterForm.process,"onUpdate:modelValue":t[8]||(t[8]=e=>r.filterForm.process=e),placeholder:"请输入产生工序",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.bF)(b,null,{default:(0,o.k6)((()=>[(0,o.bF)(k,{span:24,class:"filter-buttons-col"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",el,[(0,o.bF)(d,{onClick:r.resetFilter},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)("重置")]))),_:1},8,["onClick"]),(0,o.bF)(d,{type:"primary",onClick:r.applyFilter},{default:(0,o.k6)((()=>t[14]||(t[14]=[(0,o.eW)("查询")]))),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])],512),[[l.aG,r.showFilterPanel]])])),_:1})])),_:1}),(0,o.bF)(F,{class:"records-card",shadow:"hover"},{header:(0,o.k6)((()=>[(0,o.Lk)("div",tl,[(0,o.Lk)("span",null,"固体废物记录列表 (共"+(0,i.v_)(r.records.length)+"条)",1),(0,o.Lk)("div",al,[(0,o.bF)(d,{onClick:r.refreshRecords},{default:(0,o.k6)((()=>[(0,o.bF)(c,null,{default:(0,o.k6)((()=>[(0,o.bF)(x)])),_:1}),t[15]||(t[15]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"]),(0,o.bF)(R,{onCommand:r.exportData},{dropdown:(0,o.k6)((()=>[(0,o.bF)(I,null,{default:(0,o.k6)((()=>[(0,o.bF)(C,{command:"withImages"},{default:(0,o.k6)((()=>t[17]||(t[17]=[(0,o.eW)("导出(含首张图片)")]))),_:1}),(0,o.bF)(C,{command:"withAllImages"},{default:(0,o.k6)((()=>t[18]||(t[18]=[(0,o.eW)("导出(含全部图片)")]))),_:1}),(0,o.bF)(C,{command:"withoutImages"},{default:(0,o.k6)((()=>t[19]||(t[19]=[(0,o.eW)("导出(不含图片)")]))),_:1})])),_:1})])),default:(0,o.k6)((()=>[(0,o.bF)(d,{type:"success"},{default:(0,o.k6)((()=>[(0,o.bF)(c,null,{default:(0,o.k6)((()=>[(0,o.bF)(L)])),_:1}),t[16]||(t[16]=(0,o.eW)(" 导出数据 ")),(0,o.bF)(c,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1})])),_:1})])),_:1},8,["onCommand"]),(0,o.bF)(d,{onClick:r.goToUserManagement},{default:(0,o.k6)((()=>[(0,o.bF)(c,null,{default:(0,o.k6)((()=>[(0,o.bF)(W)])),_:1}),t[20]||(t[20]=(0,o.Lk)("span",null,"用户管理",-1))])),_:1},8,["onClick"]),r.canViewLogs?((0,o.uX)(),(0,o.Wv)(d,{key:0,onClick:r.goToOperationLogs},{default:(0,o.k6)((()=>[(0,o.bF)(c,null,{default:(0,o.k6)((()=>[(0,o.bF)(V)])),_:1}),t[21]||(t[21]=(0,o.Lk)("span",null,"操作日志",-1))])),_:1},8,["onClick"])):(0,o.Q3)("",!0),(0,o.bF)(d,{onClick:r.goToFeedbackManagement},{default:(0,o.k6)((()=>[(0,o.bF)(c,null,{default:(0,o.k6)((()=>[(0,o.bF)($)])),_:1}),t[22]||(t[22]=(0,o.Lk)("span",null,"问题反馈",-1))])),_:1},8,["onClick"])])])])),default:(0,o.k6)((()=>[(0,o.Lk)("div",ll,[(0,o.bo)(((0,o.uX)(),(0,o.Wv)(K,{data:r.filteredRecords,border:"",stripe:"",style:{width:"100%"},height:r.tableHeight,ref:"tableRef"},{append:(0,o.k6)((()=>[r.loadingMore?((0,o.uX)(),(0,o.CE)("div",ml,[(0,o.bF)(c,{class:"loading"},{default:(0,o.k6)((()=>[(0,o.bF)(P)])),_:1}),t[25]||(t[25]=(0,o.eW)(" 正在加载... "))])):r.hasMore&&r.records.length>0?((0,o.uX)(),(0,o.CE)("div",gl,[(0,o.bF)(d,{type:"primary",onClick:r.loadMore,disabled:r.loadingMore,size:"small"},{default:(0,o.k6)((()=>[t[26]||(t[26]=(0,o.eW)(" 点击加载更多 ")),(0,o.bF)(c,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1})])),_:1},8,["onClick","disabled"])])):r.records.length>0?((0,o.uX)(),(0,o.CE)("div",fl," 已全部加载 ")):(0,o.Q3)("",!0)])),default:(0,o.k6)((()=>[(0,o.bF)(T,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,o.bF)(T,{prop:"company_name",label:"公司","min-width":"100"}),(0,o.bF)(T,{prop:"unit_name",label:"单位","min-width":"100"}),(0,o.bF)(T,{prop:"waste_type_name",label:"废物类型","min-width":"100"}),(0,o.bF)(T,{prop:"location",label:"产生地点","min-width":"100"}),(0,o.bF)(T,{prop:"process",label:"产生工序","min-width":"100"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(e.row.process||"无"),1)])),_:1}),(0,o.bF)(T,{prop:"remarks",label:"备注","min-width":"120"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,o.bF)(T,{prop:"collection_start_time",label:"收集开始时间","min-width":"160"}),(0,o.bF)(T,{label:"数量(吨)","min-width":"100"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(null!==e.row.quantity&&void 0!==e.row.quantity?parseFloat(e.row.quantity).toFixed(3):""),1)])),_:1}),(0,o.bF)(T,{prop:"creator_name",label:"填报人","min-width":"100"}),(0,o.bF)(T,{prop:"created_at",label:"记录时间","min-width":"160"}),(0,o.bF)(T,{label:"清理前照片","min-width":"140",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_before?((0,o.uX)(),(0,o.CE)("div",ol,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,o.bF)(S,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,rl)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,o.uX)(),(0,o.CE)("div",nl,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",sl,"无"))])),_:1}),(0,o.bF)(T,{label:"清理后照片","min-width":"140",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_after?((0,o.uX)(),(0,o.CE)("div",il,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,o.bF)(S,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,dl)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,o.uX)(),(0,o.CE)("div",ul,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",cl,"无"))])),_:1}),(0,o.bF)(T,{label:"操作","min-width":"130"},{default:(0,o.k6)((e=>[(0,o.Lk)("div",pl,[(0,o.bF)(d,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,o.k6)((()=>t[23]||(t[23]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,o.bF)(d,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,o.k6)((()=>t[24]||(t[24]=[(0,o.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","height"])),[[A,r.loading]])]),0!==r.records.length||r.loading?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("div",kl,[(0,o.bF)(E,{description:"暂无废物记录"})]))])),_:1})]),r.showViewer?((0,o.uX)(),(0,o.Wv)(U,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])}const bl=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}};var vl={name:"SuperAdminRecordsView",components:{Refresh:v.C42,User:v.KJW,ArrowDown:v.yd$,ArrowUp:v.DoI,Download:v.f5X,ElImageViewer:Fe.Tg,Document:v.yoT,ChatLineRound:v.Fv_,Loading:v.Rhj},setup(){const e=(0,s.rd)();if(!Ho.isSystemAdmin())return h.nk.error("权限不足，只有系统超级管理员可以访问此页面"),e.push("/"),{};const t=(0,k.KR)([]),a=(0,k.KR)(!1),l=(0,k.KR)([]),r=(0,k.KR)([]),n=(0,k.KR)([]),i=(0,k.KR)(!0),d=_.baseURL,u=(0,k.KR)(750),c=(0,k.KR)(null),p=(0,k.KR)(1),m=(0,k.KR)(20),g=(0,k.KR)(!0),f=(0,k.KR)(!1),v=(0,k.KR)(!1),y=(0,k.KR)([]),w=(0,k.KR)(0),F=(0,k.Kh)({companyId:null,unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:"",process:""}),x=(0,o.EW)((()=>F.companyId?l.value.filter((e=>e.company_id===F.companyId)):l.value));(0,o.wB)((()=>F.companyId),(()=>{F.unitId=null}));const L=(0,o.EW)((()=>t.value.filter((e=>{if(F.companyId&&e.company_id!==F.companyId)return!1;if(F.unitId&&e.unit_id!==F.unitId)return!1;if(F.wasteTypeId&&e.waste_type_id!==F.wasteTypeId)return!1;if(null!==F.minQuantity&&""!==F.minQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)<F.minQuantity)return!1;if(null!==F.maxQuantity&&""!==F.maxQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)>F.maxQuantity)return!1;if(F.location&&!e.location?.includes(F.location))return!1;if(F.process&&!e.process?.includes(F.process))return!1;if(F.dateRange&&2===F.dateRange.length){const t=new Date(F.dateRange[0]),a=new Date(F.dateRange[1]);a.setHours(23,59,59,999);const l=new Date(e.collection_start_time||e.created_at);if(l<t||l>a)return!1}return!0})))),C=(0,o.EW)((()=>Ho.state.isLoggedIn&&Ho.state.user&&1===Ho.state.user.can_view_logs)),I=async(e=!0)=>{e?(a.value=!0,p.value=1,t.value=[]):f.value=!0;try{const a={page:p.value,pageSize:m.value},l=await Po.get(_.endpoints.wasteRecords,{params:a});t.value=e?l.data.records||l.data:[...t.value,...l.data.records||l.data];const o=l.data.records?l.data.records.length:l.data.length;g.value=o===m.value}catch(l){console.error("Error fetching records:",l),h.nk.error("获取记录列表失败")}finally{a.value=!1,f.value=!1}},R=async()=>{!f.value&&g.value&&(p.value+=1,await I(!1))},W=async()=>{try{const e=await Po.get(_.endpoints.units);l.value=e.data}catch(e){console.error("Error fetching units:",e),h.nk.error("获取单位列表失败")}},V=async()=>{try{const e=await Po.get(_.endpoints.companies);r.value=e.data}catch(e){console.error("Error fetching companies:",e),h.nk.error("获取公司列表失败")}},$=async()=>{try{const e=await Po.get(_.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),h.nk.error("获取废物类型失败")}},T=()=>{I(!0)},S=()=>{Object.keys(F).forEach((e=>{Array.isArray(F[e])?F[e]=[]:(F[e],F[e]=null)})),I(!0)},P=e=>{if(!e)return"";try{const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch(t){return e}},K=e=>{"withImages"===e?E():"withAllImages"===e?U():"withoutImages"===e&&A()},E=async()=>{try{const e=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t=L.value;if(0===t.length)return e.close(),void h.nk.warning("没有可导出的数据");const l="系统管理_固体废物记录",o=50,r=t.length,n=Math.ceil(r/o);n>1?(e.setText(`数据较多(${r}条)，将拆分为${n}个文件导出...`),h.nk.info(`数据较多(${r}条)，将拆分为${n}个文件导出`)):e.setText(`准备导出 ${r} 条记录...`);let s=0;for(let a=0;a<n;a++){const i=a*o,d=Math.min((a+1)*o,r),u=t.slice(i,d),c=n>1?`${l}_第${a+1}部分(共${n}部分)`:l;e.setText(`正在处理第${a+1}/${n}批次，${i+1}-${d}条记录...`);const p=u.map((e=>{const t=bl(e.photo_path_before),a=bl(e.photo_path_after);return{"公司":e.company_name,"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"产生工序":e.process||"无","备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at),"清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),m=[{text:"公司",field:"公司"},{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],g=window.location.origin,f=(t,l)=>{const o=Math.round(t/l*100);e.setText(`正在导出第${a+1}/${n}部分：${o}% (${t}/${l})`)},k=await $e(p,c,m,g,f);k&&s++}e.close(),s===n?n>1?h.nk.success(`成功导出${n}个文件`):h.nk.success("导出成功"):s>0?h.nk.warning(`部分导出成功，完成了${s}/${n}个文件`):h.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),h.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,xe.Ks.service().close()}},U=async()=>{try{(0,h.nk)({message:"导出大量包含全部图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={exportType:"all_images",companyId:F.companyId?F.companyId:void 0};console.log("导出记录的筛选条件:",t);const{data:l}=await Po.get(`${_.endpoints.exportWasteRecords}/${Ho.state.user.id}`,t);if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return e.close(),h.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const o=F.companyId?r.value.find((e=>e.id===F.companyId))?.name||"未知公司":"全部公司",n=`系统管理_固体废物记录_全部照片_${o}`,s=50,i=l.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),h.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录的全部照片...`);let u=0;for(let a=0;a<d;a++){const t=a*s,o=Math.min((a+1)*s,i),r=l.slice(t,o),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${o}条记录...`);const p=r.map((e=>{const t=bl(e.photo_path_before),a=bl(e.photo_path_after),l={"公司":e.company_name,"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at)};for(let o=0;o<5;o++)l[`清理前照片${o+1}`]=o<t.length?t[o]:"";for(let o=0;o<5;o++)l[`清理后照片${o+1}`]=o<a.length?a[o]:"";return l})),m=[{text:"公司",field:"公司"},{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"}];for(let e=0;e<5;e++)m.push({text:`清理前照片${e+1}`,field:`清理前照片${e+1}`,isImage:!0});for(let e=0;e<5;e++)m.push({text:`清理后照片${e+1}`,field:`清理后照片${e+1}`,isImage:!0});const g=window.location.origin,f=(t,l)=>{const o=Math.round(t/l*100);e.setText(`正在导出第${a+1}/${d}部分：${o}% (${t}/${l})`)},k=await $e(p,c,m,g,f);k&&u++}e.close(),u===d?d>1?h.nk.success(`成功导出${d}个文件`):h.nk.success("导出成功"):u>0?h.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):h.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),h.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,xe.Ks.service().close()}},A=async()=>{try{const e=xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t=L.value;if(0===t.length)return e.close(),void h.nk.warning("没有可导出的数据");const l="系统管理_固体废物记录",o=1e3,r=t.length,n=Math.ceil(r/o);n>1?(e.setText(`数据较多(${r}条)，将拆分为${n}个文件导出...`),h.nk.info(`数据较多(${r}条)，将拆分为${n}个文件导出`)):e.setText(`准备导出 ${r} 条记录...`);let s=0;for(let a=0;a<n;a++){const i=a*o,d=Math.min((a+1)*o,r),u=t.slice(i,d),c=n>1?`${l}_第${a+1}部分(共${n}部分)`:l;e.setText(`正在处理第${a+1}/${n}批次，${i+1}-${d}条记录...`);const p=u.map((e=>({"公司":e.company_name,"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at),"清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),m=[{text:"公司",field:"公司"},{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],g=await Te(p,c,m);g&&s++}e.close(),s===n?n>1?h.nk.success(`成功导出${n}个文件`):h.nk.success("导出成功"):s>0?h.nk.warning(`部分导出成功，完成了${s}/${n}个文件`):h.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),h.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,xe.Ks.service().close()}},D=()=>{I(!0)},X=()=>{e.push({name:"UserManagement"})},Q=()=>{e.push({name:"OperationLogs"})},M=()=>{e.push({name:"CompanyManagement"})},B=()=>{e.push({name:"FeedbackManagement"})},q=t=>{e.push({name:"EditRecord",params:{id:t}})},z=e=>{b.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{O(e.id)})).catch((()=>{h.nk.info("已取消删除")}))},O=async e=>{try{await Po.delete(`${_.endpoints.wasteRecords}/${e}`),h.nk.success("删除成功"),I(!0)}catch(t){console.error("Error deleting record:",t),h.nk.error("删除失败")}},N=(e,t)=>{y.value=e.map((e=>`${d}${e}`)),w.value=t,v.value=!0},j=()=>{v.value=!1},Y=e=>e+1;return(0,o.sV)((()=>{I(!0),W(),V(),$()})),{records:t,filteredRecords:L,loading:a,units:l,companies:r,filteredUnits:x,wasteTypes:n,showFilterPanel:i,filterForm:F,applyFilter:T,resetFilter:S,exportData:K,exportWithImages:E,exportWithAllImages:U,exportWithoutImages:A,parsePhotoPath:bl,refreshRecords:D,goToUserManagement:X,goToOperationLogs:Q,goToCompanyManagement:M,goToFeedbackManagement:B,editRecord:q,confirmDelete:z,showViewer:v,previewImages:y,previewIndex:w,previewPhoto:N,closeViewer:j,baseUrl:d,indexMethod:Y,tableHeight:u,tableRef:c,canViewLogs:C,page:p,pageSize:m,hasMore:g,loadingMore:f,loadMore:R}}};const yl=(0,W.A)(vl,[["render",hl],["__scopeId","data-v-14e04a91"]]);var wl=yl;const _l={class:"feedback-container"},Fl={class:"header"},xl={class:"content"};function Ll(e,t,a,r,n,s){const i=(0,o.g2)("arrow-left"),d=(0,o.g2)("el-icon"),u=(0,o.g2)("el-option"),c=(0,o.g2)("el-select"),p=(0,o.g2)("el-form-item"),m=(0,o.g2)("el-input"),g=(0,o.g2)("el-button"),f=(0,o.g2)("el-form"),k=(0,o.g2)("el-card");return(0,o.uX)(),(0,o.CE)("div",_l,[(0,o.Lk)("div",Fl,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(i)])),_:1}),t[5]||(t[5]=(0,o.eW)(" 返回 "))]),t[6]||(t[6]=(0,o.Lk)("h1",null,"问题反馈",-1)),t[7]||(t[7]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",xl,[(0,o.bF)(k,{class:"feedback-card",shadow:"hover"},{header:(0,o.k6)((()=>t[8]||(t[8]=[(0,o.Lk)("div",{class:"card-header"},[(0,o.Lk)("span",null,"提交系统问题反馈")],-1)]))),default:(0,o.k6)((()=>[(0,o.bF)(f,{ref:"formRef",model:r.form,rules:r.rules,"label-width":"100px",onSubmit:(0,l.D$)(r.submitForm,["prevent"])},{default:(0,o.k6)((()=>[(0,o.bF)(p,{label:"问题类型",prop:"type"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:r.form.type,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.type=e),placeholder:"请选择问题类型",style:{width:"100%"}},{default:(0,o.k6)((()=>[(0,o.bF)(u,{label:"系统Bug",value:"bug"}),(0,o.bF)(u,{label:"功能建议",value:"feature"}),(0,o.bF)(u,{label:"体验改进",value:"improvement"}),(0,o.bF)(u,{label:"其他问题",value:"other"})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"优先级",prop:"priority"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:r.form.priority,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.priority=e),placeholder:"请选择优先级",style:{width:"100%"}},{default:(0,o.k6)((()=>[(0,o.bF)(u,{label:"低",value:"low"}),(0,o.bF)(u,{label:"中",value:"medium"}),(0,o.bF)(u,{label:"高",value:"high"}),(0,o.bF)(u,{label:"紧急",value:"urgent"})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"问题标题",prop:"title"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{modelValue:r.form.title,"onUpdate:modelValue":t[3]||(t[3]=e=>r.form.title=e),placeholder:"请简要描述问题"},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"问题描述",prop:"description"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{modelValue:r.form.description,"onUpdate:modelValue":t[4]||(t[4]=e=>r.form.description=e),type:"textarea",rows:6,placeholder:"请详细描述遇到的问题，包括出现的情况、预期的结果等"},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,null,{default:(0,o.k6)((()=>[(0,o.bF)(g,{type:"primary",onClick:r.submitForm,loading:r.loading},{default:(0,o.k6)((()=>t[9]||(t[9]=[(0,o.eW)(" 提交反馈 ")]))),_:1},8,["onClick","loading"]),(0,o.bF)(g,{onClick:r.resetForm},{default:(0,o.k6)((()=>t[10]||(t[10]=[(0,o.eW)("重置")]))),_:1},8,["onClick"]),(0,o.bF)(g,{onClick:r.goBack},{default:(0,o.k6)((()=>t[11]||(t[11]=[(0,o.eW)("取消")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules","onSubmit"])])),_:1})])])}var Cl={name:"FeedbackForm",components:{ArrowLeft:v.nkM},setup(){const e=(0,s.rd)(),t=(0,k.KR)(null),a=(0,k.KR)(!1),l=(0,k.Kh)({type:"bug",priority:"medium",title:"",description:""}),o={type:[{required:!0,message:"请选择问题类型",trigger:"change"}],priority:[{required:!0,message:"请选择优先级",trigger:"change"}],title:[{required:!0,message:"请输入问题标题",trigger:"blur"}],description:[{required:!0,message:"请输入问题描述",trigger:"blur"}]},r=async()=>{try{const o=await t.value.validate();if(!o)return;a.value=!0;const r={type:l.type,priority:l.priority,title:l.title,description:l.description},n=await Po.post(_.endpoints.feedback,r);n.data.success?(h.nk.success("问题反馈提交成功！"),e.push({name:"FeedbackList"})):h.nk.error(n.data.message||"提交失败")}catch(o){console.error("提交问题反馈失败:",o),h.nk.error("提交失败，请重试")}finally{a.value=!1}},n=()=>{t.value.resetFields()},i=()=>{l.title||l.description?b.s.confirm("您有未保存的内容，确定要离开吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{e.back()})):e.back()};return{formRef:t,loading:a,form:l,rules:o,submitForm:r,resetForm:n,goBack:i}}};const Il=(0,W.A)(Cl,[["render",Ll],["__scopeId","data-v-b9058c26"]]);var Rl=Il;const Wl={class:"feedback-list-container"},Vl={class:"header"},$l={class:"header-actions"},Tl={class:"content"},Sl={class:"card-header"},Pl={key:0,style:{"text-align":"center",padding:"50px"}},Kl={key:1,style:{"text-align":"center",padding:"50px"}},El={key:2,class:"feedback-list"},Ul=["onClick"],Al={class:"feedback-header"},Dl={class:"feedback-title"},Xl={class:"feedback-meta"},Ql={class:"feedback-description"},Ml={class:"feedback-footer"},Bl={class:"feedback-time"},ql={class:"feedback-actions"},zl={key:0,class:"feedback-detail"},Ol={class:"description-section"},Nl={class:"description-content"},jl={key:0,class:"reply-section"},Yl={class:"reply-content"},Hl={class:"reply-meta"};function Jl(e,t,a,r,n,s){const d=(0,o.g2)("arrow-left"),u=(0,o.g2)("el-icon"),c=(0,o.g2)("plus"),p=(0,o.g2)("el-button"),m=(0,o.g2)("refresh"),g=(0,o.g2)("loading"),f=(0,o.g2)("el-empty"),k=(0,o.g2)("el-tag"),h=(0,o.g2)("el-card"),b=(0,o.g2)("el-descriptions-item"),v=(0,o.g2)("el-descriptions"),y=(0,o.g2)("el-dialog");return(0,o.uX)(),(0,o.CE)("div",Wl,[(0,o.Lk)("div",Vl,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(d)])),_:1}),t[2]||(t[2]=(0,o.eW)(" 返回 "))]),t[4]||(t[4]=(0,o.Lk)("h1",null,"我的反馈",-1)),(0,o.Lk)("div",$l,[(0,o.bF)(p,{type:"primary",onClick:r.goToNewFeedback},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(c)])),_:1}),t[3]||(t[3]=(0,o.eW)(" 新建反馈 "))])),_:1},8,["onClick"])])]),(0,o.Lk)("div",Tl,[(0,o.bF)(h,{class:"feedback-card",shadow:"hover"},{header:(0,o.k6)((()=>[(0,o.Lk)("div",Sl,[(0,o.Lk)("span",null,"问题反馈记录 (共"+(0,i.v_)(r.feedbacks.length)+"条)",1),(0,o.bF)(p,{onClick:r.fetchFeedbacks},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(m)])),_:1}),t[5]||(t[5]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"])])])),default:(0,o.k6)((()=>[r.loading?((0,o.uX)(),(0,o.CE)("div",Pl,[(0,o.bF)(u,{class:"is-loading"},{default:(0,o.k6)((()=>[(0,o.bF)(g)])),_:1}),t[6]||(t[6]=(0,o.Lk)("p",null,"加载中...",-1))])):0===r.feedbacks.length?((0,o.uX)(),(0,o.CE)("div",Kl,[(0,o.bF)(f,{description:"暂无反馈记录"},{default:(0,o.k6)((()=>[(0,o.bF)(p,{type:"primary",onClick:r.goToNewFeedback},{default:(0,o.k6)((()=>t[7]||(t[7]=[(0,o.eW)("提交反馈")]))),_:1},8,["onClick"])])),_:1})])):((0,o.uX)(),(0,o.CE)("div",El,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.feedbacks,(e=>((0,o.uX)(),(0,o.CE)("div",{key:e.id,class:"feedback-item",onClick:t=>r.viewFeedback(e)},[(0,o.Lk)("div",Al,[(0,o.Lk)("div",Dl,(0,i.v_)(e.title),1),(0,o.Lk)("div",Xl,[(0,o.bF)(k,{type:r.getTypeColor(e.type)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getTypeText(e.type)),1)])),_:2},1032,["type"]),(0,o.bF)(k,{type:r.getPriorityColor(e.priority)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getPriorityText(e.priority)),1)])),_:2},1032,["type"]),(0,o.bF)(k,{type:r.getStatusColor(e.status)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getStatusText(e.status)),1)])),_:2},1032,["type"])])]),(0,o.Lk)("div",Ql,(0,i.v_)(e.description.length>100?e.description.substring(0,100)+"...":e.description),1),(0,o.Lk)("div",Ml,[(0,o.Lk)("span",Bl,(0,i.v_)(r.formatDateTime(e.created_at)),1),(0,o.Lk)("div",ql,[(0,o.bF)(p,{size:"small",onClick:(0,l.D$)((t=>r.viewFeedback(e)),["stop"])},{default:(0,o.k6)((()=>t[8]||(t[8]=[(0,o.eW)("查看详情")]))),_:2},1032,["onClick"]),"pending"===e.status?((0,o.uX)(),(0,o.Wv)(p,{key:0,size:"small",type:"danger",onClick:(0,l.D$)((t=>r.deleteFeedback(e)),["stop"])},{default:(0,o.k6)((()=>t[9]||(t[9]=[(0,o.eW)("删除")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0)])])],8,Ul)))),128))]))])),_:1})]),(0,o.bF)(y,{modelValue:r.showDetail,"onUpdate:modelValue":t[1]||(t[1]=e=>r.showDetail=e),title:"反馈详情",width:"70%","close-on-click-modal":!1},{default:(0,o.k6)((()=>[r.selectedFeedback?((0,o.uX)(),(0,o.CE)("div",zl,[(0,o.bF)(v,{column:2,border:""},{default:(0,o.k6)((()=>[(0,o.bF)(b,{label:"问题标题"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.selectedFeedback.title),1)])),_:1}),(0,o.bF)(b,{label:"问题类型"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{type:r.getTypeColor(r.selectedFeedback.type)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getTypeText(r.selectedFeedback.type)),1)])),_:1},8,["type"])])),_:1}),(0,o.bF)(b,{label:"优先级"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{type:r.getPriorityColor(r.selectedFeedback.priority)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getPriorityText(r.selectedFeedback.priority)),1)])),_:1},8,["type"])])),_:1}),(0,o.bF)(b,{label:"状态"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{type:r.getStatusColor(r.selectedFeedback.status)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getStatusText(r.selectedFeedback.status)),1)])),_:1},8,["type"])])),_:1}),(0,o.bF)(b,{label:"提交时间"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.formatDateTime(r.selectedFeedback.created_at)),1)])),_:1}),(0,o.bF)(b,{label:"更新时间"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.formatDateTime(r.selectedFeedback.updated_at)),1)])),_:1})])),_:1}),(0,o.Lk)("div",Ol,[t[10]||(t[10]=(0,o.Lk)("h4",null,"问题描述",-1)),(0,o.Lk)("div",Nl,(0,i.v_)(r.selectedFeedback.description),1)]),r.selectedFeedback.admin_reply?((0,o.uX)(),(0,o.CE)("div",jl,[t[11]||(t[11]=(0,o.Lk)("h4",null,"管理员回复",-1)),(0,o.Lk)("div",Yl,(0,i.v_)(r.selectedFeedback.admin_reply),1),(0,o.Lk)("div",Hl," 回复人："+(0,i.v_)(r.selectedFeedback.admin_username||"系统管理员"),1)])):(0,o.Q3)("",!0)])):(0,o.Q3)("",!0)])),_:1},8,["modelValue"])])}var Gl={name:"FeedbackList",components:{ArrowLeft:v.nkM,Plus:v.FWt,Refresh:v.C42,Loading:v.Rhj},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)([]),l=(0,k.KR)(!1),r=(0,k.KR)(null),n=async()=>{t.value=!0;try{const e=await Po.get(_.endpoints.userFeedbacks);e.data.success?a.value=e.data.data:h.nk.error("获取反馈列表失败")}catch(e){console.error("获取反馈列表失败:",e),h.nk.error("获取反馈列表失败")}finally{t.value=!1}},i=async e=>{try{const t=await Po.get(_.endpoints.feedbackById.replace(":id",e.id));t.data.success?(r.value=t.data.data,l.value=!0):h.nk.error("获取反馈详情失败")}catch(t){console.error("获取反馈详情失败:",t),h.nk.error("获取反馈详情失败")}},d=async e=>{try{await b.s.confirm(`确定要删除反馈"${e.title}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await Po.delete(_.endpoints.feedbackById.replace(":id",e.id));t.data.success?(h.nk.success("删除成功"),n()):h.nk.error(t.data.message||"删除失败")}catch(t){"cancel"!==t&&(console.error("删除反馈失败:",t),h.nk.error("删除失败"))}},u=()=>{e.push({name:"FeedbackForm"})},c=()=>{e.back()},p=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN")},m=e=>{const t={bug:"danger",feature:"primary",improvement:"warning",other:"info"};return t[e]||"info"},g=e=>{const t={bug:"Bug",feature:"功能建议",improvement:"体验改进",other:"其他"};return t[e]||e},f=e=>{const t={low:"info",medium:"warning",high:"danger",urgent:"danger"};return t[e]||"info"},v=e=>{const t={low:"低",medium:"中",high:"高",urgent:"紧急"};return t[e]||e},y=e=>{const t={pending:"warning",processing:"primary",resolved:"success",closed:"info"};return t[e]||"info"},w=e=>{const t={pending:"待处理",processing:"处理中",resolved:"已解决",closed:"已关闭"};return t[e]||e};return(0,o.sV)((()=>{n()})),{loading:t,feedbacks:a,showDetail:l,selectedFeedback:r,fetchFeedbacks:n,viewFeedback:i,deleteFeedback:d,goToNewFeedback:u,goBack:c,formatDateTime:p,getTypeColor:m,getTypeText:g,getPriorityColor:f,getPriorityText:v,getStatusColor:y,getStatusText:w}}};const Zl=(0,W.A)(Gl,[["render",Jl],["__scopeId","data-v-7effb757"]]);var eo=Zl;const to={class:"feedback-management-container"},ao={class:"header"},lo={class:"content"},oo={class:"stats-row"},ro={class:"stat-content"},no={class:"stat-number"},so={class:"stat-content"},io={class:"stat-number"},uo={class:"stat-content"},co={class:"stat-number"},po={class:"stat-content"},mo={class:"stat-number"},go={class:"card-header"},fo={class:"filter-form-container"},ko={class:"card-header"},ho={key:0,style:{"text-align":"center",padding:"50px"}},bo={key:0,class:"feedback-detail"},vo={class:"description-section"},yo={class:"description-content"},wo={key:0,class:"reply-section"},_o={class:"reply-content"},Fo={class:"reply-meta"},xo={class:"dialog-footer"};function Lo(e,t,a,r,n,s){const d=(0,o.g2)("arrow-left"),u=(0,o.g2)("el-icon"),c=(0,o.g2)("el-card"),p=(0,o.g2)("arrow-up"),m=(0,o.g2)("arrow-down"),g=(0,o.g2)("el-button"),f=(0,o.g2)("el-option"),k=(0,o.g2)("el-select"),h=(0,o.g2)("el-form-item"),b=(0,o.g2)("el-col"),v=(0,o.g2)("el-row"),y=(0,o.g2)("el-form"),w=(0,o.g2)("el-collapse-transition"),_=(0,o.g2)("refresh"),F=(0,o.g2)("loading"),x=(0,o.g2)("el-table-column"),L=(0,o.g2)("el-tag"),C=(0,o.g2)("el-table"),I=(0,o.g2)("el-descriptions-item"),R=(0,o.g2)("el-descriptions"),W=(0,o.g2)("el-dialog"),V=(0,o.g2)("el-input");return(0,o.uX)(),(0,o.CE)("div",to,[(0,o.Lk)("div",ao,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(d)])),_:1}),t[10]||(t[10]=(0,o.eW)(" 返回 "))]),t[11]||(t[11]=(0,o.Lk)("h1",null,"问题反馈管理",-1)),t[12]||(t[12]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",lo,[(0,o.Lk)("div",oo,[(0,o.bF)(c,{class:"stat-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",ro,[(0,o.Lk)("div",no,(0,i.v_)(r.stats.total||0),1),t[13]||(t[13]=(0,o.Lk)("div",{class:"stat-label"},"总数",-1))])])),_:1}),(0,o.bF)(c,{class:"stat-card pending"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",so,[(0,o.Lk)("div",io,(0,i.v_)(r.stats.pending||0),1),t[14]||(t[14]=(0,o.Lk)("div",{class:"stat-label"},"待处理",-1))])])),_:1}),(0,o.bF)(c,{class:"stat-card processing"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",uo,[(0,o.Lk)("div",co,(0,i.v_)(r.stats.processing||0),1),t[15]||(t[15]=(0,o.Lk)("div",{class:"stat-label"},"处理中",-1))])])),_:1}),(0,o.bF)(c,{class:"stat-card resolved"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",po,[(0,o.Lk)("div",mo,(0,i.v_)(r.stats.resolved||0),1),t[16]||(t[16]=(0,o.Lk)("div",{class:"stat-label"},"已解决",-1))])])),_:1})]),(0,o.bF)(c,{class:"filter-card",shadow:"hover"},{header:(0,o.k6)((()=>[(0,o.Lk)("div",go,[t[17]||(t[17]=(0,o.Lk)("span",null,"筛选条件",-1)),(0,o.bF)(g,{link:"",type:"primary",onClick:t[1]||(t[1]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,o.k6)((()=>[r.showFilterPanel?((0,o.uX)(),(0,o.Wv)(u,{key:0},{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1})):((0,o.uX)(),(0,o.Wv)(u,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(m)])),_:1})),(0,o.eW)(" "+(0,i.v_)(r.showFilterPanel?"收起":"展开"),1)])),_:1})])])),default:(0,o.k6)((()=>[(0,o.bF)(w,null,{default:(0,o.k6)((()=>[(0,o.bo)((0,o.Lk)("div",fo,[(0,o.bF)(y,{model:r.filterForm,class:"filter-form","label-width":"80px"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{gutter:20},{default:(0,o.k6)((()=>[r.isSystemAdmin?((0,o.uX)(),(0,o.Wv)(b,{key:0,span:6},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"公司"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{modelValue:r.filterForm.company_id,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.company_id=e),placeholder:"请选择公司",clearable:""},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"全部公司",value:null}),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.companies,(e=>((0,o.uX)(),(0,o.Wv)(f,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})):(0,o.Q3)("",!0),(0,o.bF)(b,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"状态"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{modelValue:r.filterForm.status,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.status=e),placeholder:"请选择状态",clearable:""},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"全部状态",value:null}),(0,o.bF)(f,{label:"待处理",value:"pending"}),(0,o.bF)(f,{label:"处理中",value:"processing"}),(0,o.bF)(f,{label:"已解决",value:"resolved"}),(0,o.bF)(f,{label:"已关闭",value:"closed"})])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(b,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"类型"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{modelValue:r.filterForm.type,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.type=e),placeholder:"请选择类型",clearable:""},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"全部类型",value:null}),(0,o.bF)(f,{label:"系统Bug",value:"bug"}),(0,o.bF)(f,{label:"功能建议",value:"feature"}),(0,o.bF)(f,{label:"体验改进",value:"improvement"}),(0,o.bF)(f,{label:"其他问题",value:"other"})])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(b,{span:6},{default:(0,o.k6)((()=>[(0,o.bF)(h,null,{default:(0,o.k6)((()=>[(0,o.bF)(g,{type:"primary",onClick:r.applyFilter},{default:(0,o.k6)((()=>t[18]||(t[18]=[(0,o.eW)("筛选")]))),_:1},8,["onClick"]),(0,o.bF)(g,{onClick:r.resetFilter},{default:(0,o.k6)((()=>t[19]||(t[19]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model"])],512),[[l.aG,r.showFilterPanel]])])),_:1})])),_:1}),(0,o.bF)(c,{class:"feedback-card",shadow:"hover"},{header:(0,o.k6)((()=>[(0,o.Lk)("div",ko,[(0,o.Lk)("span",null,"问题反馈列表 (共"+(0,i.v_)(r.filteredFeedbacks.length)+"条)",1),(0,o.bF)(g,{onClick:r.fetchFeedbacks},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(_)])),_:1}),t[20]||(t[20]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"])])])),default:(0,o.k6)((()=>[r.loading?((0,o.uX)(),(0,o.CE)("div",ho,[(0,o.bF)(u,{class:"is-loading"},{default:(0,o.k6)((()=>[(0,o.bF)(F)])),_:1}),t[21]||(t[21]=(0,o.Lk)("p",null,"加载中...",-1))])):((0,o.uX)(),(0,o.Wv)(C,{key:1,data:r.filteredFeedbacks,stripe:"",style:{width:"100%"},onRowClick:r.viewFeedback},{default:(0,o.k6)((()=>[(0,o.bF)(x,{prop:"id",label:"ID",width:"80"}),(0,o.bF)(x,{prop:"title",label:"问题标题","min-width":"200","show-overflow-tooltip":""}),r.isSystemAdmin?((0,o.uX)(),(0,o.Wv)(x,{key:0,prop:"company_name",label:"公司",width:"120"})):(0,o.Q3)("",!0),(0,o.bF)(x,{prop:"username",label:"提交人",width:"120"}),(0,o.bF)(x,{label:"类型",width:"100"},{default:(0,o.k6)((e=>[(0,o.bF)(L,{type:r.getTypeColor(e.row.type)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getTypeText(e.row.type)),1)])),_:2},1032,["type"])])),_:1}),(0,o.bF)(x,{label:"优先级",width:"100"},{default:(0,o.k6)((e=>[(0,o.bF)(L,{type:r.getPriorityColor(e.row.priority)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getPriorityText(e.row.priority)),1)])),_:2},1032,["type"])])),_:1}),(0,o.bF)(x,{label:"状态",width:"100"},{default:(0,o.k6)((e=>[(0,o.bF)(L,{type:r.getStatusColor(e.row.status)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getStatusText(e.row.status)),1)])),_:2},1032,["type"])])),_:1}),(0,o.bF)(x,{prop:"created_at",label:"提交时间",width:"160"},{default:(0,o.k6)((e=>[(0,o.eW)((0,i.v_)(r.formatDateTime(e.row.created_at)),1)])),_:1}),(0,o.bF)(x,{label:"操作",width:"180",fixed:"right"},{default:(0,o.k6)((e=>[(0,o.bF)(g,{size:"small",onClick:(0,l.D$)((t=>r.viewFeedback(e.row)),["stop"])},{default:(0,o.k6)((()=>t[22]||(t[22]=[(0,o.eW)("查看")]))),_:2},1032,["onClick"]),"closed"!==e.row.status?((0,o.uX)(),(0,o.Wv)(g,{key:0,size:"small",type:"primary",onClick:(0,l.D$)((t=>r.handleFeedback(e.row)),["stop"])},{default:(0,o.k6)((()=>t[23]||(t[23]=[(0,o.eW)("处理")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0),(0,o.bF)(g,{size:"small",type:"danger",onClick:(0,l.D$)((t=>r.deleteFeedback(e.row)),["stop"])},{default:(0,o.k6)((()=>t[24]||(t[24]=[(0,o.eW)("删除")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data","onRowClick"]))])),_:1})]),(0,o.bF)(W,{modelValue:r.showDetail,"onUpdate:modelValue":t[5]||(t[5]=e=>r.showDetail=e),title:"反馈详情",width:"70%","close-on-click-modal":!1},{default:(0,o.k6)((()=>[r.selectedFeedback?((0,o.uX)(),(0,o.CE)("div",bo,[(0,o.bF)(R,{column:2,border:""},{default:(0,o.k6)((()=>[(0,o.bF)(I,{label:"问题标题"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.selectedFeedback.title),1)])),_:1}),(0,o.bF)(I,{label:"提交人"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.selectedFeedback.username)+" ("+(0,i.v_)(r.selectedFeedback.phone)+")",1)])),_:1}),r.isSystemAdmin?((0,o.uX)(),(0,o.Wv)(I,{key:0,label:"公司"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.selectedFeedback.company_name),1)])),_:1})):(0,o.Q3)("",!0),(0,o.bF)(I,{label:"问题类型"},{default:(0,o.k6)((()=>[(0,o.bF)(L,{type:r.getTypeColor(r.selectedFeedback.type)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getTypeText(r.selectedFeedback.type)),1)])),_:1},8,["type"])])),_:1}),(0,o.bF)(I,{label:"优先级"},{default:(0,o.k6)((()=>[(0,o.bF)(L,{type:r.getPriorityColor(r.selectedFeedback.priority)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getPriorityText(r.selectedFeedback.priority)),1)])),_:1},8,["type"])])),_:1}),(0,o.bF)(I,{label:"状态"},{default:(0,o.k6)((()=>[(0,o.bF)(L,{type:r.getStatusColor(r.selectedFeedback.status)},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.getStatusText(r.selectedFeedback.status)),1)])),_:1},8,["type"])])),_:1}),(0,o.bF)(I,{label:"提交时间"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.formatDateTime(r.selectedFeedback.created_at)),1)])),_:1}),(0,o.bF)(I,{label:"更新时间"},{default:(0,o.k6)((()=>[(0,o.eW)((0,i.v_)(r.formatDateTime(r.selectedFeedback.updated_at)),1)])),_:1})])),_:1}),(0,o.Lk)("div",vo,[t[25]||(t[25]=(0,o.Lk)("h4",null,"问题描述",-1)),(0,o.Lk)("div",yo,(0,i.v_)(r.selectedFeedback.description),1)]),r.selectedFeedback.admin_reply?((0,o.uX)(),(0,o.CE)("div",wo,[t[26]||(t[26]=(0,o.Lk)("h4",null,"管理员回复",-1)),(0,o.Lk)("div",_o,(0,i.v_)(r.selectedFeedback.admin_reply),1),(0,o.Lk)("div",Fo," 回复人："+(0,i.v_)(r.selectedFeedback.admin_username||"系统管理员"),1)])):(0,o.Q3)("",!0)])):(0,o.Q3)("",!0)])),_:1},8,["modelValue"]),(0,o.bF)(W,{modelValue:r.showHandle,"onUpdate:modelValue":t[9]||(t[9]=e=>r.showHandle=e),title:"处理反馈",width:"50%","close-on-click-modal":!1},{footer:(0,o.k6)((()=>[(0,o.Lk)("span",xo,[(0,o.bF)(g,{onClick:t[8]||(t[8]=e=>r.showHandle=!1)},{default:(0,o.k6)((()=>t[27]||(t[27]=[(0,o.eW)("取消")]))),_:1}),(0,o.bF)(g,{type:"primary",onClick:r.submitHandle,loading:r.handleLoading},{default:(0,o.k6)((()=>t[28]||(t[28]=[(0,o.eW)("提交")]))),_:1},8,["onClick","loading"])])])),default:(0,o.k6)((()=>[(0,o.bF)(y,{model:r.handleForm,"label-width":"80px"},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"状态"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{modelValue:r.handleForm.status,"onUpdate:modelValue":t[6]||(t[6]=e=>r.handleForm.status=e),placeholder:"请选择状态",style:{width:"100%"}},{default:(0,o.k6)((()=>[(0,o.bF)(f,{label:"处理中",value:"processing"}),(0,o.bF)(f,{label:"已解决",value:"resolved"}),(0,o.bF)(f,{label:"已关闭",value:"closed"})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(h,{label:"回复内容"},{default:(0,o.k6)((()=>[(0,o.bF)(V,{modelValue:r.handleForm.admin_reply,"onUpdate:modelValue":t[7]||(t[7]=e=>r.handleForm.admin_reply=e),type:"textarea",rows:4,placeholder:"请输入处理结果或回复内容"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}var Co={name:"FeedbackManagement",components:{ArrowLeft:v.nkM,ArrowUp:v.DoI,ArrowDown:v.yd$,Refresh:v.C42,Loading:v.Rhj},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)(!1),l=(0,k.KR)([]),r=(0,k.KR)([]),n=(0,k.KR)({}),i=(0,k.KR)(!0),d=(0,k.KR)(!1),u=(0,k.KR)(!1),c=(0,k.KR)(null),p=(0,k.Kh)({company_id:null,status:null,type:null}),m=(0,k.Kh)({status:"",admin_reply:""}),g=(0,o.EW)((()=>5===Ho.state.user?.role_id)),f=(0,o.EW)((()=>l.value.filter((e=>(!p.company_id||e.company_id===p.company_id)&&((!p.status||e.status===p.status)&&(!p.type||e.type===p.type)))))),v=async()=>{if(g.value)try{const e=await Po.get(_.endpoints.companies);e.data.success&&(r.value=e.data.data)}catch(e){console.error("获取公司列表失败:",e)}},y=async()=>{t.value=!0;try{const e={};p.company_id&&(e.company_id=p.company_id),p.status&&(e.status=p.status),p.type&&(e.type=p.type);const t=await Po.get(_.endpoints.adminFeedbacks,e);t.data.success?l.value=t.data.data:h.nk.error("获取反馈列表失败")}catch(e){console.error("获取反馈列表失败:",e),h.nk.error("获取反馈列表失败")}finally{t.value=!1}},w=async()=>{try{const e={};p.company_id&&(e.company_id=p.company_id);const t=await Po.get(_.endpoints.feedbackStats,e);t.data.success&&(n.value=t.data.data)}catch(e){console.error("获取统计数据失败:",e)}},F=async()=>{await Promise.all([y(),w()]),h.nk.success("筛选已应用")},x=async()=>{p.company_id=null,p.status=null,p.type=null,await Promise.all([y(),w()]),h.nk.info("筛选条件已重置")},L=async e=>{try{const t=await Po.get(_.endpoints.feedbackById.replace(":id",e.id));t.data.success?(c.value=t.data.data,d.value=!0):h.nk.error("获取反馈详情失败")}catch(t){console.error("获取反馈详情失败:",t),h.nk.error("获取反馈详情失败")}},C=e=>{c.value=e,m.status="pending"===e.status?"processing":e.status,m.admin_reply=e.admin_reply||"",u.value=!0},I=async()=>{if(m.status){a.value=!0;try{const e=await Po.put(_.endpoints.feedbackStatus.replace(":id",c.value.id),{status:m.status,admin_reply:m.admin_reply});e.data.success?(h.nk.success("处理成功"),u.value=!1,await Promise.all([y(),w()])):h.nk.error(e.data.message||"处理失败")}catch(e){console.error("处理反馈失败:",e),h.nk.error("处理失败")}finally{a.value=!1}}else h.nk.error("请选择状态")},R=async e=>{try{await b.s.confirm(`确定要删除反馈"${e.title}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await Po.delete(_.endpoints.feedbackById.replace(":id",e.id));t.data.success?(h.nk.success("删除成功"),await Promise.all([y(),w()])):h.nk.error(t.data.message||"删除失败")}catch(t){"cancel"!==t&&(console.error("删除反馈失败:",t),h.nk.error("删除失败"))}},W=()=>{e.back()},V=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN")},$=e=>{const t={bug:"danger",feature:"primary",improvement:"warning",other:"info"};return t[e]||"info"},T=e=>{const t={bug:"Bug",feature:"功能建议",improvement:"体验改进",other:"其他"};return t[e]||e},S=e=>{const t={low:"info",medium:"warning",high:"danger",urgent:"danger"};return t[e]||"info"},P=e=>{const t={low:"低",medium:"中",high:"高",urgent:"紧急"};return t[e]||e},K=e=>{const t={pending:"warning",processing:"primary",resolved:"success",closed:"info"};return t[e]||"info"},E=e=>{const t={pending:"待处理",processing:"处理中",resolved:"已解决",closed:"已关闭"};return t[e]||e};return(0,o.sV)((async()=>{await v(),await Promise.all([y(),w()])})),{loading:t,handleLoading:a,feedbacks:l,companies:r,stats:n,showFilterPanel:i,showDetail:d,showHandle:u,selectedFeedback:c,filterForm:p,handleForm:m,isSystemAdmin:g,filteredFeedbacks:f,fetchFeedbacks:y,fetchStats:w,applyFilter:F,resetFilter:x,viewFeedback:L,handleFeedback:C,submitHandle:I,deleteFeedback:R,goBack:W,formatDateTime:V,getTypeColor:$,getTypeText:T,getPriorityColor:S,getPriorityText:P,getStatusColor:K,getStatusText:E}}};const Io=(0,W.A)(Co,[["render",Lo],["__scopeId","data-v-41ed3348"]]);var Ro=Io;const Wo=[{path:"/login",name:"Login",component:Be,meta:{requiresAuth:!1}},{path:"/user-management",name:"UserManagement",component:ft,meta:{requiresAuth:!0,requiresManager:!0}},{path:"/profile",name:"UserProfile",component:ea,meta:{requiresAuth:!0}},{path:"/operation-logs",name:"OperationLogs",component:Ra,meta:{requiresAuth:!0,requiresLogPermission:!0}},{path:"/companies",name:"CompanyManagement",component:Na,meta:{requiresAuth:!0,requiresSystemAdmin:!0}},{path:"/",name:"Home",component:$,meta:{requiresAuth:!0}},{path:"/units",name:"UnitSelection",component:$,meta:{requiresAuth:!0}},{path:"/admin-records",name:"AdminRecords",component:Nt,meta:{requiresAuth:!0,requiresCompanyAdmin:!0}},{path:"/super-admin-records",name:"SuperAdminRecords",component:wl,meta:{requiresAuth:!0,requiresSystemAdmin:!0}},{path:"/record/new",name:"NewRecord",component:lt,props:{id:null},meta:{requiresAuth:!0}},{path:"/record/:id",name:"EditRecord",component:lt,props:!0,meta:{requiresAuth:!0}},{path:"/unit/:id",name:"WasteForm",component:N,props:!0,meta:{requiresAuth:!0}},{path:"/records/:unitId",name:"RecordsList",component:Ee,props:!0,meta:{requiresAuth:!0}},{path:"/feedback/new",name:"FeedbackForm",component:Rl,meta:{requiresAuth:!0}},{path:"/feedback/list",name:"FeedbackList",component:eo,meta:{requiresAuth:!0}},{path:"/feedback/management",name:"FeedbackManagement",component:Ro,meta:{requiresAuth:!0,requiresManager:!0}}],Vo=(0,s.aE)({history:(0,s.LA)("/"),routes:Wo});Vo.beforeEach(((e,t,a)=>{const l=e.matched.some((e=>e.meta.requiresAuth)),o=e.matched.some((e=>e.meta.requiresSuperAdmin)),r=e.matched.some((e=>e.meta.requiresSystemAdmin)),n=e.matched.some((e=>e.meta.requiresCompanyAdmin)),s=e.matched.some((e=>e.meta.requiresManager)),i=e.matched.some((e=>e.meta.requiresLogPermission));if(!l||Ho.state.isLoggedIn)if(i&&Ho.state.isLoggedIn&&1!==Ho.state.user.can_view_logs)5===Ho.state.user.role_id?a({name:"SuperAdminRecords"}):3===Ho.state.user.role_id?a({name:"AdminRecords"}):4===Ho.state.user.role_id?a({name:"NewRecord"}):Ho.state.user.unit_id?a({name:"WasteForm",params:{id:Ho.state.user.unit_id}}):a({name:"UnitSelection"});else{if(o&&Ho.state.isLoggedIn){if(5===Ho.state.user.role_id)return void a({name:"SuperAdminRecords"});if(3!==Ho.state.user.role_id&&4!==Ho.state.user.role_id)return void(Ho.state.user.unit_id?a({name:"WasteForm",params:{id:Ho.state.user.unit_id}}):a({name:"UnitSelection"}))}if(r&&Ho.state.isLoggedIn&&5!==Ho.state.user.role_id)3===Ho.state.user.role_id?a({name:"AdminRecords"}):4===Ho.state.user.role_id?a({name:"NewRecord"}):Ho.state.user.unit_id?a({name:"WasteForm",params:{id:Ho.state.user.unit_id}}):a({name:"UnitSelection"});else if(n&&Ho.state.isLoggedIn&&3!==Ho.state.user.role_id&&4!==Ho.state.user.role_id)5===Ho.state.user.role_id?a({name:"SuperAdminRecords"}):Ho.state.user.unit_id?a({name:"WasteForm",params:{id:Ho.state.user.unit_id}}):a({name:"UnitSelection"});else{if(s&&Ho.state.isLoggedIn)if(5===Ho.state.user.role_id||3===Ho.state.user.role_id||2===Ho.state.user.role_id);else{if(4===Ho.state.user.role_id)return void a({name:"NewRecord"});if(1===Ho.state.user.role_id)return void(Ho.state.user.unit_id?a({name:"WasteForm",params:{id:Ho.state.user.unit_id}}):a({name:"UnitSelection"}))}if("Login"===e.name&&Ho.state.isLoggedIn)5===Ho.state.user.role_id?a({name:"SuperAdminRecords"}):3===Ho.state.user.role_id?a({name:"AdminRecords"}):4===Ho.state.user.role_id?a({name:"NewRecord"}):(Ho.state.user.role_id,Ho.state.user.unit_id?a({name:"WasteForm",params:{id:Ho.state.user.unit_id}}):a({name:"UnitSelection"}));else{if(("/"===e.path||"Home"===e.name)&&Ho.state.isLoggedIn)return 5===Ho.state.user.role_id?void a({name:"SuperAdminRecords"}):3===Ho.state.user.role_id?void a({name:"AdminRecords"}):4===Ho.state.user.role_id?void a({name:"NewRecord"}):2===Ho.state.user.role_id||1===Ho.state.user.role_id?void(Ho.state.user.unit_id?a({name:"WasteForm",params:{id:Ho.state.user.unit_id}}):a({name:"UnitSelection"})):void a({name:"UnitSelection"});if("WasteForm"===e.name&&Ho.state.isLoggedIn){if(5===Ho.state.user.role_id)return void a({name:"SuperAdminRecords"});if(3===Ho.state.user.role_id||4===Ho.state.user.role_id);else if((1===Ho.state.user.role_id||2===Ho.state.user.role_id)&&Ho.state.user.unit_id&&Ho.state.user.unit_id!==parseInt(e.params.id))return void a({name:"WasteForm",params:{id:Ho.state.user.unit_id}})}"UnitSelection"===e.name&&Ho.state.isLoggedIn&&5===Ho.state.user.role_id?a({name:"SuperAdminRecords"}):a()}}}else a({name:"Login"})}));var $o=Vo;const To=y.A.create({baseURL:_.baseURL,timeout:3e5,headers:{"Content-Type":"application/json"},maxContentLength:52428800,maxBodyLength:52428800});To.interceptors.request.use((e=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return t&&(e.headers.Authorization=`Bearer ${t}`),e}),(e=>(console.error("Request error:",e),Promise.reject(e)))),To.interceptors.response.use((e=>e),(e=>{if(e.response)switch(e.response.status){case 401:if(e.config.url.includes("/api/login"))return Promise.reject(e);Ho.logout(),h.nk.error("登录已过期，请重新登录"),$o.push("/login");break;case 403:h.nk.error("没有权限访问该资源");break;case 404:h.nk.error("请求的资源不存在");break;case 500:h.nk.error("服务器错误，请稍后重试");break;default:h.nk.error(e.response.data?.error||"请求失败")}else e.request?h.nk.error("网络错误，请检查网络连接"):h.nk.error("请求配置错误");return Promise.reject(e)}));const So={get(e,t={}){return To.get(e,{params:t})},post(e,t={}){return To.post(e,t)},postForm(e,t,a){const l={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};"function"===typeof a&&(l.onUploadProgress=a);const o=localStorage.getItem("token")||sessionStorage.getItem("token");return o&&(l.headers.Authorization=`Bearer ${o}`),To.post(e,t,l)},put(e,t={}){return To.put(e,t)},putForm(e,t,a){const l={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};"function"===typeof a&&(l.onUploadProgress=a);const o=localStorage.getItem("token")||sessionStorage.getItem("token");return o&&(l.headers.Authorization=`Bearer ${o}`),To.put(e,t,l)},delete(e){return To.delete(e)},defaults:To.defaults};var Po=So;const Ko={user:null,token:null,isLoggedIn:!1,loading:!1,error:null},Eo=(0,k.Kh)({...Ko}),Uo=()=>{let e=localStorage.getItem("user"),t=localStorage.getItem("token");if(e&&t||(e=sessionStorage.getItem("user"),t=sessionStorage.getItem("token")),e&&t)try{const a=JSON.parse(e);Eo.user=a,Eo.token=t,Eo.isLoggedIn=!0,Po.defaults&&Po.defaults.headers&&(Po.defaults.headers.common["Authorization"]=`Bearer ${t}`),console.log("成功恢复用户状态:",a.username||a.phone,"角色ID:",a.role_id)}catch(a){console.error("Error parsing saved user data:",a),localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")}else console.log("未找到保存的用户状态")},Ao=async(e,t,a=!1)=>{Eo.loading=!0,Eo.error=null,console.log("auth.login 开始执行，手机号:",e);try{const o={phone:e,rememberMe:a};null!==t&&void 0!==t&&""!==t?(o.password=t,console.log("auth.login 发送密码参数")):console.log("auth.login 不发送密码参数"),console.log("发送登录请求，数据:",o);const r=await Po.post(_.endpoints.login,o);console.log("登录请求成功响应:",r.data);const{token:n,...s}=r.data;Eo.user=s,Eo.token=n,Eo.isLoggedIn=!0,Po.defaults&&Po.defaults.headers&&(Po.defaults.headers.common["Authorization"]=`Bearer ${n}`),a?(localStorage.setItem("user",JSON.stringify(s)),localStorage.setItem("token",n)):(sessionStorage.setItem("user",JSON.stringify(s)),sessionStorage.setItem("token",n),localStorage.removeItem("user"),localStorage.removeItem("token"));try{"caches"in window&&caches.keys().then((e=>{e.forEach((e=>{caches.delete(e)}))}))}catch(l){console.warn("清除缓存失败:",l)}return{success:!0,user:s}}catch(o){return Eo.error=o.response?.data?.error||"登录失败，请检查网络连接",console.error("Login error:",o),{success:!1,error:Eo.error}}finally{Eo.loading=!1}},Do=()=>{Eo.user=null,Eo.token=null,Eo.isLoggedIn=!1,Po.defaults&&Po.defaults.headers&&delete Po.defaults.headers.common["Authorization"],localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")},Xo=()=>Eo.isLoggedIn&&Eo.user&&5===Eo.user.role_id,Qo=()=>Eo.isLoggedIn&&Eo.user&&3===Eo.user.role_id,Mo=()=>Eo.isLoggedIn&&Eo.user&&(3===Eo.user.role_id||4===Eo.user.role_id||5===Eo.user.role_id),Bo=()=>Eo.isLoggedIn&&Eo.user&&2===Eo.user.role_id,qo=()=>Eo.isLoggedIn&&Eo.user&&4===Eo.user.role_id,zo=()=>Eo.user?Eo.user.id:null,Oo=()=>Eo.user?Eo.user.unit_id:null,No=()=>Eo.user?Eo.user.company_id:null,jo=()=>Eo.user?Eo.user.company_name:null,Yo=e=>{Eo.isLoggedIn&&Eo.user&&(Eo.user={...Eo.user,...e},localStorage.getItem("user")&&localStorage.setItem("user",JSON.stringify(Eo.user)),sessionStorage.getItem("user")&&sessionStorage.setItem("user",JSON.stringify(Eo.user)))};Uo();var Ho={state:Eo,login:Ao,logout:Do,isSystemAdmin:Xo,isCompanyAdmin:Qo,isAdmin:Mo,isUnitAdmin:Bo,isSupervisor:qo,getUserId:zo,getUnitId:Oo,getCompanyId:No,getCompanyName:jo,updateUserInfo:Yo},Jo={name:"AppHeader",components:{ChatLineRound:v.Fv_},setup(){const e=(0,s.rd)(),t=(0,k.KR)(null),a=(0,k.KR)(!1),l=(0,k.KR)(!1),r=(0,o.EW)((()=>Ho.state.isLoggedIn?Ho.state.user.username||Ho.state.user.phone:"")),n=(0,k.Kh)({type:"bug",priority:"medium",title:"",description:""}),i={type:[{required:!0,message:"请选择问题类型",trigger:"change"}],priority:[{required:!0,message:"请选择优先级",trigger:"change"}],title:[{required:!0,message:"请输入问题标题",trigger:"blur"}],description:[{required:!0,message:"请输入问题描述",trigger:"blur"}]},d=()=>{Ho.logout(),h.nk.success("已退出登录"),e.push("/login")},u=()=>{e.push("/profile")},c=()=>{l.value=!0},p=()=>{n.title||n.description?b.s.confirm("您有未保存的内容，确定要离开吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{l.value=!1,g()})):(l.value=!1,g())},m=async()=>{try{const e=await t.value.validate();if(!e)return;a.value=!0;const o={type:n.type,priority:n.priority,title:n.title,description:n.description},r=await Po.post(_.endpoints.feedback,o);r.data.success?(h.nk.success("问题反馈提交成功！"),l.value=!1,g()):h.nk.error(r.data.message||"提交失败")}catch(e){console.error("提交问题反馈失败:",e),h.nk.error("提交失败，请重试")}finally{a.value=!1}},g=()=>{t.value&&t.value.resetFields(),n.type="bug",n.priority="medium",n.title="",n.description=""};return{auth:Ho,userName:r,handleLogout:d,goToProfile:u,feedbackVisible:l,formRef:t,loading:a,form:n,rules:i,showFeedbackDialog:c,closeFeedbackDialog:p,submitForm:m,resetForm:g}}};const Go=(0,W.A)(Jo,[["render",f],["__scopeId","data-v-5cf04759"]]);var Zo=Go,er={components:{AppHeader:Zo},setup(){const e=(0,s.lq)(),t=(0,o.EW)((()=>"/login"!==e.path)),a="1.0.1",l="app_version";return(0,o.sV)((()=>{const e=localStorage.getItem(l);e&&e!==a?b.s.confirm("应用有新的更新，需要刷新页面以获取最新功能。","版本更新",{confirmButtonText:"立即刷新",cancelButtonText:"稍后再说",type:"warning"}).then((()=>{localStorage.setItem(l,a),window.location.reload(!0)})).catch((()=>{localStorage.setItem(l,a)})):localStorage.setItem(l,a)})),{showHeader:t}}};const tr=(0,W.A)(er,[["render",n]]);var ar=tr,lr=a(6070),or=(a(4188),a(5186));const rr=(0,l.Ef)(ar);rr.use($o),rr.use(lr.A,{locale:or.A}),rr.mount("#app")}},t={};function a(l){var o=t[l];if(void 0!==o)return o.exports;var r=t[l]={exports:{}};return e[l].call(r.exports,r,r.exports,a),r.exports}a.m=e,function(){var e=[];a.O=function(t,l,o,r){if(!l){var n=1/0;for(u=0;u<e.length;u++){l=e[u][0],o=e[u][1],r=e[u][2];for(var s=!0,i=0;i<l.length;i++)(!1&r||n>=r)&&Object.keys(a.O).every((function(e){return a.O[e](l[i])}))?l.splice(i--,1):(s=!1,r<n&&(n=r));if(s){e.splice(u--,1);var d=o();void 0!==d&&(t=d)}}return t}r=r||0;for(var u=e.length;u>0&&e[u-1][2]>r;u--)e[u]=e[u-1];e[u]=[l,o,r]}}(),function(){a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,{a:t}),t}}(),function(){a.d=function(e,t){for(var l in t)a.o(t,l)&&!a.o(e,l)&&Object.defineProperty(e,l,{enumerable:!0,get:t[l]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};a.O.j=function(t){return 0===e[t]};var t=function(t,l){var o,r,n=l[0],s=l[1],i=l[2],d=0;if(n.some((function(t){return 0!==e[t]}))){for(o in s)a.o(s,o)&&(a.m[o]=s[o]);if(i)var u=i(a)}for(t&&t(l);d<n.length;d++)r=n[d],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return a.O(u)},l=self["webpackChunkhazardous_waste_management_frontend"]=self["webpackChunkhazardous_waste_management_frontend"]||[];l.forEach(t.bind(null,0)),l.push=t.bind(null,l.push.bind(l))}();var l=a.O(void 0,[504],(function(){return a(6638)}));l=a.O(l)})();
//# sourceMappingURL=app.35a7a968.js.map