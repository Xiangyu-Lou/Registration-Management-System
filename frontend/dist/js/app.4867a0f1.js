(function(){"use strict";var e={632:function(e,t,a){var o=a(5130),l=a(6768);const r={id:"app"};function n(e,t,a,o,n,s){const i=(0,l.g2)("app-header"),d=(0,l.g2)("router-view");return(0,l.uX)(),(0,l.CE)("div",r,[o.showHeader?((0,l.uX)(),(0,l.Wv)(i,{key:0})):(0,l.Q3)("",!0),(0,l.bF)(d)])}var s=a(1387),i=a(4232);const d={class:"app-header"},u={key:0,class:"user-info"},c={class:"welcome-text"},p={key:0,class:"unit-tag"};function m(e,t,a,o,r,n){const s=(0,l.g2)("user"),m=(0,l.g2)("el-icon"),g=(0,l.g2)("el-button");return(0,l.uX)(),(0,l.CE)("div",d,[t[3]||(t[3]=(0,l.Lk)("div",{class:"logo"},[(0,l.Lk)("h1",null,"固体废物管理系统")],-1)),o.auth.state.isLoggedIn?((0,l.uX)(),(0,l.CE)("div",u,[(0,l.Lk)("span",c,[t[0]||(t[0]=(0,l.eW)(" 欢迎, ")),(0,l.Lk)("strong",null,(0,i.v_)(o.userName),1),o.auth.state.user.unit_name?((0,l.uX)(),(0,l.CE)("span",p,(0,i.v_)(o.auth.state.user.unit_name),1)):(0,l.Q3)("",!0)]),(0,l.bF)(g,{type:"text",class:"profile-button",onClick:o.goToProfile},{default:(0,l.k6)((()=>[(0,l.bF)(m,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[1]||(t[1]=(0,l.eW)(" 账号设置 "))])),_:1},8,["onClick"]),(0,l.bF)(g,{type:"text",class:"logout-button",onClick:o.handleLogout},{default:(0,l.k6)((()=>t[2]||(t[2]=[(0,l.eW)(" 退出登录 ")]))),_:1},8,["onClick"])])):(0,l.Q3)("",!0)])}var g=a(1219),f=a(144),h=a(4373);const v="";var w={baseURL:v,endpoints:{login:"/api/login",users:"/api/users",userStatus:"/api/users/:id/status",userProfile:"/api/users/:id/profile",units:"/api/units",wasteTypes:"/api/waste-types",locations:"/api/locations",locationsByUnit:"/api/locations",wasteRecords:"/api/waste-records",wasteRecordsByUnit:"/api/waste-records",wasteRecordDetail:"/api/waste-records/detail",wasteRecordsByUser:"/api/waste-records/user",exportWasteRecords:"/api/waste-records/export/user"},getUrl(e){return`${this.baseURL}${e}`}};const b={class:"unit-selection-container"},k={class:"content"},y={class:"units-grid"},_={class:"unit-name"};function F(e,t,a,o,r,n){const s=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",b,[t[1]||(t[1]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"固体废物管理系统")],-1)),(0,l.Lk)("div",k,[t[0]||(t[0]=(0,l.Lk)("h2",null,"请选择您的单位",-1)),(0,l.Lk)("div",y,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(s,{key:e.id,class:"unit-card",shadow:"hover",onClick:t=>n.selectUnit(e)},{default:(0,l.k6)((()=>[(0,l.Lk)("div",_,(0,i.v_)(e.name),1)])),_:2},1032,["onClick"])))),128))])]),t[2]||(t[2]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var I={name:"UnitSelection",data(){return{units:[],loading:!1}},created(){this.fetchUnits()},methods:{async fetchUnits(){this.loading=!0;try{console.log("正在获取单位列表...");const e=await h.A.get(w.getUrl(w.endpoints.units));console.log("获取单位列表成功:",e.data),this.units=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}finally{this.loading=!1}},selectUnit(e){this.$router.push({name:"WasteForm",params:{id:e.id}})}}},x=a(1241);const L=(0,x.A)(I,[["render",F],["__scopeId","data-v-249742c5"]]);var R=L;const C={class:"waste-form-container"},T={class:"header"},V={key:1},U={class:"content"},K={class:"unit-info"},W={class:"form-row"},P={key:0,class:"upload-warning"},$={class:"form-actions"},E={class:"upload-progress"},S={class:"upload-status"};function A(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("document"),c=(0,l.g2)("el-option"),p=(0,l.g2)("el-select"),m=(0,l.g2)("el-form-item"),g=(0,l.g2)("el-input"),f=(0,l.g2)("el-date-picker"),h=(0,l.g2)("clock"),v=(0,l.g2)("el-time-picker"),w=(0,l.g2)("el-input-number"),b=(0,l.g2)("el-alert"),k=(0,l.g2)("plus"),y=(0,l.g2)("el-upload"),_=(0,l.g2)("el-button"),F=(0,l.g2)("el-form"),I=(0,l.g2)("el-progress"),x=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",C,[(0,l.Lk)("div",T,[o.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 返回 "))])):((0,l.uX)(),(0,l.CE)("div",V)),t[13]||(t[13]=(0,l.Lk)("h1",null,"固体废物填报",-1)),(0,l.Lk)("div",{class:"view-records",onClick:t[1]||(t[1]=(...e)=>o.viewRecords&&o.viewRecords(...e))},[t[12]||(t[12]=(0,l.eW)(" 查看记录 ")),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1})])]),(0,l.Lk)("div",U,[(0,l.Lk)("div",K,[(0,l.Lk)("h2",null,(0,i.v_)(o.unitName),1)]),(0,l.bF)(F,{ref:"wasteForm",model:o.form,rules:o.rules,"label-position":"top",class:"waste-form"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"产生工序",prop:"processType"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.processType,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.processType=e),placeholder:"请选择产生工序",style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(c,{label:"作业现场",value:"作业现场"}),(0,l.bF)(c,{label:"清罐清理",value:"清罐清理"}),(0,l.bF)(c,{label:"报废清理",value:"报废清理"}),(0,l.bF)(c,{label:"管线刺漏",value:"管线刺漏"}),(0,l.bF)(c,{label:"历史遗留",value:"历史遗留"}),(0,l.bF)(c,{label:"日常维护",value:"日常维护"}),(0,l.bF)(c,{label:"封井退出",value:"封井退出"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"产生地点",prop:"locationId"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.locationId,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.locationId=e),placeholder:"请选择废物产生地点",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.locations,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"备注",prop:"remarks"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:o.form.remarks,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.remarks=e),type:"textarea",rows:1,placeholder:"若选择其他产生工序或产生地点，请在此说明"},null,8,["modelValue"])])),_:1}),(0,l.Lk)("div",W,[(0,l.bF)(m,{label:"收集日期",class:"date-item"},{default:(0,l.k6)((()=>[(0,l.bF)(f,{modelValue:o.form.collectionDate,"onUpdate:modelValue":t[6]||(t[6]=e=>o.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,"popper-class":"date-picker-popup",teleported:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"收集时间",class:"time-item"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:o.form.collectionTime,"onUpdate:modelValue":t[7]||(t[7]=e=>o.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"},editable:!1,"popper-class":"time-picker-popup",teleported:!1},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1})])),_:1},8,["modelValue"])])),_:1})]),(0,l.bF)(m,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:o.form.quantity,"onUpdate:modelValue":t[8]||(t[8]=e=>o.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"},onFocus:t[9]||(t[9]=e=>o.selectAllText(e)),"input-props":{inputmode:"decimal",pattern:"[0-9]*[.,]?[0-9]*"},controls:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集前）",prop:"photo_before"},{default:(0,l.k6)((()=>[t[14]||(t[14]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),o.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",P,[(0,l.bF)(b,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoBeforeChange,"on-remove":o.handlePhotoBeforeRemove,"file-list":o.fileListBefore,limit:5,multiple:"","list-type":"picture-card","before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集后）",prop:"photo_after"},{default:(0,l.k6)((()=>[t[15]||(t[15]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoAfterChange,"on-remove":o.handlePhotoAfterRemove,"file-list":o.fileListAfter,limit:5,multiple:"","list-type":"picture-card","before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.Lk)("div",$,[(0,l.bF)(_,{type:"primary",class:"submit-btn",onClick:o.submitForm,loading:o.loading},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)("提交")]))),_:1},8,["onClick","loading"]),(0,l.bF)(_,{class:"reset-btn",onClick:o.resetForm},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model","rules"])]),(0,l.bF)(x,{modelValue:o.showUploadProgress,"onUpdate:modelValue":t[10]||(t[10]=e=>o.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",E,[t[18]||(t[18]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(I,{percentage:o.uploadPercentage,format:o.percentageFormat,status:100===o.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",S,(0,i.v_)(o.uploadStatus),1)])])),_:1},8,["modelValue"]),t[19]||(t[19]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var D=a(7477),B=a(9372),X=a.n(B),Q={name:"WasteForm",components:{ArrowLeft:D.nkM,Document:D.yoT,Plus:D.FWt,Clock:D.zD7},props:{id:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),a=(0,f.KR)(null),o=(0,f.KR)(!1),r=(0,f.KR)(""),n=(0,f.KR)([]),i=(0,f.KR)([]),d=(0,f.KR)([]),u=(0,f.KR)([]),c=(0,f.KR)([]),p=(0,f.KR)([]),m=(0,f.KR)(!1),h=(0,f.KR)(0),v=(0,f.KR)("准备上传..."),b=(0,f.KR)(!1),k=(0,l.EW)((()=>ta.state.isLoggedIn&&3===ta.state.user.role_id)),y=(0,f.Kh)({wasteTypeId:"",locationId:"",collectionDate:(new Date).toISOString().slice(0,10),collectionTime:(new Date).toTimeString().slice(0,5),quantity:void 0,photo_before:[],photo_after:[],remarks:"",processType:""}),_={wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],locationId:[{required:!0,message:"请选择废物产生地点",trigger:"change"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{const e=document.createElement("meta");e.setAttribute("name","viewport"),e.setAttribute("content","width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1"),document.head.appendChild(e);const t=document.querySelector('meta[name="viewport"]');t&&t!==e&&t.remove(),await F(),await I(),await x()})),(0,l.xo)((()=>{const e=document.querySelector('meta[name="viewport"]');e&&e.remove();const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width,initial-scale=1.0"),document.head.appendChild(t)}));const F=async()=>{try{const t=await Mt.get(w.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.id)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},I=async()=>{try{const e=await Mt.get(w.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型失败")}},x=async()=>{try{const t=await Mt.get(`${w.endpoints.locationsByUnit}/${e.id}`);i.value=t.data}catch(t){console.error("Error fetching locations:",t),g.nk.error("获取地点列表失败")}},L=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return g.nk.error("只能上传图片文件!"),!1;const o=52428800;return e.size>o?(g.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{m.value=!0,v.value="正在处理图片...",h.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(X())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){h.value=30,v.value="正在处理图片...",console.log("图片处理中...")},drew(){h.value=60,v.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),v.value="图片处理完成",h.value=100,setTimeout((()=>{m.value=!1}),500),t(l)},error(a){console.error("图片压缩失败:",a),v.value="处理失败，使用原始图片",h.value=100,setTimeout((()=>{m.value=!1}),500),t(e)}})}))},R=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){m.value=!0,v.value="正在处理图片...",h.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(X())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){h.value=30,v.value="正在处理图片...",console.log("图片处理中...")},drew(){h.value=60,v.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),v.value="图片处理完成",h.value=100,t(l)},error(a){console.error("图片压缩失败:",a),v.value="处理失败，使用原始图片",h.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=d.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?d.value[a]=t:d.value.push(t);const o=c.value.findIndex((t=>t.uid===e.uid));o>=0&&(c.value[o].processed=!0),setTimeout((()=>{m.value=!1}),500)}catch(o){console.error("处理图片时出错:",o),g.nk.warning("图片处理失败，将使用原始图片");const t=d.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?d.value[t]=e.raw:d.value.push(e.raw),m.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const a=[...d.value,...u.value];b.value=U(a),console.log("更新后的photoFilesBefore:",d.value),console.log("更新后的fileListBefore:",c.value)},C=(e,t)=>{console.log("收集前照片移除:",e),c.value=t,e.raw?d.value=d.value.filter((t=>t.name!==e.raw.name)):d.value=d.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),U([...d.value,...u.value])||(b.value=!1),console.log("更新后的photoFilesBefore:",d.value)},T=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),p.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){m.value=!0,v.value="正在处理图片...",h.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(X())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){h.value=30,v.value="正在处理图片...",console.log("图片处理中...")},drew(){h.value=60,v.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),v.value="图片处理完成",h.value=100,t(l)},error(a){console.error("图片压缩失败:",a),v.value="处理失败，使用原始图片",h.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=u.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?u.value[a]=t:u.value.push(t);const o=p.value.findIndex((t=>t.uid===e.uid));o>=0&&(p.value[o].processed=!0),setTimeout((()=>{m.value=!1}),500)}catch(o){console.error("处理图片时出错:",o),g.nk.warning("图片处理失败，将使用原始图片");const t=u.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?u.value[t]=e.raw:u.value.push(e.raw),m.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const a=[...d.value,...u.value];b.value=U(a),console.log("更新后的photoFilesAfter:",u.value),console.log("更新后的fileListAfter:",p.value)},V=(e,t)=>{console.log("收集后照片移除:",e),p.value=t,e.raw?u.value=u.value.filter((t=>t.name!==e.raw.name)):u.value=u.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),U([...d.value,...u.value])||(b.value=!1),console.log("更新后的photoFilesAfter:",u.value)},U=e=>{const t=5242880;return e.some((e=>e.size>t))},K=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);h.value=t,v.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},W=e=>100===e?"完成":`${e}%`,P=()=>{a.value&&a.value.validate((async t=>{if(t){o.value=!0;try{const t=new FormData;t.append("unitId",e.id),t.append("wasteTypeId",y.wasteTypeId),t.append("locationId",y.locationId),t.append("collectionDate",y.collectionDate),t.append("collectionTime",y.collectionTime),t.append("quantity",y.quantity),t.append("processType",y.processType),t.append("remarks",y.remarks||""),ta.state.isLoggedIn&&ta.state.user?(t.append("creator_id",ta.state.user.id),console.log("添加用户信息:",{creator_id:ta.state.user.id,user:ta.state.user})):console.log("用户未登录或用户信息不完整"),console.log("提交表单数据:",{unitId:e.id,wasteTypeId:y.wasteTypeId,locationId:y.locationId,quantity:y.quantity,remarks:y.remarks||"",photo_before:d.value?d.value.length:0,photo_after:u.value?u.value.length:0}),d.value&&d.value.length>0&&(console.log("添加收集前照片数量:",d.value.length),d.value.forEach(((e,a)=>{e&&(console.log(`收集前照片 ${a+1}:`,e.name),t.append("photo_before",e))}))),u.value&&u.value.length>0&&(console.log("添加收集后照片数量:",u.value.length),u.value.forEach(((e,a)=>{e&&(console.log(`收集后照片 ${a+1}:`,e.name),t.append("photo_after",e))})));const a=[...d.value||[],...u.value||[]];b.value=U(a),a.length>0&&(m.value=!0,h.value=0,v.value="准备上传...");const o=await Mt.postForm(w.endpoints.wasteRecords,t,K);console.log("提交响应:",o.data),g.nk.success("废物记录提交成功"),$()}catch(a){console.error("Error submitting form:",a),a.response&&(console.error("错误响应数据:",a.response.data),console.error("错误状态码:",a.response.status)),g.nk.error("提交失败，请稍后再试")}finally{o.value=!1,m.value=!1}}else g.nk.warning("请完成必填项")}))},$=()=>{a.value&&a.value.resetFields(),d.value=[],u.value=[],c.value=[],p.value=[],y.quantity=.001,y.collectionDate=(new Date).toISOString().slice(0,10),y.collectionTime=(new Date).toTimeString().slice(0,5)},E=()=>{k.value&&t.push("/")},S=()=>{t.push({name:"RecordsList",params:{unitId:e.id}})},A=e=>{setTimeout((()=>{if(e&&e.target){const t=e.target.querySelector("input");t&&t.select()}}),10)};return{form:y,rules:_,wasteForm:a,loading:o,unitName:r,wasteTypes:n,locations:i,isAdmin:k,fileListBefore:c,fileListAfter:p,handlePhotoBeforeChange:R,handlePhotoBeforeRemove:C,handlePhotoAfterChange:T,handlePhotoAfterRemove:V,handleBeforeUpload:L,submitForm:P,resetForm:$,goBack:E,viewRecords:S,selectAllText:A,showUploadProgress:m,uploadPercentage:h,uploadStatus:v,percentageFormat:W,showLargeFileWarning:b}}};const q=(0,x.A)(Q,[["render",A],["__scopeId","data-v-75ed91fb"]]);var M=q;const z={class:"records-container"},j={class:"header"},O={key:1},N={class:"content"},H={class:"unit-info"},Y={class:"actions"},J={class:"filter-header"},G={class:"filter-form-container"},Z={class:"quantity-range"},ee={class:"filter-actions"},te={class:"records-wrapper"},ae={class:"card-header"},oe={class:"card-actions"},le={key:0,class:"photo-preview"},re=["onClick"],ne={key:0,class:"photo-count"},se={key:1},ie={key:0,class:"photo-preview"},de=["onClick"],ue={key:0,class:"photo-count"},ce={key:1},pe={class:"operation-buttons"},me={key:0,class:"loading-more"},ge={key:1,class:"empty-block"},fe={key:2,class:"record-limit-tip"};function he(e,t,a,r,n,s){const d=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),c=(0,l.g2)("home"),p=(0,l.g2)("plus"),m=(0,l.g2)("el-button"),g=(0,l.g2)("user"),f=(0,l.g2)("refresh"),h=(0,l.g2)("download"),v=(0,l.g2)("arrow-down"),w=(0,l.g2)("arrow-up"),b=(0,l.g2)("el-date-picker"),k=(0,l.g2)("el-form-item"),y=(0,l.g2)("el-col"),_=(0,l.g2)("el-option"),F=(0,l.g2)("el-select"),I=(0,l.g2)("el-row"),x=(0,l.g2)("el-input"),L=(0,l.g2)("el-input-number"),R=(0,l.g2)("el-form"),C=(0,l.g2)("el-card"),T=(0,l.g2)("el-table-column"),V=(0,l.g2)("el-image"),U=(0,l.g2)("el-table"),K=(0,l.g2)("loading"),W=(0,l.g2)("el-empty"),P=(0,l.g2)("el-alert"),$=(0,l.g2)("el-image-viewer"),E=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",z,[(0,l.Lk)("div",j,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1}),t[10]||(t[10]=(0,l.eW)(" 返回填报 "))]),t[12]||(t[12]=(0,l.Lk)("h1",null,"废物记录查看",-1)),r.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"home-link",onClick:t[1]||(t[1]=(...e)=>r.goHome&&r.goHome(...e))},[t[11]||(t[11]=(0,l.eW)(" 首页 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(c)])),_:1})])):((0,l.uX)(),(0,l.CE)("div",O))]),(0,l.Lk)("div",N,[(0,l.Lk)("div",H,[(0,l.Lk)("h2",null,(0,i.v_)(r.unitName)+" - 固体废物记录",1)]),(0,l.Lk)("div",Y,[(0,l.bF)(m,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isAdmin||r.isUnitAdmin?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(m,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}),t[15]||(t[15]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"]),(0,l.bF)(m,{type:"primary",onClick:r.exportRecords,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1}),t[16]||(t[16]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick","loading"])]),(0,l.bF)(C,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",J,[t[17]||(t[17]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(m,{type:"primary",link:"",onClick:t[2]||(t[2]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(u,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(w)])),_:1})):((0,l.uX)(),(0,l.Wv)(u,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(v)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",G,[(0,l.bF)(R,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(I,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":r.disabledDate},null,8,["modelValue","disabled-date"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(I,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"产生工序"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.processType,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.processType=e),placeholder:"选择产生工序",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[(0,l.bF)(_,{label:"作业现场",value:"作业现场"}),(0,l.bF)(_,{label:"清罐清理",value:"清罐清理"}),(0,l.bF)(_,{label:"报废清理",value:"报废清理"}),(0,l.bF)(_,{label:"管线刺漏",value:"管线刺漏"}),(0,l.bF)(_,{label:"历史遗留",value:"历史遗留"}),(0,l.bF)(_,{label:"日常维护",value:"日常维护"}),(0,l.bF)(_,{label:"封井退出",value:"封井退出"})])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"备注关键词"},{default:(0,l.k6)((()=>[(0,l.bF)(x,{modelValue:r.filterForm.remarksKeyword,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.remarksKeyword=e),placeholder:"输入关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(I,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Z,[(0,l.bF)(L,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"48%"}},null,8,["modelValue"]),t[18]||(t[18]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.bF)(L,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[8]||(t[8]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"48%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.locationId,"onUpdate:modelValue":t[9]||(t[9]=e=>r.filterForm.locationId=e),placeholder:"选择产生地点",style:{width:"100%"},clearable:"",filterable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.locations,(e=>((0,l.uX)(),(0,l.Wv)(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.Lk)("div",ee,[(0,l.bF)(m,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)("筛选")]))),_:1},8,["onClick"]),(0,l.bF)(m,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[20]||(t[20]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[o.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",te,[(0,l.bF)(C,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ae,[t[22]||(t[22]=(0,l.Lk)("h3",{class:"table-title"},"废物记录列表",-1)),(0,l.Lk)("div",oe,[(0,l.bF)(m,{type:"warning",onClick:r.exportRecords},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1}),t[21]||(t[21]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(U,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:r.tableHeight,onScroll:r.handleScroll},{default:(0,l.k6)((()=>[(0,l.bF)(T,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,l.bF)(T,{prop:"waste_type_name",label:"废物类型","min-width":"120"}),(0,l.bF)(T,{prop:"process_type",label:"产生工序","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.process_type||"无"),1)])),_:1}),(0,l.bF)(T,{prop:"remarks",label:"备注","min-width":"150"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,l.bF)(T,{prop:"location_name",label:"产生地点","min-width":"120"}),(0,l.bF)(T,{label:"收集开始时间","min-width":"160"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.collection_start_time)),1)])),_:1}),(0,l.bF)(T,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(parseFloat(e.row.quantity).toFixed(3)),1)])),_:1}),(0,l.bF)(T,{label:"记录时间","min-width":"160",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.created_at)),1)])),_:1}),(0,l.bF)(T,{label:"汇报人","min-width":"100",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.creator_name||"未知"),1)])),_:1}),(0,l.bF)(T,{label:"现场照片（清理前）","min-width":"150",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",le,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,re)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",ne,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",se,"无"))])),_:1}),(0,l.bF)(T,{label:"现场照片（清理后）","min-width":"150",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",ie,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,de)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",ue,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",ce,"无"))])),_:1}),(0,l.bF)(T,{label:"操作","min-width":"120",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",pe,[r.canEdit(e.row)?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[23]||(t[23]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0),r.canEdit(e.row)&&(r.isAdmin||r.isUnitAdmin)?((0,l.uX)(),(0,l.Wv)(m,{key:1,type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[24]||(t[24]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0)])])),_:1})])),_:1},8,["data","height","onScroll"])),[[E,r.loading]]),r.loadingMore?((0,l.uX)(),(0,l.CE)("div",me,[(0,l.bF)(u,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(K)])),_:1}),t[25]||(t[25]=(0,l.eW)(" 加载更多... "))])):(0,l.Q3)("",!0),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",ge,[(0,l.bF)(W,{description:"暂无废物记录"})])),r.isAdmin||r.isUnitAdmin?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",fe,[(0,l.bF)(P,{title:"提示：只能查看过去7天内的废物记录",type:"info",closable:!1,"show-icon":""})]))])),_:1})])]),t[26]||(t[26]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,l.uX)(),(0,l.Wv)($,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}var ve=a(8828),we=a(2933),be=a(5320),ke=a(3230),ye=a(7093),_e=a.n(ye);console.log("XLSX库版本:",ke.version),console.log("XLSX库可用方法:",Object.keys(ke).join(", "));const Fe=async(e,t=window.location.origin)=>{if(console.log("获取图片:",e),!e)return console.error("图片URL为空"),null;const a=e.startsWith("/")?`${t}${e}`:e;try{console.log("获取图片:",a);const e=await fetch(a,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!e.ok)throw new Error(`获取图片失败: ${e.status} ${e.statusText}`);const t=await e.arrayBuffer();return console.log("图片获取成功，大小:",t.byteLength,"字节"),t}catch(o){return console.error("获取图片失败:",o),null}},Ie=async(e,t,a,o=window.location.origin,l=null)=>{if(console.log("=== exportToExcelWithImages 函数被调用 ==="),console.log("数据条数:",e.length),!e||0===e.length)return console.error("导出失败：没有数据"),!1;try{t=t.replace(/[\\/:*?"<>|]/g,"_");const n=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),s=`${t}_${n}.xlsx`,i=new(_e().Workbook);i.creator="固体废物管理系统",i.lastModifiedBy="固体废物管理系统",i.created=new Date,i.modified=new Date;const d=i.addWorksheet("固体废物记录"),u=a.map((e=>({header:e.text,key:e.field,width:e.isImage?20:15})));d.columns=u,d.getRow(1).font={bold:!0},d.getRow(1).alignment={vertical:"middle",horizontal:"center"},console.log("开始处理数据行...");const c=e.length*(1+a.filter((e=>e.isImage)).length);let p=0;for(let t=0;t<e.length;t++){const n=e[t];console.log(`处理第 ${t+1}/${e.length} 条记录...`);const s={};a.forEach((e=>{e.isImage||(s[e.field]=n[e.field]||"")}));const u=d.addRow(s);u.height=80,p++,l&&"function"===typeof l&&l(p,c);for(const e of a)if(e.isImage){const s=e.field,u=n[s];if(u){console.log(`记录 ${t+1} 的 ${s} 字段有图片路径: ${u}`);try{const e=await Fe(u,o);if(e){const o=a.findIndex((e=>e.field===s))+1,l=d.getCell(t+2,o).address,r=i.addImage({buffer:e,extension:u.split(".").pop().toLowerCase()});d.addImage(r,{tl:{col:o-1,row:t+1},br:{col:o,row:t+1.9},editAs:"oneCell"}),console.log(`已添加图片到单元格 ${l}`)}else console.error(`获取图片失败: ${u}`)}catch(r){console.error("处理图片时出错:",r)}}else console.log(`记录 ${t+1} 的 ${s} 没有照片路径`);p++,l&&"function"===typeof l&&l(p,c)}}console.log("数据行处理完成，准备生成Excel文件...");const m=await i.xlsx.writeBuffer(),g=new Blob([m],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=window.URL.createObjectURL(g),h=document.createElement("a");return h.href=f,h.download=s,h.click(),window.URL.revokeObjectURL(f),console.log("Excel文件生成并下载成功"),!0}catch(n){return console.error("导出Excel文件失败:",n),!1}},xe=async(e,t,a)=>{if(!e||0===e.length)return console.error("导出失败：没有数据"),!1;t=t.replace(/[\\/:*?"<>|]/g,"_");const o=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),l=`${t}_${o}.xlsx`;console.log("导出函数被调用，数据条数:",e.length);try{console.log("使用ExcelJS导出Excel...");const t=new(_e().Workbook);t.creator="固体废物管理系统",t.lastModifiedBy="固体废物管理系统",t.created=new Date,t.modified=new Date;const o=t.addWorksheet("固体废物记录"),r=a.map((e=>({header:e.text,key:e.field,width:15})));o.columns=r,o.getRow(1).font={bold:!0},o.getRow(1).alignment={vertical:"middle",horizontal:"center"},e.forEach((e=>{const t={};a.forEach((a=>{t[a.field]=e[a.field]||""})),o.addRow(t)})),console.log("生成Excel数据...");const n=await t.xlsx.writeBuffer(),s=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(s),d=document.createElement("a");return d.href=i,d.download=l,console.log("下载链接创建成功，准备触发点击"),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),console.log("Excel导出成功"),!0}catch(r){return console.error("导出Excel失败，错误详情:",r),console.log("回退到CSV导出"),Le(e,t,a),!1}},Le=(e,t,a)=>{const o=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),l=`${t}_${o}.csv`;let r="\ufeff";const n=a.map((e=>`"${e.title}"`)).join(",");r+=n+"\r\n",e.forEach((e=>{const t=a.map((t=>{const a=e[t.field];if(null===a||void 0===a)return"";if("number"===t.type||"number"===typeof a)return a;let o=String(a);return(o.includes(",")||o.includes('"')||o.includes("\n"))&&(o=o.replace(/"/g,'""'),o=`"${o}"`),o})).join(",");r+=t+"\r\n"}));const s=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),d=document.createElement("a");d.setAttribute("href",i),d.setAttribute("download",l),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),console.log("CSV导出成功")};var Re={name:"RecordsList",components:{ArrowLeft:D.nkM,Home:D.Home,Refresh:D.C42,Plus:D.FWt,User:D.KJW,ArrowDown:D.yd$,ArrowUp:D.DoI,Download:D.f5X,ElImageViewer:ve.Tg,Loading:D.Rhj},props:{unitId:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),a=(0,f.KR)([]),o=(0,f.KR)(!1),r=(0,f.KR)(""),n=(0,f.KR)([]),i=(0,f.KR)([]),d=(0,f.KR)(!0),u=w.baseURL,c=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},p=(0,f.KR)(1),m=(0,f.KR)(20),v=(0,f.KR)(!0),b=(0,f.KR)(!1),k=(0,f.Kh)({dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,locationId:null,processType:null,remarksKeyword:null}),y=(0,l.EW)((()=>a.value.filter((e=>{if(k.wasteTypeId&&e.waste_type_id!==k.wasteTypeId)return!1;if(null!==k.minQuantity&&void 0!==k.minQuantity&&parseFloat(e.quantity)<k.minQuantity)return!1;if(null!==k.maxQuantity&&void 0!==k.maxQuantity&&parseFloat(e.quantity)>k.maxQuantity)return!1;if(k.locationId&&e.location_id!==k.locationId)return!1;if(k.dateRange&&2===k.dateRange.length){const t=new Date(k.dateRange[0]);t.setHours(0,0,0);const a=new Date(k.dateRange[1]);a.setHours(23,59,59);const o=new Date(e.collection_start_time);if(o<t||o>a)return!1}return(!k.processType||e.process_type===k.processType)&&!(k.remarksKeyword&&!e.remarks.includes(k.remarksKeyword))})))),_=(0,l.EW)((()=>ta.isAdmin())),F=(0,l.EW)((()=>ta.isUnitAdmin())),I=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},x=async()=>{await Y(),g.nk.success("记录已刷新")},L=()=>{const e=ta.getUnitId();e?t.push(`/unit/${e}`):t.push("/")},R=()=>{t.push("/")},C=()=>{t.push("/user-management")},T=()=>{t.push(`/unit/${e.unitId}`)},V=e=>{t.push(`/record/${e}`)},U=e=>{if(!e)return!1;if(_.value)return!0;const t=ta.getUnitId();if(F.value&&t&&e.unit_id===parseInt(t))return!0;const a=ta.getUserId();return a&&e.creator_id===parseInt(a)},K=e=>(p.value-1)*m.value+e+1,W=e=>{_.value||F.value?we.s.confirm("确定要删除这条废物记录吗？此操作不可逆。","删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await Mt.delete(`${w.endpoints.wasteRecords}/${e.id}`),g.nk.success("记录已成功删除"),await Y()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败，请重试")}})).catch((()=>{g.nk.info("已取消删除")})):g.nk.error("您没有删除记录的权限")},P=async()=>{try{p.value=1,await Y(),g.nk.success("筛选条件已应用")}catch(e){console.error("应用筛选失败:",e),g.nk.error("应用筛选失败")}},$=async()=>{k.dateRange=null,k.wasteTypeId=null,k.minQuantity=null,k.maxQuantity=null,k.locationId=null,k.processType=null,k.remarksKeyword=null,p.value=1,await Y(),g.nk.success("筛选条件已重置")},E=async()=>{try{await we.s.confirm("请选择导出格式","导出选项",{confirmButtonText:"带图片导出",cancelButtonText:"不带图片导出",distinguishCancelAndClose:!0,type:"info"}).then((async()=>{await S()})).catch((e=>{"cancel"===e&&A()}))}catch(e){console.error("导出过程发生错误:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}},S=async()=>{try{(0,g.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const t=be.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const a={wasteTypeId:k.wasteTypeId?k.wasteTypeId:void 0,minQuantity:k.minQuantity?k.minQuantity:void 0,maxQuantity:k.maxQuantity?k.maxQuantity:void 0,locationId:k.locationId?k.locationId:void 0,dateRange:k.dateRange?JSON.stringify(k.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0,processType:k.processType?k.processType:void 0,remarksKeyword:k.remarksKeyword?k.remarksKeyword:void 0};console.log("导出记录的筛选条件:",a);const{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${ta.state.user.id}`,{params:a});if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return t.close(),g.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);t.setText(`准备导出 ${l.length} 条记录...`);const n=l.map((e=>{const t=c(e.photo_path_before),a=c(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process_type||"无","备注":e.remarks||"无","产生地点":e.location_name,"数量(kg)":e.quantity,"收集开始时间":I(e.collection_start_time),"填报人":e.creator_name||"系统","清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),s=`固体废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"产生地点",field:"产生地点"},{text:"数量(kg)",field:"数量(kg)"},{text:"收集开始时间",field:"收集开始时间"},{text:"填报人",field:"填报人"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],d=window.location.origin,u=(e,a)=>{const o=Math.round(e/a*100);t.setText(`正在导出：${o}% (${e}/${a})`)},p=await Ie(n,s,i,d,u);t.close(),p?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),g.nk.error("导出失败: "+(t.message||"未知错误"))}finally{o.value=!1,be.Ks.service().close()}},A=async()=>{try{const t=be.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const a={wasteTypeId:k.wasteTypeId?k.wasteTypeId:void 0,minQuantity:k.minQuantity?k.minQuantity:void 0,maxQuantity:k.maxQuantity?k.maxQuantity:void 0,locationId:k.locationId?k.locationId:void 0,dateRange:k.dateRange?JSON.stringify(k.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0,processType:k.processType?k.processType:void 0,remarksKeyword:k.remarksKeyword?k.remarksKeyword:void 0},{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${ta.state.user.id}`,{params:a});if(0===l.length)return t.close(),g.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);t.setText(`准备导出 ${l.length} 条记录...`);const n=l.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process_type||"无","备注":e.remarks||"无","产生地点":e.location_name,"数量(kg)":e.quantity,"收集开始时间":I(e.collection_start_time),"填报人":e.creator_name||"系统","清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),s=`固体废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"产生地点",field:"产生地点"},{text:"数量(kg)",field:"数量(kg)"},{text:"收集开始时间",field:"收集开始时间"},{text:"填报人",field:"填报人"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],d=await xe(n,s,i);t.close(),d?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),g.nk.error("导出失败: "+(t.message||"未知错误"))}finally{o.value=!1,be.Ks.service().close()}},D=(0,f.KR)(!1),B=(0,f.KR)([]),X=(0,f.KR)(0),Q=(e,t)=>{const a=Array.isArray(e)?e:[e];B.value=a.map((e=>`${u}${e}`)),X.value=t||0,D.value=!0},q=()=>{D.value=!1},M=(0,f.KR)(750),z=()=>{const e=window.innerHeight,t=Math.max(.85*e,700);M.value=t},j=()=>{z()};(0,l.sV)((async()=>{z(),window.addEventListener("resize",j),await N(),await O(),await H(),await Y()})),(0,l.hi)((()=>{window.removeEventListener("resize",j)}));const O=async()=>{try{const e=await Mt.get(w.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("获取废物类型失败:",e),g.nk.error("获取废物类型失败，请刷新重试")}},N=async()=>{try{const t=await Mt.get(w.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.unitId)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},H=async()=>{try{const t=await Mt.get(`${w.endpoints.locationsByUnit}/${e.unitId}`);i.value=t.data}catch(t){console.error("获取地点列表失败:",t),g.nk.error("获取地点列表失败，请刷新重试")}},Y=async(e=!1)=>{e?b.value=!0:(o.value=!0,p.value=1,a.value=[]);try{if(!ta.state.isLoggedIn||!ta.state.user)throw new Error("用户未登录");const t={page:p.value,pageSize:m.value,wasteTypeId:k.wasteTypeId,minQuantity:k.minQuantity,maxQuantity:k.maxQuantity,locationId:k.locationId,processType:k.processType,remarksKeyword:k.remarksKeyword};k.dateRange&&2===k.dateRange.length&&(t.dateRange=JSON.stringify(k.dateRange)),console.log("请求废物记录，参数:",t);const o=await Mt.get(`${w.endpoints.wasteRecords}/user/${ta.state.user.id}`,{params:t});console.log("获取到废物记录响应:",o.data);const l=o.data.records.map((e=>({...e,created_at:I(e.created_at),collection_start_time:I(e.collection_start_time)})));a.value=e?[...a.value,...l]:l,v.value=o.data.hasMore,v.value&&p.value++}catch(t){console.error("获取废物记录失败:",t),g.nk.error("获取废物记录失败: "+(t.message||"未知错误"))}finally{o.value=!1,b.value=!1}},J=async e=>{if(!e||!e.target)return;const t=e.target.scrollHeight||0,a=e.target.scrollTop||0,o=e.target.clientHeight||0;t-a-o<50&&v.value&&!b.value&&(p.value++,await Y(!0))},G=e=>{if(!_.value&&!F.value){const t=new Date,a=new Date(t);return a.setDate(t.getDate()-7),e<a||e>t}return!1};return{records:a,filteredRecords:y,loading:o,unitName:r,wasteTypes:n,locations:i,showFilterPanel:d,filterForm:k,disabledDate:G,isAdmin:_,isUnitAdmin:F,parseFormattedDateTime:I,refreshRecords:x,goBack:L,goHome:R,goToUserManagement:C,addNewRecord:T,editRecord:V,canEdit:U,confirmDelete:W,apiConfig:w,applyFilter:P,resetFilter:$,exportRecords:E,showViewer:D,previewImages:B,previewIndex:X,previewPhoto:Q,closeViewer:q,handleScroll:J,parsePhotoPath:c,baseUrl:u,page:p,pageSize:m,hasMore:v,loadingMore:b,indexMethod:K,tableHeight:M}}};const Ce=(0,x.A)(Re,[["render",he],["__scopeId","data-v-21af222f"]]);var Te=Ce;const Ve={class:"login-container"},Ue={class:"login-card"},Ke={key:0,class:"login-error"};function We(e,t,a,r,n,s){const d=(0,l.g2)("el-input"),u=(0,l.g2)("el-form-item"),c=(0,l.g2)("el-checkbox"),p=(0,l.g2)("el-button"),m=(0,l.g2)("el-form");return(0,l.uX)(),(0,l.CE)("div",Ve,[(0,l.Lk)("div",Ue,[t[5]||(t[5]=(0,l.Lk)("div",{class:"login-header"},[(0,l.Lk)("h1",null,"固体废物管理系统"),(0,l.Lk)("h2",null,"用户登录")],-1)),(0,l.bF)(m,{ref:"loginForm",model:r.form,rules:r.rules,"label-width":"80px",class:"login-form",onSubmit:(0,o.D$)(r.submitForm,["prevent"])},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"用户名",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:r.form.phone,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,{label:"密码",prop:"password"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:r.form.password,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:r.form.rememberMe,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.rememberMe=e)},{default:(0,l.k6)((()=>t[3]||(t[3]=[(0,l.eW)("记住登录")]))),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p,{type:"primary","native-type":"submit",onClick:r.submitForm,loading:r.auth.state.loading,style:{width:"100%"}},{default:(0,l.k6)((()=>t[4]||(t[4]=[(0,l.eW)(" 登录 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules","onSubmit"]),r.auth.state.error?((0,l.uX)(),(0,l.CE)("div",Ke,(0,i.v_)(r.auth.state.error),1)):(0,l.Q3)("",!0)])])}var Pe={name:"LoginView",setup(){const e=(0,s.rd)(),t=(0,f.KR)(null),a=(0,f.Kh)({phone:"",password:"",rememberMe:!1}),o=(0,l.EW)((()=>{const e=[{required:!0,message:"请输入手机号",trigger:"submit"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"submit"}],t=[{required:!0,message:"请输入密码",trigger:"submit"}];return{phone:e,password:t}})),r=async()=>{console.log("提交表单被触发"),t.value?ta.state.loading?console.log("登录正在进行中，跳过"):t.value.validate((async e=>{e?(console.log("表单验证通过"),await n()):console.log("表单验证失败")})):console.log("表单引用不存在")},n=async()=>{console.log("开始登录，账号:",a.phone);try{console.log("开始处理登录操作...");const t=await ta.login(a.phone,a.password,a.rememberMe);if(console.log("登录响应:",t),t.success){const a=t.user;g.nk.success(`欢迎，${a.username||a.phone}`),3===a.role_id?e.push("/admin-records"):2===a.role_id?e.push(`/records/${a.unit_id}`):e.push(`/unit/${a.unit_id}`)}else g.nk.error(t.error||"登录失败")}catch(t){g.nk.error(t.response?.data?.error||"登录失败，请检查网络连接")}};return(0,l.sV)((()=>{if(ta.state.isLoggedIn){const t=ta.state.user;3===t.role_id?e.push("/admin-records"):2===t.role_id?e.push(`/records/${t.unit_id}`):e.push(`/unit/${t.unit_id}`)}})),{form:a,rules:o,loginForm:t,submitForm:r,auth:ta}}};const $e=(0,x.A)(Pe,[["render",We],["__scopeId","data-v-01efd5c6"]]);var Ee=$e;const Se={class:"edit-record-container"},Ae={class:"header"},De={class:"content"},Be={class:"form-header"},Xe={key:0,class:"upload-warning"},Qe={class:"upload-progress"},qe={class:"upload-status"};function Me(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("el-option"),c=(0,l.g2)("el-select"),p=(0,l.g2)("el-form-item"),m=(0,l.g2)("el-input"),g=(0,l.g2)("el-date-picker"),f=(0,l.g2)("clock"),h=(0,l.g2)("el-time-picker"),v=(0,l.g2)("el-input-number"),w=(0,l.g2)("el-alert"),b=(0,l.g2)("plus"),k=(0,l.g2)("el-upload"),y=(0,l.g2)("el-image-viewer"),_=(0,l.g2)("el-button"),F=(0,l.g2)("el-form"),I=(0,l.g2)("el-progress"),x=(0,l.g2)("el-dialog"),L=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Se,[(0,l.Lk)("div",Ae,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[10]||(t[10]=(0,l.eW)(" 返回 "))]),(0,l.Lk)("h1",null,(0,i.v_)(o.isNew?"新增废物记录":"编辑废物记录"),1),t[11]||(t[11]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",De,[(0,l.Lk)("div",Be,[(0,l.Lk)("h2",null,(0,i.v_)(o.unitName),1)]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(F,{ref:"recordForm",model:o.form,rules:o.rules,"label-width":"120px",class:"record-form"},{default:(0,l.k6)((()=>[o.isSuperAdmin&&o.isNew?((0,l.uX)(),(0,l.Wv)(p,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>o.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.units,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(p,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"产生工序",prop:"processType"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.processType,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.processType=e),placeholder:"请选择产生工序",style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"作业现场",value:"作业现场"}),(0,l.bF)(u,{label:"清罐清理",value:"清罐清理"}),(0,l.bF)(u,{label:"报废清理",value:"报废清理"}),(0,l.bF)(u,{label:"管线刺漏",value:"管线刺漏"}),(0,l.bF)(u,{label:"历史遗留",value:"历史遗留"}),(0,l.bF)(u,{label:"日常维护",value:"日常维护"}),(0,l.bF)(u,{label:"封井退出",value:"封井退出"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"产生地点",prop:"locationId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.locationId,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.locationId=e),placeholder:"请选择废物产生地点",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.locations,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"备注",prop:"remarks"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:o.form.remarks,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.remarks=e),type:"textarea",rows:1,placeholder:"若选择其他产生工序或产生地点，请在此说明"},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集日期"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:o.form.collectionDate,"onUpdate:modelValue":t[6]||(t[6]=e=>o.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:o.form.collectionTime,"onUpdate:modelValue":t[7]||(t[7]=e=>o.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:o.form.quantity,"onUpdate:modelValue":t[8]||(t[8]=e=>o.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集前）",prop:"photo_path_before"},{default:(0,l.k6)((()=>[t[12]||(t[12]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),o.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",Xe,[(0,l.bF)(w,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(k,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoBeforeChange,"on-remove":o.handlePhotoBeforeRemove,"file-list":o.fileListBefore,limit:5,multiple:"","list-type":"picture-card","on-preview":o.handlePictureCardPreview,"before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(b)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集后）",prop:"photo_path_after"},{default:(0,l.k6)((()=>[t[13]||(t[13]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(k,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoAfterChange,"on-remove":o.handlePhotoAfterRemove,"file-list":o.fileListAfter,limit:5,multiple:"","list-type":"picture-card","on-preview":o.handlePictureCardPreview,"before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(b)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),o.showViewer?((0,l.uX)(),(0,l.Wv)(y,{key:0,"url-list":o.previewImages,"initial-index":o.previewIndex,onClose:o.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,null,{default:(0,l.k6)((()=>[(0,l.bF)(_,{type:"primary",onClick:o.submitForm,loading:o.loading},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("保存")]))),_:1},8,["onClick","loading"]),(0,l.bF)(_,{onClick:o.goBack},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)("取消")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"])),[[L,o.loading]])]),(0,l.bF)(x,{modelValue:o.showUploadProgress,"onUpdate:modelValue":t[9]||(t[9]=e=>o.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Qe,[t[16]||(t[16]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(I,{percentage:o.uploadPercentage,format:o.percentageFormat,status:100===o.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",qe,(0,i.v_)(o.uploadStatus),1)])])),_:1},8,["modelValue"]),t[17]||(t[17]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var ze={name:"EditRecordView",components:{ArrowLeft:D.nkM,Plus:D.FWt,Clock:D.zD7,ElImageViewer:ve.Tg},setup(){const e=(0,s.rd)(),t=(0,s.lq)(),a=(0,f.KR)(null),o=(0,f.KR)(!1),r=(0,f.KR)(!1),n=(0,f.KR)(""),i=(0,f.KR)([]),d=(0,f.KR)([]),u=(0,f.KR)([]),c=(0,f.KR)([]),p=(0,f.KR)([]),m=(0,f.KR)([]),h=(0,f.KR)([]),v=(0,f.KR)([]),b=(0,f.KR)(!1),k=(0,f.KR)(0),y=(0,f.KR)(""),_=(0,f.KR)(!1),F=(0,f.KR)(0),I=(0,f.KR)("准备上传..."),x=(0,f.KR)(!1),L=(0,f.KR)(null),R=e=>{if(!e)return[];console.log("解析照片路径，原始值:",e,"类型:",typeof e);try{if(Array.isArray(e))return console.log("照片路径已经是数组:",e),e;if("string"===typeof e){if(e.startsWith("[")&&e.endsWith("]")){const t=JSON.parse(e);return console.log("照片路径解析为JSON数组:",t),t}if(e.includes(",")){const t=e.split(",").map((e=>e.trim())).filter((e=>e));return console.log("照片路径解析为逗号分隔字符串:",t),t}return console.log("照片路径解析为单个字符串:",[e]),[e]}return console.log("照片路径类型未知，尝试转换为字符串:",String(e)),[String(e)]}catch(t){return console.error("解析照片路径失败:",t),"string"===typeof e?[e]:[]}},C=(0,l.EW)((()=>!t.params.id||"new"===t.params.id)),T=(0,l.EW)((()=>ta.state.isLoggedIn&&3===ta.state.user.role_id)),V=(0,f.Kh)({unitId:"",wasteTypeId:"",locationId:"",collectionDate:"",collectionTime:"",quantity:0,recordId:null,creatorId:ta.state.user?.id||null,photo_path_before:"",photo_path_after:"",processType:"",remarks:""}),U={unitId:[{required:!0,message:"请选择单位",trigger:"change"}],wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],locationId:[{required:!0,message:"请选择废物产生地点",trigger:"change"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{o.value=!0;try{await P(),T.value&&await K(),C.value?(!T.value&&ta.state.user&&(V.unitId=ta.state.user.unit_id,await W(V.unitId),await $(V.unitId)),V.collectionDate=(new Date).toISOString().slice(0,10),V.collectionTime=(new Date).toTimeString().slice(0,5)):await E()}catch(e){console.error("初始化数据失败:",e),g.nk.error("加载数据失败，请刷新重试")}finally{o.value=!1}})),(0,l.wB)((()=>V.unitId),(async(e,t)=>{e&&e!==t&&(await W(e),await $(e),t&&(V.locationId=""))}));const K=async()=>{try{const e=await Mt.get(w.endpoints.units);d.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},W=async e=>{try{const t=await Mt.get(w.endpoints.units),a=t.data.find((t=>t.id===parseInt(e)));a&&(n.value=a.name)}catch(t){console.error("获取单位信息失败:",t)}},P=async()=>{try{const e=await Mt.get(w.endpoints.wasteTypes);i.value=e.data}catch(e){console.error("获取废物类型失败:",e),g.nk.error("获取废物类型失败")}},$=async e=>{try{if(!e)return;const t=await Mt.get(`${w.endpoints.locationsByUnit}/${e}`);u.value=t.data,console.log("获取到的地点列表:",u.value)}catch(t){console.error("获取地点列表失败:",t),g.nk.error("获取地点列表失败")}},E=async()=>{try{o.value=!0;const e=await Mt.get(`${w.endpoints.wasteRecords}/detail/${t.params.id}`);L.value=e.data;const a=e.data;if(console.log("获取到的记录详情:",a),V.unitId=a.unit_id,V.wasteTypeId=a.waste_type_id,V.locationId=a.location_id,V.recordId=a.id,await W(V.unitId),await $(V.unitId),a.collection_start_time){const e=new Date(a.collection_start_time);V.collectionDate=e.toISOString().slice(0,10),V.collectionTime=e.toTimeString().slice(0,5)}if(V.quantity=a.quantity,V.processType=a.process_type||"",console.log("设置产生工序字段:",a.process_type),V.remarks=a.remarks||"",console.log("设置备注字段:",a.remarks),a.photo_path_before){console.log("收集前照片路径:",a.photo_path_before);const e=R(a.photo_path_before);console.log("解析后的收集前照片路径:",e),c.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集前照片完整URL:",t),{name:e.split("/").pop(),url:t}}))}if(a.photo_path_after){console.log("收集后照片路径:",a.photo_path_after);const e=R(a.photo_path_after);console.log("解析后的收集后照片路径:",e),p.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集后照片完整URL:",t),{name:e.split("/").pop(),url:t}}))}n.value=a.unit_name,y.value=a.created_at,q([...c.value,...p.value])}catch(e){console.error("获取记录详情失败:",e),g.nk.error("获取记录详情失败")}finally{o.value=!1}},S=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return g.nk.error("只能上传图片文件!"),!1;const o=52428800;return e.size>o?(g.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{_.value=!0,I.value="正在处理图片...",F.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(X())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){F.value=30,I.value="正在处理图片...",console.log("图片处理中...")},drew(){F.value=60,I.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),I.value="图片处理完成",F.value=100,setTimeout((()=>{_.value=!1}),500),t(l)},error(a){console.error("图片压缩失败:",a),I.value="处理失败，使用原始图片",F.value=100,setTimeout((()=>{_.value=!1}),500),t(e)}})}))},A=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){_.value=!0,I.value="正在处理图片...",F.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(X())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){F.value=30,I.value="正在处理图片...",console.log("图片处理中...")},drew(){F.value=60,I.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),I.value="图片处理完成",F.value=100,t(l)},error(a){console.error("图片压缩失败:",a),I.value="处理失败，使用原始图片",F.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?m.value[a]=t:m.value.push(t);const o=c.value.findIndex((t=>t.uid===e.uid));o>=0&&(c.value[o].processed=!0),setTimeout((()=>{_.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),g.nk.warning("图片处理失败，将使用原始图片");const t=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?m.value[t]=e.raw:m.value.push(e.raw),_.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return j(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集前照片添加raw属性:",e.raw)),q([...c.value,...p.value]),console.log("更新后的fileListBefore:",c.value),console.log("更新后的photoFilesBefore:",m.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},D=(e,t)=>{console.log("收集前照片移除:",e),c.value=t,j([...c.value,...p.value])||(x.value=!1),q([...c.value,...p.value])},B=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),p.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){_.value=!0,I.value="正在处理图片...",F.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(X())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){F.value=30,I.value="正在处理图片...",console.log("图片处理中...")},drew(){F.value=60,I.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),I.value="图片处理完成",F.value=100,t(l)},error(a){console.error("图片压缩失败:",a),I.value="处理失败，使用原始图片",F.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=h.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?h.value[a]=t:h.value.push(t);const o=p.value.findIndex((t=>t.uid===e.uid));o>=0&&(p.value[o].processed=!0),setTimeout((()=>{_.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),g.nk.warning("图片处理失败，将使用原始图片");const t=h.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?h.value[t]=e.raw:h.value.push(e.raw),_.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return j(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集后照片添加raw属性:",e.raw)),q([...c.value,...p.value]),console.log("更新后的fileListAfter:",p.value),console.log("更新后的photoFilesAfter:",h.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},Q=(e,t)=>{console.log("收集后照片移除:",e),p.value=t,j([...c.value,...p.value])||(x.value=!1),q([...c.value,...p.value])},q=e=>{v.value=e.map((e=>e.url?(console.log("预览图片URL:",e.url),e.url):e.raw?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e.raw)),console.log("预览图片从raw创建:",e._blobUrl),e._blobUrl):e instanceof File?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e)),console.log("预览图片从File创建:",e._blobUrl),e._blobUrl):"")).filter((e=>e)),console.log("预览图片列表:",v.value)},M=e=>{console.log("预览图片:",e),q([...c.value,...p.value]);const t=v.value.findIndex((t=>{if(e.url)return t===e.url;if(e.raw){const a=URL.createObjectURL(e.raw),o=t===a;return URL.revokeObjectURL(a),o}return!1}));k.value=-1!==t?t:0,b.value=!0},z=()=>{b.value=!1},j=e=>{const t=2097152;return e.some((e=>e.size>t))},O=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);F.value=t,I.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},N=e=>100===e?"完成":`${e}%`,H=async()=>{a.value&&await a.value.validate((async e=>{if(!e)return console.log("表单验证失败"),g.nk.error("请填写所有必填字段"),!1;F.value=0,I.value="正在上传文件...",_.value=!0;try{const e=new FormData;if(e.append("unitId",V.unitId),e.append("wasteTypeId",V.wasteTypeId),e.append("locationId",V.locationId),e.append("collectionDate",V.collectionDate),e.append("collectionTime",V.collectionTime),e.append("quantity",V.quantity),e.append("processType",V.processType||""),e.append("remarks",V.remarks||""),c.value.length>0){const t=c.value.filter((e=>e.raw)),a=c.value.filter((e=>!e.raw));if(t.length>0){if(console.log("有新上传的收集前照片，需要合并现有照片"),t.forEach((t=>{t.raw&&(console.log("添加新的收集前照片:",t.raw.name),e.append("photo_before",t.raw))})),a.length>0){const t=a.map((e=>{let t=e.url;const a=window.location.origin;return t.startsWith(a)&&(t=t.substring(a.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集前照片路径:",t),e.append("photo_path_before",JSON.stringify(t))}}else if(a.length>0){const t=a.map((e=>{let t=e.url;const a=window.location.origin;return t.startsWith(a)&&(t=t.substring(a.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集前照片路径(无新照片):",t),e.append("photo_path_before",JSON.stringify(t))}}else!C.value&&L.value&&L.value.photo_path_before&&(console.log("用户删除了所有收集前照片，发送NULL标记"),e.append("photo_path_before","NULL"));if(p.value.length>0){const t=p.value.filter((e=>e.raw)),a=p.value.filter((e=>!e.raw));if(t.length>0){if(console.log("有新上传的收集后照片，需要合并现有照片"),t.forEach((t=>{t.raw&&(console.log("添加新的收集后照片:",t.raw.name),e.append("photo_after",t.raw))})),a.length>0){const t=a.map((e=>{let t=e.url;const a=window.location.origin;return t.startsWith(a)&&(t=t.substring(a.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集后照片路径:",t),e.append("photo_path_after",JSON.stringify(t))}}else if(a.length>0){const t=a.map((e=>{let t=e.url;const a=window.location.origin;return t.startsWith(a)&&(t=t.substring(a.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集后照片路径(无新照片):",t),e.append("photo_path_after",JSON.stringify(t))}}else!C.value&&L.value&&L.value.photo_path_after&&(console.log("用户删除了所有收集后照片，发送NULL标记"),e.append("photo_path_after","NULL"));console.log("FormData内容:");for(let[t,a]of e.entries())a instanceof File?console.log(`${t}: File - ${a.name} (${a.type}, ${a.size} bytes)`):console.log(`${t}: ${a}`);V.recordId?(await Mt.putForm(`${w.endpoints.wasteRecords}/${V.recordId}`,e,O),g.nk.success("废物记录更新成功")):(await Mt.postForm(w.endpoints.wasteRecords,e,O),g.nk.success("废物记录添加成功")),_.value=!1,Y()}catch(t){console.error("提交表单失败:",t),t.response&&t.response.data?(console.error("服务器返回错误:",t.response.data),g.nk.error(`提交表单失败: ${t.response.data.error||"未知错误"}`)):g.nk.error("提交表单失败，请检查网络连接"),_.value=!1}}))},Y=()=>{T.value?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:ta.state.user.unit_id}})};return{form:V,rules:U,recordForm:a,loading:o,submitting:r,unitName:n,wasteTypes:i,units:d,locations:u,fileListBefore:c,fileListAfter:p,photoFilesBefore:m,photoFilesAfter:h,previewImages:v,showViewer:b,previewIndex:k,isNew:C,isSuperAdmin:T,parsePhotoPath:R,handlePhotoBeforeChange:A,handlePhotoBeforeRemove:D,handlePhotoAfterChange:B,handlePhotoAfterRemove:Q,handlePictureCardPreview:M,handleBeforeUpload:S,closeViewer:z,submitForm:H,goBack:Y,showUploadProgress:_,uploadPercentage:F,uploadStatus:I,percentageFormat:N,showLargeFileWarning:x,record:L}}};const je=(0,x.A)(ze,[["render",Me],["__scopeId","data-v-992cc100"]]);var Oe=je;const Ne={class:"user-management-container"},He={class:"header"},Ye={class:"content"},Je={class:"toolbar"},Ge={key:0,class:"password-hint"},Ze={key:1,class:"password-hint"},et={class:"dialog-footer"};function tt(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("plus"),c=(0,l.g2)("el-button"),p=(0,l.g2)("el-table-column"),m=(0,l.g2)("el-tag"),g=(0,l.g2)("el-popconfirm"),f=(0,l.g2)("el-table"),h=(0,l.g2)("el-input"),v=(0,l.g2)("el-form-item"),w=(0,l.g2)("el-option"),b=(0,l.g2)("el-select"),k=(0,l.g2)("el-form"),y=(0,l.g2)("el-dialog"),_=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Ne,[(0,l.Lk)("div",He,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 返回 "))]),t[9]||(t[9]=(0,l.Lk)("h1",null,"人员管理",-1)),t[10]||(t[10]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Ye,[(0,l.Lk)("div",Je,[(0,l.bF)(c,{type:"primary",onClick:o.openAddDialog},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 添加用户 "))])),_:1},8,["onClick"])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(f,{data:o.users,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,l.k6)((()=>[(0,l.bF)(p,{type:"index",label:"序号",width:"70",align:"center"}),(0,l.bF)(p,{prop:"username",label:"姓名",width:"120"}),(0,l.bF)(p,{prop:"phone",label:"手机号",width:"140"}),(0,l.bF)(p,{prop:"role_name",label:"角色",width:"120"}),(0,l.bF)(p,{prop:"unit_name",label:"单位","min-width":"120"}),(0,l.bF)(p,{label:"状态",width:"100",align:"center"},{default:(0,l.k6)((e=>[(0,l.bF)(m,{type:1===e.row.status?"success":"danger"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.status?"正常":"已停用"),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(p,{label:"操作",width:"240",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.bF)(c,{size:"small",onClick:t=>o.handleEdit(e.row)},{default:(0,l.k6)((()=>t[12]||(t[12]=[(0,l.eW)("编辑")]))),_:2},1032,["onClick"]),(0,l.bF)(c,{size:"small",type:1===e.row.status?"warning":"success",onClick:t=>o.handleStatusChange(e.row)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.status?"停用":"恢复"),1)])),_:2},1032,["type","onClick"]),(0,l.bF)(g,{title:"确定要删除此用户吗？",onConfirm:t=>o.handleDelete(e.row)},{reference:(0,l.k6)((()=>[(0,l.bF)(c,{size:"small",type:"danger"},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"])),[[_,o.loading]])]),(0,l.bF)(y,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[7]||(t[7]=e=>o.dialogVisible=e),title:o.isEdit?"编辑用户":"添加用户",width:"500px"},{footer:(0,l.k6)((()=>[(0,l.Lk)("span",et,[(0,l.bF)(c,{onClick:t[6]||(t[6]=e=>o.dialogVisible=!1)},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(c,{type:"primary",onClick:o.submitForm,loading:o.formLoading},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(k,{ref:"userForm",model:o.form,rules:o.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"姓名",prop:"username"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:o.form.username,"onUpdate:modelValue":t[1]||(t[1]=e=>o.form.username=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),(0,l.bF)(v,{label:"手机号",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:o.form.phone,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,l.bF)(v,{label:"角色",prop:"roleId"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:o.form.roleId,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.roleId=e),placeholder:"请选择角色",style:{width:"100%"}},{default:(0,l.k6)((()=>[o.isSuperAdmin?((0,l.uX)(),(0,l.Wv)(w,{key:0,value:3,label:"超级管理员"})):(0,l.Q3)("",!0),(0,l.bF)(w,{value:2,label:"单位管理员"}),(0,l.bF)(w,{value:1,label:"基层员工"})])),_:1},8,["modelValue"])])),_:1}),3!==o.form.roleId?((0,l.uX)(),(0,l.Wv)(v,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:o.form.unitId,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"},disabled:!o.isSuperAdmin&&o.isEdit},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.units,(e=>((0,l.uX)(),(0,l.Wv)(w,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(v,{label:"密码",prop:o.isEdit?"":"password"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:o.form.password,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.password=e),placeholder:"请输入密码",type:"password","show-password":""},null,8,["modelValue"]),o.isEdit?((0,l.uX)(),(0,l.CE)("div",Ze,"不修改密码请留空")):((0,l.uX)(),(0,l.CE)("div",Ge,"所有账号必须设置密码"))])),_:1},8,["prop"])])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),t[16]||(t[16]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var at={name:"UserManagement",components:{ArrowLeft:D.nkM,Plus:D.FWt},setup(){const e=(0,s.rd)(),t=(0,f.KR)(!1),a=(0,f.KR)(!1),o=(0,f.KR)(!1),r=(0,f.KR)(!1),n=(0,f.KR)(null),i=(0,f.KR)([]),d=(0,f.KR)([]),u=(0,l.EW)((()=>ta.state.isLoggedIn&&3===ta.state.user.role_id)),c=(0,l.EW)((()=>ta.state.isLoggedIn?ta.state.user.unit_id:null)),p=(0,f.Kh)({id:null,username:"",phone:"",roleId:1,unitId:null,password:""}),m={username:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],unitId:[{required:!0,message:"请选择单位",trigger:"change"}],password:[{required:function(){return!r.value},message:"请输入密码",trigger:"blur"},{validator:(e,t,a)=>{t&&t.length>0?t.length<1||t.length>20?a(new Error("长度在 1 到 20 个字符")):a():r.value?a():a(new Error("请输入密码"))},trigger:"blur"}]},h=async()=>{t.value=!0;try{let e;e=u.value?await Mt.get(w.endpoints.users):await Mt.get(`${w.endpoints.units}/${c.value}/users`),i.value=e.data}catch(e){console.error("Error fetching users:",e),g.nk.error("获取用户列表失败")}finally{t.value=!1}},v=async()=>{try{const e=await Mt.get(w.endpoints.units);d.value=e.data}catch(e){console.error("Error fetching units:",e),g.nk.error("获取单位列表失败")}},b=()=>{r.value=!1,F(),o.value=!0,u.value||(p.unitId=c.value)},k=e=>{r.value=!0,p.id=e.id,p.username=e.username,p.phone=e.phone,p.roleId=e.role_id,p.unitId=e.unit_id,p.password="",o.value=!0},y=async e=>{try{await Mt.delete(`${w.endpoints.users}/${e.id}`),g.nk.success("用户删除成功"),h()}catch(t){console.error("Error deleting user:",t);let e="删除用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}},_=async e=>{const t=1===e.status?0:1,a=1===t?"恢复":"停用";try{await Mt.put(`${w.endpoints.users}/${e.id}/status`,{status:t}),g.nk.success(`用户${a}成功`),h()}catch(o){console.error("状态变更失败:",o);let e=`${a}用户失败`;o.response&&o.response.data&&o.response.data.error&&(e=o.response.data.error),g.nk.error(e)}},F=()=>{n.value&&n.value.resetFields(),p.id=null,p.username="",p.phone="",p.roleId=1,p.unitId=null,p.password=""},I=()=>{n.value.validate((async e=>{if(e){a.value=!0;try{const e={username:p.username,phone:p.phone,roleId:p.roleId,unitId:3!==p.roleId?p.unitId:null};p.password&&(e.password=p.password),r.value?(await Mt.put(`${w.endpoints.users}/${p.id}`,e),g.nk.success("用户更新成功")):(await Mt.post(w.endpoints.users,e),g.nk.success("用户添加成功")),o.value=!1,h()}catch(t){console.error("Error submitting user form:",t);let e=r.value?"更新用户失败":"添加用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}finally{a.value=!1}}else g.nk.warning("请完成必填项")}))},x=()=>{e.back()};return(0,l.sV)((()=>{h(),v()})),{loading:t,formLoading:a,dialogVisible:o,isEdit:r,userForm:n,users:i,units:d,form:p,rules:m,isSuperAdmin:u,currentUnitId:c,openAddDialog:b,handleEdit:k,handleDelete:y,handleStatusChange:_,submitForm:I,goBack:x}}};const ot=(0,x.A)(at,[["render",tt],["__scopeId","data-v-0176e750"]]);var lt=ot;const rt={class:"admin-records-container"},nt={class:"content"},st={class:"actions"},it={class:"filter-header"},dt={class:"filter-form-container"},ut={class:"quantity-range"},ct={class:"filter-actions"},pt={class:"records-wrapper"},mt={class:"card-header"},gt={class:"card-actions"},ft={key:0,class:"photo-preview"},ht=["onClick"],vt={key:0,class:"photo-count"},wt={key:1},bt={key:0,class:"photo-preview"},kt=["onClick"],yt={key:0,class:"photo-count"},_t={key:1},Ft={class:"operation-buttons"},It={key:0,class:"loading-more"},xt={key:1,class:"empty-block"};function Lt(e,t,a,r,n,s){const d=(0,l.g2)("plus"),u=(0,l.g2)("el-icon"),c=(0,l.g2)("el-button"),p=(0,l.g2)("user"),m=(0,l.g2)("refresh"),g=(0,l.g2)("arrow-down"),f=(0,l.g2)("arrow-up"),h=(0,l.g2)("el-option"),v=(0,l.g2)("el-select"),w=(0,l.g2)("el-form-item"),b=(0,l.g2)("el-col"),k=(0,l.g2)("el-date-picker"),y=(0,l.g2)("el-row"),_=(0,l.g2)("el-input"),F=(0,l.g2)("el-input-number"),I=(0,l.g2)("el-form"),x=(0,l.g2)("el-card"),L=(0,l.g2)("download"),R=(0,l.g2)("el-table-column"),C=(0,l.g2)("el-image"),T=(0,l.g2)("el-table"),V=(0,l.g2)("loading"),U=(0,l.g2)("el-empty"),K=(0,l.g2)("el-image-viewer"),W=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",rt,[t[21]||(t[21]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"固体废物管理系统历史记录")],-1)),(0,l.Lk)("div",nt,[(0,l.Lk)("div",st,[(0,l.bF)(c,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1}),t[9]||(t[9]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),(0,l.bF)(c,{type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[10]||(t[10]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"]),(0,l.bF)(c,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(m)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,l.bF)(x,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",it,[t[12]||(t[12]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(c,{type:"primary",link:"",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(u,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})):((0,l.uX)(),(0,l.Wv)(u,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",dt,[(0,l.bF)(I,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(b,{span:12},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"所属单位"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.unitId=e),placeholder:"选择单位",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(b,{span:12},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(y,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(b,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(b,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"产生工序"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:r.filterForm.processType,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.processType=e),placeholder:"选择产生工序",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[(0,l.bF)(h,{label:"作业现场",value:"作业现场"}),(0,l.bF)(h,{label:"清罐清理",value:"清罐清理"}),(0,l.bF)(h,{label:"报废清理",value:"报废清理"}),(0,l.bF)(h,{label:"管线刺漏",value:"管线刺漏"}),(0,l.bF)(h,{label:"历史遗留",value:"历史遗留"}),(0,l.bF)(h,{label:"日常维护",value:"日常维护"}),(0,l.bF)(h,{label:"封井退出",value:"封井退出"})])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(b,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"备注关键词"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.filterForm.remarksKeyword,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.remarksKeyword=e),placeholder:"输入关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(y,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(b,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ut,[(0,l.bF)(F,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"47%"}},null,8,["modelValue"]),t[13]||(t[13]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.bF)(F,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"47%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,l.bF)(b,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:r.filterForm.locationId,"onUpdate:modelValue":t[8]||(t[8]=e=>r.filterForm.locationId=e),placeholder:r.filterForm.unitId?"选择产生地点":"请先选择单位",style:{width:"100%"},clearable:"",filterable:"",disabled:!r.filterForm.unitId},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.locations,(e=>((0,l.uX)(),(0,l.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","placeholder","disabled"])])),_:1})])),_:1})])),_:1}),(0,l.Lk)("div",ct,[(0,l.bF)(c,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("筛选")]))),_:1},8,["onClick"]),(0,l.bF)(c,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[o.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",pt,[(0,l.bF)(x,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",mt,[t[17]||(t[17]=(0,l.Lk)("h3",{class:"table-title"},"所有废物记录",-1)),(0,l.Lk)("div",gt,[(0,l.bF)(c,{type:"warning",onClick:r.exportRecords},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(L)])),_:1}),t[16]||(t[16]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(T,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:r.tableHeight,onScroll:r.handleScroll},{default:(0,l.k6)((()=>[(0,l.bF)(R,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,l.bF)(R,{prop:"unit_name",label:"单位","min-width":"100"}),(0,l.bF)(R,{prop:"waste_type_name",label:"废物类型","min-width":"120"}),(0,l.bF)(R,{prop:"process_type",label:"产生工序","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.process_type||"无"),1)])),_:1}),(0,l.bF)(R,{prop:"remarks",label:"备注","min-width":"150"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,l.bF)(R,{prop:"location_name",label:"产生地点","min-width":"120"}),(0,l.bF)(R,{prop:"collection_start_time",label:"收集开始时间","min-width":"160"}),(0,l.bF)(R,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(parseFloat(e.row.quantity).toFixed(3)),1)])),_:1}),(0,l.bF)(R,{prop:"creator_name",label:"填报人","min-width":"100"}),(0,l.bF)(R,{prop:"created_at",label:"记录时间","min-width":"160"}),(0,l.bF)(R,{label:"现场照片（清理前）","min-width":"150",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",ft,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,l.bF)(C,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,ht)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",vt,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",wt,"无"))])),_:1}),(0,l.bF)(R,{label:"现场照片（清理后）","min-width":"150",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",bt,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,l.bF)(C,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,kt)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",yt,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",_t,"无"))])),_:1}),(0,l.bF)(R,{label:"操作","min-width":"120",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",Ft,[(0,l.bF)(c,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,l.bF)(c,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","height","onScroll"])),[[W,r.loading]]),r.loadingMore?((0,l.uX)(),(0,l.CE)("div",It,[(0,l.bF)(u,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(V)])),_:1}),t[20]||(t[20]=(0,l.eW)(" 加载更多... "))])):(0,l.Q3)("",!0),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",xt,[(0,l.bF)(U,{description:"暂无废物记录"})]))])),_:1})])]),t[22]||(t[22]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1)),r.showViewer?((0,l.uX)(),(0,l.Wv)(K,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}const Rt=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},Ct=(e,t)=>{if(!e.photos)return[];try{const a=JSON.parse(e.photos);return Array.isArray(a)?a.filter((e=>e.type===t)):[]}catch(a){return console.error("解析照片JSON失败:",a),[]}};var Tt={name:"AdminRecordsView",components:{Plus:D.FWt,Refresh:D.C42,User:D.KJW,ArrowDown:D.yd$,ArrowUp:D.DoI,Download:D.f5X,ElImageViewer:ve.Tg,Loading:D.Rhj},setup(){const e=(0,s.rd)(),t=(0,f.KR)([]),a=(0,f.KR)(!1),o=(0,f.KR)([]),r=(0,f.KR)([]),n=(0,f.KR)([]),i=(0,f.KR)(!0),d=w.baseURL,u=(0,f.KR)(750),c=()=>{const e=window.innerHeight,t=Math.max(.85*e,700);u.value=t},p=()=>{c()},m=(0,f.KR)(!1),v=(0,f.KR)([]),b=(0,f.KR)(0),k=(0,f.KR)(1),y=(0,f.KR)(20),_=(0,f.KR)(!0),F=(0,f.KR)(!1),I=(0,f.Kh)({unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,locationId:null,processType:null,remarksKeyword:null}),x=(0,l.EW)((()=>t.value.filter((e=>{if(I.unitId&&e.unit_id!==I.unitId)return!1;if(I.wasteTypeId&&e.waste_type_id!==I.wasteTypeId)return!1;if(null!==I.minQuantity&&parseFloat(e.quantity)<I.minQuantity)return!1;if(null!==I.maxQuantity&&parseFloat(e.quantity)>I.maxQuantity)return!1;if(I.locationId&&e.location_id!==I.locationId)return!1;if(I.dateRange&&2===I.dateRange.length){const t=new Date(I.dateRange[0]),a=new Date(I.dateRange[1]);if(a.setHours(23,59,59,999),!e.collection_start_time)return!1;{const o=L(e.collection_start_time);if(o<t||o>a)return!1}}return(!I.processType||e.process_type===I.processType)&&!(I.remarksKeyword&&!e.remarks.includes(I.remarksKeyword))})))),L=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)};(0,l.sV)((async()=>{if(!ta.state.isLoggedIn||3!==ta.state.user.role_id)return g.nk.error("权限不足"),void e.push("/login");c(),window.addEventListener("resize",p),await Promise.all([R(),C(),V()])})),(0,l.hi)((()=>{window.removeEventListener("resize",p)}));const R=async()=>{try{const e=await h.A.get(`${w.baseURL}${w.endpoints.units}`);o.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败，请刷新重试")}},C=async()=>{try{const e=await h.A.get(`${w.baseURL}${w.endpoints.wasteTypes}`);r.value=e.data}catch(e){console.error("获取废物类型失败:",e),g.nk.error("获取废物类型失败，请刷新重试")}},T=async e=>{try{if(!e)return void(n.value=[]);const t=await h.A.get(`${w.baseURL}${w.endpoints.locationsByUnit}/${e}`);n.value=t.data}catch(t){console.error("获取地点列表失败:",t),g.nk.error("获取地点列表失败，请刷新重试")}};(0,l.wB)((()=>I.unitId),(async e=>{I.locationId=null,e?await T(e):n.value=[]}));const V=async(e=!1)=>{e?F.value=!0:(a.value=!0,k.value=1);try{const a={page:k.value,pageSize:y.value,wasteTypeId:I.wasteTypeId,minQuantity:I.minQuantity,maxQuantity:I.maxQuantity,locationId:I.locationId,processType:I.processType,remarksKeyword:I.remarksKeyword};I.dateRange&&2===I.dateRange.length&&(a.dateRange=JSON.stringify(I.dateRange));const o=await h.A.get(`${w.getUrl(w.endpoints.wasteRecords)}/user/${ta.state.user.id}`,{params:a}),l=o.data.records.map((e=>({...e,created_at:U(e.created_at),collection_start_time:U(e.collection_start_time)})));t.value=e?[...t.value,...l]:l,_.value=o.data.hasMore,_.value&&k.value++}catch(o){console.error("获取废物记录失败:",o),g.nk.error("获取废物记录失败")}finally{a.value=!1,F.value=!1}},U=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})},K=()=>{V()},W=()=>{3===ta.state.user.role_id?e.push("/record/new"):e.push(`/unit/${ta.state.user.unit_id}`)},P=()=>{e.push("/user-management")},$=t=>{e.push(`/record/${t}`)},E=async()=>{await V(),g.nk.success("筛选已应用")},S=async()=>{I.unitId=null,I.dateRange=null,I.wasteTypeId=null,I.minQuantity=null,I.maxQuantity=null,I.locationId=null,I.processType=null,I.remarksKeyword=null,await V(),g.nk.info("筛选条件已重置")},A=async()=>{try{await we.s.confirm("请选择导出格式","导出选项",{confirmButtonText:"带图片导出",cancelButtonText:"不带图片导出",distinguishCancelAndClose:!0,type:"info"}).then((async()=>{await D()})).catch((e=>{"cancel"===e&&B()}))}catch(e){console.error("导出过程发生错误:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}},D=async()=>{try{(0,g.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=be.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:I.wasteTypeId?I.wasteTypeId:void 0,minQuantity:I.minQuantity?I.minQuantity:void 0,maxQuantity:I.maxQuantity?I.maxQuantity:void 0,locationId:I.locationId?I.locationId:void 0,dateRange:I.dateRange?JSON.stringify(I.dateRange):void 0,unitId:I.unitId?I.unitId:void 0,processType:I.processType?I.processType:void 0,remarksKeyword:I.remarksKeyword?I.remarksKeyword:void 0};console.log("导出记录的筛选条件:",t);const{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${ta.state.user.id}`,{params:t});if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return e.close(),g.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);e.setText(`准备导出 ${l.length} 条记录...`);const r=l.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process_type||"无","备注":e.remarks||"无","产生地点":e.location_name,"数量(kg)":e.quantity,"收集开始时间":U(e.collection_start_time),"填报人":e.creator_name||"系统","清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),n=I.unitId?o.value.find((e=>e.id===I.unitId))?.name||"未知单位":"全部单位",s=`固体废物记录_${n}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"产生地点",field:"产生地点"},{text:"数量(kg)",field:"数量(kg)"},{text:"收集开始时间",field:"收集开始时间"},{text:"填报人",field:"填报人"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],d=window.location.origin,u=(t,a)=>{const o=Math.round(t/a*100);e.setText(`正在导出：${o}% (${t}/${a})`)},c=await Ie(r,s,i,d,u);e.close(),c?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,be.Ks.service().close()}},B=async()=>{try{const e=be.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:I.wasteTypeId?I.wasteTypeId:void 0,minQuantity:I.minQuantity?I.minQuantity:void 0,maxQuantity:I.maxQuantity?I.maxQuantity:void 0,locationId:I.locationId?I.locationId:void 0,dateRange:I.dateRange?JSON.stringify(I.dateRange):void 0,unitId:I.unitId?I.unitId:void 0,processType:I.processType?I.processType:void 0,remarksKeyword:I.remarksKeyword?I.remarksKeyword:void 0},{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${ta.state.user.id}`,{params:t});if(0===l.length)return e.close(),g.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);e.setText(`准备导出 ${l.length} 条记录...`);const r=l.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process_type||"无","备注":e.remarks||"无","产生地点":e.location_name,"数量(kg)":e.quantity,"收集开始时间":U(e.collection_start_time),"填报人":e.creator_name||"系统","清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),n=I.unitId?o.value.find((e=>e.id===I.unitId))?.name||"未知单位":"全部单位",s=`固体废物记录_${n}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"产生地点",field:"产生地点"},{text:"数量(kg)",field:"数量(kg)"},{text:"收集开始时间",field:"收集开始时间"},{text:"填报人",field:"填报人"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],d=await xe(r,s,i);e.close(),d?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,be.Ks.service().close()}},X=e=>{we.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await h.A.delete(`${w.getUrl(w.endpoints.wasteRecords)}/${e.id}`),g.nk.success("删除成功"),await V()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败")}})).catch((()=>{g.nk.info("已取消删除")}))},Q=(e,t)=>{const a=Array.isArray(e)?e:[e];v.value=a.map((e=>`${d}${e}`)),b.value=t||0,m.value=!0},q=()=>{m.value=!1},M=async e=>{const t=e.target;t&&t.scrollHeight&&!F.value&&_.value&&t.scrollHeight-t.scrollTop-t.clientHeight<100&&await V(!0)},z=e=>(k.value-1)*y.value+e+1;return{records:t,filteredRecords:x,loading:a,units:o,wasteTypes:r,locations:n,showFilterPanel:i,filterForm:I,applyFilter:E,resetFilter:S,exportRecords:A,parsePhotoPath:Rt,getPhotosByType:Ct,refreshRecords:K,addNewRecord:W,goToUserManagement:P,editRecord:$,confirmDelete:X,showViewer:m,previewImages:v,previewIndex:b,previewPhoto:Q,closeViewer:q,baseUrl:d,page:k,pageSize:y,hasMore:_,loadingMore:F,handleScroll:M,indexMethod:z,tableHeight:u}}};const Vt=(0,x.A)(Tt,[["render",Lt],["__scopeId","data-v-3f8a8848"]]);var Ut=Vt;const Kt={class:"user-profile-container"},Wt={class:"header"},Pt={class:"content"};function $t(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),i=(0,l.g2)("el-icon"),d=(0,l.g2)("el-input"),u=(0,l.g2)("el-form-item"),c=(0,l.g2)("el-divider"),p=(0,l.g2)("el-button"),m=(0,l.g2)("el-form"),g=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",Kt,[(0,l.Lk)("div",Wt,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(i,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[6]||(t[6]=(0,l.eW)(" 返回 "))]),t[7]||(t[7]=(0,l.Lk)("h1",null,"个人账户设置",-1)),t[8]||(t[8]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Pt,[(0,l.bF)(g,{class:"profile-card"},{header:(0,l.k6)((()=>t[9]||(t[9]=[(0,l.Lk)("div",{class:"card-header"},[(0,l.Lk)("h3",null,"账户信息")],-1)]))),default:(0,l.k6)((()=>[(0,l.bF)(m,{ref:"profileForm",model:o.form,rules:o.rules,"label-position":"top",class:"profile-form"},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"手机号码"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.phone,"onUpdate:modelValue":t[1]||(t[1]=e=>o.form.phone=e),disabled:"",placeholder:"手机号码"},null,8,["modelValue"]),t[10]||(t[10]=(0,l.Lk)("div",{class:"field-hint"},"手机号码不可修改",-1))])),_:1}),(0,l.bF)(u,{label:"用户名",prop:"username"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.username,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.username=e),placeholder:"请输入您的名字"},null,8,["modelValue"])])),_:1}),(0,l.bF)(c,null,{default:(0,l.k6)((()=>t[11]||(t[11]=[(0,l.eW)("修改密码（可选）")]))),_:1}),(0,l.bF)(u,{label:"原密码",prop:"oldPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.oldPassword,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.oldPassword=e),placeholder:"请输入原密码",type:"password","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,{label:"新密码",prop:"newPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.newPassword,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.newPassword=e),placeholder:"请输入新密码",type:"password","show-password":""},null,8,["modelValue"]),t[12]||(t[12]=(0,l.Lk)("div",{class:"field-hint"},"如不修改密码，请留空",-1))])),_:1}),(0,l.bF)(u,{label:"确认新密码",prop:"confirmPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.confirmPassword,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.confirmPassword=e),placeholder:"请再次输入新密码",type:"password","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p,{type:"primary",onClick:o.saveProfile,loading:o.loading},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)(" 保存修改 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules"])])),_:1})])])}var Et={name:"UserProfile",setup(){const e=(0,s.rd)(),t=(0,f.KR)(null),a=(0,f.KR)(!1),o=(0,f.Kh)({username:"",phone:"",oldPassword:"",newPassword:"",confirmPassword:""}),r=(0,f.Kh)({username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度应为2-20个字符",trigger:"blur"}],oldPassword:[{required:function(){return o.newPassword||o.confirmPassword},message:"修改密码时需要输入原密码",trigger:"blur"}],newPassword:[{min:1,max:20,message:"密码长度应为1-20个字符",trigger:"blur"}],confirmPassword:[{validator:(e,t,a)=>{o.newPassword&&t!==o.newPassword?a(new Error("两次输入的密码不一致")):a()},trigger:"blur"}]});(0,l.sV)((()=>{if(!ta.state.isLoggedIn)return g.nk.error("请先登录"),void e.push("/login");o.username=ta.state.user.username||"",o.phone=ta.state.user.phone||""}));const n=()=>{e.go(-1)},i=async()=>{if(ta.state.isLoggedIn)try{await t.value.validate(),await we.s.confirm("确定要保存这些修改吗？","确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),a.value=!0;const e={username:o.username};o.newPassword&&(e.oldPassword=o.oldPassword,e.newPassword=o.newPassword),await Mt.put(w.getUrl(`/api/users/${ta.state.user.id}/profile`),e),ta.updateUserInfo({...ta.state.user,username:o.username}),g.nk.success("个人资料已更新"),o.oldPassword="",o.newPassword="",o.confirmPassword=""}catch(e){if("cancel"===e)return;e.response&&e.response.data&&e.response.data.error?g.nk.error(e.response.data.error):e.message?g.nk.error(e.message):g.nk.error("保存失败，请重试")}finally{a.value=!1}else g.nk.error("请先登录")};return{profileForm:t,form:o,rules:r,loading:a,goBack:n,saveProfile:i}}};const St=(0,x.A)(Et,[["render",$t],["__scopeId","data-v-72729246"]]);var At=St;const Dt=[{path:"/login",name:"Login",component:Ee,meta:{requiresAuth:!1}},{path:"/user-management",name:"UserManagement",component:lt,meta:{requiresAuth:!0,requiresManager:!0}},{path:"/profile",name:"UserProfile",component:At,meta:{requiresAuth:!0}},{path:"/",name:"UnitSelection",component:R,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/admin-records",name:"AdminRecords",component:Ut,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/record/new",name:"EditRecord",component:Oe,props:{id:null},meta:{requiresAuth:!0}},{path:"/record/:id",name:"EditRecord",component:Oe,props:!0,meta:{requiresAuth:!0}},{path:"/unit/:id",name:"WasteForm",component:M,props:!0,meta:{requiresAuth:!0}},{path:"/records/:unitId",name:"RecordsList",component:Te,props:!0,meta:{requiresAuth:!0}}],Bt=(0,s.aE)({history:(0,s.LA)("/"),routes:Dt});Bt.beforeEach(((e,t,a)=>{const o=e.matched.some((e=>e.meta.requiresAuth)),l=e.matched.some((e=>e.meta.requiresSuperAdmin)),r=e.matched.some((e=>e.meta.requiresManager));if(!o||ta.state.isLoggedIn)if(l&&ta.state.isLoggedIn&&3!==ta.state.user.role_id)a({name:"WasteForm",params:{id:ta.state.user.unit_id}});else if(r&&ta.state.isLoggedIn&&1===ta.state.user.role_id)a({name:"WasteForm",params:{id:ta.state.user.unit_id}});else{if("Login"!==e.name||!ta.state.isLoggedIn)return"/"===e.path&&ta.state.isLoggedIn?3===ta.state.user.role_id?void a({name:"AdminRecords"}):2===ta.state.user.role_id?void a({name:"RecordsList",params:{unitId:ta.state.user.unit_id}}):void a({name:"WasteForm",params:{id:ta.state.user.unit_id}}):void("WasteForm"===e.name&&ta.state.isLoggedIn&&3!==ta.state.user.role_id&&ta.state.user.unit_id!==parseInt(e.params.id)?a({name:"WasteForm",params:{id:ta.state.user.unit_id}}):a());3===ta.state.user.role_id?a({name:"AdminRecords"}):2===ta.state.user.role_id?a({name:"RecordsList",params:{unitId:ta.state.user.unit_id}}):a({name:"WasteForm",params:{id:ta.state.user.unit_id}})}else a({name:"Login"})}));var Xt=Bt;const Qt=h.A.create({baseURL:w.baseURL,timeout:3e5,headers:{"Content-Type":"application/json"},maxContentLength:52428800,maxBodyLength:52428800});Qt.interceptors.request.use((e=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return t&&(e.headers.Authorization=`Bearer ${t}`),e}),(e=>(console.error("Request error:",e),Promise.reject(e)))),Qt.interceptors.response.use((e=>e),(e=>{if(e.response)switch(e.response.status){case 401:if(e.config.url.includes("/api/login"))return Promise.reject(e);ta.logout(),g.nk.error("登录已过期，请重新登录"),Xt.push("/login");break;case 403:g.nk.error("没有权限访问该资源");break;case 404:g.nk.error("请求的资源不存在");break;case 500:g.nk.error("服务器错误，请稍后重试");break;default:g.nk.error(e.response.data?.error||"请求失败")}else e.request?g.nk.error("网络错误，请检查网络连接"):g.nk.error("请求配置错误");return Promise.reject(e)}));const qt={get(e,t={}){return Qt.get(e,{params:t})},post(e,t={}){return Qt.post(e,t)},postForm(e,t,a){const o={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};"function"===typeof a&&(o.onUploadProgress=a);const l=localStorage.getItem("token")||sessionStorage.getItem("token");return l&&(o.headers.Authorization=`Bearer ${l}`),Qt.post(e,t,o)},put(e,t={}){return Qt.put(e,t)},putForm(e,t,a){const o={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};"function"===typeof a&&(o.onUploadProgress=a);const l=localStorage.getItem("token")||sessionStorage.getItem("token");return l&&(o.headers.Authorization=`Bearer ${l}`),Qt.put(e,t,o)},delete(e){return Qt.delete(e)},defaults:Qt.defaults};var Mt=qt;const zt={user:null,token:null,isLoggedIn:!1,loading:!1,error:null},jt=(0,f.Kh)({...zt}),Ot=()=>{const e=localStorage.getItem("user"),t=localStorage.getItem("token");if(e&&t)try{const a=JSON.parse(e);jt.user=a,jt.token=t,jt.isLoggedIn=!0,Mt.defaults&&Mt.defaults.headers&&(Mt.defaults.headers.common["Authorization"]=`Bearer ${t}`)}catch(a){console.error("Error parsing saved user data:",a),localStorage.removeItem("user"),localStorage.removeItem("token")}},Nt=async(e,t,a=!1)=>{jt.loading=!0,jt.error=null,console.log("auth.login 开始执行，手机号:",e);try{const o={phone:e,rememberMe:a};null!==t&&void 0!==t&&""!==t?(o.password=t,console.log("auth.login 发送密码参数")):console.log("auth.login 不发送密码参数"),console.log("发送登录请求，数据:",o);const l=await Mt.post(w.endpoints.login,o);console.log("登录请求成功响应:",l.data);const{token:r,...n}=l.data;return jt.user=n,jt.token=r,jt.isLoggedIn=!0,Mt.defaults&&Mt.defaults.headers&&(Mt.defaults.headers.common["Authorization"]=`Bearer ${r}`),a?(localStorage.setItem("user",JSON.stringify(n)),localStorage.setItem("token",r)):(sessionStorage.setItem("user",JSON.stringify(n)),sessionStorage.setItem("token",r)),{success:!0,user:n}}catch(o){return jt.error=o.response?.data?.error||"登录失败，请检查网络连接",console.error("Login error:",o),{success:!1,error:jt.error}}finally{jt.loading=!1}},Ht=()=>{jt.user=null,jt.token=null,jt.isLoggedIn=!1,Mt.defaults&&Mt.defaults.headers&&delete Mt.defaults.headers.common["Authorization"],localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")},Yt=()=>jt.isLoggedIn&&jt.user&&3===jt.user.role_id,Jt=()=>jt.isLoggedIn&&jt.user&&2===jt.user.role_id,Gt=()=>jt.user?jt.user.id:null,Zt=()=>jt.user?jt.user.unit_id:null,ea=e=>{jt.isLoggedIn&&jt.user&&(jt.user={...jt.user,...e},localStorage.getItem("user")&&localStorage.setItem("user",JSON.stringify(jt.user)),sessionStorage.getItem("user")&&sessionStorage.setItem("user",JSON.stringify(jt.user)))};Ot();var ta={state:jt,login:Nt,logout:Ht,isAdmin:Yt,isUnitAdmin:Jt,getUserId:Gt,getUnitId:Zt,updateUserInfo:ea},aa={name:"AppHeader",setup(){const e=(0,s.rd)(),t=(0,l.EW)((()=>ta.state.isLoggedIn?ta.state.user.username||ta.state.user.phone:"")),a=()=>{ta.logout(),g.nk.success("已退出登录"),e.push("/login")},o=()=>{e.push("/profile")};return{auth:ta,userName:t,handleLogout:a,goToProfile:o}}};const oa=(0,x.A)(aa,[["render",m],["__scopeId","data-v-673ebfe5"]]);var la=oa,ra={components:{AppHeader:la},setup(){const e=(0,s.lq)(),t=(0,l.EW)((()=>"/login"!==e.path));return{showHeader:t}}};const na=(0,x.A)(ra,[["render",n]]);var sa=na,ia=a(6070),da=(a(4188),a(5186));const ua=(0,o.Ef)(sa);ua.use(Xt),ua.use(ia.A,{locale:da.A}),ua.mount("#app")}},t={};function a(o){var l=t[o];if(void 0!==l)return l.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,a),r.exports}a.m=e,function(){var e=[];a.O=function(t,o,l,r){if(!o){var n=1/0;for(u=0;u<e.length;u++){o=e[u][0],l=e[u][1],r=e[u][2];for(var s=!0,i=0;i<o.length;i++)(!1&r||n>=r)&&Object.keys(a.O).every((function(e){return a.O[e](o[i])}))?o.splice(i--,1):(s=!1,r<n&&(n=r));if(s){e.splice(u--,1);var d=l();void 0!==d&&(t=d)}}return t}r=r||0;for(var u=e.length;u>0&&e[u-1][2]>r;u--)e[u]=e[u-1];e[u]=[o,l,r]}}(),function(){a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,{a:t}),t}}(),function(){a.d=function(e,t){for(var o in t)a.o(t,o)&&!a.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};a.O.j=function(t){return 0===e[t]};var t=function(t,o){var l,r,n=o[0],s=o[1],i=o[2],d=0;if(n.some((function(t){return 0!==e[t]}))){for(l in s)a.o(s,l)&&(a.m[l]=s[l]);if(i)var u=i(a)}for(t&&t(o);d<n.length;d++)r=n[d],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return a.O(u)},o=self["webpackChunkhazardous_waste_management_frontend"]=self["webpackChunkhazardous_waste_management_frontend"]||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))}();var o=a.O(void 0,[504],(function(){return a(632)}));o=a.O(o)})();
//# sourceMappingURL=app.4867a0f1.js.map