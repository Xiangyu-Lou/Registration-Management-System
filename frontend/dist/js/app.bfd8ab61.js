(function(){"use strict";var e={5762:function(e,t,a){var o=a(5130),l=a(6768);const r={id:"app"};function n(e,t,a,o,n,s){const i=(0,l.g2)("app-header"),d=(0,l.g2)("router-view");return(0,l.uX)(),(0,l.CE)("div",r,[o.showHeader?((0,l.uX)(),(0,l.Wv)(i,{key:0})):(0,l.Q3)("",!0),(0,l.bF)(d)])}var s=a(1387),i=a(4232);const d={class:"app-header"},u={key:0,class:"user-info"},c={class:"welcome-text"},p={key:0,class:"company-tag"},m={key:1,class:"unit-tag"},g={class:"dialog-footer"};function f(e,t,a,r,n,s){const f=(0,l.g2)("chat-line-round"),k=(0,l.g2)("el-icon"),v=(0,l.g2)("el-button"),h=(0,l.g2)("user"),b=(0,l.g2)("el-option"),y=(0,l.g2)("el-select"),w=(0,l.g2)("el-form-item"),_=(0,l.g2)("el-input"),F=(0,l.g2)("el-form"),L=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",d,[t[12]||(t[12]=(0,l.Lk)("div",{class:"logo"},[(0,l.Lk)("h1",null,"固体废物管理系统")],-1)),r.auth.state.isLoggedIn?((0,l.uX)(),(0,l.CE)("div",u,[(0,l.Lk)("span",c,[t[5]||(t[5]=(0,l.eW)(" 欢迎, ")),(0,l.Lk)("strong",null,(0,i.v_)(r.userName),1),r.auth.state.user.company_name?((0,l.uX)(),(0,l.CE)("span",p,(0,i.v_)(r.auth.state.user.company_name),1)):(0,l.Q3)("",!0),r.auth.state.user.unit_name?((0,l.uX)(),(0,l.CE)("span",m,(0,i.v_)(r.auth.state.user.unit_name),1)):(0,l.Q3)("",!0)]),(0,l.bF)(v,{type:"text",class:"feedback-button",onClick:r.showFeedbackDialog},{default:(0,l.k6)((()=>[(0,l.bF)(k,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}),t[6]||(t[6]=(0,l.eW)(" 问题反馈 "))])),_:1},8,["onClick"]),(0,l.bF)(v,{type:"text",class:"profile-button",onClick:r.goToProfile},{default:(0,l.k6)((()=>[(0,l.bF)(k,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1}),t[7]||(t[7]=(0,l.eW)(" 账号设置 "))])),_:1},8,["onClick"]),(0,l.bF)(v,{type:"text",class:"logout-button",onClick:r.handleLogout},{default:(0,l.k6)((()=>t[8]||(t[8]=[(0,l.eW)(" 退出登录 ")]))),_:1},8,["onClick"])])):(0,l.Q3)("",!0),(0,l.bF)(L,{modelValue:r.feedbackVisible,"onUpdate:modelValue":t[4]||(t[4]=e=>r.feedbackVisible=e),title:"问题反馈",width:"600px","close-on-click-modal":!1,onClose:r.closeFeedbackDialog},{footer:(0,l.k6)((()=>[(0,l.Lk)("div",g,[(0,l.bF)(v,{onClick:r.resetForm},{default:(0,l.k6)((()=>t[9]||(t[9]=[(0,l.eW)("重置")]))),_:1},8,["onClick"]),(0,l.bF)(v,{onClick:r.closeFeedbackDialog},{default:(0,l.k6)((()=>t[10]||(t[10]=[(0,l.eW)("取消")]))),_:1},8,["onClick"]),(0,l.bF)(v,{type:"primary",onClick:r.submitForm,loading:r.loading},{default:(0,l.k6)((()=>t[11]||(t[11]=[(0,l.eW)(" 提交反馈 ")]))),_:1},8,["onClick","loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(F,{ref:"formRef",model:r.form,rules:r.rules,"label-width":"100px",onSubmit:(0,o.D$)(r.submitForm,["prevent"])},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"问题类型",prop:"type"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:r.form.type,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.type=e),placeholder:"请选择问题类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"系统漏洞",value:"bug"}),(0,l.bF)(b,{label:"功能建议",value:"feature"}),(0,l.bF)(b,{label:"体验改进",value:"improvement"}),(0,l.bF)(b,{label:"其他问题",value:"other"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(w,{label:"优先级",prop:"priority"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:r.form.priority,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.priority=e),placeholder:"请选择优先级",style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"低",value:"low"}),(0,l.bF)(b,{label:"中",value:"medium"}),(0,l.bF)(b,{label:"高",value:"high"}),(0,l.bF)(b,{label:"紧急",value:"urgent"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(w,{label:"问题标题",prop:"title"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.form.title,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.title=e),placeholder:"请简要描述问题"},null,8,["modelValue"])])),_:1}),(0,l.bF)(w,{label:"问题描述",prop:"description"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.form.description,"onUpdate:modelValue":t[3]||(t[3]=e=>r.form.description=e),type:"textarea",rows:6,placeholder:"请详细描述遇到的问题，包括出现的情况、预期的结果等"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules","onSubmit"])])),_:1},8,["modelValue","onClose"])])}var k=a(144),v=a(1219),h=a(2933),b=a(7477),y=a(4373);const w="";var _={baseURL:w,endpoints:{login:"/api/login",users:"/api/users",usersByUnit:"/api/users/unit",userStatus:"/api/users/:id/status",userProfile:"/api/users/:id/profile",units:"/api/units",wasteTypes:"/api/waste-types",wasteRecords:"/api/waste-records",wasteRecordsByUnit:"/api/waste-records",wasteRecordDetail:"/api/waste-records/detail",wasteRecordsByUser:"/api/waste-records/user",exportWasteRecords:"/api/waste-records/export/user",operationLogs:"/api/operation-logs",operationLogStats:"/api/operation-logs/stats",operationLogUserStats:"/api/operation-logs/user-stats",exportOperationLogs:"/api/operation-logs/export",userLogPermission:"/api/users/:id/log-permission",companies:"/api/companies",companyById:"/api/companies/:id",companyStats:"/api/companies/:id/stats",feedback:"/api/feedback",userFeedbacks:"/api/feedback/user",adminFeedbacks:"/api/feedback/admin",feedbackStats:"/api/feedback/stats",feedbackById:"/api/feedback/:id",feedbackStatus:"/api/feedback/:id/status"},getUrl(e){return`${this.baseURL}${e}`}};const F={class:"unit-selection-container"},L={class:"content"},x={class:"units-grid"},C={class:"unit-name"};function I(e,t,a,o,r,n){const s=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",F,[t[1]||(t[1]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"固体废物管理系统")],-1)),(0,l.Lk)("div",L,[t[0]||(t[0]=(0,l.Lk)("h2",null,"请选择您的单位",-1)),(0,l.Lk)("div",x,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(s,{key:e.id,class:"unit-card",shadow:"hover",onClick:t=>n.selectUnit(e)},{default:(0,l.k6)((()=>[(0,l.Lk)("div",C,(0,i.v_)(e.name),1)])),_:2},1032,["onClick"])))),128))])]),t[2]||(t[2]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var R={name:"UnitSelection",data(){return{units:[],loading:!1}},created(){this.fetchUnits()},methods:{async fetchUnits(){this.loading=!0;try{console.log("正在获取单位列表...");const e=await dr.get(_.endpoints.units);console.log("获取单位列表成功:",e.data);let t=e.data;if(xr.isSupervisor()){const e=xr.getCompanyId();this.units=t.filter((t=>t.company_id===e)),console.log("监督人员过滤后的单位列表:",this.units)}else this.units=t}catch(e){console.error("获取单位列表失败:",e),v.nk.error("获取单位列表失败")}finally{this.loading=!1}},selectUnit(e){this.$router.push({name:"WasteForm",params:{id:e.id}})}}},$=a(1241);const W=(0,$.A)(R,[["render",I],["__scopeId","data-v-0d968d53"]]);var V=W;const T={class:"waste-form-container"},S={class:"header"},E={key:1},P={class:"content"},K={class:"unit-info"},U={class:"location-section"},A={class:"location-controls"},D={key:0,class:"location-tip"},X={key:1,class:"location-tip"},Q={key:0,class:"location-info"},M={class:"location-item"},B={key:0,class:"location-item"},q={key:1,class:"location-error"},z={class:"form-row"},N={key:0,class:"upload-warning"},O={class:"form-actions"},j={class:"upload-progress"},H={class:"upload-status"};function Y(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("document"),c=(0,l.g2)("el-option"),p=(0,l.g2)("el-select"),m=(0,l.g2)("el-form-item"),g=(0,l.g2)("el-input"),f=(0,l.g2)("el-button"),k=(0,l.g2)("el-tag"),v=(0,l.g2)("el-alert"),h=(0,l.g2)("el-date-picker"),b=(0,l.g2)("clock"),y=(0,l.g2)("el-time-picker"),w=(0,l.g2)("el-input-number"),_=(0,l.g2)("plus"),F=(0,l.g2)("el-upload"),L=(0,l.g2)("el-form"),x=(0,l.g2)("el-progress"),C=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",T,[(0,l.Lk)("div",S,[o.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 返回 "))])):((0,l.uX)(),(0,l.CE)("div",E)),t[15]||(t[15]=(0,l.Lk)("h1",null,"固体废物填报",-1)),(0,l.Lk)("div",{class:"view-records",onClick:t[1]||(t[1]=(...e)=>o.viewRecords&&o.viewRecords(...e))},[t[14]||(t[14]=(0,l.eW)(" 查看记录 ")),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1})])]),(0,l.Lk)("div",P,[(0,l.Lk)("div",K,[(0,l.Lk)("h2",null,(0,i.v_)(o.unitName),1)]),(0,l.bF)(L,{ref:"wasteForm",model:o.form,rules:o.rules,"label-position":"top",class:"waste-form"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"产生工序",prop:"process"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.process,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.process=e),placeholder:"请选择产生工序",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.processOptions,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===o.form.process?((0,l.uX)(),(0,l.Wv)(g,{key:0,modelValue:o.customProcess,"onUpdate:modelValue":t[4]||(t[4]=e=>o.customProcess=e),placeholder:"请输入具体产生工序",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(m,{label:"产生地点",prop:"location"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.location,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.location=e),placeholder:"请选择废物产生地点",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.locationOptions,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===o.form.location?((0,l.uX)(),(0,l.Wv)(g,{key:0,modelValue:o.customLocation,"onUpdate:modelValue":t[6]||(t[6]=e=>o.customLocation=e),placeholder:"请输入具体产生地点",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(m,{label:"地理位置"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",U,[(0,l.Lk)("div",A,[(0,l.bF)(f,{type:"primary",icon:o.Location,loading:o.locationLoading,onClick:o.getCurrentLocation,disabled:!o.isLocationSupported},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.locationLoading?"获取中...":"获取当前位置"),1)])),_:1},8,["icon","loading","onClick","disabled"]),o.isLocationSupported?o.isSecureContext?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("span",X," 需要HTTPS环境才能获取位置 ")):((0,l.uX)(),(0,l.CE)("span",D," 当前环境不支持位置获取 "))]),o.locationInfo.success?((0,l.uX)(),(0,l.CE)("div",Q,[(0,l.Lk)("div",M,[(0,l.bF)(k,{type:"success",size:"small"},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)("坐标")]))),_:1}),(0,l.Lk)("span",null,(0,i.v_)(o.formatCoordinates(o.locationInfo.longitude,o.locationInfo.latitude)),1)]),o.locationInfo.address?((0,l.uX)(),(0,l.CE)("div",B,[(0,l.bF)(k,{type:"info",size:"small"},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("地址")]))),_:1}),(0,l.Lk)("span",null,(0,i.v_)(o.formatAddress(o.locationInfo)),1)])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0),o.locationError?((0,l.uX)(),(0,l.CE)("div",q,[(0,l.bF)(v,{title:o.locationError,type:"warning",closable:!1,"show-icon":"",size:"small"},null,8,["title"])])):(0,l.Q3)("",!0)])])),_:1}),(0,l.bF)(m,{label:"备注",prop:"remarks"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:o.form.remarks,"onUpdate:modelValue":t[7]||(t[7]=e=>o.form.remarks=e),type:"textarea",rows:1,placeholder:"请输入备注信息（选填）"},null,8,["modelValue"])])),_:1}),(0,l.Lk)("div",z,[(0,l.bF)(m,{label:"收集日期",class:"date-item"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:o.form.collectionDate,"onUpdate:modelValue":t[8]||(t[8]=e=>o.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,"popper-class":"date-picker-popup",teleported:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"收集时间",class:"time-item"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:o.form.collectionTime,"onUpdate:modelValue":t[9]||(t[9]=e=>o.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"},editable:!1,"popper-class":"time-picker-popup",teleported:!1},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(b)])),_:1})])),_:1},8,["modelValue"])])),_:1})]),(0,l.bF)(m,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:o.form.quantity,"onUpdate:modelValue":t[10]||(t[10]=e=>o.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"},onFocus:t[11]||(t[11]=e=>o.selectAllText(e)),"input-props":{inputmode:"decimal",pattern:"[0-9]*[.,]?[0-9]*"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集前）",prop:"photo_before"},{default:(0,l.k6)((()=>[t[18]||(t[18]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),o.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",N,[(0,l.bF)(v,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(F,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoBeforeChange,"on-remove":o.handlePhotoBeforeRemove,"file-list":o.fileListBefore,limit:5,multiple:"","list-type":"picture-card","before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(_)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集后）",prop:"photo_after"},{default:(0,l.k6)((()=>[t[19]||(t[19]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(F,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoAfterChange,"on-remove":o.handlePhotoAfterRemove,"file-list":o.fileListAfter,limit:5,multiple:"","list-type":"picture-card","before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(_)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.Lk)("div",O,[(0,l.bF)(f,{type:"primary",class:"submit-btn",onClick:o.submitForm,loading:o.loading},{default:(0,l.k6)((()=>t[20]||(t[20]=[(0,l.eW)("提交")]))),_:1},8,["onClick","loading"]),(0,l.bF)(f,{class:"reset-btn",onClick:o.resetForm},{default:(0,l.k6)((()=>t[21]||(t[21]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model","rules"])]),(0,l.bF)(C,{modelValue:o.showUploadProgress,"onUpdate:modelValue":t[12]||(t[12]=e=>o.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",j,[t[22]||(t[22]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(x,{percentage:o.uploadPercentage,format:o.percentageFormat,status:100===o.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",H,(0,i.v_)(o.uploadStatus),1)])])),_:1},8,["modelValue"]),t[23]||(t[23]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var J=a(9372),G=a.n(J);const Z={key:"ce824eb86be2c05e696310234e310b20",securityKey:"ab849a6b9b76caadab4f82a5fbe282e8",serviceHost:"https://restapi.amap.com"},ee=()=>new Promise(((e,t)=>{if(!navigator.geolocation)return void t(new Error("当前浏览器不支持地理定位功能"));const a={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition((async t=>{const{latitude:a,longitude:o}=t.coords;try{const t=await te(a,o);e({success:!0,longitude:t.longitude,latitude:t.latitude,address:t.address,district:t.district,city:t.city,province:t.province})}catch(l){console.warn("地址解析失败，仅保存坐标信息:",l);try{const t=`${Z.serviceHost}/v3/assistant/coordinate/convert`,l=new URLSearchParams({key:Z.key,locations:`${o},${a}`,coordsys:"gps"}),r=await fetch(`${t}?${l}`),n=await r.json();let s=o,i=a;if("1"===n.status&&n.locations){const[e,t]=n.locations.split(",");s=parseFloat(e),i=parseFloat(t)}e({success:!0,longitude:s,latitude:i,address:"",district:"",city:"",province:""})}catch(r){console.warn("坐标转换也失败，使用原始GPS坐标:",r),e({success:!0,longitude:o,latitude:a,address:"",district:"",city:"",province:""})}}}),(e=>{let a="获取位置失败";switch(e.code){case e.PERMISSION_DENIED:a="用户拒绝了位置访问请求";break;case e.POSITION_UNAVAILABLE:a="位置信息不可用";break;case e.TIMEOUT:a="获取位置超时，请检查网络连接";break;default:a=`位置获取失败：${e.message}`;break}t(new Error(a))}),a)})),te=async(e,t)=>{try{const a=`${Z.serviceHost}/v3/assistant/coordinate/convert`,o=new URLSearchParams({key:Z.key,locations:`${t},${e}`,coordsys:"gps"}),l=await fetch(`${a}?${o}`),r=await l.json();let n=t,s=e;if("1"===r.status&&r.locations){const[e,t]=r.locations.split(",");n=parseFloat(e),s=parseFloat(t)}const i=`${Z.serviceHost}/v3/geocode/regeo`,d=new URLSearchParams({key:Z.key,location:`${n},${s}`,extensions:"all"}),u=await fetch(`${i}?${d}`),c=await u.json();let p={longitude:n,latitude:s,address:"",district:"",city:"",province:""};if("1"===c.status&&c.regeocode){const e=c.regeocode,t=e.addressComponent;p={longitude:n,latitude:s,address:e.formatted_address||"",district:t.district||"",city:t.city||t.province||"",province:t.province||""}}return p}catch(a){return console.warn("地址解析失败:",a),{longitude:t,latitude:e,address:"",district:"",city:"",province:""}}},ae=()=>"geolocation"in navigator,oe=()=>window.isSecureContext||"localhost"===window.location.hostname,le=(e,t)=>{if(!e||!t)return"位置信息未获取";const a=parseFloat(e),o=parseFloat(t);return isNaN(a)||isNaN(o)?"坐标格式错误":`${o.toFixed(6)}, ${a.toFixed(6)}`},re=e=>{if(!e)return"地址信息未获取";const{province:t,city:a,district:o,address:l}=e;if(l)return l;const r=[t,a,o].filter((e=>e&&e.trim()));return r.length>0?r.join(""):"地址解析失败"};var ne={name:"WasteForm",components:{ArrowLeft:b.nkM,Document:b.yoT,Plus:b.FWt,Clock:b.zD7},props:{id:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),a=(0,k.KR)(null),o=(0,k.KR)(!1),r=(0,k.KR)(""),n=(0,k.KR)([]),i=(0,k.KR)([]),d=(0,k.KR)([]),u=(0,k.KR)([]),c=(0,k.KR)([]),p=(0,k.KR)(!1),m=(0,k.KR)(0),g=(0,k.KR)("准备上传..."),f=(0,k.KR)(!1),h=(0,k.KR)([]),y=(0,k.KR)(""),w=(0,k.KR)(""),F=["作业现场","清罐清理","报废清理","管线刺漏","历史遗留","日常维护","封井退出","其他"],L=(0,k.KR)(!1),x=(0,k.KR)({success:!1,longitude:null,latitude:null,address:"",district:"",city:"",province:""}),C=(0,k.KR)(""),I={"桓台":["金家接转站","金17-1注采站","金17-2注采站","金6金9项目组","金8注采站","其他"],"潍北":["潍北联合站","昌79注采站","昌3注采站","疃3注采站","昌15注采站","其他"],"高青":["高青联合站","樊107注采站","樊14注采站","高21注采站","高54注采站","其他"],"牛庄":["牛25集输站","牛25注采站","营13注采站","史112注采站","其他"],"金角":["长堤注采站","桩23注采站","其他"],"信远":["河125注采站","河122注采站","永551注采站","其他"],"滨博":["樊142注采站","樊142-2-12注采站","樊162注采站","樊页1井组","滨博接转站","其他"],"无棣":["车41注采站","车142注采站","车40注采站","车408注采站","车274注采站","车1接转站","东风港联合站","其他"],"河口":["沾14东注采站","沾14西注采站","渤南注采站","大北注采站","沾5注采站","太平接转站","沾5接转站","其他"],"胜兴":["博兴注采站","其他"],"胜科管理区":["采油一站","其他"],"其他":["其他"]},R=(0,l.EW)((()=>xr.state.isLoggedIn&&(3===xr.state.user.role_id||4===xr.state.user.role_id))),$=(0,k.Kh)({wasteTypeId:"",location:"",collectionDate:(new Date).toISOString().slice(0,10),collectionTime:(new Date).toTimeString().slice(0,5),quantity:void 0,photo_before:[],photo_after:[],remarks:"",process:""}),W={wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],process:[{required:!0,message:"请选择产生工序",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||w.value.trim()?a():a(new Error("请输入具体产生工序"))},trigger:"blur"}],location:[{required:!0,message:"请选择废物产生地点",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||y.value.trim()?a():a(new Error("请输入具体产生地点"))},trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!1,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{const e=document.createElement("meta");e.setAttribute("name","viewport"),e.setAttribute("content","width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1"),document.head.appendChild(e);const t=document.querySelector('meta[name="viewport"]');t&&t!==e&&t.remove(),await V(),await T(),ae()&&oe()&&S()})),(0,l.xo)((()=>{const e=document.querySelector('meta[name="viewport"]');e&&e.remove();const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width,initial-scale=1.0"),document.head.appendChild(t)}));const V=async()=>{try{const a=await dr.get(_.endpoints.units);let o=a.data;if(xr.isSupervisor()){const e=xr.getCompanyId();o=o.filter((t=>t.company_id===e))}const l=o.find((t=>t.id===parseInt(e.id)));l?(r.value=l.name,I[r.value]?h.value=I[r.value]:(h.value=[],console.warn(`未找到管理区 "${r.value}" 的地点选项`))):xr.isSupervisor()&&(v.nk.error("无权访问该单位，请联系管理员"),t.push({name:"UnitSelection"}))}catch(a){console.error("Error fetching unit name:",a),v.nk.error("获取单位信息失败")}},T=async()=>{try{const e=await dr.get(_.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),v.nk.error("获取废物类型失败")}},S=async()=>{if(!L.value){L.value=!0,C.value="";try{const e=await ee();x.value=e,console.log("位置获取成功:",e)}catch(e){C.value=e.message,console.error("位置获取失败:",e)}finally{L.value=!1}}},E=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return v.nk.error("只能上传图片文件!"),!1;const o=52428800;return e.size>o?(v.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{p.value=!0,g.value="正在处理图片...",m.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(G())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,g.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,g.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),g.value="图片处理完成",m.value=100,setTimeout((()=>{p.value=!1}),500),t(l)},error(a){console.error("图片压缩失败:",a),g.value="处理失败，使用原始图片",m.value=100,setTimeout((()=>{p.value=!1}),500),t(e)}})}))},P=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),u.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){p.value=!0,g.value="正在处理图片...",m.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(G())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,g.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,g.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),g.value="图片处理完成",m.value=100,t(l)},error(a){console.error("图片压缩失败:",a),g.value="处理失败，使用原始图片",m.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=i.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?i.value[a]=t:i.value.push(t);const o=u.value.findIndex((t=>t.uid===e.uid));o>=0&&(u.value[o].processed=!0),setTimeout((()=>{p.value=!1}),500)}catch(o){console.error("处理图片时出错:",o),v.nk.warning("图片处理失败，将使用原始图片");const t=i.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?i.value[t]=e.raw:i.value.push(e.raw),p.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const a=[...i.value,...d.value];f.value=D(a),console.log("更新后的photoFilesBefore:",i.value),console.log("更新后的fileListBefore:",u.value)},K=(e,t)=>{console.log("收集前照片移除:",e),u.value=t,e.raw?i.value=i.value.filter((t=>t.name!==e.raw.name)):i.value=i.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),D([...i.value,...d.value])||(f.value=!1),console.log("更新后的photoFilesBefore:",i.value)},U=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){p.value=!0,g.value="正在处理图片...",m.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(G())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,g.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,g.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),g.value="图片处理完成",m.value=100,t(l)},error(a){console.error("图片压缩失败:",a),g.value="处理失败，使用原始图片",m.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=d.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?d.value[a]=t:d.value.push(t);const o=c.value.findIndex((t=>t.uid===e.uid));o>=0&&(c.value[o].processed=!0),setTimeout((()=>{p.value=!1}),500)}catch(o){console.error("处理图片时出错:",o),v.nk.warning("图片处理失败，将使用原始图片");const t=d.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?d.value[t]=e.raw:d.value.push(e.raw),p.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const a=[...i.value,...d.value];f.value=D(a),console.log("更新后的photoFilesAfter:",d.value),console.log("更新后的fileListAfter:",c.value)},A=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,e.raw?d.value=d.value.filter((t=>t.name!==e.raw.name)):d.value=d.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),D([...i.value,...d.value])||(f.value=!1),console.log("更新后的photoFilesAfter:",d.value)},D=e=>{const t=5242880;return e.some((e=>e.size>t))},X=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);m.value=t,g.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},Q=e=>100===e?"完成":`${e}%`,M=()=>{a.value.validate((async a=>{if(a){o.value=!0;try{const a=new FormData;a.append("unitId",e.id),a.append("wasteTypeId",$.wasteTypeId),"其他"===$.process&&w.value.trim()?a.append("process",w.value.trim()):a.append("process",$.process),"其他"===$.location&&y.value.trim()?a.append("location",y.value.trim()):a.append("location",$.location),$.collectionDate&&$.collectionTime&&(a.append("collectionDate",$.collectionDate),a.append("collectionTime",$.collectionTime)),void 0!==$.quantity&&null!==$.quantity&&""!==$.quantity&&a.append("quantity",$.quantity),a.append("remarks",$.remarks||""),x.value.success&&(x.value.longitude&&a.append("longitude",x.value.longitude),x.value.latitude&&a.append("latitude",x.value.latitude),x.value.address&&a.append("address",x.value.address),x.value.district&&a.append("district",x.value.district),x.value.city&&a.append("city",x.value.city),x.value.province&&a.append("province",x.value.province)),xr.state.isLoggedIn&&xr.state.user?(a.append("creator_id",xr.state.user.id),console.log("添加用户信息:",{creator_id:xr.state.user.id,user:xr.state.user})):console.log("用户未登录或用户信息不完整"),console.log("提交表单数据:",{unitId:e.id,wasteTypeId:$.wasteTypeId,process:"其他"===$.process?w.value:$.process,location:"其他"===$.location?y.value:$.location,quantity:$.quantity,remarks:$.remarks||"",photo_before:i.value?i.value.length:0,photo_after:d.value?d.value.length:0}),i.value&&i.value.length>0&&(console.log("添加收集前照片数量:",i.value.length),i.value.forEach(((e,t)=>{e&&(console.log(`收集前照片 ${t+1}:`,e.name),a.append("photo_before",e))}))),d.value&&d.value.length>0&&(console.log("添加收集后照片数量:",d.value.length),d.value.forEach(((e,t)=>{e&&(console.log(`收集后照片 ${t+1}:`,e.name),a.append("photo_after",e))})));const o=[...i.value||[],...d.value||[]];f.value=D(o),o.length>0&&(p.value=!0,m.value=0,g.value="准备上传...");const l=await dr.postForm(_.endpoints.wasteRecords,a,X);console.log("提交响应:",l.data),v.nk.success("废物记录提交成功！正在跳转到记录列表..."),B(),setTimeout((()=>{if(xr.state.isLoggedIn&&xr.state.user){const a=xr.state.user.role_id;3===a||4===a?t.push("/admin-records"):t.push({name:"RecordsList",params:{unitId:e.id}})}else t.push({name:"RecordsList",params:{unitId:e.id}})}),1500)}catch(l){console.error("Error submitting form:",l),l.response&&(console.error("错误响应数据:",l.response.data),console.error("错误状态码:",l.response.status)),v.nk.error("提交失败，请稍后再试")}finally{o.value=!1,p.value=!1}}else v.nk.warning("请完成必填项")}))},B=()=>{a.value&&a.value.resetFields(),$.wasteTypeId="",$.location="",$.process="",$.remarks="",$.quantity=void 0,$.collectionDate=(new Date).toISOString().slice(0,10),$.collectionTime=(new Date).toTimeString().slice(0,5),y.value="",w.value="",i.value=[],d.value=[],u.value=[],c.value=[],f.value=!1},q=()=>{R.value&&t.push("/")},z=()=>{t.push({name:"RecordsList",params:{unitId:e.id}})},N=e=>{setTimeout((()=>{if(e&&e.target){const t=e.target.querySelector("input");t&&t.select()}}),10)};return{form:$,rules:W,wasteForm:a,loading:o,unitName:r,wasteTypes:n,isAdmin:R,fileListBefore:u,fileListAfter:c,handlePhotoBeforeChange:P,handlePhotoBeforeRemove:K,handlePhotoAfterChange:U,handlePhotoAfterRemove:A,handleBeforeUpload:E,submitForm:M,resetForm:B,goBack:q,viewRecords:z,selectAllText:N,showUploadProgress:p,uploadPercentage:m,uploadStatus:g,percentageFormat:Q,showLargeFileWarning:f,locationOptions:h,customLocation:y,customProcess:w,processOptions:F,locationLoading:L,locationInfo:x,locationError:C,getCurrentLocation:S,isLocationSupported:ae,isSecureContext:oe,formatCoordinates:le,formatAddress:re,Location:b.aZn}}};const se=(0,$.A)(ne,[["render",Y],["__scopeId","data-v-5a80faa1"]]);var ie=se;const de={class:"records-container"},ue={class:"header"},ce={key:1},pe={class:"content"},me={class:"unit-info"},ge={class:"actions"},fe={class:"filter-header"},ke={class:"filter-form-container"},ve={class:"quantity-range"},he={class:"input-with-clear"},be={class:"input-with-clear"},ye={class:"filter-actions"},we={class:"records-wrapper"},_e={class:"card-header"},Fe={class:"card-actions"},Le={key:0,class:"location-info-cell"},xe={key:0,class:"photo-preview"},Ce=["onClick"],Ie={key:0,class:"photo-count"},Re={key:1},$e={key:0,class:"photo-preview"},We=["onClick"],Ve={key:0,class:"photo-count"},Te={key:1},Se={class:"operation-buttons"},Ee={key:0,class:"loading-row"},Pe={key:1,class:"load-more-row"},Ke={key:2,class:"no-more-row"},Ue={key:0,class:"record-limit-tip"};function Ae(e,t,a,r,n,s){const d=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),c=(0,l.g2)("home"),p=(0,l.g2)("plus"),m=(0,l.g2)("el-button"),g=(0,l.g2)("user"),f=(0,l.g2)("refresh"),k=(0,l.g2)("arrow-down"),v=(0,l.g2)("arrow-up"),h=(0,l.g2)("el-option"),b=(0,l.g2)("el-select"),y=(0,l.g2)("el-form-item"),w=(0,l.g2)("el-col"),_=(0,l.g2)("el-input"),F=(0,l.g2)("el-date-picker"),L=(0,l.g2)("el-row"),x=(0,l.g2)("el-input-number"),C=(0,l.g2)("CircleClose"),I=(0,l.g2)("el-form"),R=(0,l.g2)("el-card"),$=(0,l.g2)("download"),W=(0,l.g2)("el-table-column"),V=(0,l.g2)("el-image"),T=(0,l.g2)("loading"),S=(0,l.g2)("el-table"),E=(0,l.g2)("el-alert"),P=(0,l.g2)("el-image-viewer"),K=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",de,[(0,l.Lk)("div",ue,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 返回填报 "))]),t[13]||(t[13]=(0,l.Lk)("h1",null,"废物记录查看",-1)),r.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"home-link",onClick:t[1]||(t[1]=(...e)=>r.goHome&&r.goHome(...e))},[t[12]||(t[12]=(0,l.eW)(" 首页 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(c)])),_:1})])):((0,l.uX)(),(0,l.CE)("div",ce))]),(0,l.Lk)("div",pe,[(0,l.Lk)("div",me,[(0,l.Lk)("h2",null,(0,i.v_)(r.unitName)+" 固体废物记录",1)]),(0,l.Lk)("div",ge,[(0,l.bF)(m,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isAdmin&&!r.isSupervisor||r.isUnitAdmin?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}),t[15]||(t[15]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(m,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}),t[16]||(t[16]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,l.bF)(R,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",fe,[t[17]||(t[17]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(m,{type:"primary",link:"",onClick:t[2]||(t[2]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(u,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(v)])),_:1})):((0,l.uX)(),(0,l.Wv)(u,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",ke,[(0,l.bF)(I,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(L,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(w,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,l.k6)((()=>[(0,l.bF)(y,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(w,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,l.k6)((()=>[(0,l.bF)(y,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(w,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,l.k6)((()=>[(0,l.bF)(y,{label:"产生工序"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.filterForm.process,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.process=e),placeholder:"输入工序关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(w,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,l.k6)((()=>[(0,l.bF)(y,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":r.disabledDate},null,8,["modelValue","disabled-date"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(L,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(w,{xs:24,sm:12,md:16,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(y,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ve,[(0,l.Lk)("div",he,[(0,l.bF)(x,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"100%"}},null,8,["modelValue"]),null!==r.filterForm.minQuantity?((0,l.uX)(),(0,l.Wv)(u,{key:0,class:"clear-icon",onClick:t[8]||(t[8]=e=>r.filterForm.minQuantity=null)},{default:(0,l.k6)((()=>[(0,l.bF)(C)])),_:1})):(0,l.Q3)("",!0)]),t[18]||(t[18]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.Lk)("div",be,[(0,l.bF)(x,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[9]||(t[9]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"100%"}},null,8,["modelValue","min"]),null!==r.filterForm.maxQuantity?((0,l.uX)(),(0,l.Wv)(u,{key:0,class:"clear-icon",onClick:t[10]||(t[10]=e=>r.filterForm.maxQuantity=null)},{default:(0,l.k6)((()=>[(0,l.bF)(C)])),_:1})):(0,l.Q3)("",!0)])])])),_:1})])),_:1}),(0,l.bF)(w,{xs:24,sm:12,md:8,lg:12,xl:12,class:"filter-buttons-col"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ye,[(0,l.bF)(m,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)("刷新筛选")]))),_:1},8,["onClick"]),(0,l.bF)(m,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[20]||(t[20]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])],512),[[o.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",we,[(0,l.bF)(R,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",_e,[t[24]||(t[24]=(0,l.Lk)("h3",{class:"table-title"},"废物记录列表",-1)),(0,l.Lk)("div",Fe,[(0,l.bF)(m,{type:"warning",onClick:r.exportWithoutImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[21]||(t[21]=(0,l.eW)(" 无照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,l.bF)(m,{type:"warning",onClick:r.exportWithImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[22]||(t[22]=(0,l.eW)(" 包含首张照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,l.bF)(m,{type:"warning",onClick:r.exportWithAllImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[23]||(t[23]=(0,l.eW)(" 包含全部照片(不推荐) "))])),_:1},8,["onClick","loading"])])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(S,{data:r.records,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:r.tableHeight},{append:(0,l.k6)((()=>[r.loadingMore?((0,l.uX)(),(0,l.CE)("div",Ee,[(0,l.bF)(u,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(T)])),_:1}),t[27]||(t[27]=(0,l.eW)(" 正在加载... "))])):r.hasMore&&r.records.length>0?((0,l.uX)(),(0,l.CE)("div",Pe,[(0,l.bF)(m,{type:"primary",onClick:r.loadMore,disabled:r.loadingMore,size:"small"},{default:(0,l.k6)((()=>[t[28]||(t[28]=(0,l.eW)(" 点击加载更多 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["onClick","disabled"])])):r.records.length>0?((0,l.uX)(),(0,l.CE)("div",Ke," 已全部加载 ")):(0,l.Q3)("",!0)])),default:(0,l.k6)((()=>[(0,l.bF)(W,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,l.bF)(W,{prop:"waste_type_name",label:"废物类型","min-width":"120"}),(0,l.bF)(W,{prop:"location",label:"产生地点","min-width":"120"}),(0,l.bF)(W,{prop:"process",label:"产生工序","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.process||"无"),1)])),_:1}),(0,l.bF)(W,{prop:"remarks",label:"备注","min-width":"150"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,l.bF)(W,{label:"地理位置","min-width":"200",class:"mobile-hidden"},{default:(0,l.k6)((e=>[r.hasLocationInfo(e.row)?((0,l.uX)(),(0,l.CE)("div",Le,[(0,l.Lk)("span",null,(0,i.v_)(r.formatLocationDisplay(e.row)),1)])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(W,{label:"收集开始时间","min-width":"160"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.collection_start_time)),1)])),_:1}),(0,l.bF)(W,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(null!==e.row.quantity&&void 0!==e.row.quantity?parseFloat(e.row.quantity).toFixed(3):""),1)])),_:1}),(0,l.bF)(W,{label:"汇报人","min-width":"100",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.creator_name||"未知"),1)])),_:1}),(0,l.bF)(W,{label:"记录时间","min-width":"160",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.created_at)),1)])),_:1}),(0,l.bF)(W,{label:"清理前照片","min-width":"150",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",xe,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,Ce)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",Ie,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",Re,"无"))])),_:1}),(0,l.bF)(W,{label:"清理后照片","min-width":"150",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",$e,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,We)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",Ve,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",Te,"无"))])),_:1}),(0,l.bF)(W,{label:"操作","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",Se,[r.canEdit(e.row)?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[25]||(t[25]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0),r.canEdit(e.row)&&(r.isAdmin||r.isUnitAdmin)?((0,l.uX)(),(0,l.Wv)(m,{key:1,type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[26]||(t[26]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0)])])),_:1})])),_:1},8,["data","height"])),[[K,r.loading]]),r.isAdmin||r.isUnitAdmin?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",Ue,[(0,l.bF)(E,{title:"提示：只能查看过去48小时内的废物记录",type:"info",closable:!1,"show-icon":""})]))])),_:1})])]),r.showViewer?((0,l.uX)(),(0,l.Wv)(P,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}var De=a(8828),Xe=a(5320),Qe=a(7093),Me=a.n(Qe);const Be=(e,t="")=>{const a=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),o=t?`.${t}`:"";return`${e}_${a}${o}`},qe=e=>e?e.replace(/[\\/:*?"<>|]/g,"_"):"",ze=async(e,t=window.location.origin)=>{if(console.log("获取图片:",e),!e)return console.error("图片URL为空"),null;const a=e.startsWith("/")?`${t}${e}`:e;try{console.log("获取图片:",a);const e=await fetch(a,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!e.ok)throw new Error(`获取图片失败: ${e.status} ${e.statusText}`);const t=await e.arrayBuffer();return console.log("图片获取成功，大小:",t.byteLength,"字节"),t}catch(o){return console.error("获取图片失败:",o),null}},Ne=async(e,t,a,o=window.location.origin,l=null)=>{if(console.log("=== exportToExcelWithImages 函数被调用 ==="),console.log("数据条数:",e.length),!e||0===e.length)return console.error("导出失败：没有数据"),!1;try{const n=qe(t),s=Be(n,"xlsx"),i=new(Me().Workbook);i.creator="固体废物管理系统",i.lastModifiedBy="固体废物管理系统",i.created=new Date,i.modified=new Date;const d=i.addWorksheet("固体废物记录"),u=a.map((e=>({header:e.text,key:e.field,width:e.isImage?20:15})));d.columns=u,d.getRow(1).font={bold:!0},d.getRow(1).alignment={vertical:"middle",horizontal:"center"},console.log("开始处理数据行...");const c=e.length*(1+a.filter((e=>e.isImage)).length);let p=0;for(let t=0;t<e.length;t++){const n=e[t];console.log(`处理第 ${t+1}/${e.length} 条记录...`);const s={};a.forEach((e=>{e.isImage||(s[e.field]=n[e.field]||"")}));const u=d.addRow(s);u.height=80,p++,l&&"function"===typeof l&&l(p,c);for(const e of a)if(e.isImage){const s=e.field,u=n[s];if(u){console.log(`记录 ${t+1} 的 ${s} 字段有图片路径: ${u}`);try{const e=await ze(u,o);if(e){const o=a.findIndex((e=>e.field===s))+1,l=d.getCell(t+2,o).address,r=i.addImage({buffer:e,extension:u.split(".").pop().toLowerCase()});d.addImage(r,{tl:{col:o-1,row:t+1},br:{col:o,row:t+1.9},editAs:"oneCell"}),console.log(`已添加图片到单元格 ${l}`)}else console.error(`获取图片失败: ${u}`)}catch(r){console.error("处理图片时出错:",r)}}else console.log(`记录 ${t+1} 的 ${s} 没有照片路径`);p++,l&&"function"===typeof l&&l(p,c)}}console.log("数据行处理完成，准备生成Excel文件...");const m=await i.xlsx.writeBuffer(),g=new Blob([m],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=window.URL.createObjectURL(g),k=document.createElement("a");return k.href=f,k.download=s,k.click(),window.URL.revokeObjectURL(f),console.log("Excel文件生成并下载成功"),!0}catch(n){return console.error("导出Excel文件失败:",n),!1}},Oe=async(e,t,a)=>{if(!e||0===e.length)return console.error("导出失败：没有数据"),!1;const o=qe(t),l=Be(o,"xlsx");console.log("导出函数被调用，数据条数:",e.length);try{console.log("使用ExcelJS导出Excel...");const t=new(Me().Workbook);t.creator="固体废物管理系统",t.lastModifiedBy="固体废物管理系统",t.created=new Date,t.modified=new Date;const o=t.addWorksheet("固体废物记录"),r=a.map((e=>({header:e.text,key:e.field,width:15})));o.columns=r,o.getRow(1).font={bold:!0},o.getRow(1).alignment={vertical:"middle",horizontal:"center"},e.forEach((e=>{const t={};a.forEach((a=>{t[a.field]=e[a.field]||""})),o.addRow(t)})),console.log("生成Excel数据...");const n=await t.xlsx.writeBuffer(),s=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(s),d=document.createElement("a");return d.href=i,d.download=l,console.log("下载链接创建成功，准备触发点击"),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),console.log("Excel导出成功"),!0}catch(r){return console.error("导出Excel失败，错误详情:",r),console.log("回退到CSV导出"),je(e,t,a),!1}},je=(e,t,a)=>{const o=qe(t),l=Be(o,"csv");let r="\ufeff";const n=a.map((e=>`"${e.title}"`)).join(",");r+=n+"\r\n",e.forEach((e=>{const t=a.map((t=>{const a=e[t.field];if(null===a||void 0===a)return"";if("number"===t.type||"number"===typeof a)return a;let o=String(a);return(o.includes(",")||o.includes('"')||o.includes("\n"))&&(o=o.replace(/"/g,'""'),o=`"${o}"`),o})).join(",");r+=t+"\r\n"}));const s=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),d=document.createElement("a");d.setAttribute("href",i),d.setAttribute("download",l),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),console.log("CSV导出成功")};var He={name:"RecordsList",components:{ArrowLeft:b.nkM,Home:b.Home,Refresh:b.C42,Plus:b.FWt,User:b.KJW,ArrowDown:b.yd$,ArrowUp:b.DoI,Download:b.f5X,ElImageViewer:De.Tg,Loading:b.Rhj,CircleClose:b.R$5},props:{unitId:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),a=(0,k.KR)([]),o=(0,k.KR)(!1),r=(0,k.KR)(""),n=(0,k.KR)([]),i=(0,k.KR)(!0),d=_.baseURL,u=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},c=(0,k.KR)(1),p=(0,k.KR)(20),m=(0,k.KR)(!0),g=(0,k.KR)(!1),f=(0,k.Kh)({dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:"",process:""}),b=(0,k.KR)(null);(0,l.wB)([()=>f.wasteTypeId,()=>f.location,()=>f.process,()=>f.minQuantity,()=>f.maxQuantity,()=>f.dateRange],(()=>{b.value&&clearTimeout(b.value),b.value=setTimeout((()=>{c.value=1,O()}),300)}));const w=(0,l.EW)((()=>xr.isAdmin())),F=(0,l.EW)((()=>xr.isUnitAdmin())),L=(0,l.EW)((()=>xr.isSupervisor())),x=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},C=async()=>{await O(),v.nk.success("记录已刷新")},I=()=>{const e=xr.getUnitId();e?t.push(`/unit/${e}`):t.push("/")},R=()=>{t.push("/")},$=()=>{t.push("/user-management")},W=()=>{t.push(`/unit/${e.unitId}`)},V=e=>{t.push(`/record/${e}`)},T=e=>{if(!e)return!1;if(w.value)return!0;const t=xr.getUnitId();if(F.value&&t&&e.unit_id===parseInt(t))return!0;const a=xr.getUserId();return a&&e.creator_id===parseInt(a)},S=e=>e+1,E=e=>{w.value||F.value?h.s.confirm("确定要删除这条废物记录吗？此操作不可逆。","删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await dr.delete(`${_.endpoints.wasteRecords}/${e.id}`),v.nk.success("记录已成功删除"),await O()}catch(t){console.error("删除记录失败:",t),v.nk.error("删除记录失败，请重试")}})).catch((()=>{v.nk.info("已取消删除")})):v.nk.error("您没有删除记录的权限")},P=async()=>{try{c.value=1,await O(),v.nk.success("筛选条件已应用")}catch(e){console.error("应用筛选失败:",e),v.nk.error("应用筛选失败")}},K=async()=>{f.dateRange=null,f.wasteTypeId=null,f.minQuantity=null,f.maxQuantity=null,f.location="",f.process="",c.value=1,await O(),v.nk.success("筛选条件已重置")},U=(0,k.KR)(!1),A=(0,k.KR)([]),D=(0,k.KR)(0),X=(e,t)=>{const a=Array.isArray(e)?e:[e];A.value=a.map((e=>`${d}${e}`)),D.value=t||0,U.value=!0},Q=()=>{U.value=!1},M=(0,k.KR)(750),B=()=>{const e=window.innerHeight,t=Math.max(.85*e,700);M.value=t},q=()=>{B()};(0,l.sV)((async()=>{B(),window.addEventListener("resize",q),await N(),await z(),await O()})),(0,l.hi)((()=>{window.removeEventListener("resize",q)}));const z=async()=>{try{const e=await dr.get(_.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),v.nk.error("获取废物类型列表失败")}},N=async()=>{try{const t=await dr.get(_.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.unitId)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),v.nk.error("获取单位信息失败")}},O=async(t=!1)=>{t?g.value=!0:(o.value=!0,c.value=1,a.value=[]);try{if(!xr.state.isLoggedIn||!xr.state.user)throw new Error("用户未登录");const o={page:c.value,pageSize:p.value,wasteTypeId:f.wasteTypeId||void 0,minQuantity:f.minQuantity||void 0,maxQuantity:f.maxQuantity||void 0,location:f.location||void 0,process:f.process||void 0,unitId:e.unitId?parseInt(e.unitId):void 0};f.dateRange&&2===f.dateRange.length&&(o.dateRange=JSON.stringify(f.dateRange)),console.log("【筛选】请求废物记录，参数:",JSON.stringify(o,null,2));const l=_.getUrl(`${_.endpoints.wasteRecords}/user/${xr.state.user.id}`);console.log("【筛选】请求URL:",l);const r=await y.A.get(l,{params:o});if(console.log("【筛选】获取到废物记录响应:",r.data),!r.data||!r.data.records)throw console.error("【筛选】响应数据格式错误:",r.data),new Error("响应数据格式错误");const n=r.data.records.map((e=>({...e,created_at:x(e.created_at),collection_start_time:x(e.collection_start_time)})));console.log(`【筛选】获取到${n.length}条记录`),a.value=t?[...a.value,...n]:n,m.value=r.data.hasMore,m.value&&c.value++}catch(l){console.error("【筛选】获取废物记录失败:",l),v.nk.error("获取废物记录失败: "+(l.message||"未知错误"))}finally{o.value=!1,g.value=!1}},j=()=>{console.log("手动触发加载更多");const e=document.querySelector(".el-table__body-wrapper"),t=e?e.scrollTop:0;return O(!0).then((()=>{console.log("加载完成，当前记录数:",a.value.length),setTimeout((()=>{e&&(e.scrollTop=t)}),10)})).catch((e=>{console.error("加载失败:",e),v.nk.error("加载更多数据失败")}))},H=(0,l.EW)((()=>!w.value&&!F.value)),Y=e=>e.address||e.district||e.city||e.province,J=e=>{const t=[];return e.address&&t.push(e.address),e.district&&t.push(e.district),e.city&&t.push(e.city),t.join("，")},G=async()=>{try{(0,v.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const t=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const a={wasteTypeId:f.wasteTypeId?f.wasteTypeId:void 0,minQuantity:f.minQuantity?f.minQuantity:void 0,maxQuantity:f.maxQuantity?f.maxQuantity:void 0,location:f.location||void 0,process:f.process||void 0,dateRange:f.dateRange?JSON.stringify(f.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0,exportType:"first_image"};console.log("导出记录的筛选条件:",a);const{data:l}=await y.A.get(`${_.getUrl(_.endpoints.exportWasteRecords)}/${xr.state.user.id}`,{params:a});if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return t.close(),v.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);t.setText(`准备导出 ${l.length} 条记录...`);const n=l.map((e=>{const t=u(e.photo_path_before),a=u(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"产生工序":e.process||"无","备注":e.remarks||"无","收集开始时间":x(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":x(e.created_at),"清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),s=`固体废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],d=window.location.origin,c=(e,a)=>{const o=Math.round(e/a*100);t.setText(`正在导出：${o}% (${e}/${a})`)},p=await Ne(n,s,i,d,c);t.close(),p?v.nk.success("导出成功"):v.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),v.nk.error("导出失败: "+(t.message||"未知错误"))}finally{o.value=!1,Xe.Ks.service().close()}},Z=async()=>{try{(0,v.nk)({message:"导出大量包含全部图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const t=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const a={wasteTypeId:f.wasteTypeId?f.wasteTypeId:void 0,minQuantity:f.minQuantity?f.minQuantity:void 0,maxQuantity:f.maxQuantity?f.maxQuantity:void 0,location:f.location||void 0,process:f.process||void 0,dateRange:f.dateRange?JSON.stringify(f.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0,exportType:"all_images"};console.log("导出记录的筛选条件:",a);const{data:l}=await y.A.get(`${_.getUrl(_.endpoints.exportWasteRecords)}/${xr.state.user.id}`,{params:a});if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return t.close(),v.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);t.setText(`准备导出 ${l.length} 条记录的全部照片...`);const n=l.map((e=>{const t=u(e.photo_path_before),a=u(e.photo_path_after),o={"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":x(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":x(e.created_at)};for(let l=0;l<5;l++)o[`清理前照片${l+1}`]=l<t.length?t[l]:"";for(let l=0;l<5;l++)o[`清理后照片${l+1}`]=l<a.length?a[l]:"";return o})),s=`固体废物记录_全部照片_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"}];for(let e=0;e<5;e++)i.push({text:`清理前照片${e+1}`,field:`清理前照片${e+1}`,isImage:!0});for(let e=0;e<5;e++)i.push({text:`清理后照片${e+1}`,field:`清理后照片${e+1}`,isImage:!0});const d=window.location.origin,c=(e,a)=>{const o=Math.round(e/a*100);t.setText(`正在导出全部照片：${o}% (${e}/${a})`)},p=await Ne(n,s,i,d,c);t.close(),p?v.nk.success("导出成功"):v.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),v.nk.error("导出失败: "+(t.message||"未知错误"))}finally{o.value=!1,Xe.Ks.service().close()}},ee=async()=>{try{const t=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const a={wasteTypeId:f.wasteTypeId?f.wasteTypeId:void 0,minQuantity:f.minQuantity?f.minQuantity:void 0,maxQuantity:f.maxQuantity?f.maxQuantity:void 0,location:f.location||void 0,process:f.process||void 0,dateRange:f.dateRange?JSON.stringify(f.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0,exportType:"no_images"},{data:l}=await y.A.get(`${_.getUrl(_.endpoints.exportWasteRecords)}/${xr.state.user.id}`,{params:a});if(0===l.length)return t.close(),v.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);t.setText(`准备导出 ${l.length} 条记录...`);const n=l.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":x(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":x(e.created_at),"清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),s=`固体废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],d=await Oe(n,s,i);t.close(),d?v.nk.success("导出成功"):v.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),v.nk.error("导出失败: "+(t.message||"未知错误"))}finally{o.value=!1,Xe.Ks.service().close()}},te=e=>{if(!w.value&&!F.value){const t=new Date,a=new Date(t);return a.setHours(t.getHours()-48),e<a||e>t}return!1};return{records:a,loading:o,unitName:r,wasteTypes:n,isAdmin:w,isUnitAdmin:F,isSupervisor:L,parseFormattedDateTime:x,refreshRecords:C,goBack:I,goHome:R,goToUserManagement:$,addNewRecord:W,editRecord:V,canEdit:T,confirmDelete:E,apiConfig:_,showFilterPanel:i,filterForm:f,applyFilter:P,resetFilter:K,debounceTimer:b,exportWithImages:G,exportWithAllImages:Z,exportWithoutImages:ee,showViewer:U,previewImages:A,previewIndex:D,previewPhoto:X,closeViewer:Q,handleResize:q,parsePhotoPath:u,baseUrl:d,page:c,pageSize:p,hasMore:m,loadingMore:g,indexMethod:S,disabledDate:te,tableHeight:M,isBasicEmployee:H,loadMore:j,hasLocationInfo:Y,formatLocationDisplay:J}}};const Ye=(0,$.A)(He,[["render",Ae],["__scopeId","data-v-3c138004"]]);var Je=Ye;const Ge={class:"login-container"},Ze={class:"login-card"},et={key:0,class:"login-error"};function tt(e,t,a,r,n,s){const d=(0,l.g2)("el-input"),u=(0,l.g2)("el-form-item"),c=(0,l.g2)("el-checkbox"),p=(0,l.g2)("el-button"),m=(0,l.g2)("el-form");return(0,l.uX)(),(0,l.CE)("div",Ge,[(0,l.Lk)("div",Ze,[t[5]||(t[5]=(0,l.Lk)("div",{class:"login-header"},[(0,l.Lk)("h1",null,"固体废物管理系统"),(0,l.Lk)("h2",null,"用户登录")],-1)),(0,l.bF)(m,{ref:"loginForm",model:r.form,rules:r.rules,"label-width":"80px",class:"login-form",onSubmit:(0,o.D$)(r.submitForm,["prevent"])},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"用户",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:r.form.phone,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.phone=e),placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,{label:"密码",prop:"password"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:r.form.password,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:r.form.rememberMe,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.rememberMe=e)},{default:(0,l.k6)((()=>t[3]||(t[3]=[(0,l.eW)("记住登录")]))),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p,{type:"primary","native-type":"submit",onClick:r.submitForm,loading:r.auth.state.loading,style:{width:"100%"}},{default:(0,l.k6)((()=>t[4]||(t[4]=[(0,l.eW)(" 登录 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules","onSubmit"]),r.auth.state.error?((0,l.uX)(),(0,l.CE)("div",et,(0,i.v_)(r.auth.state.error),1)):(0,l.Q3)("",!0)])])}var at={name:"LoginView",setup(){const e=(0,s.rd)(),t=(0,k.KR)(null),a=(0,k.Kh)({phone:"",password:"",rememberMe:!1}),o=(0,l.EW)((()=>{const e=[{required:!0,message:"请输入用户名",trigger:"submit"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的格式",trigger:"submit"}],t=[{required:!0,message:"请输入密码",trigger:"submit"}];return{phone:e,password:t}})),r=async()=>{console.log("提交表单被触发"),t.value?xr.state.loading?console.log("登录正在进行中，跳过"):t.value.validate((async e=>{e?(console.log("表单验证通过"),await n()):console.log("表单验证失败")})):console.log("表单引用不存在")},n=async()=>{console.log("开始登录，账号:",a.phone);try{console.log("开始处理登录操作...");const t=await xr.login(a.phone,a.password,a.rememberMe);if(console.log("登录响应:",t),t.success){const a=t.user;v.nk.success(`欢迎，${a.username||a.phone}`),3===a.role_id?e.push("/admin-records"):4===a.role_id?e.push("/record/new"):(a.role_id,e.push(`/unit/${a.unit_id}`))}else v.nk.error(t.error||"登录失败")}catch(t){v.nk.error(t.response?.data?.error||"登录失败，请检查网络连接")}};return(0,l.sV)((()=>{if(xr.state.isLoggedIn){const t=xr.state.user;3===t.role_id?e.push("/admin-records"):4===t.role_id?e.push("/record/new"):(t.role_id,e.push(`/unit/${t.unit_id}`))}})),{form:a,rules:o,loginForm:t,submitForm:r,auth:xr}}};const ot=(0,$.A)(at,[["render",tt],["__scopeId","data-v-25ea481a"]]);var lt=ot;const rt={class:"edit-record-container"},nt={class:"header"},st={key:1},it={key:3},dt={class:"content"},ut={class:"form-header"},ct={key:0,class:"form-tip"},pt={class:"location-display"},mt={key:0,class:"location-item"},gt={key:1,class:"location-item"},ft={key:2,class:"location-item"},kt={class:"location-section"},vt={class:"location-controls"},ht={key:0,class:"location-tip"},bt={key:1,class:"location-tip"},yt={key:0,class:"location-info"},wt={class:"location-item"},_t={key:0,class:"location-item"},Ft={key:1,class:"location-error"},Lt={key:0,class:"upload-warning"},xt={class:"upload-progress"},Ct={class:"upload-status"};function It(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("el-option"),c=(0,l.g2)("el-select"),p=(0,l.g2)("el-form-item"),m=(0,l.g2)("el-input"),g=(0,l.g2)("el-tag"),f=(0,l.g2)("el-button"),k=(0,l.g2)("el-alert"),v=(0,l.g2)("el-date-picker"),h=(0,l.g2)("clock"),b=(0,l.g2)("el-time-picker"),y=(0,l.g2)("el-input-number"),w=(0,l.g2)("plus"),_=(0,l.g2)("el-upload"),F=(0,l.g2)("el-image-viewer"),L=(0,l.g2)("el-form"),x=(0,l.g2)("el-progress"),C=(0,l.g2)("el-dialog"),I=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",rt,[(0,l.Lk)("div",nt,[o.isSupervisor?((0,l.uX)(),(0,l.CE)("div",st)):((0,l.uX)(),(0,l.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 查看记录 "))])),(0,l.Lk)("h1",null,(0,i.v_)(o.isNew?"新增废物记录":"编辑废物记录"),1),o.isSupervisor?((0,l.uX)(),(0,l.CE)("div",{key:2,class:"back-button supervisor-back-button",onClick:t[1]||(t[1]=(...e)=>o.goBack&&o.goBack(...e))}," 查看记录 ")):((0,l.uX)(),(0,l.CE)("div",it))]),(0,l.Lk)("div",dt,[(0,l.Lk)("div",ut,[(0,l.Lk)("h2",null,(0,i.v_)(o.unitName),1)]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(L,{ref:"recordForm",model:o.form,rules:o.rules,"label-width":"120px",class:"record-form"},{default:(0,l.k6)((()=>[o.isAdmin?((0,l.uX)(),(0,l.Wv)(p,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.unitId,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.units,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),o.isNew?((0,l.uX)(),(0,l.CE)("div",ct,"请先选择单位，才能选择产生地点")):(0,l.Q3)("",!0)])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(p,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"产生工序",prop:"process"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.process,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.process=e),placeholder:"请选择产生工序",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.processOptions,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===o.form.process?((0,l.uX)(),(0,l.Wv)(m,{key:0,modelValue:o.customProcess,"onUpdate:modelValue":t[5]||(t[5]=e=>o.customProcess=e),placeholder:"请输入具体产生工序",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,{label:"产生地点",prop:"location"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.location,"onUpdate:modelValue":t[6]||(t[6]=e=>o.form.location=e),placeholder:o.isAdmin&&!o.unitName?"请先选择单位":"请选择废物产生地点",style:{width:"100%"},disabled:o.isAdmin&&!o.unitName},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.locationOptions,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","placeholder","disabled"]),"其他"===o.form.location?((0,l.uX)(),(0,l.Wv)(m,{key:0,modelValue:o.customLocation,"onUpdate:modelValue":t[7]||(t[7]=e=>o.customLocation=e),placeholder:"请输入具体产生地点",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,{label:"备注",prop:"remarks"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:o.form.remarks,"onUpdate:modelValue":t[8]||(t[8]=e=>o.form.remarks=e),type:"textarea",rows:1,placeholder:"请输入备注信息（选填）"},null,8,["modelValue"])])),_:1}),!o.isNew&&o.hasLocationInfo?((0,l.uX)(),(0,l.Wv)(p,{key:1,label:"地理位置"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",pt,[o.locationInfo.coordinates?((0,l.uX)(),(0,l.CE)("div",mt,[(0,l.bF)(g,{type:"success",size:"small"},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("坐标")]))),_:1}),(0,l.Lk)("span",null,(0,i.v_)(o.locationInfo.coordinates),1)])):(0,l.Q3)("",!0),o.locationInfo.address?((0,l.uX)(),(0,l.CE)("div",gt,[(0,l.bF)(g,{type:"info",size:"small"},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)("地址")]))),_:1}),(0,l.Lk)("span",null,(0,i.v_)(o.locationInfo.address),1)])):(0,l.Q3)("",!0),o.locationInfo.region?((0,l.uX)(),(0,l.CE)("div",ft,[(0,l.bF)(g,{type:"warning",size:"small"},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)("区域")]))),_:1}),(0,l.Lk)("span",null,(0,i.v_)(o.locationInfo.region),1)])):(0,l.Q3)("",!0)])])),_:1})):(0,l.Q3)("",!0),o.isNew?((0,l.uX)(),(0,l.Wv)(p,{key:2,label:"地理位置"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",kt,[(0,l.Lk)("div",vt,[(0,l.bF)(f,{type:"primary",icon:o.Location,loading:o.locationLoading,onClick:o.getCurrentLocation,disabled:!o.isLocationSupported},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.locationLoading?"获取中...":"获取当前位置"),1)])),_:1},8,["icon","loading","onClick","disabled"]),o.isLocationSupported?o.isSecureContext?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("span",bt," 需要HTTPS环境才能获取位置 ")):((0,l.uX)(),(0,l.CE)("span",ht," 当前环境不支持位置获取 "))]),o.currentLocationInfo.success?((0,l.uX)(),(0,l.CE)("div",yt,[(0,l.Lk)("div",wt,[(0,l.bF)(g,{type:"success",size:"small"},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("坐标")]))),_:1}),(0,l.Lk)("span",null,(0,i.v_)(o.formatCoordinates(o.currentLocationInfo.longitude,o.currentLocationInfo.latitude)),1)]),o.currentLocationInfo.address?((0,l.uX)(),(0,l.CE)("div",_t,[(0,l.bF)(g,{type:"info",size:"small"},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)("地址")]))),_:1}),(0,l.Lk)("span",null,(0,i.v_)(o.formatAddress(o.currentLocationInfo)),1)])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0),o.locationError?((0,l.uX)(),(0,l.CE)("div",Ft,[(0,l.bF)(k,{title:o.locationError,type:"warning",closable:!1,"show-icon":"",size:"small"},null,8,["title"])])):(0,l.Q3)("",!0)])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(p,{label:"收集日期"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:o.form.collectionDate,"onUpdate:modelValue":t[9]||(t[9]=e=>o.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:o.form.collectionTime,"onUpdate:modelValue":t[10]||(t[10]=e=>o.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:o.form.quantity,"onUpdate:modelValue":t[11]||(t[11]=e=>o.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集前）",prop:"photo_path_before"},{default:(0,l.k6)((()=>[t[19]||(t[19]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),o.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",Lt,[(0,l.bF)(k,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(_,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoBeforeChange,"on-remove":o.handlePhotoBeforeRemove,"file-list":o.fileListBefore,limit:5,multiple:"","list-type":"picture-card","on-preview":o.handlePictureCardPreview,"before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(w)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集后）",prop:"photo_path_after"},{default:(0,l.k6)((()=>[t[20]||(t[20]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(_,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoAfterChange,"on-remove":o.handlePhotoAfterRemove,"file-list":o.fileListAfter,limit:5,multiple:"","list-type":"picture-card","on-preview":o.handlePictureCardPreview,"before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(w)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),o.showViewer?((0,l.uX)(),(0,l.Wv)(F,{key:0,"url-list":o.previewImages,"initial-index":o.previewIndex,onClose:o.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,null,{default:(0,l.k6)((()=>[(0,l.bF)(f,{type:"primary",onClick:o.submitForm,loading:o.loading},{default:(0,l.k6)((()=>t[21]||(t[21]=[(0,l.eW)("保存")]))),_:1},8,["onClick","loading"]),(0,l.bF)(f,{onClick:o.goBack},{default:(0,l.k6)((()=>t[22]||(t[22]=[(0,l.eW)("取消")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"])),[[I,o.loading]])]),(0,l.bF)(C,{modelValue:o.showUploadProgress,"onUpdate:modelValue":t[12]||(t[12]=e=>o.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",xt,[t[23]||(t[23]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(x,{percentage:o.uploadPercentage,format:o.percentageFormat,status:100===o.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",Ct,(0,i.v_)(o.uploadStatus),1)])])),_:1},8,["modelValue"]),t[24]||(t[24]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var Rt={name:"EditRecordView",components:{ArrowLeft:b.nkM,Plus:b.FWt,Clock:b.zD7,ElImageViewer:De.Tg},setup(){const e=(0,s.rd)(),t=(0,s.lq)(),a=(0,k.KR)(null),o=(0,k.KR)(!1),r=(0,k.KR)(!1),n=(0,k.KR)(""),i=(0,k.KR)([]),d=(0,k.KR)([]),u=(0,k.KR)([]),c=(0,k.KR)([]),p=(0,k.KR)([]),m=(0,k.KR)([]),g=(0,k.KR)([]),f=(0,k.KR)(!1),h=(0,k.KR)(0),y=(0,k.KR)(""),w=(0,k.KR)(!1),F=(0,k.KR)(0),L=(0,k.KR)("准备上传..."),x=(0,k.KR)(!1),C=(0,k.KR)(null),I=(0,k.KR)([]),R=(0,k.KR)(""),$=(0,k.KR)(""),W=["作业现场","清罐清理","报废清理","管线刺漏","历史遗留","日常维护","封井退出","其他"],V=(0,k.KR)({coordinates:"",address:"",region:""}),T=(0,k.KR)(!1),S=(0,k.KR)({success:!1,longitude:null,latitude:null,address:"",district:"",city:"",province:""}),E=(0,k.KR)(""),P=(0,k.KR)([]),K=(0,k.KR)([]),U=(0,k.KR)([]),A=(0,k.KR)([]),D={"桓台":["金家接转站","金17-1注采站","金17-2注采站","金6金9项目组","金8注采站","其他"],"潍北":["潍北联合站","昌79注采站","昌3注采站","疃3注采站","昌15注采站","其他"],"高青":["高青联合站","樊107注采站","樊14注采站","高21注采站","高54注采站","其他"],"牛庄":["牛25集输站","牛25注采站","营13注采站","史112注采站","其他"],"金角":["长堤注采站","桩23注采站","其他"],"信远":["河125注采站","河122注采站","永551注采站","其他"],"滨博":["樊142注采站","樊142-2-12注采站","樊162注采站","樊页1井组","滨博接转站","其他"],"无棣":["车41注采站","车142注采站","车40注采站","车408注采站","车274注采站","车1接转站","东风港联合站","其他"],"河口":["沾14东注采站","沾14西注采站","渤南注采站","大北注采站","沾5注采站","太平接转站","沾5接转站","其他"],"胜兴":["博兴注采站","其他"],"胜科管理区":["采油一站","其他"],"其他":["其他"]},X=e=>{if(!e)return[];console.log("解析照片路径，原始值:",e,"类型:",typeof e);try{if(Array.isArray(e))return console.log("照片路径已经是数组:",e),e;if("string"===typeof e){if(e.startsWith("[")&&e.endsWith("]")){const t=JSON.parse(e);return console.log("照片路径解析为JSON数组:",t),t}if(e.includes(",")){const t=e.split(",").map((e=>e.trim())).filter((e=>e));return console.log("照片路径解析为逗号分隔字符串:",t),t}return console.log("照片路径解析为单个字符串:",[e]),[e]}return console.log("照片路径类型未知，尝试转换为字符串:",String(e)),[String(e)]}catch(t){return console.error("解析照片路径失败:",t),"string"===typeof e?[e]:[]}},Q=(0,l.EW)((()=>!t.params.id||"new"===t.params.id)),M=(0,l.EW)((()=>xr.state.isLoggedIn&&(3===xr.state.user.role_id||4===xr.state.user.role_id||5===xr.state.user.role_id))),B=(0,l.EW)((()=>xr.state.isLoggedIn&&4===xr.state.user.role_id)),q=(0,l.EW)((()=>V.value.coordinates||V.value.address||V.value.region)),z=(0,k.Kh)({unitId:"",wasteTypeId:"",location:"",collectionDate:"",collectionTime:"",quantity:void 0,recordId:null,creatorId:xr.state.user?.id||null,photo_path_before:"",photo_path_after:"",remarks:"",process:""}),N={unitId:[{required:!0,message:"请选择单位",trigger:"change",validator:(e,t,a)=>{M.value?t?a():a(new Error("请选择单位")):a()}}],wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],process:[{required:!0,message:"请选择产生工序",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||$.value.trim()?a():a(new Error("请输入具体产生工序"))},trigger:"blur"}],location:[{required:!0,message:"请选择废物产生地点",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||R.value.trim()?a():a(new Error("请输入具体产生地点"))},trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!1,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{o.value=!0;try{await H(),M.value&&await O(),Q.value?(!M.value&&xr.state.user&&(z.unitId=xr.state.user.unit_id,await j(z.unitId)),z.collectionDate=(new Date).toISOString().slice(0,10),z.collectionTime=(new Date).toTimeString().slice(0,5),ae()&&oe()&&Y()):await J()}catch(e){console.error("初始化数据失败:",e),v.nk.error("加载数据失败，请刷新重试")}finally{o.value=!1}}));const O=async()=>{try{const e=await dr.get(_.endpoints.units);let t=e.data;if(xr.isSupervisor()){const e=xr.getCompanyId();t=t.filter((t=>t.company_id===e))}d.value=t}catch(e){console.error("获取单位列表失败:",e),v.nk.error("获取单位列表失败")}},j=async e=>{try{const t=await dr.get(_.endpoints.units),a=t.data.find((t=>t.id===parseInt(e)));a&&(n.value=a.name,D[n.value]?I.value=D[n.value]:(I.value=[],console.warn(`未找到管理区 "${n.value}" 的地点选项`)))}catch(t){console.error("获取单位信息失败:",t)}},H=async()=>{try{const e=await dr.get(_.endpoints.wasteTypes);i.value=e.data}catch(e){console.error("获取废物类型失败:",e),v.nk.error("获取废物类型失败")}},Y=async()=>{if(!T.value){T.value=!0,E.value="";try{const e=await ee();S.value=e,console.log("位置获取成功:",e)}catch(e){E.value=e.message,console.error("位置获取失败:",e)}finally{T.value=!1}}},J=async()=>{try{o.value=!0;const e=await dr.get(`${_.endpoints.wasteRecords}/detail/${t.params.id}`);C.value=e.data;const a=e.data;if(console.log("获取到的记录详情:",a),z.unitId=a.unit_id,z.wasteTypeId=a.waste_type_id,await j(z.unitId),a.process&&(W.includes(a.process)?z.process=a.process:(z.process="其他",$.value=a.process)),I.value.includes(a.location)?z.location=a.location:(z.location="其他",R.value=a.location),z.recordId=a.id,a.collection_start_time){const e=a.collection_start_time;if(console.log("原始时间字符串:",e),e.includes(" ")){const[t,a]=e.split(" ");z.collectionDate=t,z.collectionTime=a.substring(0,5),console.log("解析后日期:",t,"时间:",a.substring(0,5))}else{const t=new Date(e+(e.includes("T")?"":"T00:00:00")),a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0");z.collectionDate=`${a}-${o}-${l}`,z.collectionTime=`${r}:${n}`,console.log("解析后日期:",z.collectionDate,"时间:",z.collectionTime)}}if(z.quantity=a.quantity,z.remarks=a.remarks||"",console.log("设置备注字段:",a.remarks),a.longitude&&a.latitude){const e=parseFloat(a.latitude),t=parseFloat(a.longitude);isNaN(e)||isNaN(t)||(V.value.coordinates=`${e.toFixed(6)}, ${t.toFixed(6)}`)}if(a.address&&(V.value.address=a.address),a.province||a.city||a.district){const e=[a.province,a.city,a.district].filter((e=>e&&e.trim()));V.value.region=e.join("")}if(console.log("设置位置信息:",V.value),a.photo_path_before){console.log("收集前照片路径:",a.photo_path_before);const e=X(a.photo_path_before);console.log("解析后的收集前照片路径:",e),U.value=[...e],u.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集前照片完整URL:",t),{name:e.split("/").pop(),url:t,originalPath:e}}))}if(a.photo_path_after){console.log("收集后照片路径:",a.photo_path_after);const e=X(a.photo_path_after);console.log("解析后的收集后照片路径:",e),A.value=[...e],c.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集后照片完整URL:",t),{name:e.split("/").pop(),url:t,originalPath:e}}))}n.value=a.unit_name,y.value=a.created_at,de([...u.value,...c.value])}catch(e){console.error("获取记录详情失败:",e),v.nk.error("获取记录详情失败")}finally{o.value=!1}},Z=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return v.nk.error("只能上传图片文件!"),!1;const o=52428800;return e.size>o?(v.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{w.value=!0,L.value="正在处理图片...",F.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(G())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){F.value=30,L.value="正在处理图片...",console.log("图片处理中...")},drew(){F.value=60,L.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),L.value="图片处理完成",F.value=100,setTimeout((()=>{w.value=!1}),500),t(l)},error(a){console.error("图片压缩失败:",a),L.value="处理失败，使用原始图片",F.value=100,setTimeout((()=>{w.value=!1}),500),t(e)}})}))},te=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),u.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){w.value=!0,L.value="正在处理图片...",F.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(G())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){F.value=30,L.value="正在处理图片...",console.log("图片处理中...")},drew(){F.value=60,L.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),L.value="图片处理完成",F.value=100,t(l)},error(a){console.error("图片压缩失败:",a),L.value="处理失败，使用原始图片",F.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=p.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?p.value[a]=t:p.value.push(t);const o=u.value.findIndex((t=>t.uid===e.uid));o>=0&&(u.value[o].processed=!0),setTimeout((()=>{w.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),v.nk.warning("图片处理失败，将使用原始图片");const t=p.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?p.value[t]=e.raw:p.value.push(e.raw),w.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return pe(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集前照片添加raw属性:",e.raw)),de([...u.value,...c.value]),console.log("更新后的fileListBefore:",u.value),console.log("更新后的photoFilesBefore:",p.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},ne=(e,t)=>{console.log("收集前照片移除:",e),e.originalPath&&(console.log("记录要删除的收集前照片:",e.originalPath),P.value.push(e.originalPath)),u.value=t,pe([...u.value,...c.value])||(x.value=!1),de([...u.value,...c.value])},se=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){w.value=!0,L.value="正在处理图片...",F.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(G())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){F.value=30,L.value="正在处理图片...",console.log("图片处理中...")},drew(){F.value=60,L.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),L.value="图片处理完成",F.value=100,t(l)},error(a){console.error("图片压缩失败:",a),L.value="处理失败，使用原始图片",F.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?m.value[a]=t:m.value.push(t);const o=c.value.findIndex((t=>t.uid===e.uid));o>=0&&(c.value[o].processed=!0),setTimeout((()=>{w.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),v.nk.warning("图片处理失败，将使用原始图片");const t=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?m.value[t]=e.raw:m.value.push(e.raw),w.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return pe(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集后照片添加raw属性:",e.raw)),de([...u.value,...c.value]),console.log("更新后的fileListAfter:",c.value),console.log("更新后的photoFilesAfter:",m.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},ie=(e,t)=>{console.log("收集后照片移除:",e),e.originalPath&&(console.log("记录要删除的收集后照片:",e.originalPath),K.value.push(e.originalPath)),c.value=t,pe([...u.value,...c.value])||(x.value=!1),de([...u.value,...c.value])},de=e=>{g.value=e.map((e=>e.url?(console.log("预览图片URL:",e.url),e.url):e.raw?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e.raw)),console.log("预览图片从raw创建:",e._blobUrl),e._blobUrl):e instanceof File?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e)),console.log("预览图片从File创建:",e._blobUrl),e._blobUrl):"")).filter((e=>e)),console.log("预览图片列表:",g.value)},ue=e=>{console.log("预览图片:",e),de([...u.value,...c.value]);const t=g.value.findIndex((t=>{if(e.url)return t===e.url;if(e.raw){const a=URL.createObjectURL(e.raw),o=t===a;return URL.revokeObjectURL(a),o}return!1}));h.value=-1!==t?t:0,f.value=!0},ce=()=>{f.value=!1},pe=e=>{const t=2097152;return e.some((e=>e.size>t))},me=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);F.value=t,L.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},ge=e=>100===e?"完成":`${e}%`,fe=async()=>{a.value&&await a.value.validate((async t=>{if(!t)return console.log("表单验证失败"),v.nk.error("请填写所有必填字段"),!1;F.value=0,L.value="正在上传文件...",w.value=!0;try{const t=new FormData;if(t.append("unitId",z.unitId),t.append("wasteTypeId",z.wasteTypeId),"其他"===z.process&&$.value.trim()?t.append("process",$.value.trim()):t.append("process",z.process),"其他"===z.location&&R.value.trim()?t.append("location",R.value.trim()):t.append("location",z.location),t.append("collectionDate",z.collectionDate),t.append("collectionTime",z.collectionTime),void 0!==z.quantity&&null!==z.quantity&&""!==z.quantity&&t.append("quantity",z.quantity),t.append("remarks",z.remarks||""),Q.value&&S.value.success&&(S.value.longitude&&t.append("longitude",S.value.longitude),S.value.latitude&&t.append("latitude",S.value.latitude),S.value.address&&t.append("address",S.value.address),S.value.district&&t.append("district",S.value.district),S.value.city&&t.append("city",S.value.city),S.value.province&&t.append("province",S.value.province)),Q.value||(P.value.length>0&&(console.log("发送要删除的收集前照片列表:",P.value),t.append("photos_to_remove_before",JSON.stringify(P.value))),K.value.length>0&&(console.log("发送要删除的收集后照片列表:",K.value),t.append("photos_to_remove_after",JSON.stringify(K.value)))),u.value.length>0){const e=u.value.filter((e=>e.raw)),a=u.value.filter((e=>!e.raw&&e.originalPath));if(e.forEach((e=>{e.raw&&(console.log("添加新的收集前照片:",e.raw.name),t.append("photo_before",e.raw))})),a.length>0){const e=a.map((e=>e.originalPath));console.log("保留的收集前照片路径:",e),t.append("photo_path_before",JSON.stringify(e))}}else!Q.value&&U.value.length>0&&(console.log("用户删除了所有收集前照片，发送NULL标记"),t.append("photo_path_before","NULL"));if(c.value.length>0){const e=c.value.filter((e=>e.raw)),a=c.value.filter((e=>!e.raw&&e.originalPath));if(e.forEach((e=>{e.raw&&(console.log("添加新的收集后照片:",e.raw.name),t.append("photo_after",e.raw))})),a.length>0){const e=a.map((e=>e.originalPath));console.log("保留的收集后照片路径:",e),t.append("photo_path_after",JSON.stringify(e))}}else!Q.value&&A.value.length>0&&(console.log("用户删除了所有收集后照片，发送NULL标记"),t.append("photo_path_after","NULL"));console.log("FormData内容:");for(let[e,a]of t.entries())a instanceof File?console.log(`${e}: File - ${a.name} (${a.type}, ${a.size} bytes)`):console.log(`${e}: ${a}`);z.recordId?(await dr.putForm(`${_.endpoints.wasteRecords}/${z.recordId}`,t,me),v.nk.success("废物记录更新成功！正在跳转到记录列表...")):(await dr.postForm(_.endpoints.wasteRecords,t,me),v.nk.success("废物记录添加成功！正在跳转到记录列表...")),w.value=!1,setTimeout((()=>{if(xr.state.isLoggedIn&&xr.state.user){const t=xr.state.user.role_id;3===t||4===t?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:xr.state.user.unit_id}})}else ke()}),1500)}catch(a){console.error("提交表单失败:",a),a.response&&a.response.data?(console.error("服务器返回错误:",a.response.data),v.nk.error(`提交表单失败: ${a.response.data.error||"未知错误"}`)):v.nk.error("提交表单失败，请检查网络连接"),w.value=!1}}))},ke=()=>{5===xr.state.user.role_id?e.push({name:"SuperAdminRecords"}):3===xr.state.user.role_id||4===xr.state.user.role_id?e.push({name:"AdminRecords"}):xr.state.user.unit_id?e.push({name:"RecordsList",params:{unitId:xr.state.user.unit_id}}):e.push({name:"UnitSelection"})};return(0,l.wB)((()=>z.unitId),(async e=>{e?await j(e):(I.value=[],n.value="")})),{form:z,rules:N,recordForm:a,loading:o,submitting:r,unitName:n,wasteTypes:i,units:d,fileListBefore:u,fileListAfter:c,photoFilesBefore:p,photoFilesAfter:m,previewImages:g,showViewer:f,previewIndex:h,isNew:Q,isAdmin:M,isSupervisor:B,parsePhotoPath:X,handlePhotoBeforeChange:te,handlePhotoBeforeRemove:ne,handlePhotoAfterChange:se,handlePhotoAfterRemove:ie,handlePictureCardPreview:ue,handleBeforeUpload:Z,closeViewer:ce,submitForm:fe,goBack:ke,showUploadProgress:w,uploadPercentage:F,uploadStatus:L,percentageFormat:ge,showLargeFileWarning:x,record:C,locationOptions:I,locationMap:D,customLocation:R,customProcess:$,processOptions:W,deletedPhotosBefore:P,deletedPhotosAfter:K,originalPhotosBefore:U,originalPhotosAfter:A,locationInfo:V,hasLocationInfo:q,locationLoading:T,currentLocationInfo:S,locationError:E,getCurrentLocation:Y,isLocationSupported:ae,isSecureContext:oe,formatCoordinates:le,formatAddress:re,Location:b.aZn}}};const $t=(0,$.A)(Rt,[["render",It],["__scopeId","data-v-696b9a1e"]]);var Wt=$t;const Vt={class:"user-management-container"},Tt={class:"header"},St={class:"content"},Et={class:"toolbar"},Pt={class:"search-container"},Kt={key:0,class:"password-hint"},Ut={key:1,class:"password-hint"},At={class:"dialog-footer"};function Dt(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("search"),c=(0,l.g2)("el-input"),p=(0,l.g2)("plus"),m=(0,l.g2)("el-button"),g=(0,l.g2)("el-table-column"),f=(0,l.g2)("el-tag"),k=(0,l.g2)("el-popconfirm"),v=(0,l.g2)("el-table"),h=(0,l.g2)("el-form-item"),b=(0,l.g2)("el-option"),y=(0,l.g2)("el-select"),w=(0,l.g2)("el-form"),_=(0,l.g2)("el-dialog"),F=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Vt,[(0,l.Lk)("div",Tt,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[10]||(t[10]=(0,l.eW)(" 返回 "))]),t[11]||(t[11]=(0,l.Lk)("h1",null,"人员管理",-1)),t[12]||(t[12]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",St,[(0,l.Lk)("div",Et,[(0,l.Lk)("div",Pt,[(0,l.bF)(c,{modelValue:o.searchKeyword,"onUpdate:modelValue":t[1]||(t[1]=e=>o.searchKeyword=e),placeholder:"请输入姓名关键字搜索",clearable:"",onClear:o.clearSearch,class:"search-input"},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1})])),_:1},8,["modelValue","onClear"])]),(0,l.bF)(m,{type:"primary",onClick:o.openAddDialog},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 添加用户 "))])),_:1},8,["onClick"])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(v,{data:o.users,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,l.k6)((()=>[(0,l.bF)(g,{type:"index",label:"序号",width:"70",align:"center"}),(0,l.bF)(g,{prop:"username",label:"姓名",width:"120"}),(0,l.bF)(g,{prop:"phone",label:"手机号",width:"140"}),(0,l.bF)(g,{prop:"role_name",label:"角色",width:"120"}),(0,l.bF)(g,{prop:"unit_name",label:"单位","min-width":"120"}),o.isSystemAdmin?((0,l.uX)(),(0,l.Wv)(g,{key:0,prop:"company_name",label:"公司",width:"120"})):(0,l.Q3)("",!0),(0,l.bF)(g,{label:"状态",width:"100",align:"center"},{default:(0,l.k6)((e=>[(0,l.bF)(f,{type:1===e.row.status?"success":"danger"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.status?"正常":"已停用"),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(g,{label:"日志权限",width:"100",align:"center"},{default:(0,l.k6)((e=>[(0,l.bF)(f,{type:1===e.row.can_view_logs?"success":"info"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.can_view_logs?"允许":"禁止"),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(g,{label:"操作",width:"300",fixed:"right"},{default:(0,l.k6)((e=>[o.isSuperAdmin||2!==e.row.role_id?((0,l.uX)(),(0,l.Wv)(m,{key:0,size:"small",onClick:t=>o.handleEdit(e.row)},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0),o.isSuperAdmin||2!==e.row.role_id?((0,l.uX)(),(0,l.Wv)(m,{key:1,size:"small",type:1===e.row.status?"warning":"success",onClick:t=>o.handleStatusChange(e.row)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.status?"停用":"恢复"),1)])),_:2},1032,["type","onClick"])):(0,l.Q3)("",!0),o.canManageLogPermissions?((0,l.uX)(),(0,l.Wv)(m,{key:2,size:"small",type:1===e.row.can_view_logs?"warning":"primary",onClick:t=>o.handleLogPermissionChange(e.row)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.can_view_logs?"禁止日志":"允许日志"),1)])),_:2},1032,["type","onClick"])):(0,l.Q3)("",!0),o.isSuperAdmin||2!==e.row.role_id?((0,l.uX)(),(0,l.Wv)(k,{key:3,title:"确定要删除此用户吗？",onConfirm:t=>o.handleDelete(e.row)},{reference:(0,l.k6)((()=>[(0,l.bF)(m,{size:"small",type:"danger"},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])):(0,l.Q3)("",!0)])),_:1})])),_:1},8,["data"])),[[F,o.loading]])]),(0,l.bF)(_,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[9]||(t[9]=e=>o.dialogVisible=e),title:o.isEdit?"编辑用户":"添加用户",width:"500px"},{footer:(0,l.k6)((()=>[(0,l.Lk)("span",At,[(0,l.bF)(m,{onClick:t[8]||(t[8]=e=>o.dialogVisible=!1)},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(m,{type:"primary",onClick:o.submitForm,loading:o.formLoading},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(w,{ref:"userForm",model:o.form,rules:o.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,l.k6)((()=>[(0,l.bF)(h,{label:"姓名",prop:"username"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.username,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.username=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),(0,l.bF)(h,{label:"手机号",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.phone,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,l.bF)(h,{label:"角色",prop:"roleId"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:o.form.roleId,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.roleId=e),placeholder:"请选择角色",style:{width:"100%"}},{default:(0,l.k6)((()=>[o.isSystemAdmin?((0,l.uX)(),(0,l.Wv)(b,{key:0,value:5,label:"系统超级管理员"})):(0,l.Q3)("",!0),o.isSystemAdmin||o.isCompanyAdmin?((0,l.uX)(),(0,l.Wv)(b,{key:1,value:3,label:"公司管理员"})):(0,l.Q3)("",!0),o.isSystemAdmin||o.isCompanyAdmin?((0,l.uX)(),(0,l.Wv)(b,{key:2,value:4,label:"监督人员"})):(0,l.Q3)("",!0),(0,l.bF)(b,{value:2,label:"单位管理员"}),(0,l.bF)(b,{value:1,label:"基层员工"})])),_:1},8,["modelValue"])])),_:1}),3!==o.form.roleId&&4!==o.form.roleId&&5!==o.form.roleId?((0,l.uX)(),(0,l.Wv)(h,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:o.form.unitId,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"},disabled:!e.isAdmin&&o.isEdit},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.units,(e=>((0,l.uX)(),(0,l.Wv)(b,{key:e.id,label:o.isSystemAdmin?`${e.name} (${e.company_name})`:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})):(0,l.Q3)("",!0),o.isSystemAdmin?((0,l.uX)(),(0,l.Wv)(h,{key:1,label:"公司",prop:"companyId"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:o.form.companyId,"onUpdate:modelValue":t[6]||(t[6]=e=>o.form.companyId=e),placeholder:"请选择公司",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.companies,(e=>((0,l.uX)(),(0,l.Wv)(b,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(h,{label:"密码",prop:o.isEdit?"":"password"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.password,"onUpdate:modelValue":t[7]||(t[7]=e=>o.form.password=e),placeholder:"请输入密码",type:"password","show-password":""},null,8,["modelValue"]),o.isEdit?((0,l.uX)(),(0,l.CE)("div",Ut,"不修改密码请留空")):((0,l.uX)(),(0,l.CE)("div",Kt,"所有账号必须设置密码"))])),_:1},8,["prop"])])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),t[18]||(t[18]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var Xt={name:"UserManagement",components:{ArrowLeft:b.nkM,Plus:b.FWt,Search:b.vji},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)(!1),o=(0,k.KR)(!1),r=(0,k.KR)(!1),n=(0,k.KR)(null),i=(0,k.KR)([]),d=(0,k.KR)([]),u=(0,k.KR)([]),c=(0,k.KR)(""),p=(0,k.KR)([]),m=(0,l.EW)((()=>xr.isSystemAdmin())),g=(0,l.EW)((()=>xr.isCompanyAdmin())),f=(0,l.EW)((()=>xr.isAdmin())),h=(0,l.EW)((()=>xr.state.isLoggedIn&&xr.state.user&&1===xr.state.user.can_view_logs)),b=(0,l.EW)((()=>xr.state.isLoggedIn?xr.state.user.unit_id:null)),y=(0,k.Kh)({id:null,username:"",phone:"",roleId:1,unitId:null,companyId:null,password:""}),w={username:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],unitId:[{required:function(){return 3!==y.roleId&&4!==y.roleId&&5!==y.roleId},message:"请选择单位",trigger:"change"}],companyId:[{required:function(){return m.value&&!r.value},message:"请选择公司",trigger:"change"}],password:[{required:function(){return!r.value},message:"请输入密码",trigger:"blur"},{validator:(e,t,a)=>{t&&t.length>0?t.length<1||t.length>20?a(new Error("长度在 1 到 20 个字符")):a():r.value?a():a(new Error("请输入密码"))},trigger:"blur"}]},F=async()=>{t.value=!0;try{let e;e=f.value?await dr.get(_.endpoints.users):await dr.get(`${_.endpoints.usersByUnit}/${b.value}`),i.value=e.data,p.value=e.data}catch(e){console.error("Error fetching users:",e),v.nk.error("获取用户列表失败")}finally{t.value=!1}},L=async()=>{try{const e=await dr.get(_.endpoints.units);d.value=e.data}catch(e){console.error("Error fetching units:",e),v.nk.error("获取单位列表失败")}},x=async()=>{if(m.value)try{const e=await dr.get(_.endpoints.companies);u.value=e.data}catch(e){console.error("Error fetching companies:",e),v.nk.error("获取公司列表失败")}},C=()=>{r.value=!1,V(),o.value=!0,f.value||(y.unitId=b.value),m.value||(y.companyId=xr.getCompanyId())},I=e=>{r.value=!0,y.id=e.id,y.username=e.username,y.phone=e.phone,y.roleId=e.role_id,y.unitId=e.unit_id,y.companyId=e.company_id,y.password="",o.value=!0},R=async e=>{try{await dr.delete(`${_.endpoints.users}/${e.id}`),v.nk.success("用户删除成功"),F()}catch(t){console.error("Error deleting user:",t);let e="删除用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),v.nk.error(e)}},$=async e=>{const t=1===e.status?0:1,a=1===t?"恢复":"停用";try{await dr.put(`${_.endpoints.users}/${e.id}/status`,{status:t}),v.nk.success(`用户${a}成功`),F()}catch(o){console.error("状态变更失败:",o);let e=`${a}用户失败`;o.response&&o.response.data&&o.response.data.error&&(e=o.response.data.error),v.nk.error(e)}},W=async e=>{const t=1===e.can_view_logs?null:1,a=1===t?"允许查看日志":"禁止查看日志";try{const o=_.endpoints.userLogPermission.replace(":id",e.id);await dr.put(o,{can_view_logs:t}),v.nk.success(`用户日志权限设置成功：${a}`),xr.state.user&&xr.state.user.id===e.id&&xr.updateUserInfo({can_view_logs:t}),F()}catch(o){console.error("日志权限变更失败:",o);let e="设置日志权限失败";o.response&&o.response.data&&o.response.data.error&&(e=o.response.data.error),v.nk.error(e)}},V=()=>{n.value&&n.value.resetFields(),y.id=null,y.username="",y.phone="",y.roleId=1,y.unitId=null,y.companyId=null,y.password=""},T=()=>{n.value.validate((async e=>{if(e){a.value=!0;try{const e={username:y.username,phone:y.phone,roleId:y.roleId,unitId:3!==y.roleId&&4!==y.roleId&&5!==y.roleId?y.unitId:null};m.value&&y.companyId&&(e.companyId=y.companyId),y.password&&(e.password=y.password),r.value?(await dr.put(`${_.endpoints.users}/${y.id}`,e),v.nk.success("用户更新成功")):(await dr.post(_.endpoints.users,e),v.nk.success("用户添加成功")),o.value=!1,F()}catch(t){console.error("Error submitting user form:",t);let e=r.value?"更新用户失败":"添加用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),v.nk.error(e)}finally{a.value=!1}}else v.nk.warning("请完成必填项")}))},S=()=>{e.back()},E=()=>{if(c.value.trim()){const e=c.value.toLowerCase();i.value=p.value.filter((t=>t.username.toLowerCase().includes(e)))}else i.value=p.value},P=()=>{c.value="",E()};return(0,l.sV)((()=>{F(),L(),x()})),(0,l.wB)(c,(()=>{E()})),{loading:t,formLoading:a,dialogVisible:o,isEdit:r,userForm:n,users:i,units:d,companies:u,form:y,rules:w,isSystemAdmin:m,isCompanyAdmin:g,isSuperAdmin:f,currentUnitId:b,canManageLogPermissions:h,openAddDialog:C,handleEdit:I,handleDelete:R,handleStatusChange:$,handleLogPermissionChange:W,submitForm:T,goBack:S,searchKeyword:c,filterUsers:E,clearSearch:P}}};const Qt=(0,$.A)(Xt,[["render",Dt],["__scopeId","data-v-454f6f64"]]);var Mt=Qt;const Bt={class:"admin-records-container"},qt={class:"content"},zt={class:"actions"},Nt={class:"filter-header"},Ot={class:"filter-form-container"},jt={class:"quantity-range"},Ht={class:"input-with-clear"},Yt={class:"input-with-clear"},Jt={class:"filter-actions"},Gt={class:"records-wrapper"},Zt={class:"card-header"},ea={class:"card-actions"},ta={class:"table-wrapper",ref:"tableContainer"},aa={key:0,class:"location-info-cell"},oa={key:0,class:"photo-preview"},la=["onClick"],ra={key:0,class:"photo-count"},na={key:1},sa={key:0,class:"photo-preview"},ia=["onClick"],da={key:0,class:"photo-count"},ua={key:1},ca={class:"operation-buttons"},pa={key:0,class:"loading-row"},ma={key:1,class:"load-more-row"},ga={key:2,class:"no-more-row"},fa={key:0,class:"empty-block"};function ka(e,t,a,r,n,s){const d=(0,l.g2)("plus"),u=(0,l.g2)("el-icon"),c=(0,l.g2)("el-button"),p=(0,l.g2)("user"),m=(0,l.g2)("document"),g=(0,l.g2)("refresh"),f=(0,l.g2)("arrow-down"),k=(0,l.g2)("arrow-up"),v=(0,l.g2)("el-option"),h=(0,l.g2)("el-select"),b=(0,l.g2)("el-form-item"),y=(0,l.g2)("el-col"),w=(0,l.g2)("el-input"),_=(0,l.g2)("el-switch"),F=(0,l.g2)("el-row"),L=(0,l.g2)("el-date-picker"),x=(0,l.g2)("el-input-number"),C=(0,l.g2)("CircleClose"),I=(0,l.g2)("el-form"),R=(0,l.g2)("el-card"),$=(0,l.g2)("download"),W=(0,l.g2)("el-table-column"),V=(0,l.g2)("el-image"),T=(0,l.g2)("loading"),S=(0,l.g2)("el-table"),E=(0,l.g2)("el-empty"),P=(0,l.g2)("el-image-viewer"),K=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Bt,[t[27]||(t[27]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"固体废物记录")],-1)),(0,l.Lk)("div",qt,[(0,l.Lk)("div",zt,[(0,l.bF)(c,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isSuperAdmin&&!r.isSupervisor?((0,l.uX)(),(0,l.Wv)(c,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[12]||(t[12]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),r.isSuperAdmin&&r.canViewLogs?((0,l.uX)(),(0,l.Wv)(c,{key:1,type:"warning",onClick:r.goToOperationLogs},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(m)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 操作日志 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(c,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,l.bF)(R,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Nt,[t[15]||(t[15]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(c,{type:"primary",link:"",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(u,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})):((0,l.uX)(),(0,l.Wv)(u,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",Ot,[(0,l.bF)(I,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"所属单位"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.unitId=e),placeholder:"选择单位",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(v,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(v,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"产生工序"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:r.filterForm.process,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.process=e),placeholder:"输入工序关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),r.isSuperAdmin?((0,l.uX)(),(0,l.Wv)(y,{key:0,xs:24,sm:12,md:4,lg:4,xl:4},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"监督数据"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.filterForm.showSupervised,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.showSupervised=e),"active-text":"显示","inactive-text":"隐藏","active-color":"#13ce66","inactive-color":"#ff4949","active-value":!0,"inactive-value":!1,style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(F,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:24,md:10,lg:10,xl:10},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(L,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:8,lg:8,xl:8},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",jt,[(0,l.Lk)("div",Ht,[(0,l.bF)(x,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"100%"}},null,8,["modelValue"]),null!==r.filterForm.minQuantity?((0,l.uX)(),(0,l.Wv)(u,{key:0,class:"clear-icon",onClick:t[8]||(t[8]=e=>r.filterForm.minQuantity=null)},{default:(0,l.k6)((()=>[(0,l.bF)(C)])),_:1})):(0,l.Q3)("",!0)]),t[16]||(t[16]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.Lk)("div",Yt,[(0,l.bF)(x,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[9]||(t[9]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"100%"}},null,8,["modelValue","min"]),null!==r.filterForm.maxQuantity?((0,l.uX)(),(0,l.Wv)(u,{key:0,class:"clear-icon",onClick:t[10]||(t[10]=e=>r.filterForm.maxQuantity=null)},{default:(0,l.k6)((()=>[(0,l.bF)(C)])),_:1})):(0,l.Q3)("",!0)])])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:6,lg:6,xl:6,class:"filter-buttons-col"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Jt,[(0,l.bF)(c,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("刷新筛选")]))),_:1},8,["onClick"]),(0,l.bF)(c,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])],512),[[o.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",Gt,[(0,l.bF)(R,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Zt,[t[22]||(t[22]=(0,l.Lk)("h3",{class:"table-title"},"所有废物记录",-1)),(0,l.Lk)("div",ea,[(0,l.bF)(c,{type:"warning",onClick:r.exportWithoutImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[19]||(t[19]=(0,l.eW)(" 无照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,l.bF)(c,{type:"warning",onClick:r.exportWithImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[20]||(t[20]=(0,l.eW)(" 包含首张照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,l.bF)(c,{type:"warning",onClick:r.exportWithAllImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[21]||(t[21]=(0,l.eW)(" 包含全部照片(不推荐) "))])),_:1},8,["onClick","loading"])])]),(0,l.Lk)("div",ta,[(0,l.bo)(((0,l.uX)(),(0,l.Wv)(S,{ref:"tableRef",data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:r.tableHeight},{append:(0,l.k6)((()=>[r.loadingMore?((0,l.uX)(),(0,l.CE)("div",pa,[(0,l.bF)(u,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(T)])),_:1}),t[25]||(t[25]=(0,l.eW)(" 正在加载... "))])):r.hasMore&&r.records.length>0?((0,l.uX)(),(0,l.CE)("div",ma,[(0,l.bF)(c,{type:"primary",onClick:r.loadMore,disabled:r.loadingMore,size:"small"},{default:(0,l.k6)((()=>[t[26]||(t[26]=(0,l.eW)(" 点击加载更多 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})])),_:1},8,["onClick","disabled"])])):r.records.length>0?((0,l.uX)(),(0,l.CE)("div",ga," 已全部加载 ")):(0,l.Q3)("",!0)])),default:(0,l.k6)((()=>[(0,l.bF)(W,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,l.bF)(W,{prop:"unit_name",label:"单位","min-width":"100"}),(0,l.bF)(W,{prop:"waste_type_name",label:"废物类型","min-width":"100"}),(0,l.bF)(W,{prop:"location",label:"产生地点","min-width":"100"}),(0,l.bF)(W,{prop:"process",label:"产生工序","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.process||"无"),1)])),_:1}),(0,l.bF)(W,{prop:"remarks",label:"备注","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,l.bF)(W,{label:"地理位置","min-width":"200",class:"mobile-hidden"},{default:(0,l.k6)((e=>[r.hasLocationInfo(e.row)?((0,l.uX)(),(0,l.CE)("div",aa,[(0,l.Lk)("span",null,(0,i.v_)(r.formatLocationDisplay(e.row)),1)])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(W,{prop:"collection_start_time",label:"收集开始时间","min-width":"160"}),(0,l.bF)(W,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(null!==e.row.quantity&&void 0!==e.row.quantity?parseFloat(e.row.quantity).toFixed(3):""),1)])),_:1}),(0,l.bF)(W,{prop:"creator_name",label:"填报人","min-width":"100"}),(0,l.bF)(W,{prop:"created_at",label:"记录时间","min-width":"160"}),(0,l.bF)(W,{label:"清理前照片","min-width":"140",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",oa,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,la)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",ra,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",na,"无"))])),_:1}),(0,l.bF)(W,{label:"清理后照片","min-width":"140",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",sa,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,ia)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",da,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",ua,"无"))])),_:1}),(0,l.bF)(W,{label:"操作","min-width":"130"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",ca,[(0,l.bF)(c,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[23]||(t[23]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,l.bF)(c,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[24]||(t[24]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","height"])),[[K,r.loading]])],512),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",fa,[(0,l.bF)(E,{description:"暂无废物记录"})]))])),_:1})])]),r.showViewer?((0,l.uX)(),(0,l.Wv)(P,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}const va=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},ha=(e,t)=>{if(!e.photos)return[];try{const a=JSON.parse(e.photos);return Array.isArray(a)?a.filter((e=>e.type===t)):[]}catch(a){return console.error("解析照片JSON失败:",a),[]}};var ba={name:"AdminRecordsView",components:{Plus:b.FWt,Refresh:b.C42,User:b.KJW,ArrowDown:b.yd$,ArrowUp:b.DoI,Download:b.f5X,ElImageViewer:De.Tg,Loading:b.Rhj,CircleClose:b.R$5,Document:b.yoT},setup(){const e=(0,s.rd)(),t=(0,k.KR)([]),a=(0,k.KR)(!1),o=(0,k.KR)([]),r=(0,k.KR)([]),n=(0,k.KR)(!0),i=_.baseURL,d=(0,k.KR)(750),u=(0,k.KR)(null),c=()=>{const e=window.innerHeight,t=Math.min(Math.max(.85*e,650),900);d.value=t,console.log("设置表格高度:",t)},p=()=>{c()},m=(0,k.KR)(!1),g=(0,k.KR)([]),f=(0,k.KR)(0),b=(0,k.KR)(1),w=(0,k.KR)(1),F=(0,k.KR)(20),L=(0,k.KR)(!0),x=(0,k.KR)(!1),C=(0,k.KR)(null),I=(0,k.Kh)({unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:"",process:"",showSupervised:!0}),R=(0,k.KR)(null);(0,l.wB)([()=>I.unitId,()=>I.dateRange,()=>I.wasteTypeId,()=>I.minQuantity,()=>I.maxQuantity,()=>I.location,()=>I.process,()=>I.showSupervised],(()=>{R.value&&clearTimeout(R.value),R.value=setTimeout((()=>{b.value=1,S()}),300)}));const $=(0,l.EW)((()=>t.value.filter((e=>{if(I.unitId&&e.unit_id!==I.unitId)return!1;if(I.wasteTypeId&&e.waste_type_id!==I.wasteTypeId)return!1;if(null!==I.minQuantity&&""!==I.minQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)<I.minQuantity)return!1;if(null!==I.maxQuantity&&""!==I.maxQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)>I.maxQuantity)return!1;if(I.location&&!e.location.toLowerCase().includes(I.location.toLowerCase()))return!1;if(I.process&&!e.process?.toLowerCase().includes(I.process.toLowerCase()))return!1;if(I.dateRange&&2===I.dateRange.length){const t=new Date(I.dateRange[0]),a=new Date(I.dateRange[1]);if(a.setHours(23,59,59,999),!e.collection_start_time)return!1;{const o=W(e.collection_start_time);if(o<t||o>a)return!1}}return!0})))),W=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)};(0,l.sV)((async()=>{if(3!==xr.state.user.role_id&&4!==xr.state.user.role_id)return v.nk.error("权限不足"),void e.push("/login");await V(),await T(),S(),c(),window.addEventListener("resize",p)})),(0,l.hi)((()=>{window.removeEventListener("resize",p)}));const V=async()=>{try{const e=await dr.get(_.endpoints.units);o.value=e.data}catch(e){console.error("获取单位列表失败:",e),v.nk.error("获取单位列表失败")}},T=async()=>{try{const e=await y.A.get(_.getUrl(_.endpoints.wasteTypes));r.value=e.data}catch(e){console.error("获取废物类型列表失败:",e),v.nk.error("获取废物类型列表失败")}},S=async(e=!1)=>{console.log(`开始加载数据，是否加载更多: ${e}`),e?(x.value=!0,console.log(`加载更多: 当前page=${b.value}, currentPage=${w.value}`)):(a.value=!0,b.value=1,w.value=1,t.value=[],console.log("初始化加载: 重置页码和记录"));try{const a={page:b.value,pageSize:F.value,wasteTypeId:I.wasteTypeId,minQuantity:I.minQuantity,maxQuantity:I.maxQuantity,location:I.location,process:I.process,showSupervised:I.showSupervised?"true":"false",unitId:I.unitId?I.unitId:void 0};console.log("发送请求参数:",a),I.dateRange&&2===I.dateRange.length&&(a.dateRange=JSON.stringify(I.dateRange));const o=await dr.get(`${_.endpoints.wasteRecords}/user/${xr.state.user.id}`,a);console.log("服务器返回数据:",{recordsCount:o.data.records.length,hasMore:o.data.hasMore});const l=o.data.records.map((e=>({...e,created_at:E(e.created_at),collection_start_time:E(e.collection_start_time)})));e?(t.value=[...t.value,...l],console.log(`追加${l.length}条记录，现在总共有${t.value.length}条记录`)):(t.value=l,console.log(`加载了${l.length}条新记录`)),L.value=o.data.hasMore,console.log(`服务器是否有更多数据: ${L.value}`),L.value?(b.value++,console.log(`有更多数据，下一页将是: page=${b.value}`)):console.log("没有更多数据了")}catch(o){console.error("获取废物记录失败:",o),v.nk.error("获取废物记录失败")}finally{a.value=!1,x.value=!1,console.log(`加载完成，状态: loading=${a.value}, loadingMore=${x.value}`)}},E=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})},P=()=>{S()},K=()=>{3===xr.state.user.role_id||4===xr.state.user.role_id?e.push("/record/new"):e.push(`/unit/${xr.state.user.unit_id}`)},U=()=>{e.push("/user-management")},A=()=>{e.push("/operation-logs")},D=t=>{e.push(`/record/${t}`)},X=async()=>{await S(),v.nk.success("筛选已应用")},Q=async()=>{I.unitId=null,I.dateRange=null,I.wasteTypeId=null,I.minQuantity=null,I.maxQuantity=null,I.location="",I.process="",I.showSupervised=!0,await S(),v.nk.info("筛选条件已重置")},M=async()=>{try{(0,v.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:I.wasteTypeId?I.wasteTypeId:void 0,minQuantity:I.minQuantity?I.minQuantity:void 0,maxQuantity:I.maxQuantity?I.maxQuantity:void 0,location:I.location||void 0,process:I.process||void 0,dateRange:I.dateRange?JSON.stringify(I.dateRange):void 0,unitId:I.unitId?I.unitId:void 0,showSupervised:I.showSupervised?"true":"false",exportType:"first_image"};console.log("导出记录的筛选条件:",t);const{data:l}=await dr.get(`${_.endpoints.exportWasteRecords}/${xr.state.user.id}`,t);if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return e.close(),v.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=I.unitId?o.value.find((e=>e.id===I.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_${r}`,s=200,i=l.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),v.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录...`);let u=0;for(let a=0;a<d;a++){const t=a*s,o=Math.min((a+1)*s,i),r=l.slice(t,o),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${o}条记录...`);const p=r.map((e=>{const t=va(e.photo_path_before),a=va(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"产生工序":e.process||"无","备注":e.remarks||"无","收集开始时间":E(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":E(e.created_at),"清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],g=window.location.origin,f=(t,o)=>{const l=Math.round(t/o*100);e.setText(`正在导出第${a+1}/${d}部分：${l}% (${t}/${o})`)},k=await Ne(p,c,m,g,f);k&&u++}e.close(),u===d?d>1?v.nk.success(`成功导出${d}个文件`):v.nk.success("导出成功"):u>0?v.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):v.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),v.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,Xe.Ks.service().close()}},B=async()=>{try{(0,v.nk)({message:"导出大量包含全部图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:I.wasteTypeId?I.wasteTypeId:void 0,minQuantity:I.minQuantity?I.minQuantity:void 0,maxQuantity:I.maxQuantity?I.maxQuantity:void 0,location:I.location||void 0,process:I.process||void 0,dateRange:I.dateRange?JSON.stringify(I.dateRange):void 0,unitId:I.unitId?I.unitId:void 0,showSupervised:I.showSupervised?"true":"false",exportType:"all_images"};console.log("导出记录的筛选条件:",t);const{data:l}=await dr.get(`${_.endpoints.exportWasteRecords}/${xr.state.user.id}`,t);if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return e.close(),v.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=I.unitId?o.value.find((e=>e.id===I.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_全部照片_${r}`,s=50,i=l.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),v.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录的全部照片...`);let u=0;for(let a=0;a<d;a++){const t=a*s,o=Math.min((a+1)*s,i),r=l.slice(t,o),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${o}条记录...`);const p=r.map((e=>{const t=va(e.photo_path_before),a=va(e.photo_path_after),o={"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":E(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":E(e.created_at)};for(let l=0;l<5;l++)o[`清理前照片${l+1}`]=l<t.length?t[l]:"";for(let l=0;l<5;l++)o[`清理后照片${l+1}`]=l<a.length?a[l]:"";return o})),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"}];for(let e=0;e<5;e++)m.push({text:`清理前照片${e+1}`,field:`清理前照片${e+1}`,isImage:!0});for(let e=0;e<5;e++)m.push({text:`清理后照片${e+1}`,field:`清理后照片${e+1}`,isImage:!0});const g=window.location.origin,f=(t,o)=>{const l=Math.round(t/o*100);e.setText(`正在导出第${a+1}/${d}部分：${l}% (${t}/${o})`)},k=await Ne(p,c,m,g,f);k&&u++}e.close(),u===d?d>1?v.nk.success(`成功导出${d}个文件`):v.nk.success("导出成功"):u>0?v.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):v.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),v.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,Xe.Ks.service().close()}},q=async()=>{try{const e=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:I.wasteTypeId?I.wasteTypeId:void 0,minQuantity:I.minQuantity?I.minQuantity:void 0,maxQuantity:I.maxQuantity?I.maxQuantity:void 0,location:I.location||void 0,process:I.process||void 0,dateRange:I.dateRange?JSON.stringify(I.dateRange):void 0,unitId:I.unitId?I.unitId:void 0,showSupervised:I.showSupervised?"true":"false",exportType:"no_images"},{data:l}=await dr.get(`${_.endpoints.exportWasteRecords}/${xr.state.user.id}`,t);if(0===l.length)return e.close(),v.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=I.unitId?o.value.find((e=>e.id===I.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_${r}`,s=1e3,i=l.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),v.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录...`);let u=0;for(let a=0;a<d;a++){const t=a*s,o=Math.min((a+1)*s,i),r=l.slice(t,o),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${o}条记录...`);const p=r.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":E(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":E(e.created_at),"清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],g=await Oe(p,c,m);g&&u++}e.close(),u===d?d>1?v.nk.success(`成功导出${d}个文件`):v.nk.success("导出成功"):u>0?v.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):v.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),v.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,Xe.Ks.service().close()}},z=e=>{h.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await dr.delete(`${_.getUrl(_.endpoints.wasteRecords)}/${e.id}`),v.nk.success("删除成功"),await S()}catch(t){console.error("删除记录失败:",t),v.nk.error("删除记录失败")}})).catch((()=>{v.nk.info("已取消删除")}))},N=(e,t)=>{const a=Array.isArray(e)?e:[e];g.value=a.map((e=>`${i}${e}`)),f.value=t||0,m.value=!0},O=()=>{m.value=!1},j=()=>{console.log("手动触发加载更多");const e=document.querySelector(".el-table__body-wrapper"),a=e?e.scrollTop:0;return S(!0).then((()=>{console.log("加载完成，当前记录数:",t.value.length),setTimeout((()=>{e&&(e.scrollTop=a)}),10)})).catch((e=>{console.error("加载失败:",e),v.nk.error("加载更多数据失败")}))},H=e=>e+1,Y=(0,l.EW)((()=>xr.state.isLoggedIn&&xr.state.user&&(3===xr.state.user.role_id||4===xr.state.user.role_id))),J=(0,l.EW)((()=>xr.state.isLoggedIn&&xr.state.user&&1===xr.state.user.can_view_logs)),G=(0,l.EW)((()=>xr.state.isLoggedIn&&xr.state.user&&4===xr.state.user.role_id)),Z=e=>e.address||e.district||e.city||e.province,ee=e=>{const t=[];return e.address&&t.push(e.address),e.district&&t.push(e.district),e.city&&t.push(e.city),t.join("，")};return{records:t,filteredRecords:$,loading:a,units:o,wasteTypes:r,showFilterPanel:n,filterForm:I,applyFilter:X,resetFilter:Q,exportWithImages:M,exportWithAllImages:B,exportWithoutImages:q,parsePhotoPath:va,getPhotosByType:ha,refreshRecords:P,addNewRecord:K,goToUserManagement:U,goToOperationLogs:A,editRecord:D,confirmDelete:z,showViewer:m,previewImages:g,previewIndex:f,previewPhoto:N,closeViewer:O,baseUrl:i,page:b,currentPage:w,pageSize:F,hasMore:L,loadingMore:x,indexMethod:H,tableHeight:d,debounceTimer:R,tableRef:C,loadMore:j,tableContainer:u,isSuperAdmin:Y,canViewLogs:J,isSupervisor:G,auth:xr,hasLocationInfo:Z,formatLocationDisplay:ee}}};const ya=(0,$.A)(ba,[["render",ka],["__scopeId","data-v-6a1b3ea8"]]);var wa=ya;const _a={class:"user-profile-container"},Fa={class:"header"},La={class:"content"};function xa(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),i=(0,l.g2)("el-icon"),d=(0,l.g2)("el-input"),u=(0,l.g2)("el-form-item"),c=(0,l.g2)("el-divider"),p=(0,l.g2)("el-button"),m=(0,l.g2)("el-form"),g=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",_a,[(0,l.Lk)("div",Fa,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(i,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[6]||(t[6]=(0,l.eW)(" 返回 "))]),t[7]||(t[7]=(0,l.Lk)("h1",null,"个人账户设置",-1)),t[8]||(t[8]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",La,[(0,l.bF)(g,{class:"profile-card"},{header:(0,l.k6)((()=>t[9]||(t[9]=[(0,l.Lk)("div",{class:"card-header"},[(0,l.Lk)("h3",null,"账户信息")],-1)]))),default:(0,l.k6)((()=>[(0,l.bF)(m,{ref:"profileForm",model:o.form,rules:o.rules,"label-position":"top",class:"profile-form"},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"手机号码"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.phone,"onUpdate:modelValue":t[1]||(t[1]=e=>o.form.phone=e),disabled:"",placeholder:"手机号码"},null,8,["modelValue"]),t[10]||(t[10]=(0,l.Lk)("div",{class:"field-hint"},"手机号码不可修改",-1))])),_:1}),(0,l.bF)(u,{label:"用户名",prop:"username"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.username,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.username=e),placeholder:"请输入您的名字"},null,8,["modelValue"])])),_:1}),(0,l.bF)(c,null,{default:(0,l.k6)((()=>t[11]||(t[11]=[(0,l.eW)("修改密码（可选）")]))),_:1}),(0,l.bF)(u,{label:"原密码",prop:"oldPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.oldPassword,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.oldPassword=e),placeholder:"请输入原密码",type:"password","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,{label:"新密码",prop:"newPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.newPassword,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.newPassword=e),placeholder:"请输入新密码",type:"password","show-password":""},null,8,["modelValue"]),t[12]||(t[12]=(0,l.Lk)("div",{class:"field-hint"},"如不修改密码，请留空",-1))])),_:1}),(0,l.bF)(u,{label:"确认新密码",prop:"confirmPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.confirmPassword,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.confirmPassword=e),placeholder:"请再次输入新密码",type:"password","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p,{type:"primary",onClick:o.saveProfile,loading:o.loading},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)(" 保存修改 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules"])])),_:1})])])}var Ca={name:"UserProfile",components:{ArrowLeft:b.nkM},setup(){const e=(0,s.rd)(),t=(0,k.KR)(null),a=(0,k.KR)(!1),o=(0,k.Kh)({username:"",phone:"",oldPassword:"",newPassword:"",confirmPassword:""}),r=(0,k.Kh)({username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度应为2-20个字符",trigger:"blur"}],oldPassword:[{validator:(e,t,a)=>{o.newPassword&&!t?a(new Error("修改密码时需要输入原密码")):a()},trigger:"blur"}],newPassword:[{min:1,max:20,message:"密码长度应为1-20个字符",trigger:"blur"}],confirmPassword:[{validator:(e,t,a)=>{o.newPassword?t?t!==o.newPassword?a(new Error("两次输入的密码不一致")):a():a(new Error("请再次输入新密码")):a()},trigger:"blur"}]});(0,l.sV)((()=>{if(!xr.state.isLoggedIn)return v.nk.error("请先登录"),void e.push("/login");o.username=xr.state.user.username||"",o.phone=xr.state.user.phone||""}));const n=()=>{e.go(-1)},i=async()=>{if(xr.state.isLoggedIn)try{await t.value.validate(),await h.s.confirm("确定要保存这些修改吗？","确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),a.value=!0;const e={username:o.username};o.newPassword&&(e.oldPassword=o.oldPassword,e.newPassword=o.newPassword),await dr.put(_.getUrl(`/api/users/${xr.state.user.id}/profile`),e),xr.updateUserInfo({...xr.state.user,username:o.username}),v.nk.success("个人资料已更新"),o.oldPassword="",o.newPassword="",o.confirmPassword="",setTimeout((()=>{n()}),1500)}catch(e){if("cancel"===e)return;e.response&&e.response.data&&e.response.data.error?v.nk.error(e.response.data.error):e.message?v.nk.error(e.message):v.nk.error("保存失败，请重试")}finally{a.value=!1}else v.nk.error("请先登录")};return{profileForm:t,form:o,rules:r,loading:a,goBack:n,saveProfile:i}}};const Ia=(0,$.A)(Ca,[["render",xa],["__scopeId","data-v-6ab973ca"]]);var Ra=Ia;const $a={class:"operation-logs-container"},Wa={class:"header"},Va={class:"content"},Ta={class:"filter-section"},Sa={class:"filter-header"},Ea={class:"stats-section"},Pa={class:"stat-content"},Ka={class:"stat-number"},Ua={class:"stat-content"},Aa={class:"stat-number"},Da={class:"stat-content"},Xa={class:"stat-number"},Qa={class:"stat-content"},Ma={class:"stat-number"},Ba={class:"table-section"},qa={class:"table-header"},za={class:"total-count"},Na={class:"phone-text"},Oa={class:"description-text"},ja={class:"pagination-section"},Ha={key:0,class:"detail-content"},Ya={class:"user-agent-text"},Ja={class:"description-detail"},Ga={key:0,class:"additional-data"};function Za(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("refresh"),c=(0,l.g2)("el-button"),p=(0,l.g2)("el-option"),m=(0,l.g2)("el-select"),g=(0,l.g2)("el-form-item"),f=(0,l.g2)("search"),k=(0,l.g2)("el-input"),v=(0,l.g2)("el-date-picker"),h=(0,l.g2)("el-form"),b=(0,l.g2)("el-card"),y=(0,l.g2)("el-col"),w=(0,l.g2)("el-row"),_=(0,l.g2)("el-table-column"),F=(0,l.g2)("el-tag"),L=(0,l.g2)("el-tooltip"),x=(0,l.g2)("el-table"),C=(0,l.g2)("el-pagination"),I=(0,l.g2)("el-descriptions-item"),R=(0,l.g2)("el-descriptions"),$=(0,l.g2)("el-dialog"),W=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",$a,[(0,l.Lk)("div",Wa,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[9]||(t[9]=(0,l.eW)(" 返回 "))]),t[10]||(t[10]=(0,l.Lk)("h1",null,"操作日志管理",-1)),t[11]||(t[11]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Va,[(0,l.Lk)("div",Ta,[(0,l.bF)(b,null,{header:(0,l.k6)((()=>[(0,l.Lk)("div",Sa,[t[13]||(t[13]=(0,l.Lk)("span",null,[(0,l.eW)("筛选条件 "),(0,l.Lk)("small",{style:{color:"#909399"}})],-1)),(0,l.bF)(c,{type:"primary",link:"",onClick:o.resetFilters},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[12]||(t[12]=(0,l.eW)(" 重置筛选 "))])),_:1},8,["onClick"])])])),default:(0,l.k6)((()=>[(0,l.bF)(h,{model:o.filters,inline:""},{default:(0,l.k6)((()=>[(0,l.bF)(g,{label:"操作类型"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:o.filters.operationType,"onUpdate:modelValue":t[1]||(t[1]=e=>o.filters.operationType=e),placeholder:"选择操作类型",clearable:"",style:{width:"140px"}},{default:(0,l.k6)((()=>[(0,l.bF)(p,{label:"登录",value:"login"}),(0,l.bF)(p,{label:"创建",value:"create"}),(0,l.bF)(p,{label:"更新",value:"update"}),(0,l.bF)(p,{label:"删除",value:"delete"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(g,{label:"操作人员"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:o.filters.userKeyword,"onUpdate:modelValue":t[2]||(t[2]=e=>o.filters.userKeyword=e),placeholder:"输入用户名或手机号搜索",clearable:"",style:{width:"200px"}},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(g,{label:"时间范围"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:o.dateRange,"onUpdate:modelValue":t[3]||(t[3]=e=>o.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:o.handleDateChange,style:{width:"280px"}},null,8,["modelValue","onChange"])])),_:1}),(0,l.bF)(g,{label:"描述关键词"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:o.filters.description,"onUpdate:modelValue":t[4]||(t[4]=e=>o.filters.description=e),placeholder:"输入关键词搜索",style:{width:"200px"},clearable:""},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1})]),(0,l.Lk)("div",Ea,[(0,l.bF)(w,{gutter:16},{default:(0,l.k6)((()=>[(0,l.bF)(y,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(b,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Pa,[(0,l.Lk)("div",Ka,(0,i.v_)(o.totalStats.login||0),1),t[14]||(t[14]=(0,l.Lk)("div",{class:"stat-label"},"登录操作",-1))])])),_:1})])),_:1}),(0,l.bF)(y,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(b,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Ua,[(0,l.Lk)("div",Aa,(0,i.v_)(o.totalStats.create||0),1),t[15]||(t[15]=(0,l.Lk)("div",{class:"stat-label"},"创建操作",-1))])])),_:1})])),_:1}),(0,l.bF)(y,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(b,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Da,[(0,l.Lk)("div",Xa,(0,i.v_)(o.totalStats.update||0),1),t[16]||(t[16]=(0,l.Lk)("div",{class:"stat-label"},"更新操作",-1))])])),_:1})])),_:1}),(0,l.bF)(y,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(b,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Qa,[(0,l.Lk)("div",Ma,(0,i.v_)(o.totalStats.delete||0),1),t[17]||(t[17]=(0,l.Lk)("div",{class:"stat-label"},"删除操作",-1))])])),_:1})])),_:1})])),_:1})]),(0,l.Lk)("div",Ba,[(0,l.bF)(b,null,{header:(0,l.k6)((()=>[(0,l.Lk)("div",qa,[t[18]||(t[18]=(0,l.Lk)("span",null,"操作日志列表",-1)),(0,l.Lk)("span",za,"共 "+(0,i.v_)(o.pagination.total)+" 条记录",1)])])),default:(0,l.k6)((()=>[(0,l.bo)(((0,l.uX)(),(0,l.Wv)(x,{data:o.logs,style:{width:"100%"},size:"small"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{prop:"id",label:"ID",width:"60"}),(0,l.bF)(_,{prop:"created_at",label:"操作时间",width:"160"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(o.formatDateTime(e.row.created_at)),1)])),_:1}),(0,l.bF)(_,{prop:"operation_type",label:"操作类型",width:"80"},{default:(0,l.k6)((e=>[(0,l.bF)(F,{type:o.getOperationTypeColor(e.row.operation_type),size:"small"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.getOperationTypeName(e.row.operation_type)),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(_,{prop:"target_type",label:"目标类型",width:"100"},{default:(0,l.k6)((e=>[(0,l.bF)(F,{type:"info",size:"small"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.getTargetTypeName(e.row.target_type)),1)])),_:2},1024)])),_:1}),(0,l.bF)(_,{label:"操作人员",width:"120"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",null,[(0,l.Lk)("div",null,(0,i.v_)(e.row.username||"未知"),1),(0,l.Lk)("div",Na,(0,i.v_)(e.row.phone||"-"),1)])])),_:1}),(0,l.bF)(_,{prop:"role_name",label:"角色",width:"80"}),(0,l.bF)(_,{prop:"description",label:"操作描述","min-width":"300"},{default:(0,l.k6)((e=>[(0,l.bF)(L,{content:e.row.description,placement:"top"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Oa,(0,i.v_)(e.row.description),1)])),_:2},1032,["content"])])),_:1}),(0,l.bF)(_,{prop:"ip_address",label:"IP地址",width:"120"}),(0,l.bF)(_,{label:"操作",width:"80"},{default:(0,l.k6)((e=>[(0,l.bF)(c,{type:"primary",link:"",size:"small",onClick:t=>o.showDetail(e.row)},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)(" 详情 ")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[W,o.loading]]),(0,l.Lk)("div",ja,[(0,l.bF)(C,{"current-page":o.pagination.page,"onUpdate:currentPage":t[5]||(t[5]=e=>o.pagination.page=e),"page-size":o.pagination.pageSize,"onUpdate:pageSize":t[6]||(t[6]=e=>o.pagination.pageSize=e),"page-sizes":[10,20,50,100],total:o.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:o.handleSizeChange,onCurrentChange:o.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])])),_:1})])]),(0,l.bF)($,{modelValue:o.detailVisible,"onUpdate:modelValue":t[8]||(t[8]=e=>o.detailVisible=e),title:"操作日志详情",width:"60%","close-on-click-modal":!1},{footer:(0,l.k6)((()=>[(0,l.bF)(c,{onClick:t[7]||(t[7]=e=>o.detailVisible=!1)},{default:(0,l.k6)((()=>t[21]||(t[21]=[(0,l.eW)("关闭")]))),_:1})])),default:(0,l.k6)((()=>[o.selectedLog?((0,l.uX)(),(0,l.CE)("div",Ha,[(0,l.bF)(R,{column:2,border:""},{default:(0,l.k6)((()=>[(0,l.bF)(I,{label:"日志ID"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.id),1)])),_:1}),(0,l.bF)(I,{label:"操作时间"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.formatDateTime(o.selectedLog.created_at)),1)])),_:1}),(0,l.bF)(I,{label:"操作类型"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{type:o.getOperationTypeColor(o.selectedLog.operation_type)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.getOperationTypeName(o.selectedLog.operation_type)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(I,{label:"目标类型"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{type:"info"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.getTargetTypeName(o.selectedLog.target_type)),1)])),_:1})])),_:1}),(0,l.bF)(I,{label:"目标ID"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.target_id||"-"),1)])),_:1}),(0,l.bF)(I,{label:"操作人员"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.username||"未知"),1)])),_:1}),(0,l.bF)(I,{label:"手机号"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.phone||"-"),1)])),_:1}),(0,l.bF)(I,{label:"角色"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.role_name||"-"),1)])),_:1}),(0,l.bF)(I,{label:"IP地址"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.ip_address||"-"),1)])),_:1}),(0,l.bF)(I,{label:"用户代理",span:"2"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Ya,(0,i.v_)(o.selectedLog.user_agent||"-"),1)])),_:1}),(0,l.bF)(I,{label:"操作描述",span:"2"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Ja,(0,i.v_)(o.selectedLog.description),1)])),_:1})])),_:1}),o.selectedLog.additional_data?((0,l.uX)(),(0,l.CE)("div",Ga,[t[20]||(t[20]=(0,l.Lk)("h4",null,"附加数据",-1)),(0,l.bF)(k,{type:"textarea",rows:10,value:o.formatAdditionalData(o.selectedLog.additional_data),readonly:""},null,8,["value"])])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)])),_:1},8,["modelValue"]),t[22]||(t[22]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var eo={name:"OperationLogsView",components:{ArrowLeft:b.nkM,Search:b.vji,Refresh:b.C42},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)([]),o=(0,k.KR)({}),r=(0,k.KR)(!1),n=(0,k.KR)(null),i=(0,k.KR)([]),d=(0,k.Kh)({operationType:"",userKeyword:"",startDate:"",endDate:"",description:""}),u=(0,k.Kh)({page:1,pageSize:20,total:0}),c=(0,l.EW)((()=>xr.state.isLoggedIn&&xr.state.user&&1===xr.state.user.can_view_logs));let p=null;(0,l.wB)([()=>d.operationType,()=>d.userKeyword,()=>d.startDate,()=>d.endDate,()=>d.description],(()=>{p&&clearTimeout(p),p=setTimeout((()=>{u.page=1,m(),g()}),500)})),(0,l.sV)((async()=>{if(!c.value)return v.nk.error("您没有权限查看操作日志"),void e.push("/");await Promise.all([m(),g()])})),(0,l.hi)((()=>{p&&(clearTimeout(p),p=null)}));const m=async()=>{try{t.value=!0;const e={page:u.page,pageSize:u.pageSize};d.operationType&&""!==d.operationType.trim()&&(e.operationType=d.operationType),d.userKeyword&&""!==d.userKeyword.trim()&&(e.userKeyword=d.userKeyword),d.startDate&&""!==d.startDate.trim()&&(e.startDate=d.startDate),d.endDate&&""!==d.endDate.trim()&&(e.endDate=d.endDate),d.description&&""!==d.description.trim()&&(e.description=d.description);const o=await dr.get(_.endpoints.operationLogs,e);a.value=o.data.logs||[],u.total=o.data.pagination.total||0}catch(e){console.error("获取操作日志失败:",e),v.nk.error("获取操作日志失败")}finally{t.value=!1}},g=async()=>{try{const e={};d.startDate&&""!==d.startDate.trim()&&(e.startDate=d.startDate),d.endDate&&""!==d.endDate.trim()&&(e.endDate=d.endDate);const t=await dr.get(`${_.endpoints.operationLogs}/stats`,e),a=t.data.totalStats||[],l={};a.forEach((e=>{l[e.operation_type]=e.total_count})),o.value=l}catch(e){console.error("获取统计信息失败:",e),o.value={login:0,create:0,update:0,delete:0}}},f=()=>{Object.keys(d).forEach((e=>{d[e]=""})),i.value=[],u.page=1},h=e=>{e&&2===e.length?(d.startDate=e[0],d.endDate=e[1]):(d.startDate="",d.endDate="")},b=e=>{u.pageSize=e,u.page=1,m()},y=e=>{u.page=e,m()},w=e=>{n.value=e,r.value=!0},F=e=>e?new Date(e).toLocaleString("zh-CN"):"-",L=e=>{const t={login:"登录",create:"创建",update:"更新",delete:"删除"};return t[e]||e},x=e=>{const t={login:"",create:"success",update:"warning",delete:"danger"};return t[e]||""},C=e=>{const t={waste_record:"废物记录",user:"用户管理",unit:"单位管理",waste_type:"废物类型"};return t[e]||e||"-"},I=e=>{if(!e)return"";try{const t="string"===typeof e?JSON.parse(e):e;return JSON.stringify(t,null,2)}catch(t){return e.toString()}},R=()=>{e.go(-1)};return{loading:t,logs:a,totalStats:o,filters:d,pagination:u,dateRange:i,detailVisible:r,selectedLog:n,hasPermission:c,fetchLogs:m,resetFilters:f,handleDateChange:h,handleSizeChange:b,handleCurrentChange:y,showDetail:w,formatDateTime:F,getOperationTypeName:L,getOperationTypeColor:x,getTargetTypeName:C,formatAdditionalData:I,goBack:R}}};const to=(0,$.A)(eo,[["render",Za],["__scopeId","data-v-9351c582"]]);var ao=to;const oo={class:"company-management-container"},lo={class:"header"},ro={class:"content"},no={class:"toolbar"},so={class:"search-container"},io={class:"stats-info"},uo={class:"dialog-footer"},co={key:0,class:"stats-detail"},po={class:"stats-grid"},mo={class:"stat-item"},go={class:"stat-value"},fo={class:"stat-item"},ko={class:"stat-value"},vo={class:"stat-item"},ho={class:"stat-value"};function bo(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("search"),c=(0,l.g2)("el-input"),p=(0,l.g2)("plus"),m=(0,l.g2)("el-button"),g=(0,l.g2)("el-table-column"),f=(0,l.g2)("el-tag"),k=(0,l.g2)("el-popconfirm"),v=(0,l.g2)("el-tooltip"),h=(0,l.g2)("el-table"),b=(0,l.g2)("el-form-item"),y=(0,l.g2)("el-option"),w=(0,l.g2)("el-select"),_=(0,l.g2)("el-form"),F=(0,l.g2)("el-dialog"),L=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",oo,[(0,l.Lk)("div",lo,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 返回 "))]),t[9]||(t[9]=(0,l.Lk)("h1",null,"公司管理",-1)),t[10]||(t[10]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",ro,[(0,l.Lk)("div",no,[(0,l.Lk)("div",so,[(0,l.bF)(c,{modelValue:o.searchKeyword,"onUpdate:modelValue":t[1]||(t[1]=e=>o.searchKeyword=e),placeholder:"请输入公司名称搜索",clearable:"",onClear:o.clearSearch,class:"search-input"},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1})])),_:1},8,["modelValue","onClear"])]),(0,l.bF)(m,{type:"primary",onClick:o.openAddDialog},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 添加公司 "))])),_:1},8,["onClick"])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(h,{data:o.companies,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,l.k6)((()=>[(0,l.bF)(g,{type:"index",label:"序号",width:"70",align:"center"}),(0,l.bF)(g,{prop:"name",label:"公司名称","min-width":"200"}),(0,l.bF)(g,{prop:"code",label:"公司代码",width:"150"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.code||"未设置"),1)])),_:1}),(0,l.bF)(g,{label:"状态",width:"100",align:"center"},{default:(0,l.k6)((e=>[(0,l.bF)(f,{type:1===e.row.status?"success":"danger"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.status?"正常":"已停用"),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(g,{label:"统计信息",width:"200",align:"center"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",io,[(0,l.Lk)("div",null,"单位: "+(0,i.v_)(e.row.stats?.units||0),1),(0,l.Lk)("div",null,"用户: "+(0,i.v_)(e.row.stats?.users||0),1),(0,l.Lk)("div",null,"记录: "+(0,i.v_)(e.row.stats?.records||0),1)])])),_:1}),(0,l.bF)(g,{label:"操作",width:"300",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.bF)(m,{size:"small",onClick:t=>o.handleEdit(e.row)},{default:(0,l.k6)((()=>t[12]||(t[12]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,l.bF)(m,{size:"small",type:1===e.row.status?"warning":"success",onClick:t=>o.handleStatusChange(e.row)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.status?"停用":"恢复"),1)])),_:2},1032,["type","onClick"]),(0,l.bF)(m,{size:"small",type:"info",onClick:t=>o.viewStats(e.row)},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)(" 查看统计 ")]))),_:2},1032,["onClick"]),!e.row.stats||0===e.row.stats.units&&0===e.row.stats.users&&0===e.row.stats.records?((0,l.uX)(),(0,l.Wv)(k,{key:0,title:"确定要删除此公司吗？",onConfirm:t=>o.handleDelete(e.row)},{reference:(0,l.k6)((()=>[(0,l.bF)(m,{size:"small",type:"danger"},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])):((0,l.uX)(),(0,l.Wv)(v,{key:1,content:"该公司下还有用户、单位或记录，无法删除",placement:"top"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{size:"small",type:"danger",disabled:""},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)("删除")]))),_:1})])),_:1}))])),_:1})])),_:1},8,["data"])),[[L,o.loading]])]),(0,l.bF)(F,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[6]||(t[6]=e=>o.dialogVisible=e),title:o.isEdit?"编辑公司":"添加公司",width:"500px"},{footer:(0,l.k6)((()=>[(0,l.Lk)("span",uo,[(0,l.bF)(m,{onClick:t[5]||(t[5]=e=>o.dialogVisible=!1)},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(m,{type:"primary",onClick:o.submitForm,loading:o.formLoading},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(_,{ref:"companyForm",model:o.form,rules:o.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"公司名称",prop:"name"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.name,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.name=e),placeholder:"请输入公司名称"},null,8,["modelValue"])])),_:1}),(0,l.bF)(b,{label:"公司代码",prop:"code"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.code,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.code=e),placeholder:"请输入公司代码（可选）"},null,8,["modelValue"])])),_:1}),o.isEdit?((0,l.uX)(),(0,l.Wv)(b,{key:0,label:"状态",prop:"status"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:o.form.status,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.status=e),placeholder:"请选择状态",style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(y,{value:1,label:"正常"}),(0,l.bF)(y,{value:0,label:"停用"})])),_:1},8,["modelValue"])])),_:1})):(0,l.Q3)("",!0)])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),(0,l.bF)(F,{modelValue:o.statsDialogVisible,"onUpdate:modelValue":t[7]||(t[7]=e=>o.statsDialogVisible=e),title:"公司统计信息",width:"600px"},{default:(0,l.k6)((()=>[o.currentCompanyStats?((0,l.uX)(),(0,l.CE)("div",co,[(0,l.Lk)("h3",null,(0,i.v_)(o.currentCompanyStats.company.name),1),(0,l.Lk)("div",po,[(0,l.Lk)("div",mo,[t[18]||(t[18]=(0,l.Lk)("div",{class:"stat-label"},"单位数量",-1)),(0,l.Lk)("div",go,(0,i.v_)(o.currentCompanyStats.stats.units),1)]),(0,l.Lk)("div",fo,[t[19]||(t[19]=(0,l.Lk)("div",{class:"stat-label"},"用户数量",-1)),(0,l.Lk)("div",ko,(0,i.v_)(o.currentCompanyStats.stats.users),1)]),(0,l.Lk)("div",vo,[t[20]||(t[20]=(0,l.Lk)("div",{class:"stat-label"},"废物记录",-1)),(0,l.Lk)("div",ho,(0,i.v_)(o.currentCompanyStats.stats.records),1)])])])):(0,l.Q3)("",!0)])),_:1},8,["modelValue"]),t[21]||(t[21]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var yo={name:"CompanyManagement",components:{ArrowLeft:b.nkM,Plus:b.FWt,Search:b.vji},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)(!1),o=(0,k.KR)(!1),r=(0,k.KR)(!1),n=(0,k.KR)(!1),i=(0,k.KR)(null),d=(0,k.KR)([]),u=(0,k.KR)(""),c=(0,k.KR)([]),p=(0,k.KR)(null);if(!xr.isSystemAdmin())return v.nk.error("权限不足，只有系统超级管理员可以访问此页面"),e.push("/"),{};const m=(0,k.Kh)({id:null,name:"",code:"",status:1}),g={name:[{required:!0,message:"请输入公司名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],code:[{max:20,message:"长度不能超过 20 个字符",trigger:"blur"}]},f=(0,l.EW)((()=>{if(!u.value.trim())return c.value;const e=u.value.toLowerCase();return c.value.filter((t=>t.name.toLowerCase().includes(e)||t.code&&t.code.toLowerCase().includes(e)))})),h=async()=>{t.value=!0;try{const e=await dr.get(_.endpoints.companies),t=await Promise.all(e.data.map((async e=>{try{const t=await dr.get(_.endpoints.companyStats.replace(":id",e.id));return{...e,stats:t.data.stats}}catch(t){return console.error(`获取公司 ${e.name} 统计信息失败:`,t),{...e,stats:{units:0,users:0,records:0}}}})));c.value=t}catch(e){console.error("Error fetching companies:",e),v.nk.error("获取公司列表失败")}finally{t.value=!1}};(0,l.wB)(f,(e=>{d.value=e}),{immediate:!0});const b=()=>{n.value=!1,x(),o.value=!0},y=e=>{n.value=!0,m.id=e.id,m.name=e.name,m.code=e.code||"",m.status=e.status,o.value=!0},w=async e=>{try{await dr.delete(`${_.endpoints.companies}/${e.id}`),v.nk.success("公司删除成功"),h()}catch(t){console.error("Error deleting company:",t);let e="删除公司失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),v.nk.error(e)}},F=async e=>{const t=1===e.status?0:1,a=1===t?"恢复":"停用";try{await dr.put(`${_.endpoints.companies}/${e.id}`,{name:e.name,code:e.code,status:t}),v.nk.success(`公司${a}成功`),h()}catch(o){console.error("状态变更失败:",o);let e=`${a}公司失败`;o.response&&o.response.data&&o.response.data.error&&(e=o.response.data.error),v.nk.error(e)}},L=async e=>{try{const t=await dr.get(_.endpoints.companyStats.replace(":id",e.id));p.value=t.data,r.value=!0}catch(t){console.error("获取公司统计失败:",t),v.nk.error("获取公司统计信息失败")}},x=()=>{i.value&&i.value.resetFields(),m.id=null,m.name="",m.code="",m.status=1},C=()=>{i.value.validate((async e=>{if(e){a.value=!0;try{const e={name:m.name,code:m.code||null,status:m.status};n.value?(await dr.put(`${_.endpoints.companies}/${m.id}`,e),v.nk.success("公司更新成功")):(await dr.post(_.endpoints.companies,e),v.nk.success("公司添加成功")),o.value=!1,h()}catch(t){console.error("Error submitting company form:",t);let e=n.value?"更新公司失败":"添加公司失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),v.nk.error(e)}finally{a.value=!1}}else v.nk.warning("请完成必填项")}))},I=()=>{e.back()},R=()=>{u.value=""};return(0,l.sV)((()=>{h()})),{loading:t,formLoading:a,dialogVisible:o,statsDialogVisible:r,isEdit:n,companyForm:i,companies:d,form:m,rules:g,currentCompanyStats:p,openAddDialog:b,handleEdit:y,handleDelete:w,handleStatusChange:F,viewStats:L,submitForm:C,goBack:I,searchKeyword:u,clearSearch:R}}};const wo=(0,$.A)(yo,[["render",bo],["__scopeId","data-v-27e228e0"]]);var _o=wo;const Fo={class:"super-admin-records-container"},Lo={class:"header"},xo={class:"header-actions"},Co={class:"content"},Io={class:"card-header"},Ro={class:"filter-form-container"},$o={class:"filter-actions"},Wo={class:"card-header"},Vo={class:"card-actions"},To={class:"responsive-table"},So={key:0,class:"location-info-cell"},Eo={key:0,class:"photo-preview"},Po=["onClick"],Ko={key:0,class:"photo-count"},Uo={key:1},Ao={key:0,class:"photo-preview"},Do=["onClick"],Xo={key:0,class:"photo-count"},Qo={key:1},Mo={class:"operation-buttons"},Bo={key:0,class:"loading-row"},qo={key:1,class:"load-more-row"},zo={key:2,class:"no-more-row"},No={key:0,class:"empty-state"};function Oo(e,t,a,r,n,s){const d=(0,l.g2)("el-button"),u=(0,l.g2)("arrow-up"),c=(0,l.g2)("el-icon"),p=(0,l.g2)("arrow-down"),m=(0,l.g2)("el-option"),g=(0,l.g2)("el-select"),f=(0,l.g2)("el-form-item"),k=(0,l.g2)("el-col"),v=(0,l.g2)("el-date-picker"),h=(0,l.g2)("el-row"),b=(0,l.g2)("el-input-number"),y=(0,l.g2)("el-input"),w=(0,l.g2)("el-form"),_=(0,l.g2)("el-collapse-transition"),F=(0,l.g2)("el-card"),L=(0,l.g2)("refresh"),x=(0,l.g2)("download"),C=(0,l.g2)("el-dropdown-item"),I=(0,l.g2)("el-dropdown-menu"),R=(0,l.g2)("el-dropdown"),$=(0,l.g2)("user"),W=(0,l.g2)("document"),V=(0,l.g2)("chat-line-round"),T=(0,l.g2)("el-table-column"),S=(0,l.g2)("el-image"),E=(0,l.g2)("loading"),P=(0,l.g2)("el-table"),K=(0,l.g2)("el-empty"),U=(0,l.g2)("el-image-viewer"),A=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Fo,[(0,l.Lk)("div",Lo,[t[10]||(t[10]=(0,l.Lk)("div",null,null,-1)),t[11]||(t[11]=(0,l.Lk)("h1",null,"系统管理 - 固体废物记录",-1)),(0,l.Lk)("div",xo,[(0,l.bF)(d,{type:"success",onClick:r.goToCompanyManagement},{default:(0,l.k6)((()=>t[9]||(t[9]=[(0,l.eW)(" 公司管理 ")]))),_:1},8,["onClick"])])]),(0,l.Lk)("div",Co,[(0,l.bF)(F,{class:"filter-card",shadow:"hover"},{header:(0,l.k6)((()=>[(0,l.Lk)("div",Io,[t[12]||(t[12]=(0,l.Lk)("span",null,"筛选条件",-1)),(0,l.bF)(d,{link:"",type:"primary",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(c,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1})):((0,l.uX)(),(0,l.Wv)(c,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1})),(0,l.eW)(" "+(0,i.v_)(r.showFilterPanel?"收起":"展开"),1)])),_:1})])])),default:(0,l.k6)((()=>[(0,l.bF)(_,null,{default:(0,l.k6)((()=>[(0,l.bo)((0,l.Lk)("div",Ro,[(0,l.bF)(w,{model:r.filterForm,class:"filter-form","label-width":"80px"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(k,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"公司"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:r.filterForm.companyId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.companyId=e),placeholder:"请选择公司",clearable:""},{default:(0,l.k6)((()=>[(0,l.bF)(m,{label:"全部公司",value:null}),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.companies,(e=>((0,l.uX)(),(0,l.Wv)(m,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(k,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"单位"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.unitId=e),placeholder:"请选择单位",clearable:""},{default:(0,l.k6)((()=>[(0,l.bF)(m,{label:"全部单位",value:null}),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.filteredUnits,(e=>((0,l.uX)(),(0,l.Wv)(m,{key:e.id,label:`${e.name} (${e.company_name})`,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(k,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"请选择废物类型",clearable:""},{default:(0,l.k6)((()=>[(0,l.bF)(m,{label:"全部类型",value:null}),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(m,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(k,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"时间范围"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(h,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(k,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"最小数量"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.minQuantity=e),min:0,precision:3,placeholder:"最小数量",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(k,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"最大数量"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.maxQuantity=e),min:0,precision:3,placeholder:"最大数量",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(k,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.location=e),placeholder:"请输入产生地点",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(k,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"产生工序"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:r.filterForm.process,"onUpdate:modelValue":t[8]||(t[8]=e=>r.filterForm.process=e),placeholder:"请输入产生工序",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(h,null,{default:(0,l.k6)((()=>[(0,l.bF)(k,{span:24,class:"filter-buttons-col"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",$o,[(0,l.bF)(d,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("重置")]))),_:1},8,["onClick"]),(0,l.bF)(d,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("查询")]))),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])],512),[[o.aG,r.showFilterPanel]])])),_:1})])),_:1}),(0,l.bF)(F,{class:"records-card",shadow:"hover"},{header:(0,l.k6)((()=>[(0,l.Lk)("div",Wo,[(0,l.Lk)("span",null,"固体废物记录列表 (共"+(0,i.v_)(r.records.length)+"条)",1),(0,l.Lk)("div",Vo,[(0,l.bF)(d,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(c,null,{default:(0,l.k6)((()=>[(0,l.bF)(L)])),_:1}),t[15]||(t[15]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"]),(0,l.bF)(R,{onCommand:r.exportData},{dropdown:(0,l.k6)((()=>[(0,l.bF)(I,null,{default:(0,l.k6)((()=>[(0,l.bF)(C,{command:"withImages"},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("导出(含首张图片)")]))),_:1}),(0,l.bF)(C,{command:"withAllImages"},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)("导出(含全部图片)")]))),_:1}),(0,l.bF)(C,{command:"withoutImages"},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)("导出(不含图片)")]))),_:1})])),_:1})])),default:(0,l.k6)((()=>[(0,l.bF)(d,{type:"success"},{default:(0,l.k6)((()=>[(0,l.bF)(c,null,{default:(0,l.k6)((()=>[(0,l.bF)(x)])),_:1}),t[16]||(t[16]=(0,l.eW)(" 导出数据 ")),(0,l.bF)(c,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1})])),_:1})])),_:1},8,["onCommand"]),(0,l.bF)(d,{onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(c,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[20]||(t[20]=(0,l.Lk)("span",null,"用户管理",-1))])),_:1},8,["onClick"]),r.canViewLogs?((0,l.uX)(),(0,l.Wv)(d,{key:0,onClick:r.goToOperationLogs},{default:(0,l.k6)((()=>[(0,l.bF)(c,null,{default:(0,l.k6)((()=>[(0,l.bF)(W)])),_:1}),t[21]||(t[21]=(0,l.Lk)("span",null,"操作日志",-1))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(d,{onClick:r.goToFeedbackManagement},{default:(0,l.k6)((()=>[(0,l.bF)(c,null,{default:(0,l.k6)((()=>[(0,l.bF)(V)])),_:1}),t[22]||(t[22]=(0,l.Lk)("span",null,"问题反馈",-1))])),_:1},8,["onClick"])])])])),default:(0,l.k6)((()=>[(0,l.Lk)("div",To,[(0,l.bo)(((0,l.uX)(),(0,l.Wv)(P,{data:r.filteredRecords,border:"",stripe:"",style:{width:"100%"},height:r.tableHeight,ref:"tableRef"},{append:(0,l.k6)((()=>[r.loadingMore?((0,l.uX)(),(0,l.CE)("div",Bo,[(0,l.bF)(c,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(E)])),_:1}),t[25]||(t[25]=(0,l.eW)(" 正在加载... "))])):r.hasMore&&r.records.length>0?((0,l.uX)(),(0,l.CE)("div",qo,[(0,l.bF)(d,{type:"primary",onClick:r.loadMore,disabled:r.loadingMore,size:"small"},{default:(0,l.k6)((()=>[t[26]||(t[26]=(0,l.eW)(" 点击加载更多 ")),(0,l.bF)(c,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1})])),_:1},8,["onClick","disabled"])])):r.records.length>0?((0,l.uX)(),(0,l.CE)("div",zo," 已全部加载 ")):(0,l.Q3)("",!0)])),default:(0,l.k6)((()=>[(0,l.bF)(T,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,l.bF)(T,{prop:"company_name",label:"公司","min-width":"100"}),(0,l.bF)(T,{prop:"unit_name",label:"单位","min-width":"100"}),(0,l.bF)(T,{prop:"waste_type_name",label:"废物类型","min-width":"100"}),(0,l.bF)(T,{prop:"location",label:"产生地点","min-width":"100"}),(0,l.bF)(T,{prop:"process",label:"产生工序","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.process||"无"),1)])),_:1}),(0,l.bF)(T,{prop:"remarks",label:"备注","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,l.bF)(T,{label:"地理位置","min-width":"200",class:"mobile-hidden"},{default:(0,l.k6)((e=>[r.hasLocationInfo(e.row)?((0,l.uX)(),(0,l.CE)("div",So,[(0,l.Lk)("span",null,(0,i.v_)(r.formatLocationDisplay(e.row)),1)])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(T,{prop:"collection_start_time",label:"收集开始时间","min-width":"160"}),(0,l.bF)(T,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(null!==e.row.quantity&&void 0!==e.row.quantity?parseFloat(e.row.quantity).toFixed(3):""),1)])),_:1}),(0,l.bF)(T,{prop:"creator_name",label:"填报人","min-width":"100"}),(0,l.bF)(T,{prop:"created_at",label:"记录时间","min-width":"160"}),(0,l.bF)(T,{label:"清理前照片","min-width":"140",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",Eo,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,l.bF)(S,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,Po)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",Ko,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",Uo,"无"))])),_:1}),(0,l.bF)(T,{label:"清理后照片","min-width":"140",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",Ao,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,l.bF)(S,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,Do)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",Xo,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",Qo,"无"))])),_:1}),(0,l.bF)(T,{label:"操作","min-width":"130"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",Mo,[(0,l.bF)(d,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[23]||(t[23]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,l.bF)(d,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[24]||(t[24]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","height"])),[[A,r.loading]])]),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",No,[(0,l.bF)(K,{description:"暂无废物记录"})]))])),_:1})]),r.showViewer?((0,l.uX)(),(0,l.Wv)(U,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}const jo=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}};var Ho={name:"SuperAdminRecordsView",components:{Refresh:b.C42,User:b.KJW,ArrowDown:b.yd$,ArrowUp:b.DoI,Download:b.f5X,ElImageViewer:De.Tg,Document:b.yoT,ChatLineRound:b.Fv_,Loading:b.Rhj},setup(){const e=(0,s.rd)();if(!xr.isSystemAdmin())return v.nk.error("权限不足，只有系统超级管理员可以访问此页面"),e.push("/"),{};const t=(0,k.KR)([]),a=(0,k.KR)(!1),o=(0,k.KR)([]),r=(0,k.KR)([]),n=(0,k.KR)([]),i=(0,k.KR)(!0),d=_.baseURL,u=(0,k.KR)(750),c=(0,k.KR)(null),p=(0,k.KR)(1),m=(0,k.KR)(20),g=(0,k.KR)(!0),f=(0,k.KR)(!1),b=(0,k.KR)(!1),y=(0,k.KR)([]),w=(0,k.KR)(0),F=(0,k.Kh)({companyId:null,unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:"",process:""}),L=(0,l.EW)((()=>F.companyId?o.value.filter((e=>e.company_id===F.companyId)):o.value));(0,l.wB)((()=>F.companyId),(()=>{F.unitId=null}));const x=(0,l.EW)((()=>t.value.filter((e=>{if(F.companyId&&e.company_id!==F.companyId)return!1;if(F.unitId&&e.unit_id!==F.unitId)return!1;if(F.wasteTypeId&&e.waste_type_id!==F.wasteTypeId)return!1;if(null!==F.minQuantity&&""!==F.minQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)<F.minQuantity)return!1;if(null!==F.maxQuantity&&""!==F.maxQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)>F.maxQuantity)return!1;if(F.location&&!e.location?.includes(F.location))return!1;if(F.process&&!e.process?.includes(F.process))return!1;if(F.dateRange&&2===F.dateRange.length){const t=new Date(F.dateRange[0]),a=new Date(F.dateRange[1]);a.setHours(23,59,59,999);const o=new Date(e.collection_start_time||e.created_at);if(o<t||o>a)return!1}return!0})))),C=(0,l.EW)((()=>xr.state.isLoggedIn&&xr.state.user&&1===xr.state.user.can_view_logs)),I=async(e=!0)=>{e?(a.value=!0,p.value=1,t.value=[]):f.value=!0;try{const a={page:p.value,pageSize:m.value},o=await dr.get(_.endpoints.wasteRecords,{params:a});t.value=e?o.data.records||o.data:[...t.value,...o.data.records||o.data];const l=o.data.records?o.data.records.length:o.data.length;g.value=l===m.value}catch(o){console.error("Error fetching records:",o),v.nk.error("获取记录列表失败")}finally{a.value=!1,f.value=!1}},R=async()=>{!f.value&&g.value&&(p.value+=1,await I(!1))},$=async()=>{try{const e=await dr.get(_.endpoints.units);o.value=e.data}catch(e){console.error("Error fetching units:",e),v.nk.error("获取单位列表失败")}},W=async()=>{try{const e=await dr.get(_.endpoints.companies);r.value=e.data}catch(e){console.error("Error fetching companies:",e),v.nk.error("获取公司列表失败")}},V=async()=>{try{const e=await dr.get(_.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),v.nk.error("获取废物类型失败")}},T=()=>{I(!0)},S=()=>{Object.keys(F).forEach((e=>{Array.isArray(F[e])?F[e]=[]:(F[e],F[e]=null)})),I(!0)},E=e=>{if(!e)return"";try{const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch(t){return e}},P=e=>{"withImages"===e?K():"withAllImages"===e?U():"withoutImages"===e&&A()},K=async()=>{try{const e=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t=x.value;if(0===t.length)return e.close(),void v.nk.warning("没有可导出的数据");const o="系统管理_固体废物记录",l=50,r=t.length,n=Math.ceil(r/l);n>1?(e.setText(`数据较多(${r}条)，将拆分为${n}个文件导出...`),v.nk.info(`数据较多(${r}条)，将拆分为${n}个文件导出`)):e.setText(`准备导出 ${r} 条记录...`);let s=0;for(let a=0;a<n;a++){const i=a*l,d=Math.min((a+1)*l,r),u=t.slice(i,d),c=n>1?`${o}_第${a+1}部分(共${n}部分)`:o;e.setText(`正在处理第${a+1}/${n}批次，${i+1}-${d}条记录...`);const p=u.map((e=>{const t=jo(e.photo_path_before),a=jo(e.photo_path_after);return{"公司":e.company_name,"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"产生工序":e.process||"无","备注":e.remarks||"无","收集开始时间":E(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":E(e.created_at),"清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),m=[{text:"公司",field:"公司"},{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],g=window.location.origin,f=(t,o)=>{const l=Math.round(t/o*100);e.setText(`正在导出第${a+1}/${n}部分：${l}% (${t}/${o})`)},k=await Ne(p,c,m,g,f);k&&s++}e.close(),s===n?n>1?v.nk.success(`成功导出${n}个文件`):v.nk.success("导出成功"):s>0?v.nk.warning(`部分导出成功，完成了${s}/${n}个文件`):v.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),v.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,Xe.Ks.service().close()}},U=async()=>{try{(0,v.nk)({message:"导出大量包含全部图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={exportType:"all_images",companyId:F.companyId?F.companyId:void 0};console.log("导出记录的筛选条件:",t);const{data:o}=await dr.get(`${_.endpoints.exportWasteRecords}/${xr.state.user.id}`,t);if(console.log(`从后端获取到 ${o.length} 条记录用于导出`),0===o.length)return e.close(),v.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const l=F.companyId?r.value.find((e=>e.id===F.companyId))?.name||"未知公司":"全部公司",n=`系统管理_固体废物记录_全部照片_${l}`,s=50,i=o.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),v.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录的全部照片...`);let u=0;for(let a=0;a<d;a++){const t=a*s,l=Math.min((a+1)*s,i),r=o.slice(t,l),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${l}条记录...`);const p=r.map((e=>{const t=jo(e.photo_path_before),a=jo(e.photo_path_after),o={"公司":e.company_name,"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":E(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":E(e.created_at)};for(let l=0;l<5;l++)o[`清理前照片${l+1}`]=l<t.length?t[l]:"";for(let l=0;l<5;l++)o[`清理后照片${l+1}`]=l<a.length?a[l]:"";return o})),m=[{text:"公司",field:"公司"},{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"}];for(let e=0;e<5;e++)m.push({text:`清理前照片${e+1}`,field:`清理前照片${e+1}`,isImage:!0});for(let e=0;e<5;e++)m.push({text:`清理后照片${e+1}`,field:`清理后照片${e+1}`,isImage:!0});const g=window.location.origin,f=(t,o)=>{const l=Math.round(t/o*100);e.setText(`正在导出第${a+1}/${d}部分：${l}% (${t}/${o})`)},k=await Ne(p,c,m,g,f);k&&u++}e.close(),u===d?d>1?v.nk.success(`成功导出${d}个文件`):v.nk.success("导出成功"):u>0?v.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):v.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),v.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,Xe.Ks.service().close()}},A=async()=>{try{const e=Xe.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t=x.value;if(0===t.length)return e.close(),void v.nk.warning("没有可导出的数据");const o="系统管理_固体废物记录",l=1e3,r=t.length,n=Math.ceil(r/l);n>1?(e.setText(`数据较多(${r}条)，将拆分为${n}个文件导出...`),v.nk.info(`数据较多(${r}条)，将拆分为${n}个文件导出`)):e.setText(`准备导出 ${r} 条记录...`);let s=0;for(let a=0;a<n;a++){const i=a*l,d=Math.min((a+1)*l,r),u=t.slice(i,d),c=n>1?`${o}_第${a+1}部分(共${n}部分)`:o;e.setText(`正在处理第${a+1}/${n}批次，${i+1}-${d}条记录...`);const p=u.map((e=>({"公司":e.company_name,"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":E(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":E(e.created_at),"清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),m=[{text:"公司",field:"公司"},{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],g=await Oe(p,c,m);g&&s++}e.close(),s===n?n>1?v.nk.success(`成功导出${n}个文件`):v.nk.success("导出成功"):s>0?v.nk.warning(`部分导出成功，完成了${s}/${n}个文件`):v.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),v.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,Xe.Ks.service().close()}},D=()=>{I(!0)},X=()=>{e.push({name:"UserManagement"})},Q=()=>{e.push({name:"OperationLogs"})},M=()=>{e.push({name:"CompanyManagement"})},B=()=>{e.push({name:"FeedbackManagement"})},q=t=>{e.push({name:"EditRecord",params:{id:t}})},z=e=>{h.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{N(e.id)})).catch((()=>{v.nk.info("已取消删除")}))},N=async e=>{try{await dr.delete(`${_.endpoints.wasteRecords}/${e}`),v.nk.success("删除成功"),I(!0)}catch(t){console.error("Error deleting record:",t),v.nk.error("删除失败")}},O=(e,t)=>{y.value=e.map((e=>`${d}${e}`)),w.value=t,b.value=!0},j=()=>{b.value=!1},H=e=>e+1,Y=e=>e.address||e.district||e.city||e.province,J=e=>{const t=[];return e.address&&t.push(e.address),e.district&&t.push(e.district),e.city&&t.push(e.city),t.join("，")};return(0,l.sV)((()=>{I(!0),$(),W(),V()})),{records:t,filteredRecords:x,loading:a,units:o,companies:r,filteredUnits:L,wasteTypes:n,showFilterPanel:i,filterForm:F,applyFilter:T,resetFilter:S,exportData:P,exportWithImages:K,exportWithAllImages:U,exportWithoutImages:A,parsePhotoPath:jo,refreshRecords:D,goToUserManagement:X,goToOperationLogs:Q,goToCompanyManagement:M,goToFeedbackManagement:B,editRecord:q,confirmDelete:z,showViewer:b,previewImages:y,previewIndex:w,previewPhoto:O,closeViewer:j,baseUrl:d,indexMethod:H,tableHeight:u,tableRef:c,canViewLogs:C,page:p,pageSize:m,hasMore:g,loadingMore:f,loadMore:R,hasLocationInfo:Y,formatLocationDisplay:J}}};const Yo=(0,$.A)(Ho,[["render",Oo],["__scopeId","data-v-efd7f9a4"]]);var Jo=Yo;const Go={class:"feedback-container"},Zo={class:"header"},el={class:"content"};function tl(e,t,a,r,n,s){const i=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("el-option"),c=(0,l.g2)("el-select"),p=(0,l.g2)("el-form-item"),m=(0,l.g2)("el-input"),g=(0,l.g2)("el-button"),f=(0,l.g2)("el-form"),k=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",Go,[(0,l.Lk)("div",Zo,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(i)])),_:1}),t[5]||(t[5]=(0,l.eW)(" 返回 "))]),t[6]||(t[6]=(0,l.Lk)("h1",null,"问题反馈",-1)),t[7]||(t[7]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",el,[(0,l.bF)(k,{class:"feedback-card",shadow:"hover"},{header:(0,l.k6)((()=>t[8]||(t[8]=[(0,l.Lk)("div",{class:"card-header"},[(0,l.Lk)("span",null,"提交系统问题反馈")],-1)]))),default:(0,l.k6)((()=>[(0,l.bF)(f,{ref:"formRef",model:r.form,rules:r.rules,"label-width":"100px",onSubmit:(0,o.D$)(r.submitForm,["prevent"])},{default:(0,l.k6)((()=>[(0,l.bF)(p,{label:"问题类型",prop:"type"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:r.form.type,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.type=e),placeholder:"请选择问题类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"系统Bug",value:"bug"}),(0,l.bF)(u,{label:"功能建议",value:"feature"}),(0,l.bF)(u,{label:"体验改进",value:"improvement"}),(0,l.bF)(u,{label:"其他问题",value:"other"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"优先级",prop:"priority"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:r.form.priority,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.priority=e),placeholder:"请选择优先级",style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"低",value:"low"}),(0,l.bF)(u,{label:"中",value:"medium"}),(0,l.bF)(u,{label:"高",value:"high"}),(0,l.bF)(u,{label:"紧急",value:"urgent"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"问题标题",prop:"title"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:r.form.title,"onUpdate:modelValue":t[3]||(t[3]=e=>r.form.title=e),placeholder:"请简要描述问题"},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"问题描述",prop:"description"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:r.form.description,"onUpdate:modelValue":t[4]||(t[4]=e=>r.form.description=e),type:"textarea",rows:6,placeholder:"请详细描述遇到的问题，包括出现的情况、预期的结果等"},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,null,{default:(0,l.k6)((()=>[(0,l.bF)(g,{type:"primary",onClick:r.submitForm,loading:r.loading},{default:(0,l.k6)((()=>t[9]||(t[9]=[(0,l.eW)(" 提交反馈 ")]))),_:1},8,["onClick","loading"]),(0,l.bF)(g,{onClick:r.resetForm},{default:(0,l.k6)((()=>t[10]||(t[10]=[(0,l.eW)("重置")]))),_:1},8,["onClick"]),(0,l.bF)(g,{onClick:r.goBack},{default:(0,l.k6)((()=>t[11]||(t[11]=[(0,l.eW)("取消")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules","onSubmit"])])),_:1})])])}var al={name:"FeedbackForm",components:{ArrowLeft:b.nkM},setup(){const e=(0,s.rd)(),t=(0,k.KR)(null),a=(0,k.KR)(!1),o=(0,k.Kh)({type:"bug",priority:"medium",title:"",description:""}),l={type:[{required:!0,message:"请选择问题类型",trigger:"change"}],priority:[{required:!0,message:"请选择优先级",trigger:"change"}],title:[{required:!0,message:"请输入问题标题",trigger:"blur"}],description:[{required:!0,message:"请输入问题描述",trigger:"blur"}]},r=async()=>{try{const l=await t.value.validate();if(!l)return;a.value=!0;const r={type:o.type,priority:o.priority,title:o.title,description:o.description},n=await dr.post(_.endpoints.feedback,r);n.data.success?(v.nk.success("问题反馈提交成功！"),e.push({name:"FeedbackList"})):v.nk.error(n.data.message||"提交失败")}catch(l){console.error("提交问题反馈失败:",l),v.nk.error("提交失败，请重试")}finally{a.value=!1}},n=()=>{t.value.resetFields()},i=()=>{o.title||o.description?h.s.confirm("您有未保存的内容，确定要离开吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{e.back()})):e.back()};return{formRef:t,loading:a,form:o,rules:l,submitForm:r,resetForm:n,goBack:i}}};const ol=(0,$.A)(al,[["render",tl],["__scopeId","data-v-b9058c26"]]);var ll=ol;const rl={class:"feedback-list-container"},nl={class:"header"},sl={class:"header-actions"},il={class:"content"},dl={class:"card-header"},ul={key:0,style:{"text-align":"center",padding:"50px"}},cl={key:1,style:{"text-align":"center",padding:"50px"}},pl={key:2,class:"feedback-list"},ml=["onClick"],gl={class:"feedback-header"},fl={class:"feedback-title"},kl={class:"feedback-meta"},vl={class:"feedback-description"},hl={class:"feedback-footer"},bl={class:"feedback-time"},yl={class:"feedback-actions"},wl={key:0,class:"feedback-detail"},_l={class:"description-section"},Fl={class:"description-content"},Ll={key:0,class:"reply-section"},xl={class:"reply-content"},Cl={class:"reply-meta"};function Il(e,t,a,r,n,s){const d=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),c=(0,l.g2)("plus"),p=(0,l.g2)("el-button"),m=(0,l.g2)("refresh"),g=(0,l.g2)("loading"),f=(0,l.g2)("el-empty"),k=(0,l.g2)("el-tag"),v=(0,l.g2)("el-card"),h=(0,l.g2)("el-descriptions-item"),b=(0,l.g2)("el-descriptions"),y=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",rl,[(0,l.Lk)("div",nl,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1}),t[2]||(t[2]=(0,l.eW)(" 返回 "))]),t[4]||(t[4]=(0,l.Lk)("h1",null,"我的反馈",-1)),(0,l.Lk)("div",sl,[(0,l.bF)(p,{type:"primary",onClick:r.goToNewFeedback},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(c)])),_:1}),t[3]||(t[3]=(0,l.eW)(" 新建反馈 "))])),_:1},8,["onClick"])])]),(0,l.Lk)("div",il,[(0,l.bF)(v,{class:"feedback-card",shadow:"hover"},{header:(0,l.k6)((()=>[(0,l.Lk)("div",dl,[(0,l.Lk)("span",null,"问题反馈记录 (共"+(0,i.v_)(r.feedbacks.length)+"条)",1),(0,l.bF)(p,{onClick:r.fetchFeedbacks},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(m)])),_:1}),t[5]||(t[5]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])])])),default:(0,l.k6)((()=>[r.loading?((0,l.uX)(),(0,l.CE)("div",ul,[(0,l.bF)(u,{class:"is-loading"},{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}),t[6]||(t[6]=(0,l.Lk)("p",null,"加载中...",-1))])):0===r.feedbacks.length?((0,l.uX)(),(0,l.CE)("div",cl,[(0,l.bF)(f,{description:"暂无反馈记录"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{type:"primary",onClick:r.goToNewFeedback},{default:(0,l.k6)((()=>t[7]||(t[7]=[(0,l.eW)("提交反馈")]))),_:1},8,["onClick"])])),_:1})])):((0,l.uX)(),(0,l.CE)("div",pl,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.feedbacks,(e=>((0,l.uX)(),(0,l.CE)("div",{key:e.id,class:"feedback-item",onClick:t=>r.viewFeedback(e)},[(0,l.Lk)("div",gl,[(0,l.Lk)("div",fl,(0,i.v_)(e.title),1),(0,l.Lk)("div",kl,[(0,l.bF)(k,{type:r.getTypeColor(e.type)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getTypeText(e.type)),1)])),_:2},1032,["type"]),(0,l.bF)(k,{type:r.getPriorityColor(e.priority)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getPriorityText(e.priority)),1)])),_:2},1032,["type"]),(0,l.bF)(k,{type:r.getStatusColor(e.status)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getStatusText(e.status)),1)])),_:2},1032,["type"])])]),(0,l.Lk)("div",vl,(0,i.v_)(e.description.length>100?e.description.substring(0,100)+"...":e.description),1),(0,l.Lk)("div",hl,[(0,l.Lk)("span",bl,(0,i.v_)(r.formatDateTime(e.created_at)),1),(0,l.Lk)("div",yl,[(0,l.bF)(p,{size:"small",onClick:(0,o.D$)((t=>r.viewFeedback(e)),["stop"])},{default:(0,l.k6)((()=>t[8]||(t[8]=[(0,l.eW)("查看详情")]))),_:2},1032,["onClick"]),"pending"===e.status?((0,l.uX)(),(0,l.Wv)(p,{key:0,size:"small",type:"danger",onClick:(0,o.D$)((t=>r.deleteFeedback(e)),["stop"])},{default:(0,l.k6)((()=>t[9]||(t[9]=[(0,l.eW)("删除")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0)])])],8,ml)))),128))]))])),_:1})]),(0,l.bF)(y,{modelValue:r.showDetail,"onUpdate:modelValue":t[1]||(t[1]=e=>r.showDetail=e),title:"反馈详情",width:"70%","close-on-click-modal":!1},{default:(0,l.k6)((()=>[r.selectedFeedback?((0,l.uX)(),(0,l.CE)("div",wl,[(0,l.bF)(b,{column:2,border:""},{default:(0,l.k6)((()=>[(0,l.bF)(h,{label:"问题标题"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.selectedFeedback.title),1)])),_:1}),(0,l.bF)(h,{label:"问题类型"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{type:r.getTypeColor(r.selectedFeedback.type)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getTypeText(r.selectedFeedback.type)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(h,{label:"优先级"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{type:r.getPriorityColor(r.selectedFeedback.priority)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getPriorityText(r.selectedFeedback.priority)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(h,{label:"状态"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{type:r.getStatusColor(r.selectedFeedback.status)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getStatusText(r.selectedFeedback.status)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(h,{label:"提交时间"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.formatDateTime(r.selectedFeedback.created_at)),1)])),_:1}),(0,l.bF)(h,{label:"更新时间"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.formatDateTime(r.selectedFeedback.updated_at)),1)])),_:1})])),_:1}),(0,l.Lk)("div",_l,[t[10]||(t[10]=(0,l.Lk)("h4",null,"问题描述",-1)),(0,l.Lk)("div",Fl,(0,i.v_)(r.selectedFeedback.description),1)]),r.selectedFeedback.admin_reply?((0,l.uX)(),(0,l.CE)("div",Ll,[t[11]||(t[11]=(0,l.Lk)("h4",null,"管理员回复",-1)),(0,l.Lk)("div",xl,(0,i.v_)(r.selectedFeedback.admin_reply),1),(0,l.Lk)("div",Cl," 回复人："+(0,i.v_)(r.selectedFeedback.admin_username||"系统管理员"),1)])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)])),_:1},8,["modelValue"])])}var Rl={name:"FeedbackList",components:{ArrowLeft:b.nkM,Plus:b.FWt,Refresh:b.C42,Loading:b.Rhj},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)([]),o=(0,k.KR)(!1),r=(0,k.KR)(null),n=async()=>{t.value=!0;try{const e=await dr.get(_.endpoints.userFeedbacks);e.data.success?a.value=e.data.data:v.nk.error("获取反馈列表失败")}catch(e){console.error("获取反馈列表失败:",e),v.nk.error("获取反馈列表失败")}finally{t.value=!1}},i=async e=>{try{const t=await dr.get(_.endpoints.feedbackById.replace(":id",e.id));t.data.success?(r.value=t.data.data,o.value=!0):v.nk.error("获取反馈详情失败")}catch(t){console.error("获取反馈详情失败:",t),v.nk.error("获取反馈详情失败")}},d=async e=>{try{await h.s.confirm(`确定要删除反馈"${e.title}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await dr.delete(_.endpoints.feedbackById.replace(":id",e.id));t.data.success?(v.nk.success("删除成功"),n()):v.nk.error(t.data.message||"删除失败")}catch(t){"cancel"!==t&&(console.error("删除反馈失败:",t),v.nk.error("删除失败"))}},u=()=>{e.push({name:"FeedbackForm"})},c=()=>{e.back()},p=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN")},m=e=>{const t={bug:"danger",feature:"primary",improvement:"warning",other:"info"};return t[e]||"info"},g=e=>{const t={bug:"Bug",feature:"功能建议",improvement:"体验改进",other:"其他"};return t[e]||e},f=e=>{const t={low:"info",medium:"warning",high:"danger",urgent:"danger"};return t[e]||"info"},b=e=>{const t={low:"低",medium:"中",high:"高",urgent:"紧急"};return t[e]||e},y=e=>{const t={pending:"warning",processing:"primary",resolved:"success",closed:"info"};return t[e]||"info"},w=e=>{const t={pending:"待处理",processing:"处理中",resolved:"已解决",closed:"已关闭"};return t[e]||e};return(0,l.sV)((()=>{n()})),{loading:t,feedbacks:a,showDetail:o,selectedFeedback:r,fetchFeedbacks:n,viewFeedback:i,deleteFeedback:d,goToNewFeedback:u,goBack:c,formatDateTime:p,getTypeColor:m,getTypeText:g,getPriorityColor:f,getPriorityText:b,getStatusColor:y,getStatusText:w}}};const $l=(0,$.A)(Rl,[["render",Il],["__scopeId","data-v-7effb757"]]);var Wl=$l;const Vl={class:"feedback-management-container"},Tl={class:"header"},Sl={class:"content"},El={class:"stats-row"},Pl={class:"stat-content"},Kl={class:"stat-number"},Ul={class:"stat-content"},Al={class:"stat-number"},Dl={class:"stat-content"},Xl={class:"stat-number"},Ql={class:"stat-content"},Ml={class:"stat-number"},Bl={class:"card-header"},ql={class:"filter-form-container"},zl={class:"card-header"},Nl={key:0,style:{"text-align":"center",padding:"50px"}},Ol={key:0,class:"feedback-detail"},jl={class:"description-section"},Hl={class:"description-content"},Yl={key:0,class:"reply-section"},Jl={class:"reply-content"},Gl={class:"reply-meta"},Zl={class:"dialog-footer"};function er(e,t,a,r,n,s){const d=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),c=(0,l.g2)("el-card"),p=(0,l.g2)("arrow-up"),m=(0,l.g2)("arrow-down"),g=(0,l.g2)("el-button"),f=(0,l.g2)("el-option"),k=(0,l.g2)("el-select"),v=(0,l.g2)("el-form-item"),h=(0,l.g2)("el-col"),b=(0,l.g2)("el-row"),y=(0,l.g2)("el-form"),w=(0,l.g2)("el-collapse-transition"),_=(0,l.g2)("refresh"),F=(0,l.g2)("loading"),L=(0,l.g2)("el-table-column"),x=(0,l.g2)("el-tag"),C=(0,l.g2)("el-table"),I=(0,l.g2)("el-descriptions-item"),R=(0,l.g2)("el-descriptions"),$=(0,l.g2)("el-dialog"),W=(0,l.g2)("el-input");return(0,l.uX)(),(0,l.CE)("div",Vl,[(0,l.Lk)("div",Tl,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1}),t[10]||(t[10]=(0,l.eW)(" 返回 "))]),t[11]||(t[11]=(0,l.Lk)("h1",null,"问题反馈管理",-1)),t[12]||(t[12]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Sl,[(0,l.Lk)("div",El,[(0,l.bF)(c,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Pl,[(0,l.Lk)("div",Kl,(0,i.v_)(r.stats.total||0),1),t[13]||(t[13]=(0,l.Lk)("div",{class:"stat-label"},"总数",-1))])])),_:1}),(0,l.bF)(c,{class:"stat-card pending"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Ul,[(0,l.Lk)("div",Al,(0,i.v_)(r.stats.pending||0),1),t[14]||(t[14]=(0,l.Lk)("div",{class:"stat-label"},"待处理",-1))])])),_:1}),(0,l.bF)(c,{class:"stat-card processing"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Dl,[(0,l.Lk)("div",Xl,(0,i.v_)(r.stats.processing||0),1),t[15]||(t[15]=(0,l.Lk)("div",{class:"stat-label"},"处理中",-1))])])),_:1}),(0,l.bF)(c,{class:"stat-card resolved"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Ql,[(0,l.Lk)("div",Ml,(0,i.v_)(r.stats.resolved||0),1),t[16]||(t[16]=(0,l.Lk)("div",{class:"stat-label"},"已解决",-1))])])),_:1})]),(0,l.bF)(c,{class:"filter-card",shadow:"hover"},{header:(0,l.k6)((()=>[(0,l.Lk)("div",Bl,[t[17]||(t[17]=(0,l.Lk)("span",null,"筛选条件",-1)),(0,l.bF)(g,{link:"",type:"primary",onClick:t[1]||(t[1]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(u,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1})):((0,l.uX)(),(0,l.Wv)(u,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(m)])),_:1})),(0,l.eW)(" "+(0,i.v_)(r.showFilterPanel?"收起":"展开"),1)])),_:1})])])),default:(0,l.k6)((()=>[(0,l.bF)(w,null,{default:(0,l.k6)((()=>[(0,l.bo)((0,l.Lk)("div",ql,[(0,l.bF)(y,{model:r.filterForm,class:"filter-form","label-width":"80px"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{gutter:20},{default:(0,l.k6)((()=>[r.isSystemAdmin?((0,l.uX)(),(0,l.Wv)(h,{key:0,span:6},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"公司"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:r.filterForm.company_id,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.company_id=e),placeholder:"请选择公司",clearable:""},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"全部公司",value:null}),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.companies,(e=>((0,l.uX)(),(0,l.Wv)(f,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(h,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"状态"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:r.filterForm.status,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.status=e),placeholder:"请选择状态",clearable:""},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"全部状态",value:null}),(0,l.bF)(f,{label:"待处理",value:"pending"}),(0,l.bF)(f,{label:"处理中",value:"processing"}),(0,l.bF)(f,{label:"已解决",value:"resolved"}),(0,l.bF)(f,{label:"已关闭",value:"closed"})])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(h,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"类型"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:r.filterForm.type,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.type=e),placeholder:"请选择类型",clearable:""},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"全部类型",value:null}),(0,l.bF)(f,{label:"系统Bug",value:"bug"}),(0,l.bF)(f,{label:"功能建议",value:"feature"}),(0,l.bF)(f,{label:"体验改进",value:"improvement"}),(0,l.bF)(f,{label:"其他问题",value:"other"})])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(h,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(v,null,{default:(0,l.k6)((()=>[(0,l.bF)(g,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)("筛选")]))),_:1},8,["onClick"]),(0,l.bF)(g,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model"])],512),[[o.aG,r.showFilterPanel]])])),_:1})])),_:1}),(0,l.bF)(c,{class:"feedback-card",shadow:"hover"},{header:(0,l.k6)((()=>[(0,l.Lk)("div",zl,[(0,l.Lk)("span",null,"问题反馈列表 (共"+(0,i.v_)(r.filteredFeedbacks.length)+"条)",1),(0,l.bF)(g,{onClick:r.fetchFeedbacks},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(_)])),_:1}),t[20]||(t[20]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])])])),default:(0,l.k6)((()=>[r.loading?((0,l.uX)(),(0,l.CE)("div",Nl,[(0,l.bF)(u,{class:"is-loading"},{default:(0,l.k6)((()=>[(0,l.bF)(F)])),_:1}),t[21]||(t[21]=(0,l.Lk)("p",null,"加载中...",-1))])):((0,l.uX)(),(0,l.Wv)(C,{key:1,data:r.filteredFeedbacks,stripe:"",style:{width:"100%"},onRowClick:r.viewFeedback},{default:(0,l.k6)((()=>[(0,l.bF)(L,{prop:"id",label:"ID",width:"80"}),(0,l.bF)(L,{prop:"title",label:"问题标题","min-width":"200","show-overflow-tooltip":""}),r.isSystemAdmin?((0,l.uX)(),(0,l.Wv)(L,{key:0,prop:"company_name",label:"公司",width:"120"})):(0,l.Q3)("",!0),(0,l.bF)(L,{prop:"username",label:"提交人",width:"120"}),(0,l.bF)(L,{label:"类型",width:"100"},{default:(0,l.k6)((e=>[(0,l.bF)(x,{type:r.getTypeColor(e.row.type)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getTypeText(e.row.type)),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(L,{label:"优先级",width:"100"},{default:(0,l.k6)((e=>[(0,l.bF)(x,{type:r.getPriorityColor(e.row.priority)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getPriorityText(e.row.priority)),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(L,{label:"状态",width:"100"},{default:(0,l.k6)((e=>[(0,l.bF)(x,{type:r.getStatusColor(e.row.status)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getStatusText(e.row.status)),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(L,{prop:"created_at",label:"提交时间",width:"160"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.formatDateTime(e.row.created_at)),1)])),_:1}),(0,l.bF)(L,{label:"操作",width:"180",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.bF)(g,{size:"small",onClick:(0,o.D$)((t=>r.viewFeedback(e.row)),["stop"])},{default:(0,l.k6)((()=>t[22]||(t[22]=[(0,l.eW)("查看")]))),_:2},1032,["onClick"]),"closed"!==e.row.status?((0,l.uX)(),(0,l.Wv)(g,{key:0,size:"small",type:"primary",onClick:(0,o.D$)((t=>r.handleFeedback(e.row)),["stop"])},{default:(0,l.k6)((()=>t[23]||(t[23]=[(0,l.eW)("处理")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(g,{size:"small",type:"danger",onClick:(0,o.D$)((t=>r.deleteFeedback(e.row)),["stop"])},{default:(0,l.k6)((()=>t[24]||(t[24]=[(0,l.eW)("删除")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data","onRowClick"]))])),_:1})]),(0,l.bF)($,{modelValue:r.showDetail,"onUpdate:modelValue":t[5]||(t[5]=e=>r.showDetail=e),title:"反馈详情",width:"70%","close-on-click-modal":!1},{default:(0,l.k6)((()=>[r.selectedFeedback?((0,l.uX)(),(0,l.CE)("div",Ol,[(0,l.bF)(R,{column:2,border:""},{default:(0,l.k6)((()=>[(0,l.bF)(I,{label:"问题标题"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.selectedFeedback.title),1)])),_:1}),(0,l.bF)(I,{label:"提交人"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.selectedFeedback.username)+" ("+(0,i.v_)(r.selectedFeedback.phone)+")",1)])),_:1}),r.isSystemAdmin?((0,l.uX)(),(0,l.Wv)(I,{key:0,label:"公司"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.selectedFeedback.company_name),1)])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(I,{label:"问题类型"},{default:(0,l.k6)((()=>[(0,l.bF)(x,{type:r.getTypeColor(r.selectedFeedback.type)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getTypeText(r.selectedFeedback.type)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(I,{label:"优先级"},{default:(0,l.k6)((()=>[(0,l.bF)(x,{type:r.getPriorityColor(r.selectedFeedback.priority)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getPriorityText(r.selectedFeedback.priority)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(I,{label:"状态"},{default:(0,l.k6)((()=>[(0,l.bF)(x,{type:r.getStatusColor(r.selectedFeedback.status)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.getStatusText(r.selectedFeedback.status)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(I,{label:"提交时间"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.formatDateTime(r.selectedFeedback.created_at)),1)])),_:1}),(0,l.bF)(I,{label:"更新时间"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.formatDateTime(r.selectedFeedback.updated_at)),1)])),_:1})])),_:1}),(0,l.Lk)("div",jl,[t[25]||(t[25]=(0,l.Lk)("h4",null,"问题描述",-1)),(0,l.Lk)("div",Hl,(0,i.v_)(r.selectedFeedback.description),1)]),r.selectedFeedback.admin_reply?((0,l.uX)(),(0,l.CE)("div",Yl,[t[26]||(t[26]=(0,l.Lk)("h4",null,"管理员回复",-1)),(0,l.Lk)("div",Jl,(0,i.v_)(r.selectedFeedback.admin_reply),1),(0,l.Lk)("div",Gl," 回复人："+(0,i.v_)(r.selectedFeedback.admin_username||"系统管理员"),1)])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)])),_:1},8,["modelValue"]),(0,l.bF)($,{modelValue:r.showHandle,"onUpdate:modelValue":t[9]||(t[9]=e=>r.showHandle=e),title:"处理反馈",width:"50%","close-on-click-modal":!1},{footer:(0,l.k6)((()=>[(0,l.Lk)("span",Zl,[(0,l.bF)(g,{onClick:t[8]||(t[8]=e=>r.showHandle=!1)},{default:(0,l.k6)((()=>t[27]||(t[27]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(g,{type:"primary",onClick:r.submitHandle,loading:r.handleLoading},{default:(0,l.k6)((()=>t[28]||(t[28]=[(0,l.eW)("提交")]))),_:1},8,["onClick","loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(y,{model:r.handleForm,"label-width":"80px"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"状态"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:r.handleForm.status,"onUpdate:modelValue":t[6]||(t[6]=e=>r.handleForm.status=e),placeholder:"请选择状态",style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"处理中",value:"processing"}),(0,l.bF)(f,{label:"已解决",value:"resolved"}),(0,l.bF)(f,{label:"已关闭",value:"closed"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(v,{label:"回复内容"},{default:(0,l.k6)((()=>[(0,l.bF)(W,{modelValue:r.handleForm.admin_reply,"onUpdate:modelValue":t[7]||(t[7]=e=>r.handleForm.admin_reply=e),type:"textarea",rows:4,placeholder:"请输入处理结果或回复内容"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}var tr={name:"FeedbackManagement",components:{ArrowLeft:b.nkM,ArrowUp:b.DoI,ArrowDown:b.yd$,Refresh:b.C42,Loading:b.Rhj},setup(){const e=(0,s.rd)(),t=(0,k.KR)(!1),a=(0,k.KR)(!1),o=(0,k.KR)([]),r=(0,k.KR)([]),n=(0,k.KR)({}),i=(0,k.KR)(!0),d=(0,k.KR)(!1),u=(0,k.KR)(!1),c=(0,k.KR)(null),p=(0,k.Kh)({company_id:null,status:null,type:null}),m=(0,k.Kh)({status:"",admin_reply:""}),g=(0,l.EW)((()=>5===xr.state.user?.role_id)),f=(0,l.EW)((()=>o.value.filter((e=>(!p.company_id||e.company_id===p.company_id)&&((!p.status||e.status===p.status)&&(!p.type||e.type===p.type)))))),b=async()=>{if(g.value)try{const e=await dr.get(_.endpoints.companies);e.data.success&&(r.value=e.data.data)}catch(e){console.error("获取公司列表失败:",e)}},y=async()=>{t.value=!0;try{const e={};p.company_id&&(e.company_id=p.company_id),p.status&&(e.status=p.status),p.type&&(e.type=p.type);const t=await dr.get(_.endpoints.adminFeedbacks,e);t.data.success?o.value=t.data.data:v.nk.error("获取反馈列表失败")}catch(e){console.error("获取反馈列表失败:",e),v.nk.error("获取反馈列表失败")}finally{t.value=!1}},w=async()=>{try{const e={};p.company_id&&(e.company_id=p.company_id);const t=await dr.get(_.endpoints.feedbackStats,e);t.data.success&&(n.value=t.data.data)}catch(e){console.error("获取统计数据失败:",e)}},F=async()=>{await Promise.all([y(),w()]),v.nk.success("筛选已应用")},L=async()=>{p.company_id=null,p.status=null,p.type=null,await Promise.all([y(),w()]),v.nk.info("筛选条件已重置")},x=async e=>{try{const t=await dr.get(_.endpoints.feedbackById.replace(":id",e.id));t.data.success?(c.value=t.data.data,d.value=!0):v.nk.error("获取反馈详情失败")}catch(t){console.error("获取反馈详情失败:",t),v.nk.error("获取反馈详情失败")}},C=e=>{c.value=e,m.status="pending"===e.status?"processing":e.status,m.admin_reply=e.admin_reply||"",u.value=!0},I=async()=>{if(m.status){a.value=!0;try{const e=await dr.put(_.endpoints.feedbackStatus.replace(":id",c.value.id),{status:m.status,admin_reply:m.admin_reply});e.data.success?(v.nk.success("处理成功"),u.value=!1,await Promise.all([y(),w()])):v.nk.error(e.data.message||"处理失败")}catch(e){console.error("处理反馈失败:",e),v.nk.error("处理失败")}finally{a.value=!1}}else v.nk.error("请选择状态")},R=async e=>{try{await h.s.confirm(`确定要删除反馈"${e.title}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await dr.delete(_.endpoints.feedbackById.replace(":id",e.id));t.data.success?(v.nk.success("删除成功"),await Promise.all([y(),w()])):v.nk.error(t.data.message||"删除失败")}catch(t){"cancel"!==t&&(console.error("删除反馈失败:",t),v.nk.error("删除失败"))}},$=()=>{e.back()},W=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN")},V=e=>{const t={bug:"danger",feature:"primary",improvement:"warning",other:"info"};return t[e]||"info"},T=e=>{const t={bug:"Bug",feature:"功能建议",improvement:"体验改进",other:"其他"};return t[e]||e},S=e=>{const t={low:"info",medium:"warning",high:"danger",urgent:"danger"};return t[e]||"info"},E=e=>{const t={low:"低",medium:"中",high:"高",urgent:"紧急"};return t[e]||e},P=e=>{const t={pending:"warning",processing:"primary",resolved:"success",closed:"info"};return t[e]||"info"},K=e=>{const t={pending:"待处理",processing:"处理中",resolved:"已解决",closed:"已关闭"};return t[e]||e};return(0,l.sV)((async()=>{await b(),await Promise.all([y(),w()])})),{loading:t,handleLoading:a,feedbacks:o,companies:r,stats:n,showFilterPanel:i,showDetail:d,showHandle:u,selectedFeedback:c,filterForm:p,handleForm:m,isSystemAdmin:g,filteredFeedbacks:f,fetchFeedbacks:y,fetchStats:w,applyFilter:F,resetFilter:L,viewFeedback:x,handleFeedback:C,submitHandle:I,deleteFeedback:R,goBack:$,formatDateTime:W,getTypeColor:V,getTypeText:T,getPriorityColor:S,getPriorityText:E,getStatusColor:P,getStatusText:K}}};const ar=(0,$.A)(tr,[["render",er],["__scopeId","data-v-41ed3348"]]);var or=ar;const lr=[{path:"/login",name:"Login",component:lt,meta:{requiresAuth:!1}},{path:"/user-management",name:"UserManagement",component:Mt,meta:{requiresAuth:!0,requiresManager:!0}},{path:"/profile",name:"UserProfile",component:Ra,meta:{requiresAuth:!0}},{path:"/operation-logs",name:"OperationLogs",component:ao,meta:{requiresAuth:!0,requiresLogPermission:!0}},{path:"/companies",name:"CompanyManagement",component:_o,meta:{requiresAuth:!0,requiresSystemAdmin:!0}},{path:"/",name:"Home",component:V,meta:{requiresAuth:!0}},{path:"/units",name:"UnitSelection",component:V,meta:{requiresAuth:!0}},{path:"/admin-records",name:"AdminRecords",component:wa,meta:{requiresAuth:!0,requiresCompanyAdmin:!0}},{path:"/super-admin-records",name:"SuperAdminRecords",component:Jo,meta:{requiresAuth:!0,requiresSystemAdmin:!0}},{path:"/record/new",name:"NewRecord",component:Wt,props:{id:null},meta:{requiresAuth:!0}},{path:"/record/:id",name:"EditRecord",component:Wt,props:!0,meta:{requiresAuth:!0}},{path:"/unit/:id",name:"WasteForm",component:ie,props:!0,meta:{requiresAuth:!0}},{path:"/records/:unitId",name:"RecordsList",component:Je,props:!0,meta:{requiresAuth:!0}},{path:"/feedback/new",name:"FeedbackForm",component:ll,meta:{requiresAuth:!0}},{path:"/feedback/list",name:"FeedbackList",component:Wl,meta:{requiresAuth:!0}},{path:"/feedback/management",name:"FeedbackManagement",component:or,meta:{requiresAuth:!0,requiresManager:!0}}],rr=(0,s.aE)({history:(0,s.LA)("/"),routes:lr});rr.beforeEach((async(e,t,a)=>{const o=e.matched.some((e=>e.meta.requiresAuth)),l=e.matched.some((e=>e.meta.requiresSuperAdmin)),r=e.matched.some((e=>e.meta.requiresSystemAdmin)),n=e.matched.some((e=>e.meta.requiresCompanyAdmin)),s=e.matched.some((e=>e.meta.requiresManager)),i=e.matched.some((e=>e.meta.requiresLogPermission));if(!o||xr.state.isLoggedIn){if("WasteForm"===e.name&&xr.state.isLoggedIn&&xr.isSupervisor()){const t=e.params.id;try{const e=await dr.get(`${_.endpoints.units}/${t}`),o=e.data;if(o&&o.company_id!==xr.getCompanyId())return console.warn("监督人员尝试访问其他公司单位:",t),void a({name:"UnitSelection"})}catch(d){return console.error("验证单位访问权限失败:",d),void a({name:"UnitSelection"})}}if("RecordsList"===e.name&&xr.state.isLoggedIn&&xr.isSupervisor()){const t=e.params.unitId;try{const e=await dr.get(`${_.endpoints.units}/${t}`),o=e.data;if(o&&o.company_id!==xr.getCompanyId())return console.warn("监督人员尝试访问其他公司单位记录:",t),void a({name:"UnitSelection"})}catch(d){return console.error("验证单位记录访问权限失败:",d),void a({name:"UnitSelection"})}}if(i&&xr.state.isLoggedIn&&1!==xr.state.user.can_view_logs)5===xr.state.user.role_id?a({name:"SuperAdminRecords"}):3===xr.state.user.role_id?a({name:"AdminRecords"}):4===xr.state.user.role_id?a({name:"NewRecord"}):xr.state.user.unit_id?a({name:"WasteForm",params:{id:xr.state.user.unit_id}}):a({name:"UnitSelection"});else{if(l&&xr.state.isLoggedIn){if(5===xr.state.user.role_id)return void a({name:"SuperAdminRecords"});if(3!==xr.state.user.role_id&&4!==xr.state.user.role_id)return void(xr.state.user.unit_id?a({name:"WasteForm",params:{id:xr.state.user.unit_id}}):a({name:"UnitSelection"}))}if(r&&xr.state.isLoggedIn&&5!==xr.state.user.role_id)3===xr.state.user.role_id?a({name:"AdminRecords"}):4===xr.state.user.role_id?a({name:"NewRecord"}):xr.state.user.unit_id?a({name:"WasteForm",params:{id:xr.state.user.unit_id}}):a({name:"UnitSelection"});else if(n&&xr.state.isLoggedIn&&3!==xr.state.user.role_id&&4!==xr.state.user.role_id)5===xr.state.user.role_id?a({name:"SuperAdminRecords"}):xr.state.user.unit_id?a({name:"WasteForm",params:{id:xr.state.user.unit_id}}):a({name:"UnitSelection"});else{if(s&&xr.state.isLoggedIn)if(5===xr.state.user.role_id||3===xr.state.user.role_id||2===xr.state.user.role_id);else{if(4===xr.state.user.role_id)return void a({name:"NewRecord"});if(1===xr.state.user.role_id)return void(xr.state.user.unit_id?a({name:"WasteForm",params:{id:xr.state.user.unit_id}}):a({name:"UnitSelection"}))}if("Login"===e.name&&xr.state.isLoggedIn)5===xr.state.user.role_id?a({name:"SuperAdminRecords"}):3===xr.state.user.role_id?a({name:"AdminRecords"}):4===xr.state.user.role_id?a({name:"NewRecord"}):(xr.state.user.role_id,xr.state.user.unit_id?a({name:"WasteForm",params:{id:xr.state.user.unit_id}}):a({name:"UnitSelection"}));else{if(("/"===e.path||"Home"===e.name)&&xr.state.isLoggedIn)return 5===xr.state.user.role_id?void a({name:"SuperAdminRecords"}):3===xr.state.user.role_id?void a({name:"AdminRecords"}):4===xr.state.user.role_id?void a({name:"NewRecord"}):2===xr.state.user.role_id||1===xr.state.user.role_id?void(xr.state.user.unit_id?a({name:"WasteForm",params:{id:xr.state.user.unit_id}}):a({name:"UnitSelection"})):void a({name:"UnitSelection"});if("WasteForm"===e.name&&xr.state.isLoggedIn){if(5===xr.state.user.role_id)return void a({name:"SuperAdminRecords"});if(3===xr.state.user.role_id||4===xr.state.user.role_id);else if((1===xr.state.user.role_id||2===xr.state.user.role_id)&&xr.state.user.unit_id&&xr.state.user.unit_id!==parseInt(e.params.id))return void a({name:"WasteForm",params:{id:xr.state.user.unit_id}})}"UnitSelection"===e.name&&xr.state.isLoggedIn&&5===xr.state.user.role_id?a({name:"SuperAdminRecords"}):a()}}}}else a({name:"Login"})}));var nr=rr;const sr=y.A.create({baseURL:_.baseURL,timeout:3e5,headers:{"Content-Type":"application/json"},maxContentLength:52428800,maxBodyLength:52428800});sr.interceptors.request.use((e=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return t&&(e.headers.Authorization=`Bearer ${t}`),e}),(e=>(console.error("Request error:",e),Promise.reject(e)))),sr.interceptors.response.use((e=>e),(e=>{if(e.response)switch(e.response.status){case 401:if(e.config.url.includes("/api/login"))return Promise.reject(e);xr.logout(),v.nk.error("登录已过期，请重新登录"),nr.push("/login");break;case 403:e.response.data?.error?.includes("监督人员只能")?(v.nk.error(e.response.data.error),nr.push({name:"UnitSelection"})):v.nk.error("没有权限访问该资源");break;case 404:v.nk.error("请求的资源不存在");break;case 500:v.nk.error("服务器错误，请稍后重试");break;default:v.nk.error(e.response.data?.error||"请求失败")}else e.request?v.nk.error("网络错误，请检查网络连接"):v.nk.error("请求配置错误");return Promise.reject(e)}));const ir={get(e,t={}){return sr.get(e,{params:t})},post(e,t={}){return sr.post(e,t)},postForm(e,t,a){const o={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};"function"===typeof a&&(o.onUploadProgress=a);const l=localStorage.getItem("token")||sessionStorage.getItem("token");return l&&(o.headers.Authorization=`Bearer ${l}`),sr.post(e,t,o)},put(e,t={}){return sr.put(e,t)},putForm(e,t,a){const o={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};"function"===typeof a&&(o.onUploadProgress=a);const l=localStorage.getItem("token")||sessionStorage.getItem("token");return l&&(o.headers.Authorization=`Bearer ${l}`),sr.put(e,t,o)},delete(e){return sr.delete(e)},defaults:sr.defaults};var dr=ir;const ur={user:null,token:null,isLoggedIn:!1,loading:!1,error:null},cr=(0,k.Kh)({...ur}),pr=()=>{let e=localStorage.getItem("user"),t=localStorage.getItem("token");if(e&&t||(e=sessionStorage.getItem("user"),t=sessionStorage.getItem("token")),e&&t)try{const a=JSON.parse(e);cr.user=a,cr.token=t,cr.isLoggedIn=!0,dr.defaults&&dr.defaults.headers&&(dr.defaults.headers.common["Authorization"]=`Bearer ${t}`),console.log("成功恢复用户状态:",a.username||a.phone,"角色ID:",a.role_id)}catch(a){console.error("Error parsing saved user data:",a),localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")}else console.log("未找到保存的用户状态")},mr=async(e,t,a=!1)=>{cr.loading=!0,cr.error=null,console.log("auth.login 开始执行，手机号:",e);try{const l={phone:e,rememberMe:a};null!==t&&void 0!==t&&""!==t?(l.password=t,console.log("auth.login 发送密码参数")):console.log("auth.login 不发送密码参数"),console.log("发送登录请求，数据:",l);const r=await dr.post(_.endpoints.login,l);console.log("登录请求成功响应:",r.data);const{token:n,...s}=r.data;cr.user=s,cr.token=n,cr.isLoggedIn=!0,dr.defaults&&dr.defaults.headers&&(dr.defaults.headers.common["Authorization"]=`Bearer ${n}`),a?(localStorage.setItem("user",JSON.stringify(s)),localStorage.setItem("token",n)):(sessionStorage.setItem("user",JSON.stringify(s)),sessionStorage.setItem("token",n),localStorage.removeItem("user"),localStorage.removeItem("token"));try{"caches"in window&&caches.keys().then((e=>{e.forEach((e=>{caches.delete(e)}))}))}catch(o){console.warn("清除缓存失败:",o)}return{success:!0,user:s}}catch(l){return cr.error=l.response?.data?.error||"登录失败，请检查网络连接",console.error("Login error:",l),{success:!1,error:cr.error}}finally{cr.loading=!1}},gr=()=>{cr.user=null,cr.token=null,cr.isLoggedIn=!1,dr.defaults&&dr.defaults.headers&&delete dr.defaults.headers.common["Authorization"],localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")},fr=()=>cr.isLoggedIn&&cr.user&&5===cr.user.role_id,kr=()=>cr.isLoggedIn&&cr.user&&3===cr.user.role_id,vr=()=>cr.isLoggedIn&&cr.user&&(3===cr.user.role_id||4===cr.user.role_id||5===cr.user.role_id),hr=()=>cr.isLoggedIn&&cr.user&&2===cr.user.role_id,br=()=>cr.isLoggedIn&&cr.user&&4===cr.user.role_id,yr=()=>cr.user?cr.user.id:null,wr=()=>cr.user?cr.user.unit_id:null,_r=()=>cr.user?cr.user.company_id:null,Fr=()=>cr.user?cr.user.company_name:null,Lr=e=>{cr.isLoggedIn&&cr.user&&(cr.user={...cr.user,...e},localStorage.getItem("user")&&localStorage.setItem("user",JSON.stringify(cr.user)),sessionStorage.getItem("user")&&sessionStorage.setItem("user",JSON.stringify(cr.user)))};pr();var xr={state:cr,login:mr,logout:gr,isSystemAdmin:fr,isCompanyAdmin:kr,isAdmin:vr,isUnitAdmin:hr,isSupervisor:br,getUserId:yr,getUnitId:wr,getCompanyId:_r,getCompanyName:Fr,updateUserInfo:Lr},Cr={name:"AppHeader",components:{ChatLineRound:b.Fv_},setup(){const e=(0,s.rd)(),t=(0,k.KR)(null),a=(0,k.KR)(!1),o=(0,k.KR)(!1),r=(0,l.EW)((()=>xr.state.isLoggedIn?xr.state.user.username||xr.state.user.phone:"")),n=(0,k.Kh)({type:"bug",priority:"medium",title:"",description:""}),i={type:[{required:!0,message:"请选择问题类型",trigger:"change"}],priority:[{required:!0,message:"请选择优先级",trigger:"change"}],title:[{required:!0,message:"请输入问题标题",trigger:"blur"}],description:[{required:!0,message:"请输入问题描述",trigger:"blur"}]},d=()=>{xr.logout(),v.nk.success("已退出登录"),e.push("/login")},u=()=>{e.push("/profile")},c=()=>{o.value=!0},p=()=>{n.title||n.description?h.s.confirm("您有未保存的内容，确定要离开吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{o.value=!1,g()})):(o.value=!1,g())},m=async()=>{try{const e=await t.value.validate();if(!e)return;a.value=!0;const l={type:n.type,priority:n.priority,title:n.title,description:n.description},r=await dr.post(_.endpoints.feedback,l);r.data.success?(v.nk.success("问题反馈提交成功！"),o.value=!1,g()):v.nk.error(r.data.message||"提交失败")}catch(e){console.error("提交问题反馈失败:",e),v.nk.error("提交失败，请重试")}finally{a.value=!1}},g=()=>{t.value&&t.value.resetFields(),n.type="bug",n.priority="medium",n.title="",n.description=""};return{auth:xr,userName:r,handleLogout:d,goToProfile:u,feedbackVisible:o,formRef:t,loading:a,form:n,rules:i,showFeedbackDialog:c,closeFeedbackDialog:p,submitForm:m,resetForm:g}}};const Ir=(0,$.A)(Cr,[["render",f],["__scopeId","data-v-5cf04759"]]);var Rr=Ir,$r={components:{AppHeader:Rr},setup(){const e=(0,s.lq)(),t=(0,l.EW)((()=>"/login"!==e.path)),a="1.0.1",o="app_version";return(0,l.sV)((()=>{const e=localStorage.getItem(o);e&&e!==a?h.s.confirm("应用有新的更新，需要刷新页面以获取最新功能。","版本更新",{confirmButtonText:"立即刷新",cancelButtonText:"稍后再说",type:"warning"}).then((()=>{localStorage.setItem(o,a),window.location.reload(!0)})).catch((()=>{localStorage.setItem(o,a)})):localStorage.setItem(o,a)})),{showHeader:t}}};const Wr=(0,$.A)($r,[["render",n]]);var Vr=Wr,Tr=a(6070),Sr=(a(4188),a(5186));const Er=(0,o.Ef)(Vr);Er.use(nr),Er.use(Tr.A,{locale:Sr.A}),Er.mount("#app")}},t={};function a(o){var l=t[o];if(void 0!==l)return l.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,a),r.exports}a.m=e,function(){var e=[];a.O=function(t,o,l,r){if(!o){var n=1/0;for(u=0;u<e.length;u++){o=e[u][0],l=e[u][1],r=e[u][2];for(var s=!0,i=0;i<o.length;i++)(!1&r||n>=r)&&Object.keys(a.O).every((function(e){return a.O[e](o[i])}))?o.splice(i--,1):(s=!1,r<n&&(n=r));if(s){e.splice(u--,1);var d=l();void 0!==d&&(t=d)}}return t}r=r||0;for(var u=e.length;u>0&&e[u-1][2]>r;u--)e[u]=e[u-1];e[u]=[o,l,r]}}(),function(){a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,{a:t}),t}}(),function(){a.d=function(e,t){for(var o in t)a.o(t,o)&&!a.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};a.O.j=function(t){return 0===e[t]};var t=function(t,o){var l,r,n=o[0],s=o[1],i=o[2],d=0;if(n.some((function(t){return 0!==e[t]}))){for(l in s)a.o(s,l)&&(a.m[l]=s[l]);if(i)var u=i(a)}for(t&&t(o);d<n.length;d++)r=n[d],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return a.O(u)},o=self["webpackChunkhazardous_waste_management_frontend"]=self["webpackChunkhazardous_waste_management_frontend"]||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))}();var o=a.O(void 0,[504],(function(){return a(5762)}));o=a.O(o)})();
//# sourceMappingURL=app.bfd8ab61.js.map