(function(){"use strict";var e={2246:function(e,t,a){var l=a(5130),o=a(6768);const r={id:"app"};function n(e,t,a,l,n,i){const s=(0,o.g2)("app-header"),u=(0,o.g2)("router-view");return(0,o.uX)(),(0,o.CE)("div",r,[l.showHeader?((0,o.uX)(),(0,o.Wv)(s,{key:0})):(0,o.Q3)("",!0),(0,o.bF)(u)])}var i=a(1387),s=a(4232);const u={class:"app-header"},d={key:0,class:"user-info"},c={class:"welcome-text"},p={class:"role-tag"},m={key:0,class:"unit-tag"};function f(e,t,a,l,r,n){const i=(0,o.g2)("el-button");return(0,o.uX)(),(0,o.CE)("div",u,[t[2]||(t[2]=(0,o.Lk)("div",{class:"header-title"},[(0,o.Lk)("h1",null,"危险废物管理系统")],-1)),l.auth.state.isLoggedIn?((0,o.uX)(),(0,o.CE)("div",d,[(0,o.Lk)("span",c,[t[0]||(t[0]=(0,o.eW)(" 欢迎, ")),(0,o.Lk)("strong",null,(0,s.v_)(l.userName),1),(0,o.Lk)("span",p,"("+(0,s.v_)(l.auth.state.user.role)+")",1),l.auth.state.user.unit_name?((0,o.uX)(),(0,o.CE)("span",m,(0,s.v_)(l.auth.state.user.unit_name),1)):(0,o.Q3)("",!0)]),(0,o.bF)(i,{type:"text",class:"logout-button",onClick:l.handleLogout},{default:(0,o.k6)((()=>t[1]||(t[1]=[(0,o.eW)(" 退出登录 ")]))),_:1},8,["onClick"])])):(0,o.Q3)("",!0)])}var g=a(1219),h=a(144),v=a(4373);const k="";var b={baseURL:k,endpoints:{login:"/api/login",users:"/api/users",units:"/api/units",wasteTypes:"/api/waste-types",wasteRecords:"/api/waste-records"},getUrl(e){return`${this.baseURL}${e}`}};const w=v.A.create({baseURL:b.baseURL,timeout:1e4,headers:{"Content-Type":"application/json"}});w.interceptors.request.use((e=>e),(e=>Promise.reject(e))),w.interceptors.response.use((e=>e),(e=>(console.error("API请求错误:",e),Promise.reject(e))));const y={get(e,t={}){return w.get(e,{params:t})},post(e,t={}){return w.post(e,t)},postForm(e,t){return w.post(e,t,{headers:{"Content-Type":"multipart/form-data"}})},put(e,t={}){return w.put(e,t)},putForm(e,t){return w.put(e,t,{headers:{"Content-Type":"multipart/form-data"}})},delete(e){return w.delete(e)}};var _=y;const F={user:null,isLoggedIn:!1,loading:!1,error:null},I=(0,h.Kh)({...F}),L=()=>{const e=localStorage.getItem("user");if(e)try{const t=JSON.parse(e);I.user=t,I.isLoggedIn=!0}catch(t){console.error("Error parsing saved user data:",t),localStorage.removeItem("user")}},C=async(e,t)=>{I.loading=!0,I.error=null,console.log("auth.login 开始执行，手机号:",e);try{const a={phone:e};null!==t&&void 0!==t&&""!==t?(a.password=t,console.log("auth.login 发送密码参数")):console.log("auth.login 不发送密码参数"),console.log("发送登录请求，数据:",a);const l=await _.post(b.endpoints.login,a);console.log("登录请求成功响应:",l.data);const o=l.data;return I.user=o,I.isLoggedIn=!0,localStorage.setItem("user",JSON.stringify(o)),{success:!0,user:o}}catch(a){return I.error=a.response?.data?.error||"登录失败，请检查网络连接",console.error("Login error:",a),{success:!1,error:I.error}}finally{I.loading=!1}},R=()=>{I.user=null,I.isLoggedIn=!1,localStorage.removeItem("user")};L();var V={state:I,login:C,logout:R},W={name:"AppHeader",setup(){const e=(0,i.rd)(),t=(0,o.EW)((()=>V.state.isLoggedIn?V.state.user.username||V.state.user.phone:"")),a=()=>{V.logout(),g.nk.success("已退出登录"),e.push("/login")};return{auth:V,userName:t,handleLogout:a}}},P=a(1241);const E=(0,P.A)(W,[["render",f],["__scopeId","data-v-4be6b0ba"]]);var T=E,U={components:{AppHeader:T},setup(){const e=(0,i.lq)(),t=(0,o.EW)((()=>"/login"!==e.path));return{showHeader:t}}};const A=(0,P.A)(U,[["render",n]]);var X=A;const $={class:"unit-selection-container"},K={class:"content"},q={class:"units-grid"},x={class:"unit-name"};function D(e,t,a,l,r,n){const i=(0,o.g2)("el-card");return(0,o.uX)(),(0,o.CE)("div",$,[t[1]||(t[1]=(0,o.Lk)("div",{class:"header"},[(0,o.Lk)("h1",null,"危险废物管理系统")],-1)),(0,o.Lk)("div",K,[t[0]||(t[0]=(0,o.Lk)("h2",null,"请选择您的单位",-1)),(0,o.Lk)("div",q,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.units,(e=>((0,o.uX)(),(0,o.Wv)(i,{key:e.id,class:"unit-card",shadow:"hover",onClick:t=>n.selectUnit(e)},{default:(0,o.k6)((()=>[(0,o.Lk)("div",x,(0,s.v_)(e.name),1)])),_:2},1032,["onClick"])))),128))])]),t[2]||(t[2]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var B={name:"UnitSelection",data(){return{units:[],loading:!1}},created(){this.fetchUnits()},methods:{async fetchUnits(){this.loading=!0;try{console.log("正在获取单位列表...");const e=await v.A.get(b.getUrl(b.endpoints.units));console.log("获取单位列表成功:",e.data),this.units=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}finally{this.loading=!1}},selectUnit(e){this.$router.push({name:"WasteForm",params:{id:e.id}})}}};const Q=(0,P.A)(B,[["render",D],["__scopeId","data-v-a706bc72"]]);var S=Q;const M={class:"waste-form-container"},Y={class:"header"},N={key:1},O={class:"content"},H={class:"unit-info"},j={class:"form-row"},z={class:"form-actions"};function J(e,t,a,l,r,n){const i=(0,o.g2)("arrow-left"),u=(0,o.g2)("el-icon"),d=(0,o.g2)("document"),c=(0,o.g2)("el-option"),p=(0,o.g2)("el-select"),m=(0,o.g2)("el-form-item"),f=(0,o.g2)("el-input"),g=(0,o.g2)("el-date-picker"),h=(0,o.g2)("clock"),v=(0,o.g2)("el-time-picker"),k=(0,o.g2)("el-input-number"),b=(0,o.g2)("plus"),w=(0,o.g2)("el-upload"),y=(0,o.g2)("el-button"),_=(0,o.g2)("el-form");return(0,o.uX)(),(0,o.CE)("div",M,[(0,o.Lk)("div",Y,[l.isAdmin?((0,o.uX)(),(0,o.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(i)])),_:1}),t[7]||(t[7]=(0,o.eW)(" 返回 "))])):((0,o.uX)(),(0,o.CE)("div",N)),t[9]||(t[9]=(0,o.Lk)("h1",null,"危险废物填报",-1)),(0,o.Lk)("div",{class:"view-records",onClick:t[1]||(t[1]=(...e)=>l.viewRecords&&l.viewRecords(...e))},[t[8]||(t[8]=(0,o.eW)(" 查看记录 ")),(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(d)])),_:1})])]),(0,o.Lk)("div",O,[(0,o.Lk)("div",H,[(0,o.Lk)("h2",null,(0,s.v_)(l.unitName),1)]),(0,o.bF)(_,{ref:"wasteForm",model:l.form,rules:l.rules,"label-position":"top",class:"waste-form"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{label:"废物类型",prop:"wasteTypeId"},{default:(0,o.k6)((()=>[(0,o.bF)(p,{modelValue:l.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"产生地点",prop:"location"},{default:(0,o.k6)((()=>[(0,o.bF)(f,{modelValue:l.form.location,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.location=e),placeholder:"请输入废物产生地点"},null,8,["modelValue"])])),_:1}),(0,o.Lk)("div",j,[(0,o.bF)(m,{label:"收集日期",class:"date-item"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:l.form.collectionDate,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"收集时间",class:"time-item"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:l.form.collectionTime,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(h)])),_:1})])),_:1},8,["modelValue"])])),_:1})]),(0,o.bF)(m,{label:"收集数量(吨)",prop:"quantity"},{default:(0,o.k6)((()=>[(0,o.bF)(k,{modelValue:l.form.quantity,"onUpdate:modelValue":t[6]||(t[6]=e=>l.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"},"controls-position":"right"},null,8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"现场照片（收集前）",prop:"photosBefore"},{default:(0,o.k6)((()=>[t[10]||(t[10]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多10张）",-1)),(0,o.bF)(w,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoBeforeChange,"on-remove":l.handlePhotoBeforeRemove,"file-list":l.fileListBefore,limit:10,multiple:"","list-type":"picture-card","before-upload":l.handleBeforeUpload},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(b)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,o.bF)(m,{label:"现场照片（收集后）",prop:"photosAfter"},{default:(0,o.k6)((()=>[t[11]||(t[11]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多10张）",-1)),(0,o.bF)(w,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoAfterChange,"on-remove":l.handlePhotoAfterRemove,"file-list":l.fileListAfter,limit:10,multiple:"","list-type":"picture-card","before-upload":l.handleBeforeUpload},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(b)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,o.Lk)("div",z,[(0,o.bF)(y,{type:"primary",onClick:l.submitForm,loading:l.loading,class:"submit-btn"},{default:(0,o.k6)((()=>t[12]||(t[12]=[(0,o.eW)("提交")]))),_:1},8,["onClick","loading"]),(0,o.bF)(y,{onClick:l.resetForm,class:"reset-btn"},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model","rules"])]),t[14]||(t[14]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var G=a(7477),Z={name:"WasteForm",components:{ArrowLeft:G.nkM,Document:G.yoT,Plus:G.FWt,Clock:G.zD7},props:{id:{type:[String,Number],required:!0}},setup(e){const t=(0,i.rd)(),a=(0,h.KR)(null),l=(0,h.KR)(!1),r=(0,h.KR)(""),n=(0,h.KR)([]),s=(0,h.KR)([]),u=(0,h.KR)([]),d=(0,h.KR)([]),c=(0,h.KR)([]),p=(0,o.EW)((()=>V.state.isLoggedIn&&3===V.state.user.role_id)),m=(0,h.Kh)({wasteTypeId:"",location:"",collectionDate:(new Date).toISOString().slice(0,10),collectionTime:"08:00",quantity:0,photosBefore:[],photosAfter:[]}),f={wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],location:[{required:!0,message:"请输入废物产生地点",trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,o.sV)((async()=>{await v(),await k()}));const v=async()=>{try{const t=await _.get(b.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.id)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},k=async()=>{try{const e=await _.get(b.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型失败")}},w=e=>(e.uid||(e.uid=Date.now()+"-"+Math.random().toString(36).substr(2,10)),!0),y=(e,t)=>{console.log("收集前照片变更:",e),d.value=t,s.value=t.filter((e=>e.raw)).map((e=>e.raw)),console.log("更新后的photoFilesBefore:",s.value)},F=(e,t)=>{console.log("收集前照片移除:",e),d.value=t,s.value=t.filter((e=>e.raw)).map((e=>e.raw)),console.log("更新后的photoFilesBefore:",s.value)},I=(e,t)=>{console.log("收集后照片变更:",e),c.value=t,u.value=t.filter((e=>e.raw)).map((e=>e.raw)),console.log("更新后的photoFilesAfter:",u.value)},L=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,u.value=t.filter((e=>e.raw)).map((e=>e.raw)),console.log("更新后的photoFilesAfter:",u.value)},C=()=>{a.value.validate((async t=>{if(t){l.value=!0;try{const t=new FormData;if(t.append("unitId",e.id),t.append("wasteTypeId",m.wasteTypeId),t.append("location",m.location),m.collectionDate&&m.collectionTime){const e=`${m.collectionDate} ${m.collectionTime}:00`;t.append("collectionStartTime",e)}t.append("quantity",m.quantity),V.state.isLoggedIn&&V.state.user&&t.append("creatorId",V.state.user.id),console.log("提交表单数据:",{unitId:e.id,wasteTypeId:m.wasteTypeId,location:m.location,quantity:m.quantity,photosBefore:s.value?s.value.length:0,photosAfter:u.value?u.value.length:0}),s.value&&s.value.length>0&&(console.log("添加收集前照片数量:",s.value.length),s.value.forEach(((e,a)=>{e&&(console.log(`收集前照片 ${a+1}:`,e.name),t.append("photosBefore",e))}))),u.value&&u.value.length>0&&(console.log("添加收集后照片数量:",u.value.length),u.value.forEach(((e,a)=>{e&&(console.log(`收集后照片 ${a+1}:`,e.name),t.append("photosAfter",e))})));const a=await _.postForm(b.endpoints.wasteRecords,t);console.log("提交响应:",a.data),g.nk.success("废物记录提交成功"),R()}catch(a){console.error("Error submitting form:",a),a.response&&(console.error("错误响应数据:",a.response.data),console.error("错误状态码:",a.response.status)),g.nk.error("提交失败，请稍后再试")}finally{l.value=!1}}else g.nk.warning("请完成必填项")}))},R=()=>{a.value&&a.value.resetFields(),s.value=[],u.value=[],d.value=[],c.value=[],m.quantity=0,m.collectionDate=(new Date).toISOString().slice(0,10),m.collectionTime="08:00"},W=()=>{p.value&&t.push("/")},P=()=>{t.push({name:"RecordsList",params:{unitId:e.id}})};return{form:m,rules:f,wasteForm:a,loading:l,unitName:r,wasteTypes:n,isAdmin:p,fileListBefore:d,fileListAfter:c,handlePhotoBeforeChange:y,handlePhotoBeforeRemove:F,handlePhotoAfterChange:I,handlePhotoAfterRemove:L,handleBeforeUpload:w,submitForm:C,resetForm:R,goBack:W,viewRecords:P}}};const ee=(0,P.A)(Z,[["render",J],["__scopeId","data-v-204824c0"]]);var te=ee;const ae={class:"records-container"},le={class:"header"},oe={key:1},re={class:"content"},ne={class:"unit-info"},ie={class:"filter-header"},se={class:"filter-form-container"},ue={class:"quantity-range"},de={class:"filter-actions"},ce={class:"records-wrapper"},pe={class:"card-header"},me={class:"card-actions"},fe={key:0},ge=["onClick"],he={class:"image-error"},ve={key:0,class:"photo-count"},ke={key:1},be={key:0},we=["onClick"],ye={class:"image-error"},_e={key:0,class:"photo-count"},Fe={key:1},Ie={key:0,class:"empty-block"};function Le(e,t,a,r,n,i){const u=(0,o.g2)("arrow-left"),d=(0,o.g2)("el-icon"),c=(0,o.g2)("home"),p=(0,o.g2)("arrow-down"),m=(0,o.g2)("arrow-up"),f=(0,o.g2)("el-button"),g=(0,o.g2)("el-date-picker"),h=(0,o.g2)("el-form-item"),v=(0,o.g2)("el-col"),k=(0,o.g2)("el-option"),b=(0,o.g2)("el-select"),w=(0,o.g2)("el-row"),y=(0,o.g2)("el-input-number"),_=(0,o.g2)("el-input"),F=(0,o.g2)("el-form"),I=(0,o.g2)("el-card"),L=(0,o.g2)("plus"),C=(0,o.g2)("user"),R=(0,o.g2)("download"),V=(0,o.g2)("refresh"),W=(0,o.g2)("el-table-column"),P=(0,o.g2)("picture-failed"),E=(0,o.g2)("el-image"),T=(0,o.g2)("el-table"),U=(0,o.g2)("el-empty"),A=(0,o.g2)("el-image-viewer"),X=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",ae,[(0,o.Lk)("div",le,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1}),t[8]||(t[8]=(0,o.eW)(" 返回填报 "))]),t[10]||(t[10]=(0,o.Lk)("h1",null,"废物记录查看",-1)),r.isAdmin?((0,o.uX)(),(0,o.CE)("div",{key:0,class:"home-link",onClick:t[1]||(t[1]=(...e)=>r.goHome&&r.goHome(...e))},[t[9]||(t[9]=(0,o.eW)(" 首页 ")),(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(c)])),_:1})])):((0,o.uX)(),(0,o.CE)("div",oe))]),(0,o.Lk)("div",re,[(0,o.Lk)("div",ne,[(0,o.Lk)("h2",null,(0,s.v_)(r.unitName)+" - 危险废物记录",1)]),(0,o.bF)(I,{class:"filter-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",ie,[t[11]||(t[11]=(0,o.Lk)("h3",null,"筛选条件",-1)),(0,o.bF)(f,{type:"primary",link:"",onClick:t[2]||(t[2]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,o.k6)((()=>[(0,o.eW)((0,s.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,o.uX)(),(0,o.Wv)(d,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(m)])),_:1})):((0,o.uX)(),(0,o.Wv)(d,{key:0},{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1}))])),_:1})]),(0,o.bo)((0,o.Lk)("div",se,[(0,o.bF)(F,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,o.k6)((()=>[(0,o.bF)(w,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(v,{span:12},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(v,{span:12},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"废物类型"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(k,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.bF)(w,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(v,{span:12},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"数量范围(吨)"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",ue,[(0,o.bF)(y,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"48%"}},null,8,["modelValue"]),t[12]||(t[12]=(0,o.Lk)("span",{class:"range-separator"},"至",-1)),(0,o.bF)(y,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"48%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,o.bF)(v,{span:12},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"产生地点"},{default:(0,o.k6)((()=>[(0,o.bF)(_,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.Lk)("div",de,[(0,o.bF)(f,{type:"primary",onClick:r.applyFilter},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)("筛选")]))),_:1},8,["onClick"]),(0,o.bF)(f,{onClick:r.resetFilter},{default:(0,o.k6)((()=>t[14]||(t[14]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[l.aG,r.showFilterPanel]])])),_:1}),(0,o.Lk)("div",ce,[(0,o.bF)(I,{class:"records-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",pe,[t[19]||(t[19]=(0,o.Lk)("h3",null,"废物记录列表",-1)),(0,o.Lk)("div",me,[(0,o.bF)(f,{type:"primary",onClick:r.addNewRecord},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(L)])),_:1}),t[15]||(t[15]=(0,o.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isAdmin||r.isUnitAdmin?((0,o.uX)(),(0,o.Wv)(f,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(C)])),_:1}),t[16]||(t[16]=(0,o.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,o.Q3)("",!0),(0,o.bF)(f,{type:"warning",onClick:r.exportRecords},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(R)])),_:1}),t[17]||(t[17]=(0,o.eW)(" 导出记录 "))])),_:1},8,["onClick"]),(0,o.bF)(f,{onClick:r.refreshRecords},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(V)])),_:1}),t[18]||(t[18]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"])])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(T,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:""},{default:(0,o.k6)((()=>[(0,o.bF)(W,{prop:"waste_type_name",label:"废物类型",width:"110"}),(0,o.bF)(W,{prop:"location",label:"产生地点"}),(0,o.bF)(W,{prop:"collection_start_time",label:"收集开始时间",width:"160"}),(0,o.bF)(W,{prop:"quantity",label:"数量(吨)",width:"100"}),(0,o.bF)(W,{prop:"created_at",label:"记录时间",width:"160"}),(0,o.bF)(W,{label:"现场照片（清理前）",width:"120"},{default:(0,o.k6)((e=>[e.row.photo_path_before?((0,o.uX)(),(0,o.CE)("div",fe,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,o.bF)(E,{src:`${r.apiConfig.baseURL}${t}`,fit:"cover",class:"record-image",style:(0,s.Tr)({margin:a>0?"2px 0 0 0":"0"})},{error:(0,o.k6)((()=>[(0,o.Lk)("div",he,[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(P)])),_:1})])])),_:2},1032,["src","style"])],8,ge)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,o.uX)(),(0,o.CE)("div",ve,(0,s.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",ke,"无照片"))])),_:1}),(0,o.bF)(W,{label:"现场照片（清理后）",width:"120"},{default:(0,o.k6)((e=>[e.row.photo_path_after?((0,o.uX)(),(0,o.CE)("div",be,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,o.bF)(E,{src:`${r.apiConfig.baseURL}${t}`,fit:"cover",class:"record-image",style:(0,s.Tr)({margin:a>0?"2px 0 0 0":"0"})},{error:(0,o.k6)((()=>[(0,o.Lk)("div",ye,[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(P)])),_:1})])])),_:2},1032,["src","style"])],8,we)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,o.uX)(),(0,o.CE)("div",_e,(0,s.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",Fe,"无照片"))])),_:1}),(0,o.bF)(W,{label:"操作",width:"180"},{default:(0,o.k6)((e=>[r.canEdit(e.row)?((0,o.uX)(),(0,o.Wv)(f,{key:0,type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,o.k6)((()=>t[20]||(t[20]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0),r.canEdit(e.row)?((0,o.uX)(),(0,o.Wv)(f,{key:1,type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,o.k6)((()=>t[21]||(t[21]=[(0,o.eW)(" 删除 ")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0)])),_:1})])),_:1},8,["data"])),[[X,r.loading]]),0!==r.records.length||r.loading?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("div",Ie,[(0,o.bF)(U,{description:"暂无废物记录"})]))])),_:1})])]),t[22]||(t[22]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,o.uX)(),(0,o.Wv)(A,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])}var Ce=a(8828),Re=a(2933);const Ve=(e,t,a)=>{if(!e||0===e.length)return;const l=t||"导出数据",o=`${l}_${(new Date).toISOString().slice(0,10)}.csv`;let r="\ufeff";const n=a.map((e=>e.title)).join(",");r+=n+"\n",e.forEach((e=>{const t=a.map((t=>{let a=e[t.field];return null===a||void 0===a?"":"number"===t.type?a:(a=String(a),a.includes(",")||a.includes('"')||a.includes("\n")?`"${a.replace(/"/g,'""')}"`:a)})).join(",");r+=t+"\n"}));const i=new Blob([r],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),u=URL.createObjectURL(i);s.setAttribute("href",u),s.setAttribute("download",o),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(u)},We=e=>{try{return JSON.parse(e)}catch(t){return console.error("解析照片路径失败:",t),[]}};var Pe={name:"RecordsList",components:{ArrowLeft:G.nkM,Home:G.Home,Refresh:G.C42,PictureFailed:G.PictureFailed,Plus:G.FWt,User:G.KJW,ArrowDown:G.yd$,ArrowUp:G.DoI,Download:G.f5X,ElImageViewer:Ce.Tg},props:{unitId:{type:[String,Number],required:!0}},setup(e){const t=(0,i.rd)(),a=(0,h.KR)([]),l=(0,h.KR)(!1),r=(0,h.KR)(""),n=(0,h.KR)([]),s=(0,h.KR)(!0),u=(0,h.Kh)({dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:""}),d=(0,o.EW)((()=>a.value.filter((e=>{if(u.wasteTypeId&&e.waste_type_id!==u.wasteTypeId)return!1;if(null!==u.minQuantity&&parseFloat(e.quantity)<u.minQuantity)return!1;if(null!==u.maxQuantity&&parseFloat(e.quantity)>u.maxQuantity)return!1;if(u.location&&!e.location.toLowerCase().includes(u.location.toLowerCase()))return!1;if(u.dateRange&&2===u.dateRange.length){const t=new Date(u.dateRange[0]),a=new Date(u.dateRange[1]);if(a.setHours(23,59,59,999),!e.collection_start_time)return!1;{const l=c(e.collection_start_time);if(l<t||l>a)return!1}}return!0})))),c=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)},p=(0,o.EW)((()=>V.state.isLoggedIn&&3===V.state.user.role_id)),m=(0,o.EW)((()=>V.state.isLoggedIn&&2===V.state.user.role_id)),f=(0,h.KR)(!1),v=(0,h.KR)([]),k=(0,h.KR)(0),w=(e,t)=>{v.value=e.map((e=>`${b.baseURL}${e}`)),k.value=t,f.value=!0},y=()=>{f.value=!1};(0,o.sV)((async()=>{await I(),await F(),await L()}));const F=async()=>{try{const e=await _.get(b.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型列表失败")}},I=async()=>{try{const t=await _.get(b.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.unitId)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},L=async()=>{l.value=!0;try{const e=await _.get(`${b.endpoints.wasteRecords}/user/${V.state.user.id}`);a.value=e.data,a.value.forEach((e=>{e.created_at=C(e.created_at),e.collection_start_time=C(e.collection_start_time)}))}catch(e){console.error("获取废物记录失败:",e),g.nk.error("获取废物记录失败")}finally{l.value=!1}},C=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})},R=()=>{L()},W=()=>{t.push({name:"WasteForm",params:{id:e.unitId}})},P=()=>{p.value&&t.push("/")},E=()=>{t.push("/user-management")},T=()=>{t.push("/record/new")},U=e=>{t.push(`/record/${e}`)},A=e=>!!V.state.isLoggedIn&&(3===V.state.user.role_id||(2===V.state.user.role_id&&V.state.user.unit_id===e.unit_id||V.state.user.unit_id===e.unit_id&&(null===e.creator_id||e.creator_id===V.state.user.id))),X=()=>{g.nk.success("筛选已应用")},$=()=>{u.dateRange=null,u.wasteTypeId=null,u.minQuantity=null,u.maxQuantity=null,u.location="",g.nk.info("筛选条件已重置")},K=()=>{if(0===d.value.length)return void g.nk.warning("没有可导出的记录");const e=[{title:"单位",field:"unit_name",width:15},{title:"废物类型",field:"waste_type_name",width:15},{title:"产生地点",field:"location",width:20},{title:"收集开始时间",field:"collection_start_time",width:20,type:"datetime"},{title:"数量(吨)",field:"quantity",width:12,type:"number"},{title:"记录时间",field:"created_at",width:20,type:"datetime"}];let t=`${r.value}_废物记录`;if(u.wasteTypeId){const e=n.value.find((e=>e.id===u.wasteTypeId));e&&(t+=`_${e.name}`)}Ve(d.value,t,e),g.nk.success("导出成功")},q=e=>{Re.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await _.delete(`${b.endpoints.wasteRecords}/${e.id}`),g.nk.success("删除成功"),await L()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败")}})).catch((()=>{g.nk.info("已取消删除")}))};return{records:a,filteredRecords:d,loading:l,unitName:r,wasteTypes:n,isAdmin:p,isUnitAdmin:m,parsePhotoPath:We,refreshRecords:R,goBack:W,goHome:P,goToUserManagement:E,addNewRecord:T,editRecord:U,canEdit:A,confirmDelete:q,apiConfig:b,showFilterPanel:s,filterForm:u,applyFilter:X,resetFilter:$,exportRecords:K,showViewer:f,previewImages:v,previewIndex:k,previewPhoto:w,closeViewer:y}}};const Ee=(0,P.A)(Pe,[["render",Le],["__scopeId","data-v-77879442"]]);var Te=Ee;const Ue={class:"login-container"},Ae={class:"login-card"},Xe={key:0,class:"login-error"};function $e(e,t,a,r,n,i){const u=(0,o.g2)("el-input"),d=(0,o.g2)("el-form-item"),c=(0,o.g2)("el-radio"),p=(0,o.g2)("el-radio-group"),m=(0,o.g2)("el-button"),f=(0,o.g2)("el-form");return(0,o.uX)(),(0,o.CE)("div",Ue,[(0,o.Lk)("div",Ae,[t[7]||(t[7]=(0,o.Lk)("div",{class:"login-header"},[(0,o.Lk)("h1",null,"危险废物管理系统"),(0,o.Lk)("h2",null,"用户登录")],-1)),(0,o.bF)(f,{ref:"loginForm",model:r.form,rules:r.rules,"label-width":"80px",class:"login-form",onSubmit:(0,l.D$)(r.submitForm,["prevent"])},{default:(0,o.k6)((()=>[(0,o.bF)(d,{label:"手机号",prop:"phone"},{default:(0,o.k6)((()=>[(0,o.bF)(u,{modelValue:r.form.phone,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),r.showPassword?((0,o.uX)(),(0,o.Wv)(d,{key:0,label:"密码",prop:"password"},{default:(0,o.k6)((()=>[(0,o.bF)(u,{modelValue:r.form.password,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1})):(0,o.Q3)("",!0),(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(p,{modelValue:r.form.userType,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.userType=e),onChange:r.handleUserTypeChange},{default:(0,o.k6)((()=>[(0,o.bF)(c,{label:1},{default:(0,o.k6)((()=>t[3]||(t[3]=[(0,o.eW)("员工")]))),_:1}),(0,o.bF)(c,{label:2},{default:(0,o.k6)((()=>t[4]||(t[4]=[(0,o.eW)("单位管理员")]))),_:1}),(0,o.bF)(c,{label:3},{default:(0,o.k6)((()=>t[5]||(t[5]=[(0,o.eW)("超级管理员")]))),_:1})])),_:1},8,["modelValue","onChange"])])),_:1}),(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(m,{type:"primary","native-type":"submit",onClick:r.submitForm,loading:r.auth.state.loading,style:{width:"100%"}},{default:(0,o.k6)((()=>t[6]||(t[6]=[(0,o.eW)(" 登录 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules","onSubmit"]),r.auth.state.error?((0,o.uX)(),(0,o.CE)("div",Xe,(0,s.v_)(r.auth.state.error),1)):(0,o.Q3)("",!0)])])}var Ke={name:"LoginView",setup(){const e=(0,i.rd)(),t=(0,h.KR)(null),a=(0,h.Kh)({phone:"",password:"",userType:1}),l=(0,o.EW)((()=>1!==a.userType)),r=(0,o.EW)((()=>{const e=[{required:!0,message:"请输入手机号",trigger:"submit"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"submit"}],t=l.value?[{required:!0,message:"请输入密码",trigger:"submit"}]:[];return{phone:e,password:t}})),n=()=>{1===a.userType&&(a.password=""),t.value&&t.value.clearValidate()},s=async()=>{console.log("提交表单被触发"),t.value?V.state.loading?console.log("登录正在进行中，跳过"):1===a.userType?(console.log("员工登录模式"),t.value.validate((async e=>{e?(console.log("员工登录表单验证通过"),await u()):console.log("员工表单验证失败")}))):(console.log("管理员登录模式"),t.value.validate((async e=>{e?(console.log("管理员表单验证通过"),await u()):console.log("表单验证失败")}))):console.log("表单引用不存在")},u=async()=>{console.log("开始登录，账号:",a.phone,"用户类型:",a.userType);try{let t;if(console.log("开始处理登录操作..."),1===a.userType?(console.log("员工登录，不发送密码"),t=await V.login(a.phone,null)):(console.log("管理员登录，发送密码"),t=await V.login(a.phone,a.password)),console.log("登录响应:",t),t.success){const a=t.user;g.nk.success(`欢迎，${a.username||a.phone}`),3===a.role_id?e.push("/admin-records"):2===a.role_id?e.push(`/records/${a.unit_id}`):e.push(`/unit/${a.unit_id}`)}else g.nk.error(t.error||"登录失败"),console.error("登录失败:",t.error)}catch(t){g.nk.error("登录失败，请检查网络连接"),console.error("登录错误:",t)}};return(0,o.sV)((()=>{if(V.state.isLoggedIn){const t=V.state.user;3===t.role_id?e.push("/admin-records"):2===t.role_id?e.push(`/records/${t.unit_id}`):e.push(`/unit/${t.unit_id}`)}})),{form:a,rules:r,loginForm:t,showPassword:l,handleUserTypeChange:n,submitForm:s,auth:V}}};const qe=(0,P.A)(Ke,[["render",$e],["__scopeId","data-v-552266be"]]);var xe=qe;const De={class:"edit-record-container"},Be={class:"header"},Qe={class:"content"},Se={class:"form-header"};function Me(e,t,a,l,r,n){const i=(0,o.g2)("arrow-left"),u=(0,o.g2)("el-icon"),d=(0,o.g2)("el-option"),c=(0,o.g2)("el-select"),p=(0,o.g2)("el-form-item"),m=(0,o.g2)("el-input"),f=(0,o.g2)("el-date-picker"),g=(0,o.g2)("clock"),h=(0,o.g2)("el-time-picker"),v=(0,o.g2)("el-input-number"),k=(0,o.g2)("plus"),b=(0,o.g2)("el-upload"),w=(0,o.g2)("el-image-viewer"),y=(0,o.g2)("el-button"),_=(0,o.g2)("el-form"),F=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",De,[(0,o.Lk)("div",Be,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(i)])),_:1}),t[7]||(t[7]=(0,o.eW)(" 返回 "))]),(0,o.Lk)("h1",null,(0,s.v_)(l.isNew?"新增废物记录":"编辑废物记录"),1),t[8]||(t[8]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",Qe,[(0,o.Lk)("div",Se,[(0,o.Lk)("h2",null,(0,s.v_)(l.unitName),1)]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(_,{ref:"recordForm",model:l.form,rules:l.rules,"label-width":"120px",class:"record-form"},{default:(0,o.k6)((()=>[l.isSuperAdmin&&l.isNew?((0,o.uX)(),(0,o.Wv)(p,{key:0,label:"单位",prop:"unitId"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>l.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.units,(e=>((0,o.uX)(),(0,o.Wv)(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(0,o.Q3)("",!0),(0,o.bF)(p,{label:"废物类型",prop:"wasteTypeId"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"产生地点",prop:"location"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{modelValue:l.form.location,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.location=e),placeholder:"请输入废物产生地点"},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集日期"},{default:(0,o.k6)((()=>[(0,o.bF)(f,{modelValue:l.form.collectionDate,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(h,{modelValue:l.form.collectionTime,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(g)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集数量(吨)",prop:"quantity"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:l.form.quantity,"onUpdate:modelValue":t[6]||(t[6]=e=>l.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"现场照片（收集前）",prop:"photosBefore"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoBeforeChange,"on-remove":l.handlePhotoBeforeRemove,"file-list":l.photoBeforeList,limit:10,multiple:"","list-type":"picture-card","on-preview":l.handlePictureCardPreview,"before-upload":l.handleBeforeUpload},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),t[9]||(t[9]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多10张）",-1))])),_:1}),(0,o.bF)(p,{label:"现场照片（收集后）",prop:"photosAfter"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoAfterChange,"on-remove":l.handlePhotoAfterRemove,"file-list":l.photoAfterList,limit:10,multiple:"","list-type":"picture-card","on-preview":l.handlePictureCardPreview,"before-upload":l.handleBeforeUpload},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),t[10]||(t[10]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多10张）",-1)),l.showViewer?((0,o.uX)(),(0,o.Wv)(w,{key:0,"url-list":l.previewImages,"initial-index":l.previewIndex,onClose:l.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])),_:1}),(0,o.bF)(p,null,{default:(0,o.k6)((()=>[(0,o.bF)(y,{type:"primary",onClick:l.submitForm,loading:l.loading},{default:(0,o.k6)((()=>t[11]||(t[11]=[(0,o.eW)("保存")]))),_:1},8,["onClick","loading"]),(0,o.bF)(y,{onClick:l.goBack},{default:(0,o.k6)((()=>t[12]||(t[12]=[(0,o.eW)("取消")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"])),[[F,l.loading]])]),t[13]||(t[13]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var Ye={name:"EditRecordView",components:{ArrowLeft:G.nkM,Plus:G.FWt,Clock:G.zD7,ElImageViewer:Ce.Tg},setup(){const e=(0,i.rd)(),t=(0,i.lq)(),a=(0,h.KR)(null),l=(0,h.KR)(!1),r=(0,h.KR)(!1),n=(0,h.KR)(""),s=(0,h.KR)([]),u=(0,h.KR)([]),d=(0,h.KR)([]),c=(0,h.KR)([]),p=(0,h.KR)([]),m=(0,h.KR)([]),f=(0,h.KR)([]),v=(0,h.KR)([]),k=(0,h.KR)([]),w=(0,h.KR)(!1),y=(0,h.KR)(0),F=(0,h.KR)(""),I=(0,o.EW)((()=>!t.params.id)),L=(0,o.EW)((()=>V.state.isLoggedIn&&3===V.state.user.role_id)),C=(0,h.Kh)({unitId:"",wasteTypeId:"",location:"",collectionDate:"",collectionTime:"",quantity:0,recordId:null,creatorId:V.state.user?.id||null}),R={unitId:[{required:!0,message:"请选择单位",trigger:"change"}],wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],location:[{required:!0,message:"请输入废物产生地点",trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,o.sV)((async()=>{l.value=!0;try{await E(),L.value&&await W(),I.value?!L.value&&V.state.user&&(C.unitId=V.state.user.unit_id,await P(C.unitId)):await T()}catch(e){console.error("初始化数据失败:",e),g.nk.error("加载数据失败，请刷新重试")}finally{l.value=!1}}));const W=async()=>{try{const e=await _.get(b.endpoints.units);u.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},P=async e=>{try{const t=await _.get(b.endpoints.units),a=t.data.find((t=>t.id===parseInt(e)));a&&(n.value=a.name)}catch(t){console.error("获取单位信息失败:",t)}},E=async()=>{try{const e=await _.get(b.endpoints.wasteTypes);s.value=e.data}catch(e){console.error("获取废物类型失败:",e),g.nk.error("获取废物类型失败")}},T=async()=>{try{l.value=!0;const a=await _.get(`${b.endpoints.wasteRecords}/detail/${t.params.id}`),o=a.data;if(console.log("获取到的记录详情:",o),C.unitId=o.unit_id,C.wasteTypeId=o.waste_type_id,C.location=o.location,C.recordId=o.id,o.collection_start_time){const e=new Date(o.collection_start_time);C.collectionDate=e.toISOString().slice(0,10),C.collectionTime=e.toTimeString().slice(0,5)}C.quantity=o.quantity;try{let e=[];o.photo_path_before&&(e=JSON.parse(o.photo_path_before),console.log("解析的收集前照片路径:",e));let t=[];o.photo_path_after&&(t=JSON.parse(o.photo_path_after),console.log("解析的收集后照片路径:",t)),f.value=e,v.value=t,d.value=e.map(((e,t)=>{const a=`${b.baseURL}${e}`;return console.log(`收集前照片${t+1}的URL:`,a),{name:`收集前照片${t+1}`,url:a,uid:`before-${t}`,status:"success"}})),c.value=t.map(((e,t)=>{const a=`${b.baseURL}${e}`;return console.log(`收集后照片${t+1}的URL:`,a),{name:`收集后照片${t+1}`,url:a,uid:`after-${t}`,status:"success"}})),q([...d.value,...c.value])}catch(e){console.error("解析照片路径失败:",e),k.value=[],f.value=[],v.value=[],d.value=[],c.value=[]}n.value=o.unit_name,F.value=o.created_at}catch(e){console.error("获取记录详情失败:",e),g.nk.error("获取记录详情失败")}finally{l.value=!1}},U=e=>(e.uid||(e.uid=Date.now()+"-"+Math.random().toString(36).substr(2,10)),!0),A=(e,t)=>{if(console.log("收集前照片变更:",e,t),d.value=t,p.value=t.filter((e=>e.raw)).map((e=>e.raw)),!I.value){const e=t.filter((e=>e.uid&&"string"===typeof e.uid&&e.uid.startsWith("before-"))).map((e=>e.uid));f.value=f.value.filter(((t,a)=>e.includes(`before-${a}`)))}return q([...d.value,...c.value]),!1},X=(e,t)=>{if(console.log("收集前照片移除:",e,t),d.value=t,e.uid&&"string"===typeof e.uid&&e.uid.startsWith("before-")){const t=parseInt(e.uid.replace("before-",""));f.value=f.value.filter(((e,a)=>a!==t))}p.value=t.filter((e=>e.raw)).map((e=>e.raw)),q([...d.value,...c.value])},$=(e,t)=>{if(console.log("收集后照片变更:",e,t),c.value=t,m.value=t.filter((e=>e.raw)).map((e=>e.raw)),!I.value){const e=t.filter((e=>e.uid&&"string"===typeof e.uid&&e.uid.startsWith("after-"))).map((e=>e.uid));v.value=v.value.filter(((t,a)=>e.includes(`after-${a}`)))}return q([...d.value,...c.value]),!1},K=(e,t)=>{if(console.log("收集后照片移除:",e,t),c.value=t,e.uid&&"string"===typeof e.uid&&e.uid.startsWith("after-")){const t=parseInt(e.uid.replace("after-",""));v.value=v.value.filter(((e,a)=>a!==t))}m.value=t.filter((e=>e.raw)).map((e=>e.raw)),q([...d.value,...c.value])},q=e=>{k.value=e.map((e=>e.url?e.url:e.raw?URL.createObjectURL(e.raw):e instanceof File?URL.createObjectURL(e):"")).filter((e=>e)),console.log("预览图片列表:",k.value)},x=e=>{const t=k.value.findIndex((t=>t===e.url||e.raw&&t===URL.createObjectURL(e.raw)));y.value=-1!==t?t:0,w.value=!0},D=()=>{w.value=!1},B=async()=>{a.value.validate((async e=>{if(!e)return console.log("表单验证失败"),g.nk.error("请填写必填字段"),!1;try{l.value=!0;const e=new FormData;if(e.append("unitId",C.unitId),e.append("wasteTypeId",C.wasteTypeId),e.append("location",C.location),e.append("quantity",C.quantity),C.collectionDate&&C.collectionTime){const t=`${C.collectionDate} ${C.collectionTime}:00`;e.append("collectionStartTime",t)}let t;p.value&&p.value.length>0&&p.value.forEach((t=>{t&&e.append("photosBefore",t)})),m.value&&m.value.length>0&&m.value.forEach((t=>{t&&e.append("photosAfter",t)})),!I.value&&f.value.length>0&&e.append("existingPhotosPathsBefore",JSON.stringify(f.value)),!I.value&&v.value.length>0&&e.append("existingPhotosPathsAfter",JSON.stringify(v.value)),I.value?(t=await _.postForm(b.endpoints.wasteRecords,e),g.nk.success("废物记录添加成功")):(t=await _.putForm(`${b.endpoints.wasteRecords}/${C.recordId}`,e),g.nk.success("废物记录更新成功")),console.log("提交响应:",t.data),Q()}catch(t){console.error("提交表单失败:",t),g.nk.error("提交表单失败")}finally{l.value=!1}}))},Q=()=>{L.value?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:V.state.user.unit_id}})};return{form:C,rules:R,recordForm:a,loading:l,submitting:r,unitName:n,wasteTypes:s,units:u,photoBeforeList:d,photoAfterList:c,previewImages:k,showViewer:w,previewIndex:y,isNew:I,isSuperAdmin:L,handlePhotoBeforeChange:A,handlePhotoBeforeRemove:X,handlePhotoAfterChange:$,handlePhotoAfterRemove:K,handlePictureCardPreview:x,handleBeforeUpload:U,closeViewer:D,submitForm:B,goBack:Q}}};const Ne=(0,P.A)(Ye,[["render",Me],["__scopeId","data-v-3be1fd12"]]);var Oe=Ne;const He={class:"user-management-container"},je={class:"header"},ze={class:"content"},Je={class:"toolbar"},Ge={key:0,class:"password-hint"},Ze={key:1,class:"password-hint"},et={class:"dialog-footer"};function tt(e,t,a,l,r,n){const i=(0,o.g2)("arrow-left"),s=(0,o.g2)("el-icon"),u=(0,o.g2)("plus"),d=(0,o.g2)("el-button"),c=(0,o.g2)("el-table-column"),p=(0,o.g2)("el-popconfirm"),m=(0,o.g2)("el-table"),f=(0,o.g2)("el-input"),g=(0,o.g2)("el-form-item"),h=(0,o.g2)("el-option"),v=(0,o.g2)("el-select"),k=(0,o.g2)("el-form"),b=(0,o.g2)("el-dialog"),w=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",He,[(0,o.Lk)("div",je,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(s,null,{default:(0,o.k6)((()=>[(0,o.bF)(i)])),_:1}),t[8]||(t[8]=(0,o.eW)(" 返回 "))]),t[9]||(t[9]=(0,o.Lk)("h1",null,"人员管理",-1)),t[10]||(t[10]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",ze,[(0,o.Lk)("div",Je,[(0,o.bF)(d,{type:"primary",onClick:l.openAddDialog},{default:(0,o.k6)((()=>[(0,o.bF)(s,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1}),t[11]||(t[11]=(0,o.eW)(" 添加用户 "))])),_:1},8,["onClick"])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(m,{data:l.users,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,o.k6)((()=>[(0,o.bF)(c,{prop:"id",label:"ID",width:"60"}),(0,o.bF)(c,{prop:"username",label:"姓名",width:"120"}),(0,o.bF)(c,{prop:"phone",label:"手机号",width:"140"}),(0,o.bF)(c,{prop:"role_name",label:"角色",width:"120"}),(0,o.bF)(c,{prop:"unit_name",label:"单位","min-width":"120"}),(0,o.bF)(c,{label:"操作",width:"180",fixed:"right"},{default:(0,o.k6)((e=>[(0,o.bF)(d,{size:"small",onClick:t=>l.handleEdit(e.row)},{default:(0,o.k6)((()=>t[12]||(t[12]=[(0,o.eW)("编辑")]))),_:2},1032,["onClick"]),(0,o.bF)(p,{title:"确定要删除此用户吗？",onConfirm:t=>l.handleDelete(e.row)},{reference:(0,o.k6)((()=>[(0,o.bF)(d,{size:"small",type:"danger"},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"])),[[w,l.loading]])]),(0,o.bF)(b,{modelValue:l.dialogVisible,"onUpdate:modelValue":t[7]||(t[7]=e=>l.dialogVisible=e),title:l.isEdit?"编辑用户":"添加用户",width:"500px"},{footer:(0,o.k6)((()=>[(0,o.Lk)("span",et,[(0,o.bF)(d,{onClick:t[6]||(t[6]=e=>l.dialogVisible=!1)},{default:(0,o.k6)((()=>t[14]||(t[14]=[(0,o.eW)("取消")]))),_:1}),(0,o.bF)(d,{type:"primary",onClick:l.submitForm,loading:l.formLoading},{default:(0,o.k6)((()=>t[15]||(t[15]=[(0,o.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,o.k6)((()=>[(0,o.bF)(k,{ref:"userForm",model:l.form,rules:l.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,o.k6)((()=>[(0,o.bF)(g,{label:"姓名",prop:"username"},{default:(0,o.k6)((()=>[(0,o.bF)(f,{modelValue:l.form.username,"onUpdate:modelValue":t[1]||(t[1]=e=>l.form.username=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),(0,o.bF)(g,{label:"手机号",prop:"phone"},{default:(0,o.k6)((()=>[(0,o.bF)(f,{modelValue:l.form.phone,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,o.bF)(g,{label:"角色",prop:"roleId"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:l.form.roleId,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.roleId=e),placeholder:"请选择角色",style:{width:"100%"}},{default:(0,o.k6)((()=>[l.isSuperAdmin?((0,o.uX)(),(0,o.Wv)(h,{key:0,value:3,label:"超级管理员"})):(0,o.Q3)("",!0),(0,o.bF)(h,{value:2,label:"单位管理员"}),(0,o.bF)(h,{value:1,label:"基层员工"})])),_:1},8,["modelValue"])])),_:1}),3!==l.form.roleId?((0,o.uX)(),(0,o.Wv)(g,{key:0,label:"单位",prop:"unitId"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:l.form.unitId,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"},disabled:!l.isSuperAdmin&&l.isEdit},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.units,(e=>((0,o.uX)(),(0,o.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})):(0,o.Q3)("",!0),2===l.form.roleId||3===l.form.roleId?((0,o.uX)(),(0,o.Wv)(g,{key:1,label:"密码",prop:"password"},{default:(0,o.k6)((()=>[(0,o.bF)(f,{modelValue:l.form.password,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.password=e),placeholder:"请输入密码",type:"password","show-password":""},null,8,["modelValue"]),l.isEdit?((0,o.uX)(),(0,o.CE)("div",Ze,"不修改密码请留空")):((0,o.uX)(),(0,o.CE)("div",Ge,"管理员账号必须设置密码"))])),_:1})):(0,o.Q3)("",!0)])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),t[16]||(t[16]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var at={name:"UserManagement",components:{ArrowLeft:G.nkM,Plus:G.FWt},setup(){const e=(0,i.rd)(),t=(0,h.KR)(!1),a=(0,h.KR)(!1),l=(0,h.KR)(!1),r=(0,h.KR)(!1),n=(0,h.KR)(null),s=(0,h.KR)([]),u=(0,h.KR)([]),d=(0,o.EW)((()=>V.state.isLoggedIn&&3===V.state.user.role_id)),c=(0,o.EW)((()=>V.state.isLoggedIn?V.state.user.unit_id:null)),p=(0,h.Kh)({id:null,username:"",phone:"",roleId:1,unitId:null,password:""}),m={username:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],unitId:[{required:!0,message:"请选择单位",trigger:"change"}],password:[{required:function(){return!r.value&&(2===p.roleId||3===p.roleId)},message:"请输入密码",trigger:"blur"},{min:1,max:20,message:"长度在 1 到 20 个字符",trigger:"blur"}]},f=async()=>{t.value=!0;try{let e;e=d.value?await _.get(b.endpoints.users):await _.get(`${b.endpoints.units}/${c.value}/users`),s.value=e.data}catch(e){console.error("Error fetching users:",e),g.nk.error("获取用户列表失败")}finally{t.value=!1}},v=async()=>{try{const e=await _.get(b.endpoints.units);u.value=e.data}catch(e){console.error("Error fetching units:",e),g.nk.error("获取单位列表失败")}},k=()=>{r.value=!1,F(),l.value=!0,d.value||(p.unitId=c.value)},w=e=>{r.value=!0,p.id=e.id,p.username=e.username,p.phone=e.phone,p.roleId=e.role_id,p.unitId=e.unit_id,p.password="",l.value=!0},y=async e=>{try{await _.delete(`${b.endpoints.users}/${e.id}`),g.nk.success("用户删除成功"),f()}catch(t){console.error("Error deleting user:",t);let e="删除用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}},F=()=>{n.value&&n.value.resetFields(),p.id=null,p.username="",p.phone="",p.roleId=1,p.unitId=null,p.password=""},I=()=>{n.value.validate((async e=>{if(e){a.value=!0;try{const e={username:p.username,phone:p.phone,roleId:p.roleId,unitId:3!==p.roleId?p.unitId:null};p.password&&(e.password=p.password),r.value?(await _.put(`${b.endpoints.users}/${p.id}`,e),g.nk.success("用户更新成功")):(await _.post(b.endpoints.users,e),g.nk.success("用户添加成功")),l.value=!1,f()}catch(t){console.error("Error submitting user form:",t);let e=r.value?"更新用户失败":"添加用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}finally{a.value=!1}}else g.nk.warning("请完成必填项")}))},L=()=>{e.back()};return(0,o.sV)((()=>{f(),v()})),{loading:t,formLoading:a,dialogVisible:l,isEdit:r,userForm:n,users:s,units:u,form:p,rules:m,isSuperAdmin:d,currentUnitId:c,openAddDialog:k,handleEdit:w,handleDelete:y,submitForm:I,goBack:L}}};const lt=(0,P.A)(at,[["render",tt],["__scopeId","data-v-3c215db0"]]);var ot=lt;const rt={class:"admin-records-container"},nt={class:"content"},it={class:"actions"},st={class:"filter-header"},ut={class:"filter-form-container"},dt={class:"quantity-range"},ct={class:"filter-actions"},pt={class:"records-wrapper"},mt={class:"card-header"},ft={class:"card-actions"},gt={key:0},ht=["onClick"],vt={class:"image-error"},kt={key:0,class:"photo-count"},bt={key:1},wt={key:0},yt=["onClick"],_t={class:"image-error"},Ft={key:0,class:"photo-count"},It={key:1},Lt={key:0,class:"empty-block"};function Ct(e,t,a,r,n,i){const u=(0,o.g2)("plus"),d=(0,o.g2)("el-icon"),c=(0,o.g2)("el-button"),p=(0,o.g2)("user"),m=(0,o.g2)("refresh"),f=(0,o.g2)("arrow-down"),g=(0,o.g2)("arrow-up"),h=(0,o.g2)("el-option"),v=(0,o.g2)("el-select"),k=(0,o.g2)("el-form-item"),b=(0,o.g2)("el-col"),w=(0,o.g2)("el-date-picker"),y=(0,o.g2)("el-row"),_=(0,o.g2)("el-input-number"),F=(0,o.g2)("el-input"),I=(0,o.g2)("el-form"),L=(0,o.g2)("el-card"),C=(0,o.g2)("download"),R=(0,o.g2)("el-table-column"),V=(0,o.g2)("picture-failed"),W=(0,o.g2)("el-image"),P=(0,o.g2)("el-table"),E=(0,o.g2)("el-empty"),T=(0,o.g2)("el-image-viewer"),U=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",rt,[t[18]||(t[18]=(0,o.Lk)("div",{class:"header"},[(0,o.Lk)("h1",null,"危险废物管理系统 - 全部记录")],-1)),(0,o.Lk)("div",nt,[(0,o.Lk)("div",it,[(0,o.bF)(c,{type:"primary",onClick:r.addNewRecord},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1}),t[7]||(t[7]=(0,o.eW)(" 新增填报 "))])),_:1},8,["onClick"]),(0,o.bF)(c,{type:"success",onClick:r.goToUserManagement},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1}),t[8]||(t[8]=(0,o.eW)(" 人员管理 "))])),_:1},8,["onClick"]),(0,o.bF)(c,{onClick:r.refreshRecords},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(m)])),_:1}),t[9]||(t[9]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,o.bF)(L,{class:"filter-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",st,[t[10]||(t[10]=(0,o.Lk)("h3",null,"筛选条件",-1)),(0,o.bF)(c,{type:"primary",link:"",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,o.k6)((()=>[(0,o.eW)((0,s.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,o.uX)(),(0,o.Wv)(d,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(g)])),_:1})):((0,o.uX)(),(0,o.Wv)(d,{key:0},{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1}))])),_:1})]),(0,o.bo)((0,o.Lk)("div",ut,[(0,o.bF)(I,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(b,{span:12},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"所属单位"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.unitId=e),placeholder:"选择单位",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.units,(e=>((0,o.uX)(),(0,o.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(b,{span:12},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(w,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.bF)(y,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(b,{span:8},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"废物类型"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(h,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(b,{span:8},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"数量范围(吨)"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",dt,[(0,o.bF)(_,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"47%"}},null,8,["modelValue"]),t[11]||(t[11]=(0,o.Lk)("span",{class:"range-separator"},"至",-1)),(0,o.bF)(_,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"47%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,o.bF)(b,{span:8},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"产生地点"},{default:(0,o.k6)((()=>[(0,o.bF)(F,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.Lk)("div",ct,[(0,o.bF)(c,{type:"primary",onClick:r.applyFilter},{default:(0,o.k6)((()=>t[12]||(t[12]=[(0,o.eW)("筛选")]))),_:1},8,["onClick"]),(0,o.bF)(c,{onClick:r.resetFilter},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[l.aG,r.showFilterPanel]])])),_:1}),(0,o.Lk)("div",pt,[(0,o.bF)(L,{class:"records-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",mt,[t[15]||(t[15]=(0,o.Lk)("h3",null,"所有废物记录",-1)),(0,o.Lk)("div",ft,[(0,o.bF)(c,{type:"warning",onClick:r.exportRecords},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(C)])),_:1}),t[14]||(t[14]=(0,o.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(P,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:""},{default:(0,o.k6)((()=>[(0,o.bF)(R,{prop:"unit_name",label:"单位",width:"100"}),(0,o.bF)(R,{prop:"waste_type_name",label:"废物类型",width:"100"}),(0,o.bF)(R,{prop:"location",label:"产生地点"}),(0,o.bF)(R,{prop:"collection_start_time",label:"收集开始时间",width:"160"}),(0,o.bF)(R,{prop:"quantity",label:"数量(kg)",width:"80"}),(0,o.bF)(R,{prop:"created_at",label:"记录时间",width:"160"}),(0,o.bF)(R,{label:"现场照片（清理前）",width:"120"},{default:(0,o.k6)((e=>[e.row.photo_path_before?((0,o.uX)(),(0,o.CE)("div",gt,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,o.bF)(W,{src:`${r.apiBaseURL}${t}`,fit:"cover",class:"record-image",style:(0,s.Tr)({margin:a>0?"2px 0 0 0":"0"})},{error:(0,o.k6)((()=>[(0,o.Lk)("div",vt,[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(V)])),_:1})])])),_:2},1032,["src","style"])],8,ht)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,o.uX)(),(0,o.CE)("div",kt,(0,s.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",bt,"无照片"))])),_:1}),(0,o.bF)(R,{label:"现场照片（清理后）",width:"120"},{default:(0,o.k6)((e=>[e.row.photo_path_after?((0,o.uX)(),(0,o.CE)("div",wt,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,o.bF)(W,{src:`${r.apiBaseURL}${t}`,fit:"cover",class:"record-image",style:(0,s.Tr)({margin:a>0?"2px 0 0 0":"0"})},{error:(0,o.k6)((()=>[(0,o.Lk)("div",_t,[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(V)])),_:1})])])),_:2},1032,["src","style"])],8,yt)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,o.uX)(),(0,o.CE)("div",Ft,(0,s.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",It,"无照片"))])),_:1}),(0,o.bF)(R,{label:"操作",width:"180"},{default:(0,o.k6)((e=>[(0,o.bF)(c,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,o.k6)((()=>t[16]||(t[16]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,o.bF)(c,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,o.k6)((()=>t[17]||(t[17]=[(0,o.eW)(" 删除 ")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[U,r.loading]]),0!==r.records.length||r.loading?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("div",Lt,[(0,o.bF)(E,{description:"暂无废物记录"})]))])),_:1})])]),t[19]||(t[19]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,o.uX)(),(0,o.Wv)(T,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])}const Rt=b.baseURL,Vt=e=>{try{return JSON.parse(e)}catch(t){return console.error("解析照片路径失败:",t),[]}};var Wt={name:"AdminRecordsView",components:{Plus:G.FWt,Refresh:G.C42,PictureFailed:G.PictureFailed,User:G.KJW,ArrowDown:G.yd$,ArrowUp:G.DoI,Download:G.f5X,ElImageViewer:Ce.Tg},setup(){const e=(0,i.rd)(),t=(0,h.KR)([]),a=(0,h.KR)(!1),l=(0,h.KR)([]),r=(0,h.KR)([]),n=(0,h.KR)(!0),s=(0,h.KR)(!1),u=(0,h.KR)([]),d=(0,h.KR)(0),c=(0,h.Kh)({unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:""}),p=(0,o.EW)((()=>t.value.filter((e=>{if(c.unitId&&e.unit_id!==c.unitId)return!1;if(c.wasteTypeId&&e.waste_type_id!==c.wasteTypeId)return!1;if(null!==c.minQuantity&&parseFloat(e.quantity)<c.minQuantity)return!1;if(null!==c.maxQuantity&&parseFloat(e.quantity)>c.maxQuantity)return!1;if(c.location&&!e.location.toLowerCase().includes(c.location.toLowerCase()))return!1;if(c.dateRange&&2===c.dateRange.length){const t=new Date(c.dateRange[0]),a=new Date(c.dateRange[1]);if(a.setHours(23,59,59,999),!e.collection_start_time)return!1;{const l=m(e.collection_start_time);if(l<t||l>a)return!1}}return!0})))),m=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)};(0,o.sV)((async()=>{if(!V.state.isLoggedIn||3!==V.state.user.role_id)return g.nk.error("权限不足"),void e.push("/login");await Promise.all([f(),k(),w()])}));const f=async()=>{try{const e=await v.A.get(b.getUrl(b.endpoints.units));l.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},k=async()=>{try{const e=await v.A.get(b.getUrl(b.endpoints.wasteTypes));r.value=e.data}catch(e){console.error("获取废物类型列表失败:",e),g.nk.error("获取废物类型列表失败")}},w=async()=>{a.value=!0;try{const e=await v.A.get(`${b.getUrl(b.endpoints.wasteRecords)}/user/${V.state.user.id}`);t.value=e.data,t.value.forEach((e=>{e.created_at=y(e.created_at),e.collection_start_time=y(e.collection_start_time)}))}catch(e){console.error("获取废物记录失败:",e),g.nk.error("获取废物记录失败")}finally{a.value=!1}},y=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})},_=()=>{w()},F=()=>{e.push("/record/new")},I=()=>{e.push("/user-management")},L=t=>{e.push(`/record/${t}`)},C=()=>{g.nk.success("筛选已应用")},R=()=>{c.unitId=null,c.dateRange=null,c.wasteTypeId=null,c.minQuantity=null,c.maxQuantity=null,c.location="",g.nk.info("筛选条件已重置")},W=()=>{if(0===p.value.length)return void g.nk.warning("没有可导出的记录");const e=[{title:"单位",field:"unit_name",width:15},{title:"废物类型",field:"waste_type_name",width:15},{title:"产生地点",field:"location",width:20},{title:"收集开始时间",field:"collection_start_time",width:20,type:"datetime"},{title:"数量(吨)",field:"quantity",width:12,type:"number"},{title:"记录时间",field:"created_at",width:20,type:"datetime"}];let t="全部废物记录";if(c.unitId){const e=l.value.find((e=>e.id===c.unitId));e&&(t=`${e.name}_废物记录`)}if(c.wasteTypeId){const e=r.value.find((e=>e.id===c.wasteTypeId));e&&(t+=`_${e.name}`)}Ve(p.value,t,e),g.nk.success("导出成功")},P=e=>{Re.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await v.A.delete(`${b.getUrl(b.endpoints.wasteRecords)}/${e.id}`),g.nk.success("删除成功"),await w()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败")}})).catch((()=>{g.nk.info("已取消删除")}))},E=(e,t)=>{u.value=e.map((e=>`${Rt}${e}`)),d.value=t,s.value=!0},T=()=>{s.value=!1};return{records:t,filteredRecords:p,loading:a,units:l,wasteTypes:r,showFilterPanel:n,filterForm:c,applyFilter:C,resetFilter:R,exportRecords:W,parsePhotoPath:Vt,refreshRecords:_,addNewRecord:F,goToUserManagement:I,editRecord:L,confirmDelete:P,showViewer:s,previewImages:u,previewIndex:d,previewPhoto:E,closeViewer:T,apiBaseURL:Rt}}};const Pt=(0,P.A)(Wt,[["render",Ct],["__scopeId","data-v-cb513036"]]);var Et=Pt;const Tt=[{path:"/login",name:"Login",component:xe,meta:{requiresAuth:!1}},{path:"/user-management",name:"UserManagement",component:ot,meta:{requiresAuth:!0,requiresManager:!0}},{path:"/",name:"UnitSelection",component:S,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/admin-records",name:"AdminRecords",component:Et,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/record/:id",name:"EditRecord",component:Oe,props:!0,meta:{requiresAuth:!0}},{path:"/unit/:id",name:"WasteForm",component:te,props:!0,meta:{requiresAuth:!0}},{path:"/records/:unitId",name:"RecordsList",component:Te,props:!0,meta:{requiresAuth:!0}}],Ut=(0,i.aE)({history:(0,i.LA)("/"),routes:Tt});Ut.beforeEach(((e,t,a)=>{const l=e.matched.some((e=>e.meta.requiresAuth)),o=e.matched.some((e=>e.meta.requiresSuperAdmin)),r=e.matched.some((e=>e.meta.requiresManager));if(!l||V.state.isLoggedIn)if(o&&V.state.isLoggedIn&&3!==V.state.user.role_id)a({name:"WasteForm",params:{id:V.state.user.unit_id}});else if(r&&V.state.isLoggedIn&&1===V.state.user.role_id)a({name:"WasteForm",params:{id:V.state.user.unit_id}});else{if("Login"!==e.name||!V.state.isLoggedIn)return"/"===e.path&&V.state.isLoggedIn?3===V.state.user.role_id?void a({name:"AdminRecords"}):2===V.state.user.role_id?void a({name:"RecordsList",params:{unitId:V.state.user.unit_id}}):void a({name:"WasteForm",params:{id:V.state.user.unit_id}}):void("WasteForm"===e.name&&V.state.isLoggedIn&&3!==V.state.user.role_id&&V.state.user.unit_id!==parseInt(e.params.id)?a({name:"WasteForm",params:{id:V.state.user.unit_id}}):a());3===V.state.user.role_id?a({name:"AdminRecords"}):2===V.state.user.role_id?a({name:"RecordsList",params:{unitId:V.state.user.unit_id}}):a({name:"WasteForm",params:{id:V.state.user.unit_id}})}else a({name:"Login"})}));var At=Ut,Xt=a(2536),$t=(a(4188),a(5186));const Kt=(0,l.Ef)(X);Kt.use(At),Kt.use(Xt.A,{locale:$t.A}),Kt.mount("#app")}},t={};function a(l){var o=t[l];if(void 0!==o)return o.exports;var r=t[l]={exports:{}};return e[l].call(r.exports,r,r.exports,a),r.exports}a.m=e,function(){var e=[];a.O=function(t,l,o,r){if(!l){var n=1/0;for(d=0;d<e.length;d++){l=e[d][0],o=e[d][1],r=e[d][2];for(var i=!0,s=0;s<l.length;s++)(!1&r||n>=r)&&Object.keys(a.O).every((function(e){return a.O[e](l[s])}))?l.splice(s--,1):(i=!1,r<n&&(n=r));if(i){e.splice(d--,1);var u=o();void 0!==u&&(t=u)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[l,o,r]}}(),function(){a.d=function(e,t){for(var l in t)a.o(t,l)&&!a.o(e,l)&&Object.defineProperty(e,l,{enumerable:!0,get:t[l]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};a.O.j=function(t){return 0===e[t]};var t=function(t,l){var o,r,n=l[0],i=l[1],s=l[2],u=0;if(n.some((function(t){return 0!==e[t]}))){for(o in i)a.o(i,o)&&(a.m[o]=i[o]);if(s)var d=s(a)}for(t&&t(l);u<n.length;u++)r=n[u],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return a.O(d)},l=self["webpackChunkhazardous_waste_management_frontend"]=self["webpackChunkhazardous_waste_management_frontend"]||[];l.forEach(t.bind(null,0)),l.push=t.bind(null,l.push.bind(l))}();var l=a.O(void 0,[504],(function(){return a(2246)}));l=a.O(l)})();
//# sourceMappingURL=app.c127fa00.js.map