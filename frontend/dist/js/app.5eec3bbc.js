(function(){"use strict";var e={187:function(e,t,a){var o=a(5130),l=a(6768);const r={id:"app"};function n(e,t,a,o,n,s){const i=(0,l.g2)("app-header"),d=(0,l.g2)("router-view");return(0,l.uX)(),(0,l.CE)("div",r,[o.showHeader?((0,l.uX)(),(0,l.Wv)(i,{key:0})):(0,l.Q3)("",!0),(0,l.bF)(d)])}var s=a(1387),i=a(4232);const d={class:"app-header"},u={key:0,class:"user-info"},c={class:"welcome-text"},p={key:0,class:"unit-tag"};function m(e,t,a,o,r,n){const s=(0,l.g2)("user"),m=(0,l.g2)("el-icon"),g=(0,l.g2)("el-button");return(0,l.uX)(),(0,l.CE)("div",d,[t[3]||(t[3]=(0,l.Lk)("div",{class:"logo"},[(0,l.Lk)("h1",null,"固体废物管理系统")],-1)),o.auth.state.isLoggedIn?((0,l.uX)(),(0,l.CE)("div",u,[(0,l.Lk)("span",c,[t[0]||(t[0]=(0,l.eW)(" 欢迎, ")),(0,l.Lk)("strong",null,(0,i.v_)(o.userName),1),o.auth.state.user.unit_name?((0,l.uX)(),(0,l.CE)("span",p,(0,i.v_)(o.auth.state.user.unit_name),1)):(0,l.Q3)("",!0)]),(0,l.bF)(g,{type:"text",class:"profile-button",onClick:o.goToProfile},{default:(0,l.k6)((()=>[(0,l.bF)(m,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[1]||(t[1]=(0,l.eW)(" 账号设置 "))])),_:1},8,["onClick"]),(0,l.bF)(g,{type:"text",class:"logout-button",onClick:o.handleLogout},{default:(0,l.k6)((()=>t[2]||(t[2]=[(0,l.eW)(" 退出登录 ")]))),_:1},8,["onClick"])])):(0,l.Q3)("",!0)])}var g=a(1219),f=a(144),h=a(4373);const v="";var w={baseURL:v,endpoints:{login:"/api/login",users:"/api/users",usersByUnit:"/api/users/unit",userStatus:"/api/users/:id/status",userProfile:"/api/users/:id/profile",units:"/api/units",wasteTypes:"/api/waste-types",wasteRecords:"/api/waste-records",wasteRecordsByUnit:"/api/waste-records",wasteRecordDetail:"/api/waste-records/detail",wasteRecordsByUser:"/api/waste-records/user",exportWasteRecords:"/api/waste-records/export/user",operationLogs:"/api/operation-logs",operationLogStats:"/api/operation-logs/stats",operationLogUserStats:"/api/operation-logs/user-stats",exportOperationLogs:"/api/operation-logs/export",userLogPermission:"/api/users/:id/log-permission"},getUrl(e){return`${this.baseURL}${e}`}};const k={class:"unit-selection-container"},b={class:"content"},y={class:"units-grid"},_={class:"unit-name"};function F(e,t,a,o,r,n){const s=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",k,[t[1]||(t[1]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"固体废物管理系统")],-1)),(0,l.Lk)("div",b,[t[0]||(t[0]=(0,l.Lk)("h2",null,"请选择您的单位",-1)),(0,l.Lk)("div",y,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(s,{key:e.id,class:"unit-card",shadow:"hover",onClick:t=>n.selectUnit(e)},{default:(0,l.k6)((()=>[(0,l.Lk)("div",_,(0,i.v_)(e.name),1)])),_:2},1032,["onClick"])))),128))])]),t[2]||(t[2]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var x={name:"UnitSelection",data(){return{units:[],loading:!1}},created(){this.fetchUnits()},methods:{async fetchUnits(){this.loading=!0;try{console.log("正在获取单位列表...");const e=await h.A.get(w.getUrl(w.endpoints.units));console.log("获取单位列表成功:",e.data),this.units=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}finally{this.loading=!1}},selectUnit(e){this.$router.push({name:"WasteForm",params:{id:e.id}})}}},I=a(1241);const L=(0,I.A)(x,[["render",F],["__scopeId","data-v-249742c5"]]);var C=L;const R={class:"waste-form-container"},$={class:"header"},W={key:1},V={class:"content"},T={class:"unit-info"},P={class:"form-row"},S={key:0,class:"upload-warning"},U={class:"form-actions"},E={class:"upload-progress"},K={class:"upload-status"};function D(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("document"),c=(0,l.g2)("el-option"),p=(0,l.g2)("el-select"),m=(0,l.g2)("el-form-item"),g=(0,l.g2)("el-input"),f=(0,l.g2)("el-date-picker"),h=(0,l.g2)("clock"),v=(0,l.g2)("el-time-picker"),w=(0,l.g2)("el-input-number"),k=(0,l.g2)("el-alert"),b=(0,l.g2)("plus"),y=(0,l.g2)("el-upload"),_=(0,l.g2)("el-button"),F=(0,l.g2)("el-form"),x=(0,l.g2)("el-progress"),I=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",R,[(0,l.Lk)("div",$,[o.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 返回 "))])):((0,l.uX)(),(0,l.CE)("div",W)),t[15]||(t[15]=(0,l.Lk)("h1",null,"固体废物填报",-1)),(0,l.Lk)("div",{class:"view-records",onClick:t[1]||(t[1]=(...e)=>o.viewRecords&&o.viewRecords(...e))},[t[14]||(t[14]=(0,l.eW)(" 查看记录 ")),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1})])]),(0,l.Lk)("div",V,[(0,l.Lk)("div",T,[(0,l.Lk)("h2",null,(0,i.v_)(o.unitName),1)]),(0,l.bF)(F,{ref:"wasteForm",model:o.form,rules:o.rules,"label-position":"top",class:"waste-form"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"产生工序",prop:"process"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.process,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.process=e),placeholder:"请选择产生工序",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.processOptions,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===o.form.process?((0,l.uX)(),(0,l.Wv)(g,{key:0,modelValue:o.customProcess,"onUpdate:modelValue":t[4]||(t[4]=e=>o.customProcess=e),placeholder:"请输入具体产生工序",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(m,{label:"产生地点",prop:"location"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:o.form.location,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.location=e),placeholder:"请选择废物产生地点",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.locationOptions,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===o.form.location?((0,l.uX)(),(0,l.Wv)(g,{key:0,modelValue:o.customLocation,"onUpdate:modelValue":t[6]||(t[6]=e=>o.customLocation=e),placeholder:"请输入具体产生地点",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(m,{label:"备注",prop:"remarks"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:o.form.remarks,"onUpdate:modelValue":t[7]||(t[7]=e=>o.form.remarks=e),type:"textarea",rows:1,placeholder:"请输入备注信息（选填）"},null,8,["modelValue"])])),_:1}),(0,l.Lk)("div",P,[(0,l.bF)(m,{label:"收集日期",class:"date-item"},{default:(0,l.k6)((()=>[(0,l.bF)(f,{modelValue:o.form.collectionDate,"onUpdate:modelValue":t[8]||(t[8]=e=>o.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,"popper-class":"date-picker-popup",teleported:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"收集时间",class:"time-item"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:o.form.collectionTime,"onUpdate:modelValue":t[9]||(t[9]=e=>o.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"},editable:!1,"popper-class":"time-picker-popup",teleported:!1},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1})])),_:1},8,["modelValue"])])),_:1})]),(0,l.bF)(m,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:o.form.quantity,"onUpdate:modelValue":t[10]||(t[10]=e=>o.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"},onFocus:t[11]||(t[11]=e=>o.selectAllText(e)),"input-props":{inputmode:"decimal",pattern:"[0-9]*[.,]?[0-9]*"},controls:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集前）",prop:"photo_before"},{default:(0,l.k6)((()=>[t[16]||(t[16]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),o.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",S,[(0,l.bF)(k,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoBeforeChange,"on-remove":o.handlePhotoBeforeRemove,"file-list":o.fileListBefore,limit:5,multiple:"","list-type":"picture-card","before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(b)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集后）",prop:"photo_after"},{default:(0,l.k6)((()=>[t[17]||(t[17]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoAfterChange,"on-remove":o.handlePhotoAfterRemove,"file-list":o.fileListAfter,limit:5,multiple:"","list-type":"picture-card","before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(b)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.Lk)("div",U,[(0,l.bF)(_,{type:"primary",class:"submit-btn",onClick:o.submitForm,loading:o.loading},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)("提交")]))),_:1},8,["onClick","loading"]),(0,l.bF)(_,{class:"reset-btn",onClick:o.resetForm},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model","rules"])]),(0,l.bF)(I,{modelValue:o.showUploadProgress,"onUpdate:modelValue":t[12]||(t[12]=e=>o.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",E,[t[20]||(t[20]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(x,{percentage:o.uploadPercentage,format:o.percentageFormat,status:100===o.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",K,(0,i.v_)(o.uploadStatus),1)])])),_:1},8,["modelValue"]),t[21]||(t[21]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var A=a(7477),Q=a(9372),X=a.n(Q),M={name:"WasteForm",components:{ArrowLeft:A.nkM,Document:A.yoT,Plus:A.FWt,Clock:A.zD7},props:{id:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),a=(0,f.KR)(null),o=(0,f.KR)(!1),r=(0,f.KR)(""),n=(0,f.KR)([]),i=(0,f.KR)([]),d=(0,f.KR)([]),u=(0,f.KR)([]),c=(0,f.KR)([]),p=(0,f.KR)(!1),m=(0,f.KR)(0),h=(0,f.KR)("准备上传..."),v=(0,f.KR)(!1),k=(0,f.KR)([]),b=(0,f.KR)(""),y=(0,f.KR)(""),_=["作业现场","清罐清理","报废清理","管线刺漏","历史遗留","日常维护","封井退出","其他"],F={"桓台":["金家接转站","金17-1注采站","金17-2注采站","金6金9项目组","金8注采站","其他"],"潍北":["潍北联合站","昌79注采站","昌3注采站","疃3注采站","昌15注采站","其他"],"高青":["高青联合站","樊107注采站","樊14注采站","高21注采站","高54注采站","其他"],"牛庄":["牛25集输站","牛25注采站","营13注采站","史112注采站","其他"],"金角":["长堤注采站","桩23注采站","其他"],"信远":["河125注采站","河122注采站","永551注采站","其他"],"滨博":["樊142注采站","樊142-2-12注采站","樊162注采站","樊页1井组","滨博接转站","其他"],"无棣":["车41注采站","车142注采站","车40注采站","车408注采站","车274注采站","车1接转站","东风港联合站","其他"],"河口":["沾14东注采站","沾14西注采站","渤南注采站","大北注采站","沾5注采站","太平接转站","沾5接转站","其他"],"胜兴":["博兴注采站","其他"],"其他":["其他"]},x=(0,l.EW)((()=>Ba.state.isLoggedIn&&(3===Ba.state.user.role_id||4===Ba.state.user.role_id))),I=(0,f.Kh)({wasteTypeId:"",location:"",collectionDate:(new Date).toISOString().slice(0,10),collectionTime:(new Date).toTimeString().slice(0,5),quantity:void 0,photo_before:[],photo_after:[],remarks:"",process:""}),L={wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],process:[{required:!0,message:"请选择产生工序",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||y.value.trim()?a():a(new Error("请输入具体产生工序"))},trigger:"blur"}],location:[{required:!0,message:"请选择废物产生地点",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||b.value.trim()?a():a(new Error("请输入具体产生地点"))},trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!1,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{const e=document.createElement("meta");e.setAttribute("name","viewport"),e.setAttribute("content","width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1"),document.head.appendChild(e);const t=document.querySelector('meta[name="viewport"]');t&&t!==e&&t.remove(),await C(),await R()})),(0,l.xo)((()=>{const e=document.querySelector('meta[name="viewport"]');e&&e.remove();const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width,initial-scale=1.0"),document.head.appendChild(t)}));const C=async()=>{try{const t=await Ta.get(w.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.id)));a&&(r.value=a.name,F[r.value]?k.value=F[r.value]:(k.value=[],console.warn(`未找到管理区 "${r.value}" 的地点选项`)))}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},R=async()=>{try{const e=await Ta.get(w.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型失败")}},$=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return g.nk.error("只能上传图片文件!"),!1;const o=52428800;return e.size>o?(g.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{p.value=!0,h.value="正在处理图片...",m.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(X())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,h.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,h.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),h.value="图片处理完成",m.value=100,setTimeout((()=>{p.value=!1}),500),t(l)},error(a){console.error("图片压缩失败:",a),h.value="处理失败，使用原始图片",m.value=100,setTimeout((()=>{p.value=!1}),500),t(e)}})}))},W=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),u.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){p.value=!0,h.value="正在处理图片...",m.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(X())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,h.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,h.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),h.value="图片处理完成",m.value=100,t(l)},error(a){console.error("图片压缩失败:",a),h.value="处理失败，使用原始图片",m.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=i.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?i.value[a]=t:i.value.push(t);const o=u.value.findIndex((t=>t.uid===e.uid));o>=0&&(u.value[o].processed=!0),setTimeout((()=>{p.value=!1}),500)}catch(o){console.error("处理图片时出错:",o),g.nk.warning("图片处理失败，将使用原始图片");const t=i.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?i.value[t]=e.raw:i.value.push(e.raw),p.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const a=[...i.value,...d.value];v.value=S(a),console.log("更新后的photoFilesBefore:",i.value),console.log("更新后的fileListBefore:",u.value)},V=(e,t)=>{console.log("收集前照片移除:",e),u.value=t,e.raw?i.value=i.value.filter((t=>t.name!==e.raw.name)):i.value=i.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),S([...i.value,...d.value])||(v.value=!1),console.log("更新后的photoFilesBefore:",i.value)},T=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],e.processed)return void console.log("文件已处理过，跳过压缩:",e.name);if(e.raw&&"ready"===e.status){p.value=!0,h.value="正在处理图片...",m.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(X())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){m.value=30,h.value="正在处理图片...",console.log("图片处理中...")},drew(){m.value=60,h.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),h.value="图片处理完成",m.value=100,t(l)},error(a){console.error("图片压缩失败:",a),h.value="处理失败，使用原始图片",m.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=d.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?d.value[a]=t:d.value.push(t);const o=c.value.findIndex((t=>t.uid===e.uid));o>=0&&(c.value[o].processed=!0),setTimeout((()=>{p.value=!1}),500)}catch(o){console.error("处理图片时出错:",o),g.nk.warning("图片处理失败，将使用原始图片");const t=d.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?d.value[t]=e.raw:d.value.push(e.raw),p.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);const a=[...i.value,...d.value];v.value=S(a),console.log("更新后的photoFilesAfter:",d.value),console.log("更新后的fileListAfter:",c.value)},P=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,e.raw?d.value=d.value.filter((t=>t.name!==e.raw.name)):d.value=d.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),S([...i.value,...d.value])||(v.value=!1),console.log("更新后的photoFilesAfter:",d.value)},S=e=>{const t=5242880;return e.some((e=>e.size>t))},U=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);m.value=t,h.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},E=e=>100===e?"完成":`${e}%`,K=()=>{a.value.validate((async a=>{if(a){o.value=!0;try{const a=new FormData;a.append("unitId",e.id),a.append("wasteTypeId",I.wasteTypeId),"其他"===I.process&&y.value.trim()?a.append("process",y.value.trim()):a.append("process",I.process),"其他"===I.location&&b.value.trim()?a.append("location",b.value.trim()):a.append("location",I.location),I.collectionDate&&I.collectionTime&&(a.append("collectionDate",I.collectionDate),a.append("collectionTime",I.collectionTime)),void 0!==I.quantity&&null!==I.quantity&&""!==I.quantity&&a.append("quantity",I.quantity),a.append("remarks",I.remarks||""),Ba.state.isLoggedIn&&Ba.state.user?(a.append("creator_id",Ba.state.user.id),console.log("添加用户信息:",{creator_id:Ba.state.user.id,user:Ba.state.user})):console.log("用户未登录或用户信息不完整"),console.log("提交表单数据:",{unitId:e.id,wasteTypeId:I.wasteTypeId,process:"其他"===I.process?y.value:I.process,location:"其他"===I.location?b.value:I.location,quantity:I.quantity,remarks:I.remarks||"",photo_before:i.value?i.value.length:0,photo_after:d.value?d.value.length:0}),i.value&&i.value.length>0&&(console.log("添加收集前照片数量:",i.value.length),i.value.forEach(((e,t)=>{e&&(console.log(`收集前照片 ${t+1}:`,e.name),a.append("photo_before",e))}))),d.value&&d.value.length>0&&(console.log("添加收集后照片数量:",d.value.length),d.value.forEach(((e,t)=>{e&&(console.log(`收集后照片 ${t+1}:`,e.name),a.append("photo_after",e))})));const o=[...i.value||[],...d.value||[]];v.value=S(o),o.length>0&&(p.value=!0,m.value=0,h.value="准备上传...");const l=await Ta.postForm(w.endpoints.wasteRecords,a,U);console.log("提交响应:",l.data),g.nk.success("废物记录提交成功！正在跳转到记录列表..."),D(),setTimeout((()=>{if(Ba.state.isLoggedIn&&Ba.state.user){const a=Ba.state.user.role_id;3===a||4===a?t.push("/admin-records"):t.push({name:"RecordsList",params:{unitId:e.id}})}else t.push({name:"RecordsList",params:{unitId:e.id}})}),1500)}catch(l){console.error("Error submitting form:",l),l.response&&(console.error("错误响应数据:",l.response.data),console.error("错误状态码:",l.response.status)),g.nk.error("提交失败，请稍后再试")}finally{o.value=!1,p.value=!1}}else g.nk.warning("请完成必填项")}))},D=()=>{a.value&&a.value.resetFields(),I.wasteTypeId="",I.location="",I.process="",I.remarks="",I.quantity=void 0,I.collectionDate=(new Date).toISOString().slice(0,10),I.collectionTime=(new Date).toTimeString().slice(0,5),b.value="",y.value="",i.value=[],d.value=[],u.value=[],c.value=[],v.value=!1},A=()=>{x.value&&t.push("/")},Q=()=>{t.push({name:"RecordsList",params:{unitId:e.id}})},M=e=>{setTimeout((()=>{if(e&&e.target){const t=e.target.querySelector("input");t&&t.select()}}),10)};return{form:I,rules:L,wasteForm:a,loading:o,unitName:r,wasteTypes:n,isAdmin:x,fileListBefore:u,fileListAfter:c,handlePhotoBeforeChange:W,handlePhotoBeforeRemove:V,handlePhotoAfterChange:T,handlePhotoAfterRemove:P,handleBeforeUpload:$,submitForm:K,resetForm:D,goBack:A,viewRecords:Q,selectAllText:M,showUploadProgress:p,uploadPercentage:m,uploadStatus:h,percentageFormat:E,showLargeFileWarning:v,locationOptions:k,customLocation:b,customProcess:y,processOptions:_}}};const q=(0,I.A)(M,[["render",D],["__scopeId","data-v-1d04339a"]]);var B=q;const z={class:"records-container"},O={class:"header"},j={key:1},N={class:"content"},Y={class:"unit-info"},H={class:"actions"},J={class:"filter-header"},G={class:"filter-form-container"},Z={class:"quantity-range"},ee={class:"input-with-clear"},te={class:"input-with-clear"},ae={class:"filter-actions"},oe={class:"records-wrapper"},le={class:"card-header"},re={class:"card-actions"},ne={key:0,class:"photo-preview"},se=["onClick"],ie={key:0,class:"photo-count"},de={key:1},ue={key:0,class:"photo-preview"},ce=["onClick"],pe={key:0,class:"photo-count"},me={key:1},ge={class:"operation-buttons"},fe={key:0,class:"loading-row"},he={key:1,class:"load-more-row"},ve={key:2,class:"no-more-row"},we={key:0,class:"record-limit-tip"};function ke(e,t,a,r,n,s){const d=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),c=(0,l.g2)("home"),p=(0,l.g2)("plus"),m=(0,l.g2)("el-button"),g=(0,l.g2)("user"),f=(0,l.g2)("refresh"),h=(0,l.g2)("arrow-down"),v=(0,l.g2)("arrow-up"),w=(0,l.g2)("el-option"),k=(0,l.g2)("el-select"),b=(0,l.g2)("el-form-item"),y=(0,l.g2)("el-col"),_=(0,l.g2)("el-input"),F=(0,l.g2)("el-date-picker"),x=(0,l.g2)("el-row"),I=(0,l.g2)("el-input-number"),L=(0,l.g2)("CircleClose"),C=(0,l.g2)("el-form"),R=(0,l.g2)("el-card"),$=(0,l.g2)("download"),W=(0,l.g2)("el-table-column"),V=(0,l.g2)("el-image"),T=(0,l.g2)("loading"),P=(0,l.g2)("el-table"),S=(0,l.g2)("el-alert"),U=(0,l.g2)("el-image-viewer"),E=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",z,[(0,l.Lk)("div",O,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 返回填报 "))]),t[13]||(t[13]=(0,l.Lk)("h1",null,"废物记录查看",-1)),r.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"home-link",onClick:t[1]||(t[1]=(...e)=>r.goHome&&r.goHome(...e))},[t[12]||(t[12]=(0,l.eW)(" 首页 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(c)])),_:1})])):((0,l.uX)(),(0,l.CE)("div",j))]),(0,l.Lk)("div",N,[(0,l.Lk)("div",Y,[(0,l.Lk)("h2",null,(0,i.v_)(r.unitName)+" 固体废物记录",1)]),(0,l.Lk)("div",H,[(0,l.bF)(m,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isAdmin||r.isUnitAdmin?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}),t[15]||(t[15]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(m,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}),t[16]||(t[16]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,l.bF)(R,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",J,[t[17]||(t[17]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(m,{type:"primary",link:"",onClick:t[2]||(t[2]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(u,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(v)])),_:1})):((0,l.uX)(),(0,l.Wv)(u,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",G,[(0,l.bF)(C,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(x,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(w,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"产生工序"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.filterForm.process,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.process=e),placeholder:"输入工序关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:12,md:8,lg:6,xl:6},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":r.disabledDate},null,8,["modelValue","disabled-date"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(x,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:12,md:16,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",Z,[(0,l.Lk)("div",ee,[(0,l.bF)(I,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"100%"}},null,8,["modelValue"]),null!==r.filterForm.minQuantity?((0,l.uX)(),(0,l.Wv)(u,{key:0,class:"clear-icon",onClick:t[8]||(t[8]=e=>r.filterForm.minQuantity=null)},{default:(0,l.k6)((()=>[(0,l.bF)(L)])),_:1})):(0,l.Q3)("",!0)]),t[18]||(t[18]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.Lk)("div",te,[(0,l.bF)(I,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[9]||(t[9]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"100%"}},null,8,["modelValue","min"]),null!==r.filterForm.maxQuantity?((0,l.uX)(),(0,l.Wv)(u,{key:0,class:"clear-icon",onClick:t[10]||(t[10]=e=>r.filterForm.maxQuantity=null)},{default:(0,l.k6)((()=>[(0,l.bF)(L)])),_:1})):(0,l.Q3)("",!0)])])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:12,md:8,lg:12,xl:12,class:"filter-buttons-col"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ae,[(0,l.bF)(m,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)("刷新筛选")]))),_:1},8,["onClick"]),(0,l.bF)(m,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[20]||(t[20]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])],512),[[o.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",oe,[(0,l.bF)(R,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",le,[t[24]||(t[24]=(0,l.Lk)("h3",{class:"table-title"},"废物记录列表",-1)),(0,l.Lk)("div",re,[(0,l.bF)(m,{type:"warning",onClick:r.exportWithoutImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[21]||(t[21]=(0,l.eW)(" 无照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,l.bF)(m,{type:"warning",onClick:r.exportWithImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[22]||(t[22]=(0,l.eW)(" 包含首张照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,l.bF)(m,{type:"warning",onClick:r.exportWithAllImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[23]||(t[23]=(0,l.eW)(" 包含全部照片(不推荐) "))])),_:1},8,["onClick","loading"])])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(P,{data:r.records,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:r.tableHeight},{append:(0,l.k6)((()=>[r.loadingMore?((0,l.uX)(),(0,l.CE)("div",fe,[(0,l.bF)(u,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(T)])),_:1}),t[27]||(t[27]=(0,l.eW)(" 正在加载... "))])):r.hasMore&&r.records.length>0?((0,l.uX)(),(0,l.CE)("div",he,[(0,l.bF)(m,{type:"primary",onClick:r.loadMore,disabled:r.loadingMore,size:"small"},{default:(0,l.k6)((()=>[t[28]||(t[28]=(0,l.eW)(" 点击加载更多 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1})])),_:1},8,["onClick","disabled"])])):r.records.length>0?((0,l.uX)(),(0,l.CE)("div",ve," 已全部加载 ")):(0,l.Q3)("",!0)])),default:(0,l.k6)((()=>[(0,l.bF)(W,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,l.bF)(W,{prop:"waste_type_name",label:"废物类型","min-width":"120"}),(0,l.bF)(W,{prop:"location",label:"产生地点","min-width":"120"}),(0,l.bF)(W,{prop:"process",label:"产生工序","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.process||"无"),1)])),_:1}),(0,l.bF)(W,{prop:"remarks",label:"备注","min-width":"150"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,l.bF)(W,{label:"收集开始时间","min-width":"160"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.collection_start_time)),1)])),_:1}),(0,l.bF)(W,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(null!==e.row.quantity&&void 0!==e.row.quantity?parseFloat(e.row.quantity).toFixed(3):""),1)])),_:1}),(0,l.bF)(W,{label:"汇报人","min-width":"100",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.creator_name||"未知"),1)])),_:1}),(0,l.bF)(W,{label:"记录时间","min-width":"160",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.created_at)),1)])),_:1}),(0,l.bF)(W,{label:"清理前照片","min-width":"150",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",ne,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,se)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",ie,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",de,"无"))])),_:1}),(0,l.bF)(W,{label:"清理后照片","min-width":"150",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",ue,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,ce)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",pe,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",me,"无"))])),_:1}),(0,l.bF)(W,{label:"操作","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",ge,[r.canEdit(e.row)?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[25]||(t[25]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0),r.canEdit(e.row)&&(r.isAdmin||r.isUnitAdmin)?((0,l.uX)(),(0,l.Wv)(m,{key:1,type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[26]||(t[26]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0)])])),_:1})])),_:1},8,["data","height"])),[[E,r.loading]]),r.isAdmin||r.isUnitAdmin?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",we,[(0,l.bF)(S,{title:"提示：只能查看过去48小时内的废物记录",type:"info",closable:!1,"show-icon":""})]))])),_:1})])]),r.showViewer?((0,l.uX)(),(0,l.Wv)(U,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}var be=a(8828),ye=a(2933),_e=a(5320),Fe=a(3230),xe=a(7093),Ie=a.n(xe);const Le=(e,t="")=>{const a=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),o=t?`.${t}`:"";return`${e}_${a}${o}`},Ce=e=>e?e.replace(/[\\/:*?"<>|]/g,"_"):"";console.log("XLSX库版本:",Fe.version),console.log("XLSX库可用方法:",Object.keys(Fe).join(", "));const Re=async(e,t=window.location.origin)=>{if(console.log("获取图片:",e),!e)return console.error("图片URL为空"),null;const a=e.startsWith("/")?`${t}${e}`:e;try{console.log("获取图片:",a);const e=await fetch(a,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!e.ok)throw new Error(`获取图片失败: ${e.status} ${e.statusText}`);const t=await e.arrayBuffer();return console.log("图片获取成功，大小:",t.byteLength,"字节"),t}catch(o){return console.error("获取图片失败:",o),null}},$e=async(e,t,a,o=window.location.origin,l=null)=>{if(console.log("=== exportToExcelWithImages 函数被调用 ==="),console.log("数据条数:",e.length),!e||0===e.length)return console.error("导出失败：没有数据"),!1;try{const n=Ce(t),s=Le(n,"xlsx"),i=new(Ie().Workbook);i.creator="固体废物管理系统",i.lastModifiedBy="固体废物管理系统",i.created=new Date,i.modified=new Date;const d=i.addWorksheet("固体废物记录"),u=a.map((e=>({header:e.text,key:e.field,width:e.isImage?20:15})));d.columns=u,d.getRow(1).font={bold:!0},d.getRow(1).alignment={vertical:"middle",horizontal:"center"},console.log("开始处理数据行...");const c=e.length*(1+a.filter((e=>e.isImage)).length);let p=0;for(let t=0;t<e.length;t++){const n=e[t];console.log(`处理第 ${t+1}/${e.length} 条记录...`);const s={};a.forEach((e=>{e.isImage||(s[e.field]=n[e.field]||"")}));const u=d.addRow(s);u.height=80,p++,l&&"function"===typeof l&&l(p,c);for(const e of a)if(e.isImage){const s=e.field,u=n[s];if(u){console.log(`记录 ${t+1} 的 ${s} 字段有图片路径: ${u}`);try{const e=await Re(u,o);if(e){const o=a.findIndex((e=>e.field===s))+1,l=d.getCell(t+2,o).address,r=i.addImage({buffer:e,extension:u.split(".").pop().toLowerCase()});d.addImage(r,{tl:{col:o-1,row:t+1},br:{col:o,row:t+1.9},editAs:"oneCell"}),console.log(`已添加图片到单元格 ${l}`)}else console.error(`获取图片失败: ${u}`)}catch(r){console.error("处理图片时出错:",r)}}else console.log(`记录 ${t+1} 的 ${s} 没有照片路径`);p++,l&&"function"===typeof l&&l(p,c)}}console.log("数据行处理完成，准备生成Excel文件...");const m=await i.xlsx.writeBuffer(),g=new Blob([m],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=window.URL.createObjectURL(g),h=document.createElement("a");return h.href=f,h.download=s,h.click(),window.URL.revokeObjectURL(f),console.log("Excel文件生成并下载成功"),!0}catch(n){return console.error("导出Excel文件失败:",n),!1}},We=async(e,t,a)=>{if(!e||0===e.length)return console.error("导出失败：没有数据"),!1;const o=Ce(t),l=Le(o,"xlsx");console.log("导出函数被调用，数据条数:",e.length);try{console.log("使用ExcelJS导出Excel...");const t=new(Ie().Workbook);t.creator="固体废物管理系统",t.lastModifiedBy="固体废物管理系统",t.created=new Date,t.modified=new Date;const o=t.addWorksheet("固体废物记录"),r=a.map((e=>({header:e.text,key:e.field,width:15})));o.columns=r,o.getRow(1).font={bold:!0},o.getRow(1).alignment={vertical:"middle",horizontal:"center"},e.forEach((e=>{const t={};a.forEach((a=>{t[a.field]=e[a.field]||""})),o.addRow(t)})),console.log("生成Excel数据...");const n=await t.xlsx.writeBuffer(),s=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(s),d=document.createElement("a");return d.href=i,d.download=l,console.log("下载链接创建成功，准备触发点击"),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),console.log("Excel导出成功"),!0}catch(r){return console.error("导出Excel失败，错误详情:",r),console.log("回退到CSV导出"),Ve(e,t,a),!1}},Ve=(e,t,a)=>{const o=Ce(t),l=Le(o,"csv");let r="\ufeff";const n=a.map((e=>`"${e.title}"`)).join(",");r+=n+"\r\n",e.forEach((e=>{const t=a.map((t=>{const a=e[t.field];if(null===a||void 0===a)return"";if("number"===t.type||"number"===typeof a)return a;let o=String(a);return(o.includes(",")||o.includes('"')||o.includes("\n"))&&(o=o.replace(/"/g,'""'),o=`"${o}"`),o})).join(",");r+=t+"\r\n"}));const s=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),d=document.createElement("a");d.setAttribute("href",i),d.setAttribute("download",l),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),console.log("CSV导出成功")};var Te={name:"RecordsList",components:{ArrowLeft:A.nkM,Home:A.Home,Refresh:A.C42,Plus:A.FWt,User:A.KJW,ArrowDown:A.yd$,ArrowUp:A.DoI,Download:A.f5X,ElImageViewer:be.Tg,Loading:A.Rhj,CircleClose:A.R$5},props:{unitId:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),a=(0,f.KR)([]),o=(0,f.KR)(!1),r=(0,f.KR)(""),n=(0,f.KR)([]),i=(0,f.KR)(!0),d=w.baseURL,u=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},c=(0,f.KR)(1),p=(0,f.KR)(20),m=(0,f.KR)(!0),v=(0,f.KR)(!1),k=(0,f.Kh)({dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:"",process:""}),b=(0,f.KR)(null);(0,l.wB)([()=>k.wasteTypeId,()=>k.location,()=>k.process,()=>k.minQuantity,()=>k.maxQuantity,()=>k.dateRange],(()=>{b.value&&clearTimeout(b.value),b.value=setTimeout((()=>{c.value=1,z()}),300)}));const y=(0,l.EW)((()=>Ba.isAdmin())),_=(0,l.EW)((()=>Ba.isUnitAdmin())),F=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},x=async()=>{await z(),g.nk.success("记录已刷新")},I=()=>{const e=Ba.getUnitId();e?t.push(`/unit/${e}`):t.push("/")},L=()=>{t.push("/")},C=()=>{t.push("/user-management")},R=()=>{t.push(`/unit/${e.unitId}`)},$=e=>{t.push(`/record/${e}`)},W=e=>{if(!e)return!1;if(y.value)return!0;const t=Ba.getUnitId();if(_.value&&t&&e.unit_id===parseInt(t))return!0;const a=Ba.getUserId();return a&&e.creator_id===parseInt(a)},V=e=>e+1,T=e=>{y.value||_.value?ye.s.confirm("确定要删除这条废物记录吗？此操作不可逆。","删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await Ta.delete(`${w.endpoints.wasteRecords}/${e.id}`),g.nk.success("记录已成功删除"),await z()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败，请重试")}})).catch((()=>{g.nk.info("已取消删除")})):g.nk.error("您没有删除记录的权限")},P=async()=>{try{c.value=1,await z(),g.nk.success("筛选条件已应用")}catch(e){console.error("应用筛选失败:",e),g.nk.error("应用筛选失败")}},S=async()=>{k.dateRange=null,k.wasteTypeId=null,k.minQuantity=null,k.maxQuantity=null,k.location="",k.process="",c.value=1,await z(),g.nk.success("筛选条件已重置")},U=(0,f.KR)(!1),E=(0,f.KR)([]),K=(0,f.KR)(0),D=(e,t)=>{const a=Array.isArray(e)?e:[e];E.value=a.map((e=>`${d}${e}`)),K.value=t||0,U.value=!0},A=()=>{U.value=!1},Q=(0,f.KR)(750),X=()=>{const e=window.innerHeight,t=Math.max(.85*e,700);Q.value=t},M=()=>{X()};(0,l.sV)((async()=>{X(),window.addEventListener("resize",M),await B(),await q(),await z()})),(0,l.hi)((()=>{window.removeEventListener("resize",M)}));const q=async()=>{try{const e=await Ta.get(w.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型列表失败")}},B=async()=>{try{const t=await Ta.get(w.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.unitId)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},z=async(t=!1)=>{t?v.value=!0:(o.value=!0,c.value=1,a.value=[]);try{if(!Ba.state.isLoggedIn||!Ba.state.user)throw new Error("用户未登录");const o={page:c.value,pageSize:p.value,wasteTypeId:k.wasteTypeId||void 0,minQuantity:k.minQuantity||void 0,maxQuantity:k.maxQuantity||void 0,location:k.location||void 0,process:k.process||void 0,unitId:e.unitId?parseInt(e.unitId):void 0};k.dateRange&&2===k.dateRange.length&&(o.dateRange=JSON.stringify(k.dateRange)),console.log("【筛选】请求废物记录，参数:",JSON.stringify(o,null,2));const l=w.getUrl(`${w.endpoints.wasteRecords}/user/${Ba.state.user.id}`);console.log("【筛选】请求URL:",l);const r=await h.A.get(l,{params:o});if(console.log("【筛选】获取到废物记录响应:",r.data),!r.data||!r.data.records)throw console.error("【筛选】响应数据格式错误:",r.data),new Error("响应数据格式错误");const n=r.data.records.map((e=>({...e,created_at:F(e.created_at),collection_start_time:F(e.collection_start_time)})));console.log(`【筛选】获取到${n.length}条记录`),a.value=t?[...a.value,...n]:n,m.value=r.data.hasMore,m.value&&c.value++}catch(l){console.error("【筛选】获取废物记录失败:",l),g.nk.error("获取废物记录失败: "+(l.message||"未知错误"))}finally{o.value=!1,v.value=!1}},O=()=>{console.log("手动触发加载更多");const e=document.querySelector(".el-table__body-wrapper"),t=e?e.scrollTop:0;return z(!0).then((()=>{console.log("加载完成，当前记录数:",a.value.length),setTimeout((()=>{e&&(e.scrollTop=t)}),10)})).catch((e=>{console.error("加载失败:",e),g.nk.error("加载更多数据失败")}))},j=(0,l.EW)((()=>!y.value&&!_.value)),N=async()=>{try{(0,g.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const t=_e.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const a={wasteTypeId:k.wasteTypeId?k.wasteTypeId:void 0,minQuantity:k.minQuantity?k.minQuantity:void 0,maxQuantity:k.maxQuantity?k.maxQuantity:void 0,location:k.location||void 0,process:k.process||void 0,dateRange:k.dateRange?JSON.stringify(k.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0};console.log("导出记录的筛选条件:",a);const{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${Ba.state.user.id}`,{params:a});if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return t.close(),g.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);t.setText(`准备导出 ${l.length} 条记录...`);const n=l.map((e=>{const t=u(e.photo_path_before),a=u(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"产生工序":e.process||"无","备注":e.remarks||"无","收集开始时间":F(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":F(e.created_at),"清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),s=`固体废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],d=window.location.origin,c=(e,a)=>{const o=Math.round(e/a*100);t.setText(`正在导出：${o}% (${e}/${a})`)},p=await $e(n,s,i,d,c);t.close(),p?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),g.nk.error("导出失败: "+(t.message||"未知错误"))}finally{o.value=!1,_e.Ks.service().close()}},Y=async()=>{try{(0,g.nk)({message:"导出大量包含全部图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const t=_e.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const a={wasteTypeId:k.wasteTypeId?k.wasteTypeId:void 0,minQuantity:k.minQuantity?k.minQuantity:void 0,maxQuantity:k.maxQuantity?k.maxQuantity:void 0,location:k.location||void 0,process:k.process||void 0,dateRange:k.dateRange?JSON.stringify(k.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0};console.log("导出记录的筛选条件:",a);const{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${Ba.state.user.id}`,{params:a});if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return t.close(),g.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);t.setText(`准备导出 ${l.length} 条记录的全部照片...`);const n=l.map((e=>{const t=u(e.photo_path_before),a=u(e.photo_path_after),o={"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":F(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":F(e.created_at)};for(let l=0;l<5;l++)o[`清理前照片${l+1}`]=l<t.length?t[l]:"";for(let l=0;l<5;l++)o[`清理后照片${l+1}`]=l<a.length?a[l]:"";return o})),s=`固体废物记录_全部照片_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"}];for(let e=0;e<5;e++)i.push({text:`清理前照片${e+1}`,field:`清理前照片${e+1}`,isImage:!0});for(let e=0;e<5;e++)i.push({text:`清理后照片${e+1}`,field:`清理后照片${e+1}`,isImage:!0});const d=window.location.origin,c=(e,a)=>{const o=Math.round(e/a*100);t.setText(`正在导出全部照片：${o}% (${e}/${a})`)},p=await $e(n,s,i,d,c);t.close(),p?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),g.nk.error("导出失败: "+(t.message||"未知错误"))}finally{o.value=!1,_e.Ks.service().close()}},H=async()=>{try{const t=_e.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});o.value=!0;const a={wasteTypeId:k.wasteTypeId?k.wasteTypeId:void 0,minQuantity:k.minQuantity?k.minQuantity:void 0,maxQuantity:k.maxQuantity?k.maxQuantity:void 0,location:k.location||void 0,process:k.process||void 0,dateRange:k.dateRange?JSON.stringify(k.dateRange):void 0,unitId:e.unitId?parseInt(e.unitId):void 0},{data:l}=await h.A.get(`${w.getUrl(w.endpoints.exportWasteRecords)}/${Ba.state.user.id}`,{params:a});if(0===l.length)return t.close(),g.nk.warning("没有符合条件的记录可导出"),void(o.value=!1);t.setText(`准备导出 ${l.length} 条记录...`);const n=l.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":F(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":F(e.created_at),"清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),s=`固体废物记录_${r.value?r.value:"全部单位"}`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],d=await We(n,s,i);t.close(),d?g.nk.success("导出成功"):g.nk.error("导出失败，请重试")}catch(t){console.error("导出记录失败:",t),g.nk.error("导出失败: "+(t.message||"未知错误"))}finally{o.value=!1,_e.Ks.service().close()}},J=e=>{if(!y.value&&!_.value){const t=new Date,a=new Date(t);return a.setHours(t.getHours()-48),e<a||e>t}return!1};return{records:a,loading:o,unitName:r,wasteTypes:n,isAdmin:y,isUnitAdmin:_,parseFormattedDateTime:F,refreshRecords:x,goBack:I,goHome:L,goToUserManagement:C,addNewRecord:R,editRecord:$,canEdit:W,confirmDelete:T,apiConfig:w,showFilterPanel:i,filterForm:k,applyFilter:P,resetFilter:S,debounceTimer:b,exportWithImages:N,exportWithAllImages:Y,exportWithoutImages:H,showViewer:U,previewImages:E,previewIndex:K,previewPhoto:D,closeViewer:A,handleResize:M,parsePhotoPath:u,baseUrl:d,page:c,pageSize:p,hasMore:m,loadingMore:v,indexMethod:V,disabledDate:J,tableHeight:Q,isBasicEmployee:j,loadMore:O}}};const Pe=(0,I.A)(Te,[["render",ke],["__scopeId","data-v-6f9e5c36"]]);var Se=Pe;const Ue={class:"login-container"},Ee={class:"login-card"},Ke={key:0,class:"login-error"};function De(e,t,a,r,n,s){const d=(0,l.g2)("el-input"),u=(0,l.g2)("el-form-item"),c=(0,l.g2)("el-checkbox"),p=(0,l.g2)("el-button"),m=(0,l.g2)("el-form");return(0,l.uX)(),(0,l.CE)("div",Ue,[(0,l.Lk)("div",Ee,[t[5]||(t[5]=(0,l.Lk)("div",{class:"login-header"},[(0,l.Lk)("h1",null,"固体废物管理系统"),(0,l.Lk)("h2",null,"用户登录")],-1)),(0,l.bF)(m,{ref:"loginForm",model:r.form,rules:r.rules,"label-width":"80px",class:"login-form",onSubmit:(0,o.D$)(r.submitForm,["prevent"])},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"用户",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:r.form.phone,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.phone=e),placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,{label:"密码",prop:"password"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:r.form.password,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:r.form.rememberMe,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.rememberMe=e)},{default:(0,l.k6)((()=>t[3]||(t[3]=[(0,l.eW)("记住登录")]))),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p,{type:"primary","native-type":"submit",onClick:r.submitForm,loading:r.auth.state.loading,style:{width:"100%"}},{default:(0,l.k6)((()=>t[4]||(t[4]=[(0,l.eW)(" 登录 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules","onSubmit"]),r.auth.state.error?((0,l.uX)(),(0,l.CE)("div",Ke,(0,i.v_)(r.auth.state.error),1)):(0,l.Q3)("",!0)])])}var Ae={name:"LoginView",setup(){const e=(0,s.rd)(),t=(0,f.KR)(null),a=(0,f.Kh)({phone:"",password:"",rememberMe:!1}),o=(0,l.EW)((()=>{const e=[{required:!0,message:"请输入用户名",trigger:"submit"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的格式",trigger:"submit"}],t=[{required:!0,message:"请输入密码",trigger:"submit"}];return{phone:e,password:t}})),r=async()=>{console.log("提交表单被触发"),t.value?Ba.state.loading?console.log("登录正在进行中，跳过"):t.value.validate((async e=>{e?(console.log("表单验证通过"),await n()):console.log("表单验证失败")})):console.log("表单引用不存在")},n=async()=>{console.log("开始登录，账号:",a.phone);try{console.log("开始处理登录操作...");const t=await Ba.login(a.phone,a.password,a.rememberMe);if(console.log("登录响应:",t),t.success){const a=t.user;g.nk.success(`欢迎，${a.username||a.phone}`),3===a.role_id?e.push("/admin-records"):4===a.role_id?e.push("/record/new"):(a.role_id,e.push(`/unit/${a.unit_id}`))}else g.nk.error(t.error||"登录失败")}catch(t){g.nk.error(t.response?.data?.error||"登录失败，请检查网络连接")}};return(0,l.sV)((()=>{if(Ba.state.isLoggedIn){const t=Ba.state.user;3===t.role_id?e.push("/admin-records"):4===t.role_id?e.push("/record/new"):(t.role_id,e.push(`/unit/${t.unit_id}`))}})),{form:a,rules:o,loginForm:t,submitForm:r,auth:Ba}}};const Qe=(0,I.A)(Ae,[["render",De],["__scopeId","data-v-25ea481a"]]);var Xe=Qe;const Me={class:"edit-record-container"},qe={class:"header"},Be={key:1},ze={key:3},Oe={class:"content"},je={class:"form-header"},Ne={key:0,class:"form-tip"},Ye={key:0,class:"upload-warning"},He={class:"upload-progress"},Je={class:"upload-status"};function Ge(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("el-option"),c=(0,l.g2)("el-select"),p=(0,l.g2)("el-form-item"),m=(0,l.g2)("el-input"),g=(0,l.g2)("el-date-picker"),f=(0,l.g2)("clock"),h=(0,l.g2)("el-time-picker"),v=(0,l.g2)("el-input-number"),w=(0,l.g2)("el-alert"),k=(0,l.g2)("plus"),b=(0,l.g2)("el-upload"),y=(0,l.g2)("el-image-viewer"),_=(0,l.g2)("el-button"),F=(0,l.g2)("el-form"),x=(0,l.g2)("el-progress"),I=(0,l.g2)("el-dialog"),L=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Me,[(0,l.Lk)("div",qe,[o.isSupervisor?((0,l.uX)(),(0,l.CE)("div",Be)):((0,l.uX)(),(0,l.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 查看记录 "))])),(0,l.Lk)("h1",null,(0,i.v_)(o.isNew?"新增废物记录":"编辑废物记录"),1),o.isSupervisor?((0,l.uX)(),(0,l.CE)("div",{key:2,class:"back-button supervisor-back-button",onClick:t[1]||(t[1]=(...e)=>o.goBack&&o.goBack(...e))}," 查看记录 ")):((0,l.uX)(),(0,l.CE)("div",ze))]),(0,l.Lk)("div",Oe,[(0,l.Lk)("div",je,[(0,l.Lk)("h2",null,(0,i.v_)(o.unitName),1)]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(F,{ref:"recordForm",model:o.form,rules:o.rules,"label-width":"120px",class:"record-form"},{default:(0,l.k6)((()=>[o.isAdmin?((0,l.uX)(),(0,l.Wv)(p,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.unitId,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.units,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),o.isNew?((0,l.uX)(),(0,l.CE)("div",Ne,"请先选择单位，才能选择产生地点")):(0,l.Q3)("",!0)])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(p,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"产生工序",prop:"process"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.process,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.process=e),placeholder:"请选择产生工序",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.processOptions,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"其他"===o.form.process?((0,l.uX)(),(0,l.Wv)(m,{key:0,modelValue:o.customProcess,"onUpdate:modelValue":t[5]||(t[5]=e=>o.customProcess=e),placeholder:"请输入具体产生工序",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,{label:"产生地点",prop:"location"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.location,"onUpdate:modelValue":t[6]||(t[6]=e=>o.form.location=e),placeholder:o.isAdmin&&!o.unitName?"请先选择单位":"请选择废物产生地点",style:{width:"100%"},disabled:o.isAdmin&&!o.unitName},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.locationOptions,(e=>((0,l.uX)(),(0,l.Wv)(u,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","placeholder","disabled"]),"其他"===o.form.location?((0,l.uX)(),(0,l.Wv)(m,{key:0,modelValue:o.customLocation,"onUpdate:modelValue":t[7]||(t[7]=e=>o.customLocation=e),placeholder:"请输入具体产生地点",style:{"margin-top":"10px",height:"40px"}},null,8,["modelValue"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,{label:"备注",prop:"remarks"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:o.form.remarks,"onUpdate:modelValue":t[8]||(t[8]=e=>o.form.remarks=e),type:"textarea",rows:1,placeholder:"请输入备注信息（选填）"},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集日期"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:o.form.collectionDate,"onUpdate:modelValue":t[9]||(t[9]=e=>o.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:o.form.collectionTime,"onUpdate:modelValue":t[10]||(t[10]=e=>o.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:o.form.quantity,"onUpdate:modelValue":t[11]||(t[11]=e=>o.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集前）",prop:"photo_path_before"},{default:(0,l.k6)((()=>[t[14]||(t[14]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),o.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",Ye,[(0,l.bF)(w,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(b,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoBeforeChange,"on-remove":o.handlePhotoBeforeRemove,"file-list":o.fileListBefore,limit:5,multiple:"","list-type":"picture-card","on-preview":o.handlePictureCardPreview,"before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集后）",prop:"photo_path_after"},{default:(0,l.k6)((()=>[t[15]||(t[15]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(b,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":o.handlePhotoAfterChange,"on-remove":o.handlePhotoAfterRemove,"file-list":o.fileListAfter,limit:5,multiple:"","list-type":"picture-card","on-preview":o.handlePictureCardPreview,"before-upload":o.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),o.showViewer?((0,l.uX)(),(0,l.Wv)(y,{key:0,"url-list":o.previewImages,"initial-index":o.previewIndex,onClose:o.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,null,{default:(0,l.k6)((()=>[(0,l.bF)(_,{type:"primary",onClick:o.submitForm,loading:o.loading},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)("保存")]))),_:1},8,["onClick","loading"]),(0,l.bF)(_,{onClick:o.goBack},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("取消")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"])),[[L,o.loading]])]),(0,l.bF)(I,{modelValue:o.showUploadProgress,"onUpdate:modelValue":t[12]||(t[12]=e=>o.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",He,[t[18]||(t[18]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(x,{percentage:o.uploadPercentage,format:o.percentageFormat,status:100===o.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",Je,(0,i.v_)(o.uploadStatus),1)])])),_:1},8,["modelValue"]),t[19]||(t[19]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var Ze={name:"EditRecordView",components:{ArrowLeft:A.nkM,Plus:A.FWt,Clock:A.zD7,ElImageViewer:be.Tg},setup(){const e=(0,s.rd)(),t=(0,s.lq)(),a=(0,f.KR)(null),o=(0,f.KR)(!1),r=(0,f.KR)(!1),n=(0,f.KR)(""),i=(0,f.KR)([]),d=(0,f.KR)([]),u=(0,f.KR)([]),c=(0,f.KR)([]),p=(0,f.KR)([]),m=(0,f.KR)([]),h=(0,f.KR)([]),v=(0,f.KR)(!1),k=(0,f.KR)(0),b=(0,f.KR)(""),y=(0,f.KR)(!1),_=(0,f.KR)(0),F=(0,f.KR)("准备上传..."),x=(0,f.KR)(!1),I=(0,f.KR)(null),L=(0,f.KR)([]),C=(0,f.KR)(""),R=(0,f.KR)(""),$=["作业现场","清罐清理","报废清理","管线刺漏","历史遗留","日常维护","封井退出","其他"],W=(0,f.KR)([]),V=(0,f.KR)([]),T=(0,f.KR)([]),P=(0,f.KR)([]),S={"桓台":["金家接转站","金17-1注采站","金17-2注采站","金6金9项目组","金8注采站","其他"],"潍北":["潍北联合站","昌79注采站","昌3注采站","疃3注采站","昌15注采站","其他"],"高青":["高青联合站","樊107注采站","樊14注采站","高21注采站","高54注采站","其他"],"牛庄":["牛25集输站","牛25注采站","营13注采站","史112注采站","其他"],"金角":["长堤注采站","桩23注采站","其他"],"信远":["河125注采站","河122注采站","永551注采站","其他"],"滨博":["樊142注采站","樊142-2-12注采站","樊162注采站","樊页1井组","滨博接转站","其他"],"无棣":["车41注采站","车142注采站","车40注采站","车408注采站","车274注采站","车1接转站","东风港联合站","其他"],"河口":["沾14东注采站","沾14西注采站","渤南注采站","大北注采站","沾5注采站","太平接转站","沾5接转站","其他"],"胜兴":["博兴注采站","其他"],"其他":["其他"]},U=e=>{if(!e)return[];console.log("解析照片路径，原始值:",e,"类型:",typeof e);try{if(Array.isArray(e))return console.log("照片路径已经是数组:",e),e;if("string"===typeof e){if(e.startsWith("[")&&e.endsWith("]")){const t=JSON.parse(e);return console.log("照片路径解析为JSON数组:",t),t}if(e.includes(",")){const t=e.split(",").map((e=>e.trim())).filter((e=>e));return console.log("照片路径解析为逗号分隔字符串:",t),t}return console.log("照片路径解析为单个字符串:",[e]),[e]}return console.log("照片路径类型未知，尝试转换为字符串:",String(e)),[String(e)]}catch(t){return console.error("解析照片路径失败:",t),"string"===typeof e?[e]:[]}},E=(0,l.EW)((()=>!t.params.id||"new"===t.params.id)),K=(0,l.EW)((()=>Ba.state.isLoggedIn&&(3===Ba.state.user.role_id||4===Ba.state.user.role_id))),D=(0,l.EW)((()=>Ba.state.isLoggedIn&&4===Ba.state.user.role_id)),A=(0,f.Kh)({unitId:"",wasteTypeId:"",location:"",collectionDate:"",collectionTime:"",quantity:void 0,recordId:null,creatorId:Ba.state.user?.id||null,photo_path_before:"",photo_path_after:"",remarks:"",process:""}),Q={unitId:[{required:!0,message:"请选择单位",trigger:"change",validator:(e,t,a)=>{K.value?t?a():a(new Error("请选择单位")):a()}}],wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],process:[{required:!0,message:"请选择产生工序",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||R.value.trim()?a():a(new Error("请输入具体产生工序"))},trigger:"blur"}],location:[{required:!0,message:"请选择废物产生地点",trigger:"change"},{validator:(e,t,a)=>{"其他"!==t||C.value.trim()?a():a(new Error("请输入具体产生地点"))},trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!1,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{o.value=!0;try{await B(),K.value&&await M(),E.value?(!K.value&&Ba.state.user&&(A.unitId=Ba.state.user.unit_id,await q(A.unitId)),A.collectionDate=(new Date).toISOString().slice(0,10),A.collectionTime=(new Date).toTimeString().slice(0,5)):await z()}catch(e){console.error("初始化数据失败:",e),g.nk.error("加载数据失败，请刷新重试")}finally{o.value=!1}}));const M=async()=>{try{const e=await Ta.get(w.endpoints.units);d.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},q=async e=>{try{const t=await Ta.get(w.endpoints.units),a=t.data.find((t=>t.id===parseInt(e)));a&&(n.value=a.name,S[n.value]?L.value=S[n.value]:(L.value=[],console.warn(`未找到管理区 "${n.value}" 的地点选项`)))}catch(t){console.error("获取单位信息失败:",t)}},B=async()=>{try{const e=await Ta.get(w.endpoints.wasteTypes);i.value=e.data}catch(e){console.error("获取废物类型失败:",e),g.nk.error("获取废物类型失败")}},z=async()=>{try{o.value=!0;const e=await Ta.get(`${w.endpoints.wasteRecords}/detail/${t.params.id}`);I.value=e.data;const a=e.data;if(console.log("获取到的记录详情:",a),A.unitId=a.unit_id,A.wasteTypeId=a.waste_type_id,await q(A.unitId),a.process&&($.includes(a.process)?A.process=a.process:(A.process="其他",R.value=a.process)),L.value.includes(a.location)?A.location=a.location:(A.location="其他",C.value=a.location),A.recordId=a.id,a.collection_start_time){const e=a.collection_start_time;if(console.log("原始时间字符串:",e),e.includes(" ")){const[t,a]=e.split(" ");A.collectionDate=t,A.collectionTime=a.substring(0,5),console.log("解析后日期:",t,"时间:",a.substring(0,5))}else{const t=new Date(e+(e.includes("T")?"":"T00:00:00")),a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0");A.collectionDate=`${a}-${o}-${l}`,A.collectionTime=`${r}:${n}`,console.log("解析后日期:",A.collectionDate,"时间:",A.collectionTime)}}if(A.quantity=a.quantity,A.remarks=a.remarks||"",console.log("设置备注字段:",a.remarks),a.photo_path_before){console.log("收集前照片路径:",a.photo_path_before);const e=U(a.photo_path_before);console.log("解析后的收集前照片路径:",e),T.value=[...e],u.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集前照片完整URL:",t),{name:e.split("/").pop(),url:t,originalPath:e}}))}if(a.photo_path_after){console.log("收集后照片路径:",a.photo_path_after);const e=U(a.photo_path_after);console.log("解析后的收集后照片路径:",e),P.value=[...e],c.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集后照片完整URL:",t),{name:e.split("/").pop(),url:t,originalPath:e}}))}n.value=a.unit_name,b.value=a.created_at,J([...u.value,...c.value])}catch(e){console.error("获取记录详情失败:",e),g.nk.error("获取记录详情失败")}finally{o.value=!1}},O=e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return g.nk.error("只能上传图片文件!"),!1;const o=52428800;return e.size>o?(g.nk.error("图片大小不能超过50MB!"),!1):new Promise((t=>{y.value=!0,F.value="正在处理图片...",_.value=0,console.log("开始处理图片:",e.name,"类型:",e.type,"大小:",(e.size/1024).toFixed(2),"KB"),new(X())(e,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){_.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){_.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),F.value="图片处理完成",_.value=100,setTimeout((()=>{y.value=!1}),500),t(l)},error(a){console.error("图片压缩失败:",a),F.value="处理失败，使用原始图片",_.value=100,setTimeout((()=>{y.value=!1}),500),t(e)}})}))},j=async(e,t)=>{if(console.log("收集前照片变更:",e),console.log("当前文件列表:",t),u.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){y.value=!0,F.value="正在处理图片...",_.value=0,console.log("开始处理收集前照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(X())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){_.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){_.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),F.value="图片处理完成",_.value=100,t(l)},error(a){console.error("图片压缩失败:",a),F.value="处理失败，使用原始图片",_.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=p.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?p.value[a]=t:p.value.push(t);const o=u.value.findIndex((t=>t.uid===e.uid));o>=0&&(u.value[o].processed=!0),setTimeout((()=>{y.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),g.nk.warning("图片处理失败，将使用原始图片");const t=p.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?p.value[t]=e.raw:p.value.push(e.raw),y.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return ee(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集前照片添加raw属性:",e.raw)),J([...u.value,...c.value]),console.log("更新后的fileListBefore:",u.value),console.log("更新后的photoFilesBefore:",p.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},N=(e,t)=>{console.log("收集前照片移除:",e),e.originalPath&&(console.log("记录要删除的收集前照片:",e.originalPath),W.value.push(e.originalPath)),u.value=t,ee([...u.value,...c.value])||(x.value=!1),J([...u.value,...c.value])},Y=async(e,t)=>{if(console.log("收集后照片变更:",e),console.log("当前文件列表:",t),c.value=[...t],!e.processed){if(e.raw&&"ready"===e.status){y.value=!0,F.value="正在处理图片...",_.value=0,console.log("开始处理收集后照片:",e.name,"类型:",e.raw.type,"大小:",(e.raw.size/1024).toFixed(2),"KB");try{const t=await new Promise((t=>{new(X())(e.raw,{quality:.6,maxWidth:1920,maxHeight:1920,mimeType:"image/jpeg",convertSize:0,beforeDraw(){_.value=30,F.value="正在处理图片...",console.log("图片处理中...")},drew(){_.value=60,F.value="正在压缩图片...",console.log("图片绘制完成")},success(a){const o=e.raw.name.replace(/\.[^/.]+$/,"")+".jpg",l=new File([a],o,{type:"image/jpeg",lastModified:(new Date).getTime()});console.log("图片处理完成:"),console.log("- 原始大小:",(e.raw.size/1024).toFixed(2),"KB"),console.log("- 处理后大小:",(l.size/1024).toFixed(2),"KB"),console.log("- 压缩率:",Math.round(100*(1-l.size/e.raw.size)),"%"),console.log("- 处理后文件类型:",l.type),console.log("- 处理后文件名:",l.name),F.value="图片处理完成",_.value=100,t(l)},error(a){console.error("图片压缩失败:",a),F.value="处理失败，使用原始图片",_.value=100,t(e.raw)}})}));console.log("替换原始文件为处理后的文件:",t.name),e.processed=!0,e.raw=t;const a=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));a>=0?m.value[a]=t:m.value.push(t);const o=c.value.findIndex((t=>t.uid===e.uid));o>=0&&(c.value[o].processed=!0),setTimeout((()=>{y.value=!1}),500)}catch(a){console.error("处理图片时出错:",a),g.nk.warning("图片处理失败，将使用原始图片");const t=m.value.findIndex((t=>t.uid===e.uid||t.name===e.name));t>=0?m.value[t]=e.raw:m.value.push(e.raw),y.value=!1}}else!e.raw&&e.url&&console.log("已有文件，不需要处理:",e.name);return ee(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集后照片添加raw属性:",e.raw)),J([...u.value,...c.value]),console.log("更新后的fileListAfter:",c.value),console.log("更新后的photoFilesAfter:",m.value),!1}console.log("文件已处理过，跳过压缩:",e.name)},H=(e,t)=>{console.log("收集后照片移除:",e),e.originalPath&&(console.log("记录要删除的收集后照片:",e.originalPath),V.value.push(e.originalPath)),c.value=t,ee([...u.value,...c.value])||(x.value=!1),J([...u.value,...c.value])},J=e=>{h.value=e.map((e=>e.url?(console.log("预览图片URL:",e.url),e.url):e.raw?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e.raw)),console.log("预览图片从raw创建:",e._blobUrl),e._blobUrl):e instanceof File?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e)),console.log("预览图片从File创建:",e._blobUrl),e._blobUrl):"")).filter((e=>e)),console.log("预览图片列表:",h.value)},G=e=>{console.log("预览图片:",e),J([...u.value,...c.value]);const t=h.value.findIndex((t=>{if(e.url)return t===e.url;if(e.raw){const a=URL.createObjectURL(e.raw),o=t===a;return URL.revokeObjectURL(a),o}return!1}));k.value=-1!==t?t:0,v.value=!0},Z=()=>{v.value=!1},ee=e=>{const t=2097152;return e.some((e=>e.size>t))},te=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);_.value=t,F.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},ae=e=>100===e?"完成":`${e}%`,oe=async()=>{a.value&&await a.value.validate((async t=>{if(!t)return console.log("表单验证失败"),g.nk.error("请填写所有必填字段"),!1;_.value=0,F.value="正在上传文件...",y.value=!0;try{const t=new FormData;if(t.append("unitId",A.unitId),t.append("wasteTypeId",A.wasteTypeId),"其他"===A.process&&R.value.trim()?t.append("process",R.value.trim()):t.append("process",A.process),"其他"===A.location&&C.value.trim()?t.append("location",C.value.trim()):t.append("location",A.location),t.append("collectionDate",A.collectionDate),t.append("collectionTime",A.collectionTime),void 0!==A.quantity&&null!==A.quantity&&""!==A.quantity&&t.append("quantity",A.quantity),t.append("remarks",A.remarks||""),E.value||(W.value.length>0&&(console.log("发送要删除的收集前照片列表:",W.value),t.append("photos_to_remove_before",JSON.stringify(W.value))),V.value.length>0&&(console.log("发送要删除的收集后照片列表:",V.value),t.append("photos_to_remove_after",JSON.stringify(V.value)))),u.value.length>0){const e=u.value.filter((e=>e.raw)),a=u.value.filter((e=>!e.raw&&e.originalPath));if(e.forEach((e=>{e.raw&&(console.log("添加新的收集前照片:",e.raw.name),t.append("photo_before",e.raw))})),a.length>0){const e=a.map((e=>e.originalPath));console.log("保留的收集前照片路径:",e),t.append("photo_path_before",JSON.stringify(e))}}else!E.value&&T.value.length>0&&(console.log("用户删除了所有收集前照片，发送NULL标记"),t.append("photo_path_before","NULL"));if(c.value.length>0){const e=c.value.filter((e=>e.raw)),a=c.value.filter((e=>!e.raw&&e.originalPath));if(e.forEach((e=>{e.raw&&(console.log("添加新的收集后照片:",e.raw.name),t.append("photo_after",e.raw))})),a.length>0){const e=a.map((e=>e.originalPath));console.log("保留的收集后照片路径:",e),t.append("photo_path_after",JSON.stringify(e))}}else!E.value&&P.value.length>0&&(console.log("用户删除了所有收集后照片，发送NULL标记"),t.append("photo_path_after","NULL"));console.log("FormData内容:");for(let[e,a]of t.entries())a instanceof File?console.log(`${e}: File - ${a.name} (${a.type}, ${a.size} bytes)`):console.log(`${e}: ${a}`);A.recordId?(await Ta.putForm(`${w.endpoints.wasteRecords}/${A.recordId}`,t,te),g.nk.success("废物记录更新成功！正在跳转到记录列表...")):(await Ta.postForm(w.endpoints.wasteRecords,t,te),g.nk.success("废物记录添加成功！正在跳转到记录列表...")),y.value=!1,setTimeout((()=>{if(Ba.state.isLoggedIn&&Ba.state.user){const t=Ba.state.user.role_id;3===t||4===t?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:Ba.state.user.unit_id}})}else le()}),1500)}catch(a){console.error("提交表单失败:",a),a.response&&a.response.data?(console.error("服务器返回错误:",a.response.data),g.nk.error(`提交表单失败: ${a.response.data.error||"未知错误"}`)):g.nk.error("提交表单失败，请检查网络连接"),y.value=!1}}))},le=()=>{K.value?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:Ba.state.user.unit_id}})};return(0,l.wB)((()=>A.unitId),(async e=>{e?await q(e):(L.value=[],n.value="")})),{form:A,rules:Q,recordForm:a,loading:o,submitting:r,unitName:n,wasteTypes:i,units:d,fileListBefore:u,fileListAfter:c,photoFilesBefore:p,photoFilesAfter:m,previewImages:h,showViewer:v,previewIndex:k,isNew:E,isAdmin:K,isSupervisor:D,parsePhotoPath:U,handlePhotoBeforeChange:j,handlePhotoBeforeRemove:N,handlePhotoAfterChange:Y,handlePhotoAfterRemove:H,handlePictureCardPreview:G,handleBeforeUpload:O,closeViewer:Z,submitForm:oe,goBack:le,showUploadProgress:y,uploadPercentage:_,uploadStatus:F,percentageFormat:ae,showLargeFileWarning:x,record:I,locationOptions:L,locationMap:S,customLocation:C,customProcess:R,processOptions:$,deletedPhotosBefore:W,deletedPhotosAfter:V,originalPhotosBefore:T,originalPhotosAfter:P}}};const et=(0,I.A)(Ze,[["render",Ge],["__scopeId","data-v-559bcfb4"]]);var tt=et;const at={class:"user-management-container"},ot={class:"header"},lt={class:"content"},rt={class:"toolbar"},nt={class:"search-container"},st={key:0,class:"password-hint"},it={key:1,class:"password-hint"},dt={class:"dialog-footer"};function ut(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("search"),c=(0,l.g2)("el-input"),p=(0,l.g2)("plus"),m=(0,l.g2)("el-button"),g=(0,l.g2)("el-table-column"),f=(0,l.g2)("el-tag"),h=(0,l.g2)("el-popconfirm"),v=(0,l.g2)("el-table"),w=(0,l.g2)("el-form-item"),k=(0,l.g2)("el-option"),b=(0,l.g2)("el-select"),y=(0,l.g2)("el-form"),_=(0,l.g2)("el-dialog"),F=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",at,[(0,l.Lk)("div",ot,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[9]||(t[9]=(0,l.eW)(" 返回 "))]),t[10]||(t[10]=(0,l.Lk)("h1",null,"人员管理",-1)),t[11]||(t[11]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",lt,[(0,l.Lk)("div",rt,[(0,l.Lk)("div",nt,[(0,l.bF)(c,{modelValue:o.searchKeyword,"onUpdate:modelValue":t[1]||(t[1]=e=>o.searchKeyword=e),placeholder:"请输入姓名关键字搜索",clearable:"",onClear:o.clearSearch,class:"search-input"},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1})])),_:1},8,["modelValue","onClear"])]),(0,l.bF)(m,{type:"primary",onClick:o.openAddDialog},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[12]||(t[12]=(0,l.eW)(" 添加用户 "))])),_:1},8,["onClick"])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(v,{data:o.users,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,l.k6)((()=>[(0,l.bF)(g,{type:"index",label:"序号",width:"70",align:"center"}),(0,l.bF)(g,{prop:"username",label:"姓名",width:"120"}),(0,l.bF)(g,{prop:"phone",label:"手机号",width:"140"}),(0,l.bF)(g,{prop:"role_name",label:"角色",width:"120"}),(0,l.bF)(g,{prop:"unit_name",label:"单位","min-width":"120"}),(0,l.bF)(g,{label:"状态",width:"100",align:"center"},{default:(0,l.k6)((e=>[(0,l.bF)(f,{type:1===e.row.status?"success":"danger"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.status?"正常":"已停用"),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(g,{label:"日志权限",width:"100",align:"center"},{default:(0,l.k6)((e=>[(0,l.bF)(f,{type:1===e.row.can_view_logs?"success":"info"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.can_view_logs?"允许":"禁止"),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(g,{label:"操作",width:"300",fixed:"right"},{default:(0,l.k6)((e=>[o.isSuperAdmin||2!==e.row.role_id?((0,l.uX)(),(0,l.Wv)(m,{key:0,size:"small",onClick:t=>o.handleEdit(e.row)},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0),o.isSuperAdmin||2!==e.row.role_id?((0,l.uX)(),(0,l.Wv)(m,{key:1,size:"small",type:1===e.row.status?"warning":"success",onClick:t=>o.handleStatusChange(e.row)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.status?"停用":"恢复"),1)])),_:2},1032,["type","onClick"])):(0,l.Q3)("",!0),o.canManageLogPermissions?((0,l.uX)(),(0,l.Wv)(m,{key:2,size:"small",type:1===e.row.can_view_logs?"warning":"primary",onClick:t=>o.handleLogPermissionChange(e.row)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(1===e.row.can_view_logs?"禁止日志":"允许日志"),1)])),_:2},1032,["type","onClick"])):(0,l.Q3)("",!0),o.isSuperAdmin||2!==e.row.role_id?((0,l.uX)(),(0,l.Wv)(h,{key:3,title:"确定要删除此用户吗？",onConfirm:t=>o.handleDelete(e.row)},{reference:(0,l.k6)((()=>[(0,l.bF)(m,{size:"small",type:"danger"},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])):(0,l.Q3)("",!0)])),_:1})])),_:1},8,["data"])),[[F,o.loading]])]),(0,l.bF)(_,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[8]||(t[8]=e=>o.dialogVisible=e),title:o.isEdit?"编辑用户":"添加用户",width:"500px"},{footer:(0,l.k6)((()=>[(0,l.Lk)("span",dt,[(0,l.bF)(m,{onClick:t[7]||(t[7]=e=>o.dialogVisible=!1)},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(m,{type:"primary",onClick:o.submitForm,loading:o.formLoading},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(y,{ref:"userForm",model:o.form,rules:o.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,l.k6)((()=>[(0,l.bF)(w,{label:"姓名",prop:"username"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.username,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.username=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),(0,l.bF)(w,{label:"手机号",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.phone,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,l.bF)(w,{label:"角色",prop:"roleId"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:o.form.roleId,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.roleId=e),placeholder:"请选择角色",style:{width:"100%"}},{default:(0,l.k6)((()=>[o.isSuperAdmin?((0,l.uX)(),(0,l.Wv)(k,{key:0,value:3,label:"超级管理员"})):(0,l.Q3)("",!0),o.isSuperAdmin?((0,l.uX)(),(0,l.Wv)(k,{key:1,value:4,label:"监督人员"})):(0,l.Q3)("",!0),(0,l.bF)(k,{value:2,label:"单位管理员"}),(0,l.bF)(k,{value:1,label:"基层员工"})])),_:1},8,["modelValue"])])),_:1}),3!==o.form.roleId&&4!==o.form.roleId?((0,l.uX)(),(0,l.Wv)(w,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:o.form.unitId,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"},disabled:!o.isSuperAdmin&&o.isEdit},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.units,(e=>((0,l.uX)(),(0,l.Wv)(k,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(w,{label:"密码",prop:o.isEdit?"":"password"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:o.form.password,"onUpdate:modelValue":t[6]||(t[6]=e=>o.form.password=e),placeholder:"请输入密码",type:"password","show-password":""},null,8,["modelValue"]),o.isEdit?((0,l.uX)(),(0,l.CE)("div",it,"不修改密码请留空")):((0,l.uX)(),(0,l.CE)("div",st,"所有账号必须设置密码"))])),_:1},8,["prop"])])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),t[17]||(t[17]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var ct={name:"UserManagement",components:{ArrowLeft:A.nkM,Plus:A.FWt,Search:A.vji},setup(){const e=(0,s.rd)(),t=(0,f.KR)(!1),a=(0,f.KR)(!1),o=(0,f.KR)(!1),r=(0,f.KR)(!1),n=(0,f.KR)(null),i=(0,f.KR)([]),d=(0,f.KR)([]),u=(0,f.KR)(""),c=(0,f.KR)([]),p=(0,l.EW)((()=>Ba.state.isLoggedIn&&(3===Ba.state.user.role_id||4===Ba.state.user.role_id))),m=(0,l.EW)((()=>Ba.state.isLoggedIn&&Ba.state.user&&1===Ba.state.user.can_view_logs)),h=(0,l.EW)((()=>Ba.state.isLoggedIn?Ba.state.user.unit_id:null)),v=(0,f.Kh)({id:null,username:"",phone:"",roleId:1,unitId:null,password:""}),k={username:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],unitId:[{required:function(){return 3!==v.roleId&&4!==v.roleId},message:"请选择单位",trigger:"change"}],password:[{required:function(){return!r.value},message:"请输入密码",trigger:"blur"},{validator:(e,t,a)=>{t&&t.length>0?t.length<1||t.length>20?a(new Error("长度在 1 到 20 个字符")):a():r.value?a():a(new Error("请输入密码"))},trigger:"blur"}]},b=async()=>{t.value=!0;try{let e;e=p.value?await Ta.get(w.endpoints.users):await Ta.get(`${w.endpoints.usersByUnit}/${h.value}`),i.value=e.data,c.value=e.data}catch(e){console.error("Error fetching users:",e),g.nk.error("获取用户列表失败")}finally{t.value=!1}},y=async()=>{try{const e=await Ta.get(w.endpoints.units);d.value=e.data}catch(e){console.error("Error fetching units:",e),g.nk.error("获取单位列表失败")}},_=()=>{r.value=!1,C(),o.value=!0,p.value||(v.unitId=h.value)},F=e=>{r.value=!0,v.id=e.id,v.username=e.username,v.phone=e.phone,v.roleId=e.role_id,v.unitId=e.unit_id,v.password="",o.value=!0},x=async e=>{try{await Ta.delete(`${w.endpoints.users}/${e.id}`),g.nk.success("用户删除成功"),b()}catch(t){console.error("Error deleting user:",t);let e="删除用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}},I=async e=>{const t=1===e.status?0:1,a=1===t?"恢复":"停用";try{await Ta.put(`${w.endpoints.users}/${e.id}/status`,{status:t}),g.nk.success(`用户${a}成功`),b()}catch(o){console.error("状态变更失败:",o);let e=`${a}用户失败`;o.response&&o.response.data&&o.response.data.error&&(e=o.response.data.error),g.nk.error(e)}},L=async e=>{const t=1===e.can_view_logs?null:1,a=1===t?"允许查看日志":"禁止查看日志";try{const o=w.endpoints.userLogPermission.replace(":id",e.id);await Ta.put(o,{can_view_logs:t}),g.nk.success(`用户日志权限设置成功：${a}`),Ba.state.user&&Ba.state.user.id===e.id&&Ba.updateUserInfo({can_view_logs:t}),b()}catch(o){console.error("日志权限变更失败:",o);let e="设置日志权限失败";o.response&&o.response.data&&o.response.data.error&&(e=o.response.data.error),g.nk.error(e)}},C=()=>{n.value&&n.value.resetFields(),v.id=null,v.username="",v.phone="",v.roleId=1,v.unitId=null,v.password=""},R=()=>{n.value.validate((async e=>{if(e){a.value=!0;try{const e={username:v.username,phone:v.phone,roleId:v.roleId,unitId:3!==v.roleId?v.unitId:null};v.password&&(e.password=v.password),r.value?(await Ta.put(`${w.endpoints.users}/${v.id}`,e),g.nk.success("用户更新成功")):(await Ta.post(w.endpoints.users,e),g.nk.success("用户添加成功")),o.value=!1,b()}catch(t){console.error("Error submitting user form:",t);let e=r.value?"更新用户失败":"添加用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}finally{a.value=!1}}else g.nk.warning("请完成必填项")}))},$=()=>{e.back()},W=()=>{if(u.value.trim()){const e=u.value.toLowerCase();i.value=c.value.filter((t=>t.username.toLowerCase().includes(e)))}else i.value=c.value},V=()=>{u.value="",W()};return(0,l.sV)((()=>{b(),y()})),(0,l.wB)(u,(()=>{W()})),{loading:t,formLoading:a,dialogVisible:o,isEdit:r,userForm:n,users:i,units:d,form:v,rules:k,isSuperAdmin:p,currentUnitId:h,canManageLogPermissions:m,openAddDialog:_,handleEdit:F,handleDelete:x,handleStatusChange:I,handleLogPermissionChange:L,submitForm:R,goBack:$,searchKeyword:u,filterUsers:W,clearSearch:V}}};const pt=(0,I.A)(ct,[["render",ut],["__scopeId","data-v-26a65cbd"]]);var mt=pt;const gt={class:"admin-records-container"},ft={class:"content"},ht={class:"actions"},vt={class:"filter-header"},wt={class:"filter-form-container"},kt={class:"quantity-range"},bt={class:"input-with-clear"},yt={class:"input-with-clear"},_t={class:"filter-actions"},Ft={class:"records-wrapper"},xt={class:"card-header"},It={class:"card-actions"},Lt={class:"table-wrapper",ref:"tableContainer"},Ct={key:0,class:"photo-preview"},Rt=["onClick"],$t={key:0,class:"photo-count"},Wt={key:1},Vt={key:0,class:"photo-preview"},Tt=["onClick"],Pt={key:0,class:"photo-count"},St={key:1},Ut={class:"operation-buttons"},Et={key:0,class:"loading-row"},Kt={key:1,class:"load-more-row"},Dt={key:2,class:"no-more-row"},At={key:0,class:"empty-block"};function Qt(e,t,a,r,n,s){const d=(0,l.g2)("plus"),u=(0,l.g2)("el-icon"),c=(0,l.g2)("el-button"),p=(0,l.g2)("user"),m=(0,l.g2)("document"),g=(0,l.g2)("refresh"),f=(0,l.g2)("arrow-down"),h=(0,l.g2)("arrow-up"),v=(0,l.g2)("el-option"),w=(0,l.g2)("el-select"),k=(0,l.g2)("el-form-item"),b=(0,l.g2)("el-col"),y=(0,l.g2)("el-input"),_=(0,l.g2)("el-switch"),F=(0,l.g2)("el-row"),x=(0,l.g2)("el-date-picker"),I=(0,l.g2)("el-input-number"),L=(0,l.g2)("CircleClose"),C=(0,l.g2)("el-form"),R=(0,l.g2)("el-card"),$=(0,l.g2)("download"),W=(0,l.g2)("el-table-column"),V=(0,l.g2)("el-image"),T=(0,l.g2)("loading"),P=(0,l.g2)("el-table"),S=(0,l.g2)("el-empty"),U=(0,l.g2)("el-image-viewer"),E=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",gt,[t[27]||(t[27]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"固体废物管理系统历史记录")],-1)),(0,l.Lk)("div",ft,[(0,l.Lk)("div",ht,[(0,l.bF)(c,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isSuperAdmin?((0,l.uX)(),(0,l.Wv)(c,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[12]||(t[12]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),r.isSuperAdmin&&r.canViewLogs?((0,l.uX)(),(0,l.Wv)(c,{key:1,type:"warning",onClick:r.goToOperationLogs},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(m)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 操作日志 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(c,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,l.bF)(R,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",vt,[t[15]||(t[15]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(c,{type:"primary",link:"",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(u,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1})):((0,l.uX)(),(0,l.Wv)(u,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",wt,[(0,l.bF)(C,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(b,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"所属单位"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.unitId=e),placeholder:"选择单位",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(v,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(b,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(v,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(b,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(b,{xs:24,sm:12,md:5,lg:5,xl:5},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"产生工序"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{modelValue:r.filterForm.process,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.process=e),placeholder:"输入工序关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),r.isSuperAdmin?((0,l.uX)(),(0,l.Wv)(b,{key:0,xs:24,sm:12,md:4,lg:4,xl:4},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"监督数据"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{modelValue:r.filterForm.showSupervised,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.showSupervised=e),"active-text":"显示","inactive-text":"隐藏","active-color":"#13ce66","inactive-color":"#ff4949","active-value":!0,"inactive-value":!1,style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(F,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(b,{xs:24,sm:24,md:10,lg:10,xl:10},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(x,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(b,{xs:24,sm:24,md:8,lg:8,xl:8},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",kt,[(0,l.Lk)("div",bt,[(0,l.bF)(I,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"100%"}},null,8,["modelValue"]),null!==r.filterForm.minQuantity?((0,l.uX)(),(0,l.Wv)(u,{key:0,class:"clear-icon",onClick:t[8]||(t[8]=e=>r.filterForm.minQuantity=null)},{default:(0,l.k6)((()=>[(0,l.bF)(L)])),_:1})):(0,l.Q3)("",!0)]),t[16]||(t[16]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.Lk)("div",yt,[(0,l.bF)(I,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[9]||(t[9]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"100%"}},null,8,["modelValue","min"]),null!==r.filterForm.maxQuantity?((0,l.uX)(),(0,l.Wv)(u,{key:0,class:"clear-icon",onClick:t[10]||(t[10]=e=>r.filterForm.maxQuantity=null)},{default:(0,l.k6)((()=>[(0,l.bF)(L)])),_:1})):(0,l.Q3)("",!0)])])])),_:1})])),_:1}),(0,l.bF)(b,{xs:24,sm:24,md:6,lg:6,xl:6,class:"filter-buttons-col"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",_t,[(0,l.bF)(c,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("刷新筛选")]))),_:1},8,["onClick"]),(0,l.bF)(c,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])],512),[[o.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",Ft,[(0,l.bF)(R,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",xt,[t[22]||(t[22]=(0,l.Lk)("h3",{class:"table-title"},"所有废物记录",-1)),(0,l.Lk)("div",It,[(0,l.bF)(c,{type:"warning",onClick:r.exportWithoutImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[19]||(t[19]=(0,l.eW)(" 无照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,l.bF)(c,{type:"warning",onClick:r.exportWithImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[20]||(t[20]=(0,l.eW)(" 包含首张照片(推荐) "))])),_:1},8,["onClick","loading"]),(0,l.bF)(c,{type:"warning",onClick:r.exportWithAllImages,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)($)])),_:1}),t[21]||(t[21]=(0,l.eW)(" 包含全部照片(不推荐) "))])),_:1},8,["onClick","loading"])])]),(0,l.Lk)("div",Lt,[(0,l.bo)(((0,l.uX)(),(0,l.Wv)(P,{ref:"tableRef",data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:r.tableHeight},{append:(0,l.k6)((()=>[r.loadingMore?((0,l.uX)(),(0,l.CE)("div",Et,[(0,l.bF)(u,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(T)])),_:1}),t[25]||(t[25]=(0,l.eW)(" 正在加载... "))])):r.hasMore&&r.records.length>0?((0,l.uX)(),(0,l.CE)("div",Kt,[(0,l.bF)(c,{type:"primary",onClick:r.loadMore,disabled:r.loadingMore,size:"small"},{default:(0,l.k6)((()=>[t[26]||(t[26]=(0,l.eW)(" 点击加载更多 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})])),_:1},8,["onClick","disabled"])])):r.records.length>0?((0,l.uX)(),(0,l.CE)("div",Dt," 已全部加载 ")):(0,l.Q3)("",!0)])),default:(0,l.k6)((()=>[(0,l.bF)(W,{type:"index",label:"序号",width:"70",align:"center",index:r.indexMethod},null,8,["index"]),(0,l.bF)(W,{prop:"unit_name",label:"单位","min-width":"100"}),(0,l.bF)(W,{prop:"waste_type_name",label:"废物类型","min-width":"100"}),(0,l.bF)(W,{prop:"location",label:"产生地点","min-width":"100"}),(0,l.bF)(W,{prop:"process",label:"产生工序","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.process||"无"),1)])),_:1}),(0,l.bF)(W,{prop:"remarks",label:"备注","min-width":"120"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.remarks||"无"),1)])),_:1}),(0,l.bF)(W,{prop:"collection_start_time",label:"收集开始时间","min-width":"160"}),(0,l.bF)(W,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(null!==e.row.quantity&&void 0!==e.row.quantity?parseFloat(e.row.quantity).toFixed(3):""),1)])),_:1}),(0,l.bF)(W,{prop:"creator_name",label:"填报人","min-width":"100"}),(0,l.bF)(W,{prop:"created_at",label:"记录时间","min-width":"160"}),(0,l.bF)(W,{label:"清理前照片","min-width":"140",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",Ct,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,Rt)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",$t,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",Wt,"无"))])),_:1}),(0,l.bF)(W,{label:"清理后照片","min-width":"140",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",Vt,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,l.bF)(V,{style:{width:"50px",height:"50px",margin:"0 auto"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,Tt)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",Pt,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",St,"无"))])),_:1}),(0,l.bF)(W,{label:"操作","min-width":"130"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",Ut,[(0,l.bF)(c,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[23]||(t[23]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,l.bF)(c,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[24]||(t[24]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","height"])),[[E,r.loading]])],512),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",At,[(0,l.bF)(S,{description:"暂无废物记录"})]))])),_:1})])]),r.showViewer?((0,l.uX)(),(0,l.Wv)(U,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}const Xt=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},Mt=(e,t)=>{if(!e.photos)return[];try{const a=JSON.parse(e.photos);return Array.isArray(a)?a.filter((e=>e.type===t)):[]}catch(a){return console.error("解析照片JSON失败:",a),[]}};var qt={name:"AdminRecordsView",components:{Plus:A.FWt,Refresh:A.C42,User:A.KJW,ArrowDown:A.yd$,ArrowUp:A.DoI,Download:A.f5X,ElImageViewer:be.Tg,Loading:A.Rhj,CircleClose:A.R$5,Document:A.yoT},setup(){const e=(0,s.rd)(),t=(0,f.KR)([]),a=(0,f.KR)(!1),o=(0,f.KR)([]),r=(0,f.KR)([]),n=(0,f.KR)(!0),i=w.baseURL,d=(0,f.KR)(750),u=(0,f.KR)(null),c=()=>{const e=window.innerHeight,t=Math.min(Math.max(.85*e,650),900);d.value=t,console.log("设置表格高度:",t)},p=()=>{c()},m=(0,f.KR)(!1),v=(0,f.KR)([]),k=(0,f.KR)(0),b=(0,f.KR)(1),y=(0,f.KR)(1),_=(0,f.KR)(20),F=(0,f.KR)(!0),x=(0,f.KR)(!1),I=(0,f.KR)(null),L=(0,f.Kh)({unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:"",process:"",showSupervised:!0}),C=(0,f.KR)(null);(0,l.wB)([()=>L.unitId,()=>L.dateRange,()=>L.wasteTypeId,()=>L.minQuantity,()=>L.maxQuantity,()=>L.location,()=>L.process,()=>L.showSupervised],(()=>{C.value&&clearTimeout(C.value),C.value=setTimeout((()=>{b.value=1,T()}),300)}));const R=(0,l.EW)((()=>t.value.filter((e=>{if(L.unitId&&e.unit_id!==L.unitId)return!1;if(L.wasteTypeId&&e.waste_type_id!==L.wasteTypeId)return!1;if(null!==L.minQuantity&&""!==L.minQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)<L.minQuantity)return!1;if(null!==L.maxQuantity&&""!==L.maxQuantity&&null!==e.quantity&&void 0!==e.quantity&&parseFloat(e.quantity)>L.maxQuantity)return!1;if(L.location&&!e.location.toLowerCase().includes(L.location.toLowerCase()))return!1;if(L.process&&!e.process?.toLowerCase().includes(L.process.toLowerCase()))return!1;if(L.dateRange&&2===L.dateRange.length){const t=new Date(L.dateRange[0]),a=new Date(L.dateRange[1]);if(a.setHours(23,59,59,999),!e.collection_start_time)return!1;{const o=$(e.collection_start_time);if(o<t||o>a)return!1}}return!0})))),$=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)};(0,l.sV)((async()=>{if(3!==Ba.state.user.role_id&&4!==Ba.state.user.role_id)return g.nk.error("权限不足"),void e.push("/login");await W(),await V(),T(),c(),window.addEventListener("resize",p)})),(0,l.hi)((()=>{window.removeEventListener("resize",p)}));const W=async()=>{try{const e=await h.A.get(w.getUrl(w.endpoints.units));o.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},V=async()=>{try{const e=await h.A.get(w.getUrl(w.endpoints.wasteTypes));r.value=e.data}catch(e){console.error("获取废物类型列表失败:",e),g.nk.error("获取废物类型列表失败")}},T=async(e=!1)=>{console.log(`开始加载数据，是否加载更多: ${e}`),e?(x.value=!0,console.log(`加载更多: 当前page=${b.value}, currentPage=${y.value}`)):(a.value=!0,b.value=1,y.value=1,t.value=[],console.log("初始化加载: 重置页码和记录"));try{const a={page:b.value,pageSize:_.value,wasteTypeId:L.wasteTypeId,minQuantity:L.minQuantity,maxQuantity:L.maxQuantity,location:L.location,process:L.process,showSupervised:L.showSupervised?"true":"false",unitId:L.unitId?L.unitId:void 0};console.log("发送请求参数:",a),L.dateRange&&2===L.dateRange.length&&(a.dateRange=JSON.stringify(L.dateRange));const o=await Ta.get(`${w.endpoints.wasteRecords}/user/${Ba.state.user.id}`,a);console.log("服务器返回数据:",{recordsCount:o.data.records.length,hasMore:o.data.hasMore});const l=o.data.records.map((e=>({...e,created_at:P(e.created_at),collection_start_time:P(e.collection_start_time)})));e?(t.value=[...t.value,...l],console.log(`追加${l.length}条记录，现在总共有${t.value.length}条记录`)):(t.value=l,console.log(`加载了${l.length}条新记录`)),F.value=o.data.hasMore,console.log(`服务器是否有更多数据: ${F.value}`),F.value?(b.value++,console.log(`有更多数据，下一页将是: page=${b.value}`)):console.log("没有更多数据了")}catch(o){console.error("获取废物记录失败:",o),g.nk.error("获取废物记录失败")}finally{a.value=!1,x.value=!1,console.log(`加载完成，状态: loading=${a.value}, loadingMore=${x.value}`)}},P=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})},S=()=>{T()},U=()=>{3===Ba.state.user.role_id||4===Ba.state.user.role_id?e.push("/record/new"):e.push(`/unit/${Ba.state.user.unit_id}`)},E=()=>{e.push("/user-management")},K=()=>{e.push("/operation-logs")},D=t=>{e.push(`/record/${t}`)},A=async()=>{await T(),g.nk.success("筛选已应用")},Q=async()=>{L.unitId=null,L.dateRange=null,L.wasteTypeId=null,L.minQuantity=null,L.maxQuantity=null,L.location="",L.process="",L.showSupervised=!0,await T(),g.nk.info("筛选条件已重置")},X=async()=>{try{(0,g.nk)({message:"导出大量包含图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=_e.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:L.wasteTypeId?L.wasteTypeId:void 0,minQuantity:L.minQuantity?L.minQuantity:void 0,maxQuantity:L.maxQuantity?L.maxQuantity:void 0,location:L.location||void 0,process:L.process||void 0,dateRange:L.dateRange?JSON.stringify(L.dateRange):void 0,unitId:L.unitId?L.unitId:void 0,showSupervised:L.showSupervised?"true":"false"};console.log("导出记录的筛选条件:",t);const{data:l}=await Ta.get(`${w.endpoints.exportWasteRecords}/${Ba.state.user.id}`,t);if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return e.close(),g.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=L.unitId?o.value.find((e=>e.id===L.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_${r}`,s=200,i=l.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),g.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录...`);let u=0;for(let a=0;a<d;a++){const t=a*s,o=Math.min((a+1)*s,i),r=l.slice(t,o),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${o}条记录...`);const p=r.map((e=>{const t=Xt(e.photo_path_before),a=Xt(e.photo_path_after);return{"单位":e.unit_name,"废物类型":e.waste_type_name,"产生地点":e.location,"产生工序":e.process||"无","备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at),"清理前照片":t.length>0?t[0]:"","清理后照片":a.length>0?a[0]:""}})),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片",isImage:!0},{text:"清理后照片",field:"清理后照片",isImage:!0}],g=window.location.origin,f=(t,o)=>{const l=Math.round(t/o*100);e.setText(`正在导出第${a+1}/${d}部分：${l}% (${t}/${o})`)},h=await $e(p,c,m,g,f);h&&u++}e.close(),u===d?d>1?g.nk.success(`成功导出${d}个文件`):g.nk.success("导出成功"):u>0?g.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):g.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,_e.Ks.service().close()}},M=async()=>{try{(0,g.nk)({message:"导出大量包含全部图片的记录所需时间较长，请耐心等待",type:"info",duration:5e3});const e=_e.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:L.wasteTypeId?L.wasteTypeId:void 0,minQuantity:L.minQuantity?L.minQuantity:void 0,maxQuantity:L.maxQuantity?L.maxQuantity:void 0,location:L.location||void 0,process:L.process||void 0,dateRange:L.dateRange?JSON.stringify(L.dateRange):void 0,unitId:L.unitId?L.unitId:void 0,showSupervised:L.showSupervised?"true":"false"};console.log("导出记录的筛选条件:",t);const{data:l}=await Ta.get(`${w.endpoints.exportWasteRecords}/${Ba.state.user.id}`,t);if(console.log(`从后端获取到 ${l.length} 条记录用于导出`),0===l.length)return e.close(),g.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=L.unitId?o.value.find((e=>e.id===L.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_全部照片_${r}`,s=50,i=l.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),g.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录的全部照片...`);let u=0;for(let a=0;a<d;a++){const t=a*s,o=Math.min((a+1)*s,i),r=l.slice(t,o),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${o}条记录...`);const p=r.map((e=>{const t=Xt(e.photo_path_before),a=Xt(e.photo_path_after),o={"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at)};for(let l=0;l<5;l++)o[`清理前照片${l+1}`]=l<t.length?t[l]:"";for(let l=0;l<5;l++)o[`清理后照片${l+1}`]=l<a.length?a[l]:"";return o})),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生工序",field:"产生工序"},{text:"产生地点",field:"产生地点"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"}];for(let e=0;e<5;e++)m.push({text:`清理前照片${e+1}`,field:`清理前照片${e+1}`,isImage:!0});for(let e=0;e<5;e++)m.push({text:`清理后照片${e+1}`,field:`清理后照片${e+1}`,isImage:!0});const g=window.location.origin,f=(t,o)=>{const l=Math.round(t/o*100);e.setText(`正在导出第${a+1}/${d}部分：${l}% (${t}/${o})`)},h=await $e(p,c,m,g,f);h&&u++}e.close(),u===d?d>1?g.nk.success(`成功导出${d}个文件`):g.nk.success("导出成功"):u>0?g.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):g.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,_e.Ks.service().close()}},q=async()=>{try{const e=_e.Ks.service({lock:!0,text:"正在导出记录，请稍候...",background:"rgba(0, 0, 0, 0.7)"});a.value=!0;const t={wasteTypeId:L.wasteTypeId?L.wasteTypeId:void 0,minQuantity:L.minQuantity?L.minQuantity:void 0,maxQuantity:L.maxQuantity?L.maxQuantity:void 0,location:L.location||void 0,process:L.process||void 0,dateRange:L.dateRange?JSON.stringify(L.dateRange):void 0,unitId:L.unitId?L.unitId:void 0,showSupervised:L.showSupervised?"true":"false"},{data:l}=await Ta.get(`${w.endpoints.exportWasteRecords}/${Ba.state.user.id}`,t);if(0===l.length)return e.close(),g.nk.warning("没有符合条件的记录可导出"),void(a.value=!1);const r=L.unitId?o.value.find((e=>e.id===L.unitId))?.name||"未知单位":"全部单位",n=`固体废物记录_${r}`,s=1e3,i=l.length,d=Math.ceil(i/s);d>1?(e.setText(`数据较多(${i}条)，将拆分为${d}个文件导出...`),g.nk.info(`数据较多(${i}条)，将拆分为${d}个文件导出`)):e.setText(`准备导出 ${i} 条记录...`);let u=0;for(let a=0;a<d;a++){const t=a*s,o=Math.min((a+1)*s,i),r=l.slice(t,o),c=d>1?`${n}_第${a+1}部分(共${d}部分)`:n;e.setText(`正在处理第${a+1}/${d}批次，${t+1}-${o}条记录...`);const p=r.map((e=>({"单位":e.unit_name,"废物类型":e.waste_type_name,"产生工序":e.process||"无","产生地点":e.location,"备注":e.remarks||"无","收集开始时间":P(e.collection_start_time),"数量(吨)":e.quantity,"填报人":e.creator_name||"系统","记录时间":P(e.created_at),"清理前照片":e.photo_path_before?"有":"无","清理后照片":e.photo_path_after?"有":"无"}))),m=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"产生地点",field:"产生地点"},{text:"产生工序",field:"产生工序"},{text:"备注",field:"备注"},{text:"收集开始时间",field:"收集开始时间"},{text:"数量(吨)",field:"数量(吨)"},{text:"填报人",field:"填报人"},{text:"记录时间",field:"记录时间"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}],g=await We(p,c,m);g&&u++}e.close(),u===d?d>1?g.nk.success(`成功导出${d}个文件`):g.nk.success("导出成功"):u>0?g.nk.warning(`部分导出成功，完成了${u}/${d}个文件`):g.nk.error("导出失败，请重试")}catch(e){console.error("导出记录失败:",e),g.nk.error("导出失败: "+(e.message||"未知错误"))}finally{a.value=!1,_e.Ks.service().close()}},B=e=>{ye.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await Ta.delete(`${w.getUrl(w.endpoints.wasteRecords)}/${e.id}`),g.nk.success("删除成功"),await T()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败")}})).catch((()=>{g.nk.info("已取消删除")}))},z=(e,t)=>{const a=Array.isArray(e)?e:[e];v.value=a.map((e=>`${i}${e}`)),k.value=t||0,m.value=!0},O=()=>{m.value=!1},j=()=>{console.log("手动触发加载更多");const e=document.querySelector(".el-table__body-wrapper"),a=e?e.scrollTop:0;return T(!0).then((()=>{console.log("加载完成，当前记录数:",t.value.length),setTimeout((()=>{e&&(e.scrollTop=a)}),10)})).catch((e=>{console.error("加载失败:",e),g.nk.error("加载更多数据失败")}))},N=e=>e+1,Y=(0,l.EW)((()=>Ba.state.isLoggedIn&&3===Ba.state.user.role_id)),H=(0,l.EW)((()=>Ba.state.isLoggedIn&&Ba.state.user&&1===Ba.state.user.can_view_logs));return{records:t,filteredRecords:R,loading:a,units:o,wasteTypes:r,showFilterPanel:n,filterForm:L,applyFilter:A,resetFilter:Q,exportWithImages:X,exportWithAllImages:M,exportWithoutImages:q,parsePhotoPath:Xt,getPhotosByType:Mt,refreshRecords:S,addNewRecord:U,goToUserManagement:E,goToOperationLogs:K,editRecord:D,confirmDelete:B,showViewer:m,previewImages:v,previewIndex:k,previewPhoto:z,closeViewer:O,baseUrl:i,page:b,currentPage:y,pageSize:_,hasMore:F,loadingMore:x,indexMethod:N,tableHeight:d,debounceTimer:C,tableRef:I,loadMore:j,tableContainer:u,isSuperAdmin:Y,canViewLogs:H}}};const Bt=(0,I.A)(qt,[["render",Qt],["__scopeId","data-v-049ed27b"]]);var zt=Bt;const Ot={class:"user-profile-container"},jt={class:"header"},Nt={class:"content"};function Yt(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),i=(0,l.g2)("el-icon"),d=(0,l.g2)("el-input"),u=(0,l.g2)("el-form-item"),c=(0,l.g2)("el-divider"),p=(0,l.g2)("el-button"),m=(0,l.g2)("el-form"),g=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",Ot,[(0,l.Lk)("div",jt,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(i,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[6]||(t[6]=(0,l.eW)(" 返回 "))]),t[7]||(t[7]=(0,l.Lk)("h1",null,"个人账户设置",-1)),t[8]||(t[8]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Nt,[(0,l.bF)(g,{class:"profile-card"},{header:(0,l.k6)((()=>t[9]||(t[9]=[(0,l.Lk)("div",{class:"card-header"},[(0,l.Lk)("h3",null,"账户信息")],-1)]))),default:(0,l.k6)((()=>[(0,l.bF)(m,{ref:"profileForm",model:o.form,rules:o.rules,"label-position":"top",class:"profile-form"},{default:(0,l.k6)((()=>[(0,l.bF)(u,{label:"手机号码"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.phone,"onUpdate:modelValue":t[1]||(t[1]=e=>o.form.phone=e),disabled:"",placeholder:"手机号码"},null,8,["modelValue"]),t[10]||(t[10]=(0,l.Lk)("div",{class:"field-hint"},"手机号码不可修改",-1))])),_:1}),(0,l.bF)(u,{label:"用户名",prop:"username"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.username,"onUpdate:modelValue":t[2]||(t[2]=e=>o.form.username=e),placeholder:"请输入您的名字"},null,8,["modelValue"])])),_:1}),(0,l.bF)(c,null,{default:(0,l.k6)((()=>t[11]||(t[11]=[(0,l.eW)("修改密码（可选）")]))),_:1}),(0,l.bF)(u,{label:"原密码",prop:"oldPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.oldPassword,"onUpdate:modelValue":t[3]||(t[3]=e=>o.form.oldPassword=e),placeholder:"请输入原密码",type:"password","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,{label:"新密码",prop:"newPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.newPassword,"onUpdate:modelValue":t[4]||(t[4]=e=>o.form.newPassword=e),placeholder:"请输入新密码",type:"password","show-password":""},null,8,["modelValue"]),t[12]||(t[12]=(0,l.Lk)("div",{class:"field-hint"},"如不修改密码，请留空",-1))])),_:1}),(0,l.bF)(u,{label:"确认新密码",prop:"confirmPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(d,{modelValue:o.form.confirmPassword,"onUpdate:modelValue":t[5]||(t[5]=e=>o.form.confirmPassword=e),placeholder:"请再次输入新密码",type:"password","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(p,{type:"primary",onClick:o.saveProfile,loading:o.loading},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)(" 保存修改 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules"])])),_:1})])])}var Ht={name:"UserProfile",components:{ArrowLeft:A.nkM},setup(){const e=(0,s.rd)(),t=(0,f.KR)(null),a=(0,f.KR)(!1),o=(0,f.Kh)({username:"",phone:"",oldPassword:"",newPassword:"",confirmPassword:""}),r=(0,f.Kh)({username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度应为2-20个字符",trigger:"blur"}],oldPassword:[{validator:(e,t,a)=>{o.newPassword&&!t?a(new Error("修改密码时需要输入原密码")):a()},trigger:"blur"}],newPassword:[{min:1,max:20,message:"密码长度应为1-20个字符",trigger:"blur"}],confirmPassword:[{validator:(e,t,a)=>{o.newPassword?t?t!==o.newPassword?a(new Error("两次输入的密码不一致")):a():a(new Error("请再次输入新密码")):a()},trigger:"blur"}]});(0,l.sV)((()=>{if(!Ba.state.isLoggedIn)return g.nk.error("请先登录"),void e.push("/login");o.username=Ba.state.user.username||"",o.phone=Ba.state.user.phone||""}));const n=()=>{e.go(-1)},i=async()=>{if(Ba.state.isLoggedIn)try{await t.value.validate(),await ye.s.confirm("确定要保存这些修改吗？","确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),a.value=!0;const e={username:o.username};o.newPassword&&(e.oldPassword=o.oldPassword,e.newPassword=o.newPassword),await Ta.put(w.getUrl(`/api/users/${Ba.state.user.id}/profile`),e),Ba.updateUserInfo({...Ba.state.user,username:o.username}),g.nk.success("个人资料已更新"),o.oldPassword="",o.newPassword="",o.confirmPassword="",setTimeout((()=>{n()}),1500)}catch(e){if("cancel"===e)return;e.response&&e.response.data&&e.response.data.error?g.nk.error(e.response.data.error):e.message?g.nk.error(e.message):g.nk.error("保存失败，请重试")}finally{a.value=!1}else g.nk.error("请先登录")};return{profileForm:t,form:o,rules:r,loading:a,goBack:n,saveProfile:i}}};const Jt=(0,I.A)(Ht,[["render",Yt],["__scopeId","data-v-6ab973ca"]]);var Gt=Jt;const Zt={class:"operation-logs-container"},ea={class:"header"},ta={class:"content"},aa={class:"filter-section"},oa={class:"filter-header"},la={class:"stats-section"},ra={class:"stat-content"},na={class:"stat-number"},sa={class:"stat-content"},ia={class:"stat-number"},da={class:"stat-content"},ua={class:"stat-number"},ca={class:"stat-content"},pa={class:"stat-number"},ma={class:"table-section"},ga={class:"table-header"},fa={class:"total-count"},ha={class:"phone-text"},va={class:"description-text"},wa={class:"pagination-section"},ka={key:0,class:"detail-content"},ba={class:"user-agent-text"},ya={class:"description-detail"},_a={key:0,class:"additional-data"};function Fa(e,t,a,o,r,n){const s=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),u=(0,l.g2)("refresh"),c=(0,l.g2)("el-button"),p=(0,l.g2)("el-option"),m=(0,l.g2)("el-select"),g=(0,l.g2)("el-form-item"),f=(0,l.g2)("search"),h=(0,l.g2)("el-input"),v=(0,l.g2)("el-date-picker"),w=(0,l.g2)("el-form"),k=(0,l.g2)("el-card"),b=(0,l.g2)("el-col"),y=(0,l.g2)("el-row"),_=(0,l.g2)("el-table-column"),F=(0,l.g2)("el-tag"),x=(0,l.g2)("el-tooltip"),I=(0,l.g2)("el-table"),L=(0,l.g2)("el-pagination"),C=(0,l.g2)("el-descriptions-item"),R=(0,l.g2)("el-descriptions"),$=(0,l.g2)("el-dialog"),W=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Zt,[(0,l.Lk)("div",ea,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>o.goBack&&o.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[9]||(t[9]=(0,l.eW)(" 返回 "))]),t[10]||(t[10]=(0,l.Lk)("h1",null,"操作日志管理",-1)),t[11]||(t[11]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",ta,[(0,l.Lk)("div",aa,[(0,l.bF)(k,null,{header:(0,l.k6)((()=>[(0,l.Lk)("div",oa,[t[13]||(t[13]=(0,l.Lk)("span",null,[(0,l.eW)("筛选条件 "),(0,l.Lk)("small",{style:{color:"#909399"}})],-1)),(0,l.bF)(c,{type:"primary",link:"",onClick:o.resetFilters},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[12]||(t[12]=(0,l.eW)(" 重置筛选 "))])),_:1},8,["onClick"])])])),default:(0,l.k6)((()=>[(0,l.bF)(w,{model:o.filters,inline:""},{default:(0,l.k6)((()=>[(0,l.bF)(g,{label:"操作类型"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:o.filters.operationType,"onUpdate:modelValue":t[1]||(t[1]=e=>o.filters.operationType=e),placeholder:"选择操作类型",clearable:"",style:{width:"140px"}},{default:(0,l.k6)((()=>[(0,l.bF)(p,{label:"登录",value:"login"}),(0,l.bF)(p,{label:"创建",value:"create"}),(0,l.bF)(p,{label:"更新",value:"update"}),(0,l.bF)(p,{label:"删除",value:"delete"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(g,{label:"操作人员"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:o.filters.userKeyword,"onUpdate:modelValue":t[2]||(t[2]=e=>o.filters.userKeyword=e),placeholder:"输入用户名或手机号搜索",clearable:"",style:{width:"200px"}},{prefix:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(g,{label:"时间范围"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:o.dateRange,"onUpdate:modelValue":t[3]||(t[3]=e=>o.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:o.handleDateChange,style:{width:"280px"}},null,8,["modelValue","onChange"])])),_:1}),(0,l.bF)(g,{label:"描述关键词"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:o.filters.description,"onUpdate:modelValue":t[4]||(t[4]=e=>o.filters.description=e),placeholder:"输入关键词搜索",style:{width:"200px"},clearable:""},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1})]),(0,l.Lk)("div",la,[(0,l.bF)(y,{gutter:16},{default:(0,l.k6)((()=>[(0,l.bF)(b,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(k,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ra,[(0,l.Lk)("div",na,(0,i.v_)(o.totalStats.login||0),1),t[14]||(t[14]=(0,l.Lk)("div",{class:"stat-label"},"登录操作",-1))])])),_:1})])),_:1}),(0,l.bF)(b,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(k,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",sa,[(0,l.Lk)("div",ia,(0,i.v_)(o.totalStats.create||0),1),t[15]||(t[15]=(0,l.Lk)("div",{class:"stat-label"},"创建操作",-1))])])),_:1})])),_:1}),(0,l.bF)(b,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(k,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",da,[(0,l.Lk)("div",ua,(0,i.v_)(o.totalStats.update||0),1),t[16]||(t[16]=(0,l.Lk)("div",{class:"stat-label"},"更新操作",-1))])])),_:1})])),_:1}),(0,l.bF)(b,{span:6},{default:(0,l.k6)((()=>[(0,l.bF)(k,{class:"stat-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ca,[(0,l.Lk)("div",pa,(0,i.v_)(o.totalStats.delete||0),1),t[17]||(t[17]=(0,l.Lk)("div",{class:"stat-label"},"删除操作",-1))])])),_:1})])),_:1})])),_:1})]),(0,l.Lk)("div",ma,[(0,l.bF)(k,null,{header:(0,l.k6)((()=>[(0,l.Lk)("div",ga,[t[18]||(t[18]=(0,l.Lk)("span",null,"操作日志列表",-1)),(0,l.Lk)("span",fa,"共 "+(0,i.v_)(o.pagination.total)+" 条记录",1)])])),default:(0,l.k6)((()=>[(0,l.bo)(((0,l.uX)(),(0,l.Wv)(I,{data:o.logs,style:{width:"100%"},size:"small"},{default:(0,l.k6)((()=>[(0,l.bF)(_,{prop:"id",label:"ID",width:"60"}),(0,l.bF)(_,{prop:"created_at",label:"操作时间",width:"160"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(o.formatDateTime(e.row.created_at)),1)])),_:1}),(0,l.bF)(_,{prop:"operation_type",label:"操作类型",width:"80"},{default:(0,l.k6)((e=>[(0,l.bF)(F,{type:o.getOperationTypeColor(e.row.operation_type),size:"small"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.getOperationTypeName(e.row.operation_type)),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(_,{prop:"target_type",label:"目标类型",width:"100"},{default:(0,l.k6)((e=>[(0,l.bF)(F,{type:"info",size:"small"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.getTargetTypeName(e.row.target_type)),1)])),_:2},1024)])),_:1}),(0,l.bF)(_,{label:"操作人员",width:"120"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",null,[(0,l.Lk)("div",null,(0,i.v_)(e.row.username||"未知"),1),(0,l.Lk)("div",ha,(0,i.v_)(e.row.phone||"-"),1)])])),_:1}),(0,l.bF)(_,{prop:"role_name",label:"角色",width:"80"}),(0,l.bF)(_,{prop:"description",label:"操作描述","min-width":"300"},{default:(0,l.k6)((e=>[(0,l.bF)(x,{content:e.row.description,placement:"top"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",va,(0,i.v_)(e.row.description),1)])),_:2},1032,["content"])])),_:1}),(0,l.bF)(_,{prop:"ip_address",label:"IP地址",width:"120"}),(0,l.bF)(_,{label:"操作",width:"80"},{default:(0,l.k6)((e=>[(0,l.bF)(c,{type:"primary",link:"",size:"small",onClick:t=>o.showDetail(e.row)},{default:(0,l.k6)((()=>t[19]||(t[19]=[(0,l.eW)(" 详情 ")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[W,o.loading]]),(0,l.Lk)("div",wa,[(0,l.bF)(L,{"current-page":o.pagination.page,"onUpdate:currentPage":t[5]||(t[5]=e=>o.pagination.page=e),"page-size":o.pagination.pageSize,"onUpdate:pageSize":t[6]||(t[6]=e=>o.pagination.pageSize=e),"page-sizes":[10,20,50,100],total:o.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:o.handleSizeChange,onCurrentChange:o.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])])),_:1})])]),(0,l.bF)($,{modelValue:o.detailVisible,"onUpdate:modelValue":t[8]||(t[8]=e=>o.detailVisible=e),title:"操作日志详情",width:"60%","close-on-click-modal":!1},{footer:(0,l.k6)((()=>[(0,l.bF)(c,{onClick:t[7]||(t[7]=e=>o.detailVisible=!1)},{default:(0,l.k6)((()=>t[21]||(t[21]=[(0,l.eW)("关闭")]))),_:1})])),default:(0,l.k6)((()=>[o.selectedLog?((0,l.uX)(),(0,l.CE)("div",ka,[(0,l.bF)(R,{column:2,border:""},{default:(0,l.k6)((()=>[(0,l.bF)(C,{label:"日志ID"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.id),1)])),_:1}),(0,l.bF)(C,{label:"操作时间"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.formatDateTime(o.selectedLog.created_at)),1)])),_:1}),(0,l.bF)(C,{label:"操作类型"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{type:o.getOperationTypeColor(o.selectedLog.operation_type)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.getOperationTypeName(o.selectedLog.operation_type)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(C,{label:"目标类型"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{type:"info"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.getTargetTypeName(o.selectedLog.target_type)),1)])),_:1})])),_:1}),(0,l.bF)(C,{label:"目标ID"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.target_id||"-"),1)])),_:1}),(0,l.bF)(C,{label:"操作人员"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.username||"未知"),1)])),_:1}),(0,l.bF)(C,{label:"手机号"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.phone||"-"),1)])),_:1}),(0,l.bF)(C,{label:"角色"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.role_name||"-"),1)])),_:1}),(0,l.bF)(C,{label:"IP地址"},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(o.selectedLog.ip_address||"-"),1)])),_:1}),(0,l.bF)(C,{label:"用户代理",span:"2"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ba,(0,i.v_)(o.selectedLog.user_agent||"-"),1)])),_:1}),(0,l.bF)(C,{label:"操作描述",span:"2"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ya,(0,i.v_)(o.selectedLog.description),1)])),_:1})])),_:1}),o.selectedLog.additional_data?((0,l.uX)(),(0,l.CE)("div",_a,[t[20]||(t[20]=(0,l.Lk)("h4",null,"附加数据",-1)),(0,l.bF)(h,{type:"textarea",rows:10,value:o.formatAdditionalData(o.selectedLog.additional_data),readonly:""},null,8,["value"])])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)])),_:1},8,["modelValue"]),t[22]||(t[22]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 固体废物管理系统")],-1))])}var xa={name:"OperationLogsView",components:{ArrowLeft:A.nkM,Search:A.vji,Refresh:A.C42},setup(){const e=(0,s.rd)(),t=(0,f.KR)(!1),a=(0,f.KR)([]),o=(0,f.KR)({}),r=(0,f.KR)(!1),n=(0,f.KR)(null),i=(0,f.KR)([]),d=(0,f.Kh)({operationType:"",userKeyword:"",startDate:"",endDate:"",description:""}),u=(0,f.Kh)({page:1,pageSize:20,total:0}),c=(0,l.EW)((()=>Ba.state.isLoggedIn&&Ba.state.user&&1===Ba.state.user.can_view_logs));let p=null;(0,l.wB)([()=>d.operationType,()=>d.userKeyword,()=>d.startDate,()=>d.endDate,()=>d.description],(()=>{p&&clearTimeout(p),p=setTimeout((()=>{u.page=1,m(),h()}),500)})),(0,l.sV)((async()=>{if(!c.value)return g.nk.error("您没有权限查看操作日志"),void e.push("/");await Promise.all([m(),h()])})),(0,l.hi)((()=>{p&&(clearTimeout(p),p=null)}));const m=async()=>{try{t.value=!0;const e={page:u.page,pageSize:u.pageSize};d.operationType&&""!==d.operationType.trim()&&(e.operationType=d.operationType),d.userKeyword&&""!==d.userKeyword.trim()&&(e.userKeyword=d.userKeyword),d.startDate&&""!==d.startDate.trim()&&(e.startDate=d.startDate),d.endDate&&""!==d.endDate.trim()&&(e.endDate=d.endDate),d.description&&""!==d.description.trim()&&(e.description=d.description);const o=await Ta.get(w.endpoints.operationLogs,e);a.value=o.data.logs||[],u.total=o.data.pagination.total||0}catch(e){console.error("获取操作日志失败:",e),g.nk.error("获取操作日志失败")}finally{t.value=!1}},h=async()=>{try{const e={};d.startDate&&""!==d.startDate.trim()&&(e.startDate=d.startDate),d.endDate&&""!==d.endDate.trim()&&(e.endDate=d.endDate);const t=await Ta.get(`${w.endpoints.operationLogs}/stats`,e),a=t.data.totalStats||[],l={};a.forEach((e=>{l[e.operation_type]=e.total_count})),o.value=l}catch(e){console.error("获取统计信息失败:",e),o.value={login:0,create:0,update:0,delete:0}}},v=()=>{Object.keys(d).forEach((e=>{d[e]=""})),i.value=[],u.page=1},k=e=>{e&&2===e.length?(d.startDate=e[0],d.endDate=e[1]):(d.startDate="",d.endDate="")},b=e=>{u.pageSize=e,u.page=1,m()},y=e=>{u.page=e,m()},_=e=>{n.value=e,r.value=!0},F=e=>e?new Date(e).toLocaleString("zh-CN"):"-",x=e=>{const t={login:"登录",create:"创建",update:"更新",delete:"删除"};return t[e]||e},I=e=>{const t={login:"",create:"success",update:"warning",delete:"danger"};return t[e]||""},L=e=>{const t={waste_record:"废物记录",user:"用户管理",unit:"单位管理",waste_type:"废物类型"};return t[e]||e||"-"},C=e=>{if(!e)return"";try{const t="string"===typeof e?JSON.parse(e):e;return JSON.stringify(t,null,2)}catch(t){return e.toString()}},R=()=>{e.go(-1)};return{loading:t,logs:a,totalStats:o,filters:d,pagination:u,dateRange:i,detailVisible:r,selectedLog:n,hasPermission:c,fetchLogs:m,resetFilters:v,handleDateChange:k,handleSizeChange:b,handleCurrentChange:y,showDetail:_,formatDateTime:F,getOperationTypeName:x,getOperationTypeColor:I,getTargetTypeName:L,formatAdditionalData:C,goBack:R}}};const Ia=(0,I.A)(xa,[["render",Fa],["__scopeId","data-v-9351c582"]]);var La=Ia;const Ca=[{path:"/login",name:"Login",component:Xe,meta:{requiresAuth:!1}},{path:"/user-management",name:"UserManagement",component:mt,meta:{requiresAuth:!0,requiresManager:!0}},{path:"/profile",name:"UserProfile",component:Gt,meta:{requiresAuth:!0}},{path:"/operation-logs",name:"OperationLogs",component:La,meta:{requiresAuth:!0,requiresLogPermission:!0}},{path:"/",name:"UnitSelection",component:C,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/admin-records",name:"AdminRecords",component:zt,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/record/new",name:"EditRecord",component:tt,props:{id:null},meta:{requiresAuth:!0}},{path:"/record/:id",name:"EditRecord",component:tt,props:!0,meta:{requiresAuth:!0}},{path:"/unit/:id",name:"WasteForm",component:B,props:!0,meta:{requiresAuth:!0}},{path:"/records/:unitId",name:"RecordsList",component:Se,props:!0,meta:{requiresAuth:!0}}],Ra=(0,s.aE)({history:(0,s.LA)("/"),routes:Ca});Ra.beforeEach(((e,t,a)=>{const o=e.matched.some((e=>e.meta.requiresAuth)),l=e.matched.some((e=>e.meta.requiresSuperAdmin)),r=e.matched.some((e=>e.meta.requiresManager)),n=e.matched.some((e=>e.meta.requiresLogPermission));if(!o||Ba.state.isLoggedIn)if(n&&Ba.state.isLoggedIn&&1!==Ba.state.user.can_view_logs)3===Ba.state.user.role_id?a({name:"AdminRecords"}):4===Ba.state.user.role_id?a({name:"EditRecord",params:{id:null}}):a({name:"WasteForm",params:{id:Ba.state.user.unit_id}});else if(l&&Ba.state.isLoggedIn&&3!==Ba.state.user.role_id&&4!==Ba.state.user.role_id)a({name:"WasteForm",params:{id:Ba.state.user.unit_id}});else if(!r||!Ba.state.isLoggedIn||1!==Ba.state.user.role_id&&4!==Ba.state.user.role_id){if("Login"!==e.name||!Ba.state.isLoggedIn)return"/"===e.path&&Ba.state.isLoggedIn?3===Ba.state.user.role_id?void a({name:"AdminRecords"}):4===Ba.state.user.role_id?void a({name:"EditRecord",params:{id:null}}):(Ba.state.user.role_id,void a({name:"WasteForm",params:{id:Ba.state.user.unit_id}})):void("WasteForm"===e.name&&Ba.state.isLoggedIn&&3!==Ba.state.user.role_id&&4!==Ba.state.user.role_id&&Ba.state.user.unit_id!==parseInt(e.params.id)?a({name:"WasteForm",params:{id:Ba.state.user.unit_id}}):a());3===Ba.state.user.role_id?a({name:"AdminRecords"}):4===Ba.state.user.role_id?a({name:"EditRecord",params:{id:null}}):(Ba.state.user.role_id,a({name:"WasteForm",params:{id:Ba.state.user.unit_id}}))}else a({name:"WasteForm",params:{id:Ba.state.user.unit_id}});else a({name:"Login"})}));var $a=Ra;const Wa=h.A.create({baseURL:w.baseURL,timeout:3e5,headers:{"Content-Type":"application/json"},maxContentLength:52428800,maxBodyLength:52428800});Wa.interceptors.request.use((e=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return t&&(e.headers.Authorization=`Bearer ${t}`),e}),(e=>(console.error("Request error:",e),Promise.reject(e)))),Wa.interceptors.response.use((e=>e),(e=>{if(e.response)switch(e.response.status){case 401:if(e.config.url.includes("/api/login"))return Promise.reject(e);Ba.logout(),g.nk.error("登录已过期，请重新登录"),$a.push("/login");break;case 403:g.nk.error("没有权限访问该资源");break;case 404:g.nk.error("请求的资源不存在");break;case 500:g.nk.error("服务器错误，请稍后重试");break;default:g.nk.error(e.response.data?.error||"请求失败")}else e.request?g.nk.error("网络错误，请检查网络连接"):g.nk.error("请求配置错误");return Promise.reject(e)}));const Va={get(e,t={}){return Wa.get(e,{params:t})},post(e,t={}){return Wa.post(e,t)},postForm(e,t,a){const o={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};"function"===typeof a&&(o.onUploadProgress=a);const l=localStorage.getItem("token")||sessionStorage.getItem("token");return l&&(o.headers.Authorization=`Bearer ${l}`),Wa.post(e,t,o)},put(e,t={}){return Wa.put(e,t)},putForm(e,t,a){const o={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};"function"===typeof a&&(o.onUploadProgress=a);const l=localStorage.getItem("token")||sessionStorage.getItem("token");return l&&(o.headers.Authorization=`Bearer ${l}`),Wa.put(e,t,o)},delete(e){return Wa.delete(e)},defaults:Wa.defaults};var Ta=Va;const Pa={user:null,token:null,isLoggedIn:!1,loading:!1,error:null},Sa=(0,f.Kh)({...Pa}),Ua=()=>{const e=localStorage.getItem("user"),t=localStorage.getItem("token");if(e&&t)try{const a=JSON.parse(e);Sa.user=a,Sa.token=t,Sa.isLoggedIn=!0,Ta.defaults&&Ta.defaults.headers&&(Ta.defaults.headers.common["Authorization"]=`Bearer ${t}`)}catch(a){console.error("Error parsing saved user data:",a),localStorage.removeItem("user"),localStorage.removeItem("token")}},Ea=async(e,t,a=!1)=>{Sa.loading=!0,Sa.error=null,console.log("auth.login 开始执行，手机号:",e);try{const l={phone:e,rememberMe:a};null!==t&&void 0!==t&&""!==t?(l.password=t,console.log("auth.login 发送密码参数")):console.log("auth.login 不发送密码参数"),console.log("发送登录请求，数据:",l);const r=await Ta.post(w.endpoints.login,l);console.log("登录请求成功响应:",r.data);const{token:n,...s}=r.data;Sa.user=s,Sa.token=n,Sa.isLoggedIn=!0,Ta.defaults&&Ta.defaults.headers&&(Ta.defaults.headers.common["Authorization"]=`Bearer ${n}`),a?(localStorage.setItem("user",JSON.stringify(s)),localStorage.setItem("token",n)):(sessionStorage.setItem("user",JSON.stringify(s)),sessionStorage.setItem("token",n),localStorage.removeItem("user"),localStorage.removeItem("token"));try{"caches"in window&&caches.keys().then((e=>{e.forEach((e=>{caches.delete(e)}))}))}catch(o){console.warn("清除缓存失败:",o)}return{success:!0,user:s}}catch(l){return Sa.error=l.response?.data?.error||"登录失败，请检查网络连接",console.error("Login error:",l),{success:!1,error:Sa.error}}finally{Sa.loading=!1}},Ka=()=>{Sa.user=null,Sa.token=null,Sa.isLoggedIn=!1,Ta.defaults&&Ta.defaults.headers&&delete Ta.defaults.headers.common["Authorization"],localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")},Da=()=>Sa.isLoggedIn&&Sa.user&&(3===Sa.user.role_id||4===Sa.user.role_id),Aa=()=>Sa.isLoggedIn&&Sa.user&&2===Sa.user.role_id,Qa=()=>Sa.isLoggedIn&&Sa.user&&4===Sa.user.role_id,Xa=()=>Sa.user?Sa.user.id:null,Ma=()=>Sa.user?Sa.user.unit_id:null,qa=e=>{Sa.isLoggedIn&&Sa.user&&(Sa.user={...Sa.user,...e},localStorage.getItem("user")&&localStorage.setItem("user",JSON.stringify(Sa.user)),sessionStorage.getItem("user")&&sessionStorage.setItem("user",JSON.stringify(Sa.user)))};Ua();var Ba={state:Sa,login:Ea,logout:Ka,isAdmin:Da,isUnitAdmin:Aa,isSupervisor:Qa,getUserId:Xa,getUnitId:Ma,updateUserInfo:qa},za={name:"AppHeader",setup(){const e=(0,s.rd)(),t=(0,l.EW)((()=>Ba.state.isLoggedIn?Ba.state.user.username||Ba.state.user.phone:"")),a=()=>{Ba.logout(),g.nk.success("已退出登录"),e.push("/login")},o=()=>{e.push("/profile")};return{auth:Ba,userName:t,handleLogout:a,goToProfile:o}}};const Oa=(0,I.A)(za,[["render",m],["__scopeId","data-v-673ebfe5"]]);var ja=Oa,Na={components:{AppHeader:ja},setup(){const e=(0,s.lq)(),t=(0,l.EW)((()=>"/login"!==e.path)),a="1.0.1",o="app_version";return(0,l.sV)((()=>{const e=localStorage.getItem(o);e&&e!==a?ye.s.confirm("应用有新的更新，需要刷新页面以获取最新功能。","版本更新",{confirmButtonText:"立即刷新",cancelButtonText:"稍后再说",type:"warning"}).then((()=>{localStorage.setItem(o,a),window.location.reload(!0)})).catch((()=>{localStorage.setItem(o,a)})):localStorage.setItem(o,a)})),{showHeader:t}}};const Ya=(0,I.A)(Na,[["render",n]]);var Ha=Ya,Ja=a(6070),Ga=(a(4188),a(5186));const Za=(0,o.Ef)(Ha);Za.use($a),Za.use(Ja.A,{locale:Ga.A}),Za.mount("#app")}},t={};function a(o){var l=t[o];if(void 0!==l)return l.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,a),r.exports}a.m=e,function(){var e=[];a.O=function(t,o,l,r){if(!o){var n=1/0;for(u=0;u<e.length;u++){o=e[u][0],l=e[u][1],r=e[u][2];for(var s=!0,i=0;i<o.length;i++)(!1&r||n>=r)&&Object.keys(a.O).every((function(e){return a.O[e](o[i])}))?o.splice(i--,1):(s=!1,r<n&&(n=r));if(s){e.splice(u--,1);var d=l();void 0!==d&&(t=d)}}return t}r=r||0;for(var u=e.length;u>0&&e[u-1][2]>r;u--)e[u]=e[u-1];e[u]=[o,l,r]}}(),function(){a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,{a:t}),t}}(),function(){a.d=function(e,t){for(var o in t)a.o(t,o)&&!a.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};a.O.j=function(t){return 0===e[t]};var t=function(t,o){var l,r,n=o[0],s=o[1],i=o[2],d=0;if(n.some((function(t){return 0!==e[t]}))){for(l in s)a.o(s,l)&&(a.m[l]=s[l]);if(i)var u=i(a)}for(t&&t(o);d<n.length;d++)r=n[d],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return a.O(u)},o=self["webpackChunkhazardous_waste_management_frontend"]=self["webpackChunkhazardous_waste_management_frontend"]||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))}();var o=a.O(void 0,[504],(function(){return a(187)}));o=a.O(o)})();
//# sourceMappingURL=app.5eec3bbc.js.map