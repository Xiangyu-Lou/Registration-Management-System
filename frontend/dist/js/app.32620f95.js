(function(){"use strict";var e={4152:function(e,t,a){var l=a(5130),o=a(6768);const r={id:"app"};function n(e,t,a,l,n,i){const s=(0,o.g2)("app-header"),u=(0,o.g2)("router-view");return(0,o.uX)(),(0,o.CE)("div",r,[l.showHeader?((0,o.uX)(),(0,o.Wv)(s,{key:0})):(0,o.Q3)("",!0),(0,o.bF)(u)])}var i=a(1387),s=a(4232);const u={class:"app-header"},d={key:0,class:"user-info"},c={class:"welcome-text"},p={class:"role-tag"},m={key:0,class:"unit-tag"};function g(e,t,a,l,r,n){const i=(0,o.g2)("el-button");return(0,o.uX)(),(0,o.CE)("div",u,[t[2]||(t[2]=(0,o.Lk)("div",{class:"header-title"},[(0,o.Lk)("h1",null,"危险废物管理系统")],-1)),l.auth.state.isLoggedIn?((0,o.uX)(),(0,o.CE)("div",d,[(0,o.Lk)("span",c,[t[0]||(t[0]=(0,o.eW)(" 欢迎, ")),(0,o.Lk)("strong",null,(0,s.v_)(l.userName),1),(0,o.Lk)("span",p,"("+(0,s.v_)(l.auth.state.user.role)+")",1),l.auth.state.user.unit_name?((0,o.uX)(),(0,o.CE)("span",m,(0,s.v_)(l.auth.state.user.unit_name),1)):(0,o.Q3)("",!0)]),(0,o.bF)(i,{type:"text",class:"logout-button",onClick:l.handleLogout},{default:(0,o.k6)((()=>t[1]||(t[1]=[(0,o.eW)(" 退出登录 ")]))),_:1},8,["onClick"])])):(0,o.Q3)("",!0)])}var h=a(1219),f=a(144),v=a(4373);const b="";var k={baseURL:b,endpoints:{login:"/api/login",users:"/api/users",units:"/api/units",wasteTypes:"/api/waste-types",wasteRecords:"/api/waste-records",wasteRecordsByUnit:"/api/waste-records",wasteRecordDetail:"/api/waste-records/detail",wasteRecordsByUser:"/api/waste-records/user",exportWasteRecords:"/api/waste-records/export/user"},getUrl(e){return`${this.baseURL}${e}`}};const w={class:"unit-selection-container"},y={class:"content"},_={class:"units-grid"},F={class:"unit-name"};function I(e,t,a,l,r,n){const i=(0,o.g2)("el-card");return(0,o.uX)(),(0,o.CE)("div",w,[t[1]||(t[1]=(0,o.Lk)("div",{class:"header"},[(0,o.Lk)("h1",null,"危险废物管理系统")],-1)),(0,o.Lk)("div",y,[t[0]||(t[0]=(0,o.Lk)("h2",null,"请选择您的单位",-1)),(0,o.Lk)("div",_,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.units,(e=>((0,o.uX)(),(0,o.Wv)(i,{key:e.id,class:"unit-card",shadow:"hover",onClick:t=>n.selectUnit(e)},{default:(0,o.k6)((()=>[(0,o.Lk)("div",F,(0,s.v_)(e.name),1)])),_:2},1032,["onClick"])))),128))])]),t[2]||(t[2]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var L={name:"UnitSelection",data(){return{units:[],loading:!1}},created(){this.fetchUnits()},methods:{async fetchUnits(){this.loading=!0;try{console.log("正在获取单位列表...");const e=await v.A.get(k.getUrl(k.endpoints.units));console.log("获取单位列表成功:",e.data),this.units=e.data}catch(e){console.error("获取单位列表失败:",e),h.nk.error("获取单位列表失败")}finally{this.loading=!1}},selectUnit(e){this.$router.push({name:"WasteForm",params:{id:e.id}})}}},R=a(1241);const C=(0,R.A)(L,[["render",I],["__scopeId","data-v-a706bc72"]]);var V=C;const W={class:"waste-form-container"},U={class:"header"},x={key:1},E={class:"content"},T={class:"unit-info"},P={class:"form-row"},A={key:0,class:"upload-warning"},S={class:"form-actions"},X={class:"upload-progress"},K={class:"upload-status"};function $(e,t,a,l,r,n){const i=(0,o.g2)("arrow-left"),u=(0,o.g2)("el-icon"),d=(0,o.g2)("document"),c=(0,o.g2)("el-option"),p=(0,o.g2)("el-select"),m=(0,o.g2)("el-form-item"),g=(0,o.g2)("el-input"),h=(0,o.g2)("el-date-picker"),f=(0,o.g2)("clock"),v=(0,o.g2)("el-time-picker"),b=(0,o.g2)("el-input-number"),k=(0,o.g2)("el-alert"),w=(0,o.g2)("plus"),y=(0,o.g2)("el-upload"),_=(0,o.g2)("el-button"),F=(0,o.g2)("el-form"),I=(0,o.g2)("el-progress"),L=(0,o.g2)("el-dialog");return(0,o.uX)(),(0,o.CE)("div",W,[(0,o.Lk)("div",U,[l.isAdmin?((0,o.uX)(),(0,o.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(i)])),_:1}),t[9]||(t[9]=(0,o.eW)(" 返回 "))])):((0,o.uX)(),(0,o.CE)("div",x)),t[11]||(t[11]=(0,o.Lk)("h1",null,"危险废物填报",-1)),(0,o.Lk)("div",{class:"view-records",onClick:t[1]||(t[1]=(...e)=>l.viewRecords&&l.viewRecords(...e))},[t[10]||(t[10]=(0,o.eW)(" 查看记录 ")),(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(d)])),_:1})])]),(0,o.Lk)("div",E,[(0,o.Lk)("div",T,[(0,o.Lk)("h2",null,(0,s.v_)(l.unitName),1)]),(0,o.bF)(F,{ref:"wasteForm",model:l.form,rules:l.rules,"label-position":"top",class:"waste-form"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{label:"废物类型",prop:"wasteTypeId"},{default:(0,o.k6)((()=>[(0,o.bF)(p,{modelValue:l.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"产生地点",prop:"location"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:l.form.location,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.location=e),placeholder:"请输入废物产生地点"},null,8,["modelValue"])])),_:1}),(0,o.Lk)("div",P,[(0,o.bF)(m,{label:"收集日期",class:"date-item"},{default:(0,o.k6)((()=>[(0,o.bF)(h,{modelValue:l.form.collectionDate,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,"popper-class":"date-picker-popup",teleported:!1},null,8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"收集时间",class:"time-item"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:l.form.collectionTime,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"},editable:!1,"popper-class":"time-picker-popup",teleported:!1},{prefix:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1})]),(0,o.bF)(m,{label:"收集数量(吨)",prop:"quantity"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{modelValue:l.form.quantity,"onUpdate:modelValue":t[6]||(t[6]=e=>l.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"},onFocus:t[7]||(t[7]=e=>l.selectAllText(e)),"input-props":{inputmode:"decimal",pattern:"[0-9]*[.,]?[0-9]*"},controls:!1},null,8,["modelValue"])])),_:1}),(0,o.bF)(m,{label:"现场照片（收集前）",prop:"photo_before"},{default:(0,o.k6)((()=>[t[12]||(t[12]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),l.showLargeFileWarning?((0,o.uX)(),(0,o.CE)("div",A,[(0,o.bF)(k,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,o.Q3)("",!0),(0,o.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoBeforeChange,"on-remove":l.handlePhotoBeforeRemove,"file-list":l.fileListBefore,limit:5,multiple:"","list-type":"picture-card","before-upload":l.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(w)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,o.bF)(m,{label:"现场照片（收集后）",prop:"photo_after"},{default:(0,o.k6)((()=>[t[13]||(t[13]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,o.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoAfterChange,"on-remove":l.handlePhotoAfterRemove,"file-list":l.fileListAfter,limit:5,multiple:"","list-type":"picture-card","before-upload":l.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(w)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,o.Lk)("div",S,[(0,o.bF)(_,{type:"primary",class:"submit-btn",onClick:l.submitForm,loading:l.loading},{default:(0,o.k6)((()=>t[14]||(t[14]=[(0,o.eW)("提交")]))),_:1},8,["onClick","loading"]),(0,o.bF)(_,{class:"reset-btn",onClick:l.resetForm},{default:(0,o.k6)((()=>t[15]||(t[15]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model","rules"])]),(0,o.bF)(L,{modelValue:l.showUploadProgress,"onUpdate:modelValue":t[8]||(t[8]=e=>l.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,o.k6)((()=>[(0,o.Lk)("div",X,[t[16]||(t[16]=(0,o.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,o.bF)(I,{percentage:l.uploadPercentage,format:l.percentageFormat,status:100===l.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,o.Lk)("p",K,(0,s.v_)(l.uploadStatus),1)])])),_:1},8,["modelValue"]),t[17]||(t[17]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var Q=a(7477),q={name:"WasteForm",components:{ArrowLeft:Q.nkM,Document:Q.yoT,Plus:Q.FWt,Clock:Q.zD7},props:{id:{type:[String,Number],required:!0}},setup(e){const t=(0,i.rd)(),a=(0,f.KR)(null),l=(0,f.KR)(!1),r=(0,f.KR)(""),n=(0,f.KR)([]),s=(0,f.KR)([]),u=(0,f.KR)([]),d=(0,f.KR)([]),c=(0,f.KR)([]),p=(0,f.KR)(!1),m=(0,f.KR)(0),g=(0,f.KR)("准备上传..."),v=(0,f.KR)(!1),b=(0,o.EW)((()=>Qt.state.isLoggedIn&&3===Qt.state.user.role_id)),w=(0,f.Kh)({wasteTypeId:"",location:"",collectionDate:(new Date).toISOString().slice(0,10),collectionTime:"08:00",quantity:void 0,photo_before:[],photo_after:[]}),y={wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],location:[{required:!0,message:"请输入废物产生地点",trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,o.sV)((async()=>{const e=document.createElement("meta");e.setAttribute("name","viewport"),e.setAttribute("content","width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1"),document.head.appendChild(e);const t=document.querySelector('meta[name="viewport"]');t&&t!==e&&t.remove(),await _(),await F()})),(0,o.xo)((()=>{const e=document.querySelector('meta[name="viewport"]');e&&e.remove();const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width,initial-scale=1.0"),document.head.appendChild(t)}));const _=async()=>{try{const t=await Ut.get(k.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.id)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),h.nk.error("获取单位信息失败")}},F=async()=>{try{const e=await Ut.get(k.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),h.nk.error("获取废物类型失败")}},I=async e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return h.nk.error("只能上传图片文件!"),!1;const l=52428800;if(e.size>l)return h.nk.error("图片大小不能超过50MB!"),!1;const o=5242880;return e.size>o&&(v.value=!0),!0},L=(e,t)=>{console.log("收集前照片变更:",e),d.value=t;const a=t.filter((e=>e.raw&&!s.value.some((t=>t.name===e.raw.name))));a.forEach((e=>{e.raw&&s.value.push(e.raw)}));const l=[...s.value,...u.value];v.value=W(l),console.log("更新后的photoFilesBefore:",s.value)},R=(e,t)=>{console.log("收集前照片移除:",e),d.value=t,e.raw?s.value=s.value.filter((t=>t.name!==e.raw.name)):s.value=s.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),W([...s.value,...u.value])||(v.value=!1),console.log("更新后的photoFilesBefore:",s.value)},C=(e,t)=>{console.log("收集后照片变更:",e),c.value=t;const a=t.filter((e=>e.raw&&!u.value.some((t=>t.name===e.raw.name))));a.forEach((e=>{e.raw&&u.value.push(e.raw)}));const l=[...s.value,...u.value];v.value=W(l),console.log("更新后的photoFilesAfter:",u.value)},V=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,e.raw?u.value=u.value.filter((t=>t.name!==e.raw.name)):u.value=u.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),W([...s.value,...u.value])||(v.value=!1),console.log("更新后的photoFilesAfter:",u.value)},W=e=>{const t=5242880;return e.some((e=>e.size>t))},U=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);m.value=t,g.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},x=e=>100===e?"完成":`${e}%`,E=()=>{a.value.validate((async t=>{if(t){l.value=!0;try{const t=new FormData;if(t.append("unitId",e.id),t.append("wasteTypeId",w.wasteTypeId),t.append("location",w.location),w.collectionDate&&w.collectionTime&&(t.append("collectionDate",w.collectionDate),t.append("collectionTime",w.collectionTime)),t.append("quantity",w.quantity),Qt.state.isLoggedIn&&Qt.state.user){t.append("creator_id",Qt.state.user.id);const e=Qt.state.user.username||Qt.state.user.phone||"未知";t.append("creator_name",e),console.log("添加用户信息:",{creator_id:Qt.state.user.id,creator_name:e,user:Qt.state.user})}else console.log("用户未登录或用户信息不完整");console.log("提交表单数据:",{unitId:e.id,wasteTypeId:w.wasteTypeId,location:w.location,quantity:w.quantity,photo_before:s.value?s.value.length:0,photo_after:u.value?u.value.length:0}),s.value&&s.value.length>0&&(console.log("添加收集前照片数量:",s.value.length),s.value.forEach(((e,a)=>{e&&(console.log(`收集前照片 ${a+1}:`,e.name),t.append("photo_before",e))}))),u.value&&u.value.length>0&&(console.log("添加收集后照片数量:",u.value.length),u.value.forEach(((e,a)=>{e&&(console.log(`收集后照片 ${a+1}:`,e.name),t.append("photo_after",e))})));const a=[...s.value||[],...u.value||[]];v.value=W(a),a.length>0&&(p.value=!0,m.value=0,g.value="准备上传...");const l=await Ut.postForm(k.endpoints.wasteRecords,t,U);console.log("提交响应:",l.data),h.nk.success("废物记录提交成功"),T()}catch(a){console.error("Error submitting form:",a),a.response&&(console.error("错误响应数据:",a.response.data),console.error("错误状态码:",a.response.status)),h.nk.error("提交失败，请稍后再试")}finally{l.value=!1,p.value=!1}}else h.nk.warning("请完成必填项")}))},T=()=>{a.value&&a.value.resetFields(),s.value=[],u.value=[],d.value=[],c.value=[],w.quantity=void 0,w.collectionDate=(new Date).toISOString().slice(0,10),w.collectionTime="08:00"},P=()=>{b.value&&t.push("/")},A=()=>{t.push({name:"RecordsList",params:{unitId:e.id}})},S=e=>{setTimeout((()=>{if(e&&e.target){const t=e.target.querySelector("input");t&&t.select()}}),10)};return{form:w,rules:y,wasteForm:a,loading:l,unitName:r,wasteTypes:n,isAdmin:b,fileListBefore:d,fileListAfter:c,handlePhotoBeforeChange:L,handlePhotoBeforeRemove:R,handlePhotoAfterChange:C,handlePhotoAfterRemove:V,handleBeforeUpload:I,submitForm:E,resetForm:T,goBack:P,viewRecords:A,selectAllText:S,showUploadProgress:p,uploadPercentage:m,uploadStatus:g,percentageFormat:x,showLargeFileWarning:v}}};const D=(0,R.A)(q,[["render",$],["__scopeId","data-v-53fa8846"]]);var B=D;const M={class:"records-container"},j={class:"header"},O={key:1},N={class:"content"},Y={class:"unit-info"},z={class:"actions"},H={class:"filter-header"},J={class:"filter-form-container"},G={class:"quantity-range"},Z={class:"filter-actions"},ee={class:"records-wrapper"},te={class:"card-header"},ae={class:"card-actions"},le={key:0,class:"photo-preview"},oe=["onClick"],re={key:0,class:"photo-count"},ne={key:1},ie={key:0,class:"photo-preview"},se=["onClick"],ue={key:0,class:"photo-count"},de={key:1},ce={class:"operation-buttons"},pe={key:0,class:"loading-more"},me={key:1,class:"empty-block"};function ge(e,t,a,r,n,i){const u=(0,o.g2)("arrow-left"),d=(0,o.g2)("el-icon"),c=(0,o.g2)("home"),p=(0,o.g2)("plus"),m=(0,o.g2)("el-button"),g=(0,o.g2)("user"),h=(0,o.g2)("refresh"),f=(0,o.g2)("arrow-down"),v=(0,o.g2)("arrow-up"),b=(0,o.g2)("el-date-picker"),k=(0,o.g2)("el-form-item"),w=(0,o.g2)("el-col"),y=(0,o.g2)("el-option"),_=(0,o.g2)("el-select"),F=(0,o.g2)("el-row"),I=(0,o.g2)("el-input-number"),L=(0,o.g2)("el-input"),R=(0,o.g2)("el-form"),C=(0,o.g2)("el-card"),V=(0,o.g2)("download"),W=(0,o.g2)("el-table-column"),U=(0,o.g2)("el-image"),x=(0,o.g2)("el-table"),E=(0,o.g2)("loading"),T=(0,o.g2)("el-empty"),P=(0,o.g2)("el-image-viewer"),A=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",M,[(0,o.Lk)("div",j,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1}),t[8]||(t[8]=(0,o.eW)(" 返回填报 "))]),t[10]||(t[10]=(0,o.Lk)("h1",null,"废物记录查看",-1)),r.isAdmin?((0,o.uX)(),(0,o.CE)("div",{key:0,class:"home-link",onClick:t[1]||(t[1]=(...e)=>r.goHome&&r.goHome(...e))},[t[9]||(t[9]=(0,o.eW)(" 首页 ")),(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(c)])),_:1})])):((0,o.uX)(),(0,o.CE)("div",O))]),(0,o.Lk)("div",N,[(0,o.Lk)("div",Y,[(0,o.Lk)("h2",null,(0,s.v_)(r.unitName)+" - 危险废物记录",1)]),(0,o.Lk)("div",z,[(0,o.bF)(m,{type:"primary",onClick:r.addNewRecord},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1}),t[11]||(t[11]=(0,o.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isAdmin||r.isUnitAdmin?((0,o.uX)(),(0,o.Wv)(m,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(g)])),_:1}),t[12]||(t[12]=(0,o.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,o.Q3)("",!0),(0,o.bF)(m,{onClick:r.refreshRecords},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(h)])),_:1}),t[13]||(t[13]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,o.bF)(C,{class:"filter-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",H,[t[14]||(t[14]=(0,o.Lk)("h3",null,"筛选条件",-1)),(0,o.bF)(m,{type:"primary",link:"",onClick:t[2]||(t[2]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,o.k6)((()=>[(0,o.eW)((0,s.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,o.uX)(),(0,o.Wv)(d,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(v)])),_:1})):((0,o.uX)(),(0,o.Wv)(d,{key:0},{default:(0,o.k6)((()=>[(0,o.bF)(f)])),_:1}))])),_:1})]),(0,o.bo)((0,o.Lk)("div",J,[(0,o.bF)(R,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,o.k6)((()=>[(0,o.bF)(F,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(w,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(b,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(w,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"废物类型"},{default:(0,o.k6)((()=>[(0,o.bF)(_,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(y,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.bF)(F,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(w,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"数量范围(吨)"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",G,[(0,o.bF)(I,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"48%"}},null,8,["modelValue"]),t[15]||(t[15]=(0,o.Lk)("span",{class:"range-separator"},"至",-1)),(0,o.bF)(I,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"48%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,o.bF)(w,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,o.k6)((()=>[(0,o.bF)(k,{label:"产生地点"},{default:(0,o.k6)((()=>[(0,o.bF)(L,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.Lk)("div",Z,[(0,o.bF)(m,{type:"primary",onClick:r.applyFilter},{default:(0,o.k6)((()=>t[16]||(t[16]=[(0,o.eW)("筛选")]))),_:1},8,["onClick"]),(0,o.bF)(m,{onClick:r.resetFilter},{default:(0,o.k6)((()=>t[17]||(t[17]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[l.aG,r.showFilterPanel]])])),_:1}),(0,o.Lk)("div",ee,[(0,o.bF)(C,{class:"records-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",te,[t[19]||(t[19]=(0,o.Lk)("h3",null,"废物记录列表",-1)),(0,o.Lk)("div",ae,[(0,o.bF)(m,{type:"warning",onClick:r.exportRecords},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(V)])),_:1}),t[18]||(t[18]=(0,o.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(x,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:"500",onScroll:r.handleScroll},{default:(0,o.k6)((()=>[(0,o.bF)(W,{prop:"waste_type_name",label:"废物类型","min-width":"110"}),(0,o.bF)(W,{prop:"location",label:"产生地点","min-width":"120"}),(0,o.bF)(W,{label:"收集开始时间","min-width":"160"},{default:(0,o.k6)((e=>[(0,o.eW)((0,s.v_)(r.parseFormattedDateTime(e.row.collection_start_time)),1)])),_:1}),(0,o.bF)(W,{label:"数量(吨)","min-width":"100"},{default:(0,o.k6)((e=>[(0,o.eW)((0,s.v_)(parseFloat(e.row.quantity).toFixed(3)),1)])),_:1}),(0,o.bF)(W,{label:"记录时间","min-width":"160",class:"mobile-hidden"},{default:(0,o.k6)((e=>[(0,o.eW)((0,s.v_)(r.parseFormattedDateTime(e.row.created_at)),1)])),_:1}),(0,o.bF)(W,{label:"汇报人","min-width":"100",class:"mobile-hidden"},{default:(0,o.k6)((e=>[(0,o.eW)((0,s.v_)(e.row.creator_name||"未知"),1)])),_:1}),(0,o.bF)(W,{label:"现场照片（清理前）",width:"120",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_before?((0,o.uX)(),(0,o.CE)("div",le,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,o.bF)(U,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,oe)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,o.uX)(),(0,o.CE)("div",re,(0,s.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",ne,"无"))])),_:1}),(0,o.bF)(W,{label:"现场照片（清理后）",width:"120",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_after?((0,o.uX)(),(0,o.CE)("div",ie,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,o.bF)(U,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,se)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,o.uX)(),(0,o.CE)("div",ue,(0,s.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",de,"无"))])),_:1}),(0,o.bF)(W,{label:"操作","min-width":"70",fixed:"right"},{default:(0,o.k6)((e=>[(0,o.Lk)("div",ce,[r.canEdit(e.row)?((0,o.uX)(),(0,o.Wv)(m,{key:0,type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,o.k6)((()=>t[20]||(t[20]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0),r.canEdit(e.row)?((0,o.uX)(),(0,o.Wv)(m,{key:1,type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,o.k6)((()=>t[21]||(t[21]=[(0,o.eW)(" 删除 ")]))),_:2},1032,["onClick"])):(0,o.Q3)("",!0)])])),_:1})])),_:1},8,["data","onScroll"])),[[A,r.loading]]),r.loadingMore?((0,o.uX)(),(0,o.CE)("div",pe,[(0,o.bF)(d,{class:"loading"},{default:(0,o.k6)((()=>[(0,o.bF)(E)])),_:1}),t[22]||(t[22]=(0,o.eW)(" 加载更多... "))])):(0,o.Q3)("",!0),0!==r.records.length||r.loading?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("div",me,[(0,o.bF)(T,{description:"暂无废物记录"})]))])),_:1})])]),t[23]||(t[23]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,o.uX)(),(0,o.Wv)(P,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])}var he=a(8828),fe=a(2933);const ve=(e,t,a)=>{if(!e||0===e.length)return;const l=t||"导出数据",o=`${l}_${(new Date).toISOString().slice(0,10)}.csv`;let r="\ufeff";const n=a.map((e=>e.title)).join(",");r+=n+"\n",e.forEach((e=>{const t=a.map((t=>{let a=e[t.field];return null===a||void 0===a?"":"number"===t.type?"number"===typeof a?a.toFixed(3):parseFloat(a).toFixed(3):(a=String(a),a.includes(",")||a.includes('"')||a.includes("\n")?`"${a.replace(/"/g,'""')}"`:a)})).join(",");r+=t+"\n"}));const i=new Blob([r],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),u=URL.createObjectURL(i);s.setAttribute("href",u),s.setAttribute("download",o),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(u)};var be={name:"RecordsList",components:{ArrowLeft:Q.nkM,Home:Q.Home,Refresh:Q.C42,Plus:Q.FWt,User:Q.KJW,ArrowDown:Q.yd$,ArrowUp:Q.DoI,Download:Q.f5X,ElImageViewer:he.Tg,Loading:Q.Rhj},props:{unitId:{type:[String,Number],required:!0}},setup(e){const t=(0,i.rd)(),a=(0,f.KR)([]),l=(0,f.KR)(!1),r=(0,f.KR)(""),n=(0,f.KR)([]),s=(0,f.KR)(!0),u=k.baseURL,d=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},c=(0,f.KR)(1),p=(0,f.KR)(20),m=(0,f.KR)(!0),g=(0,f.KR)(!1),v=(0,f.Kh)({dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:""}),b=(0,o.EW)((()=>a.value&&Array.isArray(a.value)?a.value.filter((e=>{if(v.wasteTypeId&&e.waste_type_id!==v.wasteTypeId)return!1;if(null!==v.minQuantity&&parseFloat(e.quantity)<v.minQuantity)return!1;if(null!==v.maxQuantity&&parseFloat(e.quantity)>v.maxQuantity)return!1;if(v.location&&!e.location.toLowerCase().includes(v.location.toLowerCase()))return!1;if(v.dateRange&&2===v.dateRange.length){const t=new Date(v.dateRange[0]),a=new Date(v.dateRange[1]);a.setHours(23,59,59);const l=new Date(e.collection_start_time);if(l<t||l>a)return!1}return!0})):[])),w=(0,o.EW)((()=>Qt.isAdmin())),y=(0,o.EW)((()=>Qt.isUnitAdmin())),_=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},F=async()=>{await q(),h.nk.success("记录已刷新")},I=()=>{const e=Qt.getUnitId();e?t.push(`/unit/${e}`):t.push("/")},L=()=>{t.push("/")},R=()=>{t.push("/user-management")},C=()=>{t.push(`/unit/${e.unitId}`)},V=e=>{t.push(`/record/${e}`)},W=e=>{if(!e)return!1;if(w.value)return!0;const t=Qt.getUnitId();if(y.value&&t&&e.unit_id===parseInt(t))return!0;const a=Qt.getUserId();return a&&e.creator_id===parseInt(a)},U=e=>{fe.s.confirm("确定要删除这条废物记录吗？此操作不可逆。","删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await Ut.delete(`${k.endpoints.wasteRecords}/${e.id}`),h.nk.success("记录已成功删除"),await q()}catch(t){console.error("删除记录失败:",t),h.nk.error("删除记录失败，请重试")}})).catch((()=>{h.nk.info("已取消删除")}))},x=async()=>{try{c.value=1,await q(),h.nk.success("筛选条件已应用")}catch(e){console.error("应用筛选失败:",e),h.nk.error("应用筛选失败")}},E=async()=>{v.dateRange=null,v.wasteTypeId=null,v.minQuantity=null,v.maxQuantity=null,v.location="",c.value=1,await q(),h.nk.success("筛选条件已重置")},T=()=>{try{const e=Qt.getUserId();if(!e)return void h.nk.error("用户未登录");const t={};v.wasteTypeId&&(t.wasteTypeId=v.wasteTypeId),null!==v.minQuantity&&(t.minQuantity=v.minQuantity),null!==v.maxQuantity&&(t.maxQuantity=v.maxQuantity),v.location&&(t.location=v.location),v.dateRange&&2===v.dateRange.length&&(t.dateRange=JSON.stringify(v.dateRange));const a=b.value.map((e=>({"单位":r.value,"废物类型":e.waste_type_name,"收集地点":e.location,"收集时间":_(e.collection_start_time),"数量(kg)":e.quantity,"记录时间":_(e.created_at),"汇报人":e.creator_name||"未知"}))),l=[{title:"单位",field:"单位"},{title:"废物类型",field:"废物类型"},{title:"收集地点",field:"收集地点"},{title:"收集时间",field:"收集时间"},{title:"数量(kg)",field:"数量(kg)",type:"number"},{title:"记录时间",field:"记录时间"},{title:"汇报人",field:"汇报人"}];ve(a,`${r.value}危险废物记录`,l),h.nk.success("导出成功")}catch(e){console.error("导出记录失败:",e),h.nk.error("导出记录失败")}},P=(0,f.KR)(!1),A=(0,f.KR)([]),S=(0,f.KR)(0),X=(e,t)=>{const a=Array.isArray(e)?e:[e];A.value=a.map((e=>`${u}${e}`)),S.value=t||0,P.value=!0},K=()=>{P.value=!1};(0,o.sV)((async()=>{await Q(),await $(),await q()}));const $=async()=>{try{const e=await Ut.get(k.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),h.nk.error("获取废物类型列表失败")}},Q=async()=>{try{const t=await Ut.get(k.endpoints.units),a=t.data.find((t=>t.id===parseInt(e.unitId)));a&&(r.value=a.name)}catch(t){console.error("Error fetching unit name:",t),h.nk.error("获取单位信息失败")}},q=async(e=!1)=>{e?g.value=!0:(l.value=!0,c.value=1,a.value=[]);try{const t={page:c.value,pageSize:p.value};v.wasteTypeId&&(t.wasteTypeId=v.wasteTypeId),null!==v.minQuantity&&(t.minQuantity=v.minQuantity),null!==v.maxQuantity&&(t.maxQuantity=v.maxQuantity),v.location&&(t.location=v.location),v.dateRange&&2===v.dateRange.length&&(t.dateRange=JSON.stringify(v.dateRange));const l=Qt.getUserId();if(!l)throw new Error("用户未登录");const o=await Ut.get(`${k.endpoints.wasteRecordsByUser}/${l}`,{params:t});o.data&&Array.isArray(o.data.records)?(a.value=e?[...a.value,...o.data.records]:o.data.records,m.value=!!o.data.hasMore):(console.error("Invalid response format:",o.data),a.value=[],m.value=!1,h.nk.error("获取废物记录失败：数据格式错误"))}catch(t){console.error("Error fetching records:",t),a.value=[],m.value=!1,h.nk.error("获取废物记录失败")}finally{l.value=!1,g.value=!1}},D=async e=>{if(!e||!e.target)return;const t=e.target.scrollHeight||0,a=e.target.scrollTop||0,l=e.target.clientHeight||0;t-a-l<50&&m.value&&!g.value&&(c.value++,await q(!0))};return{records:a,filteredRecords:b,loading:l,unitName:r,wasteTypes:n,isAdmin:w,isUnitAdmin:y,parseFormattedDateTime:_,refreshRecords:F,goBack:I,goHome:L,goToUserManagement:R,addNewRecord:C,editRecord:V,canEdit:W,confirmDelete:U,apiConfig:k,showFilterPanel:s,filterForm:v,applyFilter:x,resetFilter:E,exportRecords:T,showViewer:P,previewImages:A,previewIndex:S,previewPhoto:X,closeViewer:K,handleScroll:D,parsePhotoPath:d,baseUrl:u,page:c,pageSize:p,hasMore:m,loadingMore:g}}};const ke=(0,R.A)(be,[["render",ge],["__scopeId","data-v-f78b334c"]]);var we=ke;const ye={class:"login-container"},_e={class:"login-card"},Fe={key:0,class:"login-error"};function Ie(e,t,a,r,n,i){const u=(0,o.g2)("el-input"),d=(0,o.g2)("el-form-item"),c=(0,o.g2)("el-radio"),p=(0,o.g2)("el-radio-group"),m=(0,o.g2)("el-checkbox"),g=(0,o.g2)("el-button"),h=(0,o.g2)("el-form");return(0,o.uX)(),(0,o.CE)("div",ye,[(0,o.Lk)("div",_e,[t[9]||(t[9]=(0,o.Lk)("div",{class:"login-header"},[(0,o.Lk)("h1",null,"危险废物管理系统"),(0,o.Lk)("h2",null,"用户登录")],-1)),(0,o.bF)(h,{ref:"loginForm",model:r.form,rules:r.rules,"label-width":"80px",class:"login-form",onSubmit:(0,l.D$)(r.submitForm,["prevent"])},{default:(0,o.k6)((()=>[(0,o.bF)(d,{label:"手机号",prop:"phone"},{default:(0,o.k6)((()=>[(0,o.bF)(u,{modelValue:r.form.phone,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),r.showPassword?((0,o.uX)(),(0,o.Wv)(d,{key:0,label:"密码",prop:"password"},{default:(0,o.k6)((()=>[(0,o.bF)(u,{modelValue:r.form.password,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1})):(0,o.Q3)("",!0),(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(p,{modelValue:r.form.userType,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.userType=e),onChange:r.handleUserTypeChange},{default:(0,o.k6)((()=>[(0,o.bF)(c,{label:1},{default:(0,o.k6)((()=>t[4]||(t[4]=[(0,o.eW)("员工")]))),_:1}),(0,o.bF)(c,{label:2},{default:(0,o.k6)((()=>t[5]||(t[5]=[(0,o.eW)("单位管理员")]))),_:1}),(0,o.bF)(c,{label:3},{default:(0,o.k6)((()=>t[6]||(t[6]=[(0,o.eW)("超级管理员")]))),_:1})])),_:1},8,["modelValue","onChange"])])),_:1}),(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(m,{modelValue:r.form.rememberMe,"onUpdate:modelValue":t[3]||(t[3]=e=>r.form.rememberMe=e)},{default:(0,o.k6)((()=>t[7]||(t[7]=[(0,o.eW)("记住登录")]))),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(g,{type:"primary","native-type":"submit",onClick:r.submitForm,loading:r.auth.state.loading,style:{width:"100%"}},{default:(0,o.k6)((()=>t[8]||(t[8]=[(0,o.eW)(" 登录 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules","onSubmit"]),r.auth.state.error?((0,o.uX)(),(0,o.CE)("div",Fe,(0,s.v_)(r.auth.state.error),1)):(0,o.Q3)("",!0)])])}var Le={name:"LoginView",setup(){const e=(0,i.rd)(),t=(0,f.KR)(null),a=(0,f.Kh)({phone:"",password:"",userType:1,rememberMe:!1}),l=(0,o.EW)((()=>1!==a.userType)),r=(0,o.EW)((()=>{const e=[{required:!0,message:"请输入手机号",trigger:"submit"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"submit"}],t=l.value?[{required:!0,message:"请输入密码",trigger:"submit"}]:[];return{phone:e,password:t}})),n=()=>{1===a.userType&&(a.password=""),t.value&&t.value.clearValidate()},s=async()=>{console.log("提交表单被触发"),t.value?Qt.state.loading?console.log("登录正在进行中，跳过"):1===a.userType?(console.log("员工登录模式"),t.value.validate((async e=>{e?(console.log("员工登录表单验证通过"),await u()):console.log("员工表单验证失败")}))):(console.log("管理员登录模式"),t.value.validate((async e=>{e?(console.log("管理员表单验证通过"),await u()):console.log("表单验证失败")}))):console.log("表单引用不存在")},u=async()=>{console.log("开始登录，账号:",a.phone,"用户类型:",a.userType);try{console.log("开始处理登录操作...");const t=await Qt.login(a.phone,1===a.userType?null:a.password,a.rememberMe,a.userType);if(console.log("登录响应:",t),t.success){const a=t.user;h.nk.success(`欢迎，${a.username||a.phone}`),3===a.role_id?e.push("/admin-records"):2===a.role_id?e.push(`/records/${a.unit_id}`):e.push(`/unit/${a.unit_id}`)}else h.nk.error(t.error||"登录失败")}catch(t){h.nk.error(t.response?.data?.error||"登录失败，请检查网络连接")}};return(0,o.sV)((()=>{if(Qt.state.isLoggedIn){const t=Qt.state.user;3===t.role_id?e.push("/admin-records"):2===t.role_id?e.push(`/records/${t.unit_id}`):e.push(`/unit/${t.unit_id}`)}})),{form:a,rules:r,loginForm:t,showPassword:l,handleUserTypeChange:n,submitForm:s,auth:Qt}}};const Re=(0,R.A)(Le,[["render",Ie],["__scopeId","data-v-7ee4feb4"]]);var Ce=Re;const Ve={class:"edit-record-container"},We={class:"header"},Ue={class:"content"},xe={class:"form-header"},Ee={key:0,class:"upload-warning"},Te=["src"],Pe=["src"],Ae={class:"upload-progress"},Se={class:"upload-status"};function Xe(e,t,a,l,r,n){const i=(0,o.g2)("arrow-left"),u=(0,o.g2)("el-icon"),d=(0,o.g2)("el-option"),c=(0,o.g2)("el-select"),p=(0,o.g2)("el-form-item"),m=(0,o.g2)("el-input"),g=(0,o.g2)("el-date-picker"),h=(0,o.g2)("clock"),f=(0,o.g2)("el-time-picker"),v=(0,o.g2)("el-input-number"),b=(0,o.g2)("el-alert"),k=(0,o.g2)("plus"),w=(0,o.g2)("el-upload"),y=(0,o.g2)("el-image-viewer"),_=(0,o.g2)("el-button"),F=(0,o.g2)("el-collapse-item"),I=(0,o.g2)("el-collapse"),L=(0,o.g2)("el-form"),R=(0,o.g2)("el-progress"),C=(0,o.g2)("el-dialog"),V=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",Ve,[(0,o.Lk)("div",We,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(i)])),_:1}),t[8]||(t[8]=(0,o.eW)(" 返回 "))]),(0,o.Lk)("h1",null,(0,s.v_)(l.isNew?"新增废物记录":"编辑废物记录"),1),t[9]||(t[9]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",Ue,[(0,o.Lk)("div",xe,[(0,o.Lk)("h2",null,(0,s.v_)(l.unitName),1)]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(L,{ref:"recordForm",model:l.form,rules:l.rules,"label-width":"120px",class:"record-form"},{default:(0,o.k6)((()=>[l.isSuperAdmin&&l.isNew?((0,o.uX)(),(0,o.Wv)(p,{key:0,label:"单位",prop:"unitId"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>l.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.units,(e=>((0,o.uX)(),(0,o.Wv)(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(0,o.Q3)("",!0),(0,o.bF)(p,{label:"废物类型",prop:"wasteTypeId"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{modelValue:l.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"产生地点",prop:"location"},{default:(0,o.k6)((()=>[(0,o.bF)(m,{modelValue:l.form.location,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.location=e),placeholder:"请输入废物产生地点"},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集日期"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:l.form.collectionDate,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(f,{modelValue:l.form.collectionTime,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(h)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"收集数量(吨)",prop:"quantity"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:l.form.quantity,"onUpdate:modelValue":t[6]||(t[6]=e=>l.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,o.bF)(p,{label:"现场照片（收集前）",prop:"photo_path_before"},{default:(0,o.k6)((()=>[t[10]||(t[10]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),l.showLargeFileWarning?((0,o.uX)(),(0,o.CE)("div",Ee,[(0,o.bF)(b,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,o.Q3)("",!0),(0,o.bF)(w,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoBeforeChange,"on-remove":l.handlePhotoBeforeRemove,"file-list":l.fileListBefore,limit:5,multiple:"","list-type":"picture-card","on-preview":l.handlePictureCardPreview,"before-upload":l.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"])])),_:1}),(0,o.bF)(p,{label:"现场照片（收集后）",prop:"photo_path_after"},{default:(0,o.k6)((()=>[t[11]||(t[11]=(0,o.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,o.bF)(w,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":l.handlePhotoAfterChange,"on-remove":l.handlePhotoAfterRemove,"file-list":l.fileListAfter,limit:5,multiple:"","list-type":"picture-card","on-preview":l.handlePictureCardPreview,"before-upload":l.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,o.k6)((()=>[(0,o.bF)(u,null,{default:(0,o.k6)((()=>[(0,o.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),l.showViewer?((0,o.uX)(),(0,o.Wv)(y,{key:0,"url-list":l.previewImages,"initial-index":l.previewIndex,onClose:l.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])),_:1}),(0,o.bF)(p,null,{default:(0,o.k6)((()=>[(0,o.bF)(_,{type:"primary",onClick:l.submitForm,loading:l.loading},{default:(0,o.k6)((()=>t[12]||(t[12]=[(0,o.eW)("保存")]))),_:1},8,["onClick","loading"]),(0,o.bF)(_,{onClick:l.goBack},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)("取消")]))),_:1},8,["onClick"])])),_:1}),l.isNew?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.Wv)(I,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(F,{title:"调试信息"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",null,[t[16]||(t[16]=(0,o.Lk)("h4",null,"收集前照片路径:",-1)),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.fileListBefore,((e,a)=>((0,o.uX)(),(0,o.CE)("div",{key:"before-"+a},[(0,o.Lk)("div",null,"名称: "+(0,s.v_)(e.name),1),(0,o.Lk)("div",null,"URL: "+(0,s.v_)(e.url),1),(0,o.Lk)("div",null,[(0,o.Lk)("img",{src:e.url,style:{"max-width":"200px","max-height":"200px"}},null,8,Te)]),t[14]||(t[14]=(0,o.Lk)("hr",null,null,-1))])))),128)),t[17]||(t[17]=(0,o.Lk)("h4",null,"收集后照片路径:",-1)),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.fileListAfter,((e,a)=>((0,o.uX)(),(0,o.CE)("div",{key:"after-"+a},[(0,o.Lk)("div",null,"名称: "+(0,s.v_)(e.name),1),(0,o.Lk)("div",null,"URL: "+(0,s.v_)(e.url),1),(0,o.Lk)("div",null,[(0,o.Lk)("img",{src:e.url,style:{"max-width":"200px","max-height":"200px"}},null,8,Pe)]),t[15]||(t[15]=(0,o.Lk)("hr",null,null,-1))])))),128))])])),_:1})])),_:1}))])),_:1},8,["model","rules"])),[[V,l.loading]])]),(0,o.bF)(C,{modelValue:l.showUploadProgress,"onUpdate:modelValue":t[7]||(t[7]=e=>l.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,o.k6)((()=>[(0,o.Lk)("div",Ae,[t[18]||(t[18]=(0,o.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,o.bF)(R,{percentage:l.uploadPercentage,format:l.percentageFormat,status:100===l.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,o.Lk)("p",Se,(0,s.v_)(l.uploadStatus),1)])])),_:1},8,["modelValue"]),t[19]||(t[19]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var Ke={name:"EditRecordView",components:{ArrowLeft:Q.nkM,Plus:Q.FWt,Clock:Q.zD7,ElImageViewer:he.Tg},setup(){const e=(0,i.rd)(),t=(0,i.lq)(),a=(0,f.KR)(null),l=(0,f.KR)(!1),r=(0,f.KR)(!1),n=(0,f.KR)(""),s=(0,f.KR)([]),u=(0,f.KR)([]),d=(0,f.KR)([]),c=(0,f.KR)([]),p=(0,f.KR)([]),m=(0,f.KR)(!1),g=(0,f.KR)(0),v=(0,f.KR)(""),b=(0,f.KR)(!1),w=(0,f.KR)(0),y=(0,f.KR)("准备上传..."),_=(0,f.KR)(!1),F=e=>{if(!e)return[];console.log("解析照片路径，原始值:",e,"类型:",typeof e);try{if(Array.isArray(e))return console.log("照片路径已经是数组:",e),e;if("string"===typeof e){if(e.startsWith("[")&&e.endsWith("]")){const t=JSON.parse(e);return console.log("照片路径解析为JSON数组:",t),t}if(e.includes(",")){const t=e.split(",").map((e=>e.trim())).filter((e=>e));return console.log("照片路径解析为逗号分隔字符串:",t),t}return console.log("照片路径解析为单个字符串:",[e]),[e]}return console.log("照片路径类型未知，尝试转换为字符串:",String(e)),[String(e)]}catch(t){return console.error("解析照片路径失败:",t),"string"===typeof e?[e]:[]}},I=(0,o.EW)((()=>!t.params.id||"new"===t.params.id)),L=(0,o.EW)((()=>Qt.state.isLoggedIn&&3===Qt.state.user.role_id)),R=(0,f.Kh)({unitId:"",wasteTypeId:"",location:"",collectionDate:"",collectionTime:"",quantity:0,recordId:null,creatorId:Qt.state.user?.id||null,photo_path_before:"",photo_path_after:"",remarks:""}),C={unitId:[{required:!0,message:"请选择单位",trigger:"change"}],wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],location:[{required:!0,message:"请输入废物产生地点",trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,o.sV)((async()=>{l.value=!0;try{await U(),L.value&&await V(),I.value?!L.value&&Qt.state.user&&(R.unitId=Qt.state.user.unit_id,await W(R.unitId)):await x()}catch(e){console.error("初始化数据失败:",e),h.nk.error("加载数据失败，请刷新重试")}finally{l.value=!1}}));const V=async()=>{try{const e=await Ut.get(k.endpoints.units);u.value=e.data}catch(e){console.error("获取单位列表失败:",e),h.nk.error("获取单位列表失败")}},W=async e=>{try{const t=await Ut.get(k.endpoints.units),a=t.data.find((t=>t.id===parseInt(e)));a&&(n.value=a.name)}catch(t){console.error("获取单位信息失败:",t)}},U=async()=>{try{const e=await Ut.get(k.endpoints.wasteTypes);s.value=e.data}catch(e){console.error("获取废物类型失败:",e),h.nk.error("获取废物类型失败")}},x=async()=>{try{l.value=!0;const e=await Ut.get(`${k.endpoints.wasteRecords}/detail/${t.params.id}`),a=e.data;if(console.log("获取到的记录详情:",a),R.unitId=a.unit_id,R.wasteTypeId=a.waste_type_id,R.location=a.location,R.recordId=a.id,a.collection_start_time){const e=new Date(a.collection_start_time);R.collectionDate=e.toISOString().slice(0,10),R.collectionTime=e.toTimeString().slice(0,5)}if(R.quantity=a.quantity,a.photo_path_before){console.log("收集前照片路径:",a.photo_path_before);const e=F(a.photo_path_before);console.log("解析后的收集前照片路径:",e),d.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集前照片完整URL:",t),{name:e.split("/").pop(),url:t}}))}if(a.photo_path_after){console.log("收集后照片路径:",a.photo_path_after);const e=F(a.photo_path_after);console.log("解析后的收集后照片路径:",e),c.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const a=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${a}`}return console.log("收集后照片完整URL:",t),{name:e.split("/").pop(),url:t}}))}n.value=a.unit_name,v.value=a.created_at,X([...d.value,...c.value])}catch(e){console.error("获取记录详情失败:",e),h.nk.error("获取记录详情失败")}finally{l.value=!1}},E=async e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],a=t.includes(e.type);if(!a)return h.nk.error("只能上传图片文件!"),!1;const l=52428800;if(e.size>l)return h.nk.error("图片大小不能超过50MB!"),!1;const o=2097152;return e.size>o&&(_.value=!0),!0},T=(e,t)=>(console.log("收集前照片变更:",e),Q(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集前照片添加raw属性:",e.raw)),d.value=t,X([...d.value,...c.value]),!1),P=(e,t)=>{console.log("收集前照片移除:",e),d.value=t,Q([...d.value,...c.value])||(_.value=!1),X([...d.value,...c.value])},A=(e,t)=>(console.log("收集后照片变更:",e),Q(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集后照片添加raw属性:",e.raw)),c.value=t,X([...d.value,...c.value]),!1),S=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,Q([...d.value,...c.value])||(_.value=!1),X([...d.value,...c.value])},X=e=>{p.value=e.map((e=>e.url?(console.log("预览图片URL:",e.url),e.url):e.raw?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e.raw)),console.log("预览图片从raw创建:",e._blobUrl),e._blobUrl):e instanceof File?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e)),console.log("预览图片从File创建:",e._blobUrl),e._blobUrl):"")).filter((e=>e)),console.log("预览图片列表:",p.value)},K=e=>{console.log("预览图片:",e),X([...d.value,...c.value]);const t=p.value.findIndex((t=>{if(e.url)return t===e.url;if(e.raw){const a=URL.createObjectURL(e.raw),l=t===a;return URL.revokeObjectURL(a),l}return!1}));g.value=-1!==t?t:0,m.value=!0},$=()=>{m.value=!1},Q=e=>{const t=2097152;return e.some((e=>e.size>t))},q=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);w.value=t,y.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},D=e=>100===e?"完成":`${e}%`,B=async()=>{a.value&&await a.value.validate((async e=>{if(!e)return console.log("表单验证失败"),h.nk.error("请填写所有必填字段"),!1;w.value=0,y.value="正在上传文件...",b.value=!0;try{const e=new FormData;if(e.append("unitId",R.unitId),e.append("wasteTypeId",R.wasteTypeId),e.append("location",R.location),e.append("collectionDate",R.collectionDate),e.append("collectionTime",R.collectionTime),e.append("quantity",R.quantity),e.append("remarks",R.remarks||""),d.value.length>0){const t=d.value.filter((e=>e.raw)),a=d.value.filter((e=>!e.raw));if(t.length>0){if(console.log("有新上传的收集前照片，需要合并现有照片"),t.forEach((t=>{t.raw&&(console.log("添加新的收集前照片:",t.raw.name),e.append("photo_before",t.raw))})),a.length>0){const t=a.map((e=>{let t=e.url;const a=window.location.origin;return t.startsWith(a)&&(t=t.substring(a.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集前照片路径:",t),e.append("photo_path_before",JSON.stringify(t))}}else if(a.length>0){const t=a.map((e=>{let t=e.url;const a=window.location.origin;return t.startsWith(a)&&(t=t.substring(a.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集前照片路径(无新照片):",t),e.append("photo_path_before",JSON.stringify(t))}}else e.append("photo_path_before",JSON.stringify([]));if(c.value.length>0){const t=c.value.filter((e=>e.raw)),a=c.value.filter((e=>!e.raw));if(t.length>0){if(console.log("有新上传的收集后照片，需要合并现有照片"),t.forEach((t=>{t.raw&&(console.log("添加新的收集后照片:",t.raw.name),e.append("photo_after",t.raw))})),a.length>0){const t=a.map((e=>{let t=e.url;const a=window.location.origin;return t.startsWith(a)&&(t=t.substring(a.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集后照片路径:",t),e.append("photo_path_after",JSON.stringify(t))}}else if(a.length>0){const t=a.map((e=>{let t=e.url;const a=window.location.origin;return t.startsWith(a)&&(t=t.substring(a.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集后照片路径(无新照片):",t),e.append("photo_path_after",JSON.stringify(t))}}else e.append("photo_path_after",JSON.stringify([]));console.log("FormData内容:");for(let[t,a]of e.entries())a instanceof File?console.log(`${t}: File - ${a.name} (${a.type}, ${a.size} bytes)`):console.log(`${t}: ${a}`);R.recordId?(await Ut.putForm(`${k.endpoints.wasteRecords}/${R.recordId}`,e,q),h.nk.success("废物记录更新成功")):(await Ut.postForm(k.endpoints.wasteRecords,e,q),h.nk.success("废物记录添加成功")),b.value=!1,M()}catch(t){console.error("提交表单失败:",t),t.response&&t.response.data?(console.error("服务器返回错误:",t.response.data),h.nk.error(`提交表单失败: ${t.response.data.error||"未知错误"}`)):h.nk.error("提交表单失败，请检查网络连接"),b.value=!1}}))},M=()=>{L.value?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:Qt.state.user.unit_id}})};return{form:R,rules:C,recordForm:a,loading:l,submitting:r,unitName:n,wasteTypes:s,units:u,fileListBefore:d,fileListAfter:c,previewImages:p,showViewer:m,previewIndex:g,isNew:I,isSuperAdmin:L,parsePhotoPath:F,handlePhotoBeforeChange:T,handlePhotoBeforeRemove:P,handlePhotoAfterChange:A,handlePhotoAfterRemove:S,handlePictureCardPreview:K,handleBeforeUpload:E,closeViewer:$,submitForm:B,goBack:M,showUploadProgress:b,uploadPercentage:w,uploadStatus:y,percentageFormat:D,showLargeFileWarning:_}}};const $e=(0,R.A)(Ke,[["render",Xe],["__scopeId","data-v-23929916"]]);var Qe=$e;const qe={class:"user-management-container"},De={class:"header"},Be={class:"content"},Me={class:"toolbar"},je={key:0,class:"password-hint"},Oe={key:1,class:"password-hint"},Ne={class:"dialog-footer"};function Ye(e,t,a,l,r,n){const i=(0,o.g2)("arrow-left"),s=(0,o.g2)("el-icon"),u=(0,o.g2)("plus"),d=(0,o.g2)("el-button"),c=(0,o.g2)("el-table-column"),p=(0,o.g2)("el-popconfirm"),m=(0,o.g2)("el-table"),g=(0,o.g2)("el-input"),h=(0,o.g2)("el-form-item"),f=(0,o.g2)("el-option"),v=(0,o.g2)("el-select"),b=(0,o.g2)("el-form"),k=(0,o.g2)("el-dialog"),w=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",qe,[(0,o.Lk)("div",De,[(0,o.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>l.goBack&&l.goBack(...e))},[(0,o.bF)(s,null,{default:(0,o.k6)((()=>[(0,o.bF)(i)])),_:1}),t[8]||(t[8]=(0,o.eW)(" 返回 "))]),t[9]||(t[9]=(0,o.Lk)("h1",null,"人员管理",-1)),t[10]||(t[10]=(0,o.Lk)("div",null,null,-1))]),(0,o.Lk)("div",Be,[(0,o.Lk)("div",Me,[(0,o.bF)(d,{type:"primary",onClick:l.openAddDialog},{default:(0,o.k6)((()=>[(0,o.bF)(s,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1}),t[11]||(t[11]=(0,o.eW)(" 添加用户 "))])),_:1},8,["onClick"])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(m,{data:l.users,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,o.k6)((()=>[(0,o.bF)(c,{prop:"id",label:"ID",width:"60"}),(0,o.bF)(c,{prop:"username",label:"姓名",width:"120"}),(0,o.bF)(c,{prop:"phone",label:"手机号",width:"140"}),(0,o.bF)(c,{prop:"role_name",label:"角色",width:"120"}),(0,o.bF)(c,{prop:"unit_name",label:"单位","min-width":"120"}),(0,o.bF)(c,{label:"操作",width:"180",fixed:"right"},{default:(0,o.k6)((e=>[(0,o.bF)(d,{size:"small",onClick:t=>l.handleEdit(e.row)},{default:(0,o.k6)((()=>t[12]||(t[12]=[(0,o.eW)("编辑")]))),_:2},1032,["onClick"]),(0,o.bF)(p,{title:"确定要删除此用户吗？",onConfirm:t=>l.handleDelete(e.row)},{reference:(0,o.k6)((()=>[(0,o.bF)(d,{size:"small",type:"danger"},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"])),[[w,l.loading]])]),(0,o.bF)(k,{modelValue:l.dialogVisible,"onUpdate:modelValue":t[7]||(t[7]=e=>l.dialogVisible=e),title:l.isEdit?"编辑用户":"添加用户",width:"500px"},{footer:(0,o.k6)((()=>[(0,o.Lk)("span",Ne,[(0,o.bF)(d,{onClick:t[6]||(t[6]=e=>l.dialogVisible=!1)},{default:(0,o.k6)((()=>t[14]||(t[14]=[(0,o.eW)("取消")]))),_:1}),(0,o.bF)(d,{type:"primary",onClick:l.submitForm,loading:l.formLoading},{default:(0,o.k6)((()=>t[15]||(t[15]=[(0,o.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,o.k6)((()=>[(0,o.bF)(b,{ref:"userForm",model:l.form,rules:l.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,o.k6)((()=>[(0,o.bF)(h,{label:"姓名",prop:"username"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:l.form.username,"onUpdate:modelValue":t[1]||(t[1]=e=>l.form.username=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),(0,o.bF)(h,{label:"手机号",prop:"phone"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:l.form.phone,"onUpdate:modelValue":t[2]||(t[2]=e=>l.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,o.bF)(h,{label:"角色",prop:"roleId"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:l.form.roleId,"onUpdate:modelValue":t[3]||(t[3]=e=>l.form.roleId=e),placeholder:"请选择角色",style:{width:"100%"}},{default:(0,o.k6)((()=>[l.isSuperAdmin?((0,o.uX)(),(0,o.Wv)(f,{key:0,value:3,label:"超级管理员"})):(0,o.Q3)("",!0),(0,o.bF)(f,{value:2,label:"单位管理员"}),(0,o.bF)(f,{value:1,label:"基层员工"})])),_:1},8,["modelValue"])])),_:1}),3!==l.form.roleId?((0,o.uX)(),(0,o.Wv)(h,{key:0,label:"单位",prop:"unitId"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:l.form.unitId,"onUpdate:modelValue":t[4]||(t[4]=e=>l.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"},disabled:!l.isSuperAdmin&&l.isEdit},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(l.units,(e=>((0,o.uX)(),(0,o.Wv)(f,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})):(0,o.Q3)("",!0),2===l.form.roleId||3===l.form.roleId?((0,o.uX)(),(0,o.Wv)(h,{key:1,label:"密码",prop:"password"},{default:(0,o.k6)((()=>[(0,o.bF)(g,{modelValue:l.form.password,"onUpdate:modelValue":t[5]||(t[5]=e=>l.form.password=e),placeholder:"请输入密码",type:"password","show-password":""},null,8,["modelValue"]),l.isEdit?((0,o.uX)(),(0,o.CE)("div",Oe,"不修改密码请留空")):((0,o.uX)(),(0,o.CE)("div",je,"管理员账号必须设置密码"))])),_:1})):(0,o.Q3)("",!0)])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),t[16]||(t[16]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var ze={name:"UserManagement",components:{ArrowLeft:Q.nkM,Plus:Q.FWt},setup(){const e=(0,i.rd)(),t=(0,f.KR)(!1),a=(0,f.KR)(!1),l=(0,f.KR)(!1),r=(0,f.KR)(!1),n=(0,f.KR)(null),s=(0,f.KR)([]),u=(0,f.KR)([]),d=(0,o.EW)((()=>Qt.state.isLoggedIn&&3===Qt.state.user.role_id)),c=(0,o.EW)((()=>Qt.state.isLoggedIn?Qt.state.user.unit_id:null)),p=(0,f.Kh)({id:null,username:"",phone:"",roleId:1,unitId:null,password:""}),m={username:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],unitId:[{required:!0,message:"请选择单位",trigger:"change"}],password:[{required:function(){return!r.value&&(2===p.roleId||3===p.roleId)},message:"请输入密码",trigger:"blur"},{min:1,max:20,message:"长度在 1 到 20 个字符",trigger:"blur"}]},g=async()=>{t.value=!0;try{let e;e=d.value?await Ut.get(k.endpoints.users):await Ut.get(`${k.endpoints.units}/${c.value}/users`),s.value=e.data}catch(e){console.error("Error fetching users:",e),h.nk.error("获取用户列表失败")}finally{t.value=!1}},v=async()=>{try{const e=await Ut.get(k.endpoints.units);u.value=e.data}catch(e){console.error("Error fetching units:",e),h.nk.error("获取单位列表失败")}},b=()=>{r.value=!1,_(),l.value=!0,d.value||(p.unitId=c.value)},w=e=>{r.value=!0,p.id=e.id,p.username=e.username,p.phone=e.phone,p.roleId=e.role_id,p.unitId=e.unit_id,p.password="",l.value=!0},y=async e=>{try{await Ut.delete(`${k.endpoints.users}/${e.id}`),h.nk.success("用户删除成功"),g()}catch(t){console.error("Error deleting user:",t);let e="删除用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),h.nk.error(e)}},_=()=>{n.value&&n.value.resetFields(),p.id=null,p.username="",p.phone="",p.roleId=1,p.unitId=null,p.password=""},F=()=>{n.value.validate((async e=>{if(e){a.value=!0;try{const e={username:p.username,phone:p.phone,roleId:p.roleId,unitId:3!==p.roleId?p.unitId:null};p.password&&(e.password=p.password),r.value?(await Ut.put(`${k.endpoints.users}/${p.id}`,e),h.nk.success("用户更新成功")):(await Ut.post(k.endpoints.users,e),h.nk.success("用户添加成功")),l.value=!1,g()}catch(t){console.error("Error submitting user form:",t);let e=r.value?"更新用户失败":"添加用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),h.nk.error(e)}finally{a.value=!1}}else h.nk.warning("请完成必填项")}))},I=()=>{e.back()};return(0,o.sV)((()=>{g(),v()})),{loading:t,formLoading:a,dialogVisible:l,isEdit:r,userForm:n,users:s,units:u,form:p,rules:m,isSuperAdmin:d,currentUnitId:c,openAddDialog:b,handleEdit:w,handleDelete:y,submitForm:F,goBack:I}}};const He=(0,R.A)(ze,[["render",Ye],["__scopeId","data-v-3c215db0"]]);var Je=He;const Ge={class:"admin-records-container"},Ze={class:"content"},et={class:"actions"},tt={class:"filter-header"},at={class:"filter-form-container"},lt={class:"quantity-range"},ot={class:"filter-actions"},rt={class:"records-wrapper"},nt={class:"card-header"},it={class:"card-actions"},st={key:0,class:"photo-preview"},ut=["onClick"],dt={key:0,class:"photo-count"},ct={key:1},pt={key:0,class:"photo-preview"},mt=["onClick"],gt={key:0,class:"photo-count"},ht={key:1},ft={class:"operation-buttons"},vt={key:0,class:"loading-more"},bt={key:1,class:"empty-block"};function kt(e,t,a,r,n,i){const u=(0,o.g2)("plus"),d=(0,o.g2)("el-icon"),c=(0,o.g2)("el-button"),p=(0,o.g2)("user"),m=(0,o.g2)("refresh"),g=(0,o.g2)("arrow-down"),h=(0,o.g2)("arrow-up"),f=(0,o.g2)("el-option"),v=(0,o.g2)("el-select"),b=(0,o.g2)("el-form-item"),k=(0,o.g2)("el-col"),w=(0,o.g2)("el-date-picker"),y=(0,o.g2)("el-row"),_=(0,o.g2)("el-input-number"),F=(0,o.g2)("el-input"),I=(0,o.g2)("el-form"),L=(0,o.g2)("el-card"),R=(0,o.g2)("download"),C=(0,o.g2)("el-table-column"),V=(0,o.g2)("el-image"),W=(0,o.g2)("el-table"),U=(0,o.g2)("loading"),x=(0,o.g2)("el-empty"),E=(0,o.g2)("el-image-viewer"),T=(0,o.gN)("loading");return(0,o.uX)(),(0,o.CE)("div",Ge,[t[19]||(t[19]=(0,o.Lk)("div",{class:"header"},[(0,o.Lk)("h1",null,"危险废物管理系统 - 全部记录")],-1)),(0,o.Lk)("div",Ze,[(0,o.Lk)("div",et,[(0,o.bF)(c,{type:"primary",onClick:r.addNewRecord},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(u)])),_:1}),t[7]||(t[7]=(0,o.eW)(" 新增填报 "))])),_:1},8,["onClick"]),(0,o.bF)(c,{type:"success",onClick:r.goToUserManagement},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(p)])),_:1}),t[8]||(t[8]=(0,o.eW)(" 人员管理 "))])),_:1},8,["onClick"]),(0,o.bF)(c,{onClick:r.refreshRecords},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(m)])),_:1}),t[9]||(t[9]=(0,o.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,o.bF)(L,{class:"filter-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",tt,[t[10]||(t[10]=(0,o.Lk)("h3",null,"筛选条件",-1)),(0,o.bF)(c,{type:"primary",link:"",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,o.k6)((()=>[(0,o.eW)((0,s.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,o.uX)(),(0,o.Wv)(d,{key:1},{default:(0,o.k6)((()=>[(0,o.bF)(h)])),_:1})):((0,o.uX)(),(0,o.Wv)(d,{key:0},{default:(0,o.k6)((()=>[(0,o.bF)(g)])),_:1}))])),_:1})]),(0,o.bo)((0,o.Lk)("div",at,[(0,o.bF)(I,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,o.k6)((()=>[(0,o.bF)(y,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(k,{span:12},{default:(0,o.k6)((()=>[(0,o.bF)(b,{label:"所属单位"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.unitId=e),placeholder:"选择单位",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.units,(e=>((0,o.uX)(),(0,o.Wv)(f,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(k,{span:12},{default:(0,o.k6)((()=>[(0,o.bF)(b,{label:"收集时间"},{default:(0,o.k6)((()=>[(0,o.bF)(w,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.bF)(y,{gutter:20},{default:(0,o.k6)((()=>[(0,o.bF)(k,{span:8},{default:(0,o.k6)((()=>[(0,o.bF)(b,{label:"废物类型"},{default:(0,o.k6)((()=>[(0,o.bF)(v,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,o.k6)((()=>[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.wasteTypes,(e=>((0,o.uX)(),(0,o.Wv)(f,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,o.bF)(k,{span:8},{default:(0,o.k6)((()=>[(0,o.bF)(b,{label:"数量范围(吨)"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",lt,[(0,o.bF)(_,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"47%"}},null,8,["modelValue"]),t[11]||(t[11]=(0,o.Lk)("span",{class:"range-separator"},"至",-1)),(0,o.bF)(_,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"47%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,o.bF)(k,{span:8},{default:(0,o.k6)((()=>[(0,o.bF)(b,{label:"产生地点"},{default:(0,o.k6)((()=>[(0,o.bF)(F,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,o.Lk)("div",ot,[(0,o.bF)(c,{type:"primary",onClick:r.applyFilter},{default:(0,o.k6)((()=>t[12]||(t[12]=[(0,o.eW)("筛选")]))),_:1},8,["onClick"]),(0,o.bF)(c,{onClick:r.resetFilter},{default:(0,o.k6)((()=>t[13]||(t[13]=[(0,o.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[l.aG,r.showFilterPanel]])])),_:1}),(0,o.Lk)("div",rt,[(0,o.bF)(L,{class:"records-card"},{default:(0,o.k6)((()=>[(0,o.Lk)("div",nt,[t[15]||(t[15]=(0,o.Lk)("h3",null,"所有废物记录",-1)),(0,o.Lk)("div",it,[(0,o.bF)(c,{type:"warning",onClick:r.exportRecords},{default:(0,o.k6)((()=>[(0,o.bF)(d,null,{default:(0,o.k6)((()=>[(0,o.bF)(R)])),_:1}),t[14]||(t[14]=(0,o.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,o.bo)(((0,o.uX)(),(0,o.Wv)(W,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:"500",onScroll:r.handleScroll},{default:(0,o.k6)((()=>[(0,o.bF)(C,{prop:"unit_name",label:"单位",width:"100"}),(0,o.bF)(C,{prop:"waste_type_name",label:"废物类型",width:"100"}),(0,o.bF)(C,{prop:"location",label:"产生地点"}),(0,o.bF)(C,{prop:"collection_start_time",label:"收集开始时间",width:"160"}),(0,o.bF)(C,{label:"数量(吨)",width:"80"},{default:(0,o.k6)((e=>[(0,o.eW)((0,s.v_)(parseFloat(e.row.quantity).toFixed(3)),1)])),_:1}),(0,o.bF)(C,{prop:"creator_name",label:"汇报人",width:"100"}),(0,o.bF)(C,{prop:"created_at",label:"记录时间",width:"160"}),(0,o.bF)(C,{label:"现场照片（清理前）",width:"120",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_before?((0,o.uX)(),(0,o.CE)("div",st,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),a)},[(0,o.bF)(V,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,ut)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,o.uX)(),(0,o.CE)("div",dt,(0,s.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",ct,"无"))])),_:1}),(0,o.bF)(C,{label:"现场照片（清理后）",width:"120",align:"center"},{default:(0,o.k6)((e=>[e.row.photo_path_after?((0,o.uX)(),(0,o.CE)("div",pt,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,a)=>((0,o.uX)(),(0,o.CE)("div",{key:a,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),a)},[(0,o.bF)(V,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,mt)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,o.uX)(),(0,o.CE)("div",gt,(0,s.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,o.Q3)("",!0)])):((0,o.uX)(),(0,o.CE)("span",ht,"无"))])),_:1}),(0,o.bF)(C,{label:"操作",width:"70",fixed:"right"},{default:(0,o.k6)((e=>[(0,o.Lk)("div",ft,[(0,o.bF)(c,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,o.k6)((()=>t[16]||(t[16]=[(0,o.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,o.bF)(c,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,o.k6)((()=>t[17]||(t[17]=[(0,o.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","onScroll"])),[[T,r.loading]]),r.loadingMore?((0,o.uX)(),(0,o.CE)("div",vt,[(0,o.bF)(d,{class:"loading"},{default:(0,o.k6)((()=>[(0,o.bF)(U)])),_:1}),t[18]||(t[18]=(0,o.eW)(" 加载更多... "))])):(0,o.Q3)("",!0),0!==r.records.length||r.loading?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("div",bt,[(0,o.bF)(x,{description:"暂无废物记录"})]))])),_:1})])]),t[20]||(t[20]=(0,o.Lk)("div",{class:"footer"},[(0,o.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,o.uX)(),(0,o.Wv)(E,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,o.Q3)("",!0)])}const wt=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},yt=(e,t)=>{if(!e.photos)return[];try{const a=JSON.parse(e.photos);return Array.isArray(a)?a.filter((e=>e.type===t)):[]}catch(a){return console.error("解析照片JSON失败:",a),[]}};var _t={name:"AdminRecordsView",components:{Plus:Q.FWt,Refresh:Q.C42,User:Q.KJW,ArrowDown:Q.yd$,ArrowUp:Q.DoI,Download:Q.f5X,ElImageViewer:he.Tg,Loading:Q.Rhj},setup(){const e=(0,i.rd)(),t=(0,f.KR)([]),a=(0,f.KR)(!1),l=(0,f.KR)([]),r=(0,f.KR)([]),n=(0,f.KR)(!0),s=k.baseURL,u=(0,f.KR)(!1),d=(0,f.KR)([]),c=(0,f.KR)(0),p=(0,f.KR)(1),m=(0,f.KR)(20),g=(0,f.KR)(!0),b=(0,f.KR)(!1),w=(0,f.Kh)({unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:""}),y=(0,o.EW)((()=>t.value.filter((e=>{if(w.unitId&&e.unit_id!==w.unitId)return!1;if(w.wasteTypeId&&e.waste_type_id!==w.wasteTypeId)return!1;if(null!==w.minQuantity&&parseFloat(e.quantity)<w.minQuantity)return!1;if(null!==w.maxQuantity&&parseFloat(e.quantity)>w.maxQuantity)return!1;if(w.location&&!e.location.toLowerCase().includes(w.location.toLowerCase()))return!1;if(w.dateRange&&2===w.dateRange.length){const t=new Date(w.dateRange[0]),a=new Date(w.dateRange[1]);if(a.setHours(23,59,59,999),!e.collection_start_time)return!1;{const l=_(e.collection_start_time);if(l<t||l>a)return!1}}return!0})))),_=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)};(0,o.sV)((async()=>{if(!Qt.state.isLoggedIn||3!==Qt.state.user.role_id)return h.nk.error("权限不足"),void e.push("/login");await Promise.all([F(),I(),L()])}));const F=async()=>{try{const e=await v.A.get(k.getUrl(k.endpoints.units));l.value=e.data}catch(e){console.error("获取单位列表失败:",e),h.nk.error("获取单位列表失败")}},I=async()=>{try{const e=await v.A.get(k.getUrl(k.endpoints.wasteTypes));r.value=e.data}catch(e){console.error("获取废物类型列表失败:",e),h.nk.error("获取废物类型列表失败")}},L=async(e=!1)=>{e?b.value=!0:(a.value=!0,p.value=1,t.value=[]);try{const a={page:p.value,pageSize:m.value,wasteTypeId:w.wasteTypeId,minQuantity:w.minQuantity,maxQuantity:w.maxQuantity,location:w.location};w.dateRange&&2===w.dateRange.length&&(a.dateRange=JSON.stringify(w.dateRange));const l=await v.A.get(`${k.getUrl(k.endpoints.wasteRecords)}/user/${Qt.state.user.id}`,{params:a}),o=l.data.records.map((e=>({...e,created_at:R(e.created_at),collection_start_time:R(e.collection_start_time)})));t.value=e?[...t.value,...o]:o,g.value=l.data.hasMore,g.value&&p.value++}catch(l){console.error("获取废物记录失败:",l),h.nk.error("获取废物记录失败")}finally{a.value=!1,b.value=!1}},R=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})},C=()=>{L()},V=()=>{3===Qt.state.user.role_id?e.push("/record/new"):e.push(`/unit/${Qt.state.user.unit_id}`)},W=()=>{e.push("/user-management")},U=t=>{e.push(`/record/${t}`)},x=async()=>{await L(),h.nk.success("筛选已应用")},E=async()=>{w.unitId=null,w.dateRange=null,w.wasteTypeId=null,w.minQuantity=null,w.maxQuantity=null,w.location="",await L(),h.nk.info("筛选条件已重置")},T=async()=>{if(0!==y.value.length)try{a.value=!0;const e=await v.A.get(`${k.getUrl(k.endpoints.wasteRecords)}/export/user/${Qt.state.user.id}`,{params:{unitId:w.unitId,wasteTypeId:w.wasteTypeId,minQuantity:w.minQuantity,maxQuantity:w.maxQuantity,location:w.location,dateRange:w.dateRange}}),t=e.data.map((e=>({...e,created_at:R(e.created_at),collection_start_time:R(e.collection_start_time)}))),o=[{title:"单位",field:"unit_name",width:15},{title:"废物类型",field:"waste_type_name",width:15},{title:"产生地点",field:"location",width:20},{title:"收集开始时间",field:"collection_start_time",width:20,type:"datetime"},{title:"数量(吨)",field:"quantity",width:12,type:"number"},{title:"记录时间",field:"created_at",width:20,type:"datetime"}];let n="全部废物记录";if(w.unitId){const e=l.value.find((e=>e.id===w.unitId));e&&(n=`${e.name}_废物记录`)}if(w.wasteTypeId){const e=r.value.find((e=>e.id===w.wasteTypeId));e&&(n+=`_${e.name}`)}ve(t,n,o),h.nk.success("导出成功")}catch(e){console.error("导出记录失败:",e),h.nk.error("导出记录失败")}finally{a.value=!1}else h.nk.warning("没有可导出的记录")},P=e=>{fe.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await v.A.delete(`${k.getUrl(k.endpoints.wasteRecords)}/${e.id}`),h.nk.success("删除成功"),await L()}catch(t){console.error("删除记录失败:",t),h.nk.error("删除记录失败")}})).catch((()=>{h.nk.info("已取消删除")}))},A=(e,t)=>{const a=Array.isArray(e)?e:[e];d.value=a.map((e=>`${s}${e}`)),c.value=t||0,u.value=!0},S=()=>{u.value=!1},X=async e=>{const t=e.target;t&&t.scrollHeight&&!b.value&&g.value&&t.scrollHeight-t.scrollTop-t.clientHeight<100&&await L(!0)};return{records:t,filteredRecords:y,loading:a,units:l,wasteTypes:r,showFilterPanel:n,filterForm:w,applyFilter:x,resetFilter:E,exportRecords:T,parsePhotoPath:wt,getPhotosByType:yt,refreshRecords:C,addNewRecord:V,goToUserManagement:W,editRecord:U,confirmDelete:P,showViewer:u,previewImages:d,previewIndex:c,previewPhoto:A,closeViewer:S,baseUrl:s,page:p,pageSize:m,hasMore:g,loadingMore:b,handleScroll:X}}};const Ft=(0,R.A)(_t,[["render",kt],["__scopeId","data-v-02c0f4e0"]]);var It=Ft;const Lt=[{path:"/login",name:"Login",component:Ce,meta:{requiresAuth:!1}},{path:"/user-management",name:"UserManagement",component:Je,meta:{requiresAuth:!0,requiresManager:!0}},{path:"/",name:"UnitSelection",component:V,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/admin-records",name:"AdminRecords",component:It,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/record/new",name:"EditRecord",component:Qe,props:{id:null},meta:{requiresAuth:!0}},{path:"/record/:id",name:"EditRecord",component:Qe,props:!0,meta:{requiresAuth:!0}},{path:"/unit/:id",name:"WasteForm",component:B,props:!0,meta:{requiresAuth:!0}},{path:"/records/:unitId",name:"RecordsList",component:we,props:!0,meta:{requiresAuth:!0}}],Rt=(0,i.aE)({history:(0,i.LA)("/"),routes:Lt});Rt.beforeEach(((e,t,a)=>{const l=e.matched.some((e=>e.meta.requiresAuth)),o=e.matched.some((e=>e.meta.requiresSuperAdmin)),r=e.matched.some((e=>e.meta.requiresManager));if(!l||Qt.state.isLoggedIn)if(o&&Qt.state.isLoggedIn&&3!==Qt.state.user.role_id)a({name:"WasteForm",params:{id:Qt.state.user.unit_id}});else if(r&&Qt.state.isLoggedIn&&1===Qt.state.user.role_id)a({name:"WasteForm",params:{id:Qt.state.user.unit_id}});else{if("Login"!==e.name||!Qt.state.isLoggedIn)return"/"===e.path&&Qt.state.isLoggedIn?3===Qt.state.user.role_id?void a({name:"AdminRecords"}):2===Qt.state.user.role_id?void a({name:"RecordsList",params:{unitId:Qt.state.user.unit_id}}):void a({name:"WasteForm",params:{id:Qt.state.user.unit_id}}):void("WasteForm"===e.name&&Qt.state.isLoggedIn&&3!==Qt.state.user.role_id&&Qt.state.user.unit_id!==parseInt(e.params.id)?a({name:"WasteForm",params:{id:Qt.state.user.unit_id}}):a());3===Qt.state.user.role_id?a({name:"AdminRecords"}):2===Qt.state.user.role_id?a({name:"RecordsList",params:{unitId:Qt.state.user.unit_id}}):a({name:"WasteForm",params:{id:Qt.state.user.unit_id}})}else a({name:"Login"})}));var Ct=Rt;const Vt=v.A.create({baseURL:k.baseURL,timeout:3e5,headers:{"Content-Type":"application/json"},maxContentLength:52428800,maxBodyLength:52428800});Vt.interceptors.request.use((e=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return t&&(e.headers.Authorization=`Bearer ${t}`),e}),(e=>(console.error("Request error:",e),Promise.reject(e)))),Vt.interceptors.response.use((e=>e),(e=>{if(e.response)switch(e.response.status){case 401:if(e.config.url.includes("/api/login"))return Promise.reject(e);Qt.logout(),h.nk.error("登录已过期，请重新登录"),Ct.push("/login");break;case 403:h.nk.error("没有权限访问该资源");break;case 404:h.nk.error("请求的资源不存在");break;case 500:h.nk.error("服务器错误，请稍后重试");break;default:h.nk.error(e.response.data?.error||"请求失败")}else e.request?h.nk.error("网络错误，请检查网络连接"):h.nk.error("请求配置错误");return Promise.reject(e)}));const Wt={get(e,t={}){return Vt.get(e,{params:t})},post(e,t={}){return Vt.post(e,t)},postForm(e,t,a){const l={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};return"function"===typeof a&&(l.onUploadProgress=a),Vt.post(e,t,l)},put(e,t={}){return Vt.put(e,t)},putForm(e,t,a){const l={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};return"function"===typeof a&&(l.onUploadProgress=a),Vt.put(e,t,l)},delete(e){return Vt.delete(e)},defaults:Vt.defaults};var Ut=Wt;const xt={user:null,token:null,isLoggedIn:!1,loading:!1,error:null},Et=(0,f.Kh)({...xt}),Tt=()=>{const e=localStorage.getItem("user"),t=localStorage.getItem("token");if(e&&t)try{const a=JSON.parse(e);Et.user=a,Et.token=t,Et.isLoggedIn=!0,Ut.defaults&&Ut.defaults.headers&&(Ut.defaults.headers.common["Authorization"]=`Bearer ${t}`)}catch(a){console.error("Error parsing saved user data:",a),localStorage.removeItem("user"),localStorage.removeItem("token")}},Pt=async(e,t,a=!1,l=1)=>{Et.loading=!0,Et.error=null,console.log("auth.login 开始执行，手机号:",e,"用户类型:",l);try{const o={phone:e,rememberMe:a,userType:l};null!==t&&void 0!==t&&""!==t?(o.password=t,console.log("auth.login 发送密码参数")):console.log("auth.login 不发送密码参数"),console.log("发送登录请求，数据:",o);const r=await Ut.post(k.endpoints.login,o);console.log("登录请求成功响应:",r.data);const{token:n,...i}=r.data;return Et.user=i,Et.token=n,Et.isLoggedIn=!0,Ut.defaults&&Ut.defaults.headers&&(Ut.defaults.headers.common["Authorization"]=`Bearer ${n}`),a?(localStorage.setItem("user",JSON.stringify(i)),localStorage.setItem("token",n)):(sessionStorage.setItem("user",JSON.stringify(i)),sessionStorage.setItem("token",n)),{success:!0,user:i}}catch(o){return Et.error=o.response?.data?.error||"登录失败，请检查网络连接",console.error("Login error:",o),{success:!1,error:Et.error}}finally{Et.loading=!1}},At=()=>{Et.user=null,Et.token=null,Et.isLoggedIn=!1,Ut.defaults&&Ut.defaults.headers&&delete Ut.defaults.headers.common["Authorization"],localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")},St=()=>Et.isLoggedIn&&Et.user&&3===Et.user.role_id,Xt=()=>Et.isLoggedIn&&Et.user&&2===Et.user.role_id,Kt=()=>Et.user?Et.user.id:null,$t=()=>Et.user?Et.user.unit_id:null;Tt();var Qt={state:Et,login:Pt,logout:At,isAdmin:St,isUnitAdmin:Xt,getUserId:Kt,getUnitId:$t},qt={name:"AppHeader",setup(){const e=(0,i.rd)(),t=(0,o.EW)((()=>Qt.state.isLoggedIn?Qt.state.user.username||Qt.state.user.phone:"")),a=()=>{Qt.logout(),h.nk.success("已退出登录"),e.push("/login")};return{auth:Qt,userName:t,handleLogout:a}}};const Dt=(0,R.A)(qt,[["render",g],["__scopeId","data-v-ce673e6c"]]);var Bt=Dt,Mt={components:{AppHeader:Bt},setup(){const e=(0,i.lq)(),t=(0,o.EW)((()=>"/login"!==e.path));return{showHeader:t}}};const jt=(0,R.A)(Mt,[["render",n]]);var Ot=jt,Nt=a(2536),Yt=(a(4188),a(5186));const zt=(0,l.Ef)(Ot);zt.use(Ct),zt.use(Nt.A,{locale:Yt.A}),zt.mount("#app")}},t={};function a(l){var o=t[l];if(void 0!==o)return o.exports;var r=t[l]={exports:{}};return e[l].call(r.exports,r,r.exports,a),r.exports}a.m=e,function(){var e=[];a.O=function(t,l,o,r){if(!l){var n=1/0;for(d=0;d<e.length;d++){l=e[d][0],o=e[d][1],r=e[d][2];for(var i=!0,s=0;s<l.length;s++)(!1&r||n>=r)&&Object.keys(a.O).every((function(e){return a.O[e](l[s])}))?l.splice(s--,1):(i=!1,r<n&&(n=r));if(i){e.splice(d--,1);var u=o();void 0!==u&&(t=u)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[l,o,r]}}(),function(){a.d=function(e,t){for(var l in t)a.o(t,l)&&!a.o(e,l)&&Object.defineProperty(e,l,{enumerable:!0,get:t[l]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};a.O.j=function(t){return 0===e[t]};var t=function(t,l){var o,r,n=l[0],i=l[1],s=l[2],u=0;if(n.some((function(t){return 0!==e[t]}))){for(o in i)a.o(i,o)&&(a.m[o]=i[o]);if(s)var d=s(a)}for(t&&t(l);u<n.length;u++)r=n[u],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return a.O(d)},l=self["webpackChunkhazardous_waste_management_frontend"]=self["webpackChunkhazardous_waste_management_frontend"]||[];l.forEach(t.bind(null,0)),l.push=t.bind(null,l.push.bind(l))}();var l=a.O(void 0,[504],(function(){return a(4152)}));l=a.O(l)})();
//# sourceMappingURL=app.32620f95.js.map