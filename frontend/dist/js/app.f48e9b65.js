(function(){"use strict";var e={6906:function(e,t,o){var a=o(5130),l=o(6768);const r={id:"app"};function n(e,t,o,a,n,s){const i=(0,l.g2)("app-header"),u=(0,l.g2)("router-view");return(0,l.uX)(),(0,l.CE)("div",r,[a.showHeader?((0,l.uX)(),(0,l.Wv)(i,{key:0})):(0,l.Q3)("",!0),(0,l.bF)(u)])}var s=o(1387),i=o(4232);const u={class:"app-header"},d={key:0,class:"user-info"},c={class:"welcome-text"},p={key:0,class:"unit-tag"};function m(e,t,o,a,r,n){const s=(0,l.g2)("el-button");return(0,l.uX)(),(0,l.CE)("div",u,[t[2]||(t[2]=(0,l.Lk)("div",{class:"header-title"},[(0,l.Lk)("h1",null,"危险废物管理系统")],-1)),a.auth.state.isLoggedIn?((0,l.uX)(),(0,l.CE)("div",d,[(0,l.Lk)("span",c,[t[0]||(t[0]=(0,l.eW)(" 欢迎, ")),(0,l.Lk)("strong",null,(0,i.v_)(a.userName),1),a.auth.state.user.unit_name?((0,l.uX)(),(0,l.CE)("span",p,(0,i.v_)(a.auth.state.user.unit_name),1)):(0,l.Q3)("",!0)]),(0,l.bF)(s,{type:"text",class:"logout-button",onClick:a.handleLogout},{default:(0,l.k6)((()=>t[1]||(t[1]=[(0,l.eW)(" 退出登录 ")]))),_:1},8,["onClick"])])):(0,l.Q3)("",!0)])}var g=o(1219),h=o(144),f=o(4373);const b="";var v={baseURL:b,endpoints:{login:"/api/login",users:"/api/users",units:"/api/units",wasteTypes:"/api/waste-types",wasteRecords:"/api/waste-records",wasteRecordsByUnit:"/api/waste-records",wasteRecordDetail:"/api/waste-records/detail",wasteRecordsByUser:"/api/waste-records/user",exportWasteRecords:"/api/waste-records/export/user"},getUrl(e){return`${this.baseURL}${e}`}};const w={class:"unit-selection-container"},k={class:"content"},y={class:"units-grid"},_={class:"unit-name"};function F(e,t,o,a,r,n){const s=(0,l.g2)("el-card");return(0,l.uX)(),(0,l.CE)("div",w,[t[1]||(t[1]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"危险废物管理系统")],-1)),(0,l.Lk)("div",k,[t[0]||(t[0]=(0,l.Lk)("h2",null,"请选择您的单位",-1)),(0,l.Lk)("div",y,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(s,{key:e.id,class:"unit-card",shadow:"hover",onClick:t=>n.selectUnit(e)},{default:(0,l.k6)((()=>[(0,l.Lk)("div",_,(0,i.v_)(e.name),1)])),_:2},1032,["onClick"])))),128))])]),t[2]||(t[2]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var L={name:"UnitSelection",data(){return{units:[],loading:!1}},created(){this.fetchUnits()},methods:{async fetchUnits(){this.loading=!0;try{console.log("正在获取单位列表...");const e=await f.A.get(v.getUrl(v.endpoints.units));console.log("获取单位列表成功:",e.data),this.units=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}finally{this.loading=!1}},selectUnit(e){this.$router.push({name:"WasteForm",params:{id:e.id}})}}},I=o(1241);const R=(0,I.A)(L,[["render",F],["__scopeId","data-v-a706bc72"]]);var C=R;const x={class:"waste-form-container"},U={class:"header"},V={key:1},W={class:"content"},E={class:"unit-info"},$={class:"form-row"},P={key:0,class:"upload-warning"},T={class:"form-actions"},A={class:"upload-progress"},S={class:"upload-status"};function X(e,t,o,a,r,n){const s=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),d=(0,l.g2)("document"),c=(0,l.g2)("el-option"),p=(0,l.g2)("el-select"),m=(0,l.g2)("el-form-item"),g=(0,l.g2)("el-input"),h=(0,l.g2)("el-date-picker"),f=(0,l.g2)("clock"),b=(0,l.g2)("el-time-picker"),v=(0,l.g2)("el-input-number"),w=(0,l.g2)("el-alert"),k=(0,l.g2)("plus"),y=(0,l.g2)("el-upload"),_=(0,l.g2)("el-button"),F=(0,l.g2)("el-form"),L=(0,l.g2)("el-progress"),I=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",x,[(0,l.Lk)("div",U,[a.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"back-button",onClick:t[0]||(t[0]=(...e)=>a.goBack&&a.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[9]||(t[9]=(0,l.eW)(" 返回 "))])):((0,l.uX)(),(0,l.CE)("div",V)),t[11]||(t[11]=(0,l.Lk)("h1",null,"危险废物填报",-1)),(0,l.Lk)("div",{class:"view-records",onClick:t[1]||(t[1]=(...e)=>a.viewRecords&&a.viewRecords(...e))},[t[10]||(t[10]=(0,l.eW)(" 查看记录 ")),(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(d)])),_:1})])]),(0,l.Lk)("div",W,[(0,l.Lk)("div",E,[(0,l.Lk)("h2",null,(0,i.v_)(a.unitName),1)]),(0,l.bF)(F,{ref:"wasteForm",model:a.form,rules:a.rules,"label-position":"top",class:"waste-form"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:a.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>a.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(c,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"产生地点",prop:"location"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.location,"onUpdate:modelValue":t[3]||(t[3]=e=>a.form.location=e),placeholder:"请输入废物产生地点"},null,8,["modelValue"])])),_:1}),(0,l.Lk)("div",$,[(0,l.bF)(m,{label:"收集日期",class:"date-item"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{modelValue:a.form.collectionDate,"onUpdate:modelValue":t[4]||(t[4]=e=>a.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,"popper-class":"date-picker-popup",teleported:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"收集时间",class:"time-item"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:a.form.collectionTime,"onUpdate:modelValue":t[5]||(t[5]=e=>a.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"},editable:!1,"popper-class":"time-picker-popup",teleported:!1},{prefix:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1})])),_:1},8,["modelValue"])])),_:1})]),(0,l.bF)(m,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:a.form.quantity,"onUpdate:modelValue":t[6]||(t[6]=e=>a.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"},onFocus:t[7]||(t[7]=e=>a.selectAllText(e)),"input-props":{inputmode:"decimal",pattern:"[0-9]*[.,]?[0-9]*"},controls:!1},null,8,["modelValue"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集前）",prop:"photo_before"},{default:(0,l.k6)((()=>[t[12]||(t[12]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),a.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",P,[(0,l.bF)(w,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":a.handlePhotoBeforeChange,"on-remove":a.handlePhotoBeforeRemove,"file-list":a.fileListBefore,limit:5,multiple:"","list-type":"picture-card","before-upload":a.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.bF)(m,{label:"现场照片（收集后）",prop:"photo_after"},{default:(0,l.k6)((()=>[t[13]||(t[13]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(y,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":a.handlePhotoAfterChange,"on-remove":a.handlePhotoAfterRemove,"file-list":a.fileListAfter,limit:5,multiple:"","list-type":"picture-card","before-upload":a.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(k)])),_:1})])),_:1},8,["on-change","on-remove","file-list","before-upload"])])),_:1}),(0,l.Lk)("div",T,[(0,l.bF)(_,{type:"primary",class:"submit-btn",onClick:a.submitForm,loading:a.loading},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("提交")]))),_:1},8,["onClick","loading"]),(0,l.bF)(_,{class:"reset-btn",onClick:a.resetForm},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model","rules"])]),(0,l.bF)(I,{modelValue:a.showUploadProgress,"onUpdate:modelValue":t[8]||(t[8]=e=>a.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",A,[t[16]||(t[16]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(L,{percentage:a.uploadPercentage,format:a.percentageFormat,status:100===a.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",S,(0,i.v_)(a.uploadStatus),1)])])),_:1},8,["modelValue"]),t[17]||(t[17]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var K=o(7477),D={name:"WasteForm",components:{ArrowLeft:K.nkM,Document:K.yoT,Plus:K.FWt,Clock:K.zD7},props:{id:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),o=(0,h.KR)(null),a=(0,h.KR)(!1),r=(0,h.KR)(""),n=(0,h.KR)([]),i=(0,h.KR)([]),u=(0,h.KR)([]),d=(0,h.KR)([]),c=(0,h.KR)([]),p=(0,h.KR)(!1),m=(0,h.KR)(0),f=(0,h.KR)("准备上传..."),b=(0,h.KR)(!1),w=(0,l.EW)((()=>Ot.state.isLoggedIn&&3===Ot.state.user.role_id)),k=(0,h.Kh)({wasteTypeId:"",location:"",collectionDate:(new Date).toISOString().slice(0,10),collectionTime:"08:00",quantity:void 0,photo_before:[],photo_after:[]}),y={wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],location:[{required:!0,message:"请输入废物产生地点",trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{const e=document.createElement("meta");e.setAttribute("name","viewport"),e.setAttribute("content","width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1"),document.head.appendChild(e);const t=document.querySelector('meta[name="viewport"]');t&&t!==e&&t.remove(),await _(),await F()})),(0,l.xo)((()=>{const e=document.querySelector('meta[name="viewport"]');e&&e.remove();const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width,initial-scale=1.0"),document.head.appendChild(t)}));const _=async()=>{try{const t=await Tt.get(v.endpoints.units),o=t.data.find((t=>t.id===parseInt(e.id)));o&&(r.value=o.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},F=async()=>{try{const e=await Tt.get(v.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型失败")}},L=async e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],o=t.includes(e.type);if(!o)return g.nk.error("只能上传图片文件!"),!1;const a=52428800;if(e.size>a)return g.nk.error("图片大小不能超过50MB!"),!1;const l=5242880;return e.size>l&&(b.value=!0),!0},I=(e,t)=>{console.log("收集前照片变更:",e),d.value=t;const o=t.filter((e=>e.raw&&!i.value.some((t=>t.name===e.raw.name))));o.forEach((e=>{e.raw&&i.value.push(e.raw)}));const a=[...i.value,...u.value];b.value=U(a),console.log("更新后的photoFilesBefore:",i.value)},R=(e,t)=>{console.log("收集前照片移除:",e),d.value=t,e.raw?i.value=i.value.filter((t=>t.name!==e.raw.name)):i.value=i.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),U([...i.value,...u.value])||(b.value=!1),console.log("更新后的photoFilesBefore:",i.value)},C=(e,t)=>{console.log("收集后照片变更:",e),c.value=t;const o=t.filter((e=>e.raw&&!u.value.some((t=>t.name===e.raw.name))));o.forEach((e=>{e.raw&&u.value.push(e.raw)}));const a=[...i.value,...u.value];b.value=U(a),console.log("更新后的photoFilesAfter:",u.value)},x=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,e.raw?u.value=u.value.filter((t=>t.name!==e.raw.name)):u.value=u.value.filter((t=>t.uid!==e.uid&&t.name!==e.name)),U([...i.value,...u.value])||(b.value=!1),console.log("更新后的photoFilesAfter:",u.value)},U=e=>{const t=5242880;return e.some((e=>e.size>t))},V=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);m.value=t,f.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},W=e=>100===e?"完成":`${e}%`,E=()=>{o.value.validate((async t=>{if(t){a.value=!0;try{const t=new FormData;if(t.append("unitId",e.id),t.append("wasteTypeId",k.wasteTypeId),t.append("location",k.location),k.collectionDate&&k.collectionTime&&(t.append("collectionDate",k.collectionDate),t.append("collectionTime",k.collectionTime)),t.append("quantity",k.quantity),Ot.state.isLoggedIn&&Ot.state.user){t.append("creator_id",Ot.state.user.id);const e=Ot.state.user.username||Ot.state.user.phone||"未知";t.append("creator_name",e),console.log("添加用户信息:",{creator_id:Ot.state.user.id,creator_name:e,user:Ot.state.user})}else console.log("用户未登录或用户信息不完整");console.log("提交表单数据:",{unitId:e.id,wasteTypeId:k.wasteTypeId,location:k.location,quantity:k.quantity,photo_before:i.value?i.value.length:0,photo_after:u.value?u.value.length:0}),i.value&&i.value.length>0&&(console.log("添加收集前照片数量:",i.value.length),i.value.forEach(((e,o)=>{e&&(console.log(`收集前照片 ${o+1}:`,e.name),t.append("photo_before",e))}))),u.value&&u.value.length>0&&(console.log("添加收集后照片数量:",u.value.length),u.value.forEach(((e,o)=>{e&&(console.log(`收集后照片 ${o+1}:`,e.name),t.append("photo_after",e))})));const o=[...i.value||[],...u.value||[]];b.value=U(o),o.length>0&&(p.value=!0,m.value=0,f.value="准备上传...");const a=await Tt.postForm(v.endpoints.wasteRecords,t,V);console.log("提交响应:",a.data),g.nk.success("废物记录提交成功"),$()}catch(o){console.error("Error submitting form:",o),o.response&&(console.error("错误响应数据:",o.response.data),console.error("错误状态码:",o.response.status)),g.nk.error("提交失败，请稍后再试")}finally{a.value=!1,p.value=!1}}else g.nk.warning("请完成必填项")}))},$=()=>{o.value&&o.value.resetFields(),i.value=[],u.value=[],d.value=[],c.value=[],k.quantity=void 0,k.collectionDate=(new Date).toISOString().slice(0,10),k.collectionTime="08:00"},P=()=>{w.value&&t.push("/")},T=()=>{t.push({name:"RecordsList",params:{unitId:e.id}})},A=e=>{setTimeout((()=>{if(e&&e.target){const t=e.target.querySelector("input");t&&t.select()}}),10)};return{form:k,rules:y,wasteForm:o,loading:a,unitName:r,wasteTypes:n,isAdmin:w,fileListBefore:d,fileListAfter:c,handlePhotoBeforeChange:I,handlePhotoBeforeRemove:R,handlePhotoAfterChange:C,handlePhotoAfterRemove:x,handleBeforeUpload:L,submitForm:E,resetForm:$,goBack:P,viewRecords:T,selectAllText:A,showUploadProgress:p,uploadPercentage:m,uploadStatus:f,percentageFormat:W,showLargeFileWarning:b}}};const q=(0,I.A)(D,[["render",X],["__scopeId","data-v-53fa8846"]]);var Q=q;const j={class:"records-container"},B={class:"header"},O={key:1},M={class:"content"},N={class:"unit-info"},Y={class:"actions"},z={class:"filter-header"},H={class:"filter-form-container"},J={class:"quantity-range"},G={class:"filter-actions"},Z={class:"records-wrapper"},ee={class:"card-header"},te={class:"card-actions"},oe={key:0,class:"photo-preview"},ae=["onClick"],le={key:0,class:"photo-count"},re={key:1},ne={key:0,class:"photo-preview"},se=["onClick"],ie={key:0,class:"photo-count"},ue={key:1},de={class:"operation-buttons"},ce={key:0,class:"loading-more"},pe={key:1,class:"empty-block"};function me(e,t,o,r,n,s){const u=(0,l.g2)("arrow-left"),d=(0,l.g2)("el-icon"),c=(0,l.g2)("home-filled"),p=(0,l.g2)("plus"),m=(0,l.g2)("el-button"),g=(0,l.g2)("user"),h=(0,l.g2)("refresh"),f=(0,l.g2)("download"),b=(0,l.g2)("arrow-down"),v=(0,l.g2)("arrow-up"),w=(0,l.g2)("el-date-picker"),k=(0,l.g2)("el-form-item"),y=(0,l.g2)("el-col"),_=(0,l.g2)("el-option"),F=(0,l.g2)("el-select"),L=(0,l.g2)("el-row"),I=(0,l.g2)("el-input-number"),R=(0,l.g2)("el-input"),C=(0,l.g2)("el-form"),x=(0,l.g2)("el-card"),U=(0,l.g2)("el-table-column"),V=(0,l.g2)("el-image"),W=(0,l.g2)("el-table"),E=(0,l.g2)("loading"),$=(0,l.g2)("el-empty"),P=(0,l.g2)("el-image-viewer"),T=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",j,[(0,l.Lk)("div",B,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>r.goBack&&r.goBack(...e))},[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 返回填报 "))]),t[10]||(t[10]=(0,l.Lk)("h1",null,"废物记录查看",-1)),r.isAdmin?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"home-link",onClick:t[1]||(t[1]=(...e)=>r.goHome&&r.goHome(...e))},[t[9]||(t[9]=(0,l.eW)(" 首页 ")),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(c)])),_:1})])):((0,l.uX)(),(0,l.CE)("div",O))]),(0,l.Lk)("div",M,[(0,l.Lk)("div",N,[(0,l.Lk)("h2",null,(0,i.v_)(r.unitName)+" - 危险废物记录",1)]),(0,l.Lk)("div",Y,[(0,l.bF)(m,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),r.isAdmin||r.isUnitAdmin?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}),t[12]||(t[12]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(m,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"]),(0,l.bF)(m,{type:"primary",onClick:r.exportRecords,loading:r.loading},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick","loading"])]),(0,l.bF)(x,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",z,[t[15]||(t[15]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(m,{type:"primary",link:"",onClick:t[2]||(t[2]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(d,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(v)])),_:1})):((0,l.uX)(),(0,l.Wv)(d,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(b)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",H,[(0,l.bF)(C,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(L,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(w,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(L,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",J,[(0,l.bF)(I,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"48%"}},null,8,["modelValue"]),t[16]||(t[16]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.bF)(I,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"48%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,l.bF)(y,{xs:24,sm:24,md:12,lg:12,xl:12},{default:(0,l.k6)((()=>[(0,l.bF)(k,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(R,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[7]||(t[7]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.Lk)("div",G,[(0,l.bF)(m,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)("筛选")]))),_:1},8,["onClick"]),(0,l.bF)(m,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[18]||(t[18]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[a.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",Z,[(0,l.bF)(x,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ee,[t[20]||(t[20]=(0,l.Lk)("h3",null,"废物记录列表",-1)),(0,l.Lk)("div",te,[(0,l.bF)(m,{type:"warning",onClick:r.exportRecords},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(f)])),_:1}),t[19]||(t[19]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(W,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:"500",onScroll:r.handleScroll},{default:(0,l.k6)((()=>[(0,l.bF)(U,{prop:"waste_type_name",label:"废物类型","min-width":"110"}),(0,l.bF)(U,{prop:"location",label:"产生地点","min-width":"120"}),(0,l.bF)(U,{label:"收集开始时间","min-width":"160"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.collection_start_time)),1)])),_:1}),(0,l.bF)(U,{label:"数量(吨)","min-width":"100"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(parseFloat(e.row.quantity).toFixed(3)),1)])),_:1}),(0,l.bF)(U,{label:"记录时间","min-width":"160",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(r.parseFormattedDateTime(e.row.created_at)),1)])),_:1}),(0,l.bF)(U,{label:"汇报人","min-width":"100",class:"mobile-hidden"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(e.row.creator_name||"未知"),1)])),_:1}),(0,l.bF)(U,{label:"现场照片（清理前）",width:"120",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",oe,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,o)=>((0,l.uX)(),(0,l.CE)("div",{key:o,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),o)},[(0,l.bF)(V,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,ae)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",le,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",re,"无"))])),_:1}),(0,l.bF)(U,{label:"现场照片（清理后）",width:"120",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",ne,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,o)=>((0,l.uX)(),(0,l.CE)("div",{key:o,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),o)},[(0,l.bF)(V,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,se)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",ie,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",ue,"无"))])),_:1}),(0,l.bF)(U,{label:"操作","min-width":"70",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",de,[r.canEdit(e.row)?((0,l.uX)(),(0,l.Wv)(m,{key:0,type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[21]||(t[21]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0),r.canEdit(e.row)?((0,l.uX)(),(0,l.Wv)(m,{key:1,type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[22]||(t[22]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])):(0,l.Q3)("",!0)])])),_:1})])),_:1},8,["data","onScroll"])),[[T,r.loading]]),r.loadingMore?((0,l.uX)(),(0,l.CE)("div",ce,[(0,l.bF)(d,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(E)])),_:1}),t[23]||(t[23]=(0,l.eW)(" 加载更多... "))])):(0,l.Q3)("",!0),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",pe,[(0,l.bF)($,{description:"暂无废物记录"})]))])),_:1})])]),t[24]||(t[24]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,l.uX)(),(0,l.Wv)(P,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}var ge=o(8828),he=o(2933),fe=o(3230),be=o(7093),ve=o.n(be);console.log("XLSX库版本:",fe.version),console.log("XLSX库可用方法:",Object.keys(fe).join(", "));const we=async(e,t,o,a=null)=>{if(!e||0===e.length)return console.error("导出失败：没有数据"),!1;t=t.replace(/[\\/:*?"<>|]/g,"_");const l=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14);console.log("导出函数被调用，数据条数:",e.length),console.log("是否有图片数据:",a?"是":"否"),a&&(console.log("图片数据条数:",Object.keys(a).length),console.log("图片数据内容示例:",JSON.stringify(Object.keys(a).slice(0,2).reduce(((e,t)=>(e[t]=a[t],e)),{}))));try{console.log("使用ExcelJS导出Excel...");const r=new(ve().Workbook);r.creator="危险废物管理系统",r.lastModifiedBy="危险废物管理系统",r.created=new Date,r.modified=new Date;const n=r.addWorksheet("危险废物记录"),s=o.map((e=>({header:e.text,key:e.field,width:15})));n.columns=s,e.forEach(((e,t)=>{const l={};if(o.forEach((t=>{l[t.field]=e[t.field]||""})),n.addRow(l),a&&a[t]){if(console.log(`处理第${t+1}行的图片数据:`,JSON.stringify(Object.keys(a[t]))),a[t][7]&&a[t][7].base64)try{const e=a[t][7].base64,o=e.startsWith("data:")?e:`data:image/jpeg;base64,${e}`,l=r.addImage({base64:o,extension:"jpeg"}),s=7;n.addImage(l,{tl:{col:s,row:t+1},ext:{width:80,height:80}}),n.getRow(t+2).height=60,console.log(`成功添加第${t+1}行的清理前照片`)}catch(s){console.error(`添加清理前照片失败，行 ${t+1}:`,s)}if(a[t][8]&&a[t][8].base64)try{const e=a[t][8].base64,o=e.startsWith("data:")?e:`data:image/jpeg;base64,${e}`,l=r.addImage({base64:o,extension:"jpeg"}),s=8;n.addImage(l,{tl:{col:s,row:t+1},ext:{width:80,height:80}}),n.getRow(t+2).height=60,console.log(`成功添加第${t+1}行的清理后照片`)}catch(s){console.error(`添加清理后照片失败，行 ${t+1}:`,s)}}})),n.getRow(1).font={bold:!0},n.getRow(1).alignment={vertical:"middle",horizontal:"center"};const i=`${t}_${l}.xlsx`;console.log("准备导出Excel文件:",i);const u=await r.xlsx.writeBuffer(),d=new Blob([u],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),c=URL.createObjectURL(d),p=document.createElement("a");return p.href=c,p.download=i,document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(c),console.log("Excel导出成功"),!0}catch(r){return console.error("导出Excel失败，错误详情:",r),console.log("回退到CSV导出"),ke(e,t,o),!1}},ke=(e,t,o)=>{const a=(new Date).toISOString().replace(/[-:.]/g,"").substring(0,14),l=`${t}_${a}.csv`;let r="\ufeff";const n=o.map((e=>`"${e.text}"`)).join(",");r+=n+"\r\n",e.forEach((e=>{const t=o.map((t=>{const o=e[t.field];if(null===o||void 0===o)return"";if("number"===t.type||"number"===typeof o)return o;let a=String(o);return(a.includes(",")||a.includes('"')||a.includes("\n"))&&(a=a.replace(/"/g,'""'),a=`"${a}"`),a})).join(",");r+=t+"\r\n"}));const s=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),u=document.createElement("a");u.setAttribute("href",i),u.setAttribute("download",l),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(i),console.log("CSV导出成功")},ye=async e=>{if(console.log("开始转换图片到Base64:",e),!e||"string"!==typeof e)return console.error("无效的图片URL:",e),null;const t=e.includes("?")?`${e}&_t=${(new Date).getTime()}`:`${e}?_t=${(new Date).getTime()}`;try{console.log("尝试使用fetch API获取图片...");const e=await fetch(t,{mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!e.ok)throw new Error(`HTTP错误: ${e.status}`);const o=await e.blob();return console.log("图片获取成功，大小:",o.size,"字节, 类型:",o.type),new Promise(((e,t)=>{const a=new FileReader;a.onloadend=()=>{const t=a.result;console.log("图片转换为Base64成功，长度:",t.length);const o=t.split(",")[1];e(o)},a.onerror=e=>{console.error("FileReader错误:",e),t(e)},a.readAsDataURL(o)}))}catch(o){console.warn("使用fetch API获取图片失败:",o);try{console.log("尝试使用Image对象获取图片...");const e=new Image;e.crossOrigin="Anonymous",await new Promise(((o,a)=>{e.onload=o,e.onerror=e=>{console.error("图片加载错误:",e),a(e)},e.src=t})),console.log("图片加载成功，尺寸:",e.width,"x",e.height);const o=document.createElement("canvas");o.width=e.width,o.height=e.height;const a=o.getContext("2d");a.drawImage(e,0,0);const l=o.toDataURL("image/jpeg");console.log("图片转换为Base64成功，长度:",l.length);const r=l.split(",")[1];return r}catch(a){return console.error("使用Image对象获取图片也失败:",a),null}}},_e=async(e,t)=>{if(console.log("准备图片导出数据，记录数:",e.length),console.log("使用的基础URL:",t),e.length>0){console.log("第一条记录的所有字段:");const t=e[0];Object.keys(t).forEach((e=>{console.log(`${e}: ${"object"===typeof t[e]?JSON.stringify(t[e]):t[e]}`)}))}const o={};let a=0,l=0;const r=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}};for(let s=0;s<e.length;s++){const i=e[s];if(console.log(`处理记录 ${s+1}/${e.length}, ID: ${i.id}`),o[s]={},i.photo_path_before){const e=r(i.photo_path_before);if(console.log(`记录 ${s+1} 清理前照片路径:`,e),e.length>0){const a=`${t}${e[0]}`;console.log(`记录 ${s+1} 清理前照片URL:`,a);try{const e=await ye(a);e?(o[s][7]={url:a,base64:e},console.log(`记录 ${s+1} 清理前照片转换成功`),l++):(console.warn(`记录 ${s+1} 清理前照片转换失败`),o[s][7]={url:a})}catch(n){console.error(`记录 ${s+1} 清理前照片处理错误:`,n),o[s][7]={url:a}}}}else console.log(`记录 ${s+1} 没有清理前照片`);if(i.photo_path_after){const e=r(i.photo_path_after);if(console.log(`记录 ${s+1} 清理后照片路径:`,e),e.length>0){const a=`${t}${e[0]}`;console.log(`记录 ${s+1} 清理后照片URL:`,a);try{const e=await ye(a);e?(o[s][8]={url:a,base64:e},console.log(`记录 ${s+1} 清理后照片转换成功`),l++):(console.warn(`记录 ${s+1} 清理后照片转换失败`),o[s][8]={url:a})}catch(n){console.error(`记录 ${s+1} 清理后照片处理错误:`,n),o[s][8]={url:a}}}}else console.log(`记录 ${s+1} 没有清理后照片`);i.unit_name&&(o[s].unit_name=i.unit_name),a++}return console.log(`图片数据准备完成，处理记录: ${a}/${e.length}, 成功转换图片: ${l}`),o};var Fe={name:"RecordsList",components:{ArrowLeft:K.nkM,HomeFilled:K.oCE,Refresh:K.C42,Plus:K.FWt,User:K.KJW,ArrowDown:K.yd$,ArrowUp:K.DoI,Download:K.f5X,ElImageViewer:ge.Tg,Loading:K.Rhj},props:{unitId:{type:[String,Number],required:!0}},setup(e){const t=(0,s.rd)(),o=(0,h.KR)([]),a=(0,h.KR)(!1),r=(0,h.KR)(""),n=(0,h.KR)([]),i=(0,h.KR)(!0),u=v.baseURL,d=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},c=(0,h.KR)(1),p=(0,h.KR)(20),m=(0,h.KR)(!0),f=(0,h.KR)(!1),b=(0,h.Kh)({dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:""}),w=(0,l.EW)((()=>o.value&&Array.isArray(o.value)?o.value.filter((e=>{if(b.wasteTypeId&&e.waste_type_id!==b.wasteTypeId)return!1;if(null!==b.minQuantity&&parseFloat(e.quantity)<b.minQuantity)return!1;if(null!==b.maxQuantity&&parseFloat(e.quantity)>b.maxQuantity)return!1;if(b.location&&!e.location.toLowerCase().includes(b.location.toLowerCase()))return!1;if(b.dateRange&&2===b.dateRange.length){const t=new Date(b.dateRange[0]),o=new Date(b.dateRange[1]);o.setHours(23,59,59);const a=new Date(e.collection_start_time);if(a<t||a>o)return!1}return!0})):[])),k=(0,l.EW)((()=>Ot.isAdmin())),y=(0,l.EW)((()=>Ot.isUnitAdmin())),_=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},F=async()=>{await q(),g.nk.success("记录已刷新")},L=()=>{const e=Ot.getUnitId();e?t.push(`/unit/${e}`):t.push("/")},I=()=>{t.push("/")},R=()=>{t.push("/user-management")},C=()=>{t.push(`/unit/${e.unitId}`)},x=e=>{t.push(`/record/${e}`)},U=e=>{if(!e)return!1;if(k.value)return!0;const t=Ot.getUnitId();if(y.value&&t&&e.unit_id===parseInt(t))return!0;const o=Ot.getUserId();return o&&e.creator_id===parseInt(o)},V=e=>{he.s.confirm("确定要删除这条废物记录吗？此操作不可逆。","删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await Tt.delete(`${v.endpoints.wasteRecords}/${e.id}`),g.nk.success("记录已成功删除"),await q()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败，请重试")}})).catch((()=>{g.nk.info("已取消删除")}))},W=async()=>{try{c.value=1,await q(),g.nk.success("筛选条件已应用")}catch(e){console.error("应用筛选失败:",e),g.nk.error("应用筛选失败")}},E=async()=>{b.dateRange=null,b.wasteTypeId=null,b.minQuantity=null,b.maxQuantity=null,b.location="",c.value=1,await q(),g.nk.success("筛选条件已重置")},$=async()=>{try{a.value=!0,console.log("开始导出记录...");const t=w.value;if(console.log(`导出记录数量: ${t.length}`),0===t.length)return g.nk.warning("没有可导出的记录"),void(a.value=!1);const o=t.some((e=>e.photo_path_before||e.photo_path_after));if(console.log("记录中是否包含照片:",o),t.length>0){const e=t[0];console.log("第一条记录照片路径:"),console.log("清理前照片:",e.photo_path_before),console.log("清理后照片:",e.photo_path_after)}console.log("baseUrl值:",u);const l=t.map((e=>({"单位":e.unit_name||"","废物类型":e.waste_type_name||"","收集地点":e.location||"","收集时间":e.collection_start_time?new Date(e.collection_start_time).toLocaleString():"","数量(kg)":e.quantity||0,"记录时间":e.created_at?new Date(e.created_at).toLocaleString():"","汇报人":e.creator_name||"未知","清理前照片":"","清理后照片":""})));console.log("导出数据准备完成"),console.log("准备图片数据...");const n=await _e(t,u);console.log("图片数据准备完成，数量:",Object.keys(n).length),console.log("图片数据内容:",JSON.stringify(n));const s=`${r.value}危险废物记录`,i=[{text:"单位",field:"单位"},{text:"废物类型",field:"废物类型"},{text:"收集地点",field:"收集地点"},{text:"收集时间",field:"收集时间"},{text:"数量(kg)",field:"数量(kg)"},{text:"记录时间",field:"记录时间"},{text:"汇报人",field:"汇报人"},{text:"清理前照片",field:"清理前照片"},{text:"清理后照片",field:"清理后照片"}];console.log("开始导出Excel文件...");try{const e=await we(l,s,i,n);e?(console.log("导出成功"),g.nk.success("导出成功")):(console.log("导出失败，已回退到CSV导出"),g.nk.warning("Excel导出失败，已回退到CSV导出"))}catch(e){console.error("导出Excel时发生错误:",e),g.nk.error("导出Excel失败: "+e.message)}}catch(t){console.error("导出过程中发生错误:",t),g.nk.error("导出失败: "+t.message)}finally{a.value=!1}},P=(0,h.KR)(!1),T=(0,h.KR)([]),A=(0,h.KR)(0),S=(e,t)=>{const o=Array.isArray(e)?e:[e];T.value=o.map((e=>`${u}${e}`)),A.value=t||0,P.value=!0},X=()=>{P.value=!1};(0,l.sV)((async()=>{await D(),await K(),await q()}));const K=async()=>{try{const e=await Tt.get(v.endpoints.wasteTypes);n.value=e.data}catch(e){console.error("Error fetching waste types:",e),g.nk.error("获取废物类型列表失败")}},D=async()=>{try{const t=await Tt.get(v.endpoints.units),o=t.data.find((t=>t.id===parseInt(e.unitId)));o&&(r.value=o.name)}catch(t){console.error("Error fetching unit name:",t),g.nk.error("获取单位信息失败")}},q=async(e=!1)=>{e?f.value=!0:(a.value=!0,c.value=1,o.value=[]);try{const t={page:c.value,pageSize:p.value};b.wasteTypeId&&(t.wasteTypeId=b.wasteTypeId),null!==b.minQuantity&&(t.minQuantity=b.minQuantity),null!==b.maxQuantity&&(t.maxQuantity=b.maxQuantity),b.location&&(t.location=b.location),b.dateRange&&2===b.dateRange.length&&(t.dateRange=JSON.stringify(b.dateRange));const a=Ot.getUserId();if(!a)throw new Error("用户未登录");const l=await Tt.get(`${v.endpoints.wasteRecordsByUser}/${a}`,{params:t});l.data&&Array.isArray(l.data.records)?(o.value=e?[...o.value,...l.data.records]:l.data.records,m.value=!!l.data.hasMore):(console.error("Invalid response format:",l.data),o.value=[],m.value=!1,g.nk.error("获取废物记录失败：数据格式错误"))}catch(t){console.error("Error fetching records:",t),o.value=[],m.value=!1,g.nk.error("获取废物记录失败")}finally{a.value=!1,f.value=!1}},Q=async e=>{if(!e||!e.target)return;const t=e.target.scrollHeight||0,o=e.target.scrollTop||0,a=e.target.clientHeight||0;t-o-a<50&&m.value&&!f.value&&(c.value++,await q(!0))};return{records:o,filteredRecords:w,loading:a,unitName:r,wasteTypes:n,isAdmin:k,isUnitAdmin:y,parseFormattedDateTime:_,refreshRecords:F,goBack:L,goHome:I,goToUserManagement:R,addNewRecord:C,editRecord:x,canEdit:U,confirmDelete:V,apiConfig:v,showFilterPanel:i,filterForm:b,applyFilter:W,resetFilter:E,exportRecords:$,showViewer:P,previewImages:T,previewIndex:A,previewPhoto:S,closeViewer:X,handleScroll:Q,parsePhotoPath:d,baseUrl:u,page:c,pageSize:p,hasMore:m,loadingMore:f}}};const Le=(0,I.A)(Fe,[["render",me],["__scopeId","data-v-7b86bf8e"]]);var Ie=Le;const Re={class:"login-container"},Ce={class:"login-card"},xe={key:0,class:"login-error"};function Ue(e,t,o,r,n,s){const u=(0,l.g2)("el-input"),d=(0,l.g2)("el-form-item"),c=(0,l.g2)("el-radio"),p=(0,l.g2)("el-radio-group"),m=(0,l.g2)("el-checkbox"),g=(0,l.g2)("el-button"),h=(0,l.g2)("el-form");return(0,l.uX)(),(0,l.CE)("div",Re,[(0,l.Lk)("div",Ce,[t[9]||(t[9]=(0,l.Lk)("div",{class:"login-header"},[(0,l.Lk)("h1",null,"危险废物管理系统"),(0,l.Lk)("h2",null,"用户登录")],-1)),(0,l.bF)(h,{ref:"loginForm",model:r.form,rules:r.rules,"label-width":"80px",class:"login-form",onSubmit:(0,a.D$)(r.submitForm,["prevent"])},{default:(0,l.k6)((()=>[(0,l.bF)(d,{label:"手机号",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(u,{modelValue:r.form.phone,"onUpdate:modelValue":t[0]||(t[0]=e=>r.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,l.bF)(d,{label:"密码",prop:"password"},{default:(0,l.k6)((()=>[(0,l.bF)(u,{modelValue:r.form.password,"onUpdate:modelValue":t[1]||(t[1]=e=>r.form.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1}),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:r.form.userType,"onUpdate:modelValue":t[2]||(t[2]=e=>r.form.userType=e),onChange:r.handleUserTypeChange},{default:(0,l.k6)((()=>[(0,l.bF)(c,{label:1},{default:(0,l.k6)((()=>t[4]||(t[4]=[(0,l.eW)("员工")]))),_:1}),(0,l.bF)(c,{label:2},{default:(0,l.k6)((()=>t[5]||(t[5]=[(0,l.eW)("单位管理员")]))),_:1}),(0,l.bF)(c,{label:3},{default:(0,l.k6)((()=>t[6]||(t[6]=[(0,l.eW)("超级管理员")]))),_:1})])),_:1},8,["modelValue","onChange"])])),_:1}),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:r.form.rememberMe,"onUpdate:modelValue":t[3]||(t[3]=e=>r.form.rememberMe=e)},{default:(0,l.k6)((()=>t[7]||(t[7]=[(0,l.eW)("记住登录")]))),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(g,{type:"primary","native-type":"submit",onClick:r.submitForm,loading:r.auth.state.loading,style:{width:"100%"}},{default:(0,l.k6)((()=>t[8]||(t[8]=[(0,l.eW)(" 登录 ")]))),_:1},8,["onClick","loading"])])),_:1})])),_:1},8,["model","rules","onSubmit"]),r.auth.state.error?((0,l.uX)(),(0,l.CE)("div",xe,(0,i.v_)(r.auth.state.error),1)):(0,l.Q3)("",!0)])])}var Ve={name:"LoginView",setup(){const e=(0,s.rd)(),t=(0,h.KR)(null),o=(0,h.Kh)({phone:"",password:"",userType:1,rememberMe:!1}),a=(0,l.EW)((()=>!0)),r=(0,l.EW)((()=>{const e=[{required:!0,message:"请输入手机号",trigger:"submit"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"submit"}],t=[{required:!0,message:"请输入密码",trigger:"submit"}];return{phone:e,password:t}})),n=()=>{t.value&&t.value.clearValidate()},i=async()=>{console.log("提交表单被触发"),t.value?Ot.state.loading?console.log("登录正在进行中，跳过"):(console.log("登录模式"),t.value.validate((async e=>{e?(console.log("表单验证通过"),await u()):console.log("表单验证失败")}))):console.log("表单引用不存在")},u=async()=>{console.log("开始登录，账号:",o.phone,"用户类型:",o.userType);try{console.log("开始处理登录操作...");const t=await Ot.login(o.phone,o.password,o.rememberMe,o.userType);if(console.log("登录响应:",t),t.success){const o=t.user;g.nk.success(`欢迎，${o.username||o.phone}`),3===o.role_id?e.push("/admin-records"):2===o.role_id?e.push(`/records/${o.unit_id}`):e.push(`/unit/${o.unit_id}`)}else g.nk.error(t.error||"登录失败")}catch(t){g.nk.error(t.response?.data?.error||"登录失败，请检查网络连接")}};return(0,l.sV)((()=>{if(Ot.state.isLoggedIn){const t=Ot.state.user;3===t.role_id?e.push("/admin-records"):2===t.role_id?e.push(`/records/${t.unit_id}`):e.push(`/unit/${t.unit_id}`)}})),{form:o,rules:r,loginForm:t,showPassword:a,handleUserTypeChange:n,submitForm:i,auth:Ot}}};const We=(0,I.A)(Ve,[["render",Ue],["__scopeId","data-v-735f8166"]]);var Ee=We;const $e={class:"edit-record-container"},Pe={class:"header"},Te={class:"content"},Ae={class:"form-header"},Se={key:0,class:"upload-warning"},Xe=["src"],Ke=["src"],De={class:"upload-progress"},qe={class:"upload-status"};function Qe(e,t,o,a,r,n){const s=(0,l.g2)("arrow-left"),u=(0,l.g2)("el-icon"),d=(0,l.g2)("el-option"),c=(0,l.g2)("el-select"),p=(0,l.g2)("el-form-item"),m=(0,l.g2)("el-input"),g=(0,l.g2)("el-date-picker"),h=(0,l.g2)("clock"),f=(0,l.g2)("el-time-picker"),b=(0,l.g2)("el-input-number"),v=(0,l.g2)("el-alert"),w=(0,l.g2)("plus"),k=(0,l.g2)("el-upload"),y=(0,l.g2)("el-image-viewer"),_=(0,l.g2)("el-button"),F=(0,l.g2)("el-collapse-item"),L=(0,l.g2)("el-collapse"),I=(0,l.g2)("el-form"),R=(0,l.g2)("el-progress"),C=(0,l.g2)("el-dialog"),x=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",$e,[(0,l.Lk)("div",Pe,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>a.goBack&&a.goBack(...e))},[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 返回 "))]),(0,l.Lk)("h1",null,(0,i.v_)(a.isNew?"新增废物记录":"编辑废物记录"),1),t[9]||(t[9]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Te,[(0,l.Lk)("div",Ae,[(0,l.Lk)("h2",null,(0,i.v_)(a.unitName),1)]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(I,{ref:"recordForm",model:a.form,rules:a.rules,"label-width":"120px",class:"record-form"},{default:(0,l.k6)((()=>[a.isSuperAdmin&&a.isNew?((0,l.uX)(),(0,l.Wv)(p,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:a.form.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>a.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.units,(e=>((0,l.uX)(),(0,l.Wv)(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(p,{label:"废物类型",prop:"wasteTypeId"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{modelValue:a.form.wasteTypeId,"onUpdate:modelValue":t[2]||(t[2]=e=>a.form.wasteTypeId=e),placeholder:"请选择废物类型",style:{width:"100%"}},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"产生地点",prop:"location"},{default:(0,l.k6)((()=>[(0,l.bF)(m,{modelValue:a.form.location,"onUpdate:modelValue":t[3]||(t[3]=e=>a.form.location=e),placeholder:"请输入废物产生地点"},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集日期"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.collectionDate,"onUpdate:modelValue":t[4]||(t[4]=e=>a.form.collectionDate=e),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(f,{modelValue:a.form.collectionTime,"onUpdate:modelValue":t[5]||(t[5]=e=>a.form.collectionTime=e),format:"HH:mm",placeholder:"选择时间","value-format":"HH:mm",style:{width:"100%"}},{prefix:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"收集数量(吨)",prop:"quantity"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:a.form.quantity,"onUpdate:modelValue":t[6]||(t[6]=e=>a.form.quantity=e),min:0,precision:3,step:.001,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集前）",prop:"photo_path_before"},{default:(0,l.k6)((()=>[t[10]||(t[10]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集前的现场照片（最多5张）",-1)),a.showLargeFileWarning?((0,l.uX)(),(0,l.CE)("div",Se,[(0,l.bF)(v,{title:"上传大文件可能会导致处理时间较长，请耐心等待",type:"warning",closable:!1,"show-icon":""})])):(0,l.Q3)("",!0),(0,l.bF)(k,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":a.handlePhotoBeforeChange,"on-remove":a.handlePhotoBeforeRemove,"file-list":a.fileListBefore,limit:5,multiple:"","list-type":"picture-card","on-preview":a.handlePictureCardPreview,"before-upload":a.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(w)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"])])),_:1}),(0,l.bF)(p,{label:"现场照片（收集后）",prop:"photo_path_after"},{default:(0,l.k6)((()=>[t[11]||(t[11]=(0,l.Lk)("div",{class:"photo-tip"},"请上传废物收集后的现场照片（最多5张）",-1)),(0,l.bF)(k,{class:"waste-photo-uploader",action:"#","auto-upload":!1,"on-change":a.handlePhotoAfterChange,"on-remove":a.handlePhotoAfterRemove,"file-list":a.fileListAfter,limit:5,multiple:"","list-type":"picture-card","on-preview":a.handlePictureCardPreview,"before-upload":a.handleBeforeUpload,accept:"image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,.jpeg,.jpg,.png,.gif,.bmp,.webp"},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)(w)])),_:1})])),_:1},8,["on-change","on-remove","file-list","on-preview","before-upload"]),a.showViewer?((0,l.uX)(),(0,l.Wv)(y,{key:0,"url-list":a.previewImages,"initial-index":a.previewIndex,onClose:a.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])),_:1}),(0,l.bF)(p,null,{default:(0,l.k6)((()=>[(0,l.bF)(_,{type:"primary",onClick:a.submitForm,loading:a.loading},{default:(0,l.k6)((()=>t[12]||(t[12]=[(0,l.eW)("保存")]))),_:1},8,["onClick","loading"]),(0,l.bF)(_,{onClick:a.goBack},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("取消")]))),_:1},8,["onClick"])])),_:1}),a.isNew?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.Wv)(L,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(F,{title:"调试信息"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",null,[t[16]||(t[16]=(0,l.Lk)("h4",null,"收集前照片路径:",-1)),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.fileListBefore,((e,o)=>((0,l.uX)(),(0,l.CE)("div",{key:"before-"+o},[(0,l.Lk)("div",null,"名称: "+(0,i.v_)(e.name),1),(0,l.Lk)("div",null,"URL: "+(0,i.v_)(e.url),1),(0,l.Lk)("div",null,[(0,l.Lk)("img",{src:e.url,style:{"max-width":"200px","max-height":"200px"}},null,8,Xe)]),t[14]||(t[14]=(0,l.Lk)("hr",null,null,-1))])))),128)),t[17]||(t[17]=(0,l.Lk)("h4",null,"收集后照片路径:",-1)),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.fileListAfter,((e,o)=>((0,l.uX)(),(0,l.CE)("div",{key:"after-"+o},[(0,l.Lk)("div",null,"名称: "+(0,i.v_)(e.name),1),(0,l.Lk)("div",null,"URL: "+(0,i.v_)(e.url),1),(0,l.Lk)("div",null,[(0,l.Lk)("img",{src:e.url,style:{"max-width":"200px","max-height":"200px"}},null,8,Ke)]),t[15]||(t[15]=(0,l.Lk)("hr",null,null,-1))])))),128))])])),_:1})])),_:1}))])),_:1},8,["model","rules"])),[[x,a.loading]])]),(0,l.bF)(C,{modelValue:a.showUploadProgress,"onUpdate:modelValue":t[7]||(t[7]=e=>a.showUploadProgress=e),title:"正在上传文件",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:(0,l.k6)((()=>[(0,l.Lk)("div",De,[t[18]||(t[18]=(0,l.Lk)("p",null,"正在上传文件，请勿关闭页面...",-1)),(0,l.bF)(R,{percentage:a.uploadPercentage,format:a.percentageFormat,status:100===a.uploadPercentage?"success":""},null,8,["percentage","format","status"]),(0,l.Lk)("p",qe,(0,i.v_)(a.uploadStatus),1)])])),_:1},8,["modelValue"]),t[19]||(t[19]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var je={name:"EditRecordView",components:{ArrowLeft:K.nkM,Plus:K.FWt,Clock:K.zD7,ElImageViewer:ge.Tg},setup(){const e=(0,s.rd)(),t=(0,s.lq)(),o=(0,h.KR)(null),a=(0,h.KR)(!1),r=(0,h.KR)(!1),n=(0,h.KR)(""),i=(0,h.KR)([]),u=(0,h.KR)([]),d=(0,h.KR)([]),c=(0,h.KR)([]),p=(0,h.KR)([]),m=(0,h.KR)(!1),f=(0,h.KR)(0),b=(0,h.KR)(""),w=(0,h.KR)(!1),k=(0,h.KR)(0),y=(0,h.KR)("准备上传..."),_=(0,h.KR)(!1),F=e=>{if(!e)return[];console.log("解析照片路径，原始值:",e,"类型:",typeof e);try{if(Array.isArray(e))return console.log("照片路径已经是数组:",e),e;if("string"===typeof e){if(e.startsWith("[")&&e.endsWith("]")){const t=JSON.parse(e);return console.log("照片路径解析为JSON数组:",t),t}if(e.includes(",")){const t=e.split(",").map((e=>e.trim())).filter((e=>e));return console.log("照片路径解析为逗号分隔字符串:",t),t}return console.log("照片路径解析为单个字符串:",[e]),[e]}return console.log("照片路径类型未知，尝试转换为字符串:",String(e)),[String(e)]}catch(t){return console.error("解析照片路径失败:",t),"string"===typeof e?[e]:[]}},L=(0,l.EW)((()=>!t.params.id||"new"===t.params.id)),I=(0,l.EW)((()=>Ot.state.isLoggedIn&&3===Ot.state.user.role_id)),R=(0,h.Kh)({unitId:"",wasteTypeId:"",location:"",collectionDate:"",collectionTime:"",quantity:0,recordId:null,creatorId:Ot.state.user?.id||null,photo_path_before:"",photo_path_after:"",remarks:""}),C={unitId:[{required:!0,message:"请选择单位",trigger:"change"}],wasteTypeId:[{required:!0,message:"请选择废物类型",trigger:"change"}],location:[{required:!0,message:"请输入废物产生地点",trigger:"blur"}],collectionDate:[{required:!1}],collectionTime:[{required:!1}],quantity:[{required:!0,message:"请输入收集数量",trigger:"change"}]};(0,l.sV)((async()=>{a.value=!0;try{await V(),I.value&&await x(),L.value?!I.value&&Ot.state.user&&(R.unitId=Ot.state.user.unit_id,await U(R.unitId)):await W()}catch(e){console.error("初始化数据失败:",e),g.nk.error("加载数据失败，请刷新重试")}finally{a.value=!1}}));const x=async()=>{try{const e=await Tt.get(v.endpoints.units);u.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},U=async e=>{try{const t=await Tt.get(v.endpoints.units),o=t.data.find((t=>t.id===parseInt(e)));o&&(n.value=o.name)}catch(t){console.error("获取单位信息失败:",t)}},V=async()=>{try{const e=await Tt.get(v.endpoints.wasteTypes);i.value=e.data}catch(e){console.error("获取废物类型失败:",e),g.nk.error("获取废物类型失败")}},W=async()=>{try{a.value=!0;const e=await Tt.get(`${v.endpoints.wasteRecords}/detail/${t.params.id}`),o=e.data;if(console.log("获取到的记录详情:",o),R.unitId=o.unit_id,R.wasteTypeId=o.waste_type_id,R.location=o.location,R.recordId=o.id,o.collection_start_time){const e=new Date(o.collection_start_time);R.collectionDate=e.toISOString().slice(0,10),R.collectionTime=e.toTimeString().slice(0,5)}if(R.quantity=o.quantity,o.photo_path_before){console.log("收集前照片路径:",o.photo_path_before);const e=F(o.photo_path_before);console.log("解析后的收集前照片路径:",e),d.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const o=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${o}`}return console.log("收集前照片完整URL:",t),{name:e.split("/").pop(),url:t}}))}if(o.photo_path_after){console.log("收集后照片路径:",o.photo_path_after);const e=F(o.photo_path_after);console.log("解析后的收集后照片路径:",e),c.value=e.map((e=>{let t=e;if(!e.startsWith("http")){const o=e.startsWith("/")?e.substring(1):e;t=`${window.location.origin}/${o}`}return console.log("收集后照片完整URL:",t),{name:e.split("/").pop(),url:t}}))}n.value=o.unit_name,b.value=o.created_at,S([...d.value,...c.value])}catch(e){console.error("获取记录详情失败:",e),g.nk.error("获取记录详情失败")}finally{a.value=!1}},E=async e=>{const t=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"],o=t.includes(e.type);if(!o)return g.nk.error("只能上传图片文件!"),!1;const a=52428800;if(e.size>a)return g.nk.error("图片大小不能超过50MB!"),!1;const l=2097152;return e.size>l&&(_.value=!0),!0},$=(e,t)=>(console.log("收集前照片变更:",e),D(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集前照片添加raw属性:",e.raw)),d.value=t,S([...d.value,...c.value]),!1),P=(e,t)=>{console.log("收集前照片移除:",e),d.value=t,D([...d.value,...c.value])||(_.value=!1),S([...d.value,...c.value])},T=(e,t)=>(console.log("收集后照片变更:",e),D(t),void 0===e.raw&&"ready"===e.status&&(e.raw=e.originFileObj||e,console.log("为收集后照片添加raw属性:",e.raw)),c.value=t,S([...d.value,...c.value]),!1),A=(e,t)=>{console.log("收集后照片移除:",e),c.value=t,D([...d.value,...c.value])||(_.value=!1),S([...d.value,...c.value])},S=e=>{p.value=e.map((e=>e.url?(console.log("预览图片URL:",e.url),e.url):e.raw?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e.raw)),console.log("预览图片从raw创建:",e._blobUrl),e._blobUrl):e instanceof File?(e._blobUrl||(e._blobUrl=URL.createObjectURL(e)),console.log("预览图片从File创建:",e._blobUrl),e._blobUrl):"")).filter((e=>e)),console.log("预览图片列表:",p.value)},X=e=>{console.log("预览图片:",e),S([...d.value,...c.value]);const t=p.value.findIndex((t=>{if(e.url)return t===e.url;if(e.raw){const o=URL.createObjectURL(e.raw),a=t===o;return URL.revokeObjectURL(o),a}return!1}));f.value=-1!==t?t:0,m.value=!0},K=()=>{m.value=!1},D=e=>{const t=2097152;return e.some((e=>e.size>t))},q=e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);k.value=t,y.value=t<33?"正在上传文件...":t<66?"正在处理文件...":t<100?"即将完成...":"上传完成，正在保存..."}},Q=e=>100===e?"完成":`${e}%`,j=async()=>{o.value&&await o.value.validate((async e=>{if(!e)return console.log("表单验证失败"),g.nk.error("请填写所有必填字段"),!1;k.value=0,y.value="正在上传文件...",w.value=!0;try{const e=new FormData;if(e.append("unitId",R.unitId),e.append("wasteTypeId",R.wasteTypeId),e.append("location",R.location),e.append("collectionDate",R.collectionDate),e.append("collectionTime",R.collectionTime),e.append("quantity",R.quantity),e.append("remarks",R.remarks||""),d.value.length>0){const t=d.value.filter((e=>e.raw)),o=d.value.filter((e=>!e.raw));if(t.length>0){if(console.log("有新上传的收集前照片，需要合并现有照片"),t.forEach((t=>{t.raw&&(console.log("添加新的收集前照片:",t.raw.name),e.append("photo_before",t.raw))})),o.length>0){const t=o.map((e=>{let t=e.url;const o=window.location.origin;return t.startsWith(o)&&(t=t.substring(o.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集前照片路径:",t),e.append("photo_path_before",JSON.stringify(t))}}else if(o.length>0){const t=o.map((e=>{let t=e.url;const o=window.location.origin;return t.startsWith(o)&&(t=t.substring(o.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集前照片路径(无新照片):",t),e.append("photo_path_before",JSON.stringify(t))}}else e.append("photo_path_before",JSON.stringify([]));if(c.value.length>0){const t=c.value.filter((e=>e.raw)),o=c.value.filter((e=>!e.raw));if(t.length>0){if(console.log("有新上传的收集后照片，需要合并现有照片"),t.forEach((t=>{t.raw&&(console.log("添加新的收集后照片:",t.raw.name),e.append("photo_after",t.raw))})),o.length>0){const t=o.map((e=>{let t=e.url;const o=window.location.origin;return t.startsWith(o)&&(t=t.substring(o.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集后照片路径:",t),e.append("photo_path_after",JSON.stringify(t))}}else if(o.length>0){const t=o.map((e=>{let t=e.url;const o=window.location.origin;return t.startsWith(o)&&(t=t.substring(o.length),t.startsWith("/")||(t="/"+t)),t}));console.log("保存现有收集后照片路径(无新照片):",t),e.append("photo_path_after",JSON.stringify(t))}}else e.append("photo_path_after",JSON.stringify([]));console.log("FormData内容:");for(let[t,o]of e.entries())o instanceof File?console.log(`${t}: File - ${o.name} (${o.type}, ${o.size} bytes)`):console.log(`${t}: ${o}`);R.recordId?(await Tt.putForm(`${v.endpoints.wasteRecords}/${R.recordId}`,e,q),g.nk.success("废物记录更新成功")):(await Tt.postForm(v.endpoints.wasteRecords,e,q),g.nk.success("废物记录添加成功")),w.value=!1,B()}catch(t){console.error("提交表单失败:",t),t.response&&t.response.data?(console.error("服务器返回错误:",t.response.data),g.nk.error(`提交表单失败: ${t.response.data.error||"未知错误"}`)):g.nk.error("提交表单失败，请检查网络连接"),w.value=!1}}))},B=()=>{I.value?e.push("/admin-records"):e.push({name:"RecordsList",params:{unitId:Ot.state.user.unit_id}})};return{form:R,rules:C,recordForm:o,loading:a,submitting:r,unitName:n,wasteTypes:i,units:u,fileListBefore:d,fileListAfter:c,previewImages:p,showViewer:m,previewIndex:f,isNew:L,isSuperAdmin:I,parsePhotoPath:F,handlePhotoBeforeChange:$,handlePhotoBeforeRemove:P,handlePhotoAfterChange:T,handlePhotoAfterRemove:A,handlePictureCardPreview:X,handleBeforeUpload:E,closeViewer:K,submitForm:j,goBack:B,showUploadProgress:w,uploadPercentage:k,uploadStatus:y,percentageFormat:Q,showLargeFileWarning:_}}};const Be=(0,I.A)(je,[["render",Qe],["__scopeId","data-v-23929916"]]);var Oe=Be;const Me={class:"user-management-container"},Ne={class:"header"},Ye={class:"content"},ze={class:"toolbar"},He={key:0,class:"password-hint"},Je={key:1,class:"password-hint"},Ge={class:"dialog-footer"};function Ze(e,t,o,a,r,n){const s=(0,l.g2)("arrow-left"),i=(0,l.g2)("el-icon"),u=(0,l.g2)("plus"),d=(0,l.g2)("el-button"),c=(0,l.g2)("el-table-column"),p=(0,l.g2)("el-popconfirm"),m=(0,l.g2)("el-table"),g=(0,l.g2)("el-input"),h=(0,l.g2)("el-form-item"),f=(0,l.g2)("el-option"),b=(0,l.g2)("el-select"),v=(0,l.g2)("el-form"),w=(0,l.g2)("el-dialog"),k=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",Me,[(0,l.Lk)("div",Ne,[(0,l.Lk)("div",{class:"back-button",onClick:t[0]||(t[0]=(...e)=>a.goBack&&a.goBack(...e))},[(0,l.bF)(i,null,{default:(0,l.k6)((()=>[(0,l.bF)(s)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 返回 "))]),t[9]||(t[9]=(0,l.Lk)("h1",null,"人员管理",-1)),t[10]||(t[10]=(0,l.Lk)("div",null,null,-1))]),(0,l.Lk)("div",Ye,[(0,l.Lk)("div",ze,[(0,l.bF)(d,{type:"primary",onClick:a.openAddDialog},{default:(0,l.k6)((()=>[(0,l.bF)(i,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 添加用户 "))])),_:1},8,["onClick"])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(m,{data:a.users,border:"",stripe:"",style:{width:"100%","margin-top":"20px"}},{default:(0,l.k6)((()=>[(0,l.bF)(c,{prop:"id",label:"ID",width:"60"}),(0,l.bF)(c,{prop:"username",label:"姓名",width:"120"}),(0,l.bF)(c,{prop:"phone",label:"手机号",width:"140"}),(0,l.bF)(c,{prop:"role_name",label:"角色",width:"120"}),(0,l.bF)(c,{prop:"unit_name",label:"单位","min-width":"120"}),(0,l.bF)(c,{label:"操作",width:"180",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.bF)(d,{size:"small",onClick:t=>a.handleEdit(e.row)},{default:(0,l.k6)((()=>t[12]||(t[12]=[(0,l.eW)("编辑")]))),_:2},1032,["onClick"]),(0,l.bF)(p,{title:"确定要删除此用户吗？",onConfirm:t=>a.handleDelete(e.row)},{reference:(0,l.k6)((()=>[(0,l.bF)(d,{size:"small",type:"danger"},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("删除")]))),_:1})])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"])),[[k,a.loading]])]),(0,l.bF)(w,{modelValue:a.dialogVisible,"onUpdate:modelValue":t[7]||(t[7]=e=>a.dialogVisible=e),title:a.isEdit?"编辑用户":"添加用户",width:"500px"},{footer:(0,l.k6)((()=>[(0,l.Lk)("span",Ge,[(0,l.bF)(d,{onClick:t[6]||(t[6]=e=>a.dialogVisible=!1)},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(d,{type:"primary",onClick:a.submitForm,loading:a.formLoading},{default:(0,l.k6)((()=>t[15]||(t[15]=[(0,l.eW)(" 确认 ")]))),_:1},8,["onClick","loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(v,{ref:"userForm",model:a.form,rules:a.rules,"label-width":"100px",style:{"max-width":"400px",margin:"0 auto"}},{default:(0,l.k6)((()=>[(0,l.bF)(h,{label:"姓名",prop:"username"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.username,"onUpdate:modelValue":t[1]||(t[1]=e=>a.form.username=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),(0,l.bF)(h,{label:"手机号",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.phone,"onUpdate:modelValue":t[2]||(t[2]=e=>a.form.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),(0,l.bF)(h,{label:"角色",prop:"roleId"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:a.form.roleId,"onUpdate:modelValue":t[3]||(t[3]=e=>a.form.roleId=e),placeholder:"请选择角色",style:{width:"100%"}},{default:(0,l.k6)((()=>[a.isSuperAdmin?((0,l.uX)(),(0,l.Wv)(f,{key:0,value:3,label:"超级管理员"})):(0,l.Q3)("",!0),(0,l.bF)(f,{value:2,label:"单位管理员"}),(0,l.bF)(f,{value:1,label:"基层员工"})])),_:1},8,["modelValue"])])),_:1}),3!==a.form.roleId?((0,l.uX)(),(0,l.Wv)(h,{key:0,label:"单位",prop:"unitId"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:a.form.unitId,"onUpdate:modelValue":t[4]||(t[4]=e=>a.form.unitId=e),placeholder:"请选择单位",style:{width:"100%"},disabled:!a.isSuperAdmin&&a.isEdit},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(a.units,(e=>((0,l.uX)(),(0,l.Wv)(f,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})):(0,l.Q3)("",!0),(0,l.bF)(h,{label:"密码",prop:"password"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{modelValue:a.form.password,"onUpdate:modelValue":t[5]||(t[5]=e=>a.form.password=e),placeholder:"请输入密码",type:"password","show-password":""},null,8,["modelValue"]),a.isEdit?((0,l.uX)(),(0,l.CE)("div",Je,"不修改密码请留空")):((0,l.uX)(),(0,l.CE)("div",He,"所有账号必须设置密码"))])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),t[16]||(t[16]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1))])}var et={name:"UserManagement",components:{ArrowLeft:K.nkM,Plus:K.FWt},setup(){const e=(0,s.rd)(),t=(0,h.KR)(!1),o=(0,h.KR)(!1),a=(0,h.KR)(!1),r=(0,h.KR)(!1),n=(0,h.KR)(null),i=(0,h.KR)([]),u=(0,h.KR)([]),d=(0,l.EW)((()=>Ot.state.isLoggedIn&&3===Ot.state.user.role_id)),c=(0,l.EW)((()=>Ot.state.isLoggedIn?Ot.state.user.unit_id:null)),p=(0,h.Kh)({id:null,username:"",phone:"",roleId:1,unitId:null,password:""}),m={username:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],unitId:[{required:!0,message:"请选择单位",trigger:"change"}],password:[{required:function(){return!r.value},message:"请输入密码",trigger:"blur"},{min:1,max:20,message:"长度在 1 到 20 个字符",trigger:"blur"}]},f=async()=>{t.value=!0;try{let e;e=d.value?await Tt.get(v.endpoints.users):await Tt.get(`${v.endpoints.units}/${c.value}/users`),i.value=e.data}catch(e){console.error("Error fetching users:",e),g.nk.error("获取用户列表失败")}finally{t.value=!1}},b=async()=>{try{const e=await Tt.get(v.endpoints.units);u.value=e.data}catch(e){console.error("Error fetching units:",e),g.nk.error("获取单位列表失败")}},w=()=>{r.value=!1,_(),a.value=!0,d.value||(p.unitId=c.value)},k=e=>{r.value=!0,p.id=e.id,p.username=e.username,p.phone=e.phone,p.roleId=e.role_id,p.unitId=e.unit_id,p.password="",a.value=!0},y=async e=>{try{await Tt.delete(`${v.endpoints.users}/${e.id}`),g.nk.success("用户删除成功"),f()}catch(t){console.error("Error deleting user:",t);let e="删除用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}},_=()=>{n.value&&n.value.resetFields(),p.id=null,p.username="",p.phone="",p.roleId=1,p.unitId=null,p.password=""},F=()=>{n.value.validate((async e=>{if(e){o.value=!0;try{const e={username:p.username,phone:p.phone,roleId:p.roleId,unitId:3!==p.roleId?p.unitId:null};p.password&&(e.password=p.password),r.value?(await Tt.put(`${v.endpoints.users}/${p.id}`,e),g.nk.success("用户更新成功")):(await Tt.post(v.endpoints.users,e),g.nk.success("用户添加成功")),a.value=!1,f()}catch(t){console.error("Error submitting user form:",t);let e=r.value?"更新用户失败":"添加用户失败";t.response&&t.response.data&&t.response.data.error&&(e=t.response.data.error),g.nk.error(e)}finally{o.value=!1}}else g.nk.warning("请完成必填项")}))},L=()=>{e.back()};return(0,l.sV)((()=>{f(),b()})),{loading:t,formLoading:o,dialogVisible:a,isEdit:r,userForm:n,users:i,units:u,form:p,rules:m,isSuperAdmin:d,currentUnitId:c,openAddDialog:w,handleEdit:k,handleDelete:y,submitForm:F,goBack:L}}};const tt=(0,I.A)(et,[["render",Ze],["__scopeId","data-v-53211ca3"]]);var ot=tt;const at={class:"admin-records-container"},lt={class:"content"},rt={class:"actions"},nt={class:"filter-header"},st={class:"filter-form-container"},it={class:"quantity-range"},ut={class:"filter-actions"},dt={class:"records-wrapper"},ct={class:"card-header"},pt={class:"card-actions"},mt={key:0,class:"photo-preview"},gt=["onClick"],ht={key:0,class:"photo-count"},ft={key:1},bt={key:0,class:"photo-preview"},vt=["onClick"],wt={key:0,class:"photo-count"},kt={key:1},yt={class:"operation-buttons"},_t={key:0,class:"loading-more"},Ft={key:1,class:"empty-block"};function Lt(e,t,o,r,n,s){const u=(0,l.g2)("plus"),d=(0,l.g2)("el-icon"),c=(0,l.g2)("el-button"),p=(0,l.g2)("user"),m=(0,l.g2)("refresh"),g=(0,l.g2)("arrow-down"),h=(0,l.g2)("arrow-up"),f=(0,l.g2)("el-option"),b=(0,l.g2)("el-select"),v=(0,l.g2)("el-form-item"),w=(0,l.g2)("el-col"),k=(0,l.g2)("el-date-picker"),y=(0,l.g2)("el-row"),_=(0,l.g2)("el-input-number"),F=(0,l.g2)("el-input"),L=(0,l.g2)("el-form"),I=(0,l.g2)("el-card"),R=(0,l.g2)("download"),C=(0,l.g2)("el-table-column"),x=(0,l.g2)("el-image"),U=(0,l.g2)("el-table"),V=(0,l.g2)("loading"),W=(0,l.g2)("el-empty"),E=(0,l.g2)("el-image-viewer"),$=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",at,[t[19]||(t[19]=(0,l.Lk)("div",{class:"header"},[(0,l.Lk)("h1",null,"危险废物管理系统 - 全部记录")],-1)),(0,l.Lk)("div",lt,[(0,l.Lk)("div",rt,[(0,l.bF)(c,{type:"primary",onClick:r.addNewRecord},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(u)])),_:1}),t[7]||(t[7]=(0,l.eW)(" 新增填报 "))])),_:1},8,["onClick"]),(0,l.bF)(c,{type:"success",onClick:r.goToUserManagement},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(p)])),_:1}),t[8]||(t[8]=(0,l.eW)(" 人员管理 "))])),_:1},8,["onClick"]),(0,l.bF)(c,{onClick:r.refreshRecords},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(m)])),_:1}),t[9]||(t[9]=(0,l.eW)(" 刷新 "))])),_:1},8,["onClick"])]),(0,l.bF)(I,{class:"filter-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",nt,[t[10]||(t[10]=(0,l.Lk)("h3",null,"筛选条件",-1)),(0,l.bF)(c,{type:"primary",link:"",onClick:t[0]||(t[0]=e=>r.showFilterPanel=!r.showFilterPanel)},{default:(0,l.k6)((()=>[(0,l.eW)((0,i.v_)(r.showFilterPanel?"收起":"展开")+" ",1),r.showFilterPanel?((0,l.uX)(),(0,l.Wv)(d,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(h)])),_:1})):((0,l.uX)(),(0,l.Wv)(d,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(g)])),_:1}))])),_:1})]),(0,l.bo)((0,l.Lk)("div",st,[(0,l.bF)(L,{model:r.filterForm,"label-width":"100px",class:"filter-form"},{default:(0,l.k6)((()=>[(0,l.bF)(y,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(w,{span:12},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"所属单位"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:r.filterForm.unitId,"onUpdate:modelValue":t[1]||(t[1]=e=>r.filterForm.unitId=e),placeholder:"选择单位",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.units,(e=>((0,l.uX)(),(0,l.Wv)(f,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(w,{span:12},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"收集时间"},{default:(0,l.k6)((()=>[(0,l.bF)(k,{modelValue:r.filterForm.dateRange,"onUpdate:modelValue":t[2]||(t[2]=e=>r.filterForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.bF)(y,{gutter:20},{default:(0,l.k6)((()=>[(0,l.bF)(w,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"废物类型"},{default:(0,l.k6)((()=>[(0,l.bF)(b,{modelValue:r.filterForm.wasteTypeId,"onUpdate:modelValue":t[3]||(t[3]=e=>r.filterForm.wasteTypeId=e),placeholder:"选择废物类型",style:{width:"100%"},clearable:""},{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.wasteTypes,(e=>((0,l.uX)(),(0,l.Wv)(f,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),(0,l.bF)(w,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"数量范围(吨)"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",it,[(0,l.bF)(_,{modelValue:r.filterForm.minQuantity,"onUpdate:modelValue":t[4]||(t[4]=e=>r.filterForm.minQuantity=e),min:0,precision:3,step:.001,placeholder:"最小值",style:{width:"47%"}},null,8,["modelValue"]),t[11]||(t[11]=(0,l.Lk)("span",{class:"range-separator"},"至",-1)),(0,l.bF)(_,{modelValue:r.filterForm.maxQuantity,"onUpdate:modelValue":t[5]||(t[5]=e=>r.filterForm.maxQuantity=e),min:r.filterForm.minQuantity||0,precision:3,step:.001,placeholder:"最大值",style:{width:"47%"}},null,8,["modelValue","min"])])])),_:1})])),_:1}),(0,l.bF)(w,{span:8},{default:(0,l.k6)((()=>[(0,l.bF)(v,{label:"产生地点"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{modelValue:r.filterForm.location,"onUpdate:modelValue":t[6]||(t[6]=e=>r.filterForm.location=e),placeholder:"输入地点关键词搜索",clearable:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.Lk)("div",ut,[(0,l.bF)(c,{type:"primary",onClick:r.applyFilter},{default:(0,l.k6)((()=>t[12]||(t[12]=[(0,l.eW)("筛选")]))),_:1},8,["onClick"]),(0,l.bF)(c,{onClick:r.resetFilter},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("重置")]))),_:1},8,["onClick"])])])),_:1},8,["model"])],512),[[a.aG,r.showFilterPanel]])])),_:1}),(0,l.Lk)("div",dt,[(0,l.bF)(I,{class:"records-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",ct,[t[15]||(t[15]=(0,l.Lk)("h3",null,"所有废物记录",-1)),(0,l.Lk)("div",pt,[(0,l.bF)(c,{type:"warning",onClick:r.exportRecords},{default:(0,l.k6)((()=>[(0,l.bF)(d,null,{default:(0,l.k6)((()=>[(0,l.bF)(R)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 导出记录 "))])),_:1},8,["onClick"])])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(U,{data:r.filteredRecords,style:{width:"100%"},border:"",stripe:"",class:"responsive-table",height:"500",onScroll:r.handleScroll},{default:(0,l.k6)((()=>[(0,l.bF)(C,{prop:"unit_name",label:"单位",width:"100"}),(0,l.bF)(C,{prop:"waste_type_name",label:"废物类型",width:"100"}),(0,l.bF)(C,{prop:"location",label:"产生地点"}),(0,l.bF)(C,{prop:"collection_start_time",label:"收集开始时间",width:"160"}),(0,l.bF)(C,{label:"数量(吨)",width:"80"},{default:(0,l.k6)((e=>[(0,l.eW)((0,i.v_)(parseFloat(e.row.quantity).toFixed(3)),1)])),_:1}),(0,l.bF)(C,{prop:"creator_name",label:"汇报人",width:"100"}),(0,l.bF)(C,{prop:"created_at",label:"记录时间",width:"160"}),(0,l.bF)(C,{label:"现场照片（清理前）",width:"120",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_before?((0,l.uX)(),(0,l.CE)("div",mt,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_before),((t,o)=>((0,l.uX)(),(0,l.CE)("div",{key:o,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_before),o)},[(0,l.bF)(x,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,gt)))),128)),r.parsePhotoPath(e.row.photo_path_before).length>1?((0,l.uX)(),(0,l.CE)("div",ht,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_before).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",ft,"无"))])),_:1}),(0,l.bF)(C,{label:"现场照片（清理后）",width:"120",align:"center"},{default:(0,l.k6)((e=>[e.row.photo_path_after?((0,l.uX)(),(0,l.CE)("div",bt,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsePhotoPath(e.row.photo_path_after),((t,o)=>((0,l.uX)(),(0,l.CE)("div",{key:o,class:"photo-thumbnail-container",onClick:t=>r.previewPhoto(r.parsePhotoPath(e.row.photo_path_after),o)},[(0,l.bF)(x,{style:{width:"50px",height:"50px"},src:`${r.baseUrl}${t}`,fit:"cover"},null,8,["src"])],8,vt)))),128)),r.parsePhotoPath(e.row.photo_path_after).length>1?((0,l.uX)(),(0,l.CE)("div",wt,(0,i.v_)(r.parsePhotoPath(e.row.photo_path_after).length)+"张 ",1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("span",kt,"无"))])),_:1}),(0,l.bF)(C,{label:"操作",width:"70",fixed:"right"},{default:(0,l.k6)((e=>[(0,l.Lk)("div",yt,[(0,l.bF)(c,{type:"primary",size:"small",onClick:t=>r.editRecord(e.row.id),text:""},{default:(0,l.k6)((()=>t[16]||(t[16]=[(0,l.eW)(" 编辑 ")]))),_:2},1032,["onClick"]),(0,l.bF)(c,{type:"danger",size:"small",onClick:t=>r.confirmDelete(e.row),text:""},{default:(0,l.k6)((()=>t[17]||(t[17]=[(0,l.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data","onScroll"])),[[$,r.loading]]),r.loadingMore?((0,l.uX)(),(0,l.CE)("div",_t,[(0,l.bF)(d,{class:"loading"},{default:(0,l.k6)((()=>[(0,l.bF)(V)])),_:1}),t[18]||(t[18]=(0,l.eW)(" 加载更多... "))])):(0,l.Q3)("",!0),0!==r.records.length||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",Ft,[(0,l.bF)(W,{description:"暂无废物记录"})]))])),_:1})])]),t[20]||(t[20]=(0,l.Lk)("div",{class:"footer"},[(0,l.Lk)("p",null,"© 2025 危险废物管理系统")],-1)),r.showViewer?((0,l.uX)(),(0,l.Wv)(E,{key:0,"url-list":r.previewImages,"initial-index":r.previewIndex,onClose:r.closeViewer},null,8,["url-list","initial-index","onClose"])):(0,l.Q3)("",!0)])}const It=e=>{if(!e)return[];try{return e.startsWith("[")&&e.endsWith("]")?JSON.parse(e):[e]}catch(t){return console.error("解析照片路径失败:",t),[e]}},Rt=(e,t)=>{if(!e.photos)return[];try{const o=JSON.parse(e.photos);return Array.isArray(o)?o.filter((e=>e.type===t)):[]}catch(o){return console.error("解析照片JSON失败:",o),[]}};var Ct={name:"AdminRecordsView",components:{Plus:K.FWt,Refresh:K.C42,User:K.KJW,ArrowDown:K.yd$,ArrowUp:K.DoI,Download:K.f5X,ElImageViewer:ge.Tg,Loading:K.Rhj},setup(){const e=(0,s.rd)(),t=(0,h.KR)([]),o=(0,h.KR)(!1),a=(0,h.KR)([]),r=(0,h.KR)([]),n=(0,h.KR)(!0),i=v.baseURL,u=(0,h.KR)(!1),d=(0,h.KR)([]),c=(0,h.KR)(0),p=(0,h.KR)(1),m=(0,h.KR)(20),b=(0,h.KR)(!0),w=(0,h.KR)(!1),k=(0,h.Kh)({unitId:null,dateRange:null,wasteTypeId:null,minQuantity:null,maxQuantity:null,location:""}),y=(0,l.EW)((()=>t.value.filter((e=>{if(k.unitId&&e.unit_id!==k.unitId)return!1;if(k.wasteTypeId&&e.waste_type_id!==k.wasteTypeId)return!1;if(null!==k.minQuantity&&parseFloat(e.quantity)<k.minQuantity)return!1;if(null!==k.maxQuantity&&parseFloat(e.quantity)>k.maxQuantity)return!1;if(k.location&&!e.location.toLowerCase().includes(k.location.toLowerCase()))return!1;if(k.dateRange&&2===k.dateRange.length){const t=new Date(k.dateRange[0]),o=new Date(k.dateRange[1]);if(o.setHours(23,59,59,999),!e.collection_start_time)return!1;{const a=_(e.collection_start_time);if(a<t||a>o)return!1}}return!0})))),_=e=>{const t=e.replace(/[^0-9\-: ]/g,"");return new Date(t)};(0,l.sV)((async()=>{if(!Ot.state.isLoggedIn||3!==Ot.state.user.role_id)return g.nk.error("权限不足"),void e.push("/login");await Promise.all([F(),L(),I()])}));const F=async()=>{try{const e=await f.A.get(v.getUrl(v.endpoints.units));a.value=e.data}catch(e){console.error("获取单位列表失败:",e),g.nk.error("获取单位列表失败")}},L=async()=>{try{const e=await f.A.get(v.getUrl(v.endpoints.wasteTypes));r.value=e.data}catch(e){console.error("获取废物类型列表失败:",e),g.nk.error("获取废物类型列表失败")}},I=async(e=!1)=>{e?w.value=!0:(o.value=!0,p.value=1,t.value=[]);try{const o={page:p.value,pageSize:m.value,wasteTypeId:k.wasteTypeId,minQuantity:k.minQuantity,maxQuantity:k.maxQuantity,location:k.location};k.dateRange&&2===k.dateRange.length&&(o.dateRange=JSON.stringify(k.dateRange));const a=await f.A.get(`${v.getUrl(v.endpoints.wasteRecords)}/user/${Ot.state.user.id}`,{params:o}),l=a.data.records.map((e=>({...e,created_at:R(e.created_at),collection_start_time:R(e.collection_start_time)})));t.value=e?[...t.value,...l]:l,b.value=a.data.hasMore,b.value&&p.value++}catch(a){console.error("获取废物记录失败:",a),g.nk.error("获取废物记录失败")}finally{o.value=!1,w.value=!1}},R=e=>{if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})},C=()=>{I()},x=()=>{3===Ot.state.user.role_id?e.push("/record/new"):e.push(`/unit/${Ot.state.user.unit_id}`)},U=()=>{e.push("/user-management")},V=t=>{e.push(`/record/${t}`)},W=async()=>{await I(),g.nk.success("筛选已应用")},E=async()=>{k.unitId=null,k.dateRange=null,k.wasteTypeId=null,k.minQuantity=null,k.maxQuantity=null,k.location="",await I(),g.nk.info("筛选条件已重置")},$=async()=>{if(0!==y.value.length)try{o.value=!0;const e=await f.A.get(`${v.getUrl(v.endpoints.wasteRecords)}/export/user/${Ot.state.user.id}`,{params:{unitId:k.unitId,wasteTypeId:k.wasteTypeId,minQuantity:k.minQuantity,maxQuantity:k.maxQuantity,location:k.location,dateRange:k.dateRange}}),t=e.data.map((e=>({...e,created_at:R(e.created_at),collection_start_time:R(e.collection_start_time)}))),l=[{title:"单位",field:"unit_name",width:15},{title:"废物类型",field:"waste_type_name",width:15},{title:"产生地点",field:"location",width:20},{title:"收集开始时间",field:"collection_start_time",width:20,type:"datetime"},{title:"数量(吨)",field:"quantity",width:12,type:"number"},{title:"记录时间",field:"created_at",width:20,type:"datetime"}];let n="全部废物记录";if(k.unitId){const e=a.value.find((e=>e.id===k.unitId));e&&(n=`${e.name}_废物记录`)}if(k.wasteTypeId){const e=r.value.find((e=>e.id===k.wasteTypeId));e&&(n+=`_${e.name}`)}we(t,n,l),g.nk.success("导出成功")}catch(e){console.error("导出记录失败:",e),g.nk.error("导出记录失败")}finally{o.value=!1}else g.nk.warning("没有可导出的记录")},P=e=>{he.s.confirm("此操作将永久删除该记录，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await f.A.delete(`${v.getUrl(v.endpoints.wasteRecords)}/${e.id}`),g.nk.success("删除成功"),await I()}catch(t){console.error("删除记录失败:",t),g.nk.error("删除记录失败")}})).catch((()=>{g.nk.info("已取消删除")}))},T=(e,t)=>{const o=Array.isArray(e)?e:[e];d.value=o.map((e=>`${i}${e}`)),c.value=t||0,u.value=!0},A=()=>{u.value=!1},S=async e=>{const t=e.target;t&&t.scrollHeight&&!w.value&&b.value&&t.scrollHeight-t.scrollTop-t.clientHeight<100&&await I(!0)};return{records:t,filteredRecords:y,loading:o,units:a,wasteTypes:r,showFilterPanel:n,filterForm:k,applyFilter:W,resetFilter:E,exportRecords:$,parsePhotoPath:It,getPhotosByType:Rt,refreshRecords:C,addNewRecord:x,goToUserManagement:U,editRecord:V,confirmDelete:P,showViewer:u,previewImages:d,previewIndex:c,previewPhoto:T,closeViewer:A,baseUrl:i,page:p,pageSize:m,hasMore:b,loadingMore:w,handleScroll:S}}};const xt=(0,I.A)(Ct,[["render",Lt],["__scopeId","data-v-02c0f4e0"]]);var Ut=xt;const Vt=[{path:"/login",name:"Login",component:Ee,meta:{requiresAuth:!1}},{path:"/user-management",name:"UserManagement",component:ot,meta:{requiresAuth:!0,requiresManager:!0}},{path:"/",name:"UnitSelection",component:C,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/admin-records",name:"AdminRecords",component:Ut,meta:{requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/record/new",name:"EditRecord",component:Oe,props:{id:null},meta:{requiresAuth:!0}},{path:"/record/:id",name:"EditRecord",component:Oe,props:!0,meta:{requiresAuth:!0}},{path:"/unit/:id",name:"WasteForm",component:Q,props:!0,meta:{requiresAuth:!0}},{path:"/records/:unitId",name:"RecordsList",component:Ie,props:!0,meta:{requiresAuth:!0}}],Wt=(0,s.aE)({history:(0,s.LA)("/"),routes:Vt});Wt.beforeEach(((e,t,o)=>{const a=e.matched.some((e=>e.meta.requiresAuth)),l=e.matched.some((e=>e.meta.requiresSuperAdmin)),r=e.matched.some((e=>e.meta.requiresManager));if(!a||Ot.state.isLoggedIn)if(l&&Ot.state.isLoggedIn&&3!==Ot.state.user.role_id)o({name:"WasteForm",params:{id:Ot.state.user.unit_id}});else if(r&&Ot.state.isLoggedIn&&1===Ot.state.user.role_id)o({name:"WasteForm",params:{id:Ot.state.user.unit_id}});else{if("Login"!==e.name||!Ot.state.isLoggedIn)return"/"===e.path&&Ot.state.isLoggedIn?3===Ot.state.user.role_id?void o({name:"AdminRecords"}):2===Ot.state.user.role_id?void o({name:"RecordsList",params:{unitId:Ot.state.user.unit_id}}):void o({name:"WasteForm",params:{id:Ot.state.user.unit_id}}):void("WasteForm"===e.name&&Ot.state.isLoggedIn&&3!==Ot.state.user.role_id&&Ot.state.user.unit_id!==parseInt(e.params.id)?o({name:"WasteForm",params:{id:Ot.state.user.unit_id}}):o());3===Ot.state.user.role_id?o({name:"AdminRecords"}):2===Ot.state.user.role_id?o({name:"RecordsList",params:{unitId:Ot.state.user.unit_id}}):o({name:"WasteForm",params:{id:Ot.state.user.unit_id}})}else o({name:"Login"})}));var Et=Wt;const $t=f.A.create({baseURL:v.baseURL,timeout:3e5,headers:{"Content-Type":"application/json"},maxContentLength:52428800,maxBodyLength:52428800});$t.interceptors.request.use((e=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return t&&(e.headers.Authorization=`Bearer ${t}`),e}),(e=>(console.error("Request error:",e),Promise.reject(e)))),$t.interceptors.response.use((e=>e),(e=>{if(e.response)switch(e.response.status){case 401:if(e.config.url.includes("/api/login"))return Promise.reject(e);Ot.logout(),g.nk.error("登录已过期，请重新登录"),Et.push("/login");break;case 403:g.nk.error("没有权限访问该资源");break;case 404:g.nk.error("请求的资源不存在");break;case 500:g.nk.error("服务器错误，请稍后重试");break;default:g.nk.error(e.response.data?.error||"请求失败")}else e.request?g.nk.error("网络错误，请检查网络连接"):g.nk.error("请求配置错误");return Promise.reject(e)}));const Pt={get(e,t={}){return $t.get(e,{params:t})},post(e,t={}){return $t.post(e,t)},postForm(e,t,o){const a={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};return"function"===typeof o&&(a.onUploadProgress=o),$t.post(e,t,a)},put(e,t={}){return $t.put(e,t)},putForm(e,t,o){const a={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,maxContentLength:52428800,maxBodyLength:52428800};return"function"===typeof o&&(a.onUploadProgress=o),$t.put(e,t,a)},delete(e){return $t.delete(e)},defaults:$t.defaults};var Tt=Pt;const At={user:null,token:null,isLoggedIn:!1,loading:!1,error:null},St=(0,h.Kh)({...At}),Xt=()=>{const e=localStorage.getItem("user"),t=localStorage.getItem("token");if(e&&t)try{const o=JSON.parse(e);St.user=o,St.token=t,St.isLoggedIn=!0,Tt.defaults&&Tt.defaults.headers&&(Tt.defaults.headers.common["Authorization"]=`Bearer ${t}`)}catch(o){console.error("Error parsing saved user data:",o),localStorage.removeItem("user"),localStorage.removeItem("token")}},Kt=async(e,t,o=!1,a=1)=>{St.loading=!0,St.error=null,console.log("auth.login 开始执行，手机号:",e,"用户类型:",a);try{const l={phone:e,rememberMe:o,userType:a};null!==t&&void 0!==t&&""!==t?(l.password=t,console.log("auth.login 发送密码参数")):console.log("auth.login 不发送密码参数"),console.log("发送登录请求，数据:",l);const r=await Tt.post(v.endpoints.login,l);console.log("登录请求成功响应:",r.data);const{token:n,...s}=r.data;return St.user=s,St.token=n,St.isLoggedIn=!0,Tt.defaults&&Tt.defaults.headers&&(Tt.defaults.headers.common["Authorization"]=`Bearer ${n}`),o?(localStorage.setItem("user",JSON.stringify(s)),localStorage.setItem("token",n)):(sessionStorage.setItem("user",JSON.stringify(s)),sessionStorage.setItem("token",n)),{success:!0,user:s}}catch(l){return St.error=l.response?.data?.error||"登录失败，请检查网络连接",console.error("Login error:",l),{success:!1,error:St.error}}finally{St.loading=!1}},Dt=()=>{St.user=null,St.token=null,St.isLoggedIn=!1,Tt.defaults&&Tt.defaults.headers&&delete Tt.defaults.headers.common["Authorization"],localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")},qt=()=>St.isLoggedIn&&St.user&&3===St.user.role_id,Qt=()=>St.isLoggedIn&&St.user&&2===St.user.role_id,jt=()=>St.user?St.user.id:null,Bt=()=>St.user?St.user.unit_id:null;Xt();var Ot={state:St,login:Kt,logout:Dt,isAdmin:qt,isUnitAdmin:Qt,getUserId:jt,getUnitId:Bt},Mt={name:"AppHeader",setup(){const e=(0,s.rd)(),t=(0,l.EW)((()=>Ot.state.isLoggedIn?Ot.state.user.username||Ot.state.user.phone:"")),o=()=>{Ot.logout(),g.nk.success("已退出登录"),e.push("/login")};return{auth:Ot,userName:t,handleLogout:o}}};const Nt=(0,I.A)(Mt,[["render",m],["__scopeId","data-v-47e31eb0"]]);var Yt=Nt,zt={components:{AppHeader:Yt},setup(){const e=(0,s.lq)(),t=(0,l.EW)((()=>"/login"!==e.path));return{showHeader:t}}};const Ht=(0,I.A)(zt,[["render",n]]);var Jt=Ht,Gt=o(2536),Zt=(o(4188),o(5186));const eo=(0,a.Ef)(Jt);eo.use(Et),eo.use(Gt.A,{locale:Zt.A}),eo.mount("#app")}},t={};function o(a){var l=t[a];if(void 0!==l)return l.exports;var r=t[a]={exports:{}};return e[a].call(r.exports,r,r.exports,o),r.exports}o.m=e,function(){var e=[];o.O=function(t,a,l,r){if(!a){var n=1/0;for(d=0;d<e.length;d++){a=e[d][0],l=e[d][1],r=e[d][2];for(var s=!0,i=0;i<a.length;i++)(!1&r||n>=r)&&Object.keys(o.O).every((function(e){return o.O[e](a[i])}))?a.splice(i--,1):(s=!1,r<n&&(n=r));if(s){e.splice(d--,1);var u=l();void 0!==u&&(t=u)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[a,l,r]}}(),function(){o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,{a:t}),t}}(),function(){o.d=function(e,t){for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){o.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};o.O.j=function(t){return 0===e[t]};var t=function(t,a){var l,r,n=a[0],s=a[1],i=a[2],u=0;if(n.some((function(t){return 0!==e[t]}))){for(l in s)o.o(s,l)&&(o.m[l]=s[l]);if(i)var d=i(o)}for(t&&t(a);u<n.length;u++)r=n[u],o.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return o.O(d)},a=self["webpackChunkhazardous_waste_management_frontend"]=self["webpackChunkhazardous_waste_management_frontend"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=o.O(void 0,[504],(function(){return o(6906)}));a=o.O(a)})();
//# sourceMappingURL=app.f48e9b65.js.map