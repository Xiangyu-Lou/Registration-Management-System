{"ast":null,"code":"// 用于导出数据到CSV和Excel的工具函数\nimport * as XLSX from 'xlsx';\nimport ExcelJS from 'exceljs';\n// import { saveAs } from 'file-saver';\n\n// 检查XLSX库是否正确加载\nconsole.log('XLSX库版本:', XLSX.version);\nconsole.log('XLSX库可用方法:', Object.keys(XLSX).join(', '));\n\n/**\r\n * 从服务器获取图片并作为Buffer返回\r\n * @param {String} imageUrl - 图片的URL地址\r\n * @param {String} baseUrl - 基础URL，默认为当前域名\r\n * @returns {Promise<Buffer>} 图片的buffer数据\r\n */\nconst fetchImageAsBuffer = async (imageUrl, baseUrl = window.location.origin) => {\n  console.log('获取图片:', imageUrl);\n  if (!imageUrl) {\n    console.error('图片URL为空');\n    return null;\n  }\n\n  // 如果是相对路径，添加baseUrl\n  const fullUrl = imageUrl.startsWith('/') ? `${baseUrl}${imageUrl}` : imageUrl;\n  try {\n    console.log('获取图片:', fullUrl);\n    const response = await fetch(fullUrl, {\n      headers: {\n        'Cache-Control': 'no-cache',\n        'Pragma': 'no-cache'\n      }\n    });\n    if (!response.ok) {\n      throw new Error(`获取图片失败: ${response.status} ${response.statusText}`);\n    }\n    const arrayBuffer = await response.arrayBuffer();\n    console.log('图片获取成功，大小:', arrayBuffer.byteLength, '字节');\n    return Buffer.from(arrayBuffer);\n  } catch (error) {\n    console.error('获取图片失败:', error);\n    return null;\n  }\n};\n\n/**\r\n * 解析照片路径，支持JSON字符串和数组\r\n * @param {String|Array} path - 照片路径字符串或数组\r\n * @returns {Array} 解析后的照片路径数组\r\n */\nconst parsePhotoPath = path => {\n  if (!path) {\n    return [];\n  }\n\n  // 如果已经是数组，直接返回\n  if (Array.isArray(path)) {\n    return path;\n  }\n  try {\n    // 尝试解析JSON字符串\n    if (typeof path === 'string' && path.startsWith('[') && path.endsWith(']')) {\n      const parsed = JSON.parse(path);\n      return Array.isArray(parsed) ? parsed : [path];\n    }\n\n    // 非JSON格式，作为单个路径返回\n    return [path];\n  } catch (error) {\n    console.error('解析照片路径失败:', error);\n    return [path];\n  }\n};\n\n/**\r\n * 将数据导出为Excel文件，包含图片\r\n * @param {Array} data - 要导出的数据数组\r\n * @param {String} fileName - 导出的文件名（不含后缀）\r\n * @param {Array} headers - 要导出的列标题和对应字段名\r\n * @param {String} baseUrl - 基础URL，用于构建完整的图片路径\r\n */\nexport const exportToExcelWithImages = async (data, fileName, headers, baseUrl = window.location.origin) => {\n  console.log('=== exportToExcelWithImages 函数被调用 ===');\n  console.log('数据条数:', data.length);\n  if (!data || data.length === 0) {\n    console.error('导出失败：没有数据');\n    return false;\n  }\n  try {\n    // 处理文件名\n    fileName = fileName.replace(/[\\\\/:*?\"<>|]/g, '_');\n    const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 14);\n    const fullFileName = `${fileName}_${timestamp}.xlsx`;\n\n    // 创建新工作簿\n    const workbook = new ExcelJS.Workbook();\n    workbook.creator = '危险废物管理系统';\n    workbook.lastModifiedBy = '危险废物管理系统';\n    workbook.created = new Date();\n    workbook.modified = new Date();\n\n    // 添加工作表\n    const worksheet = workbook.addWorksheet('危险废物记录');\n\n    // 设置列\n    const columns = headers.map(header => ({\n      header: header.text,\n      key: header.field,\n      width: header.isImage ? 20 : 15\n    }));\n    worksheet.columns = columns;\n\n    // 设置表头样式\n    worksheet.getRow(1).font = {\n      bold: true\n    };\n    worksheet.getRow(1).alignment = {\n      vertical: 'middle',\n      horizontal: 'center'\n    };\n\n    // 添加数据行并处理图片\n    console.log('开始处理数据行...');\n    for (let rowIndex = 0; rowIndex < data.length; rowIndex++) {\n      const row = data[rowIndex];\n      const originalData = row.__original || row;\n      console.log(`处理第 ${rowIndex + 1}/${data.length} 条记录...`);\n\n      // 首先添加行基本数据\n      const rowData = {};\n      headers.forEach(header => {\n        if (!header.isImage) {\n          rowData[header.field] = row[header.field] || '';\n        }\n      });\n\n      // 添加行数据\n      const excelRow = worksheet.addRow(rowData);\n\n      // 设置行高\n      excelRow.height = 80; // 设置足够的高度显示图片\n\n      // 处理图片字段\n      for (const header of headers) {\n        if (header.isImage) {\n          const fieldName = header.field;\n          const photoPathField = fieldName === '清理前照片' ? 'photo_path_before' : fieldName === '清理后照片' ? 'photo_path_after' : null;\n          if (photoPathField && originalData[photoPathField]) {\n            // 解析照片路径\n            const photoPaths = parsePhotoPath(originalData[photoPathField]);\n            if (photoPaths.length > 0) {\n              console.log(`记录 ${rowIndex + 1} 的 ${fieldName} 有 ${photoPaths.length} 张照片，取第一张`);\n              const firstPhotoPath = photoPaths[0];\n\n              // 获取图片\n              try {\n                const imageBuffer = await fetchImageAsBuffer(firstPhotoPath, baseUrl);\n                if (imageBuffer) {\n                  // 找到这个字段在列中的位置\n                  const colIndex = headers.findIndex(h => h.field === fieldName) + 1;\n\n                  // 获取单元格位置\n                  const cellRef = worksheet.getCell(rowIndex + 2, colIndex).address;\n\n                  // 添加图片到工作表\n                  const imageId = workbook.addImage({\n                    buffer: imageBuffer,\n                    extension: firstPhotoPath.split('.').pop().toLowerCase()\n                  });\n\n                  // 将图片添加到单元格\n                  worksheet.addImage(imageId, {\n                    tl: {\n                      col: colIndex - 1,\n                      row: rowIndex + 1\n                    },\n                    br: {\n                      col: colIndex,\n                      row: rowIndex + 2\n                    },\n                    editAs: 'oneCell'\n                  });\n                  console.log(`已添加图片到单元格 ${cellRef}`);\n                } else {\n                  console.error(`获取图片失败: ${firstPhotoPath}`);\n                }\n              } catch (imageError) {\n                console.error(`处理图片时出错:`, imageError);\n              }\n            } else {\n              console.log(`记录 ${rowIndex + 1} 的 ${fieldName} 没有照片`);\n            }\n          }\n        }\n      }\n    }\n\n    // 导出工作簿\n    console.log('生成Excel数据...');\n    const buffer = await workbook.xlsx.writeBuffer();\n\n    // 创建Blob对象并下载\n    const blob = new Blob([buffer], {\n      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'\n    });\n\n    // 创建下载链接\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = fullFileName;\n\n    // 触发下载\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n    console.log('Excel导出成功');\n    return true;\n  } catch (error) {\n    console.error('导出Excel失败:', error);\n    console.error('错误详情:', error.message);\n    console.error('错误堆栈:', error.stack);\n\n    // 尝试使用普通的Excel导出（不包含图片）\n    console.log('尝试使用普通Excel导出（不包含图片）...');\n    try {\n      return exportToExcel(data, fileName, headers);\n    } catch (fallbackError) {\n      console.error('普通Excel导出也失败:', fallbackError);\n      return false;\n    }\n  }\n};\n\n/**\r\n * 将数据导出为Excel文件\r\n * @param {Array} data - 要导出的数据数组\r\n * @param {String} fileName - 导出的文件名（不含后缀）\r\n * @param {Array} headers - 要导出的列标题和对应字段名\r\n */\nexport const exportToExcel = (data, fileName, headers) => {\n  if (!data || data.length === 0) {\n    console.error('导出失败：没有数据');\n    return false;\n  }\n\n  // 处理文件名\n  fileName = fileName.replace(/[\\\\/:*?\"<>|]/g, '_');\n  const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 14);\n  console.log('导出函数被调用，数据条数:', data.length);\n\n  // 使用XLSX导出Excel\n  try {\n    console.log('尝试导出Excel...');\n\n    // 创建工作簿\n    const wb = XLSX.utils.book_new();\n    console.log('工作簿创建成功');\n\n    // 准备数据\n    const exportRows = data.map(row => {\n      const exportRow = {};\n      headers.forEach(header => {\n        exportRow[header.text] = row[header.field] || '';\n      });\n      return exportRow;\n    });\n    console.log('数据准备完成，开始创建工作表');\n\n    // 创建工作表\n    const ws = XLSX.utils.json_to_sheet(exportRows);\n    console.log('工作表创建成功');\n\n    // 设置列宽\n    const colWidths = headers.map(() => ({\n      wch: 20\n    }));\n    ws['!cols'] = colWidths;\n\n    // 添加工作表到工作簿\n    XLSX.utils.book_append_sheet(wb, ws, '危险废物记录');\n    console.log('工作表已添加到工作簿');\n\n    // 导出Excel文件\n    const excelFileName = `${fileName}_${timestamp}.xlsx`;\n    console.log('准备导出Excel文件:', excelFileName);\n\n    // 使用write方法导出\n    console.log('使用XLSX.write方法导出...');\n    const wbout = XLSX.write(wb, {\n      bookType: 'xlsx',\n      type: 'array'\n    });\n    console.log('Excel数据生成成功，大小:', wbout.length, '字节');\n\n    // 创建Blob对象\n    const blob = new Blob([wbout], {\n      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'\n    });\n    console.log('Blob创建成功，大小:', blob.size, '字节');\n\n    // 创建下载链接\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = excelFileName;\n    console.log('下载链接创建成功，准备触发点击');\n\n    // 触发下载\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n    console.log('Excel导出成功');\n    return true;\n  } catch (error) {\n    console.error('导出Excel失败，错误详情:', error);\n    console.log('回退到CSV导出');\n    // 如果Excel导出失败，回退到CSV导出\n    exportToCSV(data, fileName, headers);\n    return false;\n  }\n};\n\n/**\r\n * 导出为CSV文件\r\n * @param {Array} data - 数据数组\r\n * @param {String} fileName - 文件名\r\n * @param {Array} headers - 表头配置\r\n */\nexport const exportToCSV = (data, fileName, headers) => {\n  // 处理文件名\n  const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 14);\n  const csvFileName = `${fileName}_${timestamp}.csv`;\n\n  // 准备CSV内容\n  let csvContent = '\\uFEFF'; // 添加BOM以支持中文\n\n  // 添加表头\n  const headerRow = headers.map(h => `\"${h.title}\"`).join(',');\n  csvContent += headerRow + '\\r\\n';\n\n  // 添加数据行\n  data.forEach(item => {\n    const row = headers.map(header => {\n      const value = item[header.field];\n\n      // 处理null和undefined\n      if (value === null || value === undefined) {\n        return '';\n      }\n\n      // 处理数字\n      if (header.type === 'number' || typeof value === 'number') {\n        return value;\n      }\n\n      // 处理字符串，特别是包含逗号、引号或换行符的字符串\n      let cellValue = String(value);\n      if (cellValue.includes(',') || cellValue.includes('\"') || cellValue.includes('\\n')) {\n        cellValue = cellValue.replace(/\"/g, '\"\"'); // 将引号替换为两个引号\n        cellValue = `\"${cellValue}\"`; // 用引号包裹整个值\n      }\n      return cellValue;\n    }).join(',');\n    csvContent += row + '\\r\\n';\n  });\n\n  // 创建下载链接\n  const blob = new Blob([csvContent], {\n    type: 'text/csv;charset=utf-8;'\n  });\n  const url = URL.createObjectURL(blob);\n  const link = document.createElement('a');\n  link.setAttribute('href', url);\n  link.setAttribute('download', csvFileName);\n  link.style.visibility = 'hidden';\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  URL.revokeObjectURL(url);\n  console.log('CSV导出成功');\n};\n\n/**\r\n * 准备图片数据用于导出\r\n * @param {Array} records - 记录数据\r\n * @param {String} baseUrl - 基础URL\r\n * @returns {Object} 图片数据对象\r\n */\nexport const prepareImageExportData = async (records, baseUrl) => {\n  const imageData = {};\n  try {\n    console.log('准备图片数据，记录数:', records.length);\n    console.log('基础URL:', baseUrl);\n\n    // 处理每条记录的图片\n    records.forEach((record, index) => {\n      imageData[index] = {\n        beforeImages: [],\n        afterImages: []\n      };\n\n      // 处理清理前照片\n      if (record.photo_path_before) {\n        console.log(`记录 ${index} 清理前照片路径:`, record.photo_path_before);\n        let beforePaths = [];\n        try {\n          // 尝试解析JSON\n          if (typeof record.photo_path_before === 'string' && record.photo_path_before.startsWith('[')) {\n            beforePaths = JSON.parse(record.photo_path_before);\n            console.log(`记录 ${index} 解析后的清理前照片路径:`, beforePaths);\n          } else {\n            beforePaths = [record.photo_path_before];\n          }\n        } catch (e) {\n          console.error('解析清理前照片路径失败:', e);\n          beforePaths = [record.photo_path_before];\n        }\n\n        // 添加完整URL\n        imageData[index].beforeImages = beforePaths.map(path => {\n          // 确保路径是字符串\n          const pathStr = String(path);\n          // 如果路径已经是完整URL，则直接返回\n          if (pathStr.startsWith('http://') || pathStr.startsWith('https://')) {\n            return pathStr;\n          }\n          // 否则拼接基础URL\n          return `${baseUrl}${pathStr}`;\n        });\n        console.log(`记录 ${index} 完整的清理前照片URL:`, imageData[index].beforeImages);\n      }\n\n      // 处理清理后照片\n      if (record.photo_path_after) {\n        console.log(`记录 ${index} 清理后照片路径:`, record.photo_path_after);\n        let afterPaths = [];\n        try {\n          // 尝试解析JSON\n          if (typeof record.photo_path_after === 'string' && record.photo_path_after.startsWith('[')) {\n            afterPaths = JSON.parse(record.photo_path_after);\n            console.log(`记录 ${index} 解析后的清理后照片路径:`, afterPaths);\n          } else {\n            afterPaths = [record.photo_path_after];\n          }\n        } catch (e) {\n          console.error('解析清理后照片路径失败:', e);\n          afterPaths = [record.photo_path_after];\n        }\n\n        // 添加完整URL\n        imageData[index].afterImages = afterPaths.map(path => {\n          // 确保路径是字符串\n          const pathStr = String(path);\n          // 如果路径已经是完整URL，则直接返回\n          if (pathStr.startsWith('http://') || pathStr.startsWith('https://')) {\n            return pathStr;\n          }\n          // 否则拼接基础URL\n          return `${baseUrl}${pathStr}`;\n        });\n        console.log(`记录 ${index} 完整的清理后照片URL:`, imageData[index].afterImages);\n      }\n    });\n    console.log('图片数据准备完成，总记录数:', Object.keys(imageData).length);\n    return imageData;\n  } catch (error) {\n    console.error('准备图片数据失败:', error);\n    return {};\n  }\n};","map":{"version":3,"names":["XLSX","ExcelJS","console","log","version","Object","keys","join","fetchImageAsBuffer","imageUrl","baseUrl","window","location","origin","error","fullUrl","startsWith","response","fetch","headers","ok","Error","status","statusText","arrayBuffer","byteLength","Buffer","from","parsePhotoPath","path","Array","isArray","endsWith","parsed","JSON","parse","exportToExcelWithImages","data","fileName","length","replace","timestamp","Date","toISOString","substring","fullFileName","workbook","Workbook","creator","lastModifiedBy","created","modified","worksheet","addWorksheet","columns","map","header","text","key","field","width","isImage","getRow","font","bold","alignment","vertical","horizontal","rowIndex","row","originalData","__original","rowData","forEach","excelRow","addRow","height","fieldName","photoPathField","photoPaths","firstPhotoPath","imageBuffer","colIndex","findIndex","h","cellRef","getCell","address","imageId","addImage","buffer","extension","split","pop","toLowerCase","tl","col","br","editAs","imageError","xlsx","writeBuffer","blob","Blob","type","url","URL","createObjectURL","link","document","createElement","href","download","body","appendChild","click","removeChild","revokeObjectURL","message","stack","exportToExcel","fallbackError","wb","utils","book_new","exportRows","exportRow","ws","json_to_sheet","colWidths","wch","book_append_sheet","excelFileName","wbout","write","bookType","size","a","exportToCSV","csvFileName","csvContent","headerRow","title","item","value","undefined","cellValue","String","includes","setAttribute","style","visibility","prepareImageExportData","records","imageData","record","index","beforeImages","afterImages","photo_path_before","beforePaths","e","pathStr","photo_path_after","afterPaths"],"sources":["F:/Project/Hazardous-waste-management-system/frontend/src/utils/exportUtils.js"],"sourcesContent":["// 用于导出数据到CSV和Excel的工具函数\r\nimport * as XLSX from 'xlsx';\r\nimport ExcelJS from 'exceljs';\r\n// import { saveAs } from 'file-saver';\r\n\r\n// 检查XLSX库是否正确加载\r\nconsole.log('XLSX库版本:', XLSX.version);\r\nconsole.log('XLSX库可用方法:', Object.keys(XLSX).join(', '));\r\n\r\n/**\r\n * 从服务器获取图片并作为Buffer返回\r\n * @param {String} imageUrl - 图片的URL地址\r\n * @param {String} baseUrl - 基础URL，默认为当前域名\r\n * @returns {Promise<Buffer>} 图片的buffer数据\r\n */\r\nconst fetchImageAsBuffer = async (imageUrl, baseUrl = window.location.origin) => {\r\n  console.log('获取图片:', imageUrl);\r\n  \r\n  if (!imageUrl) {\r\n    console.error('图片URL为空');\r\n    return null;\r\n  }\r\n  \r\n  // 如果是相对路径，添加baseUrl\r\n  const fullUrl = imageUrl.startsWith('/') \r\n    ? `${baseUrl}${imageUrl}` \r\n    : imageUrl;\r\n  \r\n  try {\r\n    console.log('获取图片:', fullUrl);\r\n    const response = await fetch(fullUrl, {\r\n      headers: {\r\n        'Cache-Control': 'no-cache',\r\n        'Pragma': 'no-cache'\r\n      }\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      throw new Error(`获取图片失败: ${response.status} ${response.statusText}`);\r\n    }\r\n    \r\n    const arrayBuffer = await response.arrayBuffer();\r\n    console.log('图片获取成功，大小:', arrayBuffer.byteLength, '字节');\r\n    return Buffer.from(arrayBuffer);\r\n  } catch (error) {\r\n    console.error('获取图片失败:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\n/**\r\n * 解析照片路径，支持JSON字符串和数组\r\n * @param {String|Array} path - 照片路径字符串或数组\r\n * @returns {Array} 解析后的照片路径数组\r\n */\r\nconst parsePhotoPath = (path) => {\r\n  if (!path) {\r\n    return [];\r\n  }\r\n  \r\n  // 如果已经是数组，直接返回\r\n  if (Array.isArray(path)) {\r\n    return path;\r\n  }\r\n  \r\n  try {\r\n    // 尝试解析JSON字符串\r\n    if (typeof path === 'string' && path.startsWith('[') && path.endsWith(']')) {\r\n      const parsed = JSON.parse(path);\r\n      return Array.isArray(parsed) ? parsed : [path];\r\n    }\r\n    \r\n    // 非JSON格式，作为单个路径返回\r\n    return [path];\r\n  } catch (error) {\r\n    console.error('解析照片路径失败:', error);\r\n    return [path];\r\n  }\r\n};\r\n\r\n/**\r\n * 将数据导出为Excel文件，包含图片\r\n * @param {Array} data - 要导出的数据数组\r\n * @param {String} fileName - 导出的文件名（不含后缀）\r\n * @param {Array} headers - 要导出的列标题和对应字段名\r\n * @param {String} baseUrl - 基础URL，用于构建完整的图片路径\r\n */\r\nexport const exportToExcelWithImages = async (data, fileName, headers, baseUrl = window.location.origin) => {\r\n  console.log('=== exportToExcelWithImages 函数被调用 ===');\r\n  console.log('数据条数:', data.length);\r\n  \r\n  if (!data || data.length === 0) {\r\n    console.error('导出失败：没有数据');\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    // 处理文件名\r\n    fileName = fileName.replace(/[\\\\/:*?\"<>|]/g, '_');\r\n    const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 14);\r\n    const fullFileName = `${fileName}_${timestamp}.xlsx`;\r\n    \r\n    // 创建新工作簿\r\n    const workbook = new ExcelJS.Workbook();\r\n    workbook.creator = '危险废物管理系统';\r\n    workbook.lastModifiedBy = '危险废物管理系统';\r\n    workbook.created = new Date();\r\n    workbook.modified = new Date();\r\n    \r\n    // 添加工作表\r\n    const worksheet = workbook.addWorksheet('危险废物记录');\r\n    \r\n    // 设置列\r\n    const columns = headers.map(header => ({\r\n      header: header.text,\r\n      key: header.field,\r\n      width: header.isImage ? 20 : 15\r\n    }));\r\n    worksheet.columns = columns;\r\n    \r\n    // 设置表头样式\r\n    worksheet.getRow(1).font = { bold: true };\r\n    worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };\r\n    \r\n    // 添加数据行并处理图片\r\n    console.log('开始处理数据行...');\r\n    \r\n    for (let rowIndex = 0; rowIndex < data.length; rowIndex++) {\r\n      const row = data[rowIndex];\r\n      const originalData = row.__original || row;\r\n      \r\n      console.log(`处理第 ${rowIndex + 1}/${data.length} 条记录...`);\r\n      \r\n      // 首先添加行基本数据\r\n      const rowData = {};\r\n      headers.forEach(header => {\r\n        if (!header.isImage) {\r\n          rowData[header.field] = row[header.field] || '';\r\n        }\r\n      });\r\n      \r\n      // 添加行数据\r\n      const excelRow = worksheet.addRow(rowData);\r\n      \r\n      // 设置行高\r\n      excelRow.height = 80; // 设置足够的高度显示图片\r\n      \r\n      // 处理图片字段\r\n      for (const header of headers) {\r\n        if (header.isImage) {\r\n          const fieldName = header.field;\r\n          const photoPathField = \r\n            fieldName === '清理前照片' ? 'photo_path_before' : \r\n            fieldName === '清理后照片' ? 'photo_path_after' : null;\r\n          \r\n          if (photoPathField && originalData[photoPathField]) {\r\n            // 解析照片路径\r\n            const photoPaths = parsePhotoPath(originalData[photoPathField]);\r\n            \r\n            if (photoPaths.length > 0) {\r\n              console.log(`记录 ${rowIndex + 1} 的 ${fieldName} 有 ${photoPaths.length} 张照片，取第一张`);\r\n              const firstPhotoPath = photoPaths[0];\r\n              \r\n              // 获取图片\r\n              try {\r\n                const imageBuffer = await fetchImageAsBuffer(firstPhotoPath, baseUrl);\r\n                \r\n                if (imageBuffer) {\r\n                  // 找到这个字段在列中的位置\r\n                  const colIndex = headers.findIndex(h => h.field === fieldName) + 1;\r\n                  \r\n                  // 获取单元格位置\r\n                  const cellRef = worksheet.getCell(rowIndex + 2, colIndex).address;\r\n                  \r\n                  // 添加图片到工作表\r\n                  const imageId = workbook.addImage({\r\n                    buffer: imageBuffer,\r\n                    extension: firstPhotoPath.split('.').pop().toLowerCase()\r\n                  });\r\n                  \r\n                  // 将图片添加到单元格\r\n                  worksheet.addImage(imageId, {\r\n                    tl: { col: colIndex - 1, row: rowIndex + 1 },\r\n                    br: { col: colIndex, row: rowIndex + 2 },\r\n                    editAs: 'oneCell'\r\n                  });\r\n                  \r\n                  console.log(`已添加图片到单元格 ${cellRef}`);\r\n                } else {\r\n                  console.error(`获取图片失败: ${firstPhotoPath}`);\r\n                }\r\n              } catch (imageError) {\r\n                console.error(`处理图片时出错:`, imageError);\r\n              }\r\n            } else {\r\n              console.log(`记录 ${rowIndex + 1} 的 ${fieldName} 没有照片`);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // 导出工作簿\r\n    console.log('生成Excel数据...');\r\n    const buffer = await workbook.xlsx.writeBuffer();\r\n    \r\n    // 创建Blob对象并下载\r\n    const blob = new Blob([buffer], { \r\n      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' \r\n    });\r\n    \r\n    // 创建下载链接\r\n    const url = URL.createObjectURL(blob);\r\n    const link = document.createElement('a');\r\n    link.href = url;\r\n    link.download = fullFileName;\r\n    \r\n    // 触发下载\r\n    document.body.appendChild(link);\r\n    link.click();\r\n    document.body.removeChild(link);\r\n    URL.revokeObjectURL(url);\r\n    \r\n    console.log('Excel导出成功');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('导出Excel失败:', error);\r\n    console.error('错误详情:', error.message);\r\n    console.error('错误堆栈:', error.stack);\r\n    \r\n    // 尝试使用普通的Excel导出（不包含图片）\r\n    console.log('尝试使用普通Excel导出（不包含图片）...');\r\n    try {\r\n      return exportToExcel(data, fileName, headers);\r\n    } catch (fallbackError) {\r\n      console.error('普通Excel导出也失败:', fallbackError);\r\n      return false;\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * 将数据导出为Excel文件\r\n * @param {Array} data - 要导出的数据数组\r\n * @param {String} fileName - 导出的文件名（不含后缀）\r\n * @param {Array} headers - 要导出的列标题和对应字段名\r\n */\r\nexport const exportToExcel = (data, fileName, headers) => {\r\n  if (!data || data.length === 0) {\r\n    console.error('导出失败：没有数据');\r\n    return false;\r\n  }\r\n\r\n  // 处理文件名\r\n  fileName = fileName.replace(/[\\\\/:*?\"<>|]/g, '_');\r\n  const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 14);\r\n  \r\n  console.log('导出函数被调用，数据条数:', data.length);\r\n  \r\n  // 使用XLSX导出Excel\r\n  try {\r\n    console.log('尝试导出Excel...');\r\n    \r\n    // 创建工作簿\r\n    const wb = XLSX.utils.book_new();\r\n    console.log('工作簿创建成功');\r\n    \r\n    // 准备数据\r\n    const exportRows = data.map(row => {\r\n      const exportRow = {};\r\n      headers.forEach(header => {\r\n        exportRow[header.text] = row[header.field] || '';\r\n      });\r\n      return exportRow;\r\n    });\r\n    \r\n    console.log('数据准备完成，开始创建工作表');\r\n    \r\n    // 创建工作表\r\n    const ws = XLSX.utils.json_to_sheet(exportRows);\r\n    \r\n    console.log('工作表创建成功');\r\n    \r\n    // 设置列宽\r\n    const colWidths = headers.map(() => ({ wch: 20 }));\r\n    ws['!cols'] = colWidths;\r\n    \r\n    // 添加工作表到工作簿\r\n    XLSX.utils.book_append_sheet(wb, ws, '危险废物记录');\r\n    console.log('工作表已添加到工作簿');\r\n    \r\n    // 导出Excel文件\r\n    const excelFileName = `${fileName}_${timestamp}.xlsx`;\r\n    console.log('准备导出Excel文件:', excelFileName);\r\n    \r\n    // 使用write方法导出\r\n    console.log('使用XLSX.write方法导出...');\r\n    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });\r\n    console.log('Excel数据生成成功，大小:', wbout.length, '字节');\r\n    \r\n    // 创建Blob对象\r\n    const blob = new Blob([wbout], { \r\n      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' \r\n    });\r\n    console.log('Blob创建成功，大小:', blob.size, '字节');\r\n    \r\n    // 创建下载链接\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = excelFileName;\r\n    console.log('下载链接创建成功，准备触发点击');\r\n    \r\n    // 触发下载\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    document.body.removeChild(a);\r\n    URL.revokeObjectURL(url);\r\n    \r\n    console.log('Excel导出成功');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('导出Excel失败，错误详情:', error);\r\n    console.log('回退到CSV导出');\r\n    // 如果Excel导出失败，回退到CSV导出\r\n    exportToCSV(data, fileName, headers);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * 导出为CSV文件\r\n * @param {Array} data - 数据数组\r\n * @param {String} fileName - 文件名\r\n * @param {Array} headers - 表头配置\r\n */\r\nexport const exportToCSV = (data, fileName, headers) => {\r\n  // 处理文件名\r\n  const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 14);\r\n  const csvFileName = `${fileName}_${timestamp}.csv`;\r\n  \r\n  // 准备CSV内容\r\n  let csvContent = '\\uFEFF'; // 添加BOM以支持中文\r\n  \r\n  // 添加表头\r\n  const headerRow = headers.map(h => `\"${h.title}\"`).join(',');\r\n  csvContent += headerRow + '\\r\\n';\r\n  \r\n  // 添加数据行\r\n  data.forEach(item => {\r\n    const row = headers.map(header => {\r\n      const value = item[header.field];\r\n      \r\n      // 处理null和undefined\r\n      if (value === null || value === undefined) {\r\n        return '';\r\n      }\r\n      \r\n      // 处理数字\r\n      if (header.type === 'number' || typeof value === 'number') {\r\n        return value;\r\n      }\r\n      \r\n      // 处理字符串，特别是包含逗号、引号或换行符的字符串\r\n      let cellValue = String(value);\r\n      if (cellValue.includes(',') || cellValue.includes('\"') || cellValue.includes('\\n')) {\r\n        cellValue = cellValue.replace(/\"/g, '\"\"'); // 将引号替换为两个引号\r\n        cellValue = `\"${cellValue}\"`; // 用引号包裹整个值\r\n      }\r\n      \r\n      return cellValue;\r\n    }).join(',');\r\n    \r\n    csvContent += row + '\\r\\n';\r\n  });\r\n  \r\n  // 创建下载链接\r\n  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\r\n  const url = URL.createObjectURL(blob);\r\n  const link = document.createElement('a');\r\n  link.setAttribute('href', url);\r\n  link.setAttribute('download', csvFileName);\r\n  link.style.visibility = 'hidden';\r\n  document.body.appendChild(link);\r\n  link.click();\r\n  document.body.removeChild(link);\r\n  URL.revokeObjectURL(url);\r\n  \r\n  console.log('CSV导出成功');\r\n};\r\n\r\n/**\r\n * 准备图片数据用于导出\r\n * @param {Array} records - 记录数据\r\n * @param {String} baseUrl - 基础URL\r\n * @returns {Object} 图片数据对象\r\n */\r\nexport const prepareImageExportData = async (records, baseUrl) => {\r\n  const imageData = {};\r\n  \r\n  try {\r\n    console.log('准备图片数据，记录数:', records.length);\r\n    console.log('基础URL:', baseUrl);\r\n    \r\n    // 处理每条记录的图片\r\n    records.forEach((record, index) => {\r\n      imageData[index] = {\r\n        beforeImages: [],\r\n        afterImages: []\r\n      };\r\n      \r\n      // 处理清理前照片\r\n      if (record.photo_path_before) {\r\n        console.log(`记录 ${index} 清理前照片路径:`, record.photo_path_before);\r\n        \r\n        let beforePaths = [];\r\n        try {\r\n          // 尝试解析JSON\r\n          if (typeof record.photo_path_before === 'string' && record.photo_path_before.startsWith('[')) {\r\n            beforePaths = JSON.parse(record.photo_path_before);\r\n            console.log(`记录 ${index} 解析后的清理前照片路径:`, beforePaths);\r\n          } else {\r\n            beforePaths = [record.photo_path_before];\r\n          }\r\n        } catch (e) {\r\n          console.error('解析清理前照片路径失败:', e);\r\n          beforePaths = [record.photo_path_before];\r\n        }\r\n        \r\n        // 添加完整URL\r\n        imageData[index].beforeImages = beforePaths.map(path => {\r\n          // 确保路径是字符串\r\n          const pathStr = String(path);\r\n          // 如果路径已经是完整URL，则直接返回\r\n          if (pathStr.startsWith('http://') || pathStr.startsWith('https://')) {\r\n            return pathStr;\r\n          }\r\n          // 否则拼接基础URL\r\n          return `${baseUrl}${pathStr}`;\r\n        });\r\n        \r\n        console.log(`记录 ${index} 完整的清理前照片URL:`, imageData[index].beforeImages);\r\n      }\r\n      \r\n      // 处理清理后照片\r\n      if (record.photo_path_after) {\r\n        console.log(`记录 ${index} 清理后照片路径:`, record.photo_path_after);\r\n        \r\n        let afterPaths = [];\r\n        try {\r\n          // 尝试解析JSON\r\n          if (typeof record.photo_path_after === 'string' && record.photo_path_after.startsWith('[')) {\r\n            afterPaths = JSON.parse(record.photo_path_after);\r\n            console.log(`记录 ${index} 解析后的清理后照片路径:`, afterPaths);\r\n          } else {\r\n            afterPaths = [record.photo_path_after];\r\n          }\r\n        } catch (e) {\r\n          console.error('解析清理后照片路径失败:', e);\r\n          afterPaths = [record.photo_path_after];\r\n        }\r\n        \r\n        // 添加完整URL\r\n        imageData[index].afterImages = afterPaths.map(path => {\r\n          // 确保路径是字符串\r\n          const pathStr = String(path);\r\n          // 如果路径已经是完整URL，则直接返回\r\n          if (pathStr.startsWith('http://') || pathStr.startsWith('https://')) {\r\n            return pathStr;\r\n          }\r\n          // 否则拼接基础URL\r\n          return `${baseUrl}${pathStr}`;\r\n        });\r\n        \r\n        console.log(`记录 ${index} 完整的清理后照片URL:`, imageData[index].afterImages);\r\n      }\r\n    });\r\n    \r\n    console.log('图片数据准备完成，总记录数:', Object.keys(imageData).length);\r\n    return imageData;\r\n  } catch (error) {\r\n    console.error('准备图片数据失败:', error);\r\n    return {};\r\n  }\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}